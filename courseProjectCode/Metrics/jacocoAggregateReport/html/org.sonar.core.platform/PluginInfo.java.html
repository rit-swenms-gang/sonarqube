<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PluginInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.core.platform</a> &gt; <span class="el_source">PluginInfo.java</span></div><h1>PluginInfo.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.core.platform;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Joiner;
import com.google.common.collect.ComparisonChain;
import com.google.common.collect.Ordering;
import java.io.File;
import java.io.IOException;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.jar.JarFile;
import java.util.regex.Pattern;
import java.util.zip.ZipEntry;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.api.utils.MessageException;
import org.sonar.updatecenter.common.PluginManifest;
import org.sonar.updatecenter.common.Version;

import static java.util.Objects.requireNonNull;

public class PluginInfo implements Comparable&lt;PluginInfo&gt; {
<span class="fc" id="L48">  private static final Logger LOGGER = LoggerFactory.getLogger(PluginInfo.class);</span>

<span class="fc" id="L50">  private static final Joiner SLASH_JOINER = Joiner.on(&quot; / &quot;).skipNulls();</span>

  private final String key;
  private String name;

  @CheckForNull
  private File jarFile;

  @CheckForNull
  private String mainClass;

  @CheckForNull
  private Version version;

  private String displayVersion;

  @CheckForNull
  private Version minimalSonarPluginApiVersion;

  @CheckForNull
  private String description;

  @CheckForNull
  private String organizationName;

  @CheckForNull
  private String organizationUrl;

  @CheckForNull
  private String license;

  @CheckForNull
  private String homepageUrl;

  @CheckForNull
  private String issueTrackerUrl;

  private boolean useChildFirstClassLoader;

  @CheckForNull
  private String basePlugin;

  @CheckForNull
  private String implementationBuild;

  @CheckForNull
  private boolean sonarLintSupported;

  @CheckForNull
  private String documentationPath;

<span class="fc" id="L101">  private final Set&lt;RequiredPlugin&gt; requiredPlugins = new HashSet&lt;&gt;();</span>

<span class="fc" id="L103">  private final Set&lt;String&gt; requiredForLanguages = new HashSet&lt;&gt;();</span>

<span class="fc" id="L105">  public PluginInfo(String key) {</span>
<span class="fc" id="L106">    requireNonNull(key, &quot;Plugin key is missing from manifest&quot;);</span>
<span class="fc" id="L107">    this.key = key;</span>
<span class="fc" id="L108">    this.name = key;</span>
<span class="fc" id="L109">  }</span>

  public PluginInfo setJarFile(@Nullable File f) {
<span class="fc" id="L112">    this.jarFile = f;</span>
<span class="fc" id="L113">    return this;</span>
  }

  @CheckForNull
  public File getJarFile() {
<span class="fc" id="L118">    return jarFile;</span>
  }

  public File getNonNullJarFile() {
<span class="fc" id="L122">    requireNonNull(jarFile);</span>
<span class="fc" id="L123">    return jarFile;</span>
  }

  public String getKey() {
<span class="fc" id="L127">    return key;</span>
  }

  public String getName() {
<span class="fc" id="L131">    return name;</span>
  }

  @CheckForNull
  public Version getVersion() {
<span class="fc" id="L136">    return version;</span>
  }

  @CheckForNull
  public String getDisplayVersion() {
<span class="fc" id="L141">    return displayVersion;</span>
  }

  public PluginInfo setDisplayVersion(@Nullable String displayVersion) {
<span class="fc" id="L145">    this.displayVersion = displayVersion;</span>
<span class="fc" id="L146">    return this;</span>
  }

  @CheckForNull
  public Version getMinimalSonarPluginApiVersion() {
<span class="fc" id="L151">    return minimalSonarPluginApiVersion;</span>
  }

  @CheckForNull
  public String getMainClass() {
<span class="fc" id="L156">    return mainClass;</span>
  }

  @CheckForNull
  public String getDescription() {
<span class="fc" id="L161">    return description;</span>
  }

  @CheckForNull
  public String getOrganizationName() {
<span class="fc" id="L166">    return organizationName;</span>
  }

  @CheckForNull
  public String getOrganizationUrl() {
<span class="fc" id="L171">    return organizationUrl;</span>
  }

  @CheckForNull
  public String getLicense() {
<span class="fc" id="L176">    return license;</span>
  }

  @CheckForNull
  public String getHomepageUrl() {
<span class="fc" id="L181">    return homepageUrl;</span>
  }

  @CheckForNull
  public String getIssueTrackerUrl() {
<span class="fc" id="L186">    return issueTrackerUrl;</span>
  }

  public boolean isUseChildFirstClassLoader() {
<span class="fc" id="L190">    return useChildFirstClassLoader;</span>
  }

  public boolean isSonarLintSupported() {
<span class="fc" id="L194">    return sonarLintSupported;</span>
  }

  public String getDocumentationPath() {
<span class="fc" id="L198">    return documentationPath;</span>
  }

  @CheckForNull
  public String getBasePlugin() {
<span class="fc" id="L203">    return basePlugin;</span>
  }

  @CheckForNull
  public String getImplementationBuild() {
<span class="fc" id="L208">    return implementationBuild;</span>
  }

  public Set&lt;RequiredPlugin&gt; getRequiredPlugins() {
<span class="fc" id="L212">    return requiredPlugins;</span>
  }

  public Set&lt;String&gt; getRequiredForLanguages() {
<span class="fc" id="L216">    return requiredForLanguages;</span>
  }

  public PluginInfo setName(@Nullable String name) {
<span class="fc bfc" id="L220" title="All 2 branches covered.">    this.name = (name != null ? name : this.key);</span>
<span class="fc" id="L221">    return this;</span>
  }

  public PluginInfo setVersion(Version version) {
<span class="fc" id="L225">    this.version = version;</span>
<span class="fc" id="L226">    return this;</span>
  }

  public PluginInfo setMinimalSonarPluginApiVersion(@Nullable Version v) {
<span class="fc" id="L230">    this.minimalSonarPluginApiVersion = v;</span>
<span class="fc" id="L231">    return this;</span>
  }

  public PluginInfo setDocumentationPath(@Nullable String documentationPath) {
<span class="fc" id="L235">    this.documentationPath = documentationPath;</span>
<span class="fc" id="L236">    return this;</span>
  }

  /**
   * Required
   */
  public PluginInfo setMainClass(String mainClass) {
<span class="fc" id="L243">    this.mainClass = mainClass;</span>
<span class="fc" id="L244">    return this;</span>
  }

  public PluginInfo setDescription(@Nullable String description) {
<span class="fc" id="L248">    this.description = description;</span>
<span class="fc" id="L249">    return this;</span>
  }

  public PluginInfo setOrganizationName(@Nullable String s) {
<span class="fc" id="L253">    this.organizationName = s;</span>
<span class="fc" id="L254">    return this;</span>
  }

  public PluginInfo setOrganizationUrl(@Nullable String s) {
<span class="fc" id="L258">    this.organizationUrl = s;</span>
<span class="fc" id="L259">    return this;</span>
  }

  public PluginInfo setLicense(@Nullable String license) {
<span class="fc" id="L263">    this.license = license;</span>
<span class="fc" id="L264">    return this;</span>
  }

  public PluginInfo setHomepageUrl(@Nullable String s) {
<span class="fc" id="L268">    this.homepageUrl = s;</span>
<span class="fc" id="L269">    return this;</span>
  }

  public PluginInfo setIssueTrackerUrl(@Nullable String s) {
<span class="fc" id="L273">    this.issueTrackerUrl = s;</span>
<span class="fc" id="L274">    return this;</span>
  }

  public PluginInfo setUseChildFirstClassLoader(boolean b) {
<span class="fc" id="L278">    this.useChildFirstClassLoader = b;</span>
<span class="fc" id="L279">    return this;</span>
  }

  public PluginInfo setSonarLintSupported(boolean sonarLintPlugin) {
<span class="fc" id="L283">    this.sonarLintSupported = sonarLintPlugin;</span>
<span class="fc" id="L284">    return this;</span>
  }

  public PluginInfo setBasePlugin(@Nullable String s) {
<span class="fc bfc" id="L288" title="All 2 branches covered.">    if (&quot;l10nen&quot;.equals(s)) {</span>
<span class="fc" id="L289">      LOGGER.info(&quot;Plugin [{}] defines 'l10nen' as base plugin. &quot; +</span>
        &quot;This metadata can be removed from manifest of l10n plugins since version 5.2.&quot;, key);
<span class="fc" id="L291">      basePlugin = null;</span>
    } else {
<span class="fc" id="L293">      basePlugin = s;</span>
    }
<span class="fc" id="L295">    return this;</span>
  }

  public PluginInfo setImplementationBuild(@Nullable String implementationBuild) {
<span class="fc" id="L299">    this.implementationBuild = implementationBuild;</span>
<span class="fc" id="L300">    return this;</span>
  }

  public PluginInfo addRequiredPlugin(RequiredPlugin p) {
<span class="fc" id="L304">    this.requiredPlugins.add(p);</span>
<span class="fc" id="L305">    return this;</span>
  }

  public PluginInfo addRequiredForLanguage(String lang) {
<span class="fc" id="L309">    this.requiredForLanguages.add(lang);</span>
<span class="fc" id="L310">    return this;</span>
  }

  /**
   * Find out if this plugin is compatible with a given version of Sonar Plugin API.
   * The version of plugin api embedded in SQ must be greater than or equal to the minimal version
   * needed by the plugin.
   */
  public boolean isCompatibleWith(String runtimePluginApiVersion) {
<span class="fc bfc" id="L319" title="All 2 branches covered.">    if (null == this.minimalSonarPluginApiVersion) {</span>
      // no constraint defined on the plugin
<span class="fc" id="L321">      return true;</span>
    }

<span class="fc" id="L324">    Version effectiveMin = Version.create(minimalSonarPluginApiVersion.getName()).removeQualifier();</span>
<span class="fc" id="L325">    Version effectiveVersion = Version.create(runtimePluginApiVersion).removeQualifier();</span>

<span class="fc bfc" id="L327" title="All 2 branches covered.">    if (runtimePluginApiVersion.endsWith(&quot;-SNAPSHOT&quot;)) {</span>
      // check only the major and minor versions (two first fields)
<span class="fc" id="L329">      effectiveMin = Version.create(effectiveMin.getMajor() + &quot;.&quot; + effectiveMin.getMinor());</span>
    }

<span class="fc bfc" id="L332" title="All 2 branches covered.">    return effectiveVersion.compareTo(effectiveMin) &gt;= 0;</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L337">    return String.format(&quot;[%s]&quot;, SLASH_JOINER.join(key, version, implementationBuild));</span>
  }

  @Override
  public boolean equals(@Nullable Object o) {
<span class="fc bfc" id="L342" title="All 2 branches covered.">    if (this == o) {</span>
<span class="fc" id="L343">      return true;</span>
    }
<span class="fc bfc" id="L345" title="All 4 branches covered.">    if (o == null || getClass() != o.getClass()) {</span>
<span class="fc" id="L346">      return false;</span>
    }
<span class="fc" id="L348">    PluginInfo info = (PluginInfo) o;</span>
<span class="fc bfc" id="L349" title="All 4 branches covered.">    return Objects.equals(key, info.key) &amp;&amp; Objects.equals(version, info.version);</span>

  }

  @Override
  public int hashCode() {
<span class="fc" id="L355">    return Objects.hash(key, version);</span>
  }

  @Override
  public int compareTo(PluginInfo that) {
<span class="fc" id="L360">    return ComparisonChain.start()</span>
<span class="fc" id="L361">      .compare(this.name, that.name)</span>
<span class="fc" id="L362">      .compare(this.version, that.version, Ordering.natural().nullsFirst())</span>
<span class="fc" id="L363">      .result();</span>
  }

  public static PluginInfo create(File jarFile) {
    try {
<span class="fc" id="L368">      PluginManifest manifest = new PluginManifest(jarFile);</span>
<span class="fc" id="L369">      return create(jarFile, manifest);</span>

<span class="nc" id="L371">    } catch (IOException e) {</span>
<span class="nc" id="L372">      throw new IllegalStateException(&quot;Fail to extract plugin metadata from file: &quot; + jarFile, e);</span>
    }
  }

  @VisibleForTesting
  static PluginInfo create(File jarFile, PluginManifest manifest) {
<span class="fc" id="L378">    validateManifest(jarFile, manifest);</span>
<span class="fc" id="L379">    PluginInfo info = new PluginInfo(manifest.getKey());</span>
<span class="fc" id="L380">    info.fillFields(jarFile, manifest);</span>
<span class="fc" id="L381">    return info;</span>
  }

  private static void validateManifest(File jarFile, PluginManifest manifest) {
<span class="fc bfc" id="L385" title="All 2 branches covered.">    if (StringUtils.isBlank(manifest.getKey())) {</span>
<span class="fc" id="L386">      throw MessageException.of(String.format(&quot;File is not a plugin. Please delete it and restart: %s&quot;, jarFile.getAbsolutePath()));</span>
    }
<span class="fc" id="L388">  }</span>

  protected void fillFields(File jarFile, PluginManifest manifest) {
<span class="fc" id="L391">    setJarFile(jarFile);</span>
<span class="fc" id="L392">    setName(manifest.getName());</span>
<span class="fc" id="L393">    setMainClass(manifest.getMainClass());</span>
<span class="fc" id="L394">    setVersion(Version.create(manifest.getVersion()));</span>
<span class="fc" id="L395">    setDocumentationPath(getDocumentationPath(jarFile));</span>

    // optional fields
<span class="fc" id="L398">    setDescription(manifest.getDescription());</span>
<span class="fc" id="L399">    setLicense(manifest.getLicense());</span>
<span class="fc" id="L400">    setOrganizationName(manifest.getOrganization());</span>
<span class="fc" id="L401">    setOrganizationUrl(manifest.getOrganizationUrl());</span>
<span class="fc" id="L402">    setDisplayVersion(manifest.getDisplayVersion());</span>
<span class="fc" id="L403">    String minSonarPluginApiVersion = manifest.getSonarVersion();</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">    if (minSonarPluginApiVersion != null) {</span>
<span class="fc" id="L405">      setMinimalSonarPluginApiVersion(Version.create(minSonarPluginApiVersion));</span>
    }
<span class="fc" id="L407">    setHomepageUrl(manifest.getHomepage());</span>
<span class="fc" id="L408">    setIssueTrackerUrl(manifest.getIssueTrackerUrl());</span>
<span class="fc" id="L409">    setUseChildFirstClassLoader(manifest.isUseChildFirstClassLoader());</span>
<span class="fc" id="L410">    setSonarLintSupported(manifest.isSonarLintSupported());</span>
<span class="fc" id="L411">    setBasePlugin(manifest.getBasePlugin());</span>
<span class="fc" id="L412">    setImplementationBuild(manifest.getImplementationBuild());</span>
<span class="fc" id="L413">    String[] requiredPluginsFromManifest = manifest.getRequirePlugins();</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">    if (requiredPluginsFromManifest != null) {</span>
<span class="fc" id="L415">      Arrays.stream(requiredPluginsFromManifest)</span>
<span class="fc" id="L416">        .map(RequiredPlugin::parse)</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">        .filter(t -&gt; !&quot;license&quot;.equals(t.key))</span>
<span class="fc" id="L418">        .forEach(this::addRequiredPlugin);</span>
    }

<span class="fc" id="L421">    String[] requiredForLanguagesFromManifest = manifest.getRequiredForLanguages();</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">    if (requiredForLanguagesFromManifest != null) {</span>
<span class="fc" id="L423">      Arrays.stream(requiredForLanguagesFromManifest)</span>
<span class="fc" id="L424">        .forEach(this::addRequiredForLanguage);</span>
    }
<span class="fc" id="L426">  }</span>

  private static String getDocumentationPath(File file) {
<span class="fc" id="L429">    try (JarFile jarFile = new JarFile(file)) {</span>
<span class="fc" id="L430">      return Optional.ofNullable(jarFile.getEntry(&quot;static/documentation.md&quot;))</span>
<span class="fc" id="L431">        .map(ZipEntry::getName)</span>
<span class="fc" id="L432">        .orElse(null);</span>
<span class="fc" id="L433">    } catch (IOException e) {</span>
<span class="fc" id="L434">      LOGGER.warn(&quot;Could not retrieve documentation path from &quot; + file, e);</span>
    }
<span class="fc" id="L436">    return null;</span>
  }

  public static class RequiredPlugin {

<span class="fc" id="L441">    private static final Pattern PARSER = Pattern.compile(&quot;\\w+:.+&quot;);</span>

    private final String key;
    private final Version minimalVersion;

<span class="fc" id="L446">    public RequiredPlugin(String key, Version minimalVersion) {</span>
<span class="fc" id="L447">      this.key = key;</span>
<span class="fc" id="L448">      this.minimalVersion = minimalVersion;</span>
<span class="fc" id="L449">    }</span>

    public String getKey() {
<span class="fc" id="L452">      return key;</span>
    }

    public Version getMinimalVersion() {
<span class="fc" id="L456">      return minimalVersion;</span>
    }

    public static RequiredPlugin parse(String s) {
<span class="fc bfc" id="L460" title="All 2 branches covered.">      if (!PARSER.matcher(s).matches()) {</span>
<span class="fc" id="L461">        throw new IllegalArgumentException(&quot;Manifest field does not have correct format: &quot; + s);</span>
      }
<span class="fc" id="L463">      String[] fields = StringUtils.split(s, ':');</span>
<span class="fc" id="L464">      return new RequiredPlugin(fields[0], Version.create(fields[1]).removeQualifier());</span>
    }

    @Override
    public boolean equals(Object o) {
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">      if (this == o) {</span>
<span class="nc" id="L470">        return true;</span>
      }
<span class="pc bpc" id="L472" title="2 of 4 branches missed.">      if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L473">        return false;</span>
      }
<span class="fc" id="L475">      RequiredPlugin that = (RequiredPlugin) o;</span>
<span class="fc" id="L476">      return key.equals(that.key);</span>
    }

    @Override
    public int hashCode() {
<span class="fc" id="L481">      return key.hashCode();</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L486">      return key + ':' + minimalVersion.getName();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>