<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleCreator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.common.rule</a> &gt; <span class="el_source">RuleCreator.java</span></div><h1>RuleCreator.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.common.rule;

import com.google.common.base.Splitter;
import com.google.common.base.Strings;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.Nullable;
import org.apache.commons.lang3.StringUtils;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.rule.Severity;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.api.server.ServerSide;
import org.sonar.api.server.rule.RuleParamType;
import org.sonar.api.server.rule.internal.ImpactMapper;
import org.sonar.api.utils.System2;
import org.sonar.core.rule.RuleType;
import org.sonar.core.util.UuidFactory;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.issue.ImpactDto;
import org.sonar.db.rule.RuleDescriptionSectionDto;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleDto.Format;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.server.common.rule.service.NewCustomRule;
import org.sonar.server.exceptions.BadRequestException;
import org.sonar.server.rule.index.RuleIndexer;
import org.sonar.server.util.TypeValidations;
import org.springframework.util.CollectionUtils;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Lists.newArrayList;
import static java.lang.String.format;
import static java.util.Objects.requireNonNull;
import static java.util.Optional.ofNullable;
import static org.sonar.core.rule.RuleTypeMapper.toApiRuleType;
import static org.sonar.db.rule.RuleDescriptionSectionDto.createDefaultRuleDescriptionSection;
import static org.sonar.server.exceptions.BadRequestException.checkRequest;

@ServerSide
public class RuleCreator {
  private static final String TEMPLATE_KEY_NOT_EXIST_FORMAT = &quot;The template key doesn't exist: %s&quot;;
  private final System2 system2;
  private final RuleIndexer ruleIndexer;
  private final DbClient dbClient;
  private final TypeValidations typeValidations;
  private final UuidFactory uuidFactory;

<span class="fc" id="L75">  public RuleCreator(System2 system2, RuleIndexer ruleIndexer, DbClient dbClient, TypeValidations typeValidations, UuidFactory uuidFactory) {</span>
<span class="fc" id="L76">    this.system2 = system2;</span>
<span class="fc" id="L77">    this.ruleIndexer = ruleIndexer;</span>
<span class="fc" id="L78">    this.dbClient = dbClient;</span>
<span class="fc" id="L79">    this.typeValidations = typeValidations;</span>
<span class="fc" id="L80">    this.uuidFactory = uuidFactory;</span>
<span class="fc" id="L81">  }</span>

  public RuleDto create(DbSession dbSession, NewCustomRule newRule) {
<span class="fc" id="L84">    RuleKey templateKey = newRule.templateKey();</span>
<span class="fc" id="L85">    RuleDto templateRule = dbClient.ruleDao().selectByKey(dbSession, templateKey)</span>
<span class="fc" id="L86">      .orElseThrow(() -&gt; new IllegalArgumentException(format(TEMPLATE_KEY_NOT_EXIST_FORMAT, templateKey)));</span>
<span class="fc" id="L87">    checkArgument(templateRule.isTemplate(), &quot;This rule is not a template rule: %s&quot;, templateKey.toString());</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">    checkArgument(templateRule.getStatus() != RuleStatus.REMOVED, TEMPLATE_KEY_NOT_EXIST_FORMAT, templateKey.toString());</span>
<span class="fc" id="L89">    validateCustomRule(newRule, dbSession, templateKey, true);</span>

<span class="fc" id="L91">    Optional&lt;RuleDto&gt; definition = loadRule(dbSession, newRule.ruleKey());</span>
<span class="fc" id="L92">    RuleDto ruleDto = definition.map(dto -&gt; updateExistingRule(dto, newRule, dbSession))</span>
<span class="fc" id="L93">      .orElseGet(() -&gt; createCustomRule(newRule, templateRule, dbSession));</span>

<span class="fc" id="L95">    ruleIndexer.commitAndIndex(dbSession, ruleDto.getUuid());</span>
<span class="fc" id="L96">    return ruleDto;</span>
  }

  public List&lt;RuleDto&gt; restore(DbSession dbSession, List&lt;NewCustomRule&gt; newRules) {
<span class="fc" id="L100">    Set&lt;RuleKey&gt; templateKeys = newRules.stream().map(NewCustomRule::templateKey).collect(Collectors.toSet());</span>
<span class="fc" id="L101">    Map&lt;RuleKey, RuleDto&gt; templateRules = dbClient.ruleDao().selectByKeys(dbSession, templateKeys)</span>
<span class="fc" id="L102">      .stream()</span>
<span class="fc" id="L103">      .collect(Collectors.toMap(</span>
        RuleDto::getKey,
<span class="fc" id="L105">        Function.identity()));</span>

<span class="pc bpc" id="L107" title="2 of 4 branches missed.">    checkArgument(!templateRules.isEmpty() &amp;&amp; templateKeys.size() == templateRules.size(), &quot;Rule template keys should exists for each custom rule!&quot;);</span>
<span class="fc" id="L108">    templateRules.values().forEach(ruleDto -&gt; {</span>
<span class="fc" id="L109">      checkArgument(ruleDto.isTemplate(), &quot;This rule is not a template rule: %s&quot;, ruleDto.getKey().toString());</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">      checkArgument(ruleDto.getStatus() != RuleStatus.REMOVED, TEMPLATE_KEY_NOT_EXIST_FORMAT, ruleDto.getKey().toString());</span>
<span class="fc" id="L111">    });</span>

<span class="fc" id="L113">    List&lt;RuleDto&gt; customRules = newRules.stream()</span>
<span class="fc" id="L114">      .map(newCustomRule -&gt; {</span>
<span class="fc" id="L115">        RuleDto templateRule = templateRules.get(newCustomRule.templateKey());</span>
<span class="fc" id="L116">        validateCustomRule(newCustomRule, dbSession, templateRule.getKey(), false);</span>
<span class="fc" id="L117">        return createCustomRule(newCustomRule, templateRule, dbSession);</span>
      })
<span class="fc" id="L119">      .toList();</span>

<span class="fc" id="L121">    ruleIndexer.commitAndIndex(dbSession, customRules.stream().map(RuleDto::getUuid).toList());</span>
<span class="fc" id="L122">    return customRules;</span>
  }

  private void validateCustomRule(NewCustomRule newRule, DbSession dbSession, RuleKey templateKey, boolean checkImpacts) {
<span class="fc" id="L126">    List&lt;String&gt; errors = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L128">    validateRuleKey(errors, newRule.ruleKey(), templateKey);</span>
<span class="fc" id="L129">    validateName(errors, newRule);</span>
<span class="fc" id="L130">    validateDescription(errors, newRule);</span>

<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (newRule.status() == RuleStatus.REMOVED) {</span>
<span class="fc" id="L133">      errors.add(format(&quot;Rule status '%s' is not allowed&quot;, RuleStatus.REMOVED));</span>
    }
<span class="fc" id="L135">    String severity = newRule.severity();</span>
<span class="fc bfc" id="L136" title="All 4 branches covered.">    if (severity != null &amp;&amp; !Severity.ALL.contains(severity)) {</span>
<span class="fc" id="L137">      errors.add(format(&quot;Severity \&quot;%s\&quot; is invalid&quot;, severity));</span>
    }
<span class="fc bfc" id="L139" title="All 8 branches covered.">    if (checkImpacts &amp;&amp; !CollectionUtils.isEmpty(newRule.getImpacts()) &amp;&amp; (StringUtils.isNotBlank(newRule.severity()) || newRule.type() != null)) {</span>
<span class="fc" id="L140">      errors.add(&quot;The rule cannot have both impacts and type/severity specified&quot;);</span>
    }

<span class="fc bfc" id="L143" title="All 2 branches covered.">    for (RuleParamDto ruleParam : dbClient.ruleDao().selectRuleParamsByRuleKey(dbSession, templateKey)) {</span>
      try {
<span class="fc" id="L145">        validateParam(ruleParam, newRule.parameter(ruleParam.getName()));</span>
<span class="fc" id="L146">      } catch (BadRequestException validationError) {</span>
<span class="fc" id="L147">        errors.addAll(validationError.errors());</span>
<span class="fc" id="L148">      }</span>
<span class="fc" id="L149">    }</span>
<span class="fc" id="L150">    checkRequest(errors.isEmpty(), errors);</span>
<span class="fc" id="L151">  }</span>

  private void validateParam(RuleParamDto ruleParam, @Nullable String value) {
<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (value != null) {</span>
<span class="fc" id="L155">      RuleParamType ruleParamType = RuleParamType.parse(ruleParam.getType());</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">      if (ruleParamType.multiple()) {</span>
<span class="fc" id="L157">        List&lt;String&gt; values = newArrayList(Splitter.on(&quot;,&quot;).split(value));</span>
<span class="fc" id="L158">        typeValidations.validate(values, ruleParamType.type(), ruleParamType.values());</span>
<span class="fc" id="L159">      } else {</span>
<span class="fc" id="L160">        typeValidations.validate(value, ruleParamType.type(), ruleParamType.values());</span>
      }
    }
<span class="fc" id="L163">  }</span>

  private static void validateName(List&lt;String&gt; errors, NewCustomRule newRule) {
<span class="fc bfc" id="L166" title="All 2 branches covered.">    if (Strings.isNullOrEmpty(newRule.name())) {</span>
<span class="fc" id="L167">      errors.add(&quot;The name is missing&quot;);</span>
    }
<span class="fc" id="L169">  }</span>

  private static void validateDescription(List&lt;String&gt; errors, NewCustomRule newRule) {
<span class="fc bfc" id="L172" title="All 2 branches covered.">    if (Strings.isNullOrEmpty(newRule.markdownDescription())) {</span>
<span class="fc" id="L173">      errors.add(&quot;The description is missing&quot;);</span>
    }
<span class="fc" id="L175">  }</span>

  private static void validateRuleKey(List&lt;String&gt; errors, RuleKey ruleKey, RuleKey templateKey) {
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (!ruleKey.repository().equals(templateKey.repository())) {</span>
<span class="fc" id="L179">      errors.add(&quot;Custom and template keys must be in the same repository&quot;);</span>
    }
<span class="fc" id="L181">  }</span>

  private Optional&lt;RuleDto&gt; loadRule(DbSession dbSession, RuleKey ruleKey) {
<span class="fc" id="L184">    return dbClient.ruleDao().selectByKey(dbSession, ruleKey);</span>
  }

  private RuleDto createCustomRule(NewCustomRule newRule, RuleDto templateRuleDto, DbSession dbSession) {
<span class="fc" id="L188">    RuleDescriptionSectionDto ruleDescriptionSectionDto = createDefaultRuleDescriptionSection(uuidFactory.create(), requireNonNull(newRule.markdownDescription()));</span>

<span class="fc" id="L190">    RuleDto ruleDto = new RuleDto()</span>
<span class="fc" id="L191">      .setUuid(uuidFactory.create())</span>
<span class="fc" id="L192">      .setRuleKey(newRule.ruleKey())</span>
<span class="fc" id="L193">      .setPluginKey(templateRuleDto.getPluginKey())</span>
<span class="fc" id="L194">      .setTemplateUuid(templateRuleDto.getUuid())</span>
<span class="fc" id="L195">      .setConfigKey(templateRuleDto.getConfigKey())</span>
<span class="fc" id="L196">      .setName(newRule.name())</span>
<span class="fc" id="L197">      .setStatus(ofNullable(newRule.status()).orElse(RuleStatus.READY))</span>
<span class="fc" id="L198">      .setLanguage(templateRuleDto.getLanguage())</span>
<span class="fc" id="L199">      .setDefRemediationFunction(templateRuleDto.getDefRemediationFunction())</span>
<span class="fc" id="L200">      .setDefRemediationGapMultiplier(templateRuleDto.getDefRemediationGapMultiplier())</span>
<span class="fc" id="L201">      .setDefRemediationBaseEffort(templateRuleDto.getDefRemediationBaseEffort())</span>
<span class="fc" id="L202">      .setGapDescription(templateRuleDto.getGapDescription())</span>
<span class="fc" id="L203">      .setScope(templateRuleDto.getScope())</span>
<span class="fc" id="L204">      .setSystemTags(templateRuleDto.getSystemTags())</span>
<span class="fc" id="L205">      .setSecurityStandards(templateRuleDto.getSecurityStandards())</span>
<span class="fc" id="L206">      .setIsExternal(false)</span>
<span class="fc" id="L207">      .setIsAdHoc(false)</span>
<span class="fc" id="L208">      .setCreatedAt(system2.now())</span>
<span class="fc" id="L209">      .setUpdatedAt(system2.now())</span>
<span class="fc" id="L210">      .setDescriptionFormat(Format.MARKDOWN)</span>
<span class="fc" id="L211">      .addRuleDescriptionSectionDto(ruleDescriptionSectionDto);</span>

<span class="fc" id="L213">    setCleanCodeAttributeAndImpacts(newRule, ruleDto, templateRuleDto);</span>

<span class="fc" id="L215">    Set&lt;String&gt; tags = templateRuleDto.getTags();</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">    if (!tags.isEmpty()) {</span>
<span class="fc" id="L217">      ruleDto.setTags(tags);</span>
    }
<span class="fc" id="L219">    dbClient.ruleDao().insert(dbSession, ruleDto);</span>

<span class="fc bfc" id="L221" title="All 2 branches covered.">    for (RuleParamDto templateRuleParamDto : dbClient.ruleDao().selectRuleParamsByRuleKey(dbSession, templateRuleDto.getKey())) {</span>
<span class="fc" id="L222">      String customRuleParamValue = Strings.emptyToNull(newRule.parameter(templateRuleParamDto.getName()));</span>
<span class="fc" id="L223">      createCustomRuleParams(customRuleParamValue, ruleDto, templateRuleParamDto, dbSession);</span>
<span class="fc" id="L224">    }</span>
<span class="fc" id="L225">    return ruleDto;</span>
  }

  private static void setCleanCodeAttributeAndImpacts(NewCustomRule newRule, RuleDto ruleDto, RuleDto templateRuleDto) {
<span class="fc" id="L229">    RuleType ruleType = newRule.type();</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">    int type = ruleType == null ? templateRuleDto.getType() : ruleType.getDbConstant();</span>
<span class="fc" id="L231">    String severity = ofNullable(newRule.severity()).orElse(Severity.MAJOR);</span>

<span class="fc bfc" id="L233" title="All 2 branches covered.">    if (type == RuleType.SECURITY_HOTSPOT.getDbConstant()) {</span>
<span class="fc" id="L234">      ruleDto.setType(type).setSeverity(severity);</span>
    } else {
<span class="fc" id="L236">      CleanCodeAttribute cleanCodeAttributeFromTemplate = ofNullable(templateRuleDto.getCleanCodeAttribute()).orElse(CleanCodeAttribute.CONVENTIONAL);</span>
<span class="fc" id="L237">      ruleDto.setCleanCodeAttribute(ofNullable(newRule.getCleanCodeAttribute()).orElse(cleanCodeAttributeFromTemplate));</span>

<span class="fc bfc" id="L239" title="All 2 branches covered.">      if (!CollectionUtils.isEmpty(newRule.getImpacts())) {</span>
<span class="fc" id="L240">        newRule.getImpacts().stream()</span>
<span class="fc" id="L241">          .map(impact -&gt; new ImpactDto(impact.softwareQuality(), impact.severity()))</span>
<span class="fc" id="L242">          .forEach(ruleDto::addDefaultImpact);</span>
        // Back-map old type and severity from the impact
<span class="fc" id="L244">        Map.Entry&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; impact = ImpactMapper.getBestImpactForBackmapping(</span>
<span class="fc" id="L245">          newRule.getImpacts().stream().collect(Collectors.toMap(NewCustomRule.Impact::softwareQuality, NewCustomRule.Impact::severity)));</span>
<span class="fc" id="L246">        ruleDto.setType(ImpactMapper.convertToRuleType(impact.getKey()).getDbConstant());</span>
<span class="fc" id="L247">        ruleDto.setSeverity(ImpactMapper.convertToDeprecatedSeverity(impact.getValue()));</span>
<span class="fc" id="L248">      } else {</span>
        // Map old type and severity to impact
<span class="fc" id="L250">        SoftwareQuality softwareQuality = ImpactMapper.convertToSoftwareQuality(toApiRuleType(RuleType.fromDbConstant(type)));</span>
<span class="fc" id="L251">        org.sonar.api.issue.impact.Severity impactSeverity = ImpactMapper.convertToImpactSeverity(severity);</span>
<span class="fc" id="L252">        ruleDto.addDefaultImpact(new ImpactDto()</span>
<span class="fc" id="L253">          .setSoftwareQuality(softwareQuality)</span>
<span class="fc" id="L254">          .setSeverity(impactSeverity))</span>
<span class="fc" id="L255">          .setType(type)</span>
<span class="fc" id="L256">          .setSeverity(severity);</span>
      }
    }
<span class="fc" id="L259">  }</span>

  private void createCustomRuleParams(@Nullable String paramValue, RuleDto ruleDto, RuleParamDto templateRuleParam, DbSession dbSession) {
<span class="fc" id="L262">    RuleParamDto ruleParamDto = RuleParamDto.createFor(ruleDto)</span>
<span class="fc" id="L263">      .setName(templateRuleParam.getName())</span>
<span class="fc" id="L264">      .setType(templateRuleParam.getType())</span>
<span class="fc" id="L265">      .setDescription(templateRuleParam.getDescription())</span>
<span class="fc" id="L266">      .setDefaultValue(paramValue);</span>
<span class="fc" id="L267">    dbClient.ruleDao().insertRuleParam(dbSession, ruleDto, ruleParamDto);</span>
<span class="fc" id="L268">  }</span>

  private RuleDto updateExistingRule(RuleDto ruleDto, NewCustomRule newRule, DbSession dbSession) {
<span class="fc bfc" id="L271" title="All 2 branches covered.">    if (ruleDto.getStatus().equals(RuleStatus.REMOVED)) {</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">      if (newRule.isPreventReactivation()) {</span>
<span class="fc" id="L273">        throw new ReactivationException(format(&quot;A removed rule with the key '%s' already exists&quot;, ruleDto.getKey().rule()), ruleDto.getKey());</span>
      } else {
<span class="fc" id="L275">        ruleDto.setStatus(RuleStatus.READY)</span>
<span class="fc" id="L276">          .setUpdatedAt(system2.now());</span>
<span class="fc" id="L277">        dbClient.ruleDao().update(dbSession, ruleDto);</span>
      }
    } else {
<span class="fc" id="L280">      throw new IllegalArgumentException(format(&quot;A rule with the key '%s' already exists&quot;, ruleDto.getKey().rule()));</span>
    }
<span class="fc" id="L282">    return ruleDto;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>