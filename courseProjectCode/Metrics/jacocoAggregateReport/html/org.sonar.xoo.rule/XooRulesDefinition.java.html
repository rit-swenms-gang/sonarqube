<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XooRulesDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.xoo.rule</a> &gt; <span class="el_source">XooRulesDefinition.java</span></div><h1>XooRulesDefinition.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.xoo.rule;

import java.util.HashMap;
import java.util.Map;
import javax.annotation.Nullable;
import org.sonar.api.SonarRuntime;
import org.sonar.api.config.Configuration;
import org.sonar.api.issue.impact.Severity;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleScope;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.api.rules.RuleType;
import org.sonar.api.server.rule.RuleDescriptionSection;
import org.sonar.api.server.rule.RuleParamType;
import org.sonar.api.server.rule.RulesDefinition;
import org.sonar.api.server.rule.RulesDefinitionAnnotationLoader;
import org.sonar.api.utils.Version;
import org.sonar.xoo.Xoo;
import org.sonar.xoo.Xoo2;
import org.sonar.xoo.checks.Check;
import org.sonar.xoo.rule.hotspot.HotspotWithContextsSensor;
import org.sonar.xoo.rule.hotspot.HotspotWithSingleContextSensor;
import org.sonar.xoo.rule.hotspot.HotspotWithoutContextSensor;
import org.sonar.xoo.rule.variant.HotspotWithCodeVariantsSensor;
import org.sonar.xoo.rule.variant.IssueWithCodeVariantsSensor;

import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.ASSESS_THE_PROBLEM_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.HOW_TO_FIX_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.INTRODUCTION_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.RESOURCES_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.ROOT_CAUSE_SECTION_KEY;
import static org.sonar.api.server.rule.RulesDefinition.OwaspMobileTop10Version.Y2024;
import static org.sonar.api.server.rule.RulesDefinition.OwaspTop10Version.Y2017;
import static org.sonar.api.server.rule.RulesDefinition.OwaspTop10Version.Y2021;

/**
 * Define all the coding rules that are supported on the repositories named &quot;xoo&quot; and &quot;xoo2&quot;
 */
public class XooRulesDefinition implements RulesDefinition {

<span class="fc" id="L60">  public static final String[] AVAILABLE_CONTEXTS = {&quot;javascript&quot;, &quot;jquery&quot;, &quot;express_js&quot;, &quot;react&quot;, &quot;axios&quot;};</span>

  public static final String XOO_REPOSITORY = &quot;xoo&quot;;
  public static final String XOO2_REPOSITORY = &quot;xoo2&quot;;

  private static final String TEN_MIN = &quot;10min&quot;;

  @Nullable
  private final Version version;

  @Nullable
  private final Configuration configuration;

  public XooRulesDefinition() {
<span class="fc" id="L74">    this(null, null);</span>
<span class="fc" id="L75">  }</span>

<span class="fc" id="L77">  public XooRulesDefinition(@Nullable SonarRuntime sonarRuntime, @Nullable Configuration configuration) {</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">    this.version = sonarRuntime != null ? sonarRuntime.getApiVersion() : null;</span>
<span class="fc" id="L79">    this.configuration = configuration;</span>
<span class="fc" id="L80">  }</span>

  @Override
  public void define(Context context) {
<span class="fc" id="L84">    defineRulesXoo(context);</span>
<span class="fc" id="L85">    defineRulesXoo2(context);</span>
<span class="fc" id="L86">    defineRulesXooExternal(context);</span>
<span class="fc" id="L87">    defineRulesXooExternalWithCct(context);</span>
<span class="fc" id="L88">  }</span>

  private static void defineRulesXoo2(Context context) {
<span class="fc" id="L91">    NewRepository repo = context.createRepository(XOO2_REPOSITORY, Xoo2.KEY).setName(&quot;Xoo2&quot;);</span>

<span class="fc" id="L93">    NewRule hasTag = repo.createRule(HasTagSensor.RULE_KEY).setName(&quot;Has Tag&quot;);</span>
<span class="fc" id="L94">    addAllDescriptionSections(hasTag, &quot;Search for a given tag in Xoo files&quot;);</span>

<span class="fc" id="L96">    NewRule oneIssuePerLine = repo.createRule(OneIssuePerLineSensor.RULE_KEY).setName(&quot;One Issue Per Line&quot;);</span>
<span class="fc" id="L97">    addAllDescriptionSections(oneIssuePerLine, &quot;Generate an issue on each line of a file. It requires the metric \&quot;lines\&quot;.&quot;);</span>
<span class="fc" id="L98">    oneIssuePerLine</span>
<span class="fc" id="L99">      .setDebtRemediationFunction(hasTag.debtRemediationFunctions().linear(&quot;1min&quot;))</span>
<span class="fc" id="L100">      .setGapDescription(&quot;It takes about 1 minute to an experienced software craftsman to remove a line of code&quot;);</span>

<span class="fc" id="L102">    repo.done();</span>
<span class="fc" id="L103">  }</span>

  private void defineRulesXoo(Context context) {
<span class="fc" id="L106">    NewRepository repo = context.createRepository(XOO_REPOSITORY, Xoo.KEY).setName(&quot;Xoo&quot;);</span>

<span class="fc" id="L108">    new RulesDefinitionAnnotationLoader().load(repo, Check.ALL);</span>

<span class="fc" id="L110">    NewRule hasTag = repo.createRule(HasTagSensor.RULE_KEY).setName(&quot;Has Tag&quot;)</span>
<span class="fc" id="L111">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L112">      .setActivatedByDefault(true)</span>
<span class="fc" id="L113">      .addDescriptionSection(howToFixSectionWithContext(&quot;single_context&quot;));</span>
<span class="fc" id="L114">    addDescriptionSectionsWithoutContexts(hasTag, &quot;Search for a given tag in Xoo files&quot;);</span>

<span class="fc" id="L116">    hasTag</span>
<span class="fc" id="L117">      .setDebtRemediationFunction(hasTag.debtRemediationFunctions().constantPerIssue(&quot;2min&quot;));</span>
<span class="fc" id="L118">    hasTag.createParam(&quot;tag&quot;)</span>
<span class="fc" id="L119">      .setDefaultValue(&quot;xoo&quot;)</span>
<span class="fc" id="L120">      .setDescription(&quot;The tag to search for&quot;);</span>

<span class="fc" id="L122">    NewRule ruleWithParameters = repo.createRule(&quot;RuleWithParameters&quot;).setName(&quot;Rule with parameters&quot;);</span>
<span class="fc" id="L123">    addAllDescriptionSections(ruleWithParameters,</span>
      &quot;Rule containing parameter of different types : boolean, integer, etc. For information, no issue will be linked to this rule.&quot;);
<span class="fc" id="L125">    ruleWithParameters.createParam(&quot;string&quot;).setType(RuleParamType.STRING);</span>
<span class="fc" id="L126">    ruleWithParameters.createParam(&quot;text&quot;).setType(RuleParamType.TEXT);</span>
<span class="fc" id="L127">    ruleWithParameters.createParam(&quot;boolean&quot;).setType(RuleParamType.BOOLEAN);</span>
<span class="fc" id="L128">    ruleWithParameters.createParam(&quot;integer&quot;).setType(RuleParamType.INTEGER);</span>
<span class="fc" id="L129">    ruleWithParameters.createParam(&quot;float&quot;).setType(RuleParamType.FLOAT);</span>

<span class="fc" id="L131">    Map&lt;SoftwareQuality, Severity&gt; customImpacts = getCustomImpactsForOneIssuePerLine();</span>
<span class="fc" id="L132">    NewRule oneIssuePerLine = repo.createRule(OneIssuePerLineSensor.RULE_KEY).setName(&quot;One Issue Per Line&quot;)</span>
<span class="fc" id="L133">      .setCleanCodeAttribute(CleanCodeAttribute.COMPLETE)</span>
<span class="fc" id="L134">      .setTags(&quot;line&quot;);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">    if (!customImpacts.isEmpty()) {</span>
<span class="nc" id="L136">      customImpacts.forEach(oneIssuePerLine::addDefaultImpact);</span>
    } else {
<span class="fc" id="L138">      oneIssuePerLine.addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.INFO);</span>
    }

<span class="fc" id="L141">    addDescriptionSectionsWithoutContexts(oneIssuePerLine, &quot;Generate an issue on each line of a file. It requires the metric \&quot;lines\&quot;.&quot;);</span>
<span class="fc" id="L142">    addHowToFixSectionsWithContexts(oneIssuePerLine);</span>
<span class="fc" id="L143">    oneIssuePerLine</span>
<span class="fc" id="L144">      .setDebtRemediationFunction(oneIssuePerLine.debtRemediationFunctions().linear(&quot;1min&quot;))</span>
<span class="fc" id="L145">      .setGapDescription(&quot;It takes about 1 minute to an experienced software craftsman to remove a line of code&quot;)</span>
<span class="fc" id="L146">      .addEducationPrincipleKeys(&quot;defense_in_depth&quot;, &quot;never_trust_user_input&quot;);</span>

<span class="fc" id="L148">    NewRule oneQuickFixPerLine = repo.createRule(OneQuickFixPerLineSensor.RULE_KEY).setName(&quot;One Quick Fix Per Line&quot;)</span>
<span class="fc" id="L149">      .setCleanCodeAttribute(CleanCodeAttribute.DISTINCT)</span>
<span class="fc" id="L150">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.BLOCKER)</span>
<span class="fc" id="L151">      .setTags(&quot;line&quot;);</span>
<span class="fc" id="L152">    addAllDescriptionSections(oneQuickFixPerLine,</span>
      &quot;Generate an issue with quick fix available on each line of a file. It requires the metric \&quot;lines\&quot;.&quot;);

<span class="fc" id="L155">    oneQuickFixPerLine</span>
<span class="fc" id="L156">      .setDebtRemediationFunction(oneQuickFixPerLine.debtRemediationFunctions().linear(&quot;1min&quot;))</span>
<span class="fc" id="L157">      .setGapDescription(&quot;It takes about 1 minute to an experienced software craftsman to remove a line of code&quot;);</span>

<span class="fc" id="L159">    NewRule oneIssueOnDirPerFile = repo.createRule(OneIssueOnDirPerFileSensor.RULE_KEY).setName(&quot;One Issue On Dir Per File&quot;);</span>
<span class="fc" id="L160">    addAllDescriptionSections(oneIssueOnDirPerFile,</span>
      &quot;Generate issues on directories&quot;);
<span class="fc" id="L162">    NewRule oneIssuePerFile = repo.createRule(OneIssuePerFileSensor.RULE_KEY).setName(&quot;One Issue Per File&quot;);</span>
<span class="fc" id="L163">    oneIssuePerFile.setDebtRemediationFunction(oneIssuePerFile.debtRemediationFunctions().linear(TEN_MIN));</span>
<span class="fc" id="L164">    addAllDescriptionSections(oneIssuePerFile, &quot;Generate an issue on each file&quot;);</span>

<span class="fc" id="L166">    NewRule oneIssuePerTestFile = repo.createRule(OneIssuePerTestFileSensor.RULE_KEY).setName(&quot;One Issue Per Test File&quot;)</span>
<span class="fc" id="L167">      .setScope(RuleScope.TEST);</span>
<span class="fc" id="L168">    oneIssuePerTestFile.setDebtRemediationFunction(oneIssuePerTestFile.debtRemediationFunctions().linear(&quot;8min&quot;));</span>
<span class="fc" id="L169">    addAllDescriptionSections(oneIssuePerTestFile, &quot;Generate an issue on each test file&quot;);</span>

<span class="fc" id="L171">    NewRule oneBugIssuePerTestLine = repo.createRule(OneBugIssuePerTestLineSensor.RULE_KEY).setName(&quot;One Bug Issue Per Test Line&quot;)</span>
<span class="fc" id="L172">      .setScope(RuleScope.TEST)</span>
<span class="fc" id="L173">      .setCleanCodeAttribute(CleanCodeAttribute.RESPECTFUL)</span>
<span class="fc" id="L174">      .addDefaultImpact(SoftwareQuality.RELIABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L175">      .setType(RuleType.BUG);</span>
<span class="fc" id="L176">    addAllDescriptionSections(oneBugIssuePerTestLine, &quot;Generate a bug issue on each line of a test file. It requires the metric \&quot;lines\&quot;.&quot;);</span>

<span class="fc" id="L178">    oneBugIssuePerTestLine</span>
<span class="fc" id="L179">      .setDebtRemediationFunction(oneBugIssuePerTestLine.debtRemediationFunctions().linear(&quot;4min&quot;));</span>

<span class="fc" id="L181">    NewRule oneCodeSmellIssuePerTestLine = repo.createRule(OneCodeSmellIssuePerTestLineSensor.RULE_KEY).setName(&quot;One Code Smell Issue Per Test Line&quot;)</span>
<span class="fc" id="L182">      .setScope(RuleScope.TEST)</span>
<span class="fc" id="L183">      .setCleanCodeAttribute(CleanCodeAttribute.TESTED)</span>
<span class="fc" id="L184">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L185">      .setType(RuleType.CODE_SMELL);</span>
<span class="fc" id="L186">    addAllDescriptionSections(oneCodeSmellIssuePerTestLine, &quot;Generate a code smell issue on each line of a test file. It requires the metric \&quot;lines\&quot;.&quot;);</span>

<span class="fc" id="L188">    oneCodeSmellIssuePerTestLine</span>
<span class="fc" id="L189">      .setDebtRemediationFunction(oneCodeSmellIssuePerTestLine.debtRemediationFunctions().linear(&quot;3min&quot;));</span>

<span class="fc" id="L191">    NewRule oneIssuePerDirectory = repo.createRule(OneIssuePerDirectorySensor.RULE_KEY)</span>
<span class="fc" id="L192">      .setName(&quot;One Issue Per Directory&quot;)</span>
<span class="fc" id="L193">      .setCleanCodeAttribute(CleanCodeAttribute.CLEAR)</span>
<span class="fc" id="L194">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.HIGH);</span>
<span class="fc" id="L195">    oneIssuePerDirectory.setDebtRemediationFunction(oneIssuePerDirectory.debtRemediationFunctions().linear(TEN_MIN));</span>
<span class="fc" id="L196">    addAllDescriptionSections(oneIssuePerDirectory, &quot;Generate an issue on each non-empty directory&quot;);</span>

<span class="fc" id="L198">    NewRule oneDayDebtPerFile = repo.createRule(OneDayDebtPerFileSensor.RULE_KEY).setName(&quot;One Day Debt Per File&quot;)</span>
<span class="fc" id="L199">      .setCleanCodeAttribute(CleanCodeAttribute.LAWFUL)</span>
<span class="fc" id="L200">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM);</span>
<span class="fc" id="L201">    oneDayDebtPerFile.setDebtRemediationFunction(oneDayDebtPerFile.debtRemediationFunctions().linear(&quot;1d&quot;));</span>
<span class="fc" id="L202">    addAllDescriptionSections(oneDayDebtPerFile, &quot;Generate an issue on each file with a debt of one day&quot;);</span>

<span class="fc" id="L204">    NewRule oneIssuePerProject = repo.createRule(OneIssuePerProjectSensor.RULE_KEY).setName(&quot;One Issue Per Project&quot;);</span>
<span class="fc" id="L205">    oneIssuePerProject</span>
<span class="fc" id="L206">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L207">      .setDebtRemediationFunction(oneIssuePerProject.debtRemediationFunctions().linearWithOffset(&quot;25min&quot;, &quot;1h&quot;))</span>
<span class="fc" id="L208">      .setGapDescription(&quot;A certified architect will need roughly half an hour to start working on removal of projects, &quot; +</span>
        &quot;then it's about one hour per project.&quot;);
<span class="fc" id="L210">    addAllDescriptionSections(oneIssuePerProject, &quot;Generate an issue on each project&quot;);</span>

<span class="fc" id="L212">    NewRule oneBlockerIssuePerFile = repo.createRule(OneBlockerIssuePerFileSensor.RULE_KEY).setName(&quot;One Blocker Issue Per File&quot;)</span>
<span class="fc" id="L213">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM);</span>
<span class="fc" id="L214">    addAllDescriptionSections(oneBlockerIssuePerFile, &quot;Generate a blocker issue on each file, whatever the severity declared in the Quality profile&quot;);</span>

<span class="fc" id="L216">    NewRule issueWithCustomMessage = repo.createRule(CustomMessageSensor.RULE_KEY).setName(&quot;Issue With Custom Message&quot;)</span>
<span class="fc" id="L217">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM);</span>
<span class="fc" id="L218">    addAllDescriptionSections(issueWithCustomMessage, &quot;Generate an issue on each file with a custom message&quot;);</span>

<span class="fc" id="L220">    NewRule oneIssuePerFileWithRandomAccess = repo.createRule(RandomAccessSensor.RULE_KEY).setName(&quot;One Issue Per File with Random Access&quot;)</span>
<span class="fc" id="L221">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM);</span>
<span class="fc" id="L222">    addAllDescriptionSections(oneIssuePerFileWithRandomAccess, &quot;This issue is generated on each file&quot;);</span>

<span class="fc" id="L224">    NewRule issueWithRangeAndMultipleLocations = repo.createRule(MultilineIssuesSensor.RULE_KEY).setName(&quot;Creates issues with ranges/multiple locations&quot;);</span>
<span class="fc" id="L225">    addAllDescriptionSections(issueWithRangeAndMultipleLocations, &quot;Issue with range and multiple locations&quot;);</span>

<span class="fc" id="L227">    NewRule hotspotWithRangeAndMultipleLocations = repo.createRule(MultilineHotspotSensor.RULE_KEY)</span>
<span class="fc" id="L228">      .setName(&quot;Creates hotspots with ranges/multiple locations&quot;)</span>
<span class="fc" id="L229">      .setType(RuleType.SECURITY_HOTSPOT);</span>
<span class="fc" id="L230">    addAllDescriptionSections(hotspotWithRangeAndMultipleLocations, &quot;Hotspot with range and multiple locations&quot;);</span>

<span class="fc" id="L232">    NewRule issueOnEachFileWithExtUnknown = repo.createRule(OneIssuePerUnknownFileSensor.RULE_KEY).setName(&quot;Creates issues on each file with extension 'unknown'&quot;);</span>
<span class="fc" id="L233">    addAllDescriptionSections(issueOnEachFileWithExtUnknown, &quot;This issue is generated on each file with extenstion 'unknown'&quot;);</span>

<span class="fc" id="L235">    NewRule oneBugIssuePerLine = repo.createRule(OneBugIssuePerLineSensor.RULE_KEY).setName(&quot;One Bug Issue Per Line&quot;)</span>
<span class="fc" id="L236">      .addDefaultImpact(SoftwareQuality.RELIABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L237">      .setType(RuleType.BUG);</span>
<span class="fc" id="L238">    oneBugIssuePerLine</span>
<span class="fc" id="L239">      .setDebtRemediationFunction(oneBugIssuePerLine.debtRemediationFunctions().linear(&quot;5min&quot;));</span>
<span class="fc" id="L240">    addAllDescriptionSections(oneBugIssuePerLine, &quot;Generate a bug issue on each line of a file. It requires the metric \&quot;lines\&quot;.&quot;);</span>

<span class="fc" id="L242">    NewRule oneCodeSmellIssuePerLine = repo.createRule(OneCodeSmellIssuePerLineSensor.RULE_KEY).setName(&quot;One Code Smell Issue Per Line&quot;)</span>
<span class="fc" id="L243">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.MEDIUM)</span>
<span class="fc" id="L244">      .addDefaultImpact(SoftwareQuality.RELIABILITY, Severity.LOW)</span>
<span class="fc" id="L245">      .setType(RuleType.CODE_SMELL);</span>
<span class="fc" id="L246">    oneCodeSmellIssuePerLine</span>
<span class="fc" id="L247">      .setDebtRemediationFunction(oneCodeSmellIssuePerLine.debtRemediationFunctions().linear(&quot;9min&quot;));</span>
<span class="fc" id="L248">    addAllDescriptionSections(oneCodeSmellIssuePerLine, &quot;Generate a code smell issue on each line of a file. It requires the metric \&quot;lines\&quot;.&quot;);</span>

<span class="fc" id="L250">    NewRule oneVulnerabilityIssuePerProject = repo.createRule(OneVulnerabilityIssuePerProjectSensor.RULE_KEY).setName(&quot;One Vulnerability Issue Per Project&quot;)</span>
<span class="fc" id="L251">      .addDefaultImpact(SoftwareQuality.SECURITY, Severity.MEDIUM)</span>
<span class="fc" id="L252">      .addDefaultImpact(SoftwareQuality.MAINTAINABILITY, Severity.HIGH)</span>
<span class="fc" id="L253">      .setCleanCodeAttribute(CleanCodeAttribute.TRUSTWORTHY)</span>
<span class="fc" id="L254">      .setType(RuleType.VULNERABILITY);</span>
<span class="fc" id="L255">    addAllDescriptionSections(oneVulnerabilityIssuePerProject, &quot;Generate an issue on each project&quot;);</span>

<span class="pc bpc" id="L257" title="1 of 4 branches missed.">    if (configuration != null &amp;&amp; configuration.get(&quot;sonar.xoo.OneVulnerabilityPerLine.securityStandards&quot;).isPresent()) {</span>
<span class="nc" id="L258">      String[] standards = configuration.get(&quot;sonar.xoo.OneVulnerabilityPerLine.securityStandards&quot;).get().split(&quot;,&quot;);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">      for (String standard : standards) {</span>
<span class="nc" id="L260">        NewRule oneVulnerabilityIssuePerSecurityStandard = repo.createRule(OneVulnerabilityPerSecurityStandardSensor.RULE_KEY_PREFIX + standard)</span>
<span class="nc" id="L261">          .setName(&quot;One Vulnerability per line containing '%s'&quot;.formatted(standard))</span>
<span class="nc" id="L262">          .addDefaultImpact(SoftwareQuality.SECURITY, Severity.MEDIUM)</span>
<span class="nc" id="L263">          .setCleanCodeAttribute(CleanCodeAttribute.TRUSTWORTHY)</span>
<span class="nc" id="L264">          .setType(RuleType.VULNERABILITY);</span>
<span class="nc" id="L265">        addSecurityStandard(oneVulnerabilityIssuePerSecurityStandard, standard);</span>
<span class="nc" id="L266">        addAllDescriptionSections(oneVulnerabilityIssuePerSecurityStandard, &quot;Generate an issue on each line containing '&quot; + standard + &quot;'.&quot;);</span>
      }
    }

<span class="fc" id="L270">    oneVulnerabilityIssuePerProject</span>
<span class="fc" id="L271">      .setDebtRemediationFunction(oneVulnerabilityIssuePerProject.debtRemediationFunctions().linearWithOffset(&quot;25min&quot;, &quot;1h&quot;))</span>
<span class="fc" id="L272">      .setGapDescription(&quot;A certified architect will need roughly half an hour to start working on removal of project, &quot; +</span>
        &quot;then it's about one hour per project.&quot;);

<span class="fc" id="L275">    NewRule templateofRule = repo</span>
<span class="fc" id="L276">      .createRule(&quot;xoo-template&quot;)</span>
<span class="fc" id="L277">      .setTemplate(true)</span>
<span class="fc" id="L278">      .setName(&quot;Template of rule&quot;);</span>
<span class="fc" id="L279">    addAllDescriptionSections(templateofRule, &quot;Template to be overridden by custom rules&quot;);</span>

<span class="fc" id="L281">    NewRule hotspot = repo.createRule(HotspotWithoutContextSensor.RULE_KEY)</span>
<span class="fc" id="L282">      .setName(&quot;Find security hotspots&quot;)</span>
<span class="fc" id="L283">      .setType(RuleType.SECURITY_HOTSPOT)</span>
<span class="fc" id="L284">      .setActivatedByDefault(false);</span>
<span class="fc" id="L285">    addAllDescriptionSections(hotspot, &quot;Search for Security Hotspots in Xoo files&quot;);</span>

<span class="fc" id="L287">    hotspot</span>
<span class="fc" id="L288">      .setDebtRemediationFunction(hotspot.debtRemediationFunctions().constantPerIssue(&quot;2min&quot;));</span>

<span class="fc" id="L290">    NewRule variants = repo.createRule(IssueWithCodeVariantsSensor.RULE_KEY).setName(&quot;Find issues with code variants&quot;);</span>
<span class="fc" id="L291">    addAllDescriptionSections(variants, &quot;Search for a given variant in Xoo files&quot;);</span>

<span class="pc bpc" id="L293" title="1 of 4 branches missed.">    if (version != null &amp;&amp; version.isGreaterThanOrEqual(Version.create(9, 3))) {</span>
<span class="fc" id="L294">      hotspot</span>
<span class="fc" id="L295">        .addOwaspTop10(OwaspTop10.A1, OwaspTop10.A3)</span>
<span class="fc" id="L296">        .addOwaspTop10(Y2021, OwaspTop10.A3, OwaspTop10.A2)</span>
<span class="fc" id="L297">        .addOwaspMobileTop10(Y2024, OwaspMobileTop10.M4, OwaspMobileTop10.M8)</span>
<span class="fc" id="L298">        .addCwe(1, 89, 123, 863);</span>

<span class="fc" id="L300">      oneVulnerabilityIssuePerProject</span>
<span class="fc" id="L301">        .addOwaspTop10(Y2017, OwaspTop10.A9, OwaspTop10.A10)</span>
<span class="fc" id="L302">        .addOwaspTop10(Y2021, OwaspTop10.A6, OwaspTop10.A9)</span>
<span class="fc" id="L303">        .addOwaspMobileTop10(Y2024, OwaspMobileTop10.M3, OwaspMobileTop10.M5)</span>
<span class="fc" id="L304">        .addCwe(89, 250, 311, 546, 564, 943);</span>
    }

<span class="pc bpc" id="L307" title="1 of 4 branches missed.">    if (version != null &amp;&amp; version.isGreaterThanOrEqual(Version.create(9, 5))) {</span>
<span class="fc" id="L308">      hotspot</span>
<span class="fc" id="L309">        .addPciDss(PciDssVersion.V4_0, &quot;6.5.1&quot;, &quot;4.1&quot;)</span>
<span class="fc" id="L310">        .addPciDss(PciDssVersion.V3_2, &quot;6.5.1&quot;, &quot;4.2&quot;)</span>
<span class="fc" id="L311">        .addPciDss(PciDssVersion.V4_0, &quot;6.5a.1&quot;, &quot;4.2c&quot;)</span>
<span class="fc" id="L312">        .addPciDss(PciDssVersion.V3_2, &quot;6.5a.1b&quot;, &quot;4.2b&quot;);</span>

<span class="fc" id="L314">      oneVulnerabilityIssuePerProject</span>
<span class="fc" id="L315">        .addPciDss(PciDssVersion.V4_0, &quot;10.1&quot;)</span>
<span class="fc" id="L316">        .addPciDss(PciDssVersion.V3_2, &quot;10.2&quot;)</span>
<span class="fc" id="L317">        .addPciDss(PciDssVersion.V4_0, &quot;10.1a.2b&quot;)</span>
<span class="fc" id="L318">        .addPciDss(PciDssVersion.V3_2, &quot;10.1a.2c&quot;);</span>
    }

<span class="pc bpc" id="L321" title="1 of 4 branches missed.">    if (version != null &amp;&amp; version.isGreaterThanOrEqual(Version.create(9, 6))) {</span>
<span class="fc" id="L322">      hotspot</span>
<span class="fc" id="L323">        .addOwaspAsvs(OwaspAsvsVersion.V4_0, &quot;2.8.7&quot;, &quot;3.1.1&quot;, &quot;4.2.2&quot;);</span>
<span class="fc" id="L324">      oneVulnerabilityIssuePerProject</span>
<span class="fc" id="L325">        .addOwaspAsvs(OwaspAsvsVersion.V4_0, &quot;11.1.2&quot;, &quot;14.5.1&quot;, &quot;14.5.4&quot;);</span>
    }

<span class="pc bpc" id="L328" title="1 of 4 branches missed.">    if (version != null &amp;&amp; version.isGreaterThanOrEqual(Version.create(10, 7))) {</span>
<span class="fc" id="L329">      hotspot</span>
<span class="fc" id="L330">        .addStig(StigVersion.ASD_V5R3, &quot;V-222599&quot;, &quot;V-222615&quot;, &quot;V-222653&quot;);</span>
<span class="fc" id="L331">      oneVulnerabilityIssuePerProject</span>
<span class="fc" id="L332">        .addStig(StigVersion.ASD_V5R3, &quot;V-222596&quot;, &quot;V-222608&quot;, &quot;V-222653&quot;);</span>
    }

<span class="fc" id="L335">    NewRule hotspotWithContexts = repo.createRule(HotspotWithContextsSensor.RULE_KEY)</span>
<span class="fc" id="L336">      .setName(&quot;Find security hotspots with contexts&quot;)</span>
<span class="fc" id="L337">      .setType(RuleType.SECURITY_HOTSPOT)</span>
<span class="fc" id="L338">      .setActivatedByDefault(false);</span>
<span class="fc" id="L339">    addDescriptionSectionsWithoutContexts(hotspotWithContexts, &quot;Search for Security Hotspots with contexts in Xoo files&quot;);</span>
<span class="fc" id="L340">    addHowToFixSectionsWithContexts(hotspotWithContexts);</span>

<span class="fc" id="L342">    NewRule hotspotWithSingleContext = repo.createRule(HotspotWithSingleContextSensor.RULE_KEY)</span>
<span class="fc" id="L343">      .setName(&quot;Find security hotspots, how_to_fix with single context&quot;)</span>
<span class="fc" id="L344">      .setType(RuleType.SECURITY_HOTSPOT)</span>
<span class="fc" id="L345">      .setActivatedByDefault(false)</span>
<span class="fc" id="L346">      .addDescriptionSection(howToFixSectionWithContext(&quot;single_context&quot;));</span>
<span class="fc" id="L347">    addDescriptionSectionsWithoutContexts(hotspotWithSingleContext, &quot;Search for Security Hotspots with single context in Xoo files&quot;);</span>

<span class="fc" id="L349">    NewRule hotspotWithCodeVariants = repo.createRule(HotspotWithCodeVariantsSensor.RULE_KEY)</span>
<span class="fc" id="L350">      .setName(&quot;Find security hotspots with code variants&quot;)</span>
<span class="fc" id="L351">      .setType(RuleType.SECURITY_HOTSPOT)</span>
<span class="fc" id="L352">      .setActivatedByDefault(false);</span>
<span class="fc" id="L353">    addAllDescriptionSections(hotspotWithCodeVariants, &quot;Search for a given variant in Xoo files&quot;);</span>

<span class="fc" id="L355">    repo.done();</span>
<span class="fc" id="L356">  }</span>

  private Map&lt;SoftwareQuality, Severity&gt; getCustomImpactsForOneIssuePerLine() {
<span class="fc" id="L359">    Map&lt;SoftwareQuality, Severity&gt; customImpacts = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L360" title="1 of 4 branches missed.">    if (configuration != null &amp;&amp; configuration.get(&quot;sonar.xoo.OneIssuePerLine.impacts&quot;).isPresent()) {</span>
<span class="nc" id="L361">      String[] impacts = configuration.get(&quot;sonar.xoo.OneIssuePerLine.impacts&quot;).get().split(&quot;,&quot;);</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">      for (String impact : impacts) {</span>
<span class="nc" id="L363">        String[] impactArray = impact.split(&quot;:&quot;);</span>
<span class="nc" id="L364">        customImpacts.put(SoftwareQuality.valueOf(impactArray[0]), Severity.valueOf(impactArray[1]));</span>
      }
    }
<span class="fc" id="L367">    return customImpacts;</span>
  }

  private void addSecurityStandard(NewRule rule, String standard) {
<span class="nc" id="L371">    String[] splitStandard = standard.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L372" title="All 7 branches missed.">    switch (splitStandard[0]) {</span>
      case &quot;cwe&quot;:
<span class="nc" id="L374">        rule.addCwe(Integer.parseInt(splitStandard[1]));</span>
<span class="nc" id="L375">        break;</span>
      case &quot;owaspTop10&quot;:
<span class="nc" id="L377">        rule.addOwaspTop10(Y2017, OwaspTop10.valueOf(splitStandard[1]));</span>
<span class="nc" id="L378">        break;</span>
      case &quot;owaspTop10-2021&quot;:
<span class="nc" id="L380">        rule.addOwaspTop10(Y2021, OwaspTop10.valueOf(splitStandard[1]));</span>
<span class="nc" id="L381">        break;</span>
      case &quot;stig-ASD_V5R3&quot;:
<span class="nc bnc" id="L383" title="All 4 branches missed.">        if (version != null &amp;&amp; version.isGreaterThanOrEqual(Version.create(10, 7))) {</span>
<span class="nc" id="L384">          rule.addStig(StigVersion.ASD_V5R3, splitStandard[1]);</span>
        }
        break;
      case &quot;pciDss-3.2&quot;:
<span class="nc" id="L388">        rule.addPciDss(PciDssVersion.V3_2, splitStandard[1]);</span>
<span class="nc" id="L389">        break;</span>
      case &quot;pciDss-4.0&quot;:
<span class="nc" id="L391">        rule.addPciDss(PciDssVersion.V4_0, splitStandard[1]);</span>
<span class="nc" id="L392">        break;</span>
      default:
<span class="nc" id="L394">        throw new IllegalArgumentException(&quot;Unknown standard: &quot; + standard);</span>
    }
<span class="nc" id="L396">  }</span>

  private static void defineRulesXooExternalWithCct(Context context) {
<span class="fc" id="L399">    NewRepository repo = context.createExternalRepository(OneExternalIssueCctPerLineSensor.ENGINE_ID, Xoo.KEY).setName(OneExternalIssueCctPerLineSensor.ENGINE_ID);</span>

<span class="fc" id="L401">    repo.createRule(OnePredefinedRuleExternalIssueCctPerLineSensor.RULE_ID)</span>
<span class="fc" id="L402">      .setScope(RuleScope.ALL)</span>
<span class="fc" id="L403">      .setHtmlDescription(&quot;Generates one external issue in each line&quot;)</span>
<span class="fc" id="L404">      .addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY, &quot;Generates one external issue in each line&quot;))</span>
<span class="fc" id="L405">      .setName(&quot;One external issue per line&quot;);</span>

<span class="fc" id="L407">    repo.done();</span>
<span class="fc" id="L408">  }</span>

  private static void defineRulesXooExternal(Context context) {
<span class="fc" id="L411">    NewRepository repo = context.createExternalRepository(OneExternalIssuePerLineSensor.ENGINE_ID, Xoo.KEY).setName(OneExternalIssuePerLineSensor.ENGINE_ID);</span>

<span class="fc" id="L413">    repo.createRule(OnePredefinedRuleExternalIssuePerLineSensor.RULE_ID)</span>
<span class="fc" id="L414">      .setSeverity(OnePredefinedRuleExternalIssuePerLineSensor.SEVERITY)</span>
<span class="fc" id="L415">      .setType(OnePredefinedRuleExternalIssuePerLineSensor.TYPE)</span>
<span class="fc" id="L416">      .setScope(RuleScope.ALL)</span>
<span class="fc" id="L417">      .setHtmlDescription(&quot;Generates one external issue in each line&quot;)</span>
<span class="fc" id="L418">      .addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY, &quot;Generates one external issue in each line&quot;))</span>
<span class="fc" id="L419">      .setName(&quot;One external issue per line&quot;)</span>
<span class="fc" id="L420">      .setTags(&quot;riri&quot;, &quot;fifi&quot;, &quot;loulou&quot;);</span>

<span class="fc" id="L422">    repo.done();</span>
<span class="fc" id="L423">  }</span>

  private static void addAllDescriptionSections(NewRule rule, String description) {
<span class="fc" id="L426">    addDescriptionSectionsWithoutContexts(rule, description);</span>
<span class="fc" id="L427">    rule.addDescriptionSection(descriptionSection(HOW_TO_FIX_SECTION_KEY, &quot;How to fix: &quot; + description));</span>
<span class="fc" id="L428">  }</span>

  private static void addDescriptionSectionsWithoutContexts(NewRule rule, String description) {
<span class="fc" id="L431">    rule</span>
<span class="fc" id="L432">      .setHtmlDescription(description)</span>
<span class="fc" id="L433">      .addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY, &quot;Introduction: &quot; + description))</span>
<span class="fc" id="L434">      .addDescriptionSection(descriptionSection(ROOT_CAUSE_SECTION_KEY, &quot;Root cause: &quot; + description))</span>
<span class="fc" id="L435">      .addDescriptionSection(descriptionSection(ASSESS_THE_PROBLEM_SECTION_KEY, &quot;Assess the problem: &quot; + description))</span>
<span class="fc" id="L436">      .addDescriptionSection(descriptionSection(RESOURCES_SECTION_KEY,</span>
        &quot;&lt;a href=\&quot;www.google.fr\&quot;&gt; Google &lt;/a&gt;&lt;br&gt;&lt;a href=\&quot;https://stackoverflow.com/\&quot;&gt; StackOverflow&lt;/a&gt;&quot;))
<span class="fc" id="L438">      .addDescriptionSection(descriptionSection(&quot;fake_section_to_be_ignored&quot;,</span>
        &quot;fake_section_to_be_ignored&quot;));
<span class="fc" id="L440">  }</span>

  private static void addHowToFixSectionsWithContexts(NewRule rule) {
<span class="fc bfc" id="L443" title="All 2 branches covered.">    for (String contextName : AVAILABLE_CONTEXTS) {</span>
<span class="fc" id="L444">      rule.addDescriptionSection(howToFixSectionWithContext(contextName));</span>
    }
<span class="fc" id="L446">  }</span>

  private static RuleDescriptionSection descriptionSection(String sectionKey, String htmlDescription) {
<span class="fc" id="L449">    return RuleDescriptionSection.builder()</span>
<span class="fc" id="L450">      .sectionKey(sectionKey)</span>
<span class="fc" id="L451">      .htmlContent(htmlDescription)</span>
<span class="fc" id="L452">      .build();</span>
  }

  private static RuleDescriptionSection howToFixSectionWithContext(String contextName) {
<span class="fc" id="L456">    return RuleDescriptionSection.builder()</span>
<span class="fc" id="L457">      .sectionKey(HOW_TO_FIX_SECTION_KEY)</span>
<span class="fc" id="L458">      .htmlContent(String.format(&quot;This is 'How to fix?' description section for the &lt;a href=\&quot;https://stackoverflow.com/\&quot;&gt; %s&lt;/a&gt;. &quot; +</span>
        &quot;This text can be very long.&quot;, contextName))
<span class="fc" id="L460">      .context(new org.sonar.api.server.rule.Context(contextName, contextName))</span>
<span class="fc" id="L461">      .build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>