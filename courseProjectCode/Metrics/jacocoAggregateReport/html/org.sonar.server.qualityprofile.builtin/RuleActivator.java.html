<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleActivator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.qualityprofile.builtin</a> &gt; <span class="el_source">RuleActivator.java</span></div><h1>RuleActivator.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.qualityprofile.builtin;

import com.google.common.base.Splitter;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.apache.commons.lang3.StringUtils;
import org.sonar.api.config.Configuration;
import org.sonar.api.issue.impact.Severity;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.server.ServerSide;
import org.sonar.api.server.rule.RuleParamType;
import org.sonar.api.utils.System2;
import org.sonar.core.config.CorePropertyDefinitions;
import org.sonar.core.platform.SonarQubeVersion;
import org.sonar.core.util.UuidFactory;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.qualityprofile.ActiveRuleDao;
import org.sonar.db.qualityprofile.ActiveRuleDto;
import org.sonar.db.qualityprofile.ActiveRuleKey;
import org.sonar.db.qualityprofile.ActiveRuleParamDto;
import org.sonar.db.qualityprofile.OrgQProfileDto;
import org.sonar.db.qualityprofile.QProfileChangeDto;
import org.sonar.db.qualityprofile.QProfileDto;
import org.sonar.db.qualityprofile.RulesProfileDto;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.server.qualityprofile.ActiveRuleChange;
import org.sonar.server.qualityprofile.ActiveRuleInheritance;
import org.sonar.server.qualityprofile.QProfileImpactSeverityMapper;
import org.sonar.server.qualityprofile.RuleActivation;
import org.sonar.server.qualityprofile.builtin.RuleActivationContext.ActiveRuleWrapper;
import org.sonar.server.qualityprofile.builtin.RuleActivationContext.RuleWrapper;
import org.sonar.server.user.UserSession;
import org.sonar.server.util.TypeValidations;

import static com.google.common.base.Preconditions.checkArgument;
import static java.lang.Boolean.TRUE;
import static org.sonar.server.exceptions.BadRequestException.checkRequest;

/**
 * Activation and deactivation of rules in Quality profiles
 */
@ServerSide
public class RuleActivator {

  private final System2 system2;
  private final DbClient db;
  private final UuidFactory uuidFactory;
  private final TypeValidations typeValidations;
  private final UserSession userSession;
  private final Configuration configuration;
  private final SonarQubeVersion sonarQubeVersion;

  public RuleActivator(System2 system2, DbClient db, UuidFactory uuidFactory, TypeValidations typeValidations, UserSession userSession,
<span class="fc" id="L85">    Configuration configuration, SonarQubeVersion sonarQubeVersion) {</span>
<span class="fc" id="L86">    this.system2 = system2;</span>
<span class="fc" id="L87">    this.db = db;</span>
<span class="fc" id="L88">    this.uuidFactory = uuidFactory;</span>
<span class="fc" id="L89">    this.typeValidations = typeValidations;</span>
<span class="fc" id="L90">    this.userSession = userSession;</span>
<span class="fc" id="L91">    this.configuration = configuration;</span>
<span class="fc" id="L92">    this.sonarQubeVersion = sonarQubeVersion;</span>
<span class="fc" id="L93">  }</span>

  public List&lt;ActiveRuleChange&gt; activate(DbSession dbSession, Collection&lt;RuleActivation&gt; activations, RuleActivationContext context) {
<span class="fc" id="L96">    return activations.stream().map(a -&gt; activate(dbSession, a, context))</span>
<span class="fc" id="L97">      .flatMap(List::stream)</span>
<span class="fc" id="L98">      .toList();</span>
  }

  public List&lt;ActiveRuleChange&gt; activate(DbSession dbSession, RuleActivation activation, RuleActivationContext context) {
<span class="fc" id="L102">    context.reset(activation.getRuleUuid());</span>
<span class="fc" id="L103">    return doActivateRecursively(dbSession, activation, context);</span>
  }

  private List&lt;ActiveRuleChange&gt; doActivateRecursively(DbSession dbSession, RuleActivation activation, RuleActivationContext context) {
<span class="fc" id="L107">    RuleDto rule = context.getRule().get();</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">    checkRequest(RuleStatus.REMOVED != rule.getStatus(), &quot;Rule was removed: %s&quot;, rule.getKey());</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">    checkRequest(!rule.isTemplate(), &quot;Rule template can't be activated on a Quality profile: %s&quot;, rule.getKey());</span>
<span class="fc" id="L110">    checkRequest(context.getRulesProfile().getLanguage().equals(rule.getLanguage()),</span>
<span class="fc" id="L111">      &quot;%s rule %s cannot be activated on %s profile %s&quot;, rule.getLanguage(), rule.getKey(), context.getRulesProfile().getLanguage(),</span>
<span class="fc" id="L112">      context.getRulesProfile().getName());</span>
<span class="fc" id="L113">    List&lt;ActiveRuleChange&gt; changes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L114">    ActiveRuleChange change = null;</span>

<span class="fc" id="L116">    ActiveRuleWrapper activeRule = context.getActiveRule();</span>
<span class="fc" id="L117">    ActiveRuleKey activeRuleKey = ActiveRuleKey.of(context.getRulesProfile(), rule.getKey());</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">    if (activeRule == null) {</span>
<span class="fc bfc" id="L119" title="All 4 branches covered.">      if (activation.isReset() || skipBuiltinRuleActivation(activation, context)) {</span>
<span class="fc" id="L120">        return changes;</span>
      }
<span class="fc" id="L122">      change = handleNewRuleActivation(activation, context, rule, activeRuleKey);</span>
    } else {
      // already activated

      // No change if propagating to descendants, but child profile already overrides rule
<span class="fc bfc" id="L127" title="All 4 branches covered.">      if (!context.isCascading() || !activeRule.get().doesOverride()) {</span>
<span class="fc" id="L128">        change = new ActiveRuleChange(ActiveRuleChange.Type.UPDATED, activeRuleKey, rule);</span>
<span class="fc" id="L129">        change.setRule(context.getRule().get());</span>
<span class="fc" id="L130">        handleUpdatedRuleActivation(activation, context, change, activeRule);</span>

<span class="fc bfc" id="L132" title="All 8 branches covered.">        if (isSame(change, activeRule) || (context.isCascading() &amp;&amp; activeRule.get().getInheritance() != null &amp;&amp; !isSameAsParent(change,</span>
          context))) {
          // The rule config hasn't changed; or the rule is being propagated but the parent has a different config,
          // which means the rule was overridden by a profile in the inheritance chain
<span class="fc" id="L136">          change = null;</span>
        }
      }
    }

<span class="fc bfc" id="L141" title="All 2 branches covered.">    if (change != null) {</span>
<span class="fc" id="L142">      changes.add(change);</span>
<span class="fc" id="L143">      persist(change, context, dbSession);</span>
<span class="fc" id="L144">      updateProfileDates(dbSession, context);</span>
    }

    // get all inherited profiles
<span class="fc bfc" id="L148" title="All 2 branches covered.">    for (QProfileDto child : context.getChildProfiles()) {</span>
<span class="fc" id="L149">      context.selectChild(child);</span>
<span class="fc" id="L150">      changes.addAll(doActivateRecursively(dbSession, activation, context));</span>
<span class="fc" id="L151">    }</span>

<span class="fc" id="L153">    return changes;</span>
  }

  private static boolean skipBuiltinRuleActivation(RuleActivation activation, RuleActivationContext context) {
    // SONAR-23184: If the rule isn't active for a child profile and it is active for the previous parent definition of the profile,
    // it means it was deactivated on purpose by a user - we don't want to active it.
<span class="fc bfc" id="L159" title="All 4 branches covered.">    return context.isCascading() &amp;&amp; context.getPreviousBuiltinActiveRuleUuids().contains(activation.getRuleUuid());</span>
  }

  private void handleUpdatedRuleActivation(RuleActivation activation, RuleActivationContext context, ActiveRuleChange change,
    ActiveRuleWrapper activeRule) {
<span class="fc bfc" id="L164" title="All 4 branches covered.">    if (context.isCascading() &amp;&amp; activeRule.get().getInheritance() == null) {</span>
      // The rule is being propagated, but it was activated directly on this profile before
<span class="fc" id="L166">      change.setSeverity(activeRule.get().getSeverityString());</span>
<span class="fc" id="L167">      change.setNewImpacts(activeRule.get().getImpacts());</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">      for (ActiveRuleParamDto activeParam : activeRule.getParams()) {</span>
<span class="fc" id="L169">        change.setParameter(activeParam.getKey(), activeParam.getValue());</span>
<span class="fc" id="L170">      }</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">      change.setInheritance(isSameAsParent(change, context) ? ActiveRuleInheritance.INHERITED : ActiveRuleInheritance.OVERRIDES);</span>
    } else {
<span class="fc" id="L173">      applySeverityAndPrioritizedRuleAndParamToChange(activation, context, change);</span>
<span class="fc bfc" id="L174" title="All 4 branches covered.">      if (!context.isCascading() &amp;&amp; context.getParentActiveRule() != null) {</span>
        // override rule which is already declared on parents
<span class="fc bfc" id="L176" title="All 2 branches covered.">        change.setInheritance(isSameAsParent(change, context) ? ActiveRuleInheritance.INHERITED : ActiveRuleInheritance.OVERRIDES);</span>
      }
    }
<span class="fc" id="L179">  }</span>

  private ActiveRuleChange handleNewRuleActivation(RuleActivation activation, RuleActivationContext context, RuleDto rule,
    ActiveRuleKey activeRuleKey) {
<span class="fc" id="L183">    ActiveRuleChange change = new ActiveRuleChange(ActiveRuleChange.Type.ACTIVATED, activeRuleKey, rule);</span>
<span class="fc" id="L184">    applySeverityAndPrioritizedRuleAndParamToChange(activation, context, change);</span>
<span class="fc bfc" id="L185" title="All 4 branches covered.">    if (context.isCascading() || context.getParentActiveRule() != null) {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">      change.setInheritance(isSameAsParent(change, context) ? ActiveRuleInheritance.INHERITED : ActiveRuleInheritance.OVERRIDES);</span>
    }
<span class="fc" id="L188">    return change;</span>
  }

  private void updateProfileDates(DbSession dbSession, RuleActivationContext context) {
<span class="fc" id="L192">    RulesProfileDto ruleProfile = context.getRulesProfile();</span>
<span class="fc" id="L193">    ruleProfile.setRulesUpdatedAtAsDate(new Date(context.getDate()));</span>
<span class="fc" id="L194">    db.qualityProfileDao().update(dbSession, ruleProfile);</span>

<span class="fc bfc" id="L196" title="All 2 branches covered.">    if (userSession.isLoggedIn()) {</span>
<span class="fc" id="L197">      context.getProfiles().forEach(p -&gt; db.qualityProfileDao().update(dbSession,</span>
<span class="fc" id="L198">        OrgQProfileDto.from(p).setUserUpdatedAt(context.getDate())));</span>
    }
<span class="fc" id="L200">  }</span>

  /**
   * Update severity, prioritizedRule and params
   */
  private void applySeverityAndPrioritizedRuleAndParamToChange(RuleActivation request, RuleActivationContext context,
    ActiveRuleChange change) {
<span class="fc" id="L207">    RuleWrapper rule = context.getRule();</span>
<span class="fc" id="L208">    ActiveRuleWrapper activeRule = context.getActiveRule();</span>
<span class="fc" id="L209">    ActiveRuleWrapper parentActiveRule = context.getParentActiveRule();</span>

<span class="fc bfc" id="L211" title="All 2 branches covered.">    if (request.isReset()) {</span>
<span class="fc" id="L212">      applySeverityAndPrioritizedRuleAndParamsWhenResetRequested(change, rule, activeRule, parentActiveRule);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">    } else if (context.getRulesProfile().isBuiltIn()) {</span>
<span class="fc" id="L214">      applySeverityAndPrioritizedRuleAndParamsWhenBuiltInProfile(request, context, change, rule, activeRule);</span>
    } else {
<span class="fc" id="L216">      applySeverityAndPrioritizedRuleAndParamsWhenNonBuiltInProfile(request, context, change, rule, activeRule, parentActiveRule);</span>
    }
<span class="fc" id="L218">  }</span>

  private void applySeverityAndPrioritizedRuleAndParamsWhenResetRequested(ActiveRuleChange change, RuleWrapper rule, @Nullable ActiveRuleWrapper currentActiveRule,
    @Nullable ActiveRuleWrapper parentActiveRule) {
<span class="fc" id="L222">    String severity = firstNonNull(</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">      parentActiveRule != null ? parentActiveRule.get().getSeverityString() : null,</span>
<span class="fc" id="L224">      rule.get().getSeverityString());</span>
<span class="fc" id="L225">    change.setSeverity(severity);</span>

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    Map&lt;SoftwareQuality, Severity&gt; oldImpactSeverities = currentActiveRule != null ? currentActiveRule.get().getImpacts() : Map.of();</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">    Map&lt;SoftwareQuality, Severity&gt; impactsSeverities = parentActiveRule != null ? parentActiveRule.get().getImpacts()</span>
<span class="fc" id="L229">      : rule.get().getDefaultImpactsMap();</span>
<span class="fc" id="L230">    change.setOldImpacts(oldImpactSeverities);</span>
<span class="fc" id="L231">    change.setNewImpacts(impactsSeverities);</span>

<span class="pc bpc" id="L233" title="1 of 4 branches missed.">    change.setPrioritizedRule(parentActiveRule != null &amp;&amp; parentActiveRule.get().isPrioritizedRule());</span>

<span class="fc bfc" id="L235" title="All 2 branches covered.">    for (RuleParamDto ruleParamDto : rule.getParams()) {</span>
<span class="fc" id="L236">      String paramKey = ruleParamDto.getName();</span>
      // load params from parent profile, else from default values
<span class="fc" id="L238">      String paramValue = firstNonNull(</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">        parentActiveRule != null ? parentActiveRule.getParamValue(paramKey) : null,</span>
<span class="fc" id="L240">        rule.getParamDefaultValue(paramKey));</span>

<span class="fc" id="L242">      change.setParameter(paramKey, validateParam(ruleParamDto, paramValue));</span>
<span class="fc" id="L243">    }</span>
<span class="fc" id="L244">  }</span>

  private void applySeverityAndPrioritizedRuleAndParamsWhenBuiltInProfile(RuleActivation request, RuleActivationContext context,
    ActiveRuleChange change, RuleWrapper rule, @Nullable ActiveRuleWrapper currentActiveRule) {
    // for builtin quality profiles, the severity from profile, when null use the default severity of the rule
<span class="fc" id="L249">    SeverityConfiguration severityConfiguration = determineSeverityConfiguration(request, rule.get(), null, null);</span>
<span class="fc" id="L250">    change.setSeverity(severityConfiguration.severity());</span>

<span class="fc bfc" id="L252" title="All 2 branches covered.">    Map&lt;SoftwareQuality, Severity&gt; oldImpactSeverities = currentActiveRule != null ? currentActiveRule.get().getImpacts() : Map.of();</span>
<span class="fc" id="L253">    change.setOldImpacts(oldImpactSeverities);</span>
<span class="fc" id="L254">    change.setNewImpacts(severityConfiguration.impacts());</span>

<span class="fc" id="L256">    boolean prioritizedRule = TRUE.equals(request.isPrioritizedRule());</span>
<span class="fc" id="L257">    change.setPrioritizedRule(prioritizedRule);</span>

<span class="fc bfc" id="L259" title="All 2 branches covered.">    for (RuleParamDto ruleParamDto : rule.getParams()) {</span>
<span class="fc" id="L260">      String paramKey = ruleParamDto.getName();</span>
      // use the value defined in the profile definition, else the rule default value
<span class="fc" id="L262">      String paramValue = firstNonNull(</span>
<span class="fc" id="L263">        context.getRequestedParamValue(request, paramKey),</span>
<span class="fc" id="L264">        rule.getParamDefaultValue(paramKey));</span>
<span class="fc" id="L265">      change.setParameter(paramKey, validateParam(ruleParamDto, paramValue));</span>
<span class="fc" id="L266">    }</span>
<span class="fc" id="L267">  }</span>

  private static SeverityConfiguration determineSeverityConfiguration(RuleActivation request, RuleDto ruleDto, @Nullable ActiveRuleWrapper activeRule,
    @Nullable ActiveRuleWrapper parentActiveRule) {
<span class="fc" id="L271">    String requestSeverity = request.getSeverity();</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">    if (requestSeverity != null) {</span>
<span class="fc" id="L273">      Map&lt;SoftwareQuality, Severity&gt; impactSeverities = request.getImpactSeverities();</span>
<span class="pc bpc" id="L274" title="1 of 4 branches missed.">      if (impactSeverities != null &amp;&amp; !impactSeverities.isEmpty()) {</span>
<span class="fc" id="L275">        return new SeverityConfiguration(requestSeverity, impactSeverities);</span>
      }
      // When standard severity is requested to be overridden, we translate it to the impact to override
<span class="fc" id="L278">      return new SeverityConfiguration(requestSeverity,</span>
<span class="fc" id="L279">        QProfileImpactSeverityMapper.mapImpactSeverities(requestSeverity, ruleDto.getDefaultImpactsMap(), ruleDto.getEnumType()));</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">    } else if (!request.getImpactSeverities().isEmpty()) {</span>
      // If an impact is request to be overridden, we translate it to the standard severity
<span class="fc" id="L282">      return new SeverityConfiguration(</span>
<span class="fc" id="L283">        QProfileImpactSeverityMapper.mapSeverity(request.getImpactSeverities(), ruleDto.getEnumType(), ruleDto.getSeverityString()),</span>
<span class="fc" id="L284">        request.getImpactSeverities());</span>
<span class="fc bfc" id="L285" title="All 4 branches covered.">    } else if (activeRule != null &amp;&amp; activeRule.get().doesOverride()) {</span>
<span class="fc" id="L286">      return new SeverityConfiguration(activeRule.get().getSeverityString(), activeRule.get().getImpacts());</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">    } else if (parentActiveRule != null) {</span>
<span class="fc" id="L288">      return new SeverityConfiguration(parentActiveRule.get().getSeverityString(), parentActiveRule.get().getImpacts());</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">    } else if (activeRule != null) {</span>
<span class="fc" id="L290">      return new SeverityConfiguration(activeRule.get().getSeverityString(), activeRule.get().getImpacts());</span>
    } else {
<span class="fc" id="L292">      return new SeverityConfiguration(ruleDto.getSeverityString(), ruleDto.getDefaultImpactsMap());</span>
    }
  }

  /**
   * 1. apply requested severity and param
   * 2. if rule activated and overridden - apply user value
   * 3. apply parent value
   * 4. apply defaults
   */
  private void applySeverityAndPrioritizedRuleAndParamsWhenNonBuiltInProfile(RuleActivation request, RuleActivationContext context,
    ActiveRuleChange change,
    RuleWrapper rule, @Nullable ActiveRuleWrapper currentActiveRule, @Nullable ActiveRuleWrapper parentActiveRule) {
<span class="fc" id="L305">    SeverityConfiguration severityConfiguration = getSeverityConfigurationForNonBuiltInProfile(request, rule, currentActiveRule, parentActiveRule);</span>
<span class="fc" id="L306">    boolean prioritizedRule = getPrioritizedRuleForNonBuiltInProfile(request, currentActiveRule, parentActiveRule);</span>
<span class="fc" id="L307">    change.setSeverity(severityConfiguration.severity());</span>

<span class="fc bfc" id="L309" title="All 2 branches covered.">    Map&lt;SoftwareQuality, Severity&gt; oldImpactSeverities = currentActiveRule != null ? currentActiveRule.get().getImpacts() : Map.of();</span>
<span class="fc" id="L310">    change.setOldImpacts(oldImpactSeverities);</span>
<span class="fc" id="L311">    change.setNewImpacts(severityConfiguration.impacts());</span>
<span class="fc" id="L312">    change.setPrioritizedRule(prioritizedRule);</span>

<span class="fc bfc" id="L314" title="All 2 branches covered.">    for (RuleParamDto ruleParamDto : rule.getParams()) {</span>
<span class="fc" id="L315">      String paramKey = ruleParamDto.getName();</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">      String parentValue = parentActiveRule != null ? parentActiveRule.getParamValue(paramKey) : null;</span>
      String paramValue;
<span class="fc bfc" id="L318" title="All 2 branches covered.">      if (context.hasRequestedParamValue(request, paramKey)) {</span>
        // If the request contains the parameter then we're using either value from request, or parent value, or default value
<span class="fc" id="L320">        paramValue = firstNonNull(</span>
<span class="fc" id="L321">          context.getRequestedParamValue(request, paramKey),</span>
          parentValue,
<span class="fc" id="L323">          rule.getParamDefaultValue(paramKey));</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">      } else if (currentActiveRule != null) {</span>
        // If the request doesn't contain the parameter, then we're using either user value from db, or parent value if rule inherited,
        // or default value
<span class="fc" id="L327">        paramValue = firstNonNull(</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">          currentActiveRule.get().doesOverride() ? currentActiveRule.getParamValue(paramKey) : null,</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">          parentValue == null ? currentActiveRule.getParamValue(paramKey) : parentValue,</span>
<span class="fc" id="L330">          rule.getParamDefaultValue(paramKey));</span>
      } else {
<span class="fc" id="L332">        paramValue = firstNonNull(</span>
          parentValue,
<span class="fc" id="L334">          rule.getParamDefaultValue(paramKey));</span>
      }
<span class="fc" id="L336">      change.setParameter(paramKey, validateParam(ruleParamDto, paramValue));</span>
<span class="fc" id="L337">    }</span>
<span class="fc" id="L338">  }</span>

<span class="fc" id="L340">  private record SeverityConfiguration(@Nullable String severity, Map&lt;SoftwareQuality, Severity&gt; impacts) {</span>
  }

  private static SeverityConfiguration getSeverityConfigurationForNonBuiltInProfile(RuleActivation request, RuleWrapper rule, @Nullable ActiveRuleWrapper activeRule,
    @Nullable ActiveRuleWrapper parentActiveRule) {
<span class="fc" id="L345">    return determineSeverityConfiguration(request, rule.get(), activeRule, parentActiveRule);</span>
  }

  private static boolean getPrioritizedRuleForNonBuiltInProfile(RuleActivation request, @Nullable ActiveRuleWrapper activeRule,
    @Nullable ActiveRuleWrapper parentActiveRule) {
    boolean prioritizedRule;
<span class="fc bfc" id="L351" title="All 2 branches covered.">    if (activeRule != null) {</span>
<span class="fc" id="L352">      ActiveRuleDto activeRuleDto = activeRule.get();</span>
      // load prioritizedRule from request, else keep existing one (if overridden), else from parent if rule inherited, else 'false'
<span class="fc" id="L354">      prioritizedRule = firstNonNull(</span>
<span class="fc" id="L355">        request.isPrioritizedRule(),</span>
<span class="fc bfc" id="L356" title="All 4 branches covered.">        activeRuleDto.doesOverride() ? activeRuleDto.isPrioritizedRule() : null,</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">        parentActiveRule != null &amp;&amp; parentActiveRule.get().isPrioritizedRule());</span>
<span class="fc" id="L358">    } else {</span>
      // load prioritizedRule from request, else from parent, else 'false'
<span class="fc" id="L360">      prioritizedRule = firstNonNull(</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">        request.isPrioritizedRule(),</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">        parentActiveRule != null &amp;&amp; parentActiveRule.get().isPrioritizedRule());</span>
    }
<span class="fc" id="L364">    return prioritizedRule;</span>
  }

  private void persist(ActiveRuleChange change, RuleActivationContext context, DbSession dbSession) {
<span class="fc" id="L368">    ActiveRuleDto activeRule = null;</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">    if (change.getType() == ActiveRuleChange.Type.ACTIVATED) {</span>
<span class="fc" id="L370">      activeRule = doInsert(change, context, dbSession);</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">    } else if (change.getType() == ActiveRuleChange.Type.DEACTIVATED) {</span>
<span class="fc" id="L372">      ActiveRuleDao dao = db.activeRuleDao();</span>
<span class="fc" id="L373">      activeRule = dao.delete(dbSession, change.getKey()).orElse(null);</span>

<span class="pc bpc" id="L375" title="1 of 2 branches missed.">    } else if (change.getType() == ActiveRuleChange.Type.UPDATED) {</span>
<span class="fc" id="L376">      activeRule = doUpdate(change, context, dbSession);</span>
    }
<span class="fc" id="L378">    change.setActiveRule(activeRule);</span>

<span class="fc" id="L380">    QProfileChangeDto dto = change.toDto(userSession.getUuid());</span>

<span class="fc bfc" id="L382" title="All 2 branches covered.">    if (dto.getRuleChange() != null) {</span>
<span class="fc" id="L383">      dto.getRuleChange().setUuid(uuidFactory.create());</span>
<span class="fc" id="L384">      dto.getRuleChange().getRuleImpactChanges().forEach(e -&gt; e.setRuleChangeUuid(dto.getRuleChange().getUuid()));</span>
<span class="fc" id="L385">      db.ruleChangeDao().insert(dbSession, dto.getRuleChange());</span>
    }

<span class="fc" id="L388">    dto.setSqVersion(sonarQubeVersion.toString());</span>

<span class="fc" id="L390">    db.qProfileChangeDao().insert(dbSession, dto);</span>
<span class="fc" id="L391">  }</span>

  private ActiveRuleDto doInsert(ActiveRuleChange change, RuleActivationContext context, DbSession dbSession) {
<span class="fc" id="L394">    ActiveRuleDao dao = db.activeRuleDao();</span>
<span class="fc" id="L395">    RuleWrapper rule = context.getRule();</span>

<span class="fc" id="L397">    ActiveRuleDto activeRule = new ActiveRuleDto();</span>
<span class="fc" id="L398">    activeRule.setProfileUuid(context.getRulesProfile().getUuid());</span>
<span class="fc" id="L399">    activeRule.setRuleUuid(rule.get().getUuid());</span>
<span class="fc" id="L400">    activeRule.setKey(ActiveRuleKey.of(context.getRulesProfile(), rule.get().getKey()));</span>
<span class="fc" id="L401">    String severity = change.getSeverity();</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">    if (severity != null) {</span>
<span class="fc" id="L403">      activeRule.setSeverity(severity);</span>
    }
<span class="fc" id="L405">    activeRule.setImpacts(change.getNewImpacts());</span>
<span class="fc" id="L406">    activeRule.setPrioritizedRule(TRUE.equals(change.isPrioritizedRule()));</span>
<span class="fc" id="L407">    ActiveRuleInheritance inheritance = change.getInheritance();</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">    if (inheritance != null) {</span>
<span class="fc" id="L409">      activeRule.setInheritance(inheritance.name());</span>
    }
<span class="fc" id="L411">    activeRule.setUpdatedAt(system2.now());</span>
<span class="fc" id="L412">    activeRule.setCreatedAt(system2.now());</span>
<span class="fc" id="L413">    dao.insert(dbSession, activeRule);</span>
<span class="fc" id="L414">    List&lt;ActiveRuleParamDto&gt; params = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; param : change.getParameters().entrySet()) {</span>
<span class="fc bfc" id="L416" title="All 2 branches covered.">      if (param.getValue() != null) {</span>
<span class="fc" id="L417">        ActiveRuleParamDto paramDto = ActiveRuleParamDto.createFor(rule.getParam(param.getKey()));</span>
<span class="fc" id="L418">        paramDto.setValue(param.getValue());</span>
<span class="fc" id="L419">        params.add(paramDto);</span>
<span class="fc" id="L420">        dao.insertParam(dbSession, activeRule, paramDto);</span>
      }
<span class="fc" id="L422">    }</span>
<span class="fc" id="L423">    context.register(activeRule, params);</span>
<span class="fc" id="L424">    return activeRule;</span>
  }

  private ActiveRuleDto doUpdate(ActiveRuleChange change, RuleActivationContext context, DbSession dbSession) {
<span class="fc" id="L428">    ActiveRuleWrapper activeRule = context.getActiveRule();</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">    if (activeRule == null) {</span>
<span class="nc" id="L430">      return null;</span>
    }
<span class="fc" id="L432">    ActiveRuleDao dao = db.activeRuleDao();</span>
<span class="fc" id="L433">    String severity = change.getSeverity();</span>
<span class="fc" id="L434">    ActiveRuleDto ruleDto = activeRule.get();</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">    if (severity != null) {</span>
<span class="fc" id="L436">      ruleDto.setSeverity(severity);</span>
    }
<span class="fc" id="L438">    ruleDto.setImpacts(change.getNewImpacts());</span>
<span class="fc" id="L439">    Boolean prioritizedRule = change.isPrioritizedRule();</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">    if (prioritizedRule != null) {</span>
<span class="fc" id="L441">      ruleDto.setPrioritizedRule(prioritizedRule);</span>
    }
<span class="fc" id="L443">    ActiveRuleInheritance inheritance = change.getInheritance();</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">    if (inheritance != null) {</span>
<span class="fc" id="L445">      ruleDto.setInheritance(inheritance.name());</span>
    }
<span class="fc" id="L447">    ruleDto.setUpdatedAt(system2.now());</span>
<span class="fc" id="L448">    dao.update(dbSession, ruleDto);</span>

<span class="fc bfc" id="L450" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; param : change.getParameters().entrySet()) {</span>
<span class="fc" id="L451">      ActiveRuleParamDto activeRuleParamDto = activeRule.getParam(param.getKey());</span>
<span class="fc bfc" id="L452" title="All 2 branches covered.">      if (activeRuleParamDto == null) {</span>
        // did not exist
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">        if (param.getValue() != null) {</span>
<span class="fc" id="L455">          activeRuleParamDto = ActiveRuleParamDto.createFor(context.getRule().getParam(param.getKey()));</span>
<span class="fc" id="L456">          activeRuleParamDto.setValue(param.getValue());</span>
<span class="fc" id="L457">          dao.insertParam(dbSession, ruleDto, activeRuleParamDto);</span>
        }
      } else {
<span class="fc bfc" id="L460" title="All 2 branches covered.">        if (param.getValue() != null) {</span>
<span class="fc" id="L461">          activeRuleParamDto.setValue(param.getValue());</span>
<span class="fc" id="L462">          dao.updateParam(dbSession, activeRuleParamDto);</span>
        } else {
<span class="fc" id="L464">          dao.deleteParam(dbSession, activeRuleParamDto);</span>
        }
      }
<span class="fc" id="L467">    }</span>
<span class="fc" id="L468">    return ruleDto;</span>
  }

  public List&lt;ActiveRuleChange&gt; deactivate(DbSession dbSession, RuleActivationContext context, String ruleUuid, boolean force) {
<span class="fc" id="L472">    context.reset(ruleUuid);</span>
<span class="fc" id="L473">    return doDeactivateRecursively(dbSession, context, force);</span>
  }

  private List&lt;ActiveRuleChange&gt; doDeactivateRecursively(DbSession dbSession, RuleActivationContext context, boolean force) {
<span class="fc" id="L477">    List&lt;ActiveRuleChange&gt; changes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L478">    ActiveRuleWrapper activeRule = context.getActiveRule();</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">    if (activeRule != null) {</span>
<span class="fc bfc" id="L480" title="All 8 branches covered.">      checkRequest(force || context.isCascading() || activeRule.get().getInheritance() == null || isAllowDisableInheritedRules(),</span>
<span class="fc" id="L481">        &quot;Cannot deactivate inherited rule '%s'&quot;, context.getRule().get().getKey());</span>

<span class="fc" id="L483">      ActiveRuleChange change = new ActiveRuleChange(ActiveRuleChange.Type.DEACTIVATED, activeRule.get(), context.getRule().get());</span>
<span class="fc" id="L484">      changes.add(change);</span>
<span class="fc" id="L485">      persist(change, context, dbSession);</span>
    }

    // get all inherited profiles (they are not built-in by design)
<span class="fc" id="L489">    context.getChildProfiles().forEach(child -&gt; {</span>
<span class="fc" id="L490">      context.selectChild(child);</span>
<span class="fc" id="L491">      changes.addAll(doDeactivateRecursively(dbSession, context, force));</span>
<span class="fc" id="L492">    });</span>

<span class="fc bfc" id="L494" title="All 2 branches covered.">    if (!changes.isEmpty()) {</span>
<span class="fc" id="L495">      updateProfileDates(dbSession, context);</span>
    }

<span class="fc" id="L498">    return changes;</span>
  }

  private boolean isAllowDisableInheritedRules() {
<span class="fc" id="L502">    return configuration.getBoolean(CorePropertyDefinitions.ALLOW_DISABLE_INHERITED_RULES).orElse(true);</span>
  }

  @CheckForNull
  private String validateParam(RuleParamDto ruleParam, @Nullable String value) {
<span class="fc bfc" id="L507" title="All 2 branches covered.">    if (value != null) {</span>
<span class="fc" id="L508">      RuleParamType ruleParamType = RuleParamType.parse(ruleParam.getType());</span>
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">      if (ruleParamType.multiple()) {</span>
<span class="nc" id="L510">        List&lt;String&gt; values = Splitter.on(&quot;,&quot;).splitToList(value);</span>
<span class="nc" id="L511">        typeValidations.validate(values, ruleParamType.type(), ruleParamType.values());</span>
<span class="nc" id="L512">      } else {</span>
<span class="fc" id="L513">        typeValidations.validate(value, ruleParamType.type(), ruleParamType.values());</span>
      }
    }
<span class="fc" id="L516">    return value;</span>
  }

  public RuleActivationContext createContextForBuiltInProfile(DbSession dbSession, RulesProfileDto builtInProfile,
    Collection&lt;String&gt; ruleUuids, Set&lt;String&gt; previousBuiltinActiveRuleUuids) {
<span class="fc" id="L521">    checkArgument(builtInProfile.isBuiltIn(), &quot;Rules profile with UUID %s is not built-in&quot;, builtInProfile.getUuid());</span>

<span class="fc" id="L523">    RuleActivationContext.Builder builder = new RuleActivationContext.Builder();</span>
<span class="fc" id="L524">    builder.setDescendantProfilesSupplier(createDescendantProfilesSupplier(dbSession));</span>
<span class="fc" id="L525">    builder.setPreviousBuiltinActiveRuleUuids(previousBuiltinActiveRuleUuids);</span>

    // load rules
<span class="fc" id="L528">    completeWithRules(dbSession, builder, ruleUuids);</span>

    // load org profiles. Their parents are null by nature.
<span class="fc" id="L531">    List&lt;QProfileDto&gt; profiles = db.qualityProfileDao().selectQProfilesByRuleProfile(dbSession, builtInProfile);</span>
<span class="fc" id="L532">    builder.setProfiles(profiles);</span>
<span class="fc" id="L533">    builder.setBaseProfile(builtInProfile);</span>

    // load active rules
<span class="fc" id="L536">    Collection&lt;String&gt; ruleProfileUuids = Stream</span>
<span class="fc" id="L537">      .concat(Stream.of(builtInProfile.getUuid()), profiles.stream().map(QProfileDto::getRulesProfileUuid))</span>
<span class="fc" id="L538">      .collect(Collectors.toSet());</span>
<span class="fc" id="L539">    completeWithActiveRules(dbSession, builder, ruleUuids, ruleProfileUuids);</span>
<span class="fc" id="L540">    return builder.build();</span>
  }

  public RuleActivationContext createContextForUserProfile(DbSession dbSession, QProfileDto profile, Collection&lt;String&gt; ruleUuids) {
<span class="pc bpc" id="L544" title="1 of 2 branches missed.">    checkArgument(!profile.isBuiltIn(), &quot;Profile with UUID %s is built-in&quot;, profile.getKee());</span>
<span class="fc" id="L545">    RuleActivationContext.Builder builder = new RuleActivationContext.Builder();</span>
<span class="fc" id="L546">    builder.setDescendantProfilesSupplier(createDescendantProfilesSupplier(dbSession));</span>

    // load rules
<span class="fc" id="L549">    completeWithRules(dbSession, builder, ruleUuids);</span>

    // load profiles
<span class="fc" id="L552">    List&lt;QProfileDto&gt; profiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L553">    profiles.add(profile);</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">    if (profile.getParentKee() != null) {</span>
<span class="fc" id="L555">      profiles.add(db.qualityProfileDao().selectByUuid(dbSession, profile.getParentKee()));</span>
    }
<span class="fc" id="L557">    builder.setProfiles(profiles);</span>
<span class="fc" id="L558">    builder.setBaseProfile(RulesProfileDto.from(profile));</span>

    // load active rules
<span class="fc" id="L561">    Collection&lt;String&gt; ruleProfileUuids = profiles.stream()</span>
<span class="fc" id="L562">      .map(QProfileDto::getRulesProfileUuid)</span>
<span class="fc" id="L563">      .collect(Collectors.toSet());</span>
<span class="fc" id="L564">    completeWithActiveRules(dbSession, builder, ruleUuids, ruleProfileUuids);</span>

<span class="fc" id="L566">    return builder.build();</span>
  }

  DescendantProfilesSupplier createDescendantProfilesSupplier(DbSession dbSession) {
<span class="fc" id="L570">    return (parents, ruleUuids) -&gt; {</span>
<span class="fc" id="L571">      Collection&lt;QProfileDto&gt; profiles = db.qualityProfileDao().selectDescendants(dbSession, parents);</span>
<span class="fc" id="L572">      Set&lt;String&gt; ruleProfileUuids = profiles.stream()</span>
<span class="fc" id="L573">        .map(QProfileDto::getRulesProfileUuid)</span>
<span class="fc" id="L574">        .collect(Collectors.toSet());</span>
<span class="fc" id="L575">      Collection&lt;ActiveRuleDto&gt; activeRules = db.activeRuleDao().selectByRulesAndRuleProfileUuids(dbSession, ruleUuids, ruleProfileUuids);</span>
<span class="fc" id="L576">      List&lt;String&gt; activeRuleUuids = activeRules.stream().map(ActiveRuleDto::getUuid).toList();</span>
<span class="fc" id="L577">      List&lt;ActiveRuleParamDto&gt; activeRuleParams = db.activeRuleDao().selectParamsByActiveRuleUuids(dbSession, activeRuleUuids);</span>
<span class="fc" id="L578">      return new DescendantProfilesSupplier.Result(profiles, activeRules, activeRuleParams);</span>
    };
  }

  private void completeWithRules(DbSession dbSession, RuleActivationContext.Builder builder, Collection&lt;String&gt; ruleUuids) {
<span class="fc" id="L583">    List&lt;RuleDto&gt; rules = db.ruleDao().selectByUuids(dbSession, ruleUuids);</span>
<span class="fc" id="L584">    builder.setRules(rules);</span>
<span class="fc" id="L585">    builder.setRuleParams(db.ruleDao().selectRuleParamsByRuleUuids(dbSession, ruleUuids));</span>
<span class="fc" id="L586">  }</span>

  private void completeWithActiveRules(DbSession dbSession, RuleActivationContext.Builder builder, Collection&lt;String&gt; ruleUuids,
    Collection&lt;String&gt; ruleProfileUuids) {
<span class="fc" id="L590">    Collection&lt;ActiveRuleDto&gt; activeRules = db.activeRuleDao().selectByRulesAndRuleProfileUuids(dbSession, ruleUuids, ruleProfileUuids);</span>
<span class="fc" id="L591">    builder.setActiveRules(activeRules);</span>
<span class="fc" id="L592">    List&lt;String&gt; activeRuleUuids = activeRules.stream().map(ActiveRuleDto::getUuid).toList();</span>
<span class="fc" id="L593">    builder.setActiveRuleParams(db.activeRuleDao().selectParamsByActiveRuleUuids(dbSession, activeRuleUuids));</span>
<span class="fc" id="L594">  }</span>

  private static boolean isSame(ActiveRuleChange change, ActiveRuleWrapper activeRule) {
<span class="fc" id="L597">    ActiveRuleInheritance inheritance = change.getInheritance();</span>
<span class="fc bfc" id="L598" title="All 4 branches covered.">    if (inheritance != null &amp;&amp; !inheritance.name().equals(activeRule.get().getInheritance())) {</span>
<span class="fc" id="L599">      return false;</span>
    }
<span class="fc" id="L601">    String severity = change.getSeverity();</span>
<span class="pc bpc" id="L602" title="1 of 4 branches missed.">    if (severity != null &amp;&amp; !severity.equals(activeRule.get().getSeverityString())) {</span>
<span class="fc" id="L603">      return false;</span>
    }
<span class="fc" id="L605">    Map&lt;SoftwareQuality, Severity&gt; impactSeverities = change.getNewImpacts();</span>
<span class="fc bfc" id="L606" title="All 2 branches covered.">    if (!impactSeverities.equals(activeRule.get().getImpacts())) {</span>
<span class="fc" id="L607">      return false;</span>
    }
<span class="fc" id="L609">    Boolean prioritizedRule = change.isPrioritizedRule();</span>
<span class="pc bpc" id="L610" title="2 of 4 branches missed.">    if (prioritizedRule != null &amp;&amp; prioritizedRule != activeRule.get().isPrioritizedRule()) {</span>
<span class="nc" id="L611">      return false;</span>
    }
<span class="fc bfc" id="L613" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; changeParam : change.getParameters().entrySet()) {</span>
<span class="fc" id="L614">      String activeParamValue = activeRule.getParamValue(changeParam.getKey());</span>
<span class="pc bpc" id="L615" title="1 of 4 branches missed.">      if (changeParam.getValue() == null &amp;&amp; activeParamValue != null) {</span>
<span class="fc" id="L616">        return false;</span>
      }
<span class="pc bpc" id="L618" title="1 of 6 branches missed.">      if (changeParam.getValue() != null &amp;&amp; (activeParamValue == null || !StringUtils.equals(changeParam.getValue(), activeParamValue))) {</span>
<span class="fc" id="L619">        return false;</span>
      }
<span class="fc" id="L621">    }</span>
<span class="fc" id="L622">    return true;</span>
  }

  private static boolean isSameAsParent(ActiveRuleChange change, RuleActivationContext context) {
<span class="fc" id="L626">    ActiveRuleWrapper parentActiveRule = context.getParentActiveRule();</span>
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">    if (parentActiveRule == null) {</span>
<span class="nc" id="L628">      return false;</span>
    }
<span class="fc bfc" id="L630" title="All 2 branches covered.">    if (!StringUtils.equals(change.getSeverity(), parentActiveRule.get().getSeverityString())) {</span>
<span class="fc" id="L631">      return false;</span>
    }
<span class="fc bfc" id="L633" title="All 2 branches covered.">    if (!change.getNewImpacts().equals(parentActiveRule.get().getImpacts())) {</span>
<span class="fc" id="L634">      return false;</span>
    }
<span class="pc bpc" id="L636" title="1 of 4 branches missed.">    if (change.isPrioritizedRule() != null &amp;&amp; !Objects.equals(change.isPrioritizedRule(), parentActiveRule.get().isPrioritizedRule())) {</span>
<span class="nc" id="L637">      return false;</span>
    }
<span class="fc bfc" id="L639" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; entry : change.getParameters().entrySet()) {</span>
<span class="pc bpc" id="L640" title="1 of 4 branches missed.">      if (entry.getValue() != null &amp;&amp; !entry.getValue().equals(parentActiveRule.getParamValue(entry.getKey()))) {</span>
<span class="fc" id="L641">        return false;</span>
      }
<span class="fc" id="L643">    }</span>
<span class="fc" id="L644">    return true;</span>
  }

  @CheckForNull
  private static String firstNonNull(String... strings) {
<span class="fc bfc" id="L649" title="All 2 branches covered.">    for (String s : strings) {</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">      if (s != null) {</span>
<span class="fc" id="L651">        return s;</span>
      }
    }
<span class="fc" id="L654">    return null;</span>
  }

  private static boolean firstNonNull(Boolean... booleans) {
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">    for (Boolean b : booleans) {</span>
<span class="fc bfc" id="L659" title="All 2 branches covered.">      if (b != null) {</span>
<span class="fc" id="L660">        return b;</span>
      }
    }
<span class="nc" id="L663">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>