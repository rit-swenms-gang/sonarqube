<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BuiltInQPChangeNotificationBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.qualityprofile.builtin</a> &gt; <span class="el_source">BuiltInQPChangeNotificationBuilder.java</span></div><h1>BuiltInQPChangeNotificationBuilder.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.qualityprofile.builtin;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.stream.IntStream;
import org.sonar.api.notifications.Notification;

import static com.google.common.base.Preconditions.checkState;
import static java.lang.Integer.parseInt;
import static java.lang.Long.parseLong;
import static java.lang.String.format;
import static java.util.Objects.requireNonNull;

<span class="fc" id="L34">public class BuiltInQPChangeNotificationBuilder {</span>

  private static final String NUMBER_OF_PROFILES = &quot;numberOfProfiles&quot;;
  private static final String PROFILE_NAME = &quot;.profileName&quot;;
  private static final String LANGUAGE_KEY = &quot;.languageKey&quot;;
  private static final String LANGUAGE_NAME = &quot;.languageName&quot;;
  private static final String NEW_RULES = &quot;.newRules&quot;;
  private static final String UPDATED_RULES = &quot;.updatedRules&quot;;
  private static final String REMOVED_RULES = &quot;.removedRules&quot;;
  private static final String START_DATE = &quot;.startDate&quot;;
  private static final String END_DATE = &quot;.endDate&quot;;

<span class="fc" id="L46">  private final List&lt;Profile&gt; profiles = new ArrayList&lt;&gt;();</span>

  public BuiltInQPChangeNotificationBuilder addProfile(Profile profile) {
<span class="fc" id="L49">    profiles.add(profile);</span>
<span class="fc" id="L50">    return this;</span>
  }

  public BuiltInQPChangeNotification build() {
<span class="fc" id="L54">    BuiltInQPChangeNotification notification = new BuiltInQPChangeNotification();</span>
<span class="fc" id="L55">    notification.setFieldValue(NUMBER_OF_PROFILES, String.valueOf(profiles.size()));</span>
<span class="fc" id="L56">    AtomicInteger count = new AtomicInteger();</span>
<span class="fc" id="L57">    profiles.forEach(profile -&gt; {</span>
<span class="fc" id="L58">      int index = count.getAndIncrement();</span>
<span class="fc" id="L59">      notification.setFieldValue(index + PROFILE_NAME, profile.getProfileName());</span>
<span class="fc" id="L60">      notification.setFieldValue(index + LANGUAGE_KEY, profile.getLanguageKey());</span>
<span class="fc" id="L61">      notification.setFieldValue(index + LANGUAGE_NAME, profile.getLanguageName());</span>
<span class="fc" id="L62">      notification.setFieldValue(index + NEW_RULES, String.valueOf(profile.getNewRules()));</span>
<span class="fc" id="L63">      notification.setFieldValue(index + UPDATED_RULES, String.valueOf(profile.getUpdatedRules()));</span>
<span class="fc" id="L64">      notification.setFieldValue(index + REMOVED_RULES, String.valueOf(profile.getRemovedRules()));</span>
<span class="fc" id="L65">      notification.setFieldValue(index + START_DATE, String.valueOf(profile.getStartDate()));</span>
<span class="fc" id="L66">      notification.setFieldValue(index + END_DATE, String.valueOf(profile.getEndDate()));</span>
<span class="fc" id="L67">    });</span>
<span class="fc" id="L68">    return notification;</span>
  }

  public static BuiltInQPChangeNotificationBuilder parse(Notification notification) {
<span class="fc" id="L72">    checkState(BuiltInQPChangeNotification.TYPE.equals(notification.getType()),</span>
<span class="fc" id="L73">      &quot;Expected notification of type %s but got %s&quot;, BuiltInQPChangeNotification.TYPE, notification.getType());</span>
<span class="fc" id="L74">    BuiltInQPChangeNotificationBuilder notif = new BuiltInQPChangeNotificationBuilder();</span>
<span class="fc" id="L75">    String numberOfProfilesText = notification.getFieldValue(NUMBER_OF_PROFILES);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">    checkState(numberOfProfilesText != null, &quot;Could not read the built-in quality profile notification&quot;);</span>
<span class="fc" id="L77">    Integer numberOfProfiles = Integer.valueOf(numberOfProfilesText);</span>
<span class="fc" id="L78">    IntStream.rangeClosed(0, numberOfProfiles - 1)</span>
<span class="fc" id="L79">      .mapToObj(index -&gt; Profile.newBuilder()</span>
<span class="fc" id="L80">        .setProfileName(getNonNullFieldValue(notification, index + PROFILE_NAME))</span>
<span class="fc" id="L81">        .setLanguageKey(getNonNullFieldValue(notification, index + LANGUAGE_KEY))</span>
<span class="fc" id="L82">        .setLanguageName(getNonNullFieldValue(notification, index + LANGUAGE_NAME))</span>
<span class="fc" id="L83">        .setNewRules(parseInt(getNonNullFieldValue(notification, index + NEW_RULES)))</span>
<span class="fc" id="L84">        .setUpdatedRules(parseInt(getNonNullFieldValue(notification, index + UPDATED_RULES)))</span>
<span class="fc" id="L85">        .setRemovedRules(parseInt(getNonNullFieldValue(notification, index + REMOVED_RULES)))</span>
<span class="fc" id="L86">        .setStartDate(parseLong(getNonNullFieldValue(notification, index + START_DATE)))</span>
<span class="fc" id="L87">        .setEndDate(parseLong(getNonNullFieldValue(notification, index + END_DATE)))</span>
<span class="fc" id="L88">        .build())</span>
<span class="fc" id="L89">      .forEach(notif::addProfile);</span>
<span class="fc" id="L90">    return notif;</span>
  }

  private static String getNonNullFieldValue(Notification notification, String key) {
<span class="fc" id="L94">    String value = notification.getFieldValue(key);</span>
<span class="fc" id="L95">    return requireNonNull(value, format(&quot;Notification field '%s' is null&quot;, key));</span>
  }

  public List&lt;Profile&gt; getProfiles() {
<span class="fc" id="L99">    return profiles;</span>
  }

  public static class Profile {
    private final String profileName;
    private final String languageKey;
    private final String languageName;
    private final int newRules;
    private final int updatedRules;
    private final int removedRules;
    private final long startDate;
    private final long endDate;

<span class="fc" id="L112">    public Profile(Builder builder) {</span>
<span class="fc" id="L113">      this.profileName = builder.profileName;</span>
<span class="fc" id="L114">      this.languageKey = builder.languageKey;</span>
<span class="fc" id="L115">      this.languageName = builder.languageName;</span>
<span class="fc" id="L116">      this.newRules = builder.newRules;</span>
<span class="fc" id="L117">      this.updatedRules = builder.updatedRules;</span>
<span class="fc" id="L118">      this.removedRules = builder.removedRules;</span>
<span class="fc" id="L119">      this.startDate = builder.startDate;</span>
<span class="fc" id="L120">      this.endDate = builder.endDate;</span>
<span class="fc" id="L121">    }</span>

    public String getProfileName() {
<span class="fc" id="L124">      return profileName;</span>
    }

    public String getLanguageKey() {
<span class="fc" id="L128">      return languageKey;</span>
    }

    public String getLanguageName() {
<span class="fc" id="L132">      return languageName;</span>
    }

    public int getNewRules() {
<span class="fc" id="L136">      return newRules;</span>
    }

    public int getUpdatedRules() {
<span class="fc" id="L140">      return updatedRules;</span>
    }

    public int getRemovedRules() {
<span class="fc" id="L144">      return removedRules;</span>
    }

    public long getStartDate() {
<span class="fc" id="L148">      return startDate;</span>
    }

    public long getEndDate() {
<span class="fc" id="L152">      return endDate;</span>
    }

    public static Builder newBuilder() {
<span class="fc" id="L156">      return new Builder();</span>
    }

    public static class Builder {
      private String profileName;
      private String languageKey;
      private String languageName;
      private int newRules;
      private int updatedRules;
      private int removedRules;
      private long startDate;
      private long endDate;

      private Builder() {
      }

      public Builder setLanguageKey(String languageKey) {
<span class="fc" id="L173">        this.languageKey = requireNonNull(languageKey, &quot;languageKEy should not be null&quot;);</span>
<span class="fc" id="L174">        return this;</span>
      }

      public Builder setLanguageName(String languageName) {
<span class="fc" id="L178">        this.languageName = requireNonNull(languageName, &quot;languageName should not be null&quot;);</span>
<span class="fc" id="L179">        return this;</span>
      }

      public Builder setProfileName(String profileName) {
<span class="fc" id="L183">        this.profileName = requireNonNull(profileName, &quot;profileName should not be null&quot;);</span>
<span class="fc" id="L184">        return this;</span>
      }

      public Builder setNewRules(int newRules) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        checkState(newRules &gt;= 0, &quot;newRules should not be negative&quot;);</span>
<span class="fc" id="L189">        this.newRules = newRules;</span>
<span class="fc" id="L190">        return this;</span>
      }

      public Builder setUpdatedRules(int updatedRules) {
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        checkState(updatedRules &gt;= 0, &quot;updatedRules should not be negative&quot;);</span>
<span class="fc" id="L195">        this.updatedRules = updatedRules;</span>
<span class="fc" id="L196">        return this;</span>
      }

      public Builder setRemovedRules(int removedRules) {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        checkState(removedRules &gt;= 0, &quot;removedRules should not be negative&quot;);</span>
<span class="fc" id="L201">        this.removedRules = removedRules;</span>
<span class="fc" id="L202">        return this;</span>
      }

      public Builder setStartDate(long startDate) {
<span class="fc" id="L206">        this.startDate = startDate;</span>
<span class="fc" id="L207">        return this;</span>
      }

      public Builder setEndDate(long endDate) {
<span class="fc" id="L211">        this.endDate = endDate;</span>
<span class="fc" id="L212">        return this;</span>
      }

      public Profile build() {
<span class="fc" id="L216">        return new Profile(this);</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>