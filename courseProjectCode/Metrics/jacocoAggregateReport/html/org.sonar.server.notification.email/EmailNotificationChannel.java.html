<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailNotificationChannel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.notification.email</a> &gt; <span class="el_source">EmailNotificationChannel.java</span></div><h1>EmailNotificationChannel.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.notification.email;

import java.net.MalformedURLException;
import java.net.URL;
import java.time.Duration;
import java.util.Objects;
import java.util.Properties;
import java.util.Set;
import java.util.regex.Pattern;
import javax.annotation.CheckForNull;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.mail2.core.EmailException;
import org.apache.commons.mail2.jakarta.Email;
import org.apache.commons.mail2.jakarta.HtmlEmail;
import org.apache.commons.mail2.jakarta.SimpleEmail;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.api.notifications.Notification;
import org.sonar.api.platform.Server;
import org.sonar.api.user.User;
import org.sonar.api.utils.SonarException;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.user.UserDto;
import org.sonar.server.email.EmailSmtpConfiguration;
import org.sonar.server.issue.notification.EmailMessage;
import org.sonar.server.issue.notification.EmailTemplate;
import org.sonar.server.notification.NotificationChannel;
import org.sonar.server.oauth.OAuthMicrosoftRestClient;

import static java.time.temporal.ChronoUnit.SECONDS;
import static java.util.Objects.requireNonNull;
import static org.sonar.server.email.EmailSmtpConfiguration.EMAIL_CONFIG_SMTP_AUTH_METHOD_OAUTH;

/**
 * References:
 * &lt;ul&gt;
 * &lt;li&gt;&lt;a href=&quot;http://tools.ietf.org/html/rfc4021&quot;&gt;Registration of Mail and MIME Header Fields&lt;/a&gt;&lt;/li&gt;
 * &lt;li&gt;&lt;a href=&quot;http://tools.ietf.org/html/rfc2919&quot;&gt;List-Id: A Structured Field and Namespace for the Identification of Mailing Lists&lt;/a&gt;&lt;/li&gt;
 * &lt;li&gt;&lt;a href=&quot;https://github.com/blog/798-threaded-email-notifications&quot;&gt;GitHub: Threaded Email Notifications&lt;/a&gt;&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @since 2.10
 */
public class EmailNotificationChannel extends NotificationChannel {

<span class="fc" id="L66">  private static final Logger LOG = LoggerFactory.getLogger(EmailNotificationChannel.class);</span>

  /**
   * @see org.apache.commons.mail2.jakarta.Email#setSocketConnectionTimeout(Duration)
   * @see org.apache.commons.mail2.jakarta.Email#setSocketTimeout(Duration)
   */
<span class="fc" id="L72">  private static final Duration SOCKET_TIMEOUT = Duration.of(30, SECONDS);</span>

<span class="fc" id="L74">  private static final Pattern PATTERN_LINE_BREAK = Pattern.compile(&quot;[\n\r]&quot;);</span>

  /**
   * Email Header Field: &quot;List-ID&quot;.
   * Value of this field should contain mailing list identifier as specified in &lt;a href=&quot;http://tools.ietf.org/html/rfc2919&quot;&gt;RFC 2919&lt;/a&gt;.
   */
  private static final String LIST_ID_HEADER = &quot;List-ID&quot;;

  /**
   * Email Header Field: &quot;List-Archive&quot;.
   * Value of this field should contain URL of mailing list archive as specified in &lt;a href=&quot;http://tools.ietf.org/html/rfc2369&quot;&gt;RFC 2369&lt;/a&gt;.
   */
  private static final String LIST_ARCHIVE_HEADER = &quot;List-Archive&quot;;

  /**
   * Email Header Field: &quot;In-Reply-To&quot;.
   * Value of this field should contain related message identifier as specified in &lt;a href=&quot;http://tools.ietf.org/html/rfc2822&quot;&gt;RFC 2822&lt;/a&gt;.
   */
  private static final String IN_REPLY_TO_HEADER = &quot;In-Reply-To&quot;;

  /**
   * Email Header Field: &quot;References&quot;.
   * Value of this field should contain related message identifier as specified in &lt;a href=&quot;http://tools.ietf.org/html/rfc2822&quot;&gt;RFC 2822&lt;/a&gt;
   */
  private static final String REFERENCES_HEADER = &quot;References&quot;;

  private static final String SUBJECT_DEFAULT = &quot;Notification&quot;;
  private static final String SMTP_HOST_NOT_CONFIGURED_DEBUG_MSG = &quot;SMTP host was not configured - email will not be sent&quot;;
  private static final String MAIL_SENT_FROM = &quot;%sMail sent from: %s&quot;;

  private final EmailSmtpConfiguration configuration;
  private final Server server;
  private final EmailTemplate[] templates;
  private final DbClient dbClient;
  private final OAuthMicrosoftRestClient oAuthMicrosoftRestClient;

  public EmailNotificationChannel(EmailSmtpConfiguration configuration, Server server, EmailTemplate[] templates, DbClient dbClient,
<span class="fc" id="L111">    OAuthMicrosoftRestClient oAuthMicrosoftRestClient) {</span>
<span class="fc" id="L112">    this.configuration = configuration;</span>
<span class="fc" id="L113">    this.server = server;</span>
<span class="fc" id="L114">    this.templates = templates;</span>
<span class="fc" id="L115">    this.dbClient = dbClient;</span>
<span class="fc" id="L116">    this.oAuthMicrosoftRestClient = oAuthMicrosoftRestClient;</span>
<span class="fc" id="L117">  }</span>

  public boolean isActivated() {
<span class="fc bfc" id="L120" title="All 2 branches covered.">    return !StringUtils.isBlank(configuration.getSmtpHost());</span>
  }

  @Override
  public boolean deliver(Notification notification, String username) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">    if (!isActivated()) {</span>
<span class="nc" id="L126">      LOG.debug(SMTP_HOST_NOT_CONFIGURED_DEBUG_MSG);</span>
<span class="nc" id="L127">      return false;</span>
    }

<span class="nc" id="L130">    User user = findByLogin(username);</span>
<span class="nc bnc" id="L131" title="All 4 branches missed.">    if (user == null || StringUtils.isBlank(user.email())) {</span>
<span class="nc" id="L132">      LOG.debug(&quot;User does not exist or has no email: {}&quot;, username);</span>
<span class="nc" id="L133">      return false;</span>
    }

<span class="nc" id="L136">    EmailMessage emailMessage = format(notification);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">    if (emailMessage != null) {</span>
<span class="nc" id="L138">      emailMessage.setTo(user.email());</span>
<span class="nc" id="L139">      return deliver(emailMessage);</span>
    }
<span class="nc" id="L141">    return false;</span>
  }

  public record EmailDeliveryRequest(String recipientEmail, Notification notification) {
<span class="fc" id="L145">    public EmailDeliveryRequest(String recipientEmail, Notification notification) {</span>
<span class="fc" id="L146">      this.recipientEmail = requireNonNull(recipientEmail, &quot;recipientEmail can't be null&quot;);</span>
<span class="fc" id="L147">      this.notification = requireNonNull(notification, &quot;notification can't be null&quot;);</span>
<span class="fc" id="L148">    }</span>

    @Override
    public boolean equals(Object o) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">      if (this == o) {</span>
<span class="fc" id="L153">        return true;</span>
      }
<span class="pc bpc" id="L155" title="2 of 4 branches missed.">      if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L156">        return false;</span>
      }
<span class="fc" id="L158">      EmailDeliveryRequest that = (EmailDeliveryRequest) o;</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">      return Objects.equals(recipientEmail, that.recipientEmail) &amp;&amp;</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">        Objects.equals(notification, that.notification);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L165">      return &quot;EmailDeliveryRequest{&quot; + &quot;'&quot; + recipientEmail + '\'' + &quot; : &quot; + notification + '}';</span>
    }
  }

  public int deliverAll(Set&lt;EmailDeliveryRequest&gt; deliveries) {
<span class="fc bfc" id="L170" title="All 4 branches covered.">    if (deliveries.isEmpty() || !isActivated()) {</span>
<span class="fc" id="L171">      LOG.debug(SMTP_HOST_NOT_CONFIGURED_DEBUG_MSG);</span>
<span class="fc" id="L172">      return 0;</span>
    }

<span class="fc" id="L175">    return (int) deliveries.stream()</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">      .filter(t -&gt; !t.recipientEmail().isBlank())</span>
<span class="fc" id="L177">      .map(t -&gt; {</span>
<span class="fc" id="L178">        EmailMessage emailMessage = format(t.notification());</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (emailMessage != null) {</span>
<span class="fc" id="L180">          emailMessage.setTo(t.recipientEmail());</span>
<span class="fc" id="L181">          return deliver(emailMessage);</span>
        }
<span class="fc" id="L183">        return false;</span>
      })
<span class="fc" id="L185">      .filter(Boolean::booleanValue)</span>
<span class="fc" id="L186">      .count();</span>
  }

  @CheckForNull
  private User findByLogin(String login) {
<span class="nc" id="L191">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="nc" id="L192">      UserDto dto = dbClient.userDao().selectActiveUserByLogin(dbSession, login);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">      return dto != null ? dto.toUser() : null;</span>
    }
  }

  private EmailMessage format(Notification notification) {
<span class="fc bfc" id="L198" title="All 2 branches covered.">    for (EmailTemplate template : templates) {</span>
<span class="fc" id="L199">      EmailMessage email = template.format(notification);</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">      if (email != null) {</span>
<span class="fc" id="L201">        return email;</span>
      }
    }
<span class="fc" id="L204">    LOG.warn(&quot;Email template not found for notification: {}&quot;, notification);</span>
<span class="fc" id="L205">    return null;</span>
  }

  boolean deliver(EmailMessage emailMessage) {
<span class="fc bfc" id="L209" title="All 2 branches covered.">    if (!isActivated()) {</span>
<span class="fc" id="L210">      LOG.debug(SMTP_HOST_NOT_CONFIGURED_DEBUG_MSG);</span>
<span class="fc" id="L211">      return false;</span>
    }
    try {
<span class="fc" id="L214">      send(emailMessage);</span>
<span class="fc" id="L215">      return true;</span>
<span class="fc" id="L216">    } catch (EmailException e) {</span>
<span class="fc" id="L217">      LOG.error(&quot;Unable to send email&quot;, e);</span>
<span class="fc" id="L218">      return false;</span>
    }
  }

  private void send(EmailMessage emailMessage) throws EmailException {
    // Trick to correctly initialize javax.mail library
<span class="fc" id="L224">    ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span>
<span class="fc" id="L225">    Thread.currentThread().setContextClassLoader(getClass().getClassLoader());</span>

    try {
<span class="fc" id="L228">      LOG.atTrace()</span>
<span class="fc" id="L229">        .addArgument(() -&gt; sanitizeLog(emailMessage.getMessage()))</span>
<span class="fc" id="L230">        .log(&quot;Sending email: {}&quot;);</span>
<span class="fc" id="L231">      String host = resolveHost();</span>

<span class="fc" id="L233">      Email email = createEmailWithMessage(emailMessage);</span>
<span class="fc" id="L234">      setHeaders(email, emailMessage, host);</span>
<span class="fc" id="L235">      setConnectionDetails(email);</span>
<span class="fc" id="L236">      setToAndFrom(email, emailMessage);</span>
<span class="fc" id="L237">      setSubject(email, emailMessage);</span>
<span class="fc" id="L238">      email.send();</span>

    } finally {
<span class="fc" id="L241">      Thread.currentThread().setContextClassLoader(classloader);</span>
    }
<span class="fc" id="L243">  }</span>

  private static String sanitizeLog(String message) {
<span class="fc" id="L246">    return PATTERN_LINE_BREAK.matcher(message).replaceAll(&quot;_&quot;);</span>
  }

  private static Email createEmailWithMessage(EmailMessage emailMessage) throws EmailException {
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">    if (emailMessage.isHtml()) {</span>
<span class="nc" id="L251">      return new HtmlEmail().setHtmlMsg(emailMessage.getMessage());</span>
    }
<span class="fc" id="L253">    return new SimpleEmail().setMsg(emailMessage.getMessage());</span>
  }

  private void setSubject(Email email, EmailMessage emailMessage) {
<span class="fc" id="L257">    String subject = StringUtils.defaultIfBlank(StringUtils.trimToEmpty(configuration.getPrefix()) + &quot; &quot;, &quot;&quot;)</span>
<span class="fc" id="L258">      + Objects.toString(emailMessage.getSubject(), SUBJECT_DEFAULT);</span>
<span class="fc" id="L259">    email.setSubject(subject);</span>
<span class="fc" id="L260">  }</span>

  private void setToAndFrom(Email email, EmailMessage emailMessage) throws EmailException {
<span class="fc" id="L263">    String fromName = configuration.getFromName();</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">    String from = StringUtils.isBlank(emailMessage.getFrom()) ? fromName : (emailMessage.getFrom() + &quot; (&quot; + fromName + &quot;)&quot;);</span>
<span class="fc" id="L265">    email.setFrom(configuration.getFrom(), from);</span>
<span class="fc" id="L266">    email.addTo(emailMessage.getTo(), &quot; &quot;);</span>
<span class="fc" id="L267">  }</span>

  @CheckForNull
  private String resolveHost() {
    try {
<span class="fc" id="L272">      return new URL(server.getPublicRootUrl()).getHost();</span>
<span class="nc" id="L273">    } catch (MalformedURLException e) {</span>
      // ignore
<span class="nc" id="L275">      return null;</span>
    }
  }

  private void setHeaders(Email email, EmailMessage emailMessage, @CheckForNull String host) {
    // Set general information
<span class="fc" id="L281">    email.setCharset(&quot;UTF-8&quot;);</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">    if (StringUtils.isNotBlank(host)) {</span>
      /*
       * Set headers for proper threading: GMail will not group messages, even if they have same subject, but don't have &quot;In-Reply-To&quot; and
       * &quot;References&quot; headers. TODO investigate threading in other clients like KMail, Thunderbird, Outlook
       */
<span class="fc bfc" id="L287" title="All 2 branches covered.">      if (StringUtils.isNotEmpty(emailMessage.getMessageId())) {</span>
<span class="fc" id="L288">        String messageId = &quot;&lt;&quot; + emailMessage.getMessageId() + &quot;@&quot; + host + &quot;&gt;&quot;;</span>
<span class="fc" id="L289">        email.addHeader(IN_REPLY_TO_HEADER, messageId);</span>
<span class="fc" id="L290">        email.addHeader(REFERENCES_HEADER, messageId);</span>
      }
      // Set headers for proper filtering
<span class="fc" id="L293">      email.addHeader(LIST_ID_HEADER, &quot;SonarQube &lt;sonar.&quot; + host + &quot;&gt;&quot;);</span>
<span class="fc" id="L294">      email.addHeader(LIST_ARCHIVE_HEADER, server.getPublicRootUrl());</span>
    }
<span class="fc" id="L296">  }</span>

  private void setConnectionDetails(Email email) throws EmailException {
<span class="fc" id="L299">    email.setHostName(configuration.getSmtpHost());</span>
<span class="fc" id="L300">    configureSecureConnection(email);</span>
<span class="fc" id="L301">    email.setSocketConnectionTimeout(SOCKET_TIMEOUT);</span>
<span class="fc" id="L302">    email.setSocketTimeout(SOCKET_TIMEOUT);</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">    if (EMAIL_CONFIG_SMTP_AUTH_METHOD_OAUTH.equals(configuration.getAuthMethod())) {</span>
<span class="nc" id="L304">      setOauthAuthentication(email);</span>
<span class="pc bpc" id="L305" title="2 of 4 branches missed.">    } else if (StringUtils.isNotBlank(configuration.getSmtpUsername()) || StringUtils.isNotBlank(configuration.getSmtpPassword())) {</span>
<span class="nc" id="L306">      setBasicAuthentication(email);</span>
    }
<span class="fc" id="L308">  }</span>

  private void setOauthAuthentication(Email email) throws EmailException {
<span class="nc" id="L311">    String token = oAuthMicrosoftRestClient.getAccessTokenFromClientCredentialsGrantFlow(configuration.getOAuthHost(), configuration.getOAuthClientId(),</span>
<span class="nc" id="L312">      configuration.getOAuthClientSecret(), configuration.getOAuthTenant(), configuration.getOAuthScope());</span>
<span class="nc" id="L313">    email.setAuthentication(configuration.getSmtpUsername(), token);</span>
<span class="nc" id="L314">    Properties props = email.getMailSession().getProperties();</span>
<span class="nc" id="L315">    props.put(&quot;mail.smtp.auth.mechanisms&quot;, &quot;XOAUTH2&quot;);</span>
<span class="nc" id="L316">    props.put(&quot;mail.smtp.auth.login.disable&quot;, &quot;true&quot;);</span>
<span class="nc" id="L317">    props.put(&quot;mail.smtp.auth.plain.disable&quot;, &quot;true&quot;);</span>
<span class="nc" id="L318">  }</span>

  private void setBasicAuthentication(Email email) {
<span class="nc bnc" id="L321" title="All 4 branches missed.">    if (StringUtils.isNotBlank(configuration.getSmtpUsername()) || StringUtils.isNotBlank(configuration.getSmtpPassword())) {</span>
<span class="nc" id="L322">      email.setAuthentication(configuration.getSmtpUsername(), configuration.getSmtpPassword());</span>
    }
<span class="nc" id="L324">  }</span>

  private void configureSecureConnection(Email email) {
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">    if (StringUtils.equalsIgnoreCase(configuration.getSecureConnection(), &quot;SSLTLS&quot;)) {</span>
<span class="nc" id="L328">      email.setSSLOnConnect(true);</span>
<span class="nc" id="L329">      email.setSSLCheckServerIdentity(true);</span>
<span class="nc" id="L330">      email.setSslSmtpPort(String.valueOf(configuration.getSmtpPort()));</span>

      // this port is not used except in EmailException message, that's why it's set with the same value than SSL port.
      // It prevents from getting bad message.
<span class="nc" id="L334">      email.setSmtpPort(configuration.getSmtpPort());</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">    } else if (StringUtils.equalsIgnoreCase(configuration.getSecureConnection(), &quot;STARTTLS&quot;)) {</span>
<span class="fc" id="L336">      email.setStartTLSEnabled(true);</span>
<span class="fc" id="L337">      email.setStartTLSRequired(true);</span>
<span class="fc" id="L338">      email.setSSLCheckServerIdentity(true);</span>
<span class="fc" id="L339">      email.setSmtpPort(configuration.getSmtpPort());</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">    } else if (StringUtils.equalsIgnoreCase(configuration.getSecureConnection(), &quot;NONE&quot;)) {</span>
<span class="fc" id="L341">      email.setSmtpPort(configuration.getSmtpPort());</span>
    } else {
<span class="nc" id="L343">      throw new SonarException(&quot;Unknown type of SMTP secure connection: &quot; + configuration.getSecureConnection());</span>
    }
<span class="fc" id="L345">  }</span>

  /**
   * Send test email.
   *
   * @throws EmailException when unable to send
   */
  public void sendTestEmail(String toAddress, String subject, String message) throws EmailException {
    try {
<span class="fc" id="L354">      EmailMessage emailMessage = new EmailMessage();</span>
<span class="fc" id="L355">      emailMessage.setTo(toAddress);</span>
<span class="fc" id="L356">      emailMessage.setSubject(subject);</span>
<span class="fc" id="L357">      emailMessage.setPlainTextMessage(message + getServerBaseUrlFooter());</span>
<span class="fc" id="L358">      send(emailMessage);</span>
<span class="fc" id="L359">    } catch (EmailException e) {</span>
<span class="fc" id="L360">      LOG.debug(&quot;Fail to send test email to {}: {}&quot;, toAddress, e);</span>
<span class="fc" id="L361">      throw e;</span>
<span class="fc" id="L362">    }</span>
<span class="fc" id="L363">  }</span>

  private String getServerBaseUrlFooter() {
<span class="fc" id="L366">    return String.format(MAIL_SENT_FROM, &quot;\n\n&quot;, server.getPublicRootUrl());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>