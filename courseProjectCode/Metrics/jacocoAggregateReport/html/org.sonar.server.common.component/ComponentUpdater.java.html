<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentUpdater.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.common.component</a> &gt; <span class="el_source">ComponentUpdater.java</span></div><h1>ComponentUpdater.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.common.component;

import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;
import javax.annotation.Nullable;
import org.sonar.api.utils.System2;
import org.sonar.core.i18n.I18n;
import org.sonar.core.util.UuidFactory;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.BranchType;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.component.ComponentQualifiers;
import org.sonar.db.component.ComponentScopes;
import org.sonar.db.permission.ProjectPermission;
import org.sonar.db.portfolio.PortfolioDto;
import org.sonar.db.portfolio.PortfolioDto.SelectionMode;
import org.sonar.db.project.CreationMethod;
import org.sonar.db.project.ProjectDto;
import org.sonar.db.property.PropertyDto;
import org.sonar.db.user.UserDto;
import org.sonar.server.common.permission.Operation;
import org.sonar.server.common.permission.PermissionTemplateService;
import org.sonar.server.common.permission.PermissionUpdater;
import org.sonar.server.common.permission.UserPermissionChange;
import org.sonar.server.component.ComponentCreationData;
import org.sonar.server.es.Indexers;
import org.sonar.server.favorite.FavoriteUpdater;
import org.sonar.server.permission.PermissionService;
import org.sonar.server.project.DefaultBranchNameResolver;

import static com.google.common.base.Preconditions.checkState;
import static java.util.Collections.singletonList;
import static org.sonar.core.component.ComponentKeys.ALLOWED_CHARACTERS_MESSAGE;
import static org.sonar.core.component.ComponentKeys.isValidProjectKey;
import static org.sonar.db.permission.ProjectPermission.PUBLIC_PERMISSIONS;
import static org.sonar.server.exceptions.BadRequestException.checkRequest;
import static org.sonar.server.exceptions.BadRequestException.throwBadRequestException;

public class ComponentUpdater {

  static final String SUGGESTION_FEATURE_ENABLED_PROPERTY = &quot;sonar.ai.suggestions.enabled&quot;;
  static final String ENABLED_FOR_ALL_PROJECTS = &quot;ENABLED_FOR_ALL_PROJECTS&quot;;
<span class="fc" id="L68">  private static final Set&lt;String&gt; PROJ_APP_QUALIFIERS = Set.of(ComponentQualifiers.PROJECT, ComponentQualifiers.APP);</span>
  private static final String KEY_ALREADY_EXISTS_ERROR = &quot;Could not create %s with key: \&quot;%s\&quot;. A similar key already exists: \&quot;%s\&quot;&quot;;
  private static final String MALFORMED_KEY_ERROR = &quot;Malformed key for %s: '%s'. %s.&quot;;
  private final DbClient dbClient;
  private final I18n i18n;
  private final System2 system2;
  private final PermissionTemplateService permissionTemplateService;
  private final FavoriteUpdater favoriteUpdater;
  private final Indexers indexers;
  private final UuidFactory uuidFactory;
  private final DefaultBranchNameResolver defaultBranchNameResolver;
  private final PermissionUpdater&lt;UserPermissionChange&gt; userPermissionUpdater;
  private final PermissionService permissionService;

  public ComponentUpdater(DbClient dbClient, I18n i18n, System2 system2,
    PermissionTemplateService permissionTemplateService, FavoriteUpdater favoriteUpdater,
    Indexers indexers, UuidFactory uuidFactory, DefaultBranchNameResolver defaultBranchNameResolver, PermissionUpdater&lt;UserPermissionChange&gt; userPermissionUpdater,
<span class="fc" id="L85">    PermissionService permissionService) {</span>
<span class="fc" id="L86">    this.dbClient = dbClient;</span>
<span class="fc" id="L87">    this.i18n = i18n;</span>
<span class="fc" id="L88">    this.system2 = system2;</span>
<span class="fc" id="L89">    this.permissionTemplateService = permissionTemplateService;</span>
<span class="fc" id="L90">    this.favoriteUpdater = favoriteUpdater;</span>
<span class="fc" id="L91">    this.indexers = indexers;</span>
<span class="fc" id="L92">    this.uuidFactory = uuidFactory;</span>
<span class="fc" id="L93">    this.defaultBranchNameResolver = defaultBranchNameResolver;</span>
<span class="fc" id="L94">    this.userPermissionUpdater = userPermissionUpdater;</span>
<span class="fc" id="L95">    this.permissionService = permissionService;</span>
<span class="fc" id="L96">  }</span>

  /**
   * - Create component
   * - Apply default permission template
   * - Add component to favorite if the component has the 'Project Creators' permission
   * - Index component in es indexes
   */
  public ComponentCreationData create(DbSession dbSession, ComponentCreationParameters componentCreationParameters) {
<span class="fc" id="L105">    ComponentCreationData componentCreationData = createWithoutCommit(dbSession, componentCreationParameters);</span>
<span class="fc" id="L106">    commitAndIndex(dbSession, componentCreationData);</span>
<span class="fc" id="L107">    return componentCreationData;</span>
  }

  public void commitAndIndex(DbSession dbSession, ComponentCreationData componentCreationData) {
<span class="fc bfc" id="L111" title="All 2 branches covered.">    if (componentCreationData.portfolioDto() != null) {</span>
<span class="fc" id="L112">      indexers.commitAndIndexEntities(dbSession, singletonList(componentCreationData.portfolioDto()), Indexers.EntityEvent.CREATION);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">    } else if (componentCreationData.projectDto() != null) {</span>
<span class="fc" id="L114">      indexers.commitAndIndexEntities(dbSession, singletonList(componentCreationData.projectDto()), Indexers.EntityEvent.CREATION);</span>
    }
<span class="fc" id="L116">  }</span>

  /**
   * Create component without committing.
   * Don't forget to call commitAndIndex(...) when ready to commit.
   */
  public ComponentCreationData createWithoutCommit(DbSession dbSession, ComponentCreationParameters componentCreationParameters) {
<span class="fc" id="L123">    checkKeyFormat(componentCreationParameters.newComponent().qualifier(), componentCreationParameters.newComponent().key());</span>
<span class="fc" id="L124">    checkKeyAlreadyExists(dbSession, componentCreationParameters.newComponent());</span>

<span class="fc" id="L126">    long now = system2.now();</span>

<span class="fc" id="L128">    ComponentDto componentDto = createRootComponent(dbSession, componentCreationParameters.newComponent(), now);</span>

<span class="fc" id="L130">    BranchDto mainBranch = null;</span>
<span class="fc" id="L131">    ProjectDto projectDto = null;</span>
<span class="fc" id="L132">    PortfolioDto portfolioDto = null;</span>

<span class="fc bfc" id="L134" title="All 2 branches covered.">    if (isProjectOrApp(componentDto)) {</span>
<span class="fc" id="L135">      var isAiCodeFixEnabled = isAiCodeFixEnabledForAllProjects();</span>
<span class="fc" id="L136">      projectDto = toProjectDto(componentDto, now, componentCreationParameters.creationMethod(), isAiCodeFixEnabled);</span>
<span class="fc" id="L137">      dbClient.projectDao().insert(dbSession, projectDto);</span>
<span class="fc" id="L138">      addToFavourites(dbSession, projectDto, componentCreationParameters.userUuid(), componentCreationParameters.userLogin());</span>
<span class="fc" id="L139">      mainBranch = createMainBranch(dbSession, componentDto.uuid(), projectDto.getUuid(), componentCreationParameters.mainBranchName());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">      if (componentCreationParameters.isManaged()) {</span>
<span class="fc" id="L141">        applyPublicPermissionsForCreator(dbSession, projectDto, componentCreationParameters.userUuid());</span>
      } else {
<span class="fc" id="L143">        permissionTemplateService.applyDefaultToNewComponent(dbSession, projectDto, componentCreationParameters.userUuid());</span>
      }
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">    } else if (isPortfolio(componentDto)) {</span>
<span class="fc" id="L146">      portfolioDto = toPortfolioDto(componentDto, now);</span>
<span class="fc" id="L147">      dbClient.portfolioDao().insert(dbSession, portfolioDto, false);</span>
<span class="fc" id="L148">      permissionTemplateService.applyDefaultToNewComponent(dbSession, portfolioDto, componentCreationParameters.userUuid());</span>
    } else {
<span class="nc" id="L150">      throw new IllegalArgumentException(&quot;Component &quot; + componentDto + &quot; is not a top level entity&quot;);</span>
    }

<span class="fc" id="L153">    return new ComponentCreationData(componentDto, portfolioDto, mainBranch, projectDto);</span>
  }

  private boolean isAiCodeFixEnabledForAllProjects() {
<span class="fc" id="L157">    return Optional.ofNullable(dbClient.propertiesDao().selectGlobalProperty(SUGGESTION_FEATURE_ENABLED_PROPERTY))</span>
<span class="fc" id="L158">      .map(PropertyDto::getValue)</span>
<span class="fc" id="L159">      .stream().anyMatch(ENABLED_FOR_ALL_PROJECTS::equals);</span>
  }

  private void applyPublicPermissionsForCreator(DbSession dbSession, ProjectDto projectDto, @Nullable String userUuid) {
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">    if (userUuid != null) {</span>
<span class="fc" id="L164">      UserDto userDto = dbClient.userDao().selectByUuid(dbSession, userUuid);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">      checkState(userDto != null, &quot;User with uuid '%s' doesn't exist&quot;, userUuid);</span>
<span class="fc" id="L166">      userPermissionUpdater.apply(dbSession,</span>
<span class="fc" id="L167">        PUBLIC_PERMISSIONS.stream()</span>
<span class="fc" id="L168">        .map(permission -&gt; toUserPermissionChange(permission, projectDto, userDto))</span>
<span class="fc" id="L169">        .collect(Collectors.toSet()));</span>
    }
<span class="fc" id="L171">  }</span>

  private UserPermissionChange toUserPermissionChange(ProjectPermission permission, ProjectDto projectDto, UserDto userDto) {
<span class="fc" id="L174">    return new UserPermissionChange(Operation.ADD, permission.getKey(), projectDto, userDto, permissionService);</span>
  }

  private void addToFavourites(DbSession dbSession, ProjectDto projectDto, @Nullable String userUuid, @Nullable String userLogin) {
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (permissionTemplateService.hasDefaultTemplateWithPermissionOnProjectCreator(dbSession, projectDto)) {</span>
<span class="fc" id="L179">      favoriteUpdater.add(dbSession, projectDto, userUuid, userLogin, false);</span>
    }
<span class="fc" id="L181">  }</span>

  private void checkKeyFormat(String qualifier, String key) {
<span class="fc" id="L184">    checkRequest(isValidProjectKey(key), MALFORMED_KEY_ERROR, getQualifierToDisplay(qualifier), key, ALLOWED_CHARACTERS_MESSAGE);</span>
<span class="fc" id="L185">  }</span>

  private void checkKeyAlreadyExists(DbSession dbSession, NewComponent newComponent) {
<span class="fc" id="L188">    Optional&lt;PortfolioDto&gt; portfolios = dbClient.portfolioDao().selectByKey(dbSession, newComponent.key());</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">    if (portfolios.isPresent()) {</span>
<span class="nc" id="L190">      throwBadRequestException(&quot;Could not create component with key: \&quot;%s\&quot;. Key already in use.&quot;, newComponent.key());</span>
    }
<span class="fc" id="L192">    List&lt;ComponentDto&gt; componentDtos = dbClient.componentDao().selectByKeyCaseInsensitive(dbSession, newComponent.key());</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">    if (!componentDtos.isEmpty()) {</span>
<span class="fc" id="L194">      String alreadyExistingKeys = componentDtos</span>
<span class="fc" id="L195">        .stream()</span>
<span class="fc" id="L196">        .map(ComponentDto::getKey)</span>
<span class="fc" id="L197">        .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="nc" id="L198">      throwBadRequestException(KEY_ALREADY_EXISTS_ERROR, getQualifierToDisplay(newComponent.qualifier()), newComponent.key(), alreadyExistingKeys);</span>
    }
<span class="fc" id="L200">  }</span>

  private ComponentDto createRootComponent(DbSession session, NewComponent newComponent, long now) {
<span class="fc" id="L203">    String uuid = uuidFactory.create();</span>

<span class="fc" id="L205">    ComponentDto component = new ComponentDto()</span>
<span class="fc" id="L206">      .setUuid(uuid)</span>
<span class="fc" id="L207">      .setUuidPath(ComponentDto.UUID_PATH_OF_ROOT)</span>
<span class="fc" id="L208">      .setBranchUuid(uuid)</span>
<span class="fc" id="L209">      .setKey(newComponent.key())</span>
<span class="fc" id="L210">      .setName(newComponent.name())</span>
<span class="fc" id="L211">      .setDescription(newComponent.description())</span>
<span class="fc" id="L212">      .setLongName(newComponent.name())</span>
<span class="fc" id="L213">      .setScope(ComponentScopes.PROJECT)</span>
<span class="fc" id="L214">      .setQualifier(newComponent.qualifier())</span>
<span class="fc" id="L215">      .setPrivate(newComponent.isPrivate())</span>
<span class="fc" id="L216">      .setCreatedAt(new Date(now));</span>

<span class="fc" id="L218">    dbClient.componentDao().insert(session, component, true);</span>
<span class="fc" id="L219">    return component;</span>
  }

  private ProjectDto toProjectDto(ComponentDto component, long now, CreationMethod creationMethod, boolean isAiCodeFixEnabled) {
<span class="fc" id="L223">    return new ProjectDto()</span>
<span class="fc" id="L224">      .setUuid(uuidFactory.create())</span>
<span class="fc" id="L225">      .setKey(component.getKey())</span>
<span class="fc" id="L226">      .setQualifier(component.qualifier())</span>
<span class="fc" id="L227">      .setName(component.name())</span>
<span class="fc" id="L228">      .setPrivate(component.isPrivate())</span>
<span class="fc" id="L229">      .setDescription(component.description())</span>
<span class="fc" id="L230">      .setCreationMethod(creationMethod)</span>
<span class="fc" id="L231">      .setAiCodeFixEnabled(isAiCodeFixEnabled)</span>
<span class="fc" id="L232">      .setUpdatedAt(now)</span>
<span class="fc" id="L233">      .setCreatedAt(now);</span>
  }

  private static PortfolioDto toPortfolioDto(ComponentDto component, long now) {
<span class="fc" id="L237">    return new PortfolioDto()</span>
<span class="fc" id="L238">      .setUuid(component.uuid())</span>
<span class="fc" id="L239">      .setRootUuid(component.branchUuid())</span>
<span class="fc" id="L240">      .setKey(component.getKey())</span>
<span class="fc" id="L241">      .setName(component.name())</span>
<span class="fc" id="L242">      .setPrivate(component.isPrivate())</span>
<span class="fc" id="L243">      .setDescription(component.description())</span>
<span class="fc" id="L244">      .setSelectionMode(SelectionMode.NONE.name())</span>
<span class="fc" id="L245">      .setUpdatedAt(now)</span>
<span class="fc" id="L246">      .setCreatedAt(now);</span>
  }

  private static boolean isProjectOrApp(ComponentDto componentDto) {
<span class="fc" id="L250">    return PROJ_APP_QUALIFIERS.contains(componentDto.qualifier());</span>
  }

  private static boolean isPortfolio(ComponentDto componentDto) {
<span class="fc" id="L254">    return ComponentQualifiers.VIEW.contains(componentDto.qualifier());</span>
  }

  private BranchDto createMainBranch(DbSession session, String componentUuid, String projectUuid, @Nullable String mainBranch) {
<span class="fc" id="L258">    BranchDto branch = new BranchDto()</span>
<span class="fc" id="L259">      .setBranchType(BranchType.BRANCH)</span>
<span class="fc" id="L260">      .setUuid(componentUuid)</span>
<span class="fc" id="L261">      .setIsMain(true)</span>
<span class="fc" id="L262">      .setKey(Optional.ofNullable(mainBranch).orElse(defaultBranchNameResolver.getEffectiveMainBranchName()))</span>
<span class="fc" id="L263">      .setMergeBranchUuid(null)</span>
<span class="fc" id="L264">      .setExcludeFromPurge(true)</span>
<span class="fc" id="L265">      .setProjectUuid(projectUuid);</span>
<span class="fc" id="L266">    dbClient.branchDao().upsert(session, branch);</span>
<span class="fc" id="L267">    return branch;</span>
  }

  private String getQualifierToDisplay(String qualifier) {
<span class="fc" id="L271">    return i18n.message(Locale.getDefault(), &quot;qualifier.&quot; + qualifier, &quot;Project&quot;);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>