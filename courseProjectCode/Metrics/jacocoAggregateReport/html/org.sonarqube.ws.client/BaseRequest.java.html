<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseRequest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonarqube.ws.client</a> &gt; <span class="el_source">BaseRequest.java</span></div><h1>BaseRequest.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonarqube.ws.client;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.Set;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonarqube.ws.MediaTypes;

import static java.util.Collections.emptyList;
import static java.util.Collections.unmodifiableSet;
import static java.util.Objects.requireNonNull;
import static org.sonarqube.ws.WsUtils.checkArgument;
import static org.sonarqube.ws.WsUtils.isNullOrEmpty;

abstract class BaseRequest&lt;SELF extends BaseRequest&lt;SELF&gt;&gt; implements WsRequest {

  private final String path;

<span class="fc" id="L46">  private String mediaType = MediaTypes.JSON;</span>

<span class="fc" id="L48">  private final DefaultParameters parameters = new DefaultParameters();</span>
<span class="fc" id="L49">  private final DefaultHeaders headers = new DefaultHeaders();</span>
<span class="fc" id="L50">  private OptionalInt timeOutInMs = OptionalInt.empty();</span>
<span class="fc" id="L51">  private OptionalInt writeTimeOutInMs = OptionalInt.empty();</span>

<span class="fc" id="L53">  BaseRequest(String path) {</span>
<span class="fc" id="L54">    this.path = path;</span>
<span class="fc" id="L55">  }</span>

  @Override
  public String getPath() {
<span class="fc" id="L59">    return path;</span>
  }

  @Override
  public String getMediaType() {
<span class="fc" id="L64">    return mediaType;</span>
  }

  @Override
  public OptionalInt getTimeOutInMs() {
<span class="fc" id="L69">    return timeOutInMs;</span>
  }

  public &lt;T extends SELF&gt; T setTimeOutInMs(int timeOutInMs) {
<span class="fc" id="L73">    this.timeOutInMs = OptionalInt.of(timeOutInMs);</span>
<span class="fc" id="L74">    return (T) this;</span>
  }

  @Override
  public OptionalInt getWriteTimeOutInMs() {
<span class="fc" id="L79">    return writeTimeOutInMs;</span>
  }

  public &lt;T extends SELF&gt; T setWriteTimeOutInMs(int writeTimeOutInMs) {
<span class="fc" id="L83">    this.writeTimeOutInMs = OptionalInt.of(writeTimeOutInMs);</span>
<span class="fc" id="L84">    return (T) this;</span>
  }

  /**
   * Expected media type of response. Default is {@link MediaTypes#JSON}.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public &lt;T extends SELF&gt; T setMediaType(String s) {
<span class="fc" id="L92">    requireNonNull(s, &quot;media type of response cannot be null&quot;);</span>
<span class="fc" id="L93">    this.mediaType = s;</span>
<span class="fc" id="L94">    return (T) this;</span>
  }

  public &lt;T extends SELF&gt; T setParam(String key, @Nullable String value) {
<span class="fc" id="L98">    return (T) setSingleValueParam(key, value);</span>
  }

  public &lt;T extends SELF&gt; T setParam(String key, @Nullable Integer value) {
<span class="nc" id="L102">    return setSingleValueParam(key, value);</span>
  }

  public &lt;T extends SELF&gt; T setParam(String key, @Nullable Long value) {
<span class="nc" id="L106">    return setSingleValueParam(key, value);</span>
  }

  public &lt;T extends SELF&gt; T setParam(String key, @Nullable Float value) {
<span class="nc" id="L110">    return setSingleValueParam(key, value);</span>
  }

  public &lt;T extends SELF&gt; T setParam(String key, @Nullable Boolean value) {
<span class="fc" id="L114">    return setSingleValueParam(key, value);</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  private &lt;T extends SELF&gt; T setSingleValueParam(String key, @Nullable Object value) {
<span class="fc bfc" id="L119" title="All 2 branches covered.">    checkArgument(!isNullOrEmpty(key), &quot;a WS parameter key cannot be null&quot;);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">    if (value == null) {</span>
<span class="fc" id="L121">      return (T) this;</span>
    }
<span class="fc" id="L123">    parameters.setValue(key, value.toString());</span>

<span class="fc" id="L125">    return (T) this;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public &lt;T extends SELF&gt; T setParam(String key, @Nullable Collection&lt;? extends Object&gt; values) {
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">    checkArgument(!isNullOrEmpty(key), &quot;a WS parameter key cannot be null&quot;);</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">    if (values == null || values.isEmpty()) {</span>
<span class="nc" id="L132">      return (T) this;</span>
    }

<span class="fc" id="L135">    parameters.setValues(key, values.stream()</span>
<span class="fc" id="L136">      .filter(Objects::nonNull)</span>
<span class="fc" id="L137">      .map(Object::toString)</span>
<span class="fc" id="L138">      .toList());</span>

<span class="fc" id="L140">    return (T) this;</span>
  }

  @Override
  public Parameters getParameters() {
<span class="fc" id="L145">    return parameters;</span>
  }

  @Override
  public Headers getHeaders() {
<span class="fc" id="L150">    return headers;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  public &lt;T extends SELF&gt; T setHeader(String name, @Nullable String value) {
<span class="fc" id="L155">    requireNonNull(name, &quot;Header name can't be null&quot;);</span>
<span class="fc" id="L156">    headers.setValue(name, value);</span>
<span class="fc" id="L157">    return (T) this;</span>
  }

<span class="fc" id="L160">  private static class DefaultParameters implements Parameters {</span>
    // preserve insertion order
<span class="fc" id="L162">    private final Map&lt;String, List&lt;String&gt;&gt; keyValues = new LinkedHashMap&lt;&gt;();</span>

    @Override
    @CheckForNull
    public String getValue(String key) {
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">      return keyValues.containsKey(key) ? keyValues.get(key).get(0) : null;</span>
    }

    @Override
    public List&lt;String&gt; getValues(String key) {
<span class="fc bfc" id="L172" title="All 2 branches covered.">      return keyValues.containsKey(key) ? keyValues.get(key) : emptyList();</span>
    }

    @Override
    public Set&lt;String&gt; getKeys() {
<span class="fc" id="L177">      return keyValues.keySet();</span>
    }

    private DefaultParameters setValue(String key, String value) {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">      checkArgument(!isNullOrEmpty(key));</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">      checkArgument(value != null);</span>

<span class="fc" id="L184">      keyValues.computeIfAbsent(key, k -&gt; new ArrayList&lt;&gt;()).add(value);</span>
<span class="fc" id="L185">      return this;</span>
    }

    private DefaultParameters setValues(String key, Collection&lt;String&gt; values) {
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">      checkArgument(!isNullOrEmpty(key));</span>
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">      checkArgument(values != null &amp;&amp; !values.isEmpty());</span>

<span class="fc" id="L192">      keyValues.computeIfAbsent(key, k -&gt; new ArrayList&lt;&gt;()).addAll(values.stream().map(Object::toString).filter(Objects::nonNull).toList());</span>
<span class="fc" id="L193">      return this;</span>
    }
  }

<span class="fc" id="L197">  private static class DefaultHeaders implements Headers {</span>
<span class="fc" id="L198">    private final Map&lt;String, String&gt; keyValues = new HashMap&lt;&gt;();</span>

    @Override
    public Optional&lt;String&gt; getValue(String name) {
<span class="fc" id="L202">      return Optional.ofNullable(keyValues.get(name));</span>
    }

    private DefaultHeaders setValue(String name, @Nullable String value) {
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">      checkArgument(!isNullOrEmpty(name));</span>

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">      if (value == null) {</span>
<span class="nc" id="L209">        keyValues.remove(name);</span>
      } else {
<span class="fc" id="L211">        keyValues.put(name, value);</span>
      }
<span class="fc" id="L213">      return this;</span>
    }

    @Override
    public Set&lt;String&gt; getNames() {
<span class="fc" id="L218">      return unmodifiableSet(keyValues.keySet());</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>