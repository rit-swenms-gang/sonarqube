<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComponentTreeAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.measure.ws</a> &gt; <span class="el_source">ComponentTreeAction.java</span></div><h1>ComponentTreeAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.measure.ws;

import com.google.common.collect.FluentIterable;
import com.google.common.collect.HashBasedTable;
import com.google.common.collect.ImmutableSortedSet;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import com.google.common.collect.Table;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import javax.annotation.CheckForNull;
import javax.annotation.Nonnull;
import javax.annotation.Nullable;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.Param;
import org.sonar.api.utils.Paging;
import org.sonar.db.permission.ProjectPermission;
import org.sonar.core.i18n.I18n;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.component.ComponentQualifiers;
import org.sonar.db.component.ComponentScopes;
import org.sonar.db.component.ComponentTreeQuery;
import org.sonar.db.component.ComponentTreeQuery.Strategy;
import org.sonar.db.component.SnapshotDto;
import org.sonar.db.measure.MeasureDto;
import org.sonar.db.measure.MeasureTreeQuery;
import org.sonar.db.metric.MetricDto;
import org.sonar.db.metric.MetricDtoFunctions;
import org.sonar.server.component.ComponentFinder;
import org.sonar.server.component.ComponentTypes;
import org.sonar.server.exceptions.NotFoundException;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Measures;
import org.sonarqube.ws.Measures.ComponentTreeWsResponse;
import org.sonarqube.ws.client.component.ComponentsWsParameters;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkState;
import static java.lang.String.format;
import static java.lang.String.join;
import static java.util.Collections.emptyList;
import static java.util.Collections.emptyMap;
import static java.util.Optional.ofNullable;
import static org.sonar.api.measures.Metric.ValueType.DATA;
import static org.sonar.api.measures.Metric.ValueType.DISTRIB;
import static org.sonar.api.utils.Paging.offset;
import static org.sonar.db.component.ComponentTreeQuery.Strategy.CHILDREN;
import static org.sonar.db.component.ComponentTreeQuery.Strategy.LEAVES;
import static org.sonar.db.metric.RemovedMetricConverter.includeRenamedMetrics;
import static org.sonar.db.metric.RemovedMetricConverter.withRemovedMetricAlias;
import static org.sonar.server.component.ws.MeasuresWsParameters.ACTION_COMPONENT_TREE;
import static org.sonar.server.component.ws.MeasuresWsParameters.ADDITIONAL_METRICS;
import static org.sonar.server.component.ws.MeasuresWsParameters.ADDITIONAL_PERIOD;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_ADDITIONAL_FIELDS;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_BRANCH;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_COMPONENT;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_METRIC_KEYS;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_METRIC_PERIOD_SORT;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_METRIC_SORT;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_METRIC_SORT_FILTER;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_PULL_REQUEST;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_QUALIFIERS;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_STRATEGY;
import static org.sonar.server.exceptions.BadRequestException.checkRequest;
import static org.sonar.server.measure.ws.ComponentDtoToWsComponent.componentDtoToWsComponent;
import static org.sonar.server.measure.ws.ComponentResponseCommon.addMeasureIncludingRenamedMetric;
import static org.sonar.server.measure.ws.ComponentResponseCommon.addMetricToResponseIncludingRenamedMetric;
import static org.sonar.server.measure.ws.MeasureDtoToWsMeasure.updateMeasureBuilder;
import static org.sonar.server.measure.ws.MeasuresWsParametersBuilder.createAdditionalFieldsParameter;
import static org.sonar.server.measure.ws.MeasuresWsParametersBuilder.createMetricKeysParameter;
import static org.sonar.server.measure.ws.SnapshotDtoToWsPeriod.snapshotToWsPeriods;
import static org.sonar.server.ws.KeyExamples.KEY_BRANCH_EXAMPLE_001;
import static org.sonar.server.ws.KeyExamples.KEY_PROJECT_EXAMPLE_001;
import static org.sonar.server.ws.KeyExamples.KEY_PULL_REQUEST_EXAMPLE_001;
import static org.sonar.server.ws.WsParameterBuilder.createQualifiersParameter;
import static org.sonar.server.ws.WsParameterBuilder.QualifierParameterContext.newQualifierParameterContext;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

/**
 * &lt;p&gt;Navigate through components based on different strategy with specified measures.
 * To limit the number of rows in database, a best value algorithm exists in database.&lt;/p&gt;
 * A measure is not stored in database if:
 * &lt;ul&gt;
 * &lt;li&gt;the component is a file (production or test)&lt;/li&gt;
 * &lt;li&gt;optimization algorithm is enabled on the metric&lt;/li&gt;
 * &lt;li&gt;the measure computed equals the metric best value&lt;/li&gt;
 * &lt;li&gt;the period values are all equal to 0&lt;/li&gt;
 * &lt;/ul&gt;
 * To recreate a best value 2 different cases:
 * &lt;ul&gt;
 * &lt;li&gt;Metric starts with 'new_' (ex: new_violations): the best value measure doesn't have a value and period values are all equal to 0&lt;/li&gt;
 * &lt;li&gt;Other metrics: the best value measure has a value of 0 and no period value&lt;/li&gt;
 * &lt;/ul&gt;
 */
public class ComponentTreeAction implements MeasuresWsAction {
  private static final int MAX_SIZE = 500;
  private static final String NUMBER_OF_KEYS_LIMITED = &quot;Number of metric keys is limited to %s&quot;;
  private static final int QUERY_MINIMUM_LENGTH = 3;
  // tree exploration strategies
  static final String ALL_STRATEGY = &quot;all&quot;;
  static final String CHILDREN_STRATEGY = &quot;children&quot;;
  static final String LEAVES_STRATEGY = &quot;leaves&quot;;
<span class="fc" id="L141">  static final Map&lt;String, Strategy&gt; STRATEGIES = Map.of(</span>
    ALL_STRATEGY, LEAVES,
    CHILDREN_STRATEGY, CHILDREN,
    LEAVES_STRATEGY, LEAVES);
  // sort
  static final String NAME_SORT = &quot;name&quot;;
  static final String PATH_SORT = &quot;path&quot;;
  static final String QUALIFIER_SORT = &quot;qualifier&quot;;
  static final String METRIC_SORT = &quot;metric&quot;;
  static final String METRIC_PERIOD_SORT = &quot;metricPeriod&quot;;
<span class="fc" id="L151">  static final Set&lt;String&gt; SORTS = ImmutableSortedSet.of(NAME_SORT, PATH_SORT, QUALIFIER_SORT, METRIC_SORT, METRIC_PERIOD_SORT);</span>
  static final String ALL_METRIC_SORT_FILTER = &quot;all&quot;;
  static final String WITH_MEASURES_ONLY_METRIC_SORT_FILTER = &quot;withMeasuresOnly&quot;;
<span class="fc" id="L154">  static final Set&lt;String&gt; METRIC_SORT_FILTERS = ImmutableSortedSet.of(ALL_METRIC_SORT_FILTER, WITH_MEASURES_ONLY_METRIC_SORT_FILTER);</span>
  private static final int MAX_METRIC_KEYS = 75;
  private static final String COMMA_JOIN_SEPARATOR = &quot;, &quot;;
<span class="fc" id="L157">  private static final Set&lt;String&gt; QUALIFIERS_ELIGIBLE_FOR_BEST_VALUE = Set.of(ComponentQualifiers.FILE, ComponentQualifiers.UNIT_TEST_FILE);</span>

  private final DbClient dbClient;
  private final ComponentFinder componentFinder;
  private final UserSession userSession;
  private final I18n i18n;
  private final ComponentTypes componentTypes;

  public ComponentTreeAction(DbClient dbClient, ComponentFinder componentFinder, UserSession userSession, I18n i18n,
<span class="fc" id="L166">    ComponentTypes componentTypes) {</span>
<span class="fc" id="L167">    this.dbClient = dbClient;</span>
<span class="fc" id="L168">    this.componentFinder = componentFinder;</span>
<span class="fc" id="L169">    this.userSession = userSession;</span>
<span class="fc" id="L170">    this.i18n = i18n;</span>
<span class="fc" id="L171">    this.componentTypes = componentTypes;</span>
<span class="fc" id="L172">  }</span>

  @Override
  public void define(WebService.NewController context) {
<span class="fc" id="L176">    WebService.NewAction action = context.createAction(ACTION_COMPONENT_TREE)</span>
<span class="fc" id="L177">      .setDescription(format(&quot;Navigate through components based on the chosen strategy with specified measures.&lt;br&gt;&quot; +</span>
        &quot;Requires the following permission: 'Browse' on the specified project.&lt;br&gt;&quot; +
        &quot;For applications, it also requires 'Browse' permission on its child projects. &lt;br&gt;&quot; +
        &quot;When limiting search with the %s parameter, directories are not returned.&quot;, Param.TEXT_QUERY))
<span class="fc" id="L181">      .setResponseExample(getClass().getResource(&quot;component_tree-example.json&quot;))</span>
<span class="fc" id="L182">      .setSince(&quot;5.4&quot;)</span>
<span class="fc" id="L183">      .setHandler(this)</span>
<span class="fc" id="L184">      .addPagingParams(100, MAX_SIZE)</span>
<span class="fc" id="L185">      .setChangelog(</span>
<span class="fc" id="L186">        new Change(&quot;2025.4&quot;, format(</span>
          &quot;The following SCA metrics are available on licensed enterprise/datacenter editions with SCA enabled: %s&quot;,
<span class="fc" id="L188">          MeasuresWsModule.getNewScaMetricsInSonarQube202504())),</span>
<span class="fc" id="L189">        new Change(&quot;10.8&quot;, format(NUMBER_OF_KEYS_LIMITED, 75)),</span>
        new Change(&quot;10.8&quot;, &quot;Portfolio project metrics now also include: 'contains_ai_code', 'reliability_rating_without_aica', &quot; +
          &quot;'reliability_rating_with_aica', 'software_quality_security_rating_without_aica', 'software_quality_security_rating_with_aica', &quot; +
          &quot;'security_rating_without_aica', 'security_rating_with_aica', 'new_reliability_rating_without_aica', 'new_reliability_rating_with_aica', &quot; +
          &quot;'new_software_quality_reliability_rating_without_aica', 'new_software_quality_reliability_rating_with_aica', 'new_security_rating_without_aica', &quot; +
          &quot;'new_security_rating_with_aica', 'new_software_quality_security_rating_without_aica', 'new_software_quality_security_rating_with_aica', &quot; +
          &quot;'security_review_rating_without_aica', 'security_review_rating_with_aica', 'sqale_rating_without_aica', 'sqale_rating_with_aica', &quot; +
          &quot;'new_software_quality_maintainability_rating_without_aica', 'new_software_quality_maintainability_rating_with_aica', 'ncloc_without_aica', &quot; +
          &quot;'ncloc_with_aica', 'software_quality_reliability_rating_without_aica', 'software_quality_reliability_rating_with_aica', &quot; +
          &quot;'new_maintainability_rating_without_aica', 'new_maintainability_rating_with_aica', 'software_quality_maintainability_rating_without_aica', &quot; +
          &quot;'software_quality_maintainability_rating_with_aica', 'new_security_review_rating_without_aica', 'new_security_review_rating_with_aica', &quot; +
          &quot;'releasability_rating_without_aica', 'releasability_rating_with_aica'&quot;),
<span class="fc" id="L201">        new Change(&quot;10.8&quot;, String.format(&quot;The following metrics are not deprecated anymore: %s&quot;,</span>
<span class="fc" id="L202">          MeasuresWsModule.getUndeprecatedMetricsinSonarQube108())),</span>
<span class="fc" id="L203">        new Change(&quot;10.8&quot;, String.format(&quot;Added new accepted values for the 'metricKeys' param: %s&quot;,</span>
<span class="fc" id="L204">          MeasuresWsModule.getNewMetricsInSonarQube108())),</span>
<span class="fc" id="L205">        new Change(&quot;10.8&quot;, String.format(&quot;The metrics %s are now deprecated. Use 'software_quality_maintainability_issues', &quot; +</span>
          &quot;'software_quality_reliability_issues', 'software_quality_security_issues', 'new_software_quality_maintainability_issues', &quot; +
          &quot;'new_software_quality_reliability_issues', 'new_software_quality_security_issues' instead.&quot;,
<span class="fc" id="L208">          MeasuresWsModule.getDeprecatedMetricsInSonarQube108())),</span>
<span class="fc" id="L209">        new Change(&quot;10.7&quot;, format(NUMBER_OF_KEYS_LIMITED, 25)),</span>
        new Change(&quot;10.7&quot;,
<span class="fc" id="L211">          &quot;Added new accepted values for the 'metricKeys' param: %s&quot;.formatted(MeasuresWsModule.getNewMetricsInSonarQube107())),</span>
        new Change(&quot;10.5&quot;, &quot;Added new accepted values for the 'metricKeys' param: 'new_maintainability_issues', 'new_reliability_issues',&quot; +
          &quot; 'new_security_issues'&quot;),
<span class="fc" id="L214">        new Change(&quot;10.5&quot;, format(&quot;The metrics %s are now deprecated &quot; +</span>
          &quot;without exact replacement. Use 'maintainability_issues', 'reliability_issues' and 'security_issues' instead.&quot;,
<span class="fc" id="L216">          MeasuresWsModule.getDeprecatedMetricsInSonarQube105())),</span>
        new Change(&quot;10.5&quot;, &quot;Added new accepted values for the 'metricKeys' param: 'maintainability_issues', 'reliability_issues', &quot; +
          &quot;'security_issues'&quot;),
<span class="fc" id="L219">        new Change(&quot;10.4&quot;, format(&quot;The metrics %s are now deprecated &quot; +</span>
          &quot;without exact replacement. Use 'maintainability_issues', 'reliability_issues' and 'security_issues' instead.&quot;,
<span class="fc" id="L221">          MeasuresWsModule.getDeprecatedMetricsInSonarQube104())),</span>
        new Change(&quot;10.4&quot;, &quot;The metrics 'open_issues', 'reopened_issues' and 'confirmed_issues' are now deprecated in the response. &quot; +
          &quot;Consume 'violations' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The use of 'open_issues', 'reopened_issues' and 'confirmed_issues' values in 'metricKeys' param are now &quot; +
          &quot;deprecated. Use 'violations' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The metric 'wont_fix_issues' is now deprecated in the response. Consume 'accepted_issues' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The use of 'wont_fix_issues' value in 'metricKeys' and 'metricSort' params is now deprecated. Use &quot; +
          &quot;'accepted_issues' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;Added new accepted value for the 'metricKeys' and 'metricSort' param: 'accepted_issues'.&quot;),
<span class="fc" id="L230">        new Change(&quot;10.1&quot;, format(&quot;The use of 'BRC' as value for parameter '%s' is removed&quot;,</span>
          ComponentsWsParameters.PARAM_QUALIFIERS)),
<span class="fc" id="L232">        new Change(&quot;10.0&quot;, format(&quot;The use of the following metrics in 'metricKeys' parameter is not deprecated anymore: %s&quot;,</span>
<span class="fc" id="L233">          MeasuresWsModule.getDeprecatedMetricsInSonarQube93())),</span>
        new Change(&quot;10.0&quot;, &quot;the response field periods under measures field is removed.&quot;),
        new Change(&quot;10.0&quot;, &quot;the option `periods` of 'additionalFields' request field is removed.&quot;),
<span class="fc" id="L236">        new Change(&quot;9.3&quot;, format(&quot;The use of the following metrics in 'metricKeys' parameter is deprecated: %s&quot;,</span>
<span class="fc" id="L237">          MeasuresWsModule.getDeprecatedMetricsInSonarQube93())),</span>
        new Change(&quot;8.8&quot;, &quot;parameter 'component' is now required&quot;),
        new Change(&quot;8.8&quot;, &quot;deprecated parameter 'baseComponentId' has been removed&quot;),
        new Change(&quot;8.8&quot;, &quot;deprecated parameter 'baseComponentKey' has been removed.&quot;),
        new Change(&quot;8.8&quot;, &quot;deprecated response field 'id' has been removed&quot;),
        new Change(&quot;8.8&quot;, &quot;deprecated response field 'refId' has been removed.&quot;),
        new Change(&quot;8.1&quot;, &quot;the response field periods under measures field is deprecated. Use period instead.&quot;),
        new Change(&quot;8.1&quot;, &quot;the response field periods is deprecated. Use period instead.&quot;),
<span class="fc" id="L245">        new Change(&quot;7.6&quot;, format(&quot;The use of module keys in parameter '%s' is deprecated&quot;, PARAM_COMPONENT)),</span>
        new Change(&quot;7.2&quot;, &quot;field 'bestValue' is added to the response&quot;),
<span class="fc" id="L247">        new Change(&quot;6.3&quot;, format(NUMBER_OF_KEYS_LIMITED, 15)),</span>
        new Change(&quot;6.6&quot;, &quot;the response field 'id' is deprecated. Use 'key' instead.&quot;),
        new Change(&quot;6.6&quot;, &quot;the response field 'refId' is deprecated. Use 'refKey' instead.&quot;));

<span class="fc" id="L251">    action.createSortParams(SORTS, NAME_SORT, true)</span>
<span class="fc" id="L252">      .setDescription(&quot;Comma-separated list of sort fields&quot;)</span>
<span class="fc" id="L253">      .setExampleValue(NAME_SORT + &quot;,&quot; + PATH_SORT);</span>

<span class="fc" id="L255">    action.createParam(Param.TEXT_QUERY)</span>
<span class="fc" id="L256">      .setDescription(&quot;Limit search to: &lt;ul&gt;&quot; +</span>
        &quot;&lt;li&gt;component names that contain the supplied string&lt;/li&gt;&quot; +
        &quot;&lt;li&gt;component keys that are exactly the same as the supplied string&lt;/li&gt;&quot; +
        &quot;&lt;/ul&gt;&quot;)
<span class="fc" id="L260">      .setMinimumLength(QUERY_MINIMUM_LENGTH)</span>
<span class="fc" id="L261">      .setExampleValue(&quot;FILE_NAM&quot;);</span>

<span class="fc" id="L263">    action.createParam(PARAM_COMPONENT)</span>
<span class="fc" id="L264">      .setRequired(true)</span>
<span class="fc" id="L265">      .setDescription(&quot;Component key. The search is based on this component.&quot;)</span>
<span class="fc" id="L266">      .setExampleValue(KEY_PROJECT_EXAMPLE_001);</span>

<span class="fc" id="L268">    action.createParam(PARAM_BRANCH)</span>
<span class="fc" id="L269">      .setDescription(&quot;Branch key. Not available in the community edition.&quot;)</span>
<span class="fc" id="L270">      .setExampleValue(KEY_BRANCH_EXAMPLE_001)</span>
<span class="fc" id="L271">      .setSince(&quot;6.6&quot;);</span>

<span class="fc" id="L273">    action.createParam(PARAM_PULL_REQUEST)</span>
<span class="fc" id="L274">      .setDescription(&quot;Pull request id. Not available in the community edition.&quot;)</span>
<span class="fc" id="L275">      .setExampleValue(KEY_PULL_REQUEST_EXAMPLE_001)</span>
<span class="fc" id="L276">      .setSince(&quot;7.1&quot;);</span>

<span class="fc" id="L278">    action.createParam(PARAM_METRIC_SORT)</span>
<span class="fc" id="L279">      .setDescription(</span>
<span class="fc" id="L280">        format(&quot;Metric key to sort by. The '%s' parameter must contain the '%s' or '%s' value. It must be part of the '%s' parameter&quot;,</span>
          Param.SORT, METRIC_SORT, METRIC_PERIOD_SORT,
          PARAM_METRIC_KEYS))
<span class="fc" id="L283">      .setExampleValue(&quot;ncloc&quot;);</span>

<span class="fc" id="L285">    action.createParam(PARAM_METRIC_PERIOD_SORT)</span>
<span class="fc" id="L286">      .setDescription(format(&quot;Sort measures by leak period or not ?. The '%s' parameter must contain the '%s' value.&quot;, Param.SORT,</span>
        METRIC_PERIOD_SORT))
<span class="fc" id="L288">      .setSince(&quot;5.5&quot;)</span>
<span class="fc" id="L289">      .setPossibleValues(1);</span>

<span class="fc" id="L291">    action.createParam(PARAM_METRIC_SORT_FILTER)</span>
<span class="fc" id="L292">      .setDescription(format(&quot;Filter components. Sort must be on a metric. Possible values are: &quot; +</span>
        &quot;&lt;ul&gt;&quot; +
        &quot;&lt;li&gt;%s: return all components&lt;/li&gt;&quot; +
        &quot;&lt;li&gt;%s: filter out components that do not have a measure on the sorted metric&lt;/li&gt;&quot; +
        &quot;&lt;/ul&gt;&quot;, ALL_METRIC_SORT_FILTER, WITH_MEASURES_ONLY_METRIC_SORT_FILTER))
<span class="fc" id="L297">      .setDefaultValue(ALL_METRIC_SORT_FILTER)</span>
<span class="fc" id="L298">      .setPossibleValues(METRIC_SORT_FILTERS);</span>

<span class="fc" id="L300">    createMetricKeysParameter(action)</span>
<span class="fc" id="L301">      .setDescription(&quot;Comma-separated list of metric keys. Types %s are not allowed. For type %s only %s metrics are supported&quot;,</span>
<span class="fc" id="L302">        join(COMMA_JOIN_SEPARATOR, UnsupportedMetrics.FORBIDDEN_METRIC_TYPES),</span>
<span class="fc" id="L303">        DATA.name(),</span>
<span class="fc" id="L304">        join(COMMA_JOIN_SEPARATOR, UnsupportedMetrics.PARTIALLY_SUPPORTED_METRICS.get(DATA.name())))</span>
<span class="fc" id="L305">      .setMaxValuesAllowed(MAX_METRIC_KEYS);</span>
<span class="fc" id="L306">    createAdditionalFieldsParameter(action);</span>
<span class="fc" id="L307">    createQualifiersParameter(action, newQualifierParameterContext(i18n, componentTypes));</span>

<span class="fc" id="L309">    action.createParam(PARAM_STRATEGY)</span>
<span class="fc" id="L310">      .setDescription(&quot;Strategy to search for base component descendants:&quot; +</span>
        &quot;&lt;ul&gt;&quot; +
        &quot;&lt;li&gt;children: return the children components of the base component. Grandchildren components are not returned&lt;/li&gt;&quot; +
        &quot;&lt;li&gt;all: return all the descendants components of the base component. Grandchildren are returned.&lt;/li&gt;&quot; +
        &quot;&lt;li&gt;leaves: return all the descendant components (files, in general) which don't have other children. They are the leaves of the&quot; +
        &quot; component tree.&lt;/li&gt;&quot; +
        &quot;&lt;/ul&gt;&quot;)
<span class="fc" id="L317">      .setPossibleValues(STRATEGIES.keySet())</span>
<span class="fc" id="L318">      .setDefaultValue(ALL_STRATEGY);</span>
<span class="fc" id="L319">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L323">    ComponentTreeWsResponse componentTreeWsResponse = doHandle(toComponentTreeWsRequest(request));</span>
<span class="fc" id="L324">    writeProtobuf(componentTreeWsResponse, request, response);</span>
<span class="fc" id="L325">  }</span>

  private ComponentTreeWsResponse doHandle(ComponentTreeRequest request) {
<span class="fc" id="L328">    ComponentTreeData data = load(request);</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">    if (data.getComponents() == null) {</span>
<span class="fc" id="L330">      return emptyResponse(data.getBaseComponent(), data.getBranch(), request);</span>
    }

<span class="fc" id="L333">    return buildResponse(</span>
      request,
      data,
<span class="fc" id="L336">      Paging.forPageIndex(</span>
<span class="fc" id="L337">        request.getPage())</span>
<span class="fc" id="L338">        .withPageSize(request.getPageSize())</span>
<span class="fc" id="L339">        .andTotal(data.getComponentCount()),</span>
<span class="fc" id="L340">      request.getMetricKeys());</span>
  }

  private static ComponentTreeWsResponse buildResponse(ComponentTreeRequest request, ComponentTreeData data, Paging paging,
    List&lt;String&gt; requestedMetrics) {
<span class="fc" id="L345">    ComponentTreeWsResponse.Builder response = ComponentTreeWsResponse.newBuilder();</span>
<span class="fc" id="L346">    response.getPagingBuilder()</span>
<span class="fc" id="L347">      .setPageIndex(paging.pageIndex())</span>
<span class="fc" id="L348">      .setPageSize(paging.pageSize())</span>
<span class="fc" id="L349">      .setTotal(paging.total())</span>
<span class="fc" id="L350">      .build();</span>

<span class="fc bfc" id="L352" title="All 4 branches covered.">    boolean isMainBranch = data.getBranch() == null || data.getBranch().isMain();</span>
<span class="fc" id="L353">    response.setBaseComponent(</span>
<span class="fc" id="L354">      toWsComponent(</span>
<span class="fc" id="L355">        data.getBaseComponent(),</span>
<span class="fc" id="L356">        data.getMeasuresByComponentUuidAndMetric().row(data.getBaseComponent().uuid()),</span>
<span class="fc bfc" id="L357" title="All 2 branches covered.">        data.getReferenceComponentsByUuid(), isMainBranch ? null : request.getBranch(), request.getPullRequest(), requestedMetrics));</span>

<span class="fc bfc" id="L359" title="All 2 branches covered.">    for (ComponentDto componentDto : data.getComponents()) {</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">      if (componentDto.getCopyComponentUuid() != null) {</span>
<span class="fc" id="L361">        String refBranch = data.getBranchByReferenceUuid().get(componentDto.getCopyComponentUuid());</span>
<span class="fc" id="L362">        response.addComponents(toWsComponent(</span>
          componentDto,
<span class="fc" id="L364">          data.getMeasuresByComponentUuidAndMetric().row(componentDto.uuid()),</span>
<span class="fc" id="L365">          data.getReferenceComponentsByUuid(), refBranch, null, requestedMetrics));</span>
<span class="fc" id="L366">      } else {</span>
<span class="fc" id="L367">        response.addComponents(toWsComponent(</span>
          componentDto,
<span class="fc" id="L369">          data.getMeasuresByComponentUuidAndMetric().row(componentDto.uuid()),</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">          data.getReferenceComponentsByUuid(), isMainBranch ? null : request.getBranch(), request.getPullRequest(), requestedMetrics));</span>
      }
<span class="fc" id="L372">    }</span>

<span class="fc bfc" id="L374" title="All 2 branches covered.">    if (areMetricsInResponse(request)) {</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">      for (MetricDto metricDto : data.getMetrics()) {</span>
<span class="fc" id="L376">        addMetricToResponseIncludingRenamedMetric(metric -&gt; response.getMetricsBuilder().addMetrics(metric), requestedMetrics, metricDto);</span>
<span class="fc" id="L377">      }</span>
    }

<span class="fc" id="L380">    List&lt;String&gt; additionalFields = ofNullable(request.getAdditionalFields()).orElse(Collections.emptyList());</span>

<span class="fc bfc" id="L382" title="All 4 branches covered.">    if (additionalFields.contains(ADDITIONAL_PERIOD) &amp;&amp; data.getPeriod() != null) {</span>
<span class="fc" id="L383">      response.setPeriod(data.getPeriod());</span>
    }

<span class="fc" id="L386">    return response.build();</span>
  }

  private static boolean areMetricsInResponse(ComponentTreeRequest request) {
<span class="fc" id="L390">    List&lt;String&gt; additionalFields = request.getAdditionalFields();</span>
<span class="fc bfc" id="L391" title="All 4 branches covered.">    return additionalFields != null &amp;&amp; additionalFields.contains(ADDITIONAL_METRICS);</span>
  }

  private static ComponentTreeWsResponse emptyResponse(@Nullable ComponentDto baseComponent, @Nullable BranchDto branch,
    ComponentTreeRequest request) {
<span class="fc" id="L396">    ComponentTreeWsResponse.Builder response = ComponentTreeWsResponse.newBuilder();</span>
<span class="fc" id="L397">    response.getPagingBuilder()</span>
<span class="fc" id="L398">      .setPageIndex(request.getPage())</span>
<span class="fc" id="L399">      .setPageSize(request.getPageSize())</span>
<span class="fc" id="L400">      .setTotal(0);</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">    if (baseComponent != null) {</span>
<span class="pc bpc" id="L402" title="1 of 4 branches missed.">      boolean isMainBranch = branch == null || branch.isMain();</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">      response.setBaseComponent(componentDtoToWsComponent(baseComponent, isMainBranch ? null : request.getBranch(),</span>
<span class="fc" id="L404">        request.getPullRequest()));</span>
    }
<span class="fc" id="L406">    return response.build();</span>
  }

  private static ComponentTreeRequest toComponentTreeWsRequest(Request request) {
<span class="fc" id="L410">    List&lt;String&gt; metricKeys = request.mandatoryParamAsStrings(PARAM_METRIC_KEYS);</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">    checkArgument(metricKeys.size() &lt;= MAX_METRIC_KEYS, &quot;Number of metrics keys is limited to %s, got %s&quot;, MAX_METRIC_KEYS,</span>
<span class="fc" id="L412">      metricKeys.size());</span>
<span class="fc" id="L413">    ComponentTreeRequest componentTreeRequest = new ComponentTreeRequest()</span>
<span class="fc" id="L414">      .setComponent(request.mandatoryParam(PARAM_COMPONENT))</span>
<span class="fc" id="L415">      .setBranch(request.param(PARAM_BRANCH))</span>
<span class="fc" id="L416">      .setPullRequest(request.param(PARAM_PULL_REQUEST))</span>
<span class="fc" id="L417">      .setMetricKeys(metricKeys)</span>
<span class="fc" id="L418">      .setStrategy(request.mandatoryParam(PARAM_STRATEGY))</span>
<span class="fc" id="L419">      .setQualifiers(request.paramAsStrings(PARAM_QUALIFIERS))</span>
<span class="fc" id="L420">      .setAdditionalFields(request.paramAsStrings(PARAM_ADDITIONAL_FIELDS))</span>
<span class="fc" id="L421">      .setSort(request.paramAsStrings(Param.SORT))</span>
<span class="fc" id="L422">      .setAsc(request.paramAsBoolean(Param.ASCENDING))</span>
<span class="fc" id="L423">      .setMetricSort(includeRenamedMetrics(request.param(PARAM_METRIC_SORT)))</span>
<span class="fc" id="L424">      .setMetricSortFilter(request.mandatoryParam(PARAM_METRIC_SORT_FILTER))</span>
<span class="fc" id="L425">      .setMetricPeriodSort(request.paramAsInt(PARAM_METRIC_PERIOD_SORT))</span>
<span class="fc" id="L426">      .setPage(request.mandatoryParamAsInt(Param.PAGE))</span>
<span class="fc" id="L427">      .setPageSize(request.mandatoryParamAsInt(Param.PAGE_SIZE))</span>
<span class="fc" id="L428">      .setQuery(request.param(Param.TEXT_QUERY));</span>
<span class="fc" id="L429">    String metricSortValue = componentTreeRequest.getMetricSort();</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">    checkRequest(!componentTreeRequest.getMetricKeys().isEmpty(), &quot;The '%s' parameter must contain at least one metric key&quot;,</span>
      PARAM_METRIC_KEYS);
<span class="fc" id="L432">    List&lt;String&gt; sorts = ofNullable(componentTreeRequest.getSort()).orElse(emptyList());</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">    checkRequest(metricSortValue == null ^ sorts.contains(METRIC_SORT) ^ sorts.contains(METRIC_PERIOD_SORT),</span>
      &quot;To sort by a metric, the '%s' parameter must contain '%s' or '%s', and a metric key must be provided in the '%s' parameter&quot;,
      Param.SORT, METRIC_SORT, METRIC_PERIOD_SORT, PARAM_METRIC_SORT);
<span class="fc bfc" id="L436" title="All 2 branches covered.">    checkRequest(metricSortValue == null ^ componentTreeRequest.getMetricKeys().contains(metricSortValue),</span>
      &quot;To sort by the '%s' metric, it must be in the list of metric keys in the '%s' parameter&quot;, metricSortValue, PARAM_METRIC_KEYS);
<span class="fc bfc" id="L438" title="All 2 branches covered.">    checkRequest(componentTreeRequest.getMetricPeriodSort() == null ^ sorts.contains(METRIC_PERIOD_SORT),</span>
      &quot;To sort by a metric period, the '%s' parameter must contain '%s' and the '%s' must be provided.&quot;, Param.SORT, METRIC_PERIOD_SORT,
      PARAM_METRIC_PERIOD_SORT);
<span class="fc bfc" id="L441" title="All 4 branches covered.">    checkRequest(ALL_METRIC_SORT_FILTER.equals(componentTreeRequest.getMetricSortFilter()) || metricSortValue != null,</span>
      &quot;To filter components based on the sort metric, the '%s' parameter must contain '%s' or '%s' and the '%s' parameter must be provided&quot;,
      Param.SORT, METRIC_SORT, METRIC_PERIOD_SORT, PARAM_METRIC_SORT);
<span class="fc" id="L444">    return componentTreeRequest;</span>
  }

  private static Measures.Component.Builder toWsComponent(ComponentDto component, Map&lt;MetricDto, ComponentTreeData.Measure&gt; measures,
    Map&lt;String, ComponentDto&gt; referenceComponentsByUuid, @Nullable String branch, @Nullable String pullRequest,
    List&lt;String&gt; requestedMetrics) {
<span class="fc" id="L450">    Measures.Component.Builder wsComponent = componentDtoToWsComponent(component, branch, pullRequest);</span>
<span class="fc" id="L451">    ComponentDto referenceComponent = referenceComponentsByUuid.get(component.getCopyComponentUuid());</span>
<span class="fc bfc" id="L452" title="All 2 branches covered.">    if (referenceComponent != null) {</span>
<span class="fc" id="L453">      wsComponent.setRefKey(referenceComponent.getKey());</span>
<span class="fc" id="L454">      String displayQualifier = getDisplayQualifier(component, referenceComponent);</span>
<span class="fc" id="L455">      wsComponent.setQualifier(displayQualifier);</span>
    }
<span class="fc" id="L457">    Measures.Measure.Builder measureBuilder = Measures.Measure.newBuilder();</span>
<span class="fc bfc" id="L458" title="All 2 branches covered.">    for (Map.Entry&lt;MetricDto, ComponentTreeData.Measure&gt; entry : measures.entrySet()) {</span>
<span class="fc" id="L459">      ComponentTreeData.Measure measure = entry.getValue();</span>
<span class="fc" id="L460">      boolean onNewCode = entry.getKey().getKey().startsWith(&quot;new_&quot;);</span>
<span class="fc" id="L461">      updateMeasureBuilder(measureBuilder, entry.getKey(), measure.getValue(), measure.getData(), onNewCode);</span>
<span class="fc" id="L462">      addMeasureIncludingRenamedMetric(requestedMetrics, wsComponent, measureBuilder);</span>
<span class="fc" id="L463">      measureBuilder.clear();</span>
<span class="fc" id="L464">    }</span>
<span class="fc" id="L465">    return wsComponent;</span>
  }

  // https://jira.sonarsource.com/browse/SONAR-13703 - for apps that were added as a local reference to a portfolio, we want to
  // show them as apps, not sub-portfolios
  private static String getDisplayQualifier(ComponentDto component, ComponentDto referenceComponent) {
<span class="fc" id="L471">    String qualifier = component.qualifier();</span>
<span class="fc bfc" id="L472" title="All 4 branches covered.">    if (qualifier.equals(ComponentQualifiers.SUBVIEW) &amp;&amp; referenceComponent.qualifier().equals(ComponentQualifiers.APP)) {</span>
<span class="fc" id="L473">      return ComponentQualifiers.APP;</span>
    }
<span class="fc" id="L475">    return qualifier;</span>
  }

  private ComponentTreeData load(ComponentTreeRequest wsRequest) {
<span class="fc" id="L479">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L480">      ComponentDto baseComponent = loadComponent(dbSession, wsRequest);</span>
<span class="fc" id="L481">      checkPermissions(baseComponent);</span>
      // portfolios don't have branches
<span class="fc" id="L483">      BranchDto branchDto = dbClient.branchDao().selectByUuid(dbSession, baseComponent.branchUuid()).orElse(null);</span>

<span class="fc" id="L485">      Optional&lt;SnapshotDto&gt; baseSnapshot = dbClient.snapshotDao().selectLastAnalysisByRootComponentUuid(dbSession,</span>
<span class="fc" id="L486">        baseComponent.branchUuid());</span>
<span class="fc bfc" id="L487" title="All 2 branches covered.">      if (baseSnapshot.isEmpty()) {</span>
<span class="fc" id="L488">        return ComponentTreeData.builder()</span>
<span class="fc" id="L489">          .setBranch(branchDto)</span>
<span class="fc" id="L490">          .setBaseComponent(baseComponent)</span>
<span class="fc" id="L491">          .build();</span>
      }

<span class="fc" id="L494">      ComponentTreeQuery componentTreeQuery = toComponentTreeQuery(wsRequest, baseComponent);</span>
<span class="fc" id="L495">      List&lt;ComponentDto&gt; components = searchComponents(dbSession, componentTreeQuery);</span>

<span class="fc" id="L497">      List&lt;MetricDto&gt; metrics = searchMetrics(dbSession,</span>
<span class="fc" id="L498">        new HashSet&lt;&gt;(withRemovedMetricAlias(ofNullable(wsRequest.getMetricKeys()).orElse(List.of()))));</span>
<span class="fc" id="L499">      Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; measuresByComponentUuidAndMetric = searchMeasuresByComponentUuidAndMetric(dbSession, baseComponent, componentTreeQuery,</span>
        components, metrics);

<span class="fc" id="L502">      components = filterComponents(components, measuresByComponentUuidAndMetric, metrics, wsRequest);</span>
<span class="fc" id="L503">      components = filterAuthorizedComponents(components);</span>
<span class="fc" id="L504">      components = sortComponents(components, wsRequest, metrics, measuresByComponentUuidAndMetric);</span>

<span class="fc" id="L506">      int componentCount = components.size();</span>
<span class="fc" id="L507">      components = paginateComponents(components, wsRequest);</span>

<span class="fc" id="L509">      Map&lt;String, ComponentDto&gt; referencesByUuid = searchReferenceComponentsById(dbSession, components);</span>
<span class="fc" id="L510">      Map&lt;String, String&gt; branchByReferenceUuid = searchReferenceBranchKeys(dbSession, referencesByUuid.keySet());</span>

<span class="fc" id="L512">      return ComponentTreeData.builder()</span>
<span class="fc" id="L513">        .setBaseComponent(baseComponent)</span>
<span class="fc" id="L514">        .setBranch(branchDto)</span>
<span class="fc" id="L515">        .setComponentsFromDb(components)</span>
<span class="fc" id="L516">        .setComponentCount(componentCount)</span>
<span class="fc" id="L517">        .setBranchByReferenceUuid(branchByReferenceUuid)</span>
<span class="fc" id="L518">        .setMeasuresByComponentUuidAndMetric(measuresByComponentUuidAndMetric)</span>
<span class="fc" id="L519">        .setMetrics(metrics)</span>
<span class="fc" id="L520">        .setPeriod(snapshotToWsPeriods(baseSnapshot.get()).orElse(null))</span>
<span class="fc" id="L521">        .setReferenceComponentsByUuid(referencesByUuid)</span>
<span class="fc" id="L522">        .build();</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">    }</span>
  }

  private Map&lt;String, String&gt; searchReferenceBranchKeys(DbSession dbSession, Set&lt;String&gt; referenceUuids) {
<span class="fc" id="L527">    return dbClient.branchDao().selectByUuids(dbSession, referenceUuids).stream()</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">      .filter(b -&gt; !b.isMain())</span>
<span class="fc" id="L529">      .collect(Collectors.toMap(BranchDto::getUuid, BranchDto::getBranchKey));</span>
  }

  private ComponentDto loadComponent(DbSession dbSession, ComponentTreeRequest request) {
<span class="fc" id="L533">    String componentKey = request.getComponent();</span>
<span class="fc" id="L534">    String branch = request.getBranch();</span>
<span class="fc" id="L535">    String pullRequest = request.getPullRequest();</span>
<span class="fc" id="L536">    return componentFinder.getByKeyAndOptionalBranchOrPullRequest(dbSession, componentKey, branch, pullRequest);</span>
  }

  private Map&lt;String, ComponentDto&gt; searchReferenceComponentsById(DbSession dbSession, List&lt;ComponentDto&gt; components) {
<span class="fc" id="L540">    List&lt;String&gt; referenceComponentUUids = components.stream()</span>
<span class="fc" id="L541">      .map(ComponentDto::getCopyComponentUuid)</span>
<span class="fc" id="L542">      .filter(Objects::nonNull)</span>
<span class="fc" id="L543">      .toList();</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">    if (referenceComponentUUids.isEmpty()) {</span>
<span class="fc" id="L545">      return emptyMap();</span>
    }

<span class="fc" id="L548">    return FluentIterable.from(dbClient.componentDao().selectByUuids(dbSession, referenceComponentUUids))</span>
<span class="fc" id="L549">      .uniqueIndex(ComponentDto::uuid);</span>
  }

  private List&lt;ComponentDto&gt; searchComponents(DbSession dbSession, ComponentTreeQuery componentTreeQuery) {
<span class="fc" id="L553">    Collection&lt;String&gt; qualifiers = componentTreeQuery.getQualifiers();</span>
<span class="fc bfc" id="L554" title="All 4 branches covered.">    if (qualifiers != null &amp;&amp; qualifiers.isEmpty()) {</span>
<span class="fc" id="L555">      return Collections.emptyList();</span>
    }
<span class="fc" id="L557">    return dbClient.componentDao().selectDescendants(dbSession, componentTreeQuery);</span>
  }

  private List&lt;MetricDto&gt; searchMetrics(DbSession dbSession, Set&lt;String&gt; metricKeys) {
<span class="fc" id="L561">    List&lt;MetricDto&gt; metrics = dbClient.metricDao().selectByKeys(dbSession, metricKeys);</span>
<span class="pc bpc" id="L562" title="1 of 4 branches missed.">    if (metrics.size() &lt; metricKeys.stream().filter(key -&gt; !key.equals(&quot;contains_ai_code&quot;)).count()) {</span>
<span class="fc" id="L563">      List&lt;String&gt; foundMetricKeys = Lists.transform(metrics, MetricDto::getKey);</span>
<span class="fc" id="L564">      Set&lt;String&gt; missingMetricKeys = Sets.difference(</span>
        new LinkedHashSet&lt;&gt;(metricKeys),
        new LinkedHashSet&lt;&gt;(foundMetricKeys));

<span class="fc" id="L568">      throw new NotFoundException(format(&quot;The following metric keys are not found: %s&quot;, join(COMMA_JOIN_SEPARATOR,</span>
        missingMetricKeys)));
    }
<span class="fc" id="L571">    String forbiddenMetrics = metrics.stream()</span>
<span class="fc" id="L572">      .filter(UnsupportedMetrics.INSTANCE)</span>
<span class="fc" id="L573">      .map(MetricDto::getKey)</span>
<span class="fc" id="L574">      .sorted()</span>
<span class="fc" id="L575">      .collect(Collectors.joining(COMMA_JOIN_SEPARATOR));</span>
<span class="fc" id="L576">    checkArgument(forbiddenMetrics.isEmpty(), &quot;Metrics %s can't be requested in this web service. Please use api/measures/component&quot;,</span>
      forbiddenMetrics);
<span class="fc" id="L578">    return metrics;</span>
  }

  private Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; searchMeasuresByComponentUuidAndMetric(DbSession dbSession,
    ComponentDto baseComponent,
    ComponentTreeQuery componentTreeQuery, List&lt;ComponentDto&gt; components, List&lt;MetricDto&gt; metrics) {

<span class="fc" id="L585">    Map&lt;String, MetricDto&gt; metricsByKeys = Maps.uniqueIndex(metrics, MetricDto::getKey);</span>
<span class="fc" id="L586">    MeasureTreeQuery measureQuery = MeasureTreeQuery.builder()</span>
<span class="fc" id="L587">      .setStrategy(MeasureTreeQuery.Strategy.valueOf(componentTreeQuery.getStrategy().name()))</span>
<span class="fc" id="L588">      .setNameOrKeyQuery(componentTreeQuery.getNameOrKeyQuery())</span>
<span class="fc" id="L589">      .setQualifiers(componentTreeQuery.getQualifiers())</span>
<span class="fc" id="L590">      .build();</span>

<span class="fc" id="L592">    Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; measuresByComponentUuidAndMetric = HashBasedTable.create(components.size(),</span>
<span class="fc" id="L593">      metrics.size());</span>
<span class="fc" id="L594">    dbClient.measureDao().selectTreeByQuery(dbSession, baseComponent, measureQuery, result -&gt; {</span>
<span class="fc" id="L595">      MeasureDto measureDto = result.getResultObject();</span>
<span class="fc" id="L596">      measureDto.getMetricValues().forEach((metricKey, value) -&gt; {</span>
<span class="fc" id="L597">        MetricDto metric = metricsByKeys.get(metricKey);</span>
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">        if (metric != null) {</span>
<span class="fc" id="L599">          measuresByComponentUuidAndMetric.put(</span>
<span class="fc" id="L600">            measureDto.getComponentUuid(),</span>
            metric,
<span class="fc" id="L602">            ComponentTreeData.Measure.createFromMetricValue(metric, value));</span>
        }
<span class="fc" id="L604">      });</span>
<span class="fc" id="L605">    });</span>

<span class="fc" id="L607">    Set&lt;MetricDto&gt; baseComponentMetricDtos = measuresByComponentUuidAndMetric.row(baseComponent.uuid()).keySet();</span>

<span class="fc" id="L609">    addBestValuesToMeasures(measuresByComponentUuidAndMetric, components, baseComponentMetricDtos, metrics);</span>

<span class="fc" id="L611">    return measuresByComponentUuidAndMetric;</span>
  }

  /**
   * Conditions for best value measure:
   * &lt;ul&gt;
   * &lt;li&gt;component is a production file or test file&lt;/li&gt;
   * &lt;li&gt;metric is optimized for best value&lt;/li&gt;
   * &lt;/ul&gt;
   */
  private static void addBestValuesToMeasures(Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; measuresByComponentUuidAndMetric,
    List&lt;ComponentDto&gt; components,
    Set&lt;MetricDto&gt; baseComponentMetricDtos,
    List&lt;MetricDto&gt; metrics) {
<span class="fc" id="L625">    List&lt;MetricDtoWithBestValue&gt; metricDtosWithBestValueMeasure = metrics.stream()</span>
<span class="fc" id="L626">      .filter(baseComponentMetricDtos::contains)</span>
<span class="fc" id="L627">      .filter(MetricDtoFunctions.isOptimizedForBestValue())</span>
<span class="fc" id="L628">      .map(new MetricDtoToMetricDtoWithBestValue())</span>
<span class="fc" id="L629">      .toList();</span>
<span class="fc bfc" id="L630" title="All 2 branches covered.">    if (metricDtosWithBestValueMeasure.isEmpty()) {</span>
<span class="fc" id="L631">      return;</span>
    }

<span class="fc" id="L634">    Stream&lt;ComponentDto&gt; componentsEligibleForBestValue = components.stream().filter(ComponentTreeAction::isFileComponent);</span>
<span class="fc" id="L635">    componentsEligibleForBestValue.forEach(component -&gt; {</span>
<span class="fc bfc" id="L636" title="All 2 branches covered.">      for (MetricDtoWithBestValue metricWithBestValue : metricDtosWithBestValueMeasure) {</span>
<span class="fc bfc" id="L637" title="All 2 branches covered.">        if (measuresByComponentUuidAndMetric.get(component.uuid(), metricWithBestValue.getMetric()) == null) {</span>
<span class="fc" id="L638">          measuresByComponentUuidAndMetric.put(component.uuid(), metricWithBestValue.getMetric(),</span>
<span class="fc" id="L639">            ComponentTreeData.Measure.createFromMetricValue(metricWithBestValue.getMetric(), metricWithBestValue.getBestValue()));</span>
        }
<span class="fc" id="L641">      }</span>
<span class="fc" id="L642">    });</span>
<span class="fc" id="L643">  }</span>

  private static List&lt;ComponentDto&gt; filterComponents(List&lt;ComponentDto&gt; components,
    Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; measuresByComponentUuidAndMetric, List&lt;MetricDto&gt; metrics,
    ComponentTreeRequest wsRequest) {
<span class="fc bfc" id="L648" title="All 2 branches covered.">    if (!componentWithMeasuresOnly(wsRequest)) {</span>
<span class="fc" id="L649">      return components;</span>
    }

<span class="fc" id="L652">    String metricKeyToSort = wsRequest.getMetricSort();</span>
<span class="fc" id="L653">    Optional&lt;MetricDto&gt; metricToSort = metrics.stream().filter(m -&gt; metricKeyToSort.equals(m.getKey())).findFirst();</span>
<span class="fc" id="L654">    checkState(metricToSort.isPresent(), &quot;Metric '%s' not found&quot;, metricKeyToSort, wsRequest.getMetricKeys());</span>

<span class="fc" id="L656">    return components</span>
<span class="fc" id="L657">      .stream()</span>
<span class="fc" id="L658">      .filter(new HasMeasure(measuresByComponentUuidAndMetric, metricToSort.get()))</span>
<span class="fc" id="L659">      .toList();</span>
  }

  private List&lt;ComponentDto&gt; filterAuthorizedComponents(List&lt;ComponentDto&gt; components) {
<span class="fc" id="L663">    return userSession.keepAuthorizedComponents(ProjectPermission.USER, components);</span>
  }

  private static boolean componentWithMeasuresOnly(ComponentTreeRequest wsRequest) {
<span class="fc" id="L667">    return WITH_MEASURES_ONLY_METRIC_SORT_FILTER.equals(wsRequest.getMetricSortFilter());</span>
  }

  private static List&lt;ComponentDto&gt; sortComponents(List&lt;ComponentDto&gt; components, ComponentTreeRequest wsRequest, List&lt;MetricDto&gt; metrics,
    Table&lt;String, MetricDto, ComponentTreeData.Measure&gt; measuresByComponentUuidAndMetric) {
<span class="fc" id="L672">    return ComponentTreeSort.sortComponents(components, wsRequest, metrics, measuresByComponentUuidAndMetric);</span>
  }

  private static List&lt;ComponentDto&gt; paginateComponents(List&lt;ComponentDto&gt; components, ComponentTreeRequest wsRequest) {
<span class="fc" id="L676">    return components.stream()</span>
<span class="fc" id="L677">      .skip(offset(wsRequest.getPage(), wsRequest.getPageSize()))</span>
<span class="fc" id="L678">      .limit(wsRequest.getPageSize())</span>
<span class="fc" id="L679">      .toList();</span>
  }

  @CheckForNull
  private List&lt;String&gt; childrenQualifiers(ComponentTreeRequest request, String baseQualifier) {
<span class="fc" id="L684">    List&lt;String&gt; requestQualifiers = request.getQualifiers();</span>
<span class="fc" id="L685">    List&lt;String&gt; childrenQualifiers = null;</span>
<span class="fc bfc" id="L686" title="All 2 branches covered.">    if (LEAVES_STRATEGY.equals(request.getStrategy())) {</span>
<span class="fc" id="L687">      childrenQualifiers = componentTypes.getLeavesQualifiers(baseQualifier);</span>
    }

<span class="fc bfc" id="L690" title="All 2 branches covered.">    if (requestQualifiers == null) {</span>
<span class="fc" id="L691">      return childrenQualifiers;</span>
    }

<span class="pc bpc" id="L694" title="1 of 2 branches missed.">    if (childrenQualifiers == null) {</span>
<span class="nc" id="L695">      return requestQualifiers;</span>
    }

<span class="fc" id="L698">    Sets.SetView&lt;String&gt; qualifiersIntersection = Sets.intersection(new HashSet&lt;&gt;(childrenQualifiers),</span>
      new HashSet&lt;Object&gt;(requestQualifiers));

<span class="fc" id="L701">    return new ArrayList&lt;&gt;(qualifiersIntersection);</span>
  }

  private ComponentTreeQuery toComponentTreeQuery(ComponentTreeRequest wsRequest, ComponentDto baseComponent) {
<span class="fc" id="L705">    List&lt;String&gt; childrenQualifiers = childrenQualifiers(wsRequest, baseComponent.qualifier());</span>

<span class="fc" id="L707">    ComponentTreeQuery.Builder componentTreeQueryBuilder = ComponentTreeQuery.builder()</span>
<span class="fc" id="L708">      .setBaseUuid(baseComponent.uuid())</span>
<span class="fc" id="L709">      .setStrategy(STRATEGIES.get(wsRequest.getStrategy()));</span>

<span class="pc bpc" id="L711" title="1 of 2 branches missed.">    if (wsRequest.getQuery() != null) {</span>
<span class="nc" id="L712">      componentTreeQueryBuilder.setNameOrKeyQuery(wsRequest.getQuery());</span>
    }
<span class="fc bfc" id="L714" title="All 2 branches covered.">    if (childrenQualifiers != null) {</span>
<span class="fc" id="L715">      componentTreeQueryBuilder.setQualifiers(childrenQualifiers);</span>
    }
<span class="fc" id="L717">    return componentTreeQueryBuilder.build();</span>
  }

  private void checkPermissions(ComponentDto baseComponent) {
<span class="fc" id="L721">    userSession.checkComponentPermission(ProjectPermission.USER, baseComponent);</span>

<span class="fc bfc" id="L723" title="All 4 branches covered.">    if (ComponentScopes.PROJECT.equals(baseComponent.scope()) &amp;&amp; ComponentQualifiers.APP.equals(baseComponent.qualifier())) {</span>
<span class="fc" id="L724">      userSession.checkChildProjectsPermission(ProjectPermission.USER, baseComponent);</span>
    }
<span class="fc" id="L726">  }</span>

  public static boolean isFileComponent(@Nonnull ComponentDto input) {
<span class="fc" id="L729">    return QUALIFIERS_ELIGIBLE_FOR_BEST_VALUE.contains(input.qualifier());</span>
  }

  private static class MetricDtoToMetricDtoWithBestValue implements Function&lt;MetricDto, MetricDtoWithBestValue&gt; {
    @Override
    public MetricDtoWithBestValue apply(@Nonnull MetricDto input) {
<span class="fc" id="L735">      return new MetricDtoWithBestValue(input);</span>
    }
  }

<span class="fc" id="L739">  private enum UnsupportedMetrics implements Predicate&lt;MetricDto&gt; {</span>
<span class="fc" id="L740">    INSTANCE;</span>

<span class="fc" id="L742">    static final Set&lt;String&gt; FORBIDDEN_METRIC_TYPES = Set.of(DISTRIB.name());</span>
<span class="fc" id="L743">    static final Map&lt;String, Set&lt;String&gt;&gt; PARTIALLY_SUPPORTED_METRICS = Map.of(</span>
<span class="fc" id="L744">      DATA.name(),</span>
      DataSupportedMetrics.IMPACTS_SUPPORTED_METRICS);

    @Override
    public boolean test(@Nonnull MetricDto input) {
<span class="fc bfc" id="L749" title="All 2 branches covered.">      if (FORBIDDEN_METRIC_TYPES.contains(input.getValueType())) {</span>
<span class="fc" id="L750">        return true;</span>
      }
<span class="fc" id="L752">      Set&lt;String&gt; partialSupport = PARTIALLY_SUPPORTED_METRICS.get(input.getValueType());</span>
<span class="fc bfc" id="L753" title="All 2 branches covered.">      if (partialSupport == null) {</span>
<span class="fc" id="L754">        return false;</span>
      } else {
<span class="fc bfc" id="L756" title="All 2 branches covered.">        return !partialSupport.contains(input.getKey());</span>
      }
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>