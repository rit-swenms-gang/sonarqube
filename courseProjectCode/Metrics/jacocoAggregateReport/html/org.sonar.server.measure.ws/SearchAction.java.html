<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.measure.ws</a> &gt; <span class="el_source">SearchAction.java</span></div><h1>SearchAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.measure.ws;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.db.permission.ProjectPermission;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.measure.MeasureDto;
import org.sonar.db.metric.MetricDto;
import org.sonar.db.metric.RemovedMetricConverter;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Measures.Measure;
import org.sonarqube.ws.Measures.SearchWsResponse;

import static com.google.common.base.Preconditions.checkArgument;
import static java.lang.String.format;
import static java.util.Comparator.comparing;
import static java.util.function.Function.identity;
import static java.util.stream.Collectors.toMap;
import static org.sonar.db.component.ComponentQualifiers.APP;
import static org.sonar.db.component.ComponentQualifiers.PROJECT;
import static org.sonar.db.component.ComponentQualifiers.SUBVIEW;
import static org.sonar.db.component.ComponentQualifiers.VIEW;
import static org.sonar.db.metric.RemovedMetricConverter.DEPRECATED_METRIC_REPLACEMENT;
import static org.sonar.db.metric.RemovedMetricConverter.REMOVED_METRIC;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_METRIC_KEYS;
import static org.sonar.server.component.ws.MeasuresWsParameters.PARAM_PROJECT_KEYS;
import static org.sonar.server.exceptions.BadRequestException.checkRequest;
import static org.sonar.server.measure.ws.MeasureDtoToWsMeasure.updateMeasureBuilder;
import static org.sonar.server.measure.ws.MeasuresWsParametersBuilder.createMetricKeysParameter;
import static org.sonar.server.ws.KeyExamples.KEY_PROJECT_EXAMPLE_001;
import static org.sonar.server.ws.KeyExamples.KEY_PROJECT_EXAMPLE_002;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

public class SearchAction implements MeasuresWsAction {

  private static final int MAX_NB_PROJECTS = 100;
<span class="fc" id="L68">  private static final List&lt;String&gt; ALLOWED_QUALIFIERS = List.of(PROJECT, APP, VIEW, SUBVIEW);</span>

  private final UserSession userSession;
  private final DbClient dbClient;

<span class="fc" id="L73">  public SearchAction(UserSession userSession, DbClient dbClient) {</span>
<span class="fc" id="L74">    this.userSession = userSession;</span>
<span class="fc" id="L75">    this.dbClient = dbClient;</span>
<span class="fc" id="L76">  }</span>

  @Override
  public void define(WebService.NewController context) {
<span class="fc" id="L80">    WebService.NewAction action = context.createAction(&quot;search&quot;)</span>
<span class="fc" id="L81">      .setInternal(true)</span>
<span class="fc" id="L82">      .setDescription(&quot;Search for project measures ordered by project names.&lt;br&gt;&quot; +</span>
        &quot;At most %d projects can be provided.&lt;br&gt;&quot; +
        &quot;Returns the projects with the 'Browse' permission.&quot;,
<span class="fc" id="L85">        MAX_NB_PROJECTS)</span>
<span class="fc" id="L86">      .setSince(&quot;6.2&quot;)</span>
<span class="fc" id="L87">      .setResponseExample(getClass().getResource(&quot;search-example.json&quot;))</span>
<span class="fc" id="L88">      .setHandler(this)</span>
<span class="fc" id="L89">      .setChangelog(</span>
<span class="fc" id="L90">        new Change(&quot;2025.4&quot;, format(</span>
          &quot;The following SCA metrics are available on licensed enterprise/datacenter editions with SCA enabled: %s&quot;,
<span class="fc" id="L92">          MeasuresWsModule.getNewScaMetricsInSonarQube202504())),</span>
<span class="fc" id="L93">        new Change(&quot;10.8&quot;, format(&quot;The following metrics are not deprecated anymore: %s&quot;, MeasuresWsModule.getUndeprecatedMetricsinSonarQube108())),</span>
<span class="fc" id="L94">        new Change(&quot;10.8&quot;, String.format(&quot;Added new accepted values for the 'metricKeys' param: %s&quot;,</span>
<span class="fc" id="L95">          MeasuresWsModule.getNewMetricsInSonarQube108())),</span>
<span class="fc" id="L96">        new Change(&quot;10.8&quot;, String.format(&quot;The metrics %s are now deprecated. Use 'software_quality_maintainability_issues', &quot; +</span>
          &quot;'software_quality_reliability_issues', 'software_quality_security_issues', 'new_software_quality_maintainability_issues', &quot; +
          &quot;'new_software_quality_reliability_issues', 'new_software_quality_security_issues' instead.&quot;,
<span class="fc" id="L99">          MeasuresWsModule.getDeprecatedMetricsInSonarQube108())),</span>
<span class="fc" id="L100">        new Change(&quot;10.7&quot;, &quot;Added new accepted values for the 'metricKeys' param: %s&quot;.formatted(MeasuresWsModule.getNewMetricsInSonarQube107())),</span>
<span class="fc" id="L101">        new Change(&quot;10.5&quot;, String.format(&quot;The metrics %s are now deprecated &quot; +</span>
          &quot;without exact replacement. Use 'maintainability_issues', 'reliability_issues' and 'security_issues' instead.&quot;,
<span class="fc" id="L103">          MeasuresWsModule.getDeprecatedMetricsInSonarQube105())),</span>
        new Change(&quot;10.5&quot;, &quot;Added new accepted values for the 'metricKeys' param: 'new_maintainability_issues', 'new_reliability_issues', 'new_security_issues'&quot;),
<span class="fc" id="L105">        new Change(&quot;10.4&quot;, String.format(&quot;The metrics %s are now deprecated &quot; +</span>
          &quot;without exact replacement. Use 'maintainability_issues', 'reliability_issues' and 'security_issues' instead.&quot;,
<span class="fc" id="L107">          MeasuresWsModule.getDeprecatedMetricsInSonarQube104())),</span>
        new Change(&quot;10.4&quot;, &quot;Added new accepted values for the 'metricKeys' param: 'maintainability_issues', 'reliability_issues', 'security_issues'&quot;),
        new Change(&quot;10.4&quot;, &quot;The metrics 'open_issues', 'reopened_issues' and 'confirmed_issues' are now deprecated in the response. Consume 'violations' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The use of 'open_issues', 'reopened_issues' and 'confirmed_issues' values in 'metricKeys' param are now deprecated. Use 'violations' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The metric 'wont_fix_issues' is now deprecated in the response. Consume 'accepted_issues' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;The use of 'wont_fix_issues' value in 'metricKeys' param is now deprecated. Use 'accepted_issues' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;Added new accepted value for the 'metricKeys' param: 'accepted_issues'.&quot;),
<span class="fc" id="L114">        new Change(&quot;10.0&quot;, format(&quot;The use of the following metrics in 'metricKeys' parameter is not deprecated anymore: %s&quot;,</span>
<span class="fc" id="L115">          MeasuresWsModule.getDeprecatedMetricsInSonarQube93())),</span>
<span class="fc" id="L116">        new Change(&quot;9.3&quot;, format(&quot;The use of the following metrics in 'metricKeys' parameter is deprecated: %s&quot;,</span>
<span class="fc" id="L117">          MeasuresWsModule.getDeprecatedMetricsInSonarQube93())));</span>

<span class="fc" id="L119">    createMetricKeysParameter(action);</span>

<span class="fc" id="L121">    action.createParam(PARAM_PROJECT_KEYS)</span>
<span class="fc" id="L122">      .setDescription(&quot;Comma-separated list of project, view or sub-view keys&quot;)</span>
<span class="fc" id="L123">      .setExampleValue(String.join(&quot;,&quot;, KEY_PROJECT_EXAMPLE_001, KEY_PROJECT_EXAMPLE_002))</span>
<span class="fc" id="L124">      .setRequired(true);</span>
<span class="fc" id="L125">  }</span>

  @Override
  public void handle(Request httpRequest, Response httpResponse) throws Exception {
<span class="fc" id="L129">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L130">      SearchWsResponse response = new ResponseBuilder(httpRequest, dbSession).build();</span>
<span class="fc" id="L131">      writeProtobuf(response, httpRequest, httpResponse);</span>
    }
<span class="fc" id="L133">  }</span>

  private class ResponseBuilder {
    private final DbSession dbSession;
    private final Request httpRequest;
    private SearchRequest request;
    private List&lt;ComponentDto&gt; projects;
    private List&lt;MetricDto&gt; metrics;
    private List&lt;MeasureDto&gt; measures;

<span class="fc" id="L143">    ResponseBuilder(Request httpRequest, DbSession dbSession) {</span>
<span class="fc" id="L144">      this.dbSession = dbSession;</span>
<span class="fc" id="L145">      this.httpRequest = httpRequest;</span>
<span class="fc" id="L146">    }</span>

    SearchWsResponse build() {
<span class="fc" id="L149">      this.request = createRequest();</span>
<span class="fc" id="L150">      this.projects = searchProjects();</span>
<span class="fc" id="L151">      this.metrics = searchMetrics();</span>
<span class="fc" id="L152">      this.measures = searchMeasures();</span>
<span class="fc" id="L153">      return buildResponse();</span>
    }

    private SearchRequest createRequest() {
<span class="fc" id="L157">      request = SearchRequest.builder()</span>
<span class="fc" id="L158">        .setMetricKeys(httpRequest.mandatoryParamAsStrings(PARAM_METRIC_KEYS))</span>
<span class="fc" id="L159">        .setProjectKeys(httpRequest.paramAsStrings(PARAM_PROJECT_KEYS))</span>
<span class="fc" id="L160">        .build();</span>

<span class="fc" id="L162">      return request;</span>
    }

    private List&lt;ComponentDto&gt; searchProjects() {
<span class="fc" id="L166">      List&lt;ComponentDto&gt; componentDtos = searchByProjectKeys(dbSession, request.getProjectKeys());</span>
<span class="fc" id="L167">      checkArgument(ALLOWED_QUALIFIERS.containsAll(componentDtos.stream().map(ComponentDto::qualifier).collect(Collectors.toSet())),</span>
        &quot;Only component of qualifiers %s are allowed&quot;, ALLOWED_QUALIFIERS);
<span class="fc" id="L169">      return getAuthorizedProjects(componentDtos);</span>
    }

    private List&lt;ComponentDto&gt; searchByProjectKeys(DbSession dbSession, List&lt;String&gt; projectKeys) {
<span class="fc" id="L173">      return dbClient.componentDao().selectByKeys(dbSession, projectKeys);</span>
    }

    private List&lt;ComponentDto&gt; getAuthorizedProjects(List&lt;ComponentDto&gt; componentDtos) {
<span class="fc" id="L177">      return userSession.keepAuthorizedComponents(ProjectPermission.USER, componentDtos);</span>
    }

    private List&lt;MetricDto&gt; searchMetrics() {
<span class="fc" id="L181">      Collection&lt;String&gt; metricKeysParamValue = RemovedMetricConverter.withRemovedMetricAlias(request.getMetricKeys());</span>
<span class="fc" id="L182">      List&lt;MetricDto&gt; dbMetrics = dbClient.metricDao().selectByKeys(dbSession, metricKeysParamValue);</span>
<span class="fc" id="L183">      List&lt;String&gt; metricKeys = dbMetrics.stream().map(MetricDto::getKey).toList();</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">      checkRequest(metricKeysParamValue.size() == dbMetrics.size(), &quot;The following metrics are not found: %s&quot;,</span>
<span class="fc" id="L185">        String.join(&quot;, &quot;, difference(metricKeysParamValue, metricKeys)));</span>
<span class="fc" id="L186">      return dbMetrics;</span>
    }

    private List&lt;String&gt; difference(Collection&lt;String&gt; expected, Collection&lt;String&gt; actual) {
<span class="fc" id="L190">      Set&lt;String&gt; actualSet = new HashSet&lt;&gt;(actual);</span>

<span class="fc" id="L192">      return expected.stream()</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">        .filter(value -&gt; !actualSet.contains(value))</span>
<span class="fc" id="L194">        .sorted(String::compareTo)</span>
<span class="fc" id="L195">        .toList();</span>
    }

    private List&lt;MeasureDto&gt; searchMeasures() {
<span class="fc" id="L199">      return dbClient.measureDao().selectByComponentUuidsAndMetricKeys(dbSession,</span>
<span class="fc" id="L200">        projects.stream().map(ComponentDto::uuid).toList(),</span>
<span class="fc" id="L201">        metrics.stream().map(MetricDto::getKey).toList());</span>
    }

    private SearchWsResponse buildResponse() {
<span class="fc" id="L205">      List&lt;Measure&gt; wsMeasures = buildWsMeasures();</span>
<span class="fc" id="L206">      return SearchWsResponse.newBuilder()</span>
<span class="fc" id="L207">        .addAllMeasures(wsMeasures)</span>
<span class="fc" id="L208">        .build();</span>
    }

    private List&lt;Measure&gt; buildWsMeasures() {
<span class="fc" id="L212">      Map&lt;String, ComponentDto&gt; componentsByUuid = projects.stream().collect(toMap(ComponentDto::uuid, Function.identity()));</span>
<span class="fc" id="L213">      Map&lt;String, String&gt; componentNamesByKey = projects.stream().collect(toMap(ComponentDto::getKey, ComponentDto::name));</span>
<span class="fc" id="L214">      Map&lt;String, MetricDto&gt; metricsByKey = metrics.stream().collect(toMap(MetricDto::getKey, identity()));</span>

<span class="fc" id="L216">      Function&lt;Measure, String&gt; byMetricKey = Measure::getMetric;</span>
<span class="fc" id="L217">      Function&lt;Measure, String&gt; byComponentName = wsMeasure -&gt; componentNamesByKey.get(wsMeasure.getComponent());</span>

<span class="fc" id="L219">      Measure.Builder measureBuilder = Measure.newBuilder();</span>
<span class="fc" id="L220">      List&lt;Measure&gt; allMeasures = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">      for (MeasureDto measure : measures) {</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">        for (String metricKey : measure.getMetricValues().keySet()) {</span>
<span class="fc" id="L223">          updateMeasureBuilder(measureBuilder, metricsByKey.get(metricKey), measure);</span>
<span class="fc" id="L224">          measureBuilder.setComponent(componentsByUuid.get(measure.getComponentUuid()).getKey());</span>
<span class="fc" id="L225">          Measure measureMsg = measureBuilder.build();</span>
<span class="fc" id="L226">          addMeasureIncludingRenamedMetric(measureMsg, allMeasures, measureBuilder);</span>

<span class="fc" id="L228">          measureBuilder.clear();</span>
<span class="fc" id="L229">        }</span>
<span class="fc" id="L230">      }</span>
<span class="fc" id="L231">      return allMeasures.stream()</span>
<span class="fc" id="L232">        .sorted(comparing(byMetricKey).thenComparing(byComponentName))</span>
<span class="fc" id="L233">        .toList();</span>
    }

    private void addMeasureIncludingRenamedMetric(Measure measureMsg, List&lt;Measure&gt; allMeasures, Measure.Builder measureBuilder) {
<span class="fc bfc" id="L237" title="All 2 branches covered.">      if (measureBuilder.getMetric().equals(DEPRECATED_METRIC_REPLACEMENT)) {</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (request.getMetricKeys().contains(DEPRECATED_METRIC_REPLACEMENT)) {</span>
<span class="nc" id="L239">          allMeasures.add(measureMsg);</span>
        }
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (request.getMetricKeys().contains(REMOVED_METRIC)) {</span>
<span class="fc" id="L242">          allMeasures.add(measureBuilder.setMetric(REMOVED_METRIC).build());</span>
        }
      } else {
<span class="fc" id="L245">        allMeasures.add(measureMsg);</span>
      }
<span class="fc" id="L247">    }</span>
  }

  private static class SearchRequest {

    private final List&lt;String&gt; metricKeys;
    private final List&lt;String&gt; projectKeys;

<span class="fc" id="L255">    public SearchRequest(Builder builder) {</span>
<span class="fc" id="L256">      metricKeys = builder.metricKeys;</span>
<span class="fc" id="L257">      projectKeys = builder.projectKeys;</span>
<span class="fc" id="L258">    }</span>

    public List&lt;String&gt; getMetricKeys() {
<span class="fc" id="L261">      return metricKeys;</span>
    }

    public List&lt;String&gt; getProjectKeys() {
<span class="fc" id="L265">      return projectKeys;</span>
    }

    public static Builder builder() {
<span class="fc" id="L269">      return new Builder();</span>
    }

  }

  private static class Builder {
    private List&lt;String&gt; metricKeys;
    private List&lt;String&gt; projectKeys;

    private Builder() {
      // enforce method constructor
    }

    public Builder setMetricKeys(List&lt;String&gt; metricKeys) {
<span class="fc" id="L283">      this.metricKeys = metricKeys;</span>
<span class="fc" id="L284">      return this;</span>
    }

    public Builder setProjectKeys(List&lt;String&gt; projectKeys) {
<span class="fc" id="L288">      this.projectKeys = projectKeys;</span>
<span class="fc" id="L289">      return this;</span>
    }

    public SearchAction.SearchRequest build() {
<span class="pc bpc" id="L293" title="1 of 4 branches missed.">      checkArgument(metricKeys != null &amp;&amp; !metricKeys.isEmpty(), &quot;Metric keys must be provided&quot;);</span>
<span class="fc bfc" id="L294" title="All 4 branches covered.">      checkArgument(projectKeys != null &amp;&amp; !projectKeys.isEmpty(), &quot;Project keys must be provided&quot;);</span>
<span class="fc" id="L295">      int nbComponents = projectKeys.size();</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">      checkArgument(nbComponents &lt;= MAX_NB_PROJECTS,</span>
        &quot;%s projects provided, more than maximum authorized (%s)&quot;, nbComponents, MAX_NB_PROJECTS);
<span class="fc" id="L298">      return new SearchAction.SearchRequest(this);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>