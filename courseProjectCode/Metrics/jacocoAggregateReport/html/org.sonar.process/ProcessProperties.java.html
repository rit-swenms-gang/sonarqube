<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessProperties.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.process</a> &gt; <span class="el_source">ProcessProperties.java</span></div><h1>ProcessProperties.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.process;

import com.google.common.collect.ImmutableSet;
import java.net.InetAddress;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.Properties;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;
import javax.annotation.Nullable;
import org.sonar.core.config.ProxyProperties;
import org.sonar.core.extension.CoreExtension;
import org.sonar.core.extension.ServiceLoaderWrapper;

import static com.google.common.base.Preconditions.checkState;
import static java.lang.String.format;
import static org.sonar.process.ProcessProperties.Property.CLUSTER_ENABLED;
import static org.sonar.process.ProcessProperties.Property.ES_PORT;
import static org.sonar.process.ProcessProperties.Property.SEARCH_HOST;
import static org.sonar.process.ProcessProperties.Property.SEARCH_PORT;

/**
 * Constants shared by search, web server and app processes.
 * They are almost all the properties defined in conf/sonar.properties.
 */
public class ProcessProperties {
<span class="fc" id="L49">  private static final String DEFAULT_FALSE = Boolean.FALSE.toString();</span>

  private final ServiceLoaderWrapper serviceLoaderWrapper;

<span class="fc" id="L53">  public enum Property {</span>
<span class="fc" id="L54">    JDBC_URL(&quot;sonar.jdbc.url&quot;),</span>
<span class="fc" id="L55">    JDBC_USERNAME(&quot;sonar.jdbc.username&quot;, &quot;&quot;),</span>
<span class="fc" id="L56">    JDBC_PASSWORD(&quot;sonar.jdbc.password&quot;, &quot;&quot;),</span>
<span class="fc" id="L57">    JDBC_DRIVER_PATH(&quot;sonar.jdbc.driverPath&quot;),</span>
<span class="fc" id="L58">    JDBC_ADDITIONAL_LIB_PATHS(&quot;sonar.jdbc.additionalLibPaths&quot;),</span>
<span class="fc" id="L59">    JDBC_MAX_ACTIVE(&quot;sonar.jdbc.maxActive&quot;, &quot;60&quot;),</span>
<span class="fc" id="L60">    JDBC_MIN_IDLE(&quot;sonar.jdbc.minIdle&quot;, &quot;10&quot;),</span>
<span class="fc" id="L61">    JDBC_MAX_WAIT(&quot;sonar.jdbc.maxWait&quot;, &quot;8000&quot;),</span>
<span class="fc" id="L62">    JDBC_MAX_IDLE_TIMEOUT(&quot;sonar.jdbc.idleTimeout&quot;, &quot;600000&quot;),</span>
<span class="fc" id="L63">    JDBC_MAX_KEEP_ALIVE_TIME(&quot;sonar.jdbc.keepaliveTime&quot;, &quot;180000&quot;),</span>
<span class="fc" id="L64">    JDBC_MAX_LIFETIME(&quot;sonar.jdbc.maxLifetime&quot;, &quot;1800000&quot;),</span>
<span class="fc" id="L65">    JDBC_VALIDATION_TIMEOUT(&quot;sonar.jdbc.validationTimeout&quot;, &quot;5000&quot;),</span>

<span class="fc" id="L67">    JDBC_EMBEDDED_PORT(&quot;sonar.embeddedDatabase.port&quot;),</span>

<span class="fc" id="L69">    PATH_DATA(&quot;sonar.path.data&quot;, &quot;data&quot;),</span>
<span class="fc" id="L70">    PATH_HOME(&quot;sonar.path.home&quot;),</span>
<span class="fc" id="L71">    PATH_LOGS(&quot;sonar.path.logs&quot;, &quot;logs&quot;),</span>
<span class="fc" id="L72">    PATH_TEMP(&quot;sonar.path.temp&quot;, &quot;temp&quot;),</span>
<span class="fc" id="L73">    PATH_WEB(&quot;sonar.path.web&quot;, &quot;web&quot;),</span>

<span class="fc" id="L75">    LOG_LEVEL(&quot;sonar.log.level&quot;),</span>
<span class="fc" id="L76">    LOG_LEVEL_APP(&quot;sonar.log.level.app&quot;),</span>
<span class="fc" id="L77">    LOG_LEVEL_WEB(&quot;sonar.log.level.web&quot;),</span>
<span class="fc" id="L78">    LOG_LEVEL_CE(&quot;sonar.log.level.ce&quot;),</span>
<span class="fc" id="L79">    LOG_LEVEL_ES(&quot;sonar.log.level.es&quot;),</span>
<span class="fc" id="L80">    LOG_ROLLING_POLICY(&quot;sonar.log.rollingPolicy&quot;),</span>
<span class="fc" id="L81">    LOG_MAX_FILES(&quot;sonar.log.maxFiles&quot;),</span>
<span class="fc" id="L82">    LOG_CONSOLE(&quot;sonar.log.console&quot;),</span>
<span class="fc" id="L83">    LOG_JSON_OUTPUT(&quot;sonar.log.jsonOutput&quot;, DEFAULT_FALSE),</span>

<span class="fc" id="L85">    SEARCH_HOST(&quot;sonar.search.host&quot;),</span>
<span class="fc" id="L86">    SEARCH_PORT(&quot;sonar.search.port&quot;),</span>
<span class="fc" id="L87">    ES_PORT(&quot;sonar.es.port&quot;),</span>
<span class="fc" id="L88">    SEARCH_JAVA_OPTS(&quot;sonar.search.javaOpts&quot;, &quot;-Xmx512m -Xms512m -XX:MaxDirectMemorySize=256m -XX:+HeapDumpOnOutOfMemoryError&quot;),</span>
<span class="fc" id="L89">    SEARCH_JAVA_ADDITIONAL_OPTS(&quot;sonar.search.javaAdditionalOpts&quot;, &quot;&quot;),</span>
<span class="fc" id="L90">    SEARCH_REPLICAS(&quot;sonar.search.replicas&quot;),</span>
<span class="fc" id="L91">    SEARCH_INITIAL_STATE_TIMEOUT(&quot;sonar.search.initialStateTimeout&quot;),</span>
<span class="fc" id="L92">    SONAR_ES_BOOTSTRAP_CHECKS_DISABLE(&quot;sonar.es.bootstrap.checks.disable&quot;),</span>

<span class="fc" id="L94">    WEB_HOST(&quot;sonar.web.host&quot;),</span>
<span class="fc" id="L95">    WEB_JAVA_OPTS(&quot;sonar.web.javaOpts&quot;, &quot;-Xmx512m -Xms128m -XX:+HeapDumpOnOutOfMemoryError&quot;),</span>
<span class="fc" id="L96">    WEB_JAVA_ADDITIONAL_OPTS(&quot;sonar.web.javaAdditionalOpts&quot;, &quot;&quot;),</span>
<span class="fc" id="L97">    WEB_CONTEXT(&quot;sonar.web.context&quot;),</span>
<span class="fc" id="L98">    WEB_PORT(&quot;sonar.web.port&quot;),</span>
<span class="fc" id="L99">    WEB_GRACEFUL_STOP_TIMEOUT(&quot;sonar.web.gracefulStopTimeOutInMs&quot;, &quot;&quot; + 4 * 60 * 1_000L),</span>
<span class="fc" id="L100">    WEB_HTTP_MIN_THREADS(&quot;sonar.web.http.minThreads&quot;),</span>
<span class="fc" id="L101">    WEB_HTTP_MAX_THREADS(&quot;sonar.web.http.maxThreads&quot;),</span>
<span class="fc" id="L102">    WEB_HTTP_ACCEPT_COUNT(&quot;sonar.web.http.acceptCount&quot;),</span>
<span class="fc" id="L103">    WEB_HTTP_KEEP_ALIVE_TIMEOUT(&quot;sonar.web.http.keepAliveTimeout&quot;),</span>
    // The  time a user can remain idle (no activity) before the session ends.
<span class="fc" id="L105">    WEB_INACTIVE_SESSION_TIMEOUT_IN_MIN(&quot;sonar.web.sessionTimeoutInMinutes&quot;),</span>
    // The time a user can remain logged in, regardless of activity
<span class="fc" id="L107">    WEB_ACTIVE_SESSION_TIMEOUT_IN_MIN(&quot;sonar.web.activeSessionTimeoutInMinutes&quot;),</span>
<span class="fc" id="L108">    WEB_SYSTEM_PASS_CODE(&quot;sonar.web.systemPasscode&quot;),</span>
<span class="fc" id="L109">    WEB_ACCESSLOGS_ENABLE(&quot;sonar.web.accessLogs.enable&quot;),</span>
<span class="fc" id="L110">    WEB_ACCESSLOGS_PATTERN(&quot;sonar.web.accessLogs.pattern&quot;),</span>

<span class="fc" id="L112">    CE_JAVA_OPTS(&quot;sonar.ce.javaOpts&quot;, &quot;-Xmx512m -Xms128m -XX:+HeapDumpOnOutOfMemoryError&quot;),</span>
<span class="fc" id="L113">    CE_JAVA_ADDITIONAL_OPTS(&quot;sonar.ce.javaAdditionalOpts&quot;, &quot;&quot;),</span>
<span class="fc" id="L114">    CE_GRACEFUL_STOP_TIMEOUT(&quot;sonar.ce.gracefulStopTimeOutInMs&quot;, &quot;&quot; + 6 * 60 * 60 * 1_000L),</span>

<span class="fc" id="L116">    HTTP_PROXY_HOST(&quot;http.proxyHost&quot;),</span>
<span class="fc" id="L117">    HTTPS_PROXY_HOST(&quot;https.proxyHost&quot;),</span>
<span class="fc" id="L118">    HTTP_PROXY_PORT(&quot;http.proxyPort&quot;),</span>
<span class="fc" id="L119">    HTTPS_PROXY_PORT(&quot;https.proxyPort&quot;),</span>
<span class="fc" id="L120">    HTTP_PROXY_USER(ProxyProperties.HTTP_PROXY_USER),</span>
<span class="fc" id="L121">    HTTP_PROXY_PASSWORD(ProxyProperties.HTTP_PROXY_PASSWORD),</span>
<span class="fc" id="L122">    HTTP_NON_PROXY_HOSTS(&quot;http.nonProxyHosts&quot;, &quot;localhost|127.*|[::1]&quot;),</span>
<span class="fc" id="L123">    HTTP_AUTH_NTLM_DOMAIN(&quot;http.auth.ntlm.domain&quot;),</span>
<span class="fc" id="L124">    SOCKS_PROXY_HOST(&quot;socksProxyHost&quot;),</span>
<span class="fc" id="L125">    SOCKS_PROXY_PORT(&quot;socksProxyPort&quot;),</span>

<span class="fc" id="L127">    CLUSTER_ENABLED(&quot;sonar.cluster.enabled&quot;, DEFAULT_FALSE),</span>
<span class="fc" id="L128">    CLUSTER_KUBERNETES(&quot;sonar.cluster.kubernetes&quot;, DEFAULT_FALSE),</span>
<span class="fc" id="L129">    CLUSTER_NODE_TYPE(&quot;sonar.cluster.node.type&quot;),</span>
<span class="fc" id="L130">    CLUSTER_SEARCH_HOSTS(&quot;sonar.cluster.search.hosts&quot;),</span>
<span class="fc" id="L131">    CLUSTER_HZ_HOSTS(&quot;sonar.cluster.hosts&quot;),</span>
<span class="fc" id="L132">    CLUSTER_NODE_HZ_PORT(&quot;sonar.cluster.node.port&quot;, &quot;9003&quot;),</span>
<span class="fc" id="L133">    CLUSTER_NODE_HOST(&quot;sonar.cluster.node.host&quot;),</span>
<span class="fc" id="L134">    CLUSTER_NODE_NAME(&quot;sonar.cluster.node.name&quot;, &quot;sonarqube-&quot; + UUID.randomUUID().toString()),</span>
<span class="fc" id="L135">    CLUSTER_NAME(&quot;sonar.cluster.name&quot;, &quot;sonarqube&quot;),</span>
<span class="fc" id="L136">    CLUSTER_WEB_STARTUP_LEADER(&quot;sonar.cluster.web.startupLeader&quot;),</span>

<span class="fc" id="L138">    CLUSTER_SEARCH_PASSWORD(&quot;sonar.cluster.search.password&quot;),</span>
<span class="fc" id="L139">    CLUSTER_ES_KEYSTORE(&quot;sonar.cluster.es.ssl.keystore&quot;),</span>
<span class="fc" id="L140">    CLUSTER_ES_TRUSTSTORE(&quot;sonar.cluster.es.ssl.truststore&quot;),</span>
<span class="fc" id="L141">    CLUSTER_ES_KEYSTORE_PASSWORD(&quot;sonar.cluster.es.ssl.keystorePassword&quot;),</span>
<span class="fc" id="L142">    CLUSTER_ES_TRUSTSTORE_PASSWORD(&quot;sonar.cluster.es.ssl.truststorePassword&quot;),</span>
<span class="fc" id="L143">    CLUSTER_ES_HTTP_KEYSTORE(&quot;sonar.cluster.es.http.ssl.keystore&quot;),</span>
<span class="fc" id="L144">    CLUSTER_ES_HTTP_KEYSTORE_PASSWORD(&quot;sonar.cluster.es.http.ssl.keystorePassword&quot;),</span>
    // search node only settings
<span class="fc" id="L146">    CLUSTER_ES_HOSTS(&quot;sonar.cluster.es.hosts&quot;),</span>
<span class="fc" id="L147">    CLUSTER_ES_DISCOVERY_SEED_HOSTS(&quot;sonar.cluster.es.discovery.seed.hosts&quot;),</span>
<span class="fc" id="L148">    CLUSTER_NODE_SEARCH_HOST(&quot;sonar.cluster.node.search.host&quot;),</span>
<span class="fc" id="L149">    CLUSTER_NODE_SEARCH_PORT(&quot;sonar.cluster.node.search.port&quot;),</span>
<span class="fc" id="L150">    CLUSTER_NODE_ES_HOST(&quot;sonar.cluster.node.es.host&quot;),</span>
<span class="fc" id="L151">    CLUSTER_NODE_ES_PORT(&quot;sonar.cluster.node.es.port&quot;),</span>

<span class="fc" id="L153">    AUTH_JWT_SECRET(&quot;sonar.auth.jwtBase64Hs256Secret&quot;),</span>
<span class="fc" id="L154">    SONAR_WEB_SSO_ENABLE(&quot;sonar.web.sso.enable&quot;, DEFAULT_FALSE),</span>
<span class="fc" id="L155">    SONAR_WEB_SSO_LOGIN_HEADER(&quot;sonar.web.sso.loginHeader&quot;, &quot;X-Forwarded-Login&quot;),</span>
<span class="fc" id="L156">    SONAR_WEB_SSO_NAME_HEADER(&quot;sonar.web.sso.nameHeader&quot;, &quot;X-Forwarded-Name&quot;),</span>
<span class="fc" id="L157">    SONAR_WEB_SSO_EMAIL_HEADER(&quot;sonar.web.sso.emailHeader&quot;, &quot;X-Forwarded-Email&quot;),</span>
<span class="fc" id="L158">    SONAR_WEB_SSO_GROUPS_HEADER(&quot;sonar.web.sso.groupsHeader&quot;, &quot;X-Forwarded-Groups&quot;),</span>
<span class="fc" id="L159">    SONAR_WEB_SSO_REFRESH_INTERVAL_IN_MINUTES(&quot;sonar.web.sso.refreshIntervalInMinutes&quot;, &quot;5&quot;),</span>
<span class="fc" id="L160">    SONAR_SECURITY_REALM(&quot;sonar.security.realm&quot;),</span>
<span class="fc" id="L161">    SONAR_AUTHENTICATOR_IGNORE_STARTUP_FAILURE(&quot;sonar.authenticator.ignoreStartupFailure&quot;, DEFAULT_FALSE),</span>

<span class="fc" id="L163">    LDAP_SERVERS(&quot;ldap.servers&quot;),</span>
<span class="fc" id="L164">    LDAP_URL(&quot;ldap.url&quot;),</span>
<span class="fc" id="L165">    LDAP_BIND_DN(&quot;ldap.bindDn&quot;),</span>
<span class="fc" id="L166">    LDAP_BIND_PASSWORD(&quot;ldap.bindPassword&quot;),</span>
<span class="fc" id="L167">    LDAP_AUTHENTICATION(&quot;ldap.authentication&quot;),</span>
<span class="fc" id="L168">    LDAP_REALM(&quot;ldap.realm&quot;),</span>
<span class="fc" id="L169">    LDAP_CONTEXT_FACTORY_CLASS(&quot;ldap.contextFactoryClass&quot;),</span>
<span class="fc" id="L170">    LDAP_START_TLS(&quot;ldap.StartTLS&quot;),</span>
<span class="fc" id="L171">    LDAP_FOLLOW_REFERRALS(&quot;ldap.followReferrals&quot;),</span>
<span class="fc" id="L172">    LDAP_USER_BASE_DN(&quot;ldap.user.baseDn&quot;),</span>
<span class="fc" id="L173">    LDAP_USER_REQUEST(&quot;ldap.user.request&quot;),</span>
<span class="fc" id="L174">    LDAP_USER_REAL_NAME_ATTRIBUTE(&quot;ldap.user.realNameAttribute&quot;),</span>
<span class="fc" id="L175">    LDAP_USER_EMAIL_ATTRIBUTE(&quot;ldap.user.emailAttribute&quot;),</span>
<span class="fc" id="L176">    LDAP_GROUP_BASE_DN(&quot;ldap.group.baseDn&quot;),</span>
<span class="fc" id="L177">    LDAP_GROUP_REQUEST(&quot;ldap.group.request&quot;),</span>
<span class="fc" id="L178">    LDAP_GROUP_ID_ATTRIBUTE(&quot;ldap.group.idAttribute&quot;),</span>

<span class="fc" id="L180">    SONAR_TELEMETRY_ENABLE(&quot;sonar.telemetry.enable&quot;, &quot;true&quot;),</span>
<span class="fc" id="L181">    SONAR_TELEMETRY_URL(&quot;sonar.telemetry.url&quot;, &quot;https://telemetry.sonarsource.com/sonarqube&quot;),</span>
<span class="fc" id="L182">    SONAR_TELEMETRY_METRICS_URL(&quot;sonar.telemetry.metrics.url&quot;, &quot;https://telemetry.sonarsource.com/sonarqube/metrics&quot;),</span>
<span class="fc" id="L183">    SONAR_TELEMETRY_FREQUENCY_IN_SECONDS(&quot;sonar.telemetry.frequencyInSeconds&quot;, &quot;10800&quot;),</span>
<span class="fc" id="L184">    SONAR_TELEMETRY_COMPRESSION(&quot;sonar.telemetry.compression&quot;, &quot;true&quot;),</span>

<span class="fc" id="L186">    SONAR_UPDATECENTER_ACTIVATE(&quot;sonar.updatecenter.activate&quot;, &quot;true&quot;),</span>

    /**
     * Used by OrchestratorRule to ask for shutdown of monitor process
     */
<span class="fc" id="L191">    ENABLE_STOP_COMMAND(&quot;sonar.enableStopCommand&quot;),</span>

<span class="fc" id="L193">    AUTO_DATABASE_UPGRADE(&quot;sonar.autoDatabaseUpgrade&quot;, DEFAULT_FALSE);</span>

    /**
     * Properties that are defined for each LDAP server from the `ldap.servers` property
     */
<span class="fc" id="L198">    public static final Set&lt;String&gt; MULTI_SERVER_LDAP_SETTINGS = ImmutableSet.of(</span>
      &quot;ldap.*.url&quot;,
      &quot;ldap.*.bindDn&quot;,
      &quot;ldap.*.bindPassword&quot;,
      &quot;ldap.*.authentication&quot;,
      &quot;ldap.*.realm&quot;,
      &quot;ldap.*.contextFactoryClass&quot;,
      &quot;ldap.*.StartTLS&quot;,
      &quot;ldap.*.followReferrals&quot;,
      &quot;ldap.*.user.baseDn&quot;,
      &quot;ldap.*.user.request&quot;,
      &quot;ldap.*.user.realNameAttribute&quot;,
      &quot;ldap.*.user.emailAttribute&quot;,
      &quot;ldap.*.group.baseDn&quot;,
      &quot;ldap.*.group.request&quot;,
      &quot;ldap.*.group.idAttribute&quot;);

    private final String key;
    private final String defaultValue;

<span class="fc" id="L218">    Property(String key, @Nullable String defaultValue) {</span>
<span class="fc" id="L219">      this.key = key;</span>
<span class="fc" id="L220">      this.defaultValue = defaultValue;</span>
<span class="fc" id="L221">    }</span>

    Property(String key) {
<span class="fc" id="L224">      this(key, null);</span>
<span class="fc" id="L225">    }</span>

    public String getKey() {
<span class="fc" id="L228">      return key;</span>
    }

    public String getDefaultValue() {
<span class="fc" id="L232">      Objects.requireNonNull(defaultValue, &quot;There's no default value on this property&quot;);</span>
<span class="fc" id="L233">      return defaultValue;</span>
    }

    public boolean hasDefaultValue() {
<span class="fc bfc" id="L237" title="All 2 branches covered.">      return defaultValue != null;</span>
    }
  }

<span class="fc" id="L241">  public ProcessProperties(ServiceLoaderWrapper serviceLoaderWrapper) {</span>
<span class="fc" id="L242">    this.serviceLoaderWrapper = serviceLoaderWrapper;</span>
<span class="fc" id="L243">  }</span>

  public void completeDefaults(Props props) {
    // init string properties
<span class="fc bfc" id="L247" title="All 2 branches covered.">    for (Map.Entry&lt;Object, Object&gt; entry : defaults().entrySet()) {</span>
<span class="fc" id="L248">      props.setDefault(entry.getKey().toString(), entry.getValue().toString());</span>
<span class="fc" id="L249">    }</span>

<span class="fc" id="L251">    boolean clusterEnabled = props.valueAsBoolean(CLUSTER_ENABLED.getKey(), false);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">    if (!clusterEnabled) {</span>
<span class="fc" id="L253">      props.setDefault(SEARCH_HOST.getKey(), InetAddress.getLoopbackAddress().getHostAddress());</span>
<span class="fc" id="L254">      props.setDefault(SEARCH_PORT.getKey(), &quot;9001&quot;);</span>
<span class="fc" id="L255">      fixPortIfZero(props, Property.SEARCH_HOST.getKey(), SEARCH_PORT.getKey());</span>
<span class="fc" id="L256">      fixEsTransportPortIfNull(props);</span>
    }
<span class="fc" id="L258">  }</span>

  private Properties defaults() {
<span class="fc" id="L261">    Properties defaults = new Properties();</span>
<span class="fc" id="L262">    defaults.putAll(Arrays.stream(Property.values())</span>
<span class="fc" id="L263">      .filter(Property::hasDefaultValue)</span>
<span class="fc" id="L264">      .collect(Collectors.toMap(Property::getKey, Property::getDefaultValue)));</span>
<span class="fc" id="L265">    defaults.putAll(loadDefaultsFromExtensions());</span>
<span class="fc" id="L266">    return defaults;</span>
  }

  private Map&lt;String, String&gt; loadDefaultsFromExtensions() {
<span class="fc" id="L270">    Map&lt;String, String&gt; propertyDefaults = new HashMap&lt;&gt;();</span>
<span class="fc" id="L271">    Set&lt;CoreExtension&gt; extensions = serviceLoaderWrapper.load();</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">    for (CoreExtension ext : extensions) {</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">      for (Map.Entry&lt;String, String&gt; property : ext.getExtensionProperties().entrySet()) {</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (propertyDefaults.put(property.getKey(), property.getValue()) != null) {</span>
<span class="fc" id="L275">          throw new IllegalStateException(format(&quot;Configuration error: property definition named '%s' found in multiple extensions.&quot;,</span>
<span class="fc" id="L276">            property.getKey()));</span>
        }
<span class="fc" id="L278">      }</span>
<span class="fc" id="L279">    }</span>

<span class="fc" id="L281">    return propertyDefaults;</span>
  }

  private static void fixPortIfZero(Props props, String addressPropertyKey, String portPropertyKey) {
<span class="fc" id="L285">    String port = props.value(portPropertyKey);</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">    if (&quot;0&quot;.equals(port)) {</span>
<span class="fc" id="L287">      String address = props.nonNullValue(addressPropertyKey);</span>
<span class="fc" id="L288">      int allocatedPort = NetworkUtilsImpl.INSTANCE.getNextAvailablePort(address)</span>
<span class="pc" id="L289">        .orElseThrow(() -&gt; new IllegalStateException(&quot;Cannot resolve address [&quot; + address + &quot;] set by property [&quot; + addressPropertyKey + &quot;]&quot;));</span>
<span class="fc" id="L290">      props.set(portPropertyKey, String.valueOf(allocatedPort));</span>
    }
<span class="fc" id="L292">  }</span>

  private static void fixEsTransportPortIfNull(Props props) {
<span class="fc" id="L295">    String port = props.value(ES_PORT.getKey());</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">    if (port == null) {</span>
<span class="fc" id="L297">      int allocatedPort = NetworkUtilsImpl.INSTANCE.getNextAvailablePort(InetAddress.getLoopbackAddress().getHostAddress())</span>
<span class="pc" id="L298">        .orElseThrow(() -&gt; new IllegalStateException(&quot;Cannot resolve address for Elasticsearch TCP transport port&quot;));</span>
<span class="fc" id="L299">      props.set(ES_PORT.getKey(), String.valueOf(allocatedPort));</span>
    }
<span class="fc" id="L301">  }</span>

  public static long parseTimeoutMs(Property property, String value) {
<span class="fc" id="L304">    long l = Long.parseLong(value);</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">    checkState(l &gt;= 1, &quot;value of %s must be &gt;= 1&quot;, property);</span>
<span class="fc" id="L306">    return l;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>