<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProcessEntryPoint.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.process</a> &gt; <span class="el_source">ProcessEntryPoint.java</span></div><h1>ProcessEntryPoint.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.process;

import java.io.File;
import java.util.function.Predicate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.process.sharedmemoryfile.DefaultProcessCommands;
import org.sonar.process.sharedmemoryfile.ProcessCommands;

import static org.sonar.process.Lifecycle.State.STOPPED;

public class ProcessEntryPoint {

  public static final String PROPERTY_PROCESS_KEY = &quot;process.key&quot;;
  public static final String PROPERTY_PROCESS_INDEX = &quot;process.index&quot;;
  public static final String PROPERTY_GRACEFUL_STOP_TIMEOUT_MS = &quot;process.gracefulStopTimeout&quot;;
  public static final String PROPERTY_SHARED_PATH = &quot;process.sharedDir&quot;;
  // 1 second
  private static final long HARD_STOP_TIMEOUT_MS = 1_000L;

  private final Props props;
  private final ProcessId processId;
<span class="fc" id="L42">  private final Lifecycle lifecycle = new Lifecycle();</span>
  private final ProcessCommands commands;
  private final SystemExit exit;
  private final StopWatcher stopWatcher;
  private final StopWatcher hardStopWatcher;
  // new Runnable() is important to avoid conflict of call to ProcessEntryPoint#stop() with Thread#stop()
  private final Runtime runtime;
  private Monitored monitored;
  private volatile StopperThread stopperThread;

<span class="fc" id="L52">  public ProcessEntryPoint(Props props, SystemExit exit, ProcessCommands commands, Runtime runtime) {</span>
<span class="fc" id="L53">    this.props = props;</span>
<span class="fc" id="L54">    this.processId = ProcessId.fromKey(props.nonNullValue(PROPERTY_PROCESS_KEY));</span>
<span class="fc" id="L55">    this.exit = exit;</span>
<span class="fc" id="L56">    this.commands = commands;</span>
<span class="fc" id="L57">    this.stopWatcher = createStopWatcher(commands, this);</span>
<span class="fc" id="L58">    this.hardStopWatcher = createHardStopWatcher(commands, this);</span>
<span class="fc" id="L59">    this.runtime = runtime;</span>
<span class="fc" id="L60">  }</span>

  public ProcessCommands getCommands() {
<span class="nc" id="L63">    return commands;</span>
  }

  public Props getProps() {
<span class="fc" id="L67">    return props;</span>
  }

  /**
   * Launch process and waits until it's down
   */
  public void launch(Monitored mp) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">    if (!lifecycle.tryToMoveTo(Lifecycle.State.STARTING)) {</span>
<span class="fc" id="L75">      throw new IllegalStateException(&quot;Already started&quot;);</span>
    }
<span class="fc" id="L77">    monitored = mp;</span>

<span class="fc" id="L79">    Logger logger = LoggerFactory.getLogger(getClass());</span>
    try {
<span class="fc" id="L81">      launch(logger);</span>
<span class="fc" id="L82">    } catch (Exception e) {</span>
<span class="fc" id="L83">      logger.warn(&quot;Fail to start {}&quot;, processId.getHumanReadableName(), e);</span>
<span class="fc" id="L84">      hardStop();</span>
<span class="fc" id="L85">    }</span>
<span class="fc" id="L86">  }</span>

  private void launch(Logger logger) throws InterruptedException {
<span class="fc" id="L89">    logger.info(&quot;Starting {}&quot;, processId.getHumanReadableName());</span>
<span class="fc" id="L90">    runtime.addShutdownHook(new Thread(() -&gt; {</span>
<span class="fc" id="L91">      exit.setInShutdownHook();</span>
<span class="fc" id="L92">      stop();</span>
<span class="fc" id="L93">    }));</span>
<span class="fc" id="L94">    stopWatcher.start();</span>
<span class="fc" id="L95">    hardStopWatcher.start();</span>

<span class="fc" id="L97">    monitored.start();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">    Monitored.Status status = waitForStatus(s -&gt; s != Monitored.Status.DOWN);</span>
<span class="pc bpc" id="L99" title="2 of 4 branches missed.">    if (status == Monitored.Status.UP || status == Monitored.Status.OPERATIONAL) {</span>
      // notify monitor that process is ready
<span class="fc" id="L101">      commands.setUp();</span>

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">      if (lifecycle.tryToMoveTo(Lifecycle.State.STARTED)) {</span>
<span class="pc bpc" id="L104" title="3 of 4 branches missed.">        Monitored.Status newStatus = waitForStatus(s -&gt; s == Monitored.Status.OPERATIONAL || s == Monitored.Status.FAILED);</span>
<span class="pc bpc" id="L105" title="2 of 4 branches missed.">        if (newStatus == Monitored.Status.OPERATIONAL &amp;&amp; lifecycle.tryToMoveTo(Lifecycle.State.OPERATIONAL)) {</span>
<span class="fc" id="L106">          commands.setOperational();</span>
        }

<span class="fc" id="L109">        monitored.awaitStop();</span>
<span class="fc" id="L110">      }</span>
    } else {
<span class="nc" id="L112">      logger.trace(&quot;Fail to start. Hard stopping...&quot;);</span>
<span class="nc" id="L113">      hardStop();</span>
    }
<span class="fc" id="L115">  }</span>

  private Monitored.Status waitForStatus(Predicate&lt;Monitored.Status&gt; statusPredicate) throws InterruptedException {
<span class="fc" id="L118">    Monitored.Status status = monitored.getStatus();</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">    while (!statusPredicate.test(status)) {</span>
<span class="nc" id="L120">      Thread.sleep(20);</span>
<span class="nc" id="L121">      status = monitored.getStatus();</span>
    }
<span class="fc" id="L123">    return status;</span>
  }

  void stop() {
<span class="fc" id="L127">    stopAsync();</span>
<span class="fc" id="L128">    monitored.awaitStop();</span>
<span class="fc" id="L129">  }</span>

  /**
   * Blocks until stopped in a timely fashion (see {@link HardStopperThread})
   */
  void hardStop() {
<span class="fc" id="L135">    hardStopAsync();</span>
<span class="fc" id="L136">    monitored.awaitStop();</span>
<span class="fc" id="L137">  }</span>

  private void stopAsync() {
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">    if (lifecycle.tryToMoveTo(Lifecycle.State.STOPPING)) {</span>
<span class="fc" id="L141">      LoggerFactory.getLogger(ProcessEntryPoint.class).info(&quot;Gracefully stopping process&quot;);</span>
<span class="fc" id="L142">      stopWatcher.stopWatching();</span>
<span class="fc" id="L143">      long terminationTimeoutMs = Long.parseLong(props.nonNullValue(PROPERTY_GRACEFUL_STOP_TIMEOUT_MS));</span>
<span class="fc" id="L144">      stopperThread = new StopperThread(monitored, this::terminate, terminationTimeoutMs);</span>
<span class="fc" id="L145">      stopperThread.start();</span>
    }
<span class="fc" id="L147">  }</span>

  private void hardStopAsync() {
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">    if (lifecycle.tryToMoveTo(Lifecycle.State.HARD_STOPPING)) {</span>
<span class="fc" id="L151">      LoggerFactory.getLogger(ProcessEntryPoint.class).info(&quot;Hard stopping process&quot;);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">      if (stopperThread != null) {</span>
<span class="nc" id="L153">        stopperThread.stopIt();</span>
      }
<span class="fc" id="L155">      hardStopWatcher.stopWatching();</span>
<span class="fc" id="L156">      stopWatcher.stopWatching();</span>
<span class="fc" id="L157">      new HardStopperThread(monitored, this::terminate).start();</span>
    }
<span class="fc" id="L159">  }</span>

  private void terminate() {
<span class="fc" id="L162">    lifecycle.tryToMoveTo(STOPPED);</span>
<span class="fc" id="L163">    hardStopWatcher.stopWatching();</span>
<span class="fc" id="L164">    stopWatcher.stopWatching();</span>
<span class="fc" id="L165">    commands.endWatch();</span>
<span class="fc" id="L166">  }</span>

  public static ProcessEntryPoint createForArguments(String[] args) {
<span class="fc" id="L169">    Props props = ConfigurationUtils.loadPropsFromCommandLineArgs(args);</span>
<span class="fc" id="L170">    File sharedDir = getSharedDir(props);</span>
<span class="fc" id="L171">    int processNumber = getProcessNumber(props);</span>
<span class="fc" id="L172">    ProcessCommands commands = DefaultProcessCommands.main(sharedDir, processNumber);</span>
<span class="fc" id="L173">    return new ProcessEntryPoint(props, new SystemExit(), commands, Runtime.getRuntime());</span>
  }

  private static int getProcessNumber(Props props) {
<span class="fc" id="L177">    return Integer.parseInt(props.nonNullValue(PROPERTY_PROCESS_INDEX));</span>
  }

  private static File getSharedDir(Props props) {
<span class="fc" id="L181">    return props.nonNullValueAsFile(PROPERTY_SHARED_PATH);</span>
  }

  /**
   * This watchdog is looking for hard stop to be requested via {@link ProcessCommands#askedForHardStop()}.
   */
  private static StopWatcher createHardStopWatcher(ProcessCommands commands, ProcessEntryPoint processEntryPoint) {
<span class="fc" id="L188">    return new StopWatcher(&quot;HardStop Watcher&quot;, processEntryPoint::hardStopAsync, commands::askedForHardStop);</span>
  }

  /**
   * This watchdog is looking for graceful stop to be requested via {@link ProcessCommands#askedForStop()} ()}.
   */
  private static StopWatcher createStopWatcher(ProcessCommands commands, ProcessEntryPoint processEntryPoint) {
<span class="fc" id="L195">    return new StopWatcher(&quot;Stop Watcher&quot;, processEntryPoint::stopAsync, commands::askedForStop);</span>
  }

  /**
   * Stops process in a graceful fashion
   */
  private static class StopperThread extends AbstractStopperThread {

    private StopperThread(Monitored monitored, Runnable postAction, long terminationTimeoutMs) {
<span class="fc" id="L204">      super(&quot;Stopper&quot;, () -&gt; {</span>
<span class="fc" id="L205">        monitored.stop();</span>
<span class="fc" id="L206">        postAction.run();</span>
<span class="fc" id="L207">      }, terminationTimeoutMs);</span>
<span class="fc" id="L208">    }</span>
  }

  /**
   * Stops process in a short time fashion
   */
  private static class HardStopperThread extends AbstractStopperThread {

    private HardStopperThread(Monitored monitored, Runnable postAction) {
<span class="fc" id="L217">      super(</span>
        &quot;HardStopper&quot;, () -&gt; {
<span class="fc" id="L219">          monitored.hardStop();</span>
<span class="fc" id="L220">          postAction.run();</span>
<span class="fc" id="L221">        }, HARD_STOP_TIMEOUT_MS);</span>
<span class="fc" id="L222">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>