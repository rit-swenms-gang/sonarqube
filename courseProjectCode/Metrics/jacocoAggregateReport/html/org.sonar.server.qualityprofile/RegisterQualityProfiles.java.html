<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegisterQualityProfiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.qualityprofile</a> &gt; <span class="el_source">RegisterQualityProfiles.java</span></div><h1>RegisterQualityProfiles.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.qualityprofile;

import com.google.common.collect.ArrayListMultimap;
import com.google.common.collect.Multimap;
import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import org.apache.commons.lang3.StringUtils;
import org.sonar.api.Startable;
import org.sonar.api.resources.Language;
import org.sonar.api.resources.Languages;
import org.sonar.api.server.ServerSide;
import org.sonar.api.utils.System2;
import org.sonar.api.utils.log.Logger;
import org.sonar.api.utils.log.Loggers;
import org.sonar.api.utils.log.Profiler;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.qualityprofile.DefaultQProfileDto;
import org.sonar.db.qualityprofile.QProfileDto;
import org.sonar.db.qualityprofile.RulesProfileDto;
import org.sonar.server.qualityprofile.builtin.BuiltInQProfile;
import org.sonar.server.qualityprofile.builtin.BuiltInQProfileInsert;
import org.sonar.server.qualityprofile.builtin.BuiltInQProfileRepository;
import org.sonar.server.qualityprofile.builtin.BuiltInQProfileUpdate;
import org.sonar.server.qualityprofile.builtin.BuiltInQualityProfilesUpdateListener;
import org.sonar.server.qualityprofile.builtin.QProfileName;

import static java.lang.String.format;
import static java.util.stream.Collectors.toMap;
import static java.util.stream.Collectors.toSet;
import static org.sonar.server.qualityprofile.ActiveRuleInheritance.NONE;

/**
 * Synchronize Quality profiles during server startup
 */
@ServerSide
public class RegisterQualityProfiles implements Startable {

<span class="fc" id="L67">  private static final Logger LOGGER = Loggers.get(RegisterQualityProfiles.class);</span>

  private final BuiltInQProfileRepository builtInQProfileRepository;
  private final DbClient dbClient;
  private final BuiltInQProfileInsert builtInQProfileInsert;
  private final BuiltInQProfileUpdate builtInQProfileUpdate;
  private final BuiltInQualityProfilesUpdateListener builtInQualityProfilesNotification;
  private final System2 system2;
  private final Languages languages;

  public RegisterQualityProfiles(BuiltInQProfileRepository builtInQProfileRepository,
    DbClient dbClient, BuiltInQProfileInsert builtInQProfileInsert, BuiltInQProfileUpdate builtInQProfileUpdate,
<span class="fc" id="L79">    BuiltInQualityProfilesUpdateListener builtInQualityProfilesNotification, System2 system2, Languages languages) {</span>
<span class="fc" id="L80">    this.builtInQProfileRepository = builtInQProfileRepository;</span>
<span class="fc" id="L81">    this.dbClient = dbClient;</span>
<span class="fc" id="L82">    this.builtInQProfileInsert = builtInQProfileInsert;</span>
<span class="fc" id="L83">    this.builtInQProfileUpdate = builtInQProfileUpdate;</span>
<span class="fc" id="L84">    this.builtInQualityProfilesNotification = builtInQualityProfilesNotification;</span>
<span class="fc" id="L85">    this.system2 = system2;</span>
<span class="fc" id="L86">    this.languages = languages;</span>
<span class="fc" id="L87">  }</span>

  @Override
  public void start() {
<span class="fc" id="L91">    List&lt;BuiltInQProfile&gt; builtInQProfiles = builtInQProfileRepository.get();</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">    if (builtInQProfiles.isEmpty()) {</span>
<span class="nc" id="L93">      return;</span>
    }

<span class="fc" id="L96">    Profiler profiler = Profiler.create(Loggers.get(getClass())).startInfo(&quot;Register quality profiles&quot;);</span>
<span class="fc" id="L97">    try (DbSession dbSession = dbClient.openSession(false);</span>
<span class="fc" id="L98">      DbSession batchDbSession = dbClient.openSession(true)) {</span>
<span class="fc" id="L99">      long startDate = system2.now();</span>

<span class="fc" id="L101">      Map&lt;QProfileName, RulesProfileDto&gt; persistedRuleProfiles = loadPersistedProfiles(dbSession);</span>

<span class="fc" id="L103">      Multimap&lt;QProfileName, ActiveRuleChange&gt; changedProfiles = ArrayListMultimap.create();</span>
<span class="fc" id="L104">      builtInQProfiles.forEach(builtIn -&gt; {</span>
<span class="fc" id="L105">        RulesProfileDto ruleProfile = persistedRuleProfiles.get(builtIn.getQProfileName());</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (ruleProfile == null) {</span>
<span class="fc" id="L107">          create(dbSession, batchDbSession, builtIn);</span>
        } else {
<span class="fc" id="L109">          List&lt;ActiveRuleChange&gt; changes = update(dbSession, builtIn, ruleProfile);</span>
<span class="fc" id="L110">          changedProfiles.putAll(builtIn.getQProfileName(), changes.stream()</span>
<span class="fc" id="L111">            .filter(change -&gt; {</span>
<span class="fc" id="L112">              String inheritance = change.getActiveRule().getInheritance();</span>
<span class="pc bpc" id="L113" title="1 of 4 branches missed.">              return inheritance == null || NONE.name().equals(inheritance);</span>
            })
<span class="fc" id="L115">            .toList());</span>
        }
<span class="fc" id="L117">      });</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">      if (!changedProfiles.isEmpty()) {</span>
<span class="fc" id="L119">        long endDate = system2.now();</span>
<span class="fc" id="L120">        builtInQualityProfilesNotification.onChange(changedProfiles, startDate, endDate);</span>
      }
<span class="fc" id="L122">      ensureBuiltInDefaultQPContainsRules(dbSession);</span>
<span class="fc" id="L123">      unsetBuiltInFlagAndRenameQPWhenPluginUninstalled(dbSession);</span>
<span class="fc" id="L124">      ensureBuiltInAreDefaultQPWhenNoRules(dbSession);</span>

<span class="fc" id="L126">      dbSession.commit();</span>
    }
<span class="fc" id="L128">    profiler.stopDebug();</span>
<span class="fc" id="L129">  }</span>

  @Override
  public void stop() {
    // nothing to do
<span class="nc" id="L134">  }</span>

  private Map&lt;QProfileName, RulesProfileDto&gt; loadPersistedProfiles(DbSession dbSession) {
<span class="fc" id="L137">    return dbClient.qualityProfileDao().selectBuiltInRuleProfiles(dbSession).stream()</span>
<span class="fc" id="L138">      .collect(toMap(rp -&gt; new QProfileName(rp.getLanguage(), rp.getName()), Function.identity()));</span>
  }

  private void create(DbSession dbSession, DbSession batchDbSession, BuiltInQProfile builtIn) {
<span class="fc" id="L142">    LOGGER.info(&quot;Register profile {}&quot;, builtIn.getQProfileName());</span>

<span class="fc" id="L144">    renameOutdatedProfiles(dbSession, builtIn);</span>

<span class="fc" id="L146">    builtInQProfileInsert.create(batchDbSession, builtIn);</span>
<span class="fc" id="L147">  }</span>

  private List&lt;ActiveRuleChange&gt; update(DbSession dbSession, BuiltInQProfile definition, RulesProfileDto dbProfile) {
<span class="fc" id="L150">    LOGGER.info(&quot;Update profile {}&quot;, definition.getQProfileName());</span>

<span class="fc" id="L152">    return builtInQProfileUpdate.update(dbSession, definition, dbProfile);</span>
  }

  /**
   * The Quality profiles created by users should be renamed when they have the same name
   * as the built-in profile to be persisted.
   * &lt;p&gt;
   * When upgrading from &lt; 6.5 , all existing profiles are considered as &quot;custom&quot; (created
   * by users) because the concept of built-in profile is not persisted. The &quot;Sonar way&quot; profiles
   * are renamed to &quot;Sonar way (outdated copy) in order to avoid conflicts with the new
   * built-in profile &quot;Sonar way&quot;, which has probably different configuration.
   */
  private void renameOutdatedProfiles(DbSession dbSession, BuiltInQProfile profile) {
<span class="fc" id="L165">    Collection&lt;String&gt; uuids = dbClient.qualityProfileDao().selectUuidsOfCustomRulesProfiles(dbSession, profile.getLanguage(), profile.getName());</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">    if (uuids.isEmpty()) {</span>
<span class="fc" id="L167">      return;</span>
    }
<span class="fc" id="L169">    Profiler profiler = Profiler.createIfDebug(Loggers.get(getClass())).start();</span>
<span class="fc" id="L170">    String newName = profile.getName() + &quot; (outdated copy)&quot;;</span>
<span class="fc" id="L171">    LOGGER.info(&quot;Rename Quality profiles [{}/{}] to [{}]&quot;, profile.getLanguage(), profile.getName(), newName);</span>
<span class="fc" id="L172">    dbClient.qualityProfileDao().renameRulesProfilesAndCommit(dbSession, uuids, newName);</span>
<span class="fc" id="L173">    profiler.stopDebug(format(&quot;%d Quality profiles renamed to [%s]&quot;, uuids.size(), newName));</span>
<span class="fc" id="L174">  }</span>

  /**
   * This method ensure that after plugin removal, we don't end-up in a situation where a custom default quality profile is set,
   * and cannot be deleted because builtIn quality profile cannot be set to default.
   *
   * @see &lt;a href=&quot;https://jira.sonarsource.com/browse/SONAR-19478&quot;&gt;SONAR-19478&lt;/a&gt;
   */
  private void ensureBuiltInAreDefaultQPWhenNoRules(DbSession dbSession) {
<span class="fc" id="L183">    Set&lt;String&gt; activeLanguages = Arrays.stream(languages.all()).map(Language::getKey).collect(toSet());</span>
<span class="fc" id="L184">    Map&lt;String, RulesProfileDto&gt; builtInQProfileByLanguage = dbClient.qualityProfileDao().selectBuiltInRuleProfiles(dbSession).stream()</span>
<span class="fc" id="L185">      .collect(toMap(RulesProfileDto::getLanguage, Function.identity(), (oldValue, newValue) -&gt; oldValue));</span>
<span class="fc" id="L186">    List&lt;QProfileDto&gt; defaultProfileWithNoRules = dbClient.qualityProfileDao().selectDefaultProfilesWithoutActiveRules(dbSession, activeLanguages, false);</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">    for (QProfileDto defaultProfileWithNoRule : defaultProfileWithNoRules) {</span>
<span class="fc" id="L189">      long rulesCountByLanguage = dbClient.ruleDao().countByLanguage(dbSession, defaultProfileWithNoRule.getLanguage());</span>
<span class="fc" id="L190">      RulesProfileDto builtInQProfile = builtInQProfileByLanguage.get(defaultProfileWithNoRule.getLanguage());</span>
<span class="pc bpc" id="L191" title="2 of 4 branches missed.">      if (builtInQProfile != null &amp;&amp; rulesCountByLanguage == 0) {</span>
<span class="fc" id="L192">        QProfileDto builtInQualityProfile = dbClient.qualityProfileDao().selectByRuleProfileUuid(dbSession, builtInQProfile.getUuid());</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if (builtInQualityProfile != null) {</span>
<span class="fc" id="L194">          reassignDefaultQualityProfile(dbSession, defaultProfileWithNoRule, builtInQualityProfile);</span>
        }
      }
<span class="fc" id="L197">    }</span>
<span class="fc" id="L198">  }</span>

  /**
   * This method ensure that if a default built-in quality profile does not have any active rules but another built-in one for the same language
   * does have active rules, the last one will be the default one.
   *
   * @see &lt;a href=&quot;https://jira.sonarsource.com/browse/SONAR-10363&quot;&gt;SONAR-10363&lt;/a&gt;
   */
  private void ensureBuiltInDefaultQPContainsRules(DbSession dbSession) {
<span class="fc" id="L207">    Map&lt;String, RulesProfileDto&gt; rulesProfilesByLanguage = dbClient.qualityProfileDao().selectBuiltInRuleProfilesWithActiveRules(dbSession).stream()</span>
<span class="fc" id="L208">      .collect(toMap(RulesProfileDto::getLanguage, Function.identity(), (oldValue, newValue) -&gt; oldValue));</span>

<span class="fc" id="L210">    dbClient.qualityProfileDao().selectDefaultProfilesWithoutActiveRules(dbSession, rulesProfilesByLanguage.keySet(), true)</span>
<span class="fc" id="L211">      .forEach(qp -&gt; {</span>
<span class="fc" id="L212">        RulesProfileDto rulesProfile = rulesProfilesByLanguage.get(qp.getLanguage());</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (rulesProfile == null) {</span>
<span class="nc" id="L214">          return;</span>
        }

<span class="fc" id="L217">        QProfileDto qualityProfile = dbClient.qualityProfileDao().selectByRuleProfileUuid(dbSession, rulesProfile.getUuid());</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (qualityProfile == null) {</span>
<span class="nc" id="L219">          return;</span>
        }

<span class="fc" id="L222">        reassignDefaultQualityProfile(dbSession, qp, qualityProfile);</span>

<span class="fc" id="L224">        LOGGER.info(&quot;Default built-in quality profile for language [{}] has been updated from [{}] to [{}] since previous default does not have active rules.&quot;,</span>
<span class="fc" id="L225">          qp.getLanguage(),</span>
<span class="fc" id="L226">          qp.getName(),</span>
<span class="fc" id="L227">          rulesProfile.getName());</span>
<span class="fc" id="L228">      });</span>
<span class="fc" id="L229">  }</span>

  private void reassignDefaultQualityProfile(DbSession dbSession, QProfileDto currentDefaultQualityProfile, QProfileDto newDefaultQualityProfile) {
<span class="fc" id="L232">    Set&lt;String&gt; uuids = dbClient.defaultQProfileDao().selectExistingQProfileUuids(dbSession, Collections.singleton(currentDefaultQualityProfile.getKee()));</span>
<span class="fc" id="L233">    dbClient.defaultQProfileDao().deleteByQProfileUuids(dbSession, uuids);</span>
<span class="fc" id="L234">    dbClient.defaultQProfileDao().insertOrUpdate(dbSession, new DefaultQProfileDto()</span>
<span class="fc" id="L235">      .setQProfileUuid(newDefaultQualityProfile.getKee())</span>
<span class="fc" id="L236">      .setLanguage(currentDefaultQualityProfile.getLanguage()));</span>
<span class="fc" id="L237">  }</span>

  public void unsetBuiltInFlagAndRenameQPWhenPluginUninstalled(DbSession dbSession) {
<span class="fc" id="L240">    Set&lt;QProfileName&gt; pluginsBuiltInQProfiles = builtInQProfileRepository.get()</span>
<span class="fc" id="L241">      .stream()</span>
<span class="fc" id="L242">      .map(BuiltInQProfile::getQProfileName)</span>
<span class="fc" id="L243">      .collect(toSet());</span>

<span class="fc" id="L245">    Set&lt;String&gt; qualityProfileLanguages = pluginsBuiltInQProfiles</span>
<span class="fc" id="L246">      .stream()</span>
<span class="fc" id="L247">      .map(QProfileName::getLanguage)</span>
<span class="fc" id="L248">      .collect(toSet());</span>

<span class="fc" id="L250">    dbClient.qualityProfileDao().selectBuiltInRuleProfiles(dbSession)</span>
<span class="fc" id="L251">      .forEach(qProfileDto -&gt; {</span>
<span class="fc" id="L252">        var dbProfileName = QProfileName.createFor(qProfileDto.getLanguage(), qProfileDto.getName());</span>

        // Built-in Quality Profile can be a leftover from plugin which has been removed
        // Rename Quality Profile and unset built-in flag allowing Quality Profile for existing languages to be removed
        // Quality Profiles for languages not existing anymore are marked as 'REMOVED' and won't be seen in UI
<span class="pc bpc" id="L257" title="1 of 4 branches missed.">        if (!pluginsBuiltInQProfiles.contains(dbProfileName) &amp;&amp; qualityProfileLanguages.contains(qProfileDto.getLanguage())) {</span>
<span class="fc" id="L258">          String oldName = qProfileDto.getName();</span>
<span class="fc" id="L259">          String newName = generateNewProfileName(qProfileDto);</span>
<span class="fc" id="L260">          qProfileDto.setName(newName);</span>
<span class="fc" id="L261">          qProfileDto.setIsBuiltIn(false);</span>
<span class="fc" id="L262">          dbClient.qualityProfileDao().update(dbSession, qProfileDto);</span>

<span class="fc" id="L264">          LOGGER.info(&quot;Quality profile [{}] for language [{}] is no longer built-in and has been renamed to [{}] &quot;</span>
            + &quot;since it does not have any active rules.&quot;,
            oldName,
<span class="fc" id="L267">            dbProfileName.getLanguage(),</span>
            newName);
        }
<span class="fc" id="L270">      });</span>
<span class="fc" id="L271">  }</span>

  /**
   * Abbreviate Quality Profile name if it will be too long with prefix and append suffix
   */
  private String generateNewProfileName(RulesProfileDto qProfileDto) {
<span class="fc" id="L277">    var shortName = StringUtils.abbreviate(qProfileDto.getName(), 40);</span>
<span class="fc" id="L278">    DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;MMMM dd yyyy 'at' hh:mm a&quot;)</span>
<span class="fc" id="L279">      .withLocale(Locale.getDefault())</span>
<span class="fc" id="L280">      .withZone(ZoneId.systemDefault());</span>
<span class="fc" id="L281">    var now = formatter.format(Instant.ofEpochMilli(system2.now()));</span>
<span class="fc" id="L282">    String suffix = &quot; (outdated copy since &quot; + now + &quot;)&quot;;</span>
<span class="fc" id="L283">    return shortName + suffix;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>