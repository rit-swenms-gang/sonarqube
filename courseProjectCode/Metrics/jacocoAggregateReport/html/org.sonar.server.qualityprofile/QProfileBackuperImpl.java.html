<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QProfileBackuperImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.qualityprofile</a> &gt; <span class="el_source">QProfileBackuperImpl.java</span></div><h1>QProfileBackuperImpl.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.qualityprofile;

import java.io.Reader;
import java.io.Writer;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.Nullable;
import org.apache.commons.lang3.builder.CompareToBuilder;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.core.rule.RuleType;
import org.sonar.api.server.ServerSide;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.qualityprofile.ExportRuleDto;
import org.sonar.db.qualityprofile.ExportRuleParamDto;
import org.sonar.db.qualityprofile.QProfileDto;
import org.sonar.db.rule.DeprecatedRuleKeyDto;
import org.sonar.db.rule.RuleDto;
import org.sonar.server.common.rule.RuleCreator;
import org.sonar.server.common.rule.service.NewCustomRule;
import org.sonar.server.qualityprofile.builtin.QProfileName;

import static com.google.common.base.Preconditions.checkArgument;
import static java.util.function.Function.identity;
import static java.util.stream.Collectors.toSet;
import static org.sonar.server.qualityprofile.QProfileUtils.parseImpactsToMap;

@ServerSide
public class QProfileBackuperImpl implements QProfileBackuper {

  private final DbClient db;
  private final QProfileReset profileReset;
  private final QProfileFactory profileFactory;
  private final RuleCreator ruleCreator;
  private final QProfileParser qProfileParser;

  public QProfileBackuperImpl(DbClient db, QProfileReset profileReset, QProfileFactory profileFactory,
<span class="fc" id="L66">    RuleCreator ruleCreator, QProfileParser qProfileParser) {</span>
<span class="fc" id="L67">    this.db = db;</span>
<span class="fc" id="L68">    this.profileReset = profileReset;</span>
<span class="fc" id="L69">    this.profileFactory = profileFactory;</span>
<span class="fc" id="L70">    this.ruleCreator = ruleCreator;</span>
<span class="fc" id="L71">    this.qProfileParser = qProfileParser;</span>
<span class="fc" id="L72">  }</span>

  @Override
  public void backup(DbSession dbSession, QProfileDto profile, Writer writer) {
<span class="fc" id="L76">    List&lt;ExportRuleDto&gt; rulesToExport = db.qualityProfileExportDao().selectRulesByProfile(dbSession, profile);</span>
<span class="fc" id="L77">    rulesToExport.sort(BackupActiveRuleComparator.INSTANCE);</span>
<span class="fc" id="L78">    qProfileParser.writeXml(writer, profile, rulesToExport.iterator());</span>
<span class="fc" id="L79">  }</span>

  @Override
  public QProfileRestoreSummary copy(DbSession dbSession, QProfileDto from, QProfileDto to) {
<span class="fc" id="L83">    List&lt;ExportRuleDto&gt; rulesToExport = db.qualityProfileExportDao().selectRulesByProfile(dbSession, from);</span>
<span class="fc" id="L84">    rulesToExport.sort(BackupActiveRuleComparator.INSTANCE);</span>

<span class="fc" id="L86">    ImportedQProfile qProfile = toImportedQProfile(rulesToExport, to.getName(), to.getLanguage());</span>
<span class="fc" id="L87">    return restore(dbSession, qProfile, name -&gt; to);</span>
  }

  private static ImportedQProfile toImportedQProfile(List&lt;ExportRuleDto&gt; exportRules, String profileName, String profileLang) {
<span class="fc" id="L91">    List&lt;ImportedRule&gt; importedRules = new ArrayList&lt;&gt;(exportRules.size());</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">    for (ExportRuleDto exportRuleDto : exportRules) {</span>
<span class="fc" id="L94">      var ruleKey = exportRuleDto.getRuleKey();</span>
<span class="fc" id="L95">      ImportedRule importedRule = new ImportedRule();</span>
<span class="fc" id="L96">      importedRule.setName(exportRuleDto.getName());</span>
<span class="fc" id="L97">      importedRule.setRepository(ruleKey.repository());</span>
<span class="fc" id="L98">      importedRule.setKey(ruleKey.rule());</span>
<span class="fc" id="L99">      importedRule.setSeverity(exportRuleDto.getSeverityString());</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">      importedRule.setImpacts(exportRuleDto.getImpacts() != null ? parseImpactsToMap(exportRuleDto.getImpacts()) : Map.of());</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">      if (exportRuleDto.isCustomRule()) {</span>
<span class="fc" id="L102">        importedRule.setTemplate(exportRuleDto.getTemplateRuleKey().rule());</span>
<span class="fc" id="L103">        importedRule.setDescription(exportRuleDto.getDescriptionOrThrow());</span>
<span class="fc" id="L104">        importedRule.setCleanCodeAttribute(exportRuleDto.getCleanCodeAttribute());</span>
      }
<span class="fc" id="L106">      importedRule.setType(exportRuleDto.getRuleType().name());</span>
<span class="fc" id="L107">      importedRule.setParameters(exportRuleDto.getParams().stream().collect(Collectors.toMap(ExportRuleParamDto::getKey, ExportRuleParamDto::getValue)));</span>
<span class="fc" id="L108">      importedRules.add(importedRule);</span>
<span class="fc" id="L109">    }</span>

<span class="fc" id="L111">    return new ImportedQProfile(profileName, profileLang, importedRules);</span>
  }

  @Override
  public QProfileRestoreSummary restore(DbSession dbSession, Reader backup, @Nullable String overriddenProfileName) {
<span class="fc" id="L116">    return restore(dbSession, backup, nameInBackup -&gt; {</span>
<span class="fc" id="L117">      QProfileName targetName = nameInBackup;</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">      if (overriddenProfileName != null) {</span>
<span class="fc" id="L119">        targetName = new QProfileName(nameInBackup.getLanguage(), overriddenProfileName);</span>
      }
<span class="fc" id="L121">      return profileFactory.getOrCreateCustom(dbSession, targetName);</span>
    });
  }

  @Override
  public QProfileRestoreSummary restore(DbSession dbSession, Reader backup, QProfileDto profile) {
<span class="nc" id="L127">    return restore(dbSession, backup, nameInBackup -&gt; {</span>
<span class="nc" id="L128">      checkArgument(profile.getLanguage().equals(nameInBackup.getLanguage()),</span>
<span class="nc" id="L129">        &quot;Can't restore %s backup on %s profile with key [%s]. Languages are different.&quot;, nameInBackup.getLanguage(), profile.getLanguage(), profile.getKee());</span>
<span class="nc" id="L130">      return profile;</span>
    });
  }

  private QProfileRestoreSummary restore(DbSession dbSession, Reader backup, Function&lt;QProfileName, QProfileDto&gt; profileLoader) {
<span class="fc" id="L135">    ImportedQProfile qProfile = qProfileParser.readXml(backup);</span>
<span class="fc" id="L136">    return restore(dbSession, qProfile, profileLoader);</span>
  }

  private QProfileRestoreSummary restore(DbSession dbSession, ImportedQProfile qProfile, Function&lt;QProfileName, QProfileDto&gt; profileLoader) {
<span class="fc" id="L140">    QProfileName targetName = new QProfileName(qProfile.getProfileLang(), qProfile.getProfileName());</span>
<span class="fc" id="L141">    QProfileDto targetProfile = profileLoader.apply(targetName);</span>

<span class="fc" id="L143">    List&lt;ImportedRule&gt; importedRules = qProfile.getRules();</span>

<span class="fc" id="L145">    Map&lt;RuleKey, RuleDto&gt; ruleKeyToDto = getImportedRulesDtos(dbSession, importedRules);</span>
<span class="fc" id="L146">    checkIfRulesFromExternalEngines(ruleKeyToDto.values());</span>

<span class="fc" id="L148">    Map&lt;RuleKey, RuleDto&gt; customRulesDefinitions = createCustomRulesIfNotExist(dbSession, importedRules, ruleKeyToDto);</span>
<span class="fc" id="L149">    ruleKeyToDto.putAll(customRulesDefinitions);</span>

<span class="fc" id="L151">    List&lt;RuleActivation&gt; ruleActivations = toRuleActivations(importedRules, ruleKeyToDto);</span>

<span class="fc" id="L153">    BulkChangeResult changes = profileReset.reset(dbSession, targetProfile, ruleActivations);</span>
<span class="fc" id="L154">    return new QProfileRestoreSummary(targetProfile, changes);</span>
  }

  /**
   * Returns map of rule definition for an imported rule key.
   * The imported rule key may refer to a deprecated rule key, in which case the the RuleDto will correspond to a different key (the new key).
   */
  private Map&lt;RuleKey, RuleDto&gt; getImportedRulesDtos(DbSession dbSession, List&lt;ImportedRule&gt; rules) {
<span class="fc" id="L162">    Set&lt;RuleKey&gt; ruleKeys = rules.stream()</span>
<span class="fc" id="L163">      .map(ImportedRule::getRuleKey)</span>
<span class="fc" id="L164">      .collect(toSet());</span>
<span class="fc" id="L165">    Map&lt;RuleKey, RuleDto&gt; ruleDtos = db.ruleDao().selectByKeys(dbSession, ruleKeys).stream()</span>
<span class="fc" id="L166">      .collect(Collectors.toMap(RuleDto::getKey, identity()));</span>

<span class="fc" id="L168">    Set&lt;RuleKey&gt; unrecognizedRuleKeys = ruleKeys.stream()</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">      .filter(r -&gt; !ruleDtos.containsKey(r))</span>
<span class="fc" id="L170">      .collect(toSet());</span>

<span class="fc bfc" id="L172" title="All 2 branches covered.">    if (!unrecognizedRuleKeys.isEmpty()) {</span>
<span class="fc" id="L173">      Map&lt;String, DeprecatedRuleKeyDto&gt; deprecatedRuleKeysByUuid = db.ruleDao().selectAllDeprecatedRuleKeys(dbSession).stream()</span>
<span class="pc bpc" id="L174" title="2 of 4 branches missed.">        .filter(r -&gt; r.getNewRepositoryKey() != null &amp;&amp; r.getNewRuleKey() != null)</span>
<span class="fc" id="L175">        .filter(r -&gt; unrecognizedRuleKeys.contains(RuleKey.of(r.getOldRepositoryKey(), r.getOldRuleKey())))</span>
        // ignore deprecated rule if the new rule key was already found in the list of imported rules
<span class="fc bfc" id="L177" title="All 2 branches covered.">        .filter(r -&gt; !ruleKeys.contains(RuleKey.of(r.getNewRepositoryKey(), r.getNewRuleKey())))</span>
<span class="fc" id="L178">        .collect(Collectors.toMap(DeprecatedRuleKeyDto::getRuleUuid, identity()));</span>

<span class="fc" id="L180">      List&lt;RuleDto&gt; rulesBasedOnDeprecatedKeys = db.ruleDao().selectByUuids(dbSession, deprecatedRuleKeysByUuid.keySet());</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">      for (RuleDto rule : rulesBasedOnDeprecatedKeys) {</span>
<span class="fc" id="L182">        DeprecatedRuleKeyDto deprecatedRuleKey = deprecatedRuleKeysByUuid.get(rule.getUuid());</span>
<span class="fc" id="L183">        RuleKey oldRuleKey = RuleKey.of(deprecatedRuleKey.getOldRepositoryKey(), deprecatedRuleKey.getOldRuleKey());</span>
<span class="fc" id="L184">        ruleDtos.put(oldRuleKey, rule);</span>
<span class="fc" id="L185">      }</span>
    }

<span class="fc" id="L188">    return ruleDtos;</span>
  }

  private static void checkIfRulesFromExternalEngines(Collection&lt;RuleDto&gt; ruleDefinitions) {
<span class="fc" id="L192">    List&lt;RuleDto&gt; externalRules = ruleDefinitions.stream()</span>
<span class="fc" id="L193">      .filter(RuleDto::isExternal)</span>
<span class="fc" id="L194">      .toList();</span>

<span class="fc bfc" id="L196" title="All 2 branches covered.">    if (!externalRules.isEmpty()) {</span>
<span class="fc" id="L197">      throw new IllegalArgumentException(&quot;The quality profile cannot be restored as it contains rules from external rule engines: &quot;</span>
<span class="fc" id="L198">        + externalRules.stream().map(r -&gt; r.getKey().toString()).collect(Collectors.joining(&quot;, &quot;)));</span>
    }
<span class="fc" id="L200">  }</span>

  private Map&lt;RuleKey, RuleDto&gt; createCustomRulesIfNotExist(DbSession dbSession, List&lt;ImportedRule&gt; rules, Map&lt;RuleKey, RuleDto&gt; ruleDefinitionsByKey) {
<span class="fc" id="L203">    List&lt;NewCustomRule&gt; customRulesToCreate = rules.stream()</span>
<span class="fc bfc" id="L204" title="All 4 branches covered.">      .filter(r -&gt; ruleDefinitionsByKey.get(r.getRuleKey()) == null &amp;&amp; r.isCustomRule())</span>
<span class="fc" id="L205">      .map(QProfileBackuperImpl::importedRuleToNewCustomRule)</span>
<span class="fc" id="L206">      .toList();</span>

<span class="fc bfc" id="L208" title="All 2 branches covered.">    if (!customRulesToCreate.isEmpty()) {</span>
<span class="fc" id="L209">      return db.ruleDao().selectByKeys(dbSession, ruleCreator.restore(dbSession, customRulesToCreate).stream().map(RuleDto::getKey).toList())</span>
<span class="fc" id="L210">        .stream()</span>
<span class="fc" id="L211">        .collect(Collectors.toMap(RuleDto::getKey, identity()));</span>
    }
<span class="fc" id="L213">    return Collections.emptyMap();</span>
  }

  private static NewCustomRule importedRuleToNewCustomRule(ImportedRule r) {
<span class="fc" id="L217">    return NewCustomRule.createForCustomRule(r.getRuleKey(), r.getTemplateKey())</span>
<span class="fc" id="L218">      .setName(r.getName())</span>
<span class="fc" id="L219">      .setSeverity(r.getSeverity())</span>
<span class="pc" id="L220">      .setImpacts(r.getImpacts().entrySet().stream().map(i -&gt; new NewCustomRule.Impact(i.getKey(), i.getValue())).toList())</span>
<span class="fc" id="L221">      .setStatus(RuleStatus.READY)</span>
<span class="fc" id="L222">      .setPreventReactivation(true)</span>
<span class="fc" id="L223">      .setType(RuleType.valueOf(r.getType()))</span>
<span class="fc" id="L224">      .setMarkdownDescription(r.getDescription())</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">      .setCleanCodeAttribute(r.getCleanCodeAttribute() == null ? null : CleanCodeAttribute.valueOf(r.getCleanCodeAttribute()))</span>
<span class="fc" id="L226">      .setParameters(r.getParameters());</span>
  }

  private static List&lt;RuleActivation&gt; toRuleActivations(List&lt;ImportedRule&gt; rules, Map&lt;RuleKey, RuleDto&gt; ruleDefinitionsByKey) {
<span class="fc" id="L230">    List&lt;RuleActivation&gt; activatedRule = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L232" title="All 2 branches covered.">    for (ImportedRule r : rules) {</span>
<span class="fc" id="L233">      RuleDto ruleDto = ruleDefinitionsByKey.get(r.getRuleKey());</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">      if (ruleDto == null) {</span>
<span class="fc" id="L235">        continue;</span>
      }
<span class="fc" id="L237">      activatedRule.add(RuleActivation.create(</span>
<span class="fc" id="L238">        ruleDto.getUuid(),</span>
<span class="fc" id="L239">        r.getSeverity(),</span>
<span class="fc" id="L240">        r.getImpacts(),</span>
<span class="fc" id="L241">        r.getPrioritizedRule(),</span>
<span class="fc" id="L242">        r.getParameters()));</span>
<span class="fc" id="L243">    }</span>
<span class="fc" id="L244">    return activatedRule;</span>
  }

<span class="fc" id="L247">  private enum BackupActiveRuleComparator implements Comparator&lt;ExportRuleDto&gt; {</span>
<span class="fc" id="L248">    INSTANCE;</span>

    @Override
    public int compare(ExportRuleDto o1, ExportRuleDto o2) {
<span class="nc" id="L252">      RuleKey rk1 = o1.getRuleKey();</span>
<span class="nc" id="L253">      RuleKey rk2 = o2.getRuleKey();</span>
<span class="nc" id="L254">      return new CompareToBuilder()</span>
<span class="nc" id="L255">        .append(rk1.repository(), rk2.repository())</span>
<span class="nc" id="L256">        .append(rk1.rule(), rk2.rule())</span>
<span class="nc" id="L257">        .toComparison();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>