<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.qualityprofile.ws</a> &gt; <span class="el_source">SearchAction.java</span></div><h1>SearchAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.qualityprofile.ws;

import java.util.Arrays;
import java.util.Collection;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.function.Predicate;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.resources.Language;
import org.sonar.api.resources.Languages;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.NewAction;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.project.ProjectDto;
import org.sonar.db.qualityprofile.ActiveRuleCountQuery;
import org.sonar.db.qualityprofile.QProfileDto;
import org.sonar.db.user.UserDto;
import org.sonar.server.component.ComponentFinder;
import org.sonar.server.language.LanguageParamUtils;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Qualityprofiles.SearchWsResponse;
import org.sonarqube.ws.Qualityprofiles.SearchWsResponse.QualityProfile;

import static com.google.common.base.Preconditions.checkState;
import static java.lang.String.format;
import static java.util.Collections.emptyList;
import static java.util.Optional.ofNullable;
import static java.util.function.Function.identity;
import static org.sonar.api.rule.RuleStatus.DEPRECATED;
import static org.sonar.api.utils.DateUtils.formatDateTime;
import static org.sonar.db.permission.GlobalPermission.ADMINISTER_QUALITY_PROFILES;
import static org.sonar.server.ws.KeyExamples.KEY_PROJECT_EXAMPLE_001;
import static org.sonar.server.ws.WsUtils.writeProtobuf;
import static org.sonarqube.ws.client.qualityprofile.QualityProfileWsParameters.ACTION_SEARCH;
import static org.sonarqube.ws.client.qualityprofile.QualityProfileWsParameters.PARAM_DEFAULTS;
import static org.sonarqube.ws.client.qualityprofile.QualityProfileWsParameters.PARAM_LANGUAGE;
import static org.sonarqube.ws.client.qualityprofile.QualityProfileWsParameters.PARAM_PROJECT;
import static org.sonarqube.ws.client.qualityprofile.QualityProfileWsParameters.PARAM_QUALITY_PROFILE;

public class SearchAction implements QProfileWsAction {
<span class="fc" id="L70">  private static final Comparator&lt;QProfileDto&gt; Q_PROFILE_COMPARATOR = Comparator</span>
<span class="fc" id="L71">    .comparing(QProfileDto::getLanguage)</span>
<span class="fc" id="L72">    .thenComparing(QProfileDto::getName);</span>

  private final UserSession userSession;
  private final Languages languages;
  private final DbClient dbClient;
  private final ComponentFinder componentFinder;

<span class="fc" id="L79">  public SearchAction(UserSession userSession, Languages languages, DbClient dbClient, ComponentFinder componentFinder) {</span>
<span class="fc" id="L80">    this.userSession = userSession;</span>
<span class="fc" id="L81">    this.languages = languages;</span>
<span class="fc" id="L82">    this.dbClient = dbClient;</span>
<span class="fc" id="L83">    this.componentFinder = componentFinder;</span>
<span class="fc" id="L84">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L88">    NewAction action = controller.createAction(ACTION_SEARCH)</span>
<span class="fc" id="L89">      .setSince(&quot;5.2&quot;)</span>
<span class="fc" id="L90">      .setDescription(&quot;Search quality profiles&quot;)</span>
<span class="fc" id="L91">      .setHandler(this)</span>
<span class="fc" id="L92">      .setChangelog(</span>
<span class="fc" id="L93">        new Change(&quot;6.5&quot;, format(&quot;The parameters '%s', '%s' and '%s' can be combined without any constraint&quot;, PARAM_DEFAULTS, PARAM_PROJECT, PARAM_LANGUAGE)),</span>
        new Change(&quot;6.6&quot;, &quot;Add available actions 'edit', 'copy' and 'setAsDefault' and global action 'create'&quot;),
        new Change(&quot;7.0&quot;, &quot;Add available actions 'delete' and 'associateProjects'&quot;),
        new Change(&quot;10.0&quot;, &quot;Remove deprecated parameter 'project_key'. Please use 'project' instead.&quot;))
<span class="fc" id="L97">      .setResponseExample(getClass().getResource(&quot;search-example.json&quot;));</span>

<span class="fc" id="L99">    action</span>
<span class="fc" id="L100">      .createParam(PARAM_DEFAULTS)</span>
<span class="fc" id="L101">      .setDescription(&quot;If set to true, return only the quality profiles marked as default for each language&quot;)</span>
<span class="fc" id="L102">      .setDefaultValue(false)</span>
<span class="fc" id="L103">      .setBooleanPossibleValues();</span>

<span class="fc" id="L105">    action.createParam(PARAM_PROJECT)</span>
<span class="fc" id="L106">      .setDescription(&quot;Project key&quot;)</span>
<span class="fc" id="L107">      .setExampleValue(KEY_PROJECT_EXAMPLE_001);</span>

<span class="fc" id="L109">    action</span>
<span class="fc" id="L110">      .createParam(PARAM_LANGUAGE)</span>
<span class="fc" id="L111">      .setDescription(&quot;Language key. If provided, only profiles for the given language are returned.&quot;)</span>
<span class="fc" id="L112">      .setPossibleValues(LanguageParamUtils.getOrderedLanguageKeys(languages));</span>

<span class="fc" id="L114">    action.createParam(PARAM_QUALITY_PROFILE)</span>
<span class="fc" id="L115">      .setDescription(&quot;Quality profile name&quot;)</span>
<span class="fc" id="L116">      .setExampleValue(&quot;SonarQube Way&quot;);</span>
<span class="fc" id="L117">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L121">    SearchWsResponse searchWsResponse = doHandle(toSearchWsRequest(request));</span>
<span class="fc" id="L122">    writeProtobuf(searchWsResponse, request, response);</span>
<span class="fc" id="L123">  }</span>

  private static SearchRequest toSearchWsRequest(Request request) {
<span class="fc" id="L126">    return new SearchRequest()</span>
<span class="fc" id="L127">      .setProjectKey(request.param(PARAM_PROJECT))</span>
<span class="fc" id="L128">      .setQualityProfile(request.param(PARAM_QUALITY_PROFILE))</span>
<span class="fc" id="L129">      .setDefaults(request.paramAsBoolean(PARAM_DEFAULTS))</span>
<span class="fc" id="L130">      .setLanguage(request.param(PARAM_LANGUAGE));</span>
  }

  private SearchWsResponse doHandle(SearchRequest request) {
<span class="fc" id="L134">    SearchData data = load(request);</span>
<span class="fc" id="L135">    return buildResponse(data);</span>
  }

  private SearchData load(SearchRequest request) {
<span class="fc" id="L139">    try (DbSession dbSession = dbClient.openSession(false)) {</span>

<span class="fc" id="L141">      ProjectDto project = findProject(dbSession, request);</span>
<span class="fc" id="L142">      List&lt;QProfileDto&gt; defaultProfiles = dbClient.qualityProfileDao().selectDefaultProfiles(dbSession, getLanguageKeys());</span>
<span class="fc" id="L143">      List&lt;String&gt; editableProfiles = searchEditableProfiles(dbSession);</span>
<span class="fc" id="L144">      List&lt;QProfileDto&gt; profiles = searchProfiles(dbSession, request, defaultProfiles, project);</span>

<span class="fc" id="L146">      ActiveRuleCountQuery.Builder builder = ActiveRuleCountQuery.builder();</span>
<span class="fc" id="L147">      return new SearchData()</span>
<span class="fc" id="L148">        .setProfiles(profiles)</span>
<span class="fc" id="L149">        .setActiveRuleCountByProfileKey(</span>
<span class="fc" id="L150">          dbClient.activeRuleDao().countActiveRulesByQuery(dbSession, builder.setProfiles(profiles).build()))</span>
<span class="fc" id="L151">        .setActiveDeprecatedRuleCountByProfileKey(</span>
<span class="fc" id="L152">          dbClient.activeRuleDao().countActiveRulesByQuery(dbSession, builder.setProfiles(profiles).setRuleStatus(DEPRECATED).build()))</span>
<span class="fc" id="L153">        .setProjectCountByProfileKey(dbClient.qualityProfileDao().countProjectsByProfiles(dbSession, profiles))</span>
<span class="fc" id="L154">        .setDefaultProfileKeys(defaultProfiles)</span>
<span class="fc" id="L155">        .setEditableProfileKeys(editableProfiles);</span>
    }
  }

  @CheckForNull
  private ProjectDto findProject(DbSession dbSession, SearchRequest request) {
<span class="fc bfc" id="L161" title="All 2 branches covered.">    if (request.getProjectKey() == null) {</span>
<span class="fc" id="L162">      return null;</span>
    }

<span class="fc" id="L165">    return componentFinder.getProjectByKey(dbSession, request.getProjectKey());</span>
  }

  private List&lt;String&gt; searchEditableProfiles(DbSession dbSession) {
<span class="fc bfc" id="L169" title="All 2 branches covered.">    if (!userSession.isLoggedIn()) {</span>
<span class="fc" id="L170">      return emptyList();</span>
    }

<span class="fc" id="L173">    String login = userSession.getLogin();</span>
<span class="fc" id="L174">    UserDto user = dbClient.userDao().selectActiveUserByLogin(dbSession, login);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">    checkState(user != null, &quot;User with login '%s' is not found'&quot;, login);</span>

<span class="fc" id="L177">    return Stream.concat(</span>
<span class="fc" id="L178">      dbClient.qProfileEditUsersDao().selectQProfileUuidsByUser(dbSession, user).stream(),</span>
<span class="fc" id="L179">      dbClient.qProfileEditGroupsDao().selectQProfileUuidsByGroups(dbSession, userSession.getGroups()).stream())</span>
<span class="fc" id="L180">      .toList();</span>
  }

  private List&lt;QProfileDto&gt; searchProfiles(DbSession dbSession, SearchRequest request, List&lt;QProfileDto&gt; defaultProfiles, @Nullable ProjectDto project) {
<span class="fc" id="L184">    Collection&lt;QProfileDto&gt; profiles = selectAllProfiles(dbSession);</span>

<span class="fc" id="L186">    return profiles.stream()</span>
<span class="fc" id="L187">      .filter(hasLanguagePlugin())</span>
<span class="fc" id="L188">      .filter(byLanguage(request))</span>
<span class="fc" id="L189">      .filter(byName(request))</span>
<span class="fc" id="L190">      .filter(byDefault(request, defaultProfiles))</span>
<span class="fc" id="L191">      .filter(byProject(dbSession, project, defaultProfiles))</span>
<span class="fc" id="L192">      .sorted(Q_PROFILE_COMPARATOR)</span>
<span class="fc" id="L193">      .toList();</span>
  }

  private Predicate&lt;QProfileDto&gt; hasLanguagePlugin() {
<span class="fc bfc" id="L197" title="All 2 branches covered.">    return p -&gt; languages.get(p.getLanguage()) != null;</span>
  }

  private static Predicate&lt;QProfileDto&gt; byName(SearchRequest request) {
<span class="fc bfc" id="L201" title="All 4 branches covered.">    return p -&gt; request.getQualityProfile() == null || Objects.equals(p.getName(), request.getQualityProfile());</span>
  }

  private static Predicate&lt;QProfileDto&gt; byLanguage(SearchRequest request) {
<span class="fc bfc" id="L205" title="All 4 branches covered.">    return p -&gt; request.getLanguage() == null || Objects.equals(p.getLanguage(), request.getLanguage());</span>
  }

  private static Predicate&lt;QProfileDto&gt; byDefault(SearchRequest request, List&lt;QProfileDto&gt; defaultProfiles) {
<span class="fc" id="L209">    Set&lt;String&gt; defaultProfileUuids = defaultProfiles.stream().map(QProfileDto::getKee).collect(Collectors.toSet());</span>
<span class="fc bfc" id="L210" title="All 4 branches covered.">    return p -&gt; !request.getDefaults() || defaultProfileUuids.contains(p.getKee());</span>
  }

  private Predicate&lt;QProfileDto&gt; byProject(DbSession dbSession, @Nullable ProjectDto project, List&lt;QProfileDto&gt; defaultProfiles) {
<span class="fc bfc" id="L214" title="All 2 branches covered.">    if (project == null) {</span>
<span class="fc" id="L215">      return p -&gt; true;</span>
    }
<span class="fc" id="L217">    Map&lt;String, QProfileDto&gt; effectiveProfiles = defaultProfiles.stream().collect(Collectors.toMap(QProfileDto::getLanguage, identity()));</span>
<span class="fc" id="L218">    effectiveProfiles.putAll(dbClient.qualityProfileDao().selectAssociatedToProjectAndLanguages(dbSession, project, getLanguageKeys()).stream()</span>
<span class="fc" id="L219">      .collect(Collectors.toMap(QProfileDto::getLanguage, identity())));</span>
<span class="fc" id="L220">    return p -&gt; Objects.equals(p.getKee(), effectiveProfiles.get(p.getLanguage()).getKee());</span>
  }

  private Collection&lt;QProfileDto&gt; selectAllProfiles(DbSession dbSession) {
<span class="fc" id="L224">    return dbClient.qualityProfileDao().selectAll(dbSession);</span>
  }

  private Set&lt;String&gt; getLanguageKeys() {
<span class="fc" id="L228">    return Arrays.stream(languages.all()).map(Language::getKey).collect(Collectors.toSet());</span>
  }

  private SearchWsResponse buildResponse(SearchData data) {
<span class="fc" id="L232">    List&lt;QProfileDto&gt; profiles = data.getProfiles();</span>
<span class="fc" id="L233">    Map&lt;String, QProfileDto&gt; profilesByKey = profiles.stream().collect(Collectors.toMap(QProfileDto::getKee, identity()));</span>
<span class="fc" id="L234">    boolean isGlobalQProfileAdmin = userSession.hasPermission(ADMINISTER_QUALITY_PROFILES);</span>

<span class="fc" id="L236">    SearchWsResponse.Builder response = SearchWsResponse.newBuilder();</span>
<span class="fc" id="L237">    response.setActions(SearchWsResponse.Actions.newBuilder().setCreate(isGlobalQProfileAdmin));</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">    for (QProfileDto profile : profiles) {</span>
<span class="fc" id="L239">      QualityProfile.Builder profileBuilder = response.addProfilesBuilder();</span>

<span class="fc" id="L241">      String profileKey = profile.getKee();</span>
<span class="fc" id="L242">      profileBuilder.setKey(profileKey);</span>
<span class="fc" id="L243">      ofNullable(profile.getName()).ifPresent(profileBuilder::setName);</span>
<span class="fc" id="L244">      ofNullable(profile.getRulesUpdatedAt()).ifPresent(profileBuilder::setRulesUpdatedAt);</span>
<span class="fc" id="L245">      ofNullable(profile.getLastUsed()).ifPresent(last -&gt; profileBuilder.setLastUsed(formatDateTime(last)));</span>
<span class="fc" id="L246">      ofNullable(profile.getUserUpdatedAt()).ifPresent(userUpdatedAt -&gt; profileBuilder.setUserUpdatedAt(formatDateTime(userUpdatedAt)));</span>
<span class="fc" id="L247">      profileBuilder.setActiveRuleCount(data.getActiveRuleCount(profileKey));</span>
<span class="fc" id="L248">      profileBuilder.setActiveDeprecatedRuleCount(data.getActiveDeprecatedRuleCount(profileKey));</span>
<span class="fc" id="L249">      boolean isDefault = data.isDefault(profile);</span>
<span class="fc" id="L250">      profileBuilder.setIsDefault(isDefault);</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">      if (!isDefault) {</span>
<span class="fc" id="L252">        profileBuilder.setProjectCount(data.getProjectCount(profileKey));</span>
      }

<span class="fc" id="L255">      writeLanguageFields(profileBuilder, profile);</span>
<span class="fc" id="L256">      writeParentFields(profileBuilder, profile, profilesByKey);</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">      profileBuilder.setIsInherited(profile.getParentKee() != null);</span>
<span class="fc" id="L258">      profileBuilder.setIsBuiltIn(profile.isBuiltIn());</span>

<span class="fc" id="L260">      profileBuilder.setActions(SearchWsResponse.QualityProfile.Actions.newBuilder()</span>
<span class="fc bfc" id="L261" title="All 10 branches covered.">        .setEdit(!profile.isBuiltIn() &amp;&amp; (isGlobalQProfileAdmin || data.isEditable(profile)))</span>
<span class="fc" id="L262">        .setSetAsDefault(!isDefault &amp;&amp; isGlobalQProfileAdmin)</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        .setCopy(isGlobalQProfileAdmin)</span>
<span class="fc bfc" id="L264" title="All 8 branches covered.">        .setDelete(!isDefault &amp;&amp; !profile.isBuiltIn() &amp;&amp; isGlobalQProfileAdmin)</span>
<span class="fc" id="L265">        .setAssociateProjects(!isDefault &amp;&amp; isGlobalQProfileAdmin));</span>
<span class="fc" id="L266">    }</span>
<span class="fc" id="L267">    return response.build();</span>
  }

  private void writeLanguageFields(QualityProfile.Builder profileBuilder, QProfileDto profile) {
<span class="fc" id="L271">    String languageKey = profile.getLanguage();</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">    if (languageKey == null) {</span>
<span class="nc" id="L273">      return;</span>
    }

<span class="fc" id="L276">    profileBuilder.setLanguage(languageKey);</span>
<span class="fc" id="L277">    String languageName = languages.get(languageKey).getName();</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">    if (languageName != null) {</span>
<span class="fc" id="L279">      profileBuilder.setLanguageName(languageName);</span>
    }
<span class="fc" id="L281">  }</span>

  private static void writeParentFields(QualityProfile.Builder profileBuilder, QProfileDto profile, Map&lt;String, QProfileDto&gt; profilesByKey) {
<span class="fc" id="L284">    String parentKey = profile.getParentKee();</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">    if (parentKey == null) {</span>
<span class="fc" id="L286">      return;</span>
    }

<span class="fc" id="L289">    profileBuilder.setParentKey(parentKey);</span>
<span class="fc" id="L290">    QProfileDto parent = profilesByKey.get(parentKey);</span>
<span class="pc bpc" id="L291" title="2 of 4 branches missed.">    if (parent != null &amp;&amp; parent.getName() != null) {</span>
<span class="fc" id="L292">      profileBuilder.setParentName(parent.getName());</span>
    }
<span class="fc" id="L294">  }</span>

  private static class SearchRequest {
    private boolean defaults;
    private String language;
    private String qualityProfile;
    private String projectKey;

    public boolean getDefaults() {
<span class="fc" id="L303">      return defaults;</span>
    }

    public SearchRequest setDefaults(boolean defaults) {
<span class="fc" id="L307">      this.defaults = defaults;</span>
<span class="fc" id="L308">      return this;</span>
    }

    @CheckForNull
    public String getLanguage() {
<span class="fc" id="L313">      return language;</span>
    }

    public SearchRequest setLanguage(@Nullable String language) {
<span class="fc" id="L317">      this.language = language;</span>
<span class="fc" id="L318">      return this;</span>
    }

    @CheckForNull
    public String getQualityProfile() {
<span class="fc" id="L323">      return qualityProfile;</span>
    }

    public SearchRequest setQualityProfile(@Nullable String qualityProfile) {
<span class="fc" id="L327">      this.qualityProfile = qualityProfile;</span>
<span class="fc" id="L328">      return this;</span>
    }

    @CheckForNull
    public String getProjectKey() {
<span class="fc" id="L333">      return projectKey;</span>
    }

    public SearchRequest setProjectKey(@Nullable String projectKey) {
<span class="fc" id="L337">      this.projectKey = projectKey;</span>
<span class="fc" id="L338">      return this;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>