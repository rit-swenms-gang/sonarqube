<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IssueDto.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.db.issue</a> &gt; <span class="el_source">IssueDto.java</span></div><h1>IssueDto.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.db.issue;

import com.google.common.base.Joiner;
import com.google.common.base.Preconditions;
import com.google.common.base.Splitter;
import com.google.common.collect.ImmutableSet;
import com.google.protobuf.InvalidProtocolBufferException;
import java.io.Serializable;
import java.util.Collection;
import java.util.Date;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.apache.commons.lang3.builder.ToStringBuilder;
import org.apache.commons.lang3.builder.ToStringStyle;
import org.sonar.api.issue.IssueStatus;
import org.sonar.api.issue.impact.Severity;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.core.rule.RuleType;
import org.sonar.api.utils.Duration;
import org.sonar.core.issue.DefaultIssue;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.protobuf.DbIssues;
import org.sonar.db.rule.RuleDto;

import static com.google.common.base.Preconditions.checkArgument;
import static java.lang.String.format;
import static java.util.stream.Collectors.toUnmodifiableMap;
import static org.sonar.api.utils.DateUtils.dateToLong;
import static org.sonar.api.utils.DateUtils.longToDate;

public final class IssueDto implements Serializable {

  public static final int AUTHOR_MAX_SIZE = 255;
  private static final char STRING_LIST_SEPARATOR = ',';
<span class="fc" id="L62">  private static final Joiner STRING_LIST_JOINER = Joiner.on(STRING_LIST_SEPARATOR).skipNulls();</span>
<span class="fc" id="L63">  private static final Splitter STRING_LIST_SPLITTER = Splitter.on(STRING_LIST_SEPARATOR).trimResults().omitEmptyStrings();</span>

  private int type;
  private String kee;
  private String componentUuid;
  private String projectUuid;
  private String ruleUuid;
  private String severity;
  private boolean manualSeverity;
  private String message;
  private byte[] messageFormattings;
  private Integer line;
  private Double gap;
  private Long effort;
  private String status;
  private String resolution;
  private String checksum;
  private String assigneeUuid;
  private String assigneeLogin;
  private String authorLogin;
  private String securityStandards;
  private byte[] locations;
  private long createdAt;
  private long updatedAt;
  private boolean quickFixAvailable;
  private boolean isNewCodeReferenceIssue;
  private String ruleDescriptionContextKey;
  private boolean prioritizedRule;
  private boolean fromSonarQubeUpdate;

  // functional dates stored as Long
  private Long issueCreationDate;
  private Long issueUpdateDate;
  private Long issueCloseDate;

  /**
   * Temporary date used only during scan
   */
  private Long selectedAt;

  // joins
  private String ruleKey;
  private String ruleRepo;
  private boolean isExternal;
  private String language;
  private String componentKey;
  private String projectKey;
  private String filePath;
  private String tags;
  private String codeVariants;
  // populate only when retrieving closed issue for issue tracking
  private String closedChangeData;

<span class="fc" id="L116">  private Set&lt;ImpactDto&gt; impacts = new LinkedHashSet&lt;&gt;();</span>

  // non-persisted fields
<span class="fc" id="L119">  private Set&lt;ImpactDto&gt; ruleDefaultImpacts = new LinkedHashSet&lt;&gt;();</span>
  private CleanCodeAttribute cleanCodeAttribute;
  private CleanCodeAttribute ruleCleanCodeAttribute;

<span class="fc" id="L123">  public IssueDto() {</span>
    // nothing to do
<span class="fc" id="L125">  }</span>

  /**
   * On batch side, component keys and uuid are useless
   */
  public static IssueDto toDtoForComputationInsert(DefaultIssue issue, String ruleUuid, long now) {
<span class="fc" id="L131">    IssueDto issueDto = new IssueDto()</span>
<span class="fc" id="L132">      .setKee(issue.key())</span>
<span class="fc" id="L133">      .setType(issue.type())</span>
<span class="fc" id="L134">      .setLine(issue.line())</span>
<span class="fc" id="L135">      .setLocations((DbIssues.Locations) issue.getLocations())</span>
<span class="fc" id="L136">      .setMessage(issue.message())</span>
<span class="fc" id="L137">      .setMessageFormattings((DbIssues.MessageFormattings) issue.getMessageFormattings())</span>
<span class="fc" id="L138">      .setGap(issue.gap())</span>
<span class="fc" id="L139">      .setEffort(issue.effortInMinutes())</span>
<span class="fc" id="L140">      .setResolution(issue.resolution())</span>
<span class="fc" id="L141">      .setStatus(issue.status())</span>
<span class="fc" id="L142">      .setSeverity(issue.severity())</span>
<span class="fc" id="L143">      .setManualSeverity(issue.manualSeverity())</span>
<span class="fc" id="L144">      .setChecksum(issue.checksum())</span>
<span class="fc" id="L145">      .setAssigneeUuid(issue.assignee())</span>
<span class="fc" id="L146">      .setRuleUuid(ruleUuid)</span>
<span class="fc" id="L147">      .setRuleKey(issue.ruleKey().repository(), issue.ruleKey().rule())</span>
<span class="fc" id="L148">      .setExternal(issue.isFromExternalRuleEngine())</span>
<span class="fc" id="L149">      .setTags(issue.tags())</span>
<span class="fc" id="L150">      .setRuleDescriptionContextKey(issue.getRuleDescriptionContextKey().orElse(null))</span>
<span class="fc" id="L151">      .setComponentUuid(issue.componentUuid())</span>
<span class="fc" id="L152">      .setComponentKey(issue.componentKey())</span>
<span class="fc" id="L153">      .setProjectUuid(issue.projectUuid())</span>
<span class="fc" id="L154">      .setProjectKey(issue.projectKey())</span>
<span class="fc" id="L155">      .setAuthorLogin(issue.authorLogin())</span>
<span class="fc" id="L156">      .setIssueCreationDate(issue.creationDate())</span>
<span class="fc" id="L157">      .setIssueCloseDate(issue.closeDate())</span>
<span class="fc" id="L158">      .setIssueUpdateDate(issue.updateDate())</span>
<span class="fc" id="L159">      .setSelectedAt(issue.selectedAt())</span>
<span class="fc" id="L160">      .setQuickFixAvailable(issue.isQuickFixAvailable())</span>
<span class="fc" id="L161">      .setIsNewCodeReferenceIssue(issue.isNewCodeReferenceIssue())</span>
<span class="fc" id="L162">      .setCodeVariants(issue.codeVariants())</span>
<span class="fc" id="L163">      .setCleanCodeAttribute(issue.getCleanCodeAttribute())</span>
<span class="fc" id="L164">      .setPrioritizedRule(issue.isPrioritizedRule())</span>
<span class="fc" id="L165">      .setFromSonarQubeUpdate(issue.isFromSonarQubeUpdate())</span>
      // technical dates
<span class="fc" id="L167">      .setCreatedAt(now)</span>
<span class="fc" id="L168">      .setUpdatedAt(now);</span>

<span class="fc" id="L170">    issue.getImpacts().forEach(i -&gt; issueDto.addImpact(new ImpactDto(i.softwareQuality(), i.severity(), i.manualSeverity())));</span>
<span class="fc" id="L171">    return issueDto;</span>
  }

  /**
   * On server side, we need component keys and uuid
   */
  public static IssueDto toDtoForServerInsert(DefaultIssue issue, ComponentDto component, ComponentDto project, String ruleUuid, long now) {
<span class="fc" id="L178">    return toDtoForComputationInsert(issue, ruleUuid, now)</span>
<span class="fc" id="L179">      .setComponent(component)</span>
<span class="fc" id="L180">      .setProject(project);</span>
  }

  public static IssueDto toDtoForUpdate(DefaultIssue issue, long now) {
    // Invariant fields, like key and rule, can't be updated
<span class="fc" id="L185">    IssueDto issueDto = new IssueDto()</span>
<span class="fc" id="L186">      .setKee(issue.key())</span>
<span class="fc" id="L187">      .setType(issue.type())</span>
<span class="fc" id="L188">      .setLine(issue.line())</span>
<span class="fc" id="L189">      .setLocations((DbIssues.Locations) issue.getLocations())</span>
<span class="fc" id="L190">      .setMessage(issue.message())</span>
<span class="fc" id="L191">      .setMessageFormattings((DbIssues.MessageFormattings) issue.getMessageFormattings())</span>
<span class="fc" id="L192">      .setGap(issue.gap())</span>
<span class="fc" id="L193">      .setEffort(issue.effortInMinutes())</span>
<span class="fc" id="L194">      .setResolution(issue.resolution())</span>
<span class="fc" id="L195">      .setStatus(issue.status())</span>
<span class="fc" id="L196">      .setSeverity(issue.severity())</span>
<span class="fc" id="L197">      .setChecksum(issue.checksum())</span>
<span class="fc" id="L198">      .setManualSeverity(issue.manualSeverity())</span>
<span class="fc" id="L199">      .setAssigneeUuid(issue.assignee())</span>
<span class="fc" id="L200">      .setAuthorLogin(issue.authorLogin())</span>
<span class="fc" id="L201">      .setRuleKey(issue.ruleKey().repository(), issue.ruleKey().rule())</span>
<span class="fc" id="L202">      .setExternal(issue.isFromExternalRuleEngine())</span>
<span class="fc" id="L203">      .setTags(issue.tags())</span>
<span class="fc" id="L204">      .setRuleDescriptionContextKey(issue.getRuleDescriptionContextKey().orElse(null))</span>
<span class="fc" id="L205">      .setComponentUuid(issue.componentUuid())</span>
<span class="fc" id="L206">      .setComponentKey(issue.componentKey())</span>
<span class="fc" id="L207">      .setProjectUuid(issue.projectUuid())</span>
<span class="fc" id="L208">      .setProjectKey(issue.projectKey())</span>
<span class="fc" id="L209">      .setIssueCreationDate(issue.creationDate())</span>
<span class="fc" id="L210">      .setIssueCloseDate(issue.closeDate())</span>
<span class="fc" id="L211">      .setIssueUpdateDate(issue.updateDate())</span>
<span class="fc" id="L212">      .setSelectedAt(issue.selectedAt())</span>
<span class="fc" id="L213">      .setQuickFixAvailable(issue.isQuickFixAvailable())</span>
<span class="fc" id="L214">      .setIsNewCodeReferenceIssue(issue.isNewCodeReferenceIssue())</span>
<span class="fc" id="L215">      .setCodeVariants(issue.codeVariants())</span>
<span class="fc" id="L216">      .setCleanCodeAttribute(issue.getCleanCodeAttribute())</span>
<span class="fc" id="L217">      .setPrioritizedRule(issue.isPrioritizedRule())</span>
<span class="fc" id="L218">      .setFromSonarQubeUpdate(issue.isFromSonarQubeUpdate())</span>
      // technical date
<span class="fc" id="L220">      .setUpdatedAt(now);</span>

<span class="fc" id="L222">    issue.getImpacts().forEach(i -&gt; issueDto.addImpact(new ImpactDto(i.softwareQuality(), i.severity(), i.manualSeverity())));</span>
<span class="fc" id="L223">    return issueDto;</span>

  }

  public String getKey() {
<span class="fc" id="L228">    return getKee();</span>
  }

  public String getKee() {
<span class="fc" id="L232">    return kee;</span>
  }

  public IssueDto setKee(String s) {
<span class="fc" id="L236">    this.kee = s;</span>
<span class="fc" id="L237">    return this;</span>
  }

  public IssueDto setComponent(ComponentDto component) {
<span class="fc" id="L241">    this.componentKey = component.getKey();</span>
<span class="fc" id="L242">    this.componentUuid = component.uuid();</span>
<span class="fc" id="L243">    this.filePath = component.path();</span>
<span class="fc" id="L244">    return this;</span>
  }

  /**
   * The project branch where the issue is located.
   * Note that the name is misleading - it should be branch.
   */
  public IssueDto setProject(ComponentDto branch) {
<span class="fc" id="L252">    this.projectKey = branch.getKey();</span>
<span class="fc" id="L253">    this.projectUuid = branch.uuid();</span>
<span class="fc" id="L254">    return this;</span>
  }

  public String getRuleUuid() {
<span class="fc" id="L258">    return ruleUuid;</span>
  }

  /**
   * please use setRule(RuleDto rule)
   */
  public IssueDto setRuleUuid(String ruleUuid) {
<span class="fc" id="L265">    this.ruleUuid = ruleUuid;</span>
<span class="fc" id="L266">    return this;</span>
  }

  @CheckForNull
  public String getSeverity() {
<span class="fc" id="L271">    return severity;</span>
  }

  public IssueDto setSeverity(@Nullable String s) {
<span class="pc bpc" id="L275" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 10, &quot;Value is too long for issue severity: %s&quot;, s);</span>
<span class="fc" id="L276">    this.severity = s;</span>
<span class="fc" id="L277">    return this;</span>
  }

  public boolean isManualSeverity() {
<span class="fc" id="L281">    return manualSeverity;</span>
  }

  public IssueDto setManualSeverity(boolean manualSeverity) {
<span class="fc" id="L285">    this.manualSeverity = manualSeverity;</span>
<span class="fc" id="L286">    return this;</span>
  }

  @CheckForNull
  public String getMessage() {
<span class="fc" id="L291">    return message;</span>
  }

  public IssueDto setMessage(@Nullable String s) {
<span class="pc bpc" id="L295" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 4000, &quot;Value is too long for issue message: %s&quot;, s);</span>
<span class="fc" id="L296">    this.message = s;</span>
<span class="fc" id="L297">    return this;</span>
  }

  public byte[] getMessageFormattings() {
<span class="fc" id="L301">    return messageFormattings;</span>
  }

  public IssueDto setMessageFormattings(byte[] messageFormattings) {
<span class="fc" id="L305">    this.messageFormattings = messageFormattings;</span>
<span class="fc" id="L306">    return this;</span>
  }

  public IssueDto setMessageFormattings(@Nullable DbIssues.MessageFormattings messageFormattings) {
<span class="fc bfc" id="L310" title="All 2 branches covered.">    if (messageFormattings == null) {</span>
<span class="fc" id="L311">      this.messageFormattings = null;</span>
    } else {
<span class="fc" id="L313">      this.messageFormattings = messageFormattings.toByteArray();</span>
    }
<span class="fc" id="L315">    return this;</span>
  }

  @CheckForNull
  public DbIssues.MessageFormattings parseMessageFormattings() {
<span class="fc bfc" id="L320" title="All 2 branches covered.">    if (messageFormattings != null) {</span>
      try {
<span class="fc" id="L322">        return DbIssues.MessageFormattings.parseFrom(messageFormattings);</span>
<span class="nc" id="L323">      } catch (InvalidProtocolBufferException e) {</span>
<span class="nc" id="L324">        throw new IllegalStateException(format(&quot;Fail to read ISSUES.MESSAGE_FORMATTINGS [KEE=%s]&quot;, kee), e);</span>
      }
    }
<span class="fc" id="L327">    return null;</span>
  }

  @CheckForNull
  public Integer getLine() {
<span class="fc" id="L332">    return line;</span>
  }

  public IssueDto setLine(@Nullable Integer i) {
<span class="pc bpc" id="L336" title="1 of 4 branches missed.">    checkArgument(i == null || i &gt;= 0, &quot;Value of issue line must be positive: %d&quot;, i);</span>
<span class="fc" id="L337">    this.line = i;</span>
<span class="fc" id="L338">    return this;</span>
  }

  @CheckForNull
  public Double getGap() {
<span class="fc" id="L343">    return gap;</span>
  }

  public IssueDto setGap(@Nullable Double d) {
<span class="pc bpc" id="L347" title="1 of 4 branches missed.">    checkArgument(d == null || d &gt;= 0, &quot;Value of issue gap must be positive: %d&quot;, d);</span>
<span class="fc" id="L348">    this.gap = d;</span>
<span class="fc" id="L349">    return this;</span>
  }

  @CheckForNull
  public Long getEffort() {
<span class="fc" id="L354">    return effort;</span>
  }

  public IssueDto setEffort(@Nullable Long l) {
<span class="pc bpc" id="L358" title="1 of 4 branches missed.">    checkArgument(l == null || l &gt;= 0, &quot;Value of issue effort must be positive: %d&quot;, l);</span>
<span class="fc" id="L359">    this.effort = l;</span>
<span class="fc" id="L360">    return this;</span>
  }

  public String getStatus() {
<span class="fc" id="L364">    return status;</span>
  }

  @Nullable
  public IssueStatus getIssueStatus() {
<span class="fc" id="L369">    return IssueStatus.of(status, resolution);</span>
  }

  public IssueDto setStatus(@Nullable String s) {
<span class="pc bpc" id="L373" title="2 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 20, &quot;Value is too long for issue status: %s&quot;, s);</span>
<span class="fc" id="L374">    this.status = s;</span>
<span class="fc" id="L375">    return this;</span>
  }

  @CheckForNull
  public String getResolution() {
<span class="fc" id="L380">    return resolution;</span>
  }

  public IssueDto setResolution(@Nullable String s) {
<span class="pc bpc" id="L384" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 20, &quot;Value is too long for issue resolution: %s&quot;, s);</span>
<span class="fc" id="L385">    this.resolution = s;</span>
<span class="fc" id="L386">    return this;</span>
  }

  @CheckForNull
  public String getChecksum() {
<span class="fc" id="L391">    return checksum;</span>
  }

  public IssueDto setChecksum(@Nullable String s) {
<span class="pc bpc" id="L395" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 1000, &quot;Value is too long for issue checksum: %s&quot;, s);</span>
<span class="fc" id="L396">    this.checksum = s;</span>
<span class="fc" id="L397">    return this;</span>
  }

  @CheckForNull
  public String getAssigneeUuid() {
<span class="fc" id="L402">    return assigneeUuid;</span>
  }

  public IssueDto setAssigneeUuid(@Nullable String s) {
<span class="pc bpc" id="L406" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 255, &quot;Value is too long for issue assigneeUuid: %s&quot;, s);</span>
<span class="fc" id="L407">    this.assigneeUuid = s;</span>
<span class="fc" id="L408">    return this;</span>
  }

  @CheckForNull
  public String getAssigneeLogin() {
<span class="fc" id="L413">    return assigneeLogin;</span>
  }

  public IssueDto setAssigneeLogin(@Nullable String s) {
<span class="fc" id="L417">    this.assigneeLogin = s;</span>
<span class="fc" id="L418">    return this;</span>
  }

  @CheckForNull
  public String getAuthorLogin() {
<span class="fc" id="L423">    return authorLogin;</span>
  }

  public IssueDto setAuthorLogin(@Nullable String s) {
<span class="pc bpc" id="L427" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= AUTHOR_MAX_SIZE, &quot;Value is too long for issue author login: %s&quot;, s);</span>
<span class="fc" id="L428">    this.authorLogin = s;</span>
<span class="fc" id="L429">    return this;</span>
  }

  public IssueDto setSecurityStandards(@Nullable String s) {
<span class="fc" id="L433">    this.securityStandards = s;</span>
<span class="fc" id="L434">    return this;</span>
  }

  public Set&lt;String&gt; getSecurityStandards() {
<span class="fc" id="L438">    return RuleDto.deserializeSecurityStandardsString(securityStandards);</span>
  }

  /**
   * Technical date
   */
  public long getCreatedAt() {
<span class="fc" id="L445">    return createdAt;</span>
  }

  public IssueDto setCreatedAt(long createdAt) {
<span class="fc" id="L449">    this.createdAt = createdAt;</span>
<span class="fc" id="L450">    return this;</span>
  }

  /**
   * Technical date
   */
  public long getUpdatedAt() {
<span class="fc" id="L457">    return updatedAt;</span>
  }

  public IssueDto setUpdatedAt(long updatedAt) {
<span class="fc" id="L461">    this.updatedAt = updatedAt;</span>
<span class="fc" id="L462">    return this;</span>
  }

  public Long getIssueCreationTime() {
<span class="fc" id="L466">    return issueCreationDate;</span>
  }

  public IssueDto setIssueCreationTime(Long time) {
<span class="fc" id="L470">    this.issueCreationDate = time;</span>
<span class="fc" id="L471">    return this;</span>
  }

  public Date getIssueCreationDate() {
<span class="fc" id="L475">    return longToDate(issueCreationDate);</span>
  }

  public IssueDto setIssueCreationDate(@Nullable Date d) {
<span class="fc" id="L479">    this.issueCreationDate = dateToLong(d);</span>
<span class="fc" id="L480">    return this;</span>
  }

  public Long getIssueUpdateTime() {
<span class="fc" id="L484">    return issueUpdateDate;</span>
  }

  public IssueDto setIssueUpdateTime(Long time) {
<span class="fc" id="L488">    this.issueUpdateDate = time;</span>
<span class="fc" id="L489">    return this;</span>
  }

  public Date getIssueUpdateDate() {
<span class="fc" id="L493">    return longToDate(issueUpdateDate);</span>
  }

  public IssueDto setIssueUpdateDate(@Nullable Date d) {
<span class="fc" id="L497">    this.issueUpdateDate = dateToLong(d);</span>
<span class="fc" id="L498">    return this;</span>
  }

  public Long getIssueCloseTime() {
<span class="fc" id="L502">    return issueCloseDate;</span>
  }

  public IssueDto setIssueCloseTime(Long time) {
<span class="fc" id="L506">    this.issueCloseDate = time;</span>
<span class="fc" id="L507">    return this;</span>
  }

  public Date getIssueCloseDate() {
<span class="fc" id="L511">    return longToDate(issueCloseDate);</span>
  }

  public IssueDto setIssueCloseDate(@Nullable Date d) {
<span class="fc" id="L515">    this.issueCloseDate = dateToLong(d);</span>
<span class="fc" id="L516">    return this;</span>
  }

  public String getRule() {
<span class="fc" id="L520">    return ruleKey;</span>
  }

  public IssueDto setRule(RuleDto rule) {
<span class="fc" id="L524">    Preconditions.checkNotNull(rule.getUuid(), &quot;Rule must be persisted.&quot;);</span>
<span class="fc" id="L525">    this.ruleUuid = rule.getUuid();</span>
<span class="fc" id="L526">    this.ruleKey = rule.getRuleKey();</span>
<span class="fc" id="L527">    this.ruleRepo = rule.getRepositoryKey();</span>
<span class="fc" id="L528">    this.language = rule.getLanguage();</span>
<span class="fc" id="L529">    this.isExternal = rule.isExternal();</span>
<span class="fc" id="L530">    this.cleanCodeAttribute = rule.getCleanCodeAttribute();</span>
<span class="fc" id="L531">    return this;</span>
  }

  public String getRuleRepo() {
<span class="fc" id="L535">    return ruleRepo;</span>
  }

  public RuleKey getRuleKey() {
<span class="fc" id="L539">    return RuleKey.of(ruleRepo, ruleKey);</span>
  }

  public String getLanguage() {
<span class="fc" id="L543">    return language;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setRule(RuleDto)} instead
   */
  public IssueDto setLanguage(String language) {
<span class="fc" id="L552">    this.language = language;</span>
<span class="fc" id="L553">    return this;</span>
  }

  public boolean isExternal() {
<span class="fc" id="L557">    return isExternal;</span>
  }

  public IssueDto setExternal(boolean external) {
<span class="fc" id="L561">    isExternal = external;</span>
<span class="fc" id="L562">    return this;</span>
  }

  public String getComponentKey() {
<span class="fc" id="L566">    return componentKey;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setComponent(ComponentDto)} instead
   */
  public IssueDto setComponentKey(String componentKey) {
<span class="fc" id="L575">    this.componentKey = componentKey;</span>
<span class="fc" id="L576">    return this;</span>
  }

  /**
   * Can be null on Views or Devs
   */
  @CheckForNull
  public String getComponentUuid() {
<span class="fc" id="L584">    return componentUuid;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setComponent(ComponentDto)} instead
   */
  public IssueDto setComponentUuid(@Nullable String s) {
<span class="pc bpc" id="L593" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 50, &quot;Value is too long for column ISSUES.COMPONENT_UUID: %s&quot;, s);</span>
<span class="fc" id="L594">    this.componentUuid = s;</span>
<span class="fc" id="L595">    return this;</span>
  }

  /**
   * Used by the issue tracking mechanism, but it should used the component uuid instead
   */
  public String getProjectKey() {
<span class="fc" id="L602">    return projectKey;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setProject(ComponentDto)} instead
   */
  public IssueDto setProjectKey(String projectKey) {
<span class="fc" id="L611">    this.projectKey = projectKey;</span>
<span class="fc" id="L612">    return this;</span>
  }

  /**
   * The project branch where the issue is located.
   * Note that the name is misleading - it should be 'branchUuid'.
   */
  public String getProjectUuid() {
<span class="fc" id="L620">    return projectUuid;</span>
  }

  /**
   * This is branch uuid, not a project uuid. The naming is wrong, the javadoc is right.
   * Please use {@link #setProject(ComponentDto)} instead
   */
  public IssueDto setProjectUuid(String s) {
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">    checkArgument(s.length() &lt;= 50, &quot;Value is too long for column ISSUES.PROJECT_UUID: %s&quot;, s);</span>
<span class="fc" id="L629">    this.projectUuid = s;</span>
<span class="fc" id="L630">    return this;</span>
  }

  @CheckForNull
  public Long getSelectedAt() {
<span class="fc" id="L635">    return selectedAt;</span>
  }

  public IssueDto setSelectedAt(@Nullable Long d) {
<span class="fc" id="L639">    this.selectedAt = d;</span>
<span class="fc" id="L640">    return this;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setRule(RuleDto)} instead
   */
  public IssueDto setRuleKey(String repo, String rule) {
<span class="fc" id="L649">    this.ruleRepo = repo;</span>
<span class="fc" id="L650">    this.ruleKey = rule;</span>
<span class="fc" id="L651">    return this;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setProject(ComponentDto)} instead
   */
  public String getFilePath() {
<span class="fc" id="L660">    return filePath;</span>
  }

  /**
   * Should only be used to persist in E/S
   * &lt;p/&gt;
   * Please use {@link #setProject(ComponentDto)} instead
   */
  public IssueDto setFilePath(String filePath) {
<span class="fc" id="L669">    this.filePath = filePath;</span>
<span class="fc" id="L670">    return this;</span>
  }

  public Set&lt;String&gt; getTags() {
<span class="fc bfc" id="L674" title="All 2 branches covered.">    return ImmutableSet.copyOf(STRING_LIST_SPLITTER.split(tags == null ? &quot;&quot; : tags));</span>
  }

  public IssueDto setTags(@Nullable Collection&lt;String&gt; tags) {
<span class="fc bfc" id="L678" title="All 4 branches covered.">    if (tags == null || tags.isEmpty()) {</span>
<span class="fc" id="L679">      setTagsString(null);</span>
    } else {
<span class="fc" id="L681">      setTagsString(STRING_LIST_JOINER.join(tags));</span>
    }
<span class="fc" id="L683">    return this;</span>
  }

  public IssueDto setTagsString(@Nullable String s) {
<span class="pc bpc" id="L687" title="1 of 4 branches missed.">    checkArgument(s == null || s.length() &lt;= 4000, &quot;Value is too long for column ISSUES.TAGS: %s&quot;, s);</span>
<span class="fc" id="L688">    this.tags = s;</span>
<span class="fc" id="L689">    return this;</span>
  }

  public String getTagsString() {
<span class="fc" id="L693">    return tags;</span>
  }

  public Set&lt;String&gt; getCodeVariants() {
<span class="fc bfc" id="L697" title="All 2 branches covered.">    return ImmutableSet.copyOf(STRING_LIST_SPLITTER.split(codeVariants == null ? &quot;&quot; : codeVariants));</span>
  }

  public String getCodeVariantsString() {
<span class="fc" id="L701">    return codeVariants;</span>
  }

  public IssueDto setCodeVariants(@Nullable Collection&lt;String&gt; codeVariants) {
<span class="fc bfc" id="L705" title="All 4 branches covered.">    if (codeVariants == null || codeVariants.isEmpty()) {</span>
<span class="fc" id="L706">      setCodeVariantsString(null);</span>
    } else {
<span class="fc" id="L708">      setCodeVariantsString(STRING_LIST_JOINER.join(codeVariants));</span>
    }
<span class="fc" id="L710">    return this;</span>
  }

  public IssueDto setCodeVariantsString(@Nullable String codeVariants) {
<span class="pc bpc" id="L714" title="1 of 4 branches missed.">    checkArgument(codeVariants == null || codeVariants.length() &lt;= 4000,</span>
      &quot;Value is too long for column ISSUES.CODE_VARIANTS: %codeVariants&quot;, codeVariants);
<span class="fc" id="L716">    this.codeVariants = codeVariants;</span>
<span class="fc" id="L717">    return this;</span>
  }

  @CheckForNull
  public byte[] getLocations() {
<span class="fc" id="L722">    return locations;</span>
  }

  @CheckForNull
  public DbIssues.Locations parseLocations() {
<span class="fc bfc" id="L727" title="All 2 branches covered.">    if (locations != null) {</span>
      try {
<span class="fc" id="L729">        return DbIssues.Locations.parseFrom(locations);</span>
<span class="nc" id="L730">      } catch (InvalidProtocolBufferException e) {</span>
<span class="nc" id="L731">        throw new IllegalStateException(format(&quot;Fail to read ISSUES.LOCATIONS [KEE=%s]&quot;, kee), e);</span>
      }
    }
<span class="fc" id="L734">    return null;</span>
  }

  public IssueDto setLocations(@Nullable byte[] locations) {
<span class="fc" id="L738">    this.locations = locations;</span>
<span class="fc" id="L739">    return this;</span>
  }

  public IssueDto setLocations(@Nullable DbIssues.Locations locations) {
<span class="fc bfc" id="L743" title="All 2 branches covered.">    if (locations == null) {</span>
<span class="fc" id="L744">      this.locations = null;</span>
    } else {
<span class="fc" id="L746">      this.locations = locations.toByteArray();</span>
    }
<span class="fc" id="L748">    return this;</span>
  }

  public boolean isQuickFixAvailable() {
<span class="fc" id="L752">    return quickFixAvailable;</span>
  }

  public IssueDto setQuickFixAvailable(boolean quickFixAvailable) {
<span class="fc" id="L756">    this.quickFixAvailable = quickFixAvailable;</span>
<span class="fc" id="L757">    return this;</span>
  }

  public boolean isNewCodeReferenceIssue() {
<span class="fc" id="L761">    return isNewCodeReferenceIssue;</span>
  }

  public IssueDto setIsNewCodeReferenceIssue(boolean isNewCodeReferenceIssue) {
<span class="fc" id="L765">    this.isNewCodeReferenceIssue = isNewCodeReferenceIssue;</span>
<span class="fc" id="L766">    return this;</span>
  }

  public int getType() {
<span class="fc" id="L770">    return type;</span>
  }

  public IssueDto setType(int type) {
<span class="fc" id="L774">    this.type = type;</span>
<span class="fc" id="L775">    return this;</span>
  }

  public IssueDto setType(RuleType type) {
<span class="fc" id="L779">    this.type = type.getDbConstant();</span>
<span class="fc" id="L780">    return this;</span>
  }

  @CheckForNull
  public CleanCodeAttribute getEffectiveCleanCodeAttribute() {
<span class="fc bfc" id="L785" title="All 2 branches covered.">    if (cleanCodeAttribute != null) {</span>
<span class="fc" id="L786">      return cleanCodeAttribute;</span>
    }
<span class="fc" id="L788">    return ruleCleanCodeAttribute;</span>
  }

  public IssueDto setCleanCodeAttribute(CleanCodeAttribute cleanCodeAttribute) {
<span class="fc" id="L792">    this.cleanCodeAttribute = cleanCodeAttribute;</span>
<span class="fc" id="L793">    return this;</span>
  }

  public IssueDto setRuleCleanCodeAttribute(CleanCodeAttribute ruleCleanCodeAttribute) {
<span class="fc" id="L797">    this.ruleCleanCodeAttribute = ruleCleanCodeAttribute;</span>
<span class="fc" id="L798">    return this;</span>
  }

  public Optional&lt;String&gt; getClosedChangeData() {
<span class="fc" id="L802">    return Optional.ofNullable(closedChangeData);</span>
  }

  public Optional&lt;String&gt; getOptionalRuleDescriptionContextKey() {
<span class="fc" id="L806">    return Optional.ofNullable(ruleDescriptionContextKey);</span>
  }

  public IssueDto setRuleDescriptionContextKey(@Nullable String ruleDescriptionContextKey) {
<span class="fc" id="L810">    this.ruleDescriptionContextKey = ruleDescriptionContextKey;</span>
<span class="fc" id="L811">    return this;</span>
  }

  /**
   * Return impacts defined on this issue.
   *
   * @return Collection of impacts
   */
  public Set&lt;ImpactDto&gt; getImpacts() {
<span class="fc" id="L820">    return impacts;</span>
  }

  public IssueDto addImpact(ImpactDto impact) {
<span class="fc bfc" id="L824" title="All 2 branches covered.">    impacts.stream().filter(impactDto -&gt; impactDto.getSoftwareQuality() == impact.getSoftwareQuality()).findFirst()</span>
<span class="fc" id="L825">      .ifPresent(impactDto -&gt; {</span>
<span class="fc" id="L826">        throw new IllegalStateException(format(&quot;Impact already defined on issue for Software Quality [%s]&quot;, impact.getSoftwareQuality()));</span>
      });

<span class="fc" id="L829">    impacts.add(impact);</span>
<span class="fc" id="L830">    return this;</span>
  }

  public IssueDto setRuleDefaultImpacts(Set&lt;ImpactDto&gt; ruleDefaultImpacts) {
<span class="fc" id="L834">    this.ruleDefaultImpacts = new HashSet&lt;&gt;(ruleDefaultImpacts);</span>
<span class="fc" id="L835">    return this;</span>
  }

  public IssueDto replaceAllImpacts(Collection&lt;ImpactDto&gt; newImpacts) {
<span class="fc" id="L839">    Set&lt;SoftwareQuality&gt; newSoftwareQuality = newImpacts.stream().map(ImpactDto::getSoftwareQuality).collect(Collectors.toSet());</span>
<span class="fc bfc" id="L840" title="All 2 branches covered.">    if (newSoftwareQuality.size() != newImpacts.size()) {</span>
<span class="fc" id="L841">      throw new IllegalStateException(&quot;Impacts must have unique Software Quality values&quot;);</span>
    }
<span class="fc" id="L843">    impacts.clear();</span>
<span class="fc" id="L844">    impacts.addAll(newImpacts);</span>
<span class="fc" id="L845">    return this;</span>
  }

  Set&lt;ImpactDto&gt; getRuleDefaultImpacts() {
<span class="fc" id="L849">    return ruleDefaultImpacts;</span>
  }

  /**
   * Returns effective impacts defined on this issue along with default ones.
   *
   * @return Unmodifiable Map of impacts
   */
  public Map&lt;SoftwareQuality, Severity&gt; getEffectiveImpacts() {
<span class="fc bfc" id="L858" title="All 2 branches covered.">    return impacts.isEmpty() ? toImpactMap(ruleDefaultImpacts) : toImpactMap(impacts);</span>
  }

  private static Map&lt;SoftwareQuality, Severity&gt; toImpactMap(Collection&lt;ImpactDto&gt; impacts) {
<span class="fc" id="L862">    return impacts.stream()</span>
<span class="fc" id="L863">      .collect(toUnmodifiableMap(ImpactDto::getSoftwareQuality, ImpactDto::getSeverity));</span>
  }

  public boolean isPrioritizedRule() {
<span class="fc" id="L867">    return prioritizedRule;</span>
  }

  public IssueDto setPrioritizedRule(boolean isBlockerRule) {
<span class="fc" id="L871">    this.prioritizedRule = isBlockerRule;</span>
<span class="fc" id="L872">    return this;</span>
  }

  public boolean isFromSonarQubeUpdate() {
<span class="fc" id="L876">    return fromSonarQubeUpdate;</span>
  }

  public IssueDto setFromSonarQubeUpdate(boolean fromSonarQubeUpdate) {
<span class="fc" id="L880">    this.fromSonarQubeUpdate = fromSonarQubeUpdate;</span>
<span class="fc" id="L881">    return this;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L886">    return ToStringBuilder.reflectionToString(this, ToStringStyle.SHORT_PREFIX_STYLE);</span>
  }

  public DefaultIssue toDefaultIssue() {
<span class="fc" id="L890">    DefaultIssue issue = new DefaultIssue();</span>
<span class="fc" id="L891">    issue.setKey(kee);</span>
<span class="fc" id="L892">    issue.setType(RuleType.fromDbConstant(type));</span>
<span class="fc" id="L893">    issue.setStatus(status);</span>
<span class="fc" id="L894">    issue.setResolution(resolution);</span>
<span class="fc" id="L895">    issue.setMessage(message);</span>
<span class="fc" id="L896">    issue.setMessageFormattings(parseMessageFormattings());</span>
<span class="fc" id="L897">    issue.setGap(gap);</span>
<span class="fc bfc" id="L898" title="All 2 branches covered.">    issue.setEffort(effort != null ? Duration.create(effort) : null);</span>
<span class="fc" id="L899">    issue.setLine(line);</span>
<span class="fc" id="L900">    issue.setChecksum(checksum);</span>
<span class="fc" id="L901">    issue.setSeverity(severity);</span>
<span class="fc" id="L902">    issue.setPrioritizedRule(prioritizedRule);</span>
<span class="fc" id="L903">    issue.setFromSonarQubeUpdate(fromSonarQubeUpdate);</span>
<span class="fc" id="L904">    issue.setAssigneeUuid(assigneeUuid);</span>
<span class="fc" id="L905">    issue.setAssigneeLogin(assigneeLogin);</span>
<span class="fc" id="L906">    issue.setComponentKey(componentKey);</span>
<span class="fc" id="L907">    issue.setComponentUuid(componentUuid);</span>
<span class="fc" id="L908">    issue.setProjectUuid(projectUuid);</span>
<span class="fc" id="L909">    issue.setProjectKey(projectKey);</span>
<span class="fc" id="L910">    issue.setManualSeverity(manualSeverity);</span>
<span class="fc" id="L911">    issue.setRuleKey(getRuleKey());</span>
<span class="fc" id="L912">    issue.setTags(getTags());</span>
<span class="fc" id="L913">    issue.setRuleDescriptionContextKey(ruleDescriptionContextKey);</span>
<span class="fc" id="L914">    issue.setLanguage(language);</span>
<span class="fc" id="L915">    issue.setAuthorLogin(authorLogin);</span>
<span class="fc" id="L916">    issue.setNew(false);</span>
<span class="fc" id="L917">    issue.setCreationDate(longToDate(issueCreationDate));</span>
<span class="fc" id="L918">    issue.setCloseDate(longToDate(issueCloseDate));</span>
<span class="fc" id="L919">    issue.setUpdateDate(longToDate(issueUpdateDate));</span>
<span class="fc" id="L920">    issue.setSelectedAt(selectedAt);</span>
<span class="fc" id="L921">    issue.setLocations(parseLocations());</span>
<span class="fc" id="L922">    issue.setIsFromExternalRuleEngine(isExternal);</span>
<span class="fc" id="L923">    issue.setQuickFixAvailable(quickFixAvailable);</span>
<span class="fc" id="L924">    issue.setIsNewCodeReferenceIssue(isNewCodeReferenceIssue);</span>
<span class="fc" id="L925">    issue.setCodeVariants(getCodeVariants());</span>
<span class="fc" id="L926">    issue.setCleanCodeAttribute(cleanCodeAttribute);</span>
<span class="fc" id="L927">    impacts.forEach(i -&gt; issue.addImpact(i.getSoftwareQuality(), i.getSeverity(), i.isManualSeverity()));</span>
<span class="fc" id="L928">    return issue;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>