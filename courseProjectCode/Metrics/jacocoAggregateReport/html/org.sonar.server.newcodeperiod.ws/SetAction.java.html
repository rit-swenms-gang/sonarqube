<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SetAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.newcodeperiod.ws</a> &gt; <span class="el_source">SetAction.java</span></div><h1>SetAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.newcodeperiod.ws;

import com.google.common.base.Preconditions;
import java.util.EnumSet;
import java.util.Locale;
import java.util.Set;
import javax.annotation.Nullable;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.db.permission.ProjectPermission;
import org.sonar.core.documentation.DocumentationLinkGenerator;
import org.sonar.core.platform.EditionProvider;
import org.sonar.core.platform.PlatformEditionProvider;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.SnapshotDto;
import org.sonar.db.newcodeperiod.NewCodePeriodDao;
import org.sonar.db.newcodeperiod.NewCodePeriodDto;
import org.sonar.db.newcodeperiod.NewCodePeriodParser;
import org.sonar.db.newcodeperiod.NewCodePeriodType;
import org.sonar.db.project.ProjectDto;
import org.sonar.server.common.newcodeperiod.CaycUtils;
import org.sonar.server.component.ComponentFinder;
import org.sonar.server.exceptions.NotFoundException;
import org.sonar.server.user.UserSession;

import static com.google.common.base.Preconditions.checkArgument;
import static java.lang.String.format;
import static org.sonar.db.newcodeperiod.NewCodePeriodType.NUMBER_OF_DAYS;
import static org.sonar.db.newcodeperiod.NewCodePeriodType.PREVIOUS_VERSION;
import static org.sonar.db.newcodeperiod.NewCodePeriodType.REFERENCE_BRANCH;
import static org.sonar.db.newcodeperiod.NewCodePeriodType.SPECIFIC_ANALYSIS;
import static org.sonar.server.newcodeperiod.ws.NewCodePeriodsWsUtils.createNewCodePeriodHtmlLink;

public class SetAction implements NewCodePeriodsWsAction {
  private static final String PARAM_BRANCH = &quot;branch&quot;;
  private static final String PARAM_PROJECT = &quot;project&quot;;
  private static final String PARAM_TYPE = &quot;type&quot;;
  private static final String PARAM_VALUE = &quot;value&quot;;
  private static final String BEGIN_LIST = &quot;&lt;ul&gt;&quot;;
  private static final String END_LIST = &quot;&lt;/ul&gt;&quot;;
  private static final String BEGIN_ITEM_LIST = &quot;&lt;li&gt;&quot;;
  private static final String END_ITEM_LIST = &quot;&lt;/li&gt;&quot;;

<span class="fc" id="L66">  private static final Set&lt;NewCodePeriodType&gt; OVERALL_TYPES = EnumSet.of(PREVIOUS_VERSION, NUMBER_OF_DAYS);</span>
<span class="fc" id="L67">  private static final Set&lt;NewCodePeriodType&gt; PROJECT_TYPES = EnumSet.of(PREVIOUS_VERSION, NUMBER_OF_DAYS, REFERENCE_BRANCH);</span>
<span class="fc" id="L68">  private static final Set&lt;NewCodePeriodType&gt; BRANCH_TYPES = EnumSet.of(PREVIOUS_VERSION, NUMBER_OF_DAYS, SPECIFIC_ANALYSIS,</span>
    REFERENCE_BRANCH);

  private final DbClient dbClient;
  private final UserSession userSession;
  private final ComponentFinder componentFinder;
  private final PlatformEditionProvider editionProvider;
  private final NewCodePeriodDao newCodePeriodDao;
  private final DocumentationLinkGenerator documentationLinkGenerator;

  public SetAction(DbClient dbClient, UserSession userSession, ComponentFinder componentFinder, PlatformEditionProvider editionProvider,
<span class="fc" id="L79">    NewCodePeriodDao newCodePeriodDao, DocumentationLinkGenerator documentationLinkGenerator) {</span>
<span class="fc" id="L80">    this.dbClient = dbClient;</span>
<span class="fc" id="L81">    this.userSession = userSession;</span>
<span class="fc" id="L82">    this.componentFinder = componentFinder;</span>
<span class="fc" id="L83">    this.editionProvider = editionProvider;</span>
<span class="fc" id="L84">    this.newCodePeriodDao = newCodePeriodDao;</span>
<span class="fc" id="L85">    this.documentationLinkGenerator = documentationLinkGenerator;</span>
<span class="fc" id="L86">  }</span>

  @Override
  public void define(WebService.NewController context) {
<span class="fc" id="L90">    WebService.NewAction action = context.createAction(&quot;set&quot;)</span>
<span class="fc" id="L91">      .setPost(true)</span>
<span class="fc" id="L92">      .setDescription(&quot;Updates the &quot; + createNewCodePeriodHtmlLink(documentationLinkGenerator) +</span>
        &quot; on different levels:&lt;br&gt;&quot; +
        BEGIN_LIST +
        BEGIN_ITEM_LIST + &quot;Not providing a project key and a branch key will update the default value at global level. &quot; +
        &quot;Existing projects or branches having a specific new code definition will not be impacted&quot; + END_ITEM_LIST +
        BEGIN_ITEM_LIST + &quot;Project key must be provided to update the value for a project&quot; + END_ITEM_LIST +
        BEGIN_ITEM_LIST + &quot;Both project and branch keys must be provided to update the value for a branch&quot; + END_ITEM_LIST +
        END_LIST +
        &quot;Requires one of the following permissions: &quot; +
        BEGIN_LIST +
        BEGIN_ITEM_LIST + &quot;'Administer System' to change the global setting&quot; + END_ITEM_LIST +
        BEGIN_ITEM_LIST + &quot;'Administer' rights on the specified project to change the project setting&quot; + END_ITEM_LIST +
        END_LIST)
<span class="fc" id="L105">      .setSince(&quot;8.0&quot;)</span>
<span class="fc" id="L106">      .setHandler(this);</span>

<span class="fc" id="L108">    action.createParam(PARAM_PROJECT)</span>
<span class="fc" id="L109">      .setDescription(&quot;Project key&quot;);</span>
<span class="fc" id="L110">    action.createParam(PARAM_BRANCH)</span>
<span class="fc" id="L111">      .setDescription(&quot;Branch key&quot;);</span>
<span class="fc" id="L112">    action.createParam(PARAM_TYPE)</span>
<span class="fc" id="L113">      .setRequired(true)</span>
<span class="fc" id="L114">      .setDescription(&quot;Type&lt;br/&gt;&quot; +</span>
        &quot;New code definitions of the following types are allowed:&quot; +
        BEGIN_LIST +
<span class="fc" id="L117">        BEGIN_ITEM_LIST + SPECIFIC_ANALYSIS.name() + &quot; - can be set at branch level only&quot; + END_ITEM_LIST +</span>
<span class="fc" id="L118">        BEGIN_ITEM_LIST + PREVIOUS_VERSION.name() + &quot; - can be set at any level (global, project, branch)&quot; + END_ITEM_LIST +</span>
<span class="fc" id="L119">        BEGIN_ITEM_LIST + NUMBER_OF_DAYS.name() + &quot; - can be set at any level (global, project, branch)&quot; + END_ITEM_LIST +</span>
<span class="fc" id="L120">        BEGIN_ITEM_LIST + REFERENCE_BRANCH.name() + &quot; - can only be set for projects and branches&quot; + END_ITEM_LIST +</span>
        END_LIST
      );
<span class="fc" id="L123">    action.createParam(PARAM_VALUE)</span>
<span class="fc" id="L124">      .setDescription(&quot;Value&lt;br/&gt;&quot; +</span>
        &quot;For each type, a different value is expected:&quot; +
        BEGIN_LIST +
<span class="fc" id="L127">        BEGIN_ITEM_LIST + &quot;the uuid of an analysis, when type is &quot; + SPECIFIC_ANALYSIS.name() + END_ITEM_LIST +</span>
<span class="fc" id="L128">        BEGIN_ITEM_LIST + &quot;no value, when type is &quot; + PREVIOUS_VERSION.name() + END_ITEM_LIST +</span>
<span class="fc" id="L129">        BEGIN_ITEM_LIST + &quot;a number between 1 and 90, when type is &quot; + NUMBER_OF_DAYS.name() + END_ITEM_LIST +</span>
<span class="fc" id="L130">        BEGIN_ITEM_LIST + &quot;a string, when type is &quot; + REFERENCE_BRANCH.name() + END_ITEM_LIST +</span>
        END_LIST
      );
<span class="fc" id="L133">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L137">    String projectKey = request.getParam(PARAM_PROJECT).emptyAsNull().or(() -&gt; null);</span>
<span class="fc" id="L138">    String branchKey = request.getParam(PARAM_BRANCH).emptyAsNull().or(() -&gt; null);</span>

<span class="fc bfc" id="L140" title="All 4 branches covered.">    if (projectKey == null &amp;&amp; branchKey != null) {</span>
<span class="fc" id="L141">      throw new IllegalArgumentException(&quot;If branch key is specified, project key needs to be specified too&quot;);</span>
    }

<span class="fc" id="L144">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L145">      String typeStr = request.mandatoryParam(PARAM_TYPE);</span>
<span class="fc" id="L146">      String valueStr = request.getParam(PARAM_VALUE).emptyAsNull().or(() -&gt; null);</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">      boolean isCommunityEdition = editionProvider.get().filter(t -&gt; t == EditionProvider.Edition.COMMUNITY).isPresent();</span>

<span class="fc bfc" id="L149" title="All 6 branches covered.">      NewCodePeriodType type = validateType(typeStr, projectKey == null, branchKey != null || isCommunityEdition);</span>

<span class="fc" id="L151">      NewCodePeriodDto dto = new NewCodePeriodDto();</span>
<span class="fc" id="L152">      dto.setType(type);</span>

<span class="fc" id="L154">      ProjectDto project = null;</span>
<span class="fc" id="L155">      BranchDto branch = null;</span>

<span class="fc bfc" id="L157" title="All 2 branches covered.">      if (projectKey != null) {</span>
<span class="fc" id="L158">        project = getProject(dbSession, projectKey);</span>
<span class="fc" id="L159">        userSession.checkEntityPermission(ProjectPermission.ADMIN, project);</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (branchKey != null) {</span>
<span class="fc" id="L162">          branch = getBranch(dbSession, project, branchKey);</span>
<span class="fc" id="L163">          dto.setBranchUuid(branch.getUuid());</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        } else if (isCommunityEdition) {</span>
          // in CE set main branch value instead of project value
<span class="fc" id="L166">          branch = getMainBranch(dbSession, project);</span>
<span class="fc" id="L167">          dto.setBranchUuid(branch.getUuid());</span>
        }

<span class="fc" id="L170">        dto.setProjectUuid(project.getUuid());</span>
      } else {
<span class="fc" id="L172">        userSession.checkIsSystemAdministrator();</span>
      }

<span class="fc" id="L175">      setValue(dbSession, dto, type, project, branch, valueStr);</span>

<span class="fc bfc" id="L177" title="All 2 branches covered.">      if (!CaycUtils.isNewCodePeriodCompliant(dto.getType(), dto.getValue())) {</span>
<span class="fc" id="L178">        throw new IllegalArgumentException(&quot;Failed to set the New Code Definition. The given value is not compatible with the Clean as &quot; +</span>
          &quot;You Code methodology. Please refer to the documentation for compliant options.&quot;);
      }

<span class="fc" id="L182">      newCodePeriodDao.upsert(dbSession, dto);</span>
<span class="fc" id="L183">      dbSession.commit();</span>
    }
<span class="fc" id="L185">  }</span>

  private void setValue(DbSession dbSession, NewCodePeriodDto dto, NewCodePeriodType type, @Nullable ProjectDto project,
    @Nullable BranchDto branch, @Nullable String value) {
<span class="pc bpc" id="L189" title="1 of 5 branches missed.">    switch (type) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">      case PREVIOUS_VERSION -&gt; Preconditions.checkArgument(value == null, &quot;Unexpected value for type '%s'&quot;, type);</span>
      case NUMBER_OF_DAYS -&gt; {
<span class="fc" id="L192">        requireValue(type, value);</span>
<span class="fc" id="L193">        dto.setValue(parseDays(value));</span>
<span class="fc" id="L194">      }</span>
      case SPECIFIC_ANALYSIS -&gt; {
<span class="fc" id="L196">        checkValuesForSpecificBranch(type, value, project, branch);</span>
<span class="fc" id="L197">        dto.setValue(getAnalysis(dbSession, value, project, branch).getUuid());</span>
<span class="fc" id="L198">      }</span>
      case REFERENCE_BRANCH -&gt; {
<span class="fc" id="L200">        requireValue(type, value);</span>
<span class="fc" id="L201">        dto.setValue(value);</span>
<span class="fc" id="L202">      }</span>
<span class="nc" id="L203">      default -&gt; throw new IllegalStateException(&quot;Unexpected type: &quot; + type);</span>
    }
<span class="fc" id="L205">  }</span>

  private static void checkValuesForSpecificBranch(NewCodePeriodType type, @Nullable String value, @Nullable ProjectDto project, @Nullable BranchDto branch) {
<span class="fc" id="L208">    requireValue(type, value);</span>
<span class="fc" id="L209">    requireProject(type, project);</span>
<span class="fc" id="L210">    requireBranch(type, branch);</span>
<span class="fc" id="L211">  }</span>

  private static String parseDays(String value) {
    try {
<span class="fc" id="L215">      return Integer.toString(NewCodePeriodParser.parseDays(value));</span>
<span class="fc" id="L216">    } catch (Exception e) {</span>
<span class="fc" id="L217">      throw new IllegalArgumentException(&quot;Failed to parse number of days: &quot; + value);</span>
    }
  }

  private static void requireValue(NewCodePeriodType type, @Nullable String value) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">    Preconditions.checkArgument(value != null, &quot;New code definition type '%s' requires a value&quot;, type);</span>
<span class="fc" id="L223">  }</span>

  private static void requireBranch(NewCodePeriodType type, @Nullable BranchDto branch) {
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">    Preconditions.checkArgument(branch != null, &quot;New code definition type '%s' requires a branch&quot;, type);</span>
<span class="fc" id="L227">  }</span>

  private static void requireProject(NewCodePeriodType type, @Nullable ProjectDto project) {
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">    Preconditions.checkArgument(project != null, &quot;New code definition type '%s' requires a project&quot;, type);</span>
<span class="fc" id="L231">  }</span>

  private BranchDto getBranch(DbSession dbSession, ProjectDto project, String branchKey) {
<span class="fc" id="L234">    return dbClient.branchDao().selectByBranchKey(dbSession, project.getUuid(), branchKey)</span>
<span class="fc" id="L235">      .orElseThrow(() -&gt; new NotFoundException(format(&quot;Branch '%s' in project '%s' not found&quot;, branchKey, project.getKey())));</span>
  }

  private ProjectDto getProject(DbSession dbSession, String projectKey) {
<span class="fc" id="L239">    return componentFinder.getProjectByKey(dbSession, projectKey);</span>
  }

  private BranchDto getMainBranch(DbSession dbSession, ProjectDto project) {
<span class="fc" id="L243">    return dbClient.branchDao().selectByProject(dbSession, project)</span>
<span class="fc" id="L244">      .stream().filter(BranchDto::isMain)</span>
<span class="fc" id="L245">      .findFirst()</span>
<span class="pc" id="L246">      .orElseThrow(() -&gt; new NotFoundException(format(&quot;Main branch in project '%s' is not found&quot;, project.getKey())));</span>
  }

  private static NewCodePeriodType validateType(String typeStr, boolean isOverall, boolean isBranch) {
    NewCodePeriodType type;
    try {
<span class="fc" id="L252">      type = NewCodePeriodType.valueOf(typeStr.toUpperCase(Locale.US));</span>
<span class="fc" id="L253">    } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L254">      throw new IllegalArgumentException(&quot;Invalid type: &quot; + typeStr);</span>
<span class="fc" id="L255">    }</span>

<span class="fc bfc" id="L257" title="All 2 branches covered.">    if (isOverall) {</span>
<span class="fc" id="L258">      checkType(&quot;Overall setting&quot;, OVERALL_TYPES, type);</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">    } else if (isBranch) {</span>
<span class="fc" id="L260">      checkType(&quot;Branches&quot;, BRANCH_TYPES, type);</span>
    } else {
<span class="fc" id="L262">      checkType(&quot;Projects&quot;, PROJECT_TYPES, type);</span>
    }
<span class="fc" id="L264">    return type;</span>
  }

  private SnapshotDto getAnalysis(DbSession dbSession, String analysisUuid, ProjectDto project, BranchDto branch) {
<span class="fc" id="L268">    SnapshotDto snapshotDto = dbClient.snapshotDao().selectByUuid(dbSession, analysisUuid)</span>
<span class="fc" id="L269">      .orElseThrow(() -&gt; new NotFoundException(format(&quot;Analysis '%s' is not found&quot;, analysisUuid)));</span>
<span class="fc" id="L270">    checkAnalysis(dbSession, project, branch, snapshotDto);</span>
<span class="fc" id="L271">    return snapshotDto;</span>
  }

  private void checkAnalysis(DbSession dbSession, ProjectDto project, BranchDto branch, SnapshotDto analysis) {
<span class="fc" id="L275">    BranchDto analysisBranch = dbClient.branchDao().selectByUuid(dbSession, analysis.getRootComponentUuid()).orElse(null);</span>
<span class="pc bpc" id="L276" title="1 of 4 branches missed.">    boolean analysisMatchesProjectBranch = analysisBranch != null &amp;&amp; analysisBranch.getUuid().equals(branch.getUuid());</span>

<span class="fc" id="L278">    checkArgument(analysisMatchesProjectBranch,</span>
      &quot;Analysis '%s' does not belong to branch '%s' of project '%s'&quot;,
<span class="fc" id="L280">      analysis.getUuid(), branch.getKey(), project.getKey());</span>
<span class="fc" id="L281">  }</span>

  private static void checkType(String name, Set&lt;NewCodePeriodType&gt; validTypes, NewCodePeriodType type) {
<span class="fc bfc" id="L284" title="All 2 branches covered.">    if (!validTypes.contains(type)) {</span>
<span class="fc" id="L285">      throw new IllegalArgumentException(String.format(&quot;Invalid type '%s'. %s can only be set with types: %s&quot;, type, name, validTypes));</span>
    }
<span class="fc" id="L287">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>