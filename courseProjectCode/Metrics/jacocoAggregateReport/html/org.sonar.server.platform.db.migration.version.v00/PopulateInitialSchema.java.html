<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PopulateInitialSchema.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.platform.db.migration.version.v00</a> &gt; <span class="el_source">PopulateInitialSchema.java</span></div><h1>PopulateInitialSchema.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.platform.db.migration.version.v00;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;
import org.sonar.api.utils.System2;
import org.sonar.core.config.CorePropertyDefinitions;
import org.sonar.core.platform.SonarQubeVersion;
import org.sonar.core.util.UuidFactory;
import org.sonar.db.Database;
import org.sonar.server.platform.db.migration.history.MigrationHistory;
import org.sonar.server.platform.db.migration.step.DataChange;
import org.sonar.server.platform.db.migration.step.Upsert;

import static java.util.Arrays.stream;
import static java.util.Objects.requireNonNull;
import static java.util.stream.Collectors.joining;
import static java.util.stream.Stream.concat;
import static java.util.stream.Stream.of;
import static org.sonar.api.web.UserRole.ADMIN;
import static org.sonar.api.web.UserRole.CODEVIEWER;
import static org.sonar.api.web.UserRole.ISSUE_ADMIN;
import static org.sonar.api.web.UserRole.SCAN;
import static org.sonar.api.web.UserRole.SECURITYHOTSPOT_ADMIN;
import static org.sonar.api.web.UserRole.USER;
import static org.sonar.core.config.MQRModeConstants.MULTI_QUALITY_MODE_ENABLED;

public class PopulateInitialSchema extends DataChange {

  private static final String ADMINS_GROUP = &quot;sonar-administrators&quot;;
  private static final String USERS_GROUP = &quot;sonar-users&quot;;
  private static final String ADMIN_USER = &quot;admin&quot;;
  private static final String ADMIN_CRYPTED_PASSWORD = &quot;100000$R9xDN18ebKxA3ZTaputi6wDt+fcKhP2h3GgAjGbcBlCSlkMLENxw9wziHS46QIW3fWOjEMpeyEts+pNuPXSbYA==&quot;;
  private static final String ADMIN_SALT = &quot;pSDhsn3IM3KCa74CRRf7T7Vx+OE=&quot;;
<span class="fc" id="L60">  private static final List&lt;String&gt; ADMIN_ROLES = Arrays.asList(&quot;admin&quot;, &quot;profileadmin&quot;, &quot;gateadmin&quot;, &quot;provisioning&quot;, &quot;applicationcreator&quot;, &quot;portfoliocreator&quot;);</span>

  private final System2 system2;
  private final UuidFactory uuidFactory;
  private final SonarQubeVersion sonarQubeVersion;
  private final MigrationHistory migrationHistory;

  public PopulateInitialSchema(Database db, System2 system2, UuidFactory uuidFactory, SonarQubeVersion sonarQubeVersion,
    MigrationHistory migrationHistory) {
<span class="fc" id="L69">    super(db);</span>
<span class="fc" id="L70">    this.system2 = system2;</span>
<span class="fc" id="L71">    this.uuidFactory = uuidFactory;</span>
<span class="fc" id="L72">    this.sonarQubeVersion = sonarQubeVersion;</span>
<span class="fc" id="L73">    this.migrationHistory = migrationHistory;</span>
<span class="fc" id="L74">  }</span>

  @Override
  public void execute(Context context) throws SQLException {
<span class="fc" id="L78">    String adminUserUuid = insertAdminUser(context);</span>
<span class="fc" id="L79">    Groups groups = insertGroups(context);</span>
<span class="fc" id="L80">    String defaultQGUuid = insertQualityGate(context);</span>
<span class="fc" id="L81">    insertInternalProperty(context);</span>
<span class="fc" id="L82">    insertProperties(context, defaultQGUuid);</span>
<span class="fc" id="L83">    insertGroupRoles(context, groups);</span>
<span class="fc" id="L84">    insertGroupUsers(context, adminUserUuid, groups);</span>
<span class="fc" id="L85">    insertDevopsPermissionMapping(context);</span>
<span class="fc" id="L86">    insertGitlabPermissionMapping(context);</span>
<span class="fc" id="L87">    enableSpecificMqrMode(context);</span>
<span class="fc" id="L88">  }</span>

  private void insertGitlabPermissionMapping(Context context) throws SQLException {
<span class="fc" id="L91">    String insertQuery = &quot;&quot;&quot;</span>
    insert into devops_perms_mapping (uuid, devops_platform, devops_platform_role, sonarqube_permission)
    values (?, ?, ?, ?)
    &quot;&quot;&quot;;

<span class="fc" id="L96">    Map&lt;String, Set&lt;String&gt;&gt; gitlabRoleToSqPermissions = Map.of(</span>
<span class="fc" id="L97">      &quot;guest&quot;, Set.of(USER),</span>
<span class="fc" id="L98">      &quot;reporter&quot;, Set.of(USER, CODEVIEWER),</span>
<span class="fc" id="L99">      &quot;developer&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN),</span>
<span class="fc" id="L100">      &quot;maintainer&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN, ADMIN),</span>
<span class="fc" id="L101">      &quot;owner&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN, ADMIN)</span>
    );

<span class="fc" id="L104">    try (Upsert upsert = context.prepareUpsert(insertQuery)) {</span>
<span class="fc" id="L105">      gitlabRoleToSqPermissions.forEach((role, permissions) -&gt; insertGitlabRoleToSonarqubePermissionMapping(upsert, role, permissions));</span>
<span class="fc" id="L106">      upsert.commit();</span>
    }
<span class="fc" id="L108">  }</span>

  private void insertGitlabRoleToSonarqubePermissionMapping(Upsert upsert, String role, Set&lt;String&gt; sonarqubePermissions) {
<span class="fc" id="L111">    sonarqubePermissions.forEach(permission -&gt; insertGitlabRoleToSonarqubePermissionMapping(upsert, role, permission));</span>
<span class="fc" id="L112">  }</span>

  private void insertGitlabRoleToSonarqubePermissionMapping(Upsert upsert, String role, String sonarqubePermission) {
    try {
<span class="fc" id="L116">      upsert</span>
<span class="fc" id="L117">        .setString(1, uuidFactory.create())</span>
<span class="fc" id="L118">        .setString(2, &quot;gitlab&quot;)</span>
<span class="fc" id="L119">        .setString(3, role)</span>
<span class="fc" id="L120">        .setString(4, sonarqubePermission)</span>
<span class="fc" id="L121">        .execute();</span>
<span class="nc" id="L122">    } catch (SQLException e) {</span>
<span class="nc" id="L123">      throw new IllegalStateException(e);</span>
<span class="fc" id="L124">    }</span>
<span class="fc" id="L125">  }</span>

  private String insertAdminUser(Context context) throws SQLException {
<span class="fc" id="L128">    truncateTable(context, &quot;users&quot;);</span>

<span class="fc" id="L130">    long now = system2.now();</span>
<span class="fc" id="L131">    context.prepareUpsert(&quot;insert into users &quot; +</span>
      &quot;(uuid, login, name, email, external_id, external_login, external_identity_provider, user_local, crypted_password, salt, hash_method, reset_password, &quot; +
      &quot;created_at, updated_at)&quot; +
      &quot; values &quot; +
      &quot;(?, ?, 'Administrator', null, 'admin', 'admin', 'sonarqube', ?, ?, ?, 'PBKDF2', ?, ?, ?)&quot;)
<span class="fc" id="L136">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L137">      .setString(2, ADMIN_USER)</span>
<span class="fc" id="L138">      .setBoolean(3, true)</span>
<span class="fc" id="L139">      .setString(4, ADMIN_CRYPTED_PASSWORD)</span>
<span class="fc" id="L140">      .setString(5, ADMIN_SALT)</span>
<span class="fc" id="L141">      .setBoolean(6, true)</span>
<span class="fc" id="L142">      .setLong(7, now)</span>
<span class="fc" id="L143">      .setLong(8, now)</span>
<span class="fc" id="L144">      .execute()</span>
<span class="fc" id="L145">      .commit();</span>

<span class="fc" id="L147">    String res = context.prepareSelect(&quot;select uuid from users where login=?&quot;)</span>
<span class="fc" id="L148">      .setString(1, ADMIN_USER)</span>
<span class="fc" id="L149">      .get(t -&gt; t.getString(1));</span>
<span class="fc" id="L150">    return requireNonNull(res);</span>
  }

  private void insertInternalProperty(Context context) throws SQLException {
<span class="fc" id="L154">    String tableName = &quot;internal_properties&quot;;</span>
<span class="fc" id="L155">    truncateTable(context, tableName);</span>

<span class="fc" id="L157">    long now = system2.now();</span>
<span class="fc" id="L158">    Upsert upsert = context.prepareUpsert(createInsertStatement(tableName, &quot;kee&quot;, &quot;is_empty&quot;, &quot;text_value&quot;, &quot;created_at&quot;));</span>
<span class="fc" id="L159">    upsert</span>
<span class="fc" id="L160">      .setString(1, &quot;installation.date&quot;)</span>
<span class="fc" id="L161">      .setBoolean(2, false)</span>
<span class="fc" id="L162">      .setString(3, String.valueOf(system2.now()))</span>
<span class="fc" id="L163">      .setLong(4, now)</span>
<span class="fc" id="L164">      .addBatch();</span>
<span class="fc" id="L165">    upsert</span>
<span class="fc" id="L166">      .setString(1, &quot;installation.version&quot;)</span>
<span class="fc" id="L167">      .setBoolean(2, false)</span>
<span class="fc" id="L168">      .setString(3, sonarQubeVersion.get().toString())</span>
<span class="fc" id="L169">      .setLong(4, now)</span>
<span class="fc" id="L170">      .addBatch();</span>
<span class="fc" id="L171">    upsert</span>
<span class="fc" id="L172">      .execute()</span>
<span class="fc" id="L173">      .commit();</span>
<span class="fc" id="L174">  }</span>

  private void insertProperties(Context context, String defaultQualityGate) throws SQLException {
<span class="fc" id="L177">    var tableName = &quot;properties&quot;;</span>
<span class="fc" id="L178">    truncateTable(context, tableName);</span>

<span class="fc" id="L180">    long now = system2.now();</span>
<span class="fc" id="L181">    var upsert = context</span>
<span class="fc" id="L182">      .prepareUpsert(createInsertStatement(tableName, &quot;uuid&quot;, &quot;prop_key&quot;, &quot;is_empty&quot;, &quot;text_value&quot;, &quot;created_at&quot;));</span>

<span class="fc" id="L184">    upsert.setString(1, uuidFactory.create())</span>
<span class="fc" id="L185">      .setString(2, &quot;sonar.forceAuthentication&quot;)</span>
<span class="fc" id="L186">      .setBoolean(3, false)</span>
<span class="fc" id="L187">      .setString(4, &quot;true&quot;)</span>
<span class="fc" id="L188">      .setLong(5, now)</span>
<span class="fc" id="L189">      .addBatch();</span>

<span class="fc" id="L191">    upsert.setString(1, uuidFactory.create())</span>
<span class="fc" id="L192">      .setString(2, CorePropertyDefinitions.ALLOW_DISABLE_INHERITED_RULES)</span>
<span class="fc" id="L193">      .setBoolean(3, false)</span>
<span class="fc" id="L194">      .setString(4, &quot;true&quot;)</span>
<span class="fc" id="L195">      .setLong(5, now)</span>
<span class="fc" id="L196">      .addBatch();</span>

<span class="fc" id="L198">    upsert</span>
<span class="fc" id="L199">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L200">      .setString(2, &quot;projects.default.visibility&quot;)</span>
<span class="fc" id="L201">      .setBoolean(3, false)</span>
<span class="fc" id="L202">      .setString(4, &quot;public&quot;)</span>
<span class="fc" id="L203">      .setLong(5, now)</span>
<span class="fc" id="L204">      .addBatch();</span>

<span class="fc" id="L206">    upsert</span>
<span class="fc" id="L207">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L208">      .setString(2, &quot;qualitygate.default&quot;)</span>
<span class="fc" id="L209">      .setBoolean(3, false)</span>
<span class="fc" id="L210">      .setString(4, defaultQualityGate)</span>
<span class="fc" id="L211">      .setLong(5, system2.now())</span>
<span class="fc" id="L212">      .addBatch();</span>

<span class="fc" id="L214">    upsert</span>
<span class="fc" id="L215">      .execute()</span>
<span class="fc" id="L216">      .commit();</span>
<span class="fc" id="L217">  }</span>

  private Groups insertGroups(Context context) throws SQLException {
<span class="fc" id="L220">    truncateTable(context, &quot;groups&quot;);</span>

<span class="fc" id="L222">    Date now = new Date(system2.now());</span>
<span class="fc" id="L223">    Upsert upsert = context.prepareUpsert(createInsertStatement(</span>
      &quot;groups&quot;,
      &quot;uuid&quot;, &quot;name&quot;, &quot;description&quot;, &quot;created_at&quot;, &quot;updated_at&quot;));
<span class="fc" id="L226">    upsert</span>
<span class="fc" id="L227">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L228">      .setString(2, ADMINS_GROUP)</span>
<span class="fc" id="L229">      .setString(3, &quot;System administrators&quot;)</span>
<span class="fc" id="L230">      .setDate(4, now)</span>
<span class="fc" id="L231">      .setDate(5, now)</span>
<span class="fc" id="L232">      .addBatch();</span>
<span class="fc" id="L233">    upsert</span>
<span class="fc" id="L234">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L235">      .setString(2, USERS_GROUP)</span>
<span class="fc" id="L236">      .setString(3, &quot;Every authenticated user automatically belongs to this group&quot;)</span>
<span class="fc" id="L237">      .setDate(4, now)</span>
<span class="fc" id="L238">      .setDate(5, now)</span>
<span class="fc" id="L239">      .addBatch();</span>
<span class="fc" id="L240">    upsert</span>
<span class="fc" id="L241">      .execute()</span>
<span class="fc" id="L242">      .commit();</span>

<span class="fc" id="L244">    return new Groups(getGroupUuid(context, ADMINS_GROUP), getGroupUuid(context, USERS_GROUP));</span>
  }

  private static String getGroupUuid(Context context, String groupName) throws SQLException {
<span class="fc" id="L248">    String res = context.prepareSelect(&quot;select uuid from groups where name=?&quot;)</span>
<span class="fc" id="L249">      .setString(1, groupName)</span>
<span class="fc" id="L250">      .get(t -&gt; t.getString(1));</span>
<span class="fc" id="L251">    return requireNonNull(res);</span>
  }

  private String insertQualityGate(Context context) throws SQLException {
<span class="fc" id="L255">    truncateTable(context, &quot;quality_gates&quot;);</span>

<span class="fc" id="L257">    String uuid = uuidFactory.create();</span>
<span class="fc" id="L258">    Date now = new Date(system2.now());</span>
<span class="fc" id="L259">    context.prepareUpsert(createInsertStatement(&quot;quality_gates&quot;, &quot;uuid&quot;, &quot;name&quot;, &quot;is_built_in&quot;, &quot;created_at&quot;, &quot;updated_at&quot;))</span>
<span class="fc" id="L260">      .setString(1, uuid)</span>
<span class="fc" id="L261">      .setString(2, &quot;Sonar way&quot;)</span>
<span class="fc" id="L262">      .setBoolean(3, true)</span>
<span class="fc" id="L263">      .setDate(4, now)</span>
<span class="fc" id="L264">      .setDate(5, now)</span>
<span class="fc" id="L265">      .execute()</span>
<span class="fc" id="L266">      .commit();</span>
<span class="fc" id="L267">    return uuid;</span>
  }

<span class="fc" id="L270">  private record Groups(String adminGroupUuid, String userGroupUuid) {</span>
  }

  private void insertGroupRoles(Context context, Groups groups) throws SQLException {
<span class="fc" id="L274">    truncateTable(context, &quot;group_roles&quot;);</span>

<span class="fc" id="L276">    Upsert upsert = context.prepareUpsert(createInsertStatement(&quot;group_roles&quot;, &quot;uuid&quot;, &quot;group_uuid&quot;, &quot;role&quot;));</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">    for (String adminRole : ADMIN_ROLES) {</span>
<span class="fc" id="L278">      upsert</span>
<span class="fc" id="L279">        .setString(1, uuidFactory.create())</span>
<span class="fc" id="L280">        .setString(2, groups.adminGroupUuid())</span>
<span class="fc" id="L281">        .setString(3, adminRole)</span>
<span class="fc" id="L282">        .addBatch();</span>
<span class="fc" id="L283">    }</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">    for (String anyoneRole : Arrays.asList(&quot;scan&quot;, &quot;provisioning&quot;)) {</span>
<span class="fc" id="L285">      upsert</span>
<span class="fc" id="L286">        .setString(1, uuidFactory.create())</span>
<span class="fc" id="L287">        .setString(2, groups.userGroupUuid())</span>
<span class="fc" id="L288">        .setString(3, anyoneRole)</span>
<span class="fc" id="L289">        .addBatch();</span>
<span class="fc" id="L290">    }</span>
<span class="fc" id="L291">    upsert</span>
<span class="fc" id="L292">      .execute()</span>
<span class="fc" id="L293">      .commit();</span>
<span class="fc" id="L294">  }</span>

  private void insertDevopsPermissionMapping(Context context) throws SQLException {
<span class="fc" id="L297">    Map&lt;String, Set&lt;String&gt;&gt; devopsRoleToSqPermissions = Map.of(</span>
<span class="fc" id="L298">      &quot;read&quot;, Set.of(USER, CODEVIEWER),</span>
<span class="fc" id="L299">      &quot;triage&quot;, Set.of(USER, CODEVIEWER),</span>
<span class="fc" id="L300">      &quot;write&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN),</span>
<span class="fc" id="L301">      &quot;maintain&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN),</span>
<span class="fc" id="L302">      &quot;admin&quot;, Set.of(USER, CODEVIEWER, ISSUE_ADMIN, SECURITYHOTSPOT_ADMIN, SCAN, ADMIN));</span>

<span class="fc" id="L304">    String insertQuery = &quot;&quot;&quot;</span>
    insert into devops_perms_mapping (uuid, devops_platform_role, sonarqube_permission)
    values (?, ?, ?)
    &quot;&quot;&quot;;
<span class="fc" id="L308">    try (Upsert upsert = context.prepareUpsert(insertQuery)) {</span>
<span class="fc" id="L309">      devopsRoleToSqPermissions.forEach((key, value) -&gt; insertGithubRoleToSonarqubePermissionMapping(upsert, key, value));</span>
<span class="fc" id="L310">      upsert.commit();</span>
    }
<span class="fc" id="L312">  }</span>

  private void insertGithubRoleToSonarqubePermissionMapping(Upsert upsert, String githubRole, Set&lt;String&gt; sonarqubePermissions) {
<span class="fc" id="L315">    sonarqubePermissions.forEach(permission -&gt; insertGithubRoleToSonarqubePermissionMapping(upsert, githubRole, permission));</span>
<span class="fc" id="L316">  }</span>

  private void insertGithubRoleToSonarqubePermissionMapping(Upsert upsert, String githubRole, String sonarqubePermission) {
    try {
<span class="fc" id="L320">      upsert</span>
<span class="fc" id="L321">        .setString(1, uuidFactory.create())</span>
<span class="fc" id="L322">        .setString(2, githubRole)</span>
<span class="fc" id="L323">        .setString(3, sonarqubePermission)</span>
<span class="fc" id="L324">        .execute();</span>
<span class="nc" id="L325">    } catch (SQLException e) {</span>
<span class="nc" id="L326">      throw new IllegalStateException(e);</span>
<span class="fc" id="L327">    }</span>
<span class="fc" id="L328">  }</span>


  private void enableSpecificMqrMode(Context context) throws SQLException {
<span class="fc" id="L332">    try (Connection connection = getDatabase().getDataSource().getConnection()) {</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">      if (!paramExists(connection)) {</span>
<span class="fc" id="L334">        long version = migrationHistory.getInitialDbVersion();</span>
<span class="pc bpc" id="L335" title="2 of 4 branches missed.">        boolean mqrModeEnabled = version &gt;= 102_000L || version == -1L;</span>
<span class="fc" id="L336">        Upsert upsert = context.prepareUpsert(</span>
<span class="fc" id="L337">          createInsertStatement(&quot;properties&quot;,</span>
            &quot;uuid&quot;,
            &quot;prop_key&quot;,
            &quot;is_empty&quot;,
            &quot;text_value&quot;,
            &quot;created_at&quot;));
<span class="fc" id="L343">        upsert.setString(1, uuidFactory.create())</span>
<span class="fc" id="L344">          .setString(2, MULTI_QUALITY_MODE_ENABLED)</span>
<span class="fc" id="L345">          .setBoolean(3, false)</span>
<span class="fc" id="L346">          .setString(4, String.valueOf(mqrModeEnabled))</span>
<span class="fc" id="L347">          .setLong(5, system2.now());</span>
<span class="fc" id="L348">        upsert.execute().commit();</span>
      }
    }
<span class="fc" id="L351">  }</span>

  private static boolean paramExists(Connection connection) throws SQLException {
<span class="fc" id="L354">    String sql = &quot;SELECT count(1) FROM properties WHERE prop_key = '&quot; + MULTI_QUALITY_MODE_ENABLED + &quot;'&quot;;</span>
<span class="fc" id="L355">    try (PreparedStatement statement = connection.prepareStatement(sql)) {</span>
<span class="fc" id="L356">      ResultSet result = statement.executeQuery();</span>
<span class="pc bpc" id="L357" title="2 of 4 branches missed.">      return result.next() &amp;&amp; result.getInt(1) &gt; 0;</span>
    }
  }

  private void insertGroupUsers(Context context, String adminUserUuid, Groups groups) throws SQLException {
<span class="fc" id="L362">    truncateTable(context, &quot;groups_users&quot;);</span>

<span class="fc" id="L364">    Upsert upsert = context.prepareUpsert(createInsertStatement(&quot;groups_users&quot;, &quot;uuid&quot;, &quot;user_uuid&quot;, &quot;group_uuid&quot;));</span>
<span class="fc" id="L365">    upsert</span>
<span class="fc" id="L366">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L367">      .setString(2, adminUserUuid)</span>
<span class="fc" id="L368">      .setString(3, groups.userGroupUuid())</span>
<span class="fc" id="L369">      .addBatch();</span>
<span class="fc" id="L370">    upsert</span>
<span class="fc" id="L371">      .setString(1, uuidFactory.create())</span>
<span class="fc" id="L372">      .setString(2, adminUserUuid)</span>
<span class="fc" id="L373">      .setString(3, groups.adminGroupUuid())</span>
<span class="fc" id="L374">      .addBatch();</span>
<span class="fc" id="L375">    upsert</span>
<span class="fc" id="L376">      .execute()</span>
<span class="fc" id="L377">      .commit();</span>
<span class="fc" id="L378">  }</span>

  private static void truncateTable(Context context, String table) throws SQLException {
<span class="fc" id="L381">    context.prepareUpsert(&quot;truncate table &quot; + table).execute().commit();</span>
<span class="fc" id="L382">  }</span>

  public static String createInsertStatement(String tableName, String firstColumn, String... otherColumns) {
<span class="fc" id="L385">    return &quot;insert into &quot; + tableName + &quot; &quot; +</span>
<span class="fc" id="L386">      &quot;(&quot; + concat(of(firstColumn), stream(otherColumns)).collect(joining(&quot;,&quot;)) + &quot;)&quot; +</span>
      &quot; values&quot; +
<span class="fc" id="L388">      &quot; (&quot; + concat(of(firstColumn), stream(otherColumns)).map(t -&gt; &quot;?&quot;).collect(joining(&quot;,&quot;)) + &quot;)&quot;;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>