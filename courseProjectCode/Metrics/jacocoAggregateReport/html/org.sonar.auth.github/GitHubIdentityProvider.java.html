<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitHubIdentityProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.auth.github</a> &gt; <span class="el_source">GitHubIdentityProvider.java</span></div><h1>GitHubIdentityProvider.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.auth.github;

import com.github.scribejava.core.builder.ServiceBuilder;
import com.github.scribejava.core.model.OAuth2AccessToken;
import com.github.scribejava.core.oauth.OAuth20Service;
import java.io.IOException;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.ExecutionException;
import java.util.stream.Collectors;
import org.jetbrains.annotations.NotNull;
import org.sonar.api.server.authentication.Display;
import org.sonar.api.server.authentication.OAuth2IdentityProvider;
import org.sonar.api.server.authentication.UnauthorizedException;
import org.sonar.api.server.authentication.UserIdentity;
import org.sonar.api.server.http.HttpRequest;
import org.sonar.auth.github.scribe.ScribeServiceBuilder;

import static com.google.common.base.Preconditions.checkState;
import static java.lang.Long.parseLong;
import static java.lang.String.format;
import static org.sonar.auth.github.GitHubSettings.DEFAULT_API_URL;

public class GitHubIdentityProvider implements OAuth2IdentityProvider {

  public static final String KEY = &quot;github&quot;;

  private final GitHubSettings settings;
  private final UserIdentityFactory userIdentityFactory;
  private final ScribeGitHubApi scribeApi;
  private final GitHubRestClient gitHubRestClient;
  private final GithubApplicationClient githubAppClient;
  private final ScribeServiceBuilder scribeServiceBuilder;

  public GitHubIdentityProvider(GitHubSettings settings, UserIdentityFactory userIdentityFactory, ScribeGitHubApi scribeApi, GitHubRestClient gitHubRestClient,
<span class="fc" id="L56">    GithubApplicationClient githubAppClient, ScribeServiceBuilder scribeServiceBuilder) {</span>
<span class="fc" id="L57">    this.settings = settings;</span>
<span class="fc" id="L58">    this.userIdentityFactory = userIdentityFactory;</span>
<span class="fc" id="L59">    this.scribeApi = scribeApi;</span>
<span class="fc" id="L60">    this.gitHubRestClient = gitHubRestClient;</span>
<span class="fc" id="L61">    this.githubAppClient = githubAppClient;</span>
<span class="fc" id="L62">    this.scribeServiceBuilder = scribeServiceBuilder;</span>
<span class="fc" id="L63">  }</span>

  @Override
  public String getKey() {
<span class="fc" id="L67">    return KEY;</span>
  }

  @Override
  public String getName() {
<span class="fc" id="L72">    return &quot;GitHub&quot;;</span>
  }

  @Override
  public Display getDisplay() {
<span class="fc" id="L77">    return Display.builder()</span>
<span class="fc" id="L78">      .setIconPath(&quot;/images/alm/github.svg&quot;)</span>
<span class="fc" id="L79">      .setBackgroundColor(&quot;#444444&quot;)</span>
<span class="fc" id="L80">      .build();</span>
  }

  @Override
  public boolean isEnabled() {
<span class="fc" id="L85">    return settings.isEnabled();</span>
  }

  @Override
  public boolean allowsUsersToSignUp() {
<span class="fc" id="L90">    return settings.allowUsersToSignUp();</span>
  }

  @Override
  public void init(InitContext context) {
<span class="fc" id="L95">    String state = context.generateCsrfState();</span>
<span class="fc" id="L96">    OAuth20Service scribe = newScribeBuilder(context)</span>
<span class="fc" id="L97">      .defaultScope(getScope())</span>
<span class="fc" id="L98">      .build(scribeApi);</span>
<span class="fc" id="L99">    String url = scribe.getAuthorizationUrl(state);</span>
<span class="fc" id="L100">    context.redirectTo(url);</span>
<span class="fc" id="L101">  }</span>

  String getScope() {
<span class="fc bfc" id="L104" title="All 4 branches covered.">    return (settings.syncGroups() || isOrganizationMembershipRequired()) ? &quot;user:email,read:org&quot; : &quot;user:email&quot;;</span>
  }

  @Override
  public void callback(CallbackContext context) {
    try {
<span class="fc" id="L110">      onCallback(context);</span>
<span class="nc" id="L111">    } catch (IOException | ExecutionException e) {</span>
<span class="nc" id="L112">      throw new IllegalStateException(e);</span>
<span class="nc" id="L113">    } catch (InterruptedException e) {</span>
<span class="nc" id="L114">      Thread.currentThread().interrupt();</span>
<span class="nc" id="L115">      throw new IllegalStateException(e);</span>
<span class="fc" id="L116">    }</span>
<span class="fc" id="L117">  }</span>

  private void onCallback(CallbackContext context) throws InterruptedException, ExecutionException, IOException {
<span class="fc" id="L120">    context.verifyCsrfState();</span>

<span class="fc" id="L122">    HttpRequest request = context.getHttpRequest();</span>
<span class="fc" id="L123">    OAuth20Service scribe = scribeServiceBuilder.buildScribeService(settings.clientId(), settings.clientSecret(), context.getCallbackUrl(), scribeApi);</span>

<span class="fc" id="L125">    String code = request.getParameter(&quot;code&quot;);</span>
<span class="fc" id="L126">    OAuth2AccessToken accessToken = scribe.getAccessToken(code);</span>

<span class="fc" id="L128">    GsonUser user = gitHubRestClient.getUser(scribe, accessToken);</span>
<span class="fc" id="L129">    check(scribe, accessToken, user);</span>

    final String email;
<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (user.getEmail() == null) {</span>
      // if the user has not specified a public email address in their profile
<span class="fc" id="L134">      email = gitHubRestClient.getEmail(scribe, accessToken);</span>
    } else {
<span class="fc" id="L136">      email = user.getEmail();</span>
    }

<span class="fc" id="L139">    UserIdentity userIdentity = userIdentityFactory.create(user, email,</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">      settings.syncGroups() ? gitHubRestClient.getTeams(scribe, accessToken) : null);</span>
<span class="fc" id="L141">    context.authenticate(userIdentity);</span>
<span class="fc" id="L142">    context.redirectToRequestedPage();</span>
<span class="fc" id="L143">  }</span>

  private void check(OAuth20Service scribe, OAuth2AccessToken accessToken, GsonUser user) {
<span class="fc bfc" id="L146" title="All 2 branches covered.">    if (!isUserAuthorized(scribe, accessToken)) {</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">      String message = settings.getOrganizations().isEmpty()</span>
<span class="fc" id="L148">        ? format(&quot;'%s' must be a member of at least one organization which has installed the SonarQube GitHub app&quot;, user.getLogin())</span>
<span class="fc" id="L149">        : format(&quot;'%s' must be a member of at least one organization: '%s'&quot;, user.getLogin(), String.join(&quot;', '&quot;, settings.getOrganizations().stream().sorted().toList()));</span>
<span class="fc" id="L150">      throw new UnauthorizedException(message);</span>
    }
<span class="fc" id="L152">  }</span>

  private boolean isUserAuthorized(OAuth20Service scribe, OAuth2AccessToken accessToken) {
<span class="fc" id="L155">    Set&lt;String&gt; userOrganizationNames = getUserOrganizationNames(scribe, accessToken);</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">    if (isOrganizationMembershipRequired()) {</span>
<span class="fc" id="L157">      return isOrganizationsMember(settings.getOrganizations(), userOrganizationNames);</span>
    } else {
<span class="fc" id="L159">      return isMemberOfInstallationOrganization(userOrganizationNames);</span>
    }
  }

  private static boolean isOrganizationsMember(Set&lt;String&gt; organizations, Set&lt;String&gt; userOrganizationNames) {
<span class="fc" id="L164">    return organizations.stream().anyMatch(userOrganizationNames::contains);</span>
  }

  @NotNull
  private Set&lt;String&gt; getUserOrganizationNames(OAuth20Service scribe, OAuth2AccessToken accessToken) {
<span class="fc" id="L169">    return gitHubRestClient.getUserOrganizations(scribe, accessToken).stream()</span>
<span class="fc" id="L170">      .map(GsonOrganization::organization)</span>
<span class="fc" id="L171">      .collect(Collectors.toSet());</span>
  }

  private boolean isOrganizationMembershipRequired() {
<span class="fc bfc" id="L175" title="All 2 branches covered.">    return !settings.getOrganizations().isEmpty();</span>
  }

  private boolean isMemberOfInstallationOrganization(Set&lt;String&gt; userOrganizationNames) {
<span class="fc" id="L179">    GithubAppConfiguration githubAppConfiguration = githubAppConfiguration();</span>
<span class="fc" id="L180">    List&lt;GithubAppInstallation&gt; githubAppInstallations = githubAppClient.getWhitelistedGithubAppInstallations(githubAppConfiguration);</span>
<span class="fc" id="L181">    return githubAppInstallations.stream()</span>
<span class="fc" id="L182">      .map(GithubAppInstallation::organizationName)</span>
<span class="fc" id="L183">      .anyMatch(userOrganizationNames::contains);</span>
  }

  private GithubAppConfiguration githubAppConfiguration() {
<span class="fc" id="L187">    String apiEndpoint = Optional.ofNullable(settings.apiURL()).orElse(DEFAULT_API_URL);</span>
    try {
<span class="fc" id="L189">      return new GithubAppConfiguration(parseLong(settings.appId()), settings.privateKey(), apiEndpoint);</span>
<span class="nc" id="L190">    } catch (NumberFormatException numberFormatException) {</span>
<span class="nc" id="L191">      throw new IllegalStateException(&quot;Github configuration is not complete. Please check your configuration under the Authentication &gt; GitHub tab&quot;);</span>
    }
  }

  private ServiceBuilder newScribeBuilder(OAuth2IdentityProvider.OAuth2Context context) {
<span class="fc" id="L196">    checkState(isEnabled(), &quot;GitHub authentication is disabled&quot;);</span>
<span class="fc" id="L197">    return new ServiceBuilder(settings.clientId())</span>
<span class="fc" id="L198">      .apiSecret(settings.clientSecret())</span>
<span class="fc" id="L199">      .callback(context.getCallbackUrl());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>