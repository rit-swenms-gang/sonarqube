<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.user.ws</a> &gt; <span class="el_source">SearchAction.java</span></div><h1>SearchAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.user.ws;

import java.util.Optional;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.server.common.PaginationInformation;
import org.sonar.server.common.SearchResults;
import org.sonar.server.common.user.service.UserInformation;
import org.sonar.server.common.user.service.UserService;
import org.sonar.server.common.user.service.UsersSearchRequest;
import org.sonar.server.es.SearchOptions;
import org.sonar.server.exceptions.ServerException;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Users;

import static com.google.common.base.Preconditions.checkArgument;
import static org.sonar.api.server.ws.WebService.Param.PAGE;
import static org.sonar.api.server.ws.WebService.Param.PAGE_SIZE;
import static org.sonar.api.server.ws.WebService.Param.TEXT_QUERY;
import static org.sonar.server.common.PaginationInformation.forPageIndex;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

public class SearchAction implements UsersWsAction {
  private static final int MAX_PAGE_SIZE = 500;

  private static final String DEACTIVATED_PARAM = &quot;deactivated&quot;;
  private static final String MANAGED_PARAM = &quot;managed&quot;;
  static final String LAST_CONNECTION_DATE_FROM = &quot;lastConnectedAfter&quot;;
  static final String LAST_CONNECTION_DATE_TO = &quot;lastConnectedBefore&quot;;
  static final String SONAR_LINT_LAST_CONNECTION_DATE_FROM = &quot;slLastConnectedAfter&quot;;
  static final String SONAR_LINT_LAST_CONNECTION_DATE_TO = &quot;slLastConnectedBefore&quot;;
  static final String EXTERNAL_IDENTITY = &quot;externalIdentity&quot;;

  private final UserSession userSession;
  private final UserService userService;
  private final SearchWsReponseGenerator searchWsReponseGenerator;

  public SearchAction(UserSession userSession,
<span class="fc" id="L60">    UserService userService, SearchWsReponseGenerator searchWsReponseGenerator) {</span>
<span class="fc" id="L61">    this.userSession = userSession;</span>
<span class="fc" id="L62">    this.userService = userService;</span>
<span class="fc" id="L63">    this.searchWsReponseGenerator = searchWsReponseGenerator;</span>
<span class="fc" id="L64">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L68">    WebService.NewAction action = controller.createAction(&quot;search&quot;)</span>
<span class="fc" id="L69">      .setDescription(&quot;Get a list of users. By default, only active users are returned.&lt;br/&gt;&quot; +</span>
        &quot;The following fields are only returned when user has Administer System permission or for logged-in in user :&quot; +
        &quot;&lt;ul&gt;&quot; +
        &quot;   &lt;li&gt;'email'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'externalIdentity'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'externalProvider'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'groups'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'lastConnectionDate'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'sonarLintLastConnectionDate'&lt;/li&gt;&quot; +
        &quot;   &lt;li&gt;'tokensCount'&lt;/li&gt;&quot; +
        &quot;&lt;/ul&gt;&quot; +
        &quot;Field 'lastConnectionDate' is only updated every hour, so it may not be accurate, for instance when a user authenticates many times in less than one hour.&quot;)
<span class="fc" id="L81">      .setSince(&quot;3.6&quot;)</span>
<span class="fc" id="L82">      .setChangelog(</span>
        new Change(&quot;10.4&quot;, &quot;Deprecated. Use GET api/v2/users-management/users instead&quot;),
        new Change(&quot;10.3&quot;, &quot;New optional parameters &quot; + EXTERNAL_IDENTITY + &quot; to find a user by its IdP login&quot;),
        new Change(&quot;10.1&quot;, &quot;New optional parameters &quot; + SONAR_LINT_LAST_CONNECTION_DATE_FROM +
          &quot; and &quot; + SONAR_LINT_LAST_CONNECTION_DATE_TO + &quot; to filter users by SonarLint last connection date. Only available with Administer System permission.&quot;),
        new Change(&quot;10.1&quot;, &quot;New optional parameters &quot; + LAST_CONNECTION_DATE_FROM +
          &quot; and &quot; + LAST_CONNECTION_DATE_TO + &quot; to filter users by SonarQube last connection date. Only available with Administer System permission.&quot;),
        new Change(&quot;10.1&quot;, &quot;New field 'sonarLintLastConnectionDate' is added to response&quot;),
        new Change(&quot;10.0&quot;, &quot;'q' parameter values is now always performing a case insensitive match&quot;),
        new Change(&quot;10.0&quot;, &quot;New parameter 'managed' to optionally search by managed status&quot;),
        new Change(&quot;10.0&quot;, &quot;Response includes 'managed' field.&quot;),
        new Change(&quot;9.7&quot;, &quot;New parameter 'deactivated' to optionally search for deactivated users&quot;),
        new Change(&quot;7.7&quot;, &quot;New field 'lastConnectionDate' is added to response&quot;),
        new Change(&quot;7.4&quot;, &quot;External identity is only returned to system administrators&quot;),
        new Change(&quot;6.4&quot;, &quot;Paging response fields moved to a Paging object&quot;),
        new Change(&quot;6.4&quot;, &quot;Avatar has been added to the response&quot;),
        new Change(&quot;6.4&quot;, &quot;Email is only returned when user has Administer System permission&quot;))
<span class="fc" id="L99">      .setHandler(this)</span>
<span class="fc" id="L100">      .setResponseExample(getClass().getResource(&quot;search-example.json&quot;))</span>
<span class="fc" id="L101">      .setDeprecatedSince(&quot;10.4&quot;);</span>

<span class="fc" id="L103">    action.addPagingParams(50, SearchOptions.MAX_PAGE_SIZE);</span>

<span class="fc" id="L105">    final String dateExample = &quot;2020-01-01T00:00:00+0100&quot;;</span>
<span class="fc" id="L106">    action.createParam(TEXT_QUERY)</span>
<span class="fc" id="L107">      .setMinimumLength(2)</span>
<span class="fc" id="L108">      .setDescription(&quot;Filter on login, name and email.&lt;br /&gt;&quot; +</span>
        &quot;This parameter performs a partial match (contains), it is case insensitive.&quot;);
<span class="fc" id="L110">    action.createParam(DEACTIVATED_PARAM)</span>
<span class="fc" id="L111">      .setSince(&quot;9.7&quot;)</span>
<span class="fc" id="L112">      .setDescription(&quot;Return deactivated users instead of active users&quot;)</span>
<span class="fc" id="L113">      .setRequired(false)</span>
<span class="fc" id="L114">      .setDefaultValue(false)</span>
<span class="fc" id="L115">      .setBooleanPossibleValues();</span>
<span class="fc" id="L116">    action.createParam(MANAGED_PARAM)</span>
<span class="fc" id="L117">      .setSince(&quot;10.0&quot;)</span>
<span class="fc" id="L118">      .setDescription(&quot;Return managed or non-managed users. Only available for managed instances, throws for non-managed instances.&quot;)</span>
<span class="fc" id="L119">      .setRequired(false)</span>
<span class="fc" id="L120">      .setDefaultValue(null)</span>
<span class="fc" id="L121">      .setBooleanPossibleValues();</span>
<span class="fc" id="L122">    action.createParam(LAST_CONNECTION_DATE_FROM)</span>
<span class="fc" id="L123">      .setSince(&quot;10.1&quot;)</span>
<span class="fc" id="L124">      .setDescription(&quot;&quot;&quot;</span>
        Filter the users based on the last connection date field.
        Only users who interacted with this instance at or after the date will be returned.
        The format must be ISO 8601 datetime format (YYYY-MM-DDThh:mm:ssÂ±hhmm)&quot;&quot;&quot;)
<span class="fc" id="L128">      .setRequired(false)</span>
<span class="fc" id="L129">      .setDefaultValue(null)</span>
<span class="fc" id="L130">      .setExampleValue(dateExample);</span>
<span class="fc" id="L131">    action.createParam(LAST_CONNECTION_DATE_TO)</span>
<span class="fc" id="L132">      .setSince(&quot;10.1&quot;)</span>
<span class="fc" id="L133">      .setDescription(&quot;&quot;&quot;</span>
        Filter the users based on the last connection date field.
        Only users that never connected or who interacted with this instance at or before the date will be returned.
        The format must be ISO 8601 datetime format (YYYY-MM-DDThh:mm:ssÂ±hhmm)&quot;&quot;&quot;)
<span class="fc" id="L137">      .setRequired(false)</span>
<span class="fc" id="L138">      .setDefaultValue(null)</span>
<span class="fc" id="L139">      .setExampleValue(dateExample);</span>
<span class="fc" id="L140">    action.createParam(SONAR_LINT_LAST_CONNECTION_DATE_FROM)</span>
<span class="fc" id="L141">      .setSince(&quot;10.1&quot;)</span>
<span class="fc" id="L142">      .setDescription(&quot;&quot;&quot;</span>
        Filter the users based on the sonar lint last connection date field
        Only users who interacted with this instance using SonarLint at or after the date will be returned.
        The format must be ISO 8601 datetime format (YYYY-MM-DDThh:mm:ssÂ±hhmm)&quot;&quot;&quot;)
<span class="fc" id="L146">      .setRequired(false)</span>
<span class="fc" id="L147">      .setDefaultValue(null)</span>
<span class="fc" id="L148">      .setExampleValue(dateExample);</span>
<span class="fc" id="L149">    action.createParam(SONAR_LINT_LAST_CONNECTION_DATE_TO)</span>
<span class="fc" id="L150">      .setSince(&quot;10.1&quot;)</span>
<span class="fc" id="L151">      .setDescription(&quot;&quot;&quot;</span>
        Filter the users based on the sonar lint last connection date field.
        Only users that never connected or who interacted with this instance using SonarLint at or before the date will be returned.
        The format must be ISO 8601 datetime format (YYYY-MM-DDThh:mm:ssÂ±hhmm)&quot;&quot;&quot;)
<span class="fc" id="L155">      .setRequired(false)</span>
<span class="fc" id="L156">      .setDefaultValue(null)</span>
<span class="fc" id="L157">      .setExampleValue(dateExample);</span>
<span class="fc" id="L158">    action.createParam(EXTERNAL_IDENTITY)</span>
<span class="fc" id="L159">      .setSince(&quot;10.3&quot;)</span>
<span class="fc" id="L160">      .setDescription(&quot;&quot;&quot;</span>
        Find a user by its external identity (ie. its login in the Identity Provider).
        This is case sensitive and only available with Administer System permission.
        &quot;&quot;&quot;);
<span class="fc" id="L164">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L168">    throwIfAdminOnlyParametersAreUsed(request);</span>
<span class="fc" id="L169">    Users.SearchWsResponse wsResponse = doHandle(toSearchRequest(request));</span>
<span class="fc" id="L170">    writeProtobuf(wsResponse, request, response);</span>
<span class="fc" id="L171">  }</span>

  private void throwIfAdminOnlyParametersAreUsed(Request request) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">    if (!userSession.isSystemAdministrator()) {</span>
<span class="fc" id="L175">      throwIfParameterValuePresent(request, LAST_CONNECTION_DATE_FROM);</span>
<span class="fc" id="L176">      throwIfParameterValuePresent(request, LAST_CONNECTION_DATE_TO);</span>
<span class="fc" id="L177">      throwIfParameterValuePresent(request, SONAR_LINT_LAST_CONNECTION_DATE_FROM);</span>
<span class="fc" id="L178">      throwIfParameterValuePresent(request, SONAR_LINT_LAST_CONNECTION_DATE_TO);</span>
<span class="fc" id="L179">      throwIfParameterValuePresent(request, EXTERNAL_IDENTITY);</span>
    }
<span class="fc" id="L181">  }</span>

  private Users.SearchWsResponse doHandle(UsersSearchRequest request) {
<span class="fc" id="L184">    SearchResults&lt;UserInformation&gt; userSearchResults = userService.findUsers(request);</span>
<span class="fc" id="L185">    PaginationInformation paging = forPageIndex(request.getPage()).withPageSize(request.getPageSize()).andTotal(userSearchResults.total());</span>

<span class="fc" id="L187">    return searchWsReponseGenerator.toUsersForResponse(userSearchResults.searchResults(), paging);</span>
  }

  private static UsersSearchRequest toSearchRequest(Request request) {
<span class="fc" id="L191">    int pageSize = request.mandatoryParamAsInt(PAGE_SIZE);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">    checkArgument(pageSize &lt;= MAX_PAGE_SIZE, &quot;The '%s' parameter must be less than %s&quot;, PAGE_SIZE, MAX_PAGE_SIZE);</span>
<span class="fc" id="L193">    return UsersSearchRequest.builder()</span>
<span class="fc" id="L194">      .setQuery(request.param(TEXT_QUERY))</span>
<span class="fc" id="L195">      .setDeactivated(request.mandatoryParamAsBoolean(DEACTIVATED_PARAM))</span>
<span class="fc" id="L196">      .setManaged(request.paramAsBoolean(MANAGED_PARAM))</span>
<span class="fc" id="L197">      .setLastConnectionDateFrom(request.param(LAST_CONNECTION_DATE_FROM))</span>
<span class="fc" id="L198">      .setLastConnectionDateTo(request.param(LAST_CONNECTION_DATE_TO))</span>
<span class="fc" id="L199">      .setSonarLintLastConnectionDateFrom(request.param(SONAR_LINT_LAST_CONNECTION_DATE_FROM))</span>
<span class="fc" id="L200">      .setSonarLintLastConnectionDateTo(request.param(SONAR_LINT_LAST_CONNECTION_DATE_TO))</span>
<span class="fc" id="L201">      .setExternalLogin(request.param(EXTERNAL_IDENTITY))</span>
<span class="fc" id="L202">      .setPage(request.mandatoryParamAsInt(PAGE))</span>
<span class="fc" id="L203">      .setPageSize(pageSize)</span>
<span class="fc" id="L204">      .build();</span>
  }

  private static void throwIfParameterValuePresent(Request request, String parameter) {
<span class="pc" id="L208">    Optional.ofNullable(request.param(parameter)).ifPresent(v -&gt; throwForbiddenFor(parameter));</span>
<span class="fc" id="L209">  }</span>

  private static void throwForbiddenFor(String parameterName) {
<span class="fc" id="L212">    throw new ServerException(403, &quot;parameter &quot; + parameterName + &quot; requires Administer System permission.&quot;);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>