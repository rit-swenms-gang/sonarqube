<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PluginFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.scanner.bootstrap</a> &gt; <span class="el_source">PluginFiles.java</span></div><h1>PluginFiles.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.scanner.bootstrap;

import com.google.common.annotations.VisibleForTesting;
import java.io.BufferedInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardCopyOption;
import java.util.Optional;
import org.apache.commons.codec.digest.DigestUtils;
import org.apache.commons.io.FileUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.api.config.Configuration;
import org.sonar.scanner.bootstrap.ScannerPluginInstaller.InstalledPlugin;
import org.sonar.scanner.http.DefaultScannerWsClient;
import org.sonarqube.ws.client.GetRequest;
import org.sonarqube.ws.client.HttpException;
import org.sonarqube.ws.client.WsResponse;

import static java.lang.String.format;

public class PluginFiles {

<span class="fc" id="L47">  private static final Logger LOGGER = LoggerFactory.getLogger(PluginFiles.class);</span>
  private static final String MD5_HEADER = &quot;Sonar-MD5&quot;;
  @VisibleForTesting
  static final String PLUGINS_DOWNLOAD_TIMEOUT_PROPERTY = &quot;sonar.plugins.download.timeout&quot;;
  private static final int PLUGINS_DOWNLOAD_TIMEOUT_DEFAULT = 300;

  private final DefaultScannerWsClient wsClient;
  private final Configuration configuration;
  private final Path cacheDir;
  private final Path tempDir;

<span class="fc" id="L58">  public PluginFiles(DefaultScannerWsClient wsClient, Configuration configuration, SonarUserHome sonarUserHome) {</span>
<span class="fc" id="L59">    this.wsClient = wsClient;</span>
<span class="fc" id="L60">    this.configuration = configuration;</span>
<span class="fc" id="L61">    var home = sonarUserHome.getPath();</span>
<span class="fc" id="L62">    this.cacheDir = mkdir(home.resolve(&quot;cache&quot;), &quot;user cache&quot;);</span>
<span class="fc" id="L63">    this.tempDir = mkdir(home.resolve(&quot;_tmp&quot;), &quot;temp dir&quot;);</span>
<span class="fc" id="L64">    LOGGER.debug(&quot;User cache: {}&quot;, cacheDir);</span>
<span class="fc" id="L65">  }</span>

  public File createTempDir() {
    try {
<span class="nc" id="L69">      return Files.createTempDirectory(tempDir, &quot;plugins&quot;).toFile();</span>
<span class="nc" id="L70">    } catch (IOException e) {</span>
<span class="nc" id="L71">      throw new IllegalStateException(&quot;Fail to create temp directory in &quot; + tempDir, e);</span>
    }
  }

  /**
   * Get the JAR file of specified plugin. If not present in user local cache,
   * then it's downloaded from server and added to cache.
   *
   * @return the file, or {@link Optional#empty()} if plugin not found (404 HTTP code)
   * @throws IllegalStateException if the plugin can't be downloaded (not 404 nor 2xx HTTP codes)
   * or can't be cached locally.
   */
  public Optional&lt;File&gt; get(InstalledPlugin plugin) {
    // Does not fail if another process tries to create the directory at the same time.
<span class="fc" id="L85">    Path jarInCache = jarInCache(plugin.key, plugin.hash);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">    if (Files.isRegularFile(jarInCache)) {</span>
<span class="fc" id="L87">      return Optional.of(jarInCache.toFile());</span>
    }
<span class="fc" id="L89">    return download(plugin).map(Path::toFile);</span>
  }

  private Optional&lt;Path&gt; download(InstalledPlugin plugin) {
<span class="fc" id="L93">    GetRequest request = new GetRequest(&quot;api/plugins/download&quot;)</span>
<span class="fc" id="L94">      .setParam(&quot;plugin&quot;, plugin.key)</span>
<span class="fc" id="L95">      .setTimeOutInMs(configuration.getInt(PLUGINS_DOWNLOAD_TIMEOUT_PROPERTY).orElse(PLUGINS_DOWNLOAD_TIMEOUT_DEFAULT) * 1000);</span>

<span class="fc" id="L97">    Path downloadedFile = newTempFile();</span>
<span class="fc" id="L98">    LOGGER.debug(&quot;Download plugin '{}' to '{}'&quot;, plugin.key, downloadedFile);</span>

<span class="fc" id="L100">    try (WsResponse response = wsClient.call(request)) {</span>
<span class="fc" id="L101">      Optional&lt;String&gt; expectedMd5 = response.header(MD5_HEADER);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">      if (expectedMd5.isEmpty()) {</span>
<span class="fc" id="L103">        throw new IllegalStateException(format(</span>
<span class="fc" id="L104">          &quot;Fail to download plugin [%s]. Request to %s did not return header %s&quot;, plugin.key, response.requestUrl(), MD5_HEADER));</span>
      }

<span class="fc" id="L107">      downloadBinaryTo(plugin, downloadedFile, response);</span>

      // verify integrity
<span class="fc" id="L110">      String effectiveTempMd5 = computeMd5(downloadedFile);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">      if (!expectedMd5.get().equals(effectiveTempMd5)) {</span>
<span class="fc" id="L112">        throw new IllegalStateException(format(</span>
<span class="fc" id="L113">          &quot;Fail to download plugin [%s]. File %s was expected to have checksum %s but had %s&quot;, plugin.key, downloadedFile, expectedMd5.get(), effectiveTempMd5));</span>
      }

      // un-compress if needed
      String cacheMd5;
      Path tempJar;

<span class="fc" id="L120">      tempJar = downloadedFile;</span>
<span class="fc" id="L121">      cacheMd5 = expectedMd5.get();</span>

      // put in cache
<span class="fc" id="L124">      Path jarInCache = jarInCache(plugin.key, cacheMd5);</span>
<span class="fc" id="L125">      mkdir(jarInCache.getParent());</span>
<span class="fc" id="L126">      moveFile(tempJar, jarInCache);</span>
<span class="fc" id="L127">      return Optional.of(jarInCache);</span>

<span class="fc" id="L129">    } catch (HttpException e) {</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">      if (e.code() == HttpURLConnection.HTTP_NOT_FOUND) {</span>
        // Plugin was listed but not longer available. It has probably been
        // uninstalled.
<span class="fc" id="L133">        return Optional.empty();</span>
      }

      // not 2xx nor 404
<span class="fc" id="L137">      throw new IllegalStateException(format(&quot;Fail to download plugin [%s]. Request to %s returned code %d.&quot;, plugin.key, e.url(), e.code()));</span>
    }
  }

  private static void downloadBinaryTo(InstalledPlugin plugin, Path downloadedFile, WsResponse response) {
<span class="fc" id="L142">    try (InputStream stream = response.contentStream()) {</span>
<span class="fc" id="L143">      FileUtils.copyInputStreamToFile(stream, downloadedFile.toFile());</span>
<span class="nc" id="L144">    } catch (IOException e) {</span>
<span class="nc" id="L145">      throw new IllegalStateException(format(&quot;Fail to download plugin [%s] into %s&quot;, plugin.key, downloadedFile), e);</span>
<span class="fc" id="L146">    }</span>
<span class="fc" id="L147">  }</span>

  private Path jarInCache(String pluginKey, String hash) {
<span class="fc" id="L150">    Path hashDir = cacheDir.resolve(hash);</span>
<span class="fc" id="L151">    Path file = hashDir.resolve(format(&quot;sonar-%s-plugin.jar&quot;, pluginKey));</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">    if (!file.getParent().equals(hashDir)) {</span>
      // vulnerability - attempt to create a file outside the cache directory
<span class="fc" id="L154">      throw new IllegalStateException(format(&quot;Fail to download plugin [%s]. Key is not valid.&quot;, pluginKey));</span>
    }
<span class="fc" id="L156">    return file;</span>
  }

  private Path newTempFile() {
    try {
<span class="fc" id="L161">      return Files.createTempFile(tempDir, &quot;fileCache&quot;, null);</span>
<span class="nc" id="L162">    } catch (IOException e) {</span>
<span class="nc" id="L163">      throw new IllegalStateException(&quot;Fail to create temp file in &quot; + tempDir, e);</span>
    }
  }

  private static String computeMd5(Path file) {
<span class="fc" id="L168">    try (InputStream fis = new BufferedInputStream(Files.newInputStream(file))) {</span>
<span class="fc" id="L169">      return DigestUtils.md5Hex(fis);</span>
<span class="nc" id="L170">    } catch (IOException e) {</span>
<span class="nc" id="L171">      throw new IllegalStateException(&quot;Fail to compute md5 of &quot; + file, e);</span>
    }
  }

  private static void moveFile(Path sourceFile, Path targetFile) {
    try {
<span class="fc" id="L177">      Files.move(sourceFile, targetFile, StandardCopyOption.ATOMIC_MOVE);</span>
<span class="nc" id="L178">    } catch (IOException e1) {</span>
      // Check if the file was cached by another process during download
<span class="nc bnc" id="L180" title="All 2 branches missed.">      if (!Files.exists(targetFile)) {</span>
<span class="nc" id="L181">        LOGGER.warn(&quot;Unable to rename {} to {}&quot;, sourceFile, targetFile);</span>
<span class="nc" id="L182">        LOGGER.warn(&quot;A copy/delete will be tempted but with no guarantee of atomicity&quot;);</span>
        try {
<span class="nc" id="L184">          Files.move(sourceFile, targetFile);</span>
<span class="nc" id="L185">        } catch (IOException e2) {</span>
<span class="nc" id="L186">          throw new IllegalStateException(&quot;Fail to move &quot; + sourceFile + &quot; to &quot; + targetFile, e2);</span>
<span class="nc" id="L187">        }</span>
      }
<span class="fc" id="L189">    }</span>
<span class="fc" id="L190">  }</span>

  private static void mkdir(Path dir) {
    try {
<span class="fc" id="L194">      Files.createDirectories(dir);</span>
<span class="nc" id="L195">    } catch (IOException e) {</span>
<span class="nc" id="L196">      throw new IllegalStateException(&quot;Fail to create cache directory: &quot; + dir, e);</span>
<span class="fc" id="L197">    }</span>
<span class="fc" id="L198">  }</span>

  private static Path mkdir(Path dir, String debugTitle) {
<span class="fc bfc" id="L201" title="All 2 branches covered.">    if (!Files.isDirectory(dir)) {</span>
<span class="fc" id="L202">      LOGGER.debug(&quot;Create : {}&quot;, dir);</span>
      try {
<span class="fc" id="L204">        Files.createDirectories(dir);</span>
<span class="nc" id="L205">      } catch (IOException e) {</span>
<span class="nc" id="L206">        throw new IllegalStateException(&quot;Unable to create folder &quot; + debugTitle + &quot; at &quot; + dir, e);</span>
<span class="fc" id="L207">      }</span>
    }
<span class="fc" id="L209">    return dir;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>