<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SecurityHotspotWorkflowDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.issue.workflow.securityhotspot</a> &gt; <span class="el_source">SecurityHotspotWorkflowDefinition.java</span></div><h1>SecurityHotspotWorkflowDefinition.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.issue.workflow.securityhotspot;

import java.util.function.Consumer;
import org.sonar.api.ce.ComputeEngineSide;
import org.sonar.api.server.ServerSide;
import org.sonar.issue.workflow.statemachine.StateMachine;
import org.sonar.issue.workflow.statemachine.Transition;

import static org.sonar.api.issue.Issue.RESOLUTION_ACKNOWLEDGED;
import static org.sonar.api.issue.Issue.RESOLUTION_FIXED;
import static org.sonar.api.issue.Issue.RESOLUTION_REMOVED;
import static org.sonar.api.issue.Issue.RESOLUTION_SAFE;
import static org.sonar.api.issue.Issue.STATUS_CLOSED;
import static org.sonar.api.issue.Issue.STATUS_REVIEWED;
import static org.sonar.api.issue.Issue.STATUS_TO_REVIEW;
import static org.sonar.server.issue.workflow.securityhotspot.SecurityHotspotWorkflowTransition.RESET_AS_TO_REVIEW;
import static org.sonar.server.issue.workflow.securityhotspot.SecurityHotspotWorkflowTransition.RESOLVE_AS_ACKNOWLEDGED;
import static org.sonar.server.issue.workflow.securityhotspot.SecurityHotspotWorkflowTransition.RESOLVE_AS_REVIEWED;
import static org.sonar.server.issue.workflow.securityhotspot.SecurityHotspotWorkflowTransition.RESOLVE_AS_SAFE;

@ServerSide
@ComputeEngineSide
public class SecurityHotspotWorkflowDefinition {

  private static final String AUTOMATIC_CLOSE_TRANSITION = &quot;automaticclose&quot;;
  public static final String AUTOMATIC_UNCLOSE_TO_REVIEW = &quot;automaticunclosetoreview&quot;;
  public static final String AUTOMATIC_UNCLOSE_REVIEWED = &quot;automaticunclosereviewed&quot;;

<span class="fc" id="L48">  private static final Consumer&lt;SecurityHotspotWorkflowActions&gt; SET_CLOSE_DATE = SecurityHotspotWorkflowActions::setCloseDate;</span>
<span class="fc" id="L49">  private static final Consumer&lt;SecurityHotspotWorkflowActions&gt; SET_CLOSED = SecurityHotspotWorkflowActions::setClosed;</span>
<span class="fc" id="L50">  private static final Consumer&lt;SecurityHotspotWorkflowActions&gt; UNSET_CLOSE_DATE = SecurityHotspotWorkflowActions::unsetCloseDate;</span>
<span class="fc" id="L51">  private static final Consumer&lt;SecurityHotspotWorkflowActions&gt; UNSET_RESOLUTION = SecurityHotspotWorkflowActions::unsetResolution;</span>
<span class="fc" id="L52">  private static final Consumer&lt;SecurityHotspotWorkflowActions&gt; RESTORE_RESOLUTION = SecurityHotspotWorkflowActions::restoreResolution;</span>
  private final StateMachine&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; machine;

<span class="fc" id="L55">  public SecurityHotspotWorkflowDefinition() {</span>
    StateMachine.Builder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; builder = StateMachine
<span class="fc" id="L57">      .&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder()</span>
<span class="fc" id="L58">      .states(STATUS_TO_REVIEW, STATUS_REVIEWED, STATUS_CLOSED);</span>
<span class="fc" id="L59">    buildManualTransitions(builder);</span>
<span class="fc" id="L60">    buildAutomaticTransitions(builder);</span>
<span class="fc" id="L61">    machine = builder.build();</span>
<span class="fc" id="L62">  }</span>

  public StateMachine&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; getMachine() {
<span class="fc" id="L65">    return machine;</span>
  }

  private static void buildManualTransitions(StateMachine.Builder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; builder) {
    // hotspot reviewed as fixed, either from TO_REVIEW or from REVIEWED-SAFE or from REVIEWED-ACKNOWLEDGED
<span class="fc" id="L70">    Transition.TransitionBuilder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; reviewedAsFixedBuilder = Transition</span>
<span class="fc" id="L71">      .&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(RESOLVE_AS_REVIEWED.getKey())</span>
<span class="fc" id="L72">      .to(STATUS_REVIEWED)</span>
<span class="fc" id="L73">      .actions(a -&gt; a.setResolution(RESOLUTION_FIXED));</span>
<span class="fc" id="L74">    builder</span>
<span class="fc" id="L75">      .transition(reviewedAsFixedBuilder</span>
<span class="fc" id="L76">        .from(STATUS_TO_REVIEW)</span>
<span class="fc" id="L77">        .build())</span>
<span class="fc" id="L78">      .transition(reviewedAsFixedBuilder</span>
<span class="fc" id="L79">        .from(STATUS_REVIEWED)</span>
<span class="fc" id="L80">        .conditions(sh -&gt; sh.hasAnyResolution(RESOLUTION_SAFE, RESOLUTION_ACKNOWLEDGED))</span>
<span class="fc" id="L81">        .build());</span>

    // hotspot reviewed as safe, either from TO_REVIEW or from REVIEWED-FIXED or from REVIEWED-ACKNOWLEDGED
<span class="fc" id="L84">    Transition.TransitionBuilder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; resolveAsSafeTransitionBuilder = Transition</span>
<span class="fc" id="L85">      .&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(RESOLVE_AS_SAFE.getKey())</span>
<span class="fc" id="L86">      .to(STATUS_REVIEWED)</span>
<span class="fc" id="L87">      .actions(a -&gt; a.setResolution(RESOLUTION_SAFE));</span>
<span class="fc" id="L88">    builder</span>
<span class="fc" id="L89">      .transition(resolveAsSafeTransitionBuilder</span>
<span class="fc" id="L90">        .from(STATUS_TO_REVIEW)</span>
<span class="fc" id="L91">        .build())</span>
<span class="fc" id="L92">      .transition(resolveAsSafeTransitionBuilder</span>
<span class="fc" id="L93">        .from(STATUS_REVIEWED)</span>
<span class="fc" id="L94">        .conditions(sh -&gt; sh.hasAnyResolution(RESOLUTION_FIXED, RESOLUTION_ACKNOWLEDGED))</span>
<span class="fc" id="L95">        .build());</span>

    // hotspot reviewed as acknowledged, either from TO_REVIEW or from REVIEWED-FIXED or from REVIEWED-SAFE
<span class="fc" id="L98">    Transition.TransitionBuilder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; resolveAsAcknowledgedTransitionBuilder = Transition</span>
<span class="fc" id="L99">      .&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(RESOLVE_AS_ACKNOWLEDGED.getKey())</span>
<span class="fc" id="L100">      .to(STATUS_REVIEWED)</span>
<span class="pc" id="L101">      .actions(a -&gt; a.setResolution(RESOLUTION_ACKNOWLEDGED));</span>
<span class="fc" id="L102">    builder</span>
<span class="fc" id="L103">      .transition(resolveAsAcknowledgedTransitionBuilder</span>
<span class="fc" id="L104">        .from(STATUS_TO_REVIEW)</span>
<span class="fc" id="L105">        .build())</span>
<span class="fc" id="L106">      .transition(resolveAsAcknowledgedTransitionBuilder</span>
<span class="fc" id="L107">        .from(STATUS_REVIEWED)</span>
<span class="fc" id="L108">        .conditions(sh -&gt; sh.hasAnyResolution(RESOLUTION_FIXED, RESOLUTION_SAFE))</span>
<span class="fc" id="L109">        .build());</span>

    // put hotspot back into TO_REVIEW
<span class="fc" id="L112">    builder</span>
<span class="fc" id="L113">      .transition(Transition.&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(RESET_AS_TO_REVIEW.getKey())</span>
<span class="fc" id="L114">        .from(STATUS_REVIEWED).to(STATUS_TO_REVIEW)</span>
<span class="fc" id="L115">        .conditions(sh -&gt; sh.hasAnyResolution(RESOLUTION_FIXED, RESOLUTION_SAFE, RESOLUTION_ACKNOWLEDGED))</span>
<span class="fc" id="L116">        .actions(UNSET_RESOLUTION)</span>
<span class="fc" id="L117">        .build());</span>
<span class="fc" id="L118">  }</span>

  private static void buildAutomaticTransitions(StateMachine.Builder&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt; builder) {
<span class="fc" id="L121">    builder</span>
      // Close the &quot;end of life&quot; issues (disabled/deleted rule, deleted component)
<span class="fc" id="L123">      .transition(Transition.&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(AUTOMATIC_CLOSE_TRANSITION)</span>
<span class="fc" id="L124">        .from(STATUS_TO_REVIEW).to(STATUS_CLOSED)</span>
<span class="fc" id="L125">        .conditions(SecurityHotspotWorkflowEntity::isBeingClosed)</span>
<span class="fc" id="L126">        .actions(SET_CLOSED, SET_CLOSE_DATE)</span>
<span class="fc" id="L127">        .automatic()</span>
<span class="fc" id="L128">        .build())</span>
<span class="fc" id="L129">      .transition(Transition.&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(AUTOMATIC_CLOSE_TRANSITION)</span>
<span class="fc" id="L130">        .from(STATUS_REVIEWED).to(STATUS_CLOSED)</span>
<span class="fc" id="L131">        .conditions(SecurityHotspotWorkflowEntity::isBeingClosed)</span>
<span class="fc" id="L132">        .actions(SET_CLOSED, SET_CLOSE_DATE)</span>
<span class="fc" id="L133">        .automatic()</span>
<span class="fc" id="L134">        .build())</span>
      // reopen closed hotspots
<span class="fc" id="L136">      .transition(Transition.&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(AUTOMATIC_UNCLOSE_TO_REVIEW)</span>
<span class="fc" id="L137">        .from(STATUS_CLOSED).to(STATUS_TO_REVIEW)</span>
<span class="fc" id="L138">        .conditions(</span>
<span class="fc" id="L139">          sh -&gt; sh.previousStatusWas(STATUS_TO_REVIEW),</span>
<span class="fc" id="L140">          sh -&gt; sh.hasAnyResolution(RESOLUTION_REMOVED, RESOLUTION_FIXED))</span>
<span class="fc" id="L141">        .actions(RESTORE_RESOLUTION, UNSET_CLOSE_DATE)</span>
<span class="fc" id="L142">        .automatic()</span>
<span class="fc" id="L143">        .build())</span>
<span class="fc" id="L144">      .transition(Transition.&lt;SecurityHotspotWorkflowEntity, SecurityHotspotWorkflowActions&gt;builder(AUTOMATIC_UNCLOSE_REVIEWED)</span>
<span class="fc" id="L145">        .from(STATUS_CLOSED).to(STATUS_REVIEWED)</span>
<span class="fc" id="L146">        .conditions(</span>
<span class="fc" id="L147">          sh -&gt; sh.previousStatusWas(STATUS_REVIEWED),</span>
<span class="fc" id="L148">          sh -&gt; sh.hasAnyResolution(RESOLUTION_REMOVED, RESOLUTION_FIXED))</span>
<span class="fc" id="L149">        .actions(RESTORE_RESOLUTION, UNSET_CLOSE_DATE)</span>
<span class="fc" id="L150">        .automatic()</span>
<span class="fc" id="L151">        .build());</span>
<span class="fc" id="L152">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>