<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EducationRulesDefinition.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.education</a> &gt; <span class="el_source">EducationRulesDefinition.java</span></div><h1>EducationRulesDefinition.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.education;

import java.nio.charset.StandardCharsets;
import org.apache.commons.io.IOUtils;
import org.sonar.api.server.rule.RuleDescriptionSection;
import org.sonar.api.server.rule.RulesDefinition;
import org.sonar.education.sensors.EducationPrinciplesSensor;
import org.sonar.education.sensors.EducationWithContextsSensor;
import org.sonar.education.sensors.EducationWithDetectedContextSensor;

import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.ASSESS_THE_PROBLEM_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.HOW_TO_FIX_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.INTRODUCTION_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.RESOURCES_SECTION_KEY;
import static org.sonar.api.server.rule.RuleDescriptionSection.RuleDescriptionSectionKeys.ROOT_CAUSE_SECTION_KEY;
import static org.sonar.education.sensors.EducationWith2LinkedCodeSnippetsSensor.EDUCATION_WITH_2_LINKED_CODE_SNIPPETS_RULE_KEY;
import static org.sonar.education.sensors.EducationWith4LinkedCodeSnippetsSensor.EDUCATION_WITH_4_LINKED_CODE_SNIPPETS_RULE_KEY;
import static org.sonar.education.sensors.EducationWithSingleContextSensor.EDUCATION_WITH_SINGLE_CONTEXT_RULE_KEY;

<span class="fc" id="L39">public class EducationRulesDefinition implements RulesDefinition {</span>

  public static final String EDUCATION_RULE_REPOSITORY_KEY = &quot;edu&quot;;
  public static final String EDUCATION_KEY = &quot;education&quot;;

<span class="fc" id="L44">  private static final String[] ALL_SECTIONS = {INTRODUCTION_SECTION_KEY, ROOT_CAUSE_SECTION_KEY, ASSESS_THE_PROBLEM_SECTION_KEY,</span>
    RESOURCES_SECTION_KEY, HOW_TO_FIX_SECTION_KEY};
  private static final String IGNORED_FAKE_SECTION = &quot;fake_section_to_be_ignored&quot;;

<span class="fc" id="L48">  public static final String[] CONTEXTS = {&quot;spring&quot;, &quot;hibernate&quot;, &quot;apache_commons&quot;, &quot;vaadin&quot;, &quot;mybatis&quot;};</span>

  private static final String HTML_LOREM_IPSUM = &quot;&lt;a href=\&quot;https://google.com\&quot;&gt;Lorem&lt;/a&gt; ipsum dolor sit amet, consectetur adipiscing &quot; +
    &quot;elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco &quot; +
    &quot;laboris nisi ut aliquip ex ea commodo consequat.&lt;br /&gt;Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu &quot; +
    &quot;fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.&quot;;

  @Override
  public void define(Context context) {
<span class="fc" id="L57">    NewRepository repo = context.createRepository(EDUCATION_RULE_REPOSITORY_KEY, EDUCATION_KEY);</span>

<span class="fc" id="L59">    createRuleWithDescriptionSectionsAndEducationPrinciples(repo);</span>
<span class="fc" id="L60">    createRuleWithDescriptionSectionsAndSingleContext(repo);</span>
<span class="fc" id="L61">    createRuleWithDescriptionSectionsAndMultipleContexts(repo);</span>
<span class="fc" id="L62">    createRuleWithDescriptionSectionsAndMultipleContextsIncludingOneDetected(repo);</span>

<span class="fc" id="L64">    createRuleWith2LinkedCodeSnippetsInTwoSections(repo);</span>

<span class="fc" id="L66">    createRuleWith4LinkedCodeSnippetsInOneSection(repo);</span>

<span class="fc" id="L68">    repo.done();</span>
<span class="fc" id="L69">  }</span>

  private void createRuleWithDescriptionSectionsAndEducationPrinciples(NewRepository repo) {
<span class="fc" id="L72">    String[] educationPrinciples = {&quot;defense_in_depth&quot;, &quot;never_trust_user_input&quot;};</span>
<span class="fc" id="L73">    String ruleKey = EducationPrinciplesSensor.EDUCATION_WITH_GENERIC_CONCEPTS_RULE_KEY;</span>
<span class="fc" id="L74">    NewRule ruleWithSingleContext = repo.createRule(ruleKey).setName(&quot;Rule with description sections and education principles&quot;)</span>
<span class="fc" id="L75">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L77">    ruleWithSingleContext</span>
<span class="fc" id="L78">      .setHtmlDescription(String.format(&quot;This rule contains description sections. To trigger an issue using this rule you need to &quot; +</span>
        &quot;scan any text file with a line containing %s key word. This rule also contains 2 education principles - %s and %s&quot;,
        ruleKey, educationPrinciples[0], educationPrinciples[1]))
<span class="fc" id="L81">      .addEducationPrincipleKeys(educationPrinciples);</span>

<span class="fc" id="L83">    addNonContextualizedDescriptionSections(ruleWithSingleContext);</span>
<span class="fc" id="L84">    descriptionSection(HOW_TO_FIX_SECTION_KEY);</span>
<span class="fc" id="L85">  }</span>

  private void createRuleWithDescriptionSectionsAndSingleContext(NewRepository repo) {
<span class="fc" id="L88">    String ruleKey = EDUCATION_WITH_SINGLE_CONTEXT_RULE_KEY;</span>
<span class="fc" id="L89">    NewRule ruleWithSingleContext = repo.createRule(ruleKey).setName(&quot;Rule with description sections and single &quot; +</span>
      &quot;contexts for 'how to fix'&quot;)
<span class="fc" id="L91">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L93">    ruleWithSingleContext</span>
<span class="fc" id="L94">      .setHtmlDescription(String.format(&quot;This rule contains description sections and single context for 'how to fix' section. To &quot; +</span>
        &quot;trigger an issue using this rule you need to scan any text file with a line containing %s key word.&quot;, ruleKey));

<span class="fc" id="L97">    addNonContextualizedDescriptionSections(ruleWithSingleContext);</span>

<span class="fc" id="L99">    ruleWithSingleContext.addDescriptionSection(descriptionHowToFixSectionWithContext(CONTEXTS[0]));</span>
<span class="fc" id="L100">  }</span>

  private void createRuleWithDescriptionSectionsAndMultipleContexts(NewRepository repo) {
<span class="fc" id="L103">    NewRule ruleWithMultipleContexts = repo.createRule(EducationWithContextsSensor.EDUCATION_WITH_CONTEXTS_RULE_KEY)</span>
<span class="fc" id="L104">      .setName(&quot;Rule with description sections and multiple contexts for 'how to fix'&quot;)</span>
<span class="fc" id="L105">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L107">    ruleWithMultipleContexts</span>
<span class="fc" id="L108">      .setHtmlDescription(String.format(&quot;This rule contains description sections and multiple contexts for 'how to fix' section. To trigger &quot; +</span>
        &quot;an issue using this rule you need to scan any text file with a line containing %s keyword.&quot;,
        EducationWithContextsSensor.EDUCATION_WITH_CONTEXTS_RULE_KEY));

<span class="fc" id="L112">    addNonContextualizedDescriptionSections(ruleWithMultipleContexts);</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">    for (String context : CONTEXTS) {</span>
<span class="fc" id="L115">      ruleWithMultipleContexts.addDescriptionSection(descriptionHowToFixSectionWithContext(context));</span>
    }
<span class="fc" id="L117">  }</span>

  private void createRuleWithDescriptionSectionsAndMultipleContextsIncludingOneDetected(NewRepository repo) {
<span class="fc" id="L120">    NewRule ruleWithMultipleContexts = repo.createRule(EducationWithDetectedContextSensor.EDUCATION_WITH_DETECTED_CONTEXT_RULE_KEY)</span>
<span class="fc" id="L121">      .setName(&quot;Rule with description sections and multiple contexts (including one detected) for 'how to fix'&quot;)</span>
<span class="fc" id="L122">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L124">    ruleWithMultipleContexts</span>
<span class="fc" id="L125">      .setHtmlDescription(String.format(&quot;This rule contains description sections and multiple contexts (including one detected) for &quot; +</span>
        &quot;'how to fix' section. To trigger an issue using this rule you need to scan any text file with a line containing %s keyword.&quot;,
        EducationWithDetectedContextSensor.EDUCATION_WITH_DETECTED_CONTEXT_RULE_KEY));

<span class="fc" id="L129">    addNonContextualizedDescriptionSections(ruleWithMultipleContexts);</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">    for (String context : CONTEXTS) {</span>
<span class="fc" id="L132">      ruleWithMultipleContexts.addDescriptionSection(descriptionHowToFixSectionWithContext(context));</span>
    }
<span class="fc" id="L134">  }</span>


  private void createRuleWith2LinkedCodeSnippetsInTwoSections(NewRepository repo) {
<span class="fc" id="L138">    String ruleKey = EDUCATION_WITH_2_LINKED_CODE_SNIPPETS_RULE_KEY;</span>
<span class="fc" id="L139">    NewRule rule2CodeSnippetsIn2Sections = repo.createRule(ruleKey).setName(&quot;Rule with description sections and code snippets &quot; +</span>
        &quot;linked to each other in 2 different sections in order to display diff between them.&quot;)
<span class="fc" id="L141">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L143">    rule2CodeSnippetsIn2Sections</span>
<span class="fc" id="L144">      .setHtmlDescription(String.format(&quot;This rule contains description sections and 2 linked code snippets in 2 sections. To &quot; +</span>
          &quot;trigger an issue using this rule you need to scan any text file with a line containing %s key word.&quot;, ruleKey));

<span class="fc" id="L147">    String completelyDifferentSnippetsHtml = readResource(&quot;2completelyDifferentSnippets.html&quot;);</span>
<span class="fc" id="L148">    String codeSnippetsHtml = readResource(&quot;2codeSnippets.html&quot;);</span>

<span class="fc" id="L150">    rule2CodeSnippetsIn2Sections.addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY))</span>
<span class="fc" id="L151">      .addDescriptionSection(descriptionSection(ROOT_CAUSE_SECTION_KEY, completelyDifferentSnippetsHtml))</span>
<span class="fc" id="L152">      .addDescriptionSection(descriptionSection(ASSESS_THE_PROBLEM_SECTION_KEY))</span>
<span class="fc" id="L153">      .addDescriptionSection(descriptionSection(HOW_TO_FIX_SECTION_KEY, codeSnippetsHtml))</span>
<span class="fc" id="L154">      .addDescriptionSection(descriptionSection(RESOURCES_SECTION_KEY));</span>
<span class="fc" id="L155">  }</span>

  private void createRuleWith4LinkedCodeSnippetsInOneSection(NewRepository repo) {
<span class="fc" id="L158">    String ruleKey = EDUCATION_WITH_4_LINKED_CODE_SNIPPETS_RULE_KEY;</span>
<span class="fc" id="L159">    NewRule rule2CodeSnippetsInTheSameSection = repo.createRule(ruleKey).setName(&quot;Rule with description sections and code snippets &quot; +</span>
        &quot;linked to each other in the same section in order to display diff between them.&quot;)
<span class="fc" id="L161">      .addTags(EDUCATION_KEY);</span>

<span class="fc" id="L163">    rule2CodeSnippetsInTheSameSection</span>
<span class="fc" id="L164">      .setHtmlDescription(String.format(&quot;This rule contains description sections and 4 linked code snippets in the same section. To &quot; +</span>
        &quot;trigger an issue using this rule you need to scan any text file with a line containing %s key word.&quot;, ruleKey));

<span class="fc" id="L167">    String codeSnippetsHtml = readResource(&quot;4codeSnippets.html&quot;);</span>

<span class="fc" id="L169">    rule2CodeSnippetsInTheSameSection.addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY))</span>
<span class="fc" id="L170">      .addDescriptionSection(descriptionSection(ROOT_CAUSE_SECTION_KEY, codeSnippetsHtml))</span>
<span class="fc" id="L171">      .addDescriptionSection(descriptionSection(ASSESS_THE_PROBLEM_SECTION_KEY))</span>
<span class="fc" id="L172">      .addDescriptionSection(descriptionSection(HOW_TO_FIX_SECTION_KEY))</span>
<span class="fc" id="L173">      .addDescriptionSection(descriptionSection(RESOURCES_SECTION_KEY));</span>
<span class="fc" id="L174">  }</span>

  private static void addNonContextualizedDescriptionSections(NewRule newRule) {
<span class="fc" id="L177">    newRule.addDescriptionSection(descriptionSection(INTRODUCTION_SECTION_KEY))</span>
<span class="fc" id="L178">      .addDescriptionSection(descriptionSection(ROOT_CAUSE_SECTION_KEY))</span>
<span class="fc" id="L179">      .addDescriptionSection(descriptionSection(ASSESS_THE_PROBLEM_SECTION_KEY))</span>
<span class="fc" id="L180">      .addDescriptionSection(descriptionSection(RESOURCES_SECTION_KEY))</span>
<span class="fc" id="L181">      .addDescriptionSection(descriptionSection(IGNORED_FAKE_SECTION));</span>
<span class="fc" id="L182">  }</span>

  private static RuleDescriptionSection descriptionHowToFixSectionWithContext(String context) {
<span class="fc" id="L185">    var ruleContext = new org.sonar.api.server.rule.Context(context, context);</span>
<span class="fc" id="L186">    return RuleDescriptionSection.builder()</span>
<span class="fc" id="L187">      .sectionKey(HOW_TO_FIX_SECTION_KEY)</span>
<span class="fc" id="L188">      .context(ruleContext)</span>
<span class="fc" id="L189">      .htmlContent(String.format(&quot;%s: %s&quot;, HOW_TO_FIX_SECTION_KEY, HTML_LOREM_IPSUM))</span>
<span class="fc" id="L190">      .build();</span>
  }

  private static RuleDescriptionSection descriptionSection(String sectionKey) {
<span class="fc" id="L194">    return descriptionSection(sectionKey, HTML_LOREM_IPSUM);</span>
  }

  private static RuleDescriptionSection descriptionSection(String sectionKey, String htmlContent) {
<span class="fc" id="L198">    return RuleDescriptionSection.builder()</span>
<span class="fc" id="L199">      .sectionKey(sectionKey)</span>
<span class="fc" id="L200">      .htmlContent(htmlContent)</span>
<span class="fc" id="L201">      .build();</span>
  }

  private String readResource(String file) {
    try {
<span class="fc" id="L206">      return IOUtils.toString(getClass().getResource(file), StandardCharsets.UTF_8);</span>
<span class="nc" id="L207">    } catch (Exception e) {</span>
<span class="nc" id="L208">      throw new RuntimeException(e);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>