<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TaskFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.ce.ws</a> &gt; <span class="el_source">TaskFormatter.java</span></div><h1>TaskFormatter.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.ce.ws;

import com.google.common.collect.Multimap;
import java.util.Collection;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.utils.DateUtils;
import org.sonar.api.utils.System2;
import org.sonar.core.util.stream.MoreCollectors;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.ce.CeActivityDto;
import org.sonar.db.ce.CeQueueDto;
import org.sonar.db.ce.CeTaskCharacteristicDto;
import org.sonar.db.ce.CeTaskMessageDto;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.dismissmessage.MessageType;
import org.sonar.db.user.UserDto;
import org.sonarqube.ws.Ce;
import org.sonarqube.ws.Common;

import static java.lang.String.format;
import static java.util.Collections.singletonList;
import static java.util.Optional.ofNullable;
import static org.sonar.api.utils.DateUtils.formatDateTime;
import static org.sonar.core.ce.CeTaskCharacteristics.BRANCH;
import static org.sonar.core.ce.CeTaskCharacteristics.BRANCH_TYPE;
import static org.sonar.core.ce.CeTaskCharacteristics.PULL_REQUEST;

/**
 * Converts {@link CeActivityDto} and {@link CeQueueDto} to the protobuf objects
 * used to write WS responses (see ws-ce.proto in module sonar-ws)
 */
public class TaskFormatter {

  private final DbClient dbClient;
  private final System2 system2;

<span class="fc" id="L67">  public TaskFormatter(DbClient dbClient, System2 system2) {</span>
<span class="fc" id="L68">    this.dbClient = dbClient;</span>
<span class="fc" id="L69">    this.system2 = system2;</span>
<span class="fc" id="L70">  }</span>

  public List&lt;Ce.Task&gt; formatQueue(DbSession dbSession, List&lt;CeQueueDto&gt; dtos) {
<span class="fc" id="L73">    DtoCache cache = DtoCache.forQueueDtos(dbClient, dbSession, dtos);</span>
<span class="fc" id="L74">    return dtos.stream().map(input -&gt; formatQueue(input, cache)).toList();</span>
  }

  public Ce.Task formatQueue(DbSession dbSession, CeQueueDto queue) {
<span class="fc" id="L78">    return formatQueue(queue, DtoCache.forQueueDtos(dbClient, dbSession, singletonList(queue)));</span>
  }

  private Ce.Task formatQueue(CeQueueDto dto, DtoCache cache) {
<span class="fc" id="L82">    Ce.Task.Builder builder = Ce.Task.newBuilder();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">    if (dto.getComponentUuid() != null) {</span>
<span class="fc" id="L84">      builder.setComponentId(dto.getComponentUuid());</span>
<span class="fc" id="L85">      setComponent(builder, dto.getComponentUuid(), cache);</span>
    }
<span class="fc" id="L87">    builder.setId(dto.getUuid());</span>
<span class="fc" id="L88">    builder.setStatus(Ce.TaskStatus.valueOf(dto.getStatus().name()));</span>
<span class="fc" id="L89">    builder.setType(dto.getTaskType());</span>
<span class="fc" id="L90">    cache.getUser(dto.getSubmitterUuid()).ifPresent(user -&gt; builder.setSubmitterLogin(user.getLogin()));</span>
<span class="fc" id="L91">    builder.setSubmittedAt(formatDateTime(new Date(dto.getCreatedAt())));</span>
<span class="fc" id="L92">    ofNullable(dto.getStartedAt()).map(DateUtils::formatDateTime).ifPresent(builder::setStartedAt);</span>
<span class="fc" id="L93">    ofNullable(computeExecutionTimeMs(dto)).ifPresent(builder::setExecutionTimeMs);</span>
<span class="fc" id="L94">    setBranchOrPullRequest(builder, dto.getUuid(), cache);</span>
<span class="fc" id="L95">    return builder.build();</span>
  }

  public Ce.Task formatActivity(DbSession dbSession, CeActivityDto dto, @Nullable String scannerContext) {
<span class="fc" id="L99">    return formatActivity(dto, DtoCache.forActivityDtos(dbClient, dbSession, singletonList(dto)), scannerContext);</span>
  }

  public List&lt;Ce.Task&gt; formatActivity(DbSession dbSession, List&lt;CeActivityDto&gt; dtos) {
<span class="fc" id="L103">    DtoCache cache = DtoCache.forActivityDtos(dbClient, dbSession, dtos);</span>
<span class="fc" id="L104">    return dtos.stream()</span>
<span class="fc" id="L105">      .map(input -&gt; formatActivity(input, cache, null))</span>
<span class="fc" id="L106">      .toList();</span>
  }

  private static Ce.Task formatActivity(CeActivityDto activityDto, DtoCache cache, @Nullable String scannerContext) {
<span class="fc" id="L110">    Ce.Task.Builder builder = Ce.Task.newBuilder();</span>
<span class="fc" id="L111">    builder.setId(activityDto.getUuid());</span>
<span class="fc" id="L112">    builder.setStatus(Ce.TaskStatus.valueOf(activityDto.getStatus().name()));</span>
<span class="fc" id="L113">    builder.setType(activityDto.getTaskType());</span>
<span class="fc" id="L114">    ofNullable(activityDto.getNodeName()).ifPresent(builder::setNodeName);</span>
<span class="fc" id="L115">    ofNullable(activityDto.getComponentUuid()).ifPresent(uuid -&gt; setComponent(builder, uuid, cache).setComponentId(uuid));</span>
<span class="fc" id="L116">    String analysisUuid = activityDto.getAnalysisUuid();</span>
<span class="fc" id="L117">    ofNullable(analysisUuid).ifPresent(builder::setAnalysisId);</span>
<span class="fc" id="L118">    setBranchOrPullRequest(builder, activityDto.getUuid(), cache);</span>
<span class="fc" id="L119">    ofNullable(analysisUuid).ifPresent(builder::setAnalysisId);</span>
<span class="fc" id="L120">    cache.getUser(activityDto.getSubmitterUuid()).ifPresent(user -&gt; builder.setSubmitterLogin(user.getLogin()));</span>
<span class="fc" id="L121">    builder.setSubmittedAt(formatDateTime(new Date(activityDto.getSubmittedAt())));</span>
<span class="fc" id="L122">    ofNullable(activityDto.getStartedAt()).map(DateUtils::formatDateTime).ifPresent(builder::setStartedAt);</span>
<span class="fc" id="L123">    ofNullable(activityDto.getExecutedAt()).map(DateUtils::formatDateTime).ifPresent(builder::setExecutedAt);</span>
<span class="fc" id="L124">    ofNullable(activityDto.getExecutionTimeMs()).ifPresent(builder::setExecutionTimeMs);</span>
<span class="fc" id="L125">    ofNullable(activityDto.getErrorMessage()).ifPresent(builder::setErrorMessage);</span>
<span class="fc" id="L126">    ofNullable(activityDto.getErrorStacktrace()).ifPresent(builder::setErrorStacktrace);</span>
<span class="fc" id="L127">    ofNullable(activityDto.getErrorType()).ifPresent(builder::setErrorType);</span>
<span class="fc" id="L128">    ofNullable(scannerContext).ifPresent(builder::setScannerContext);</span>
<span class="fc" id="L129">    builder.setHasScannerContext(activityDto.isHasScannerContext());</span>
<span class="fc" id="L130">    List&lt;String&gt; warnings = extractWarningMessages(activityDto);</span>
<span class="fc" id="L131">    builder.setWarningCount(warnings.size());</span>
<span class="fc" id="L132">    warnings.forEach(builder::addWarnings);</span>

<span class="fc" id="L134">    List&lt;String&gt; infoMessages = extractInfoMessages(activityDto);</span>
<span class="fc" id="L135">    builder.addAllInfoMessages(infoMessages);</span>

<span class="fc" id="L137">    return builder.build();</span>
  }

  private static Ce.Task.Builder setComponent(Ce.Task.Builder builder, @Nullable String componentUuid, DtoCache componentDtoCache) {
<span class="fc" id="L141">    ComponentDto componentDto = componentDtoCache.getComponent(componentUuid);</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">    if (componentDto == null) {</span>
<span class="fc" id="L143">      return builder;</span>
    }
<span class="fc" id="L145">    builder.setComponentKey(componentDto.getKey());</span>
<span class="fc" id="L146">    builder.setComponentName(componentDto.name());</span>
<span class="fc" id="L147">    builder.setComponentQualifier(componentDto.qualifier());</span>
<span class="fc" id="L148">    return builder;</span>
  }

  private static Ce.Task.Builder setBranchOrPullRequest(Ce.Task.Builder builder, String taskUuid, DtoCache componentDtoCache) {
<span class="fc" id="L152">    componentDtoCache.getBranchKey(taskUuid).ifPresent(</span>
      b -&gt; {
<span class="fc" id="L154">        Common.BranchType branchType = componentDtoCache.getBranchType(taskUuid)</span>
<span class="pc" id="L155">          .orElseThrow(() -&gt; new IllegalStateException(format(&quot;Could not find branch type of task '%s'&quot;, taskUuid)));</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        switch (branchType) {</span>
          case BRANCH:
<span class="fc" id="L158">            builder.setBranchType(branchType);</span>
<span class="fc" id="L159">            builder.setBranch(b);</span>
<span class="fc" id="L160">            break;</span>
          default:
<span class="nc" id="L162">            throw new IllegalStateException(String.format(&quot;Unknown branch type '%s'&quot;, branchType));</span>
        }
<span class="fc" id="L164">      });</span>
<span class="fc" id="L165">    componentDtoCache.getPullRequest(taskUuid).ifPresent(builder::setPullRequest);</span>
<span class="fc" id="L166">    return builder;</span>
  }

  private static List&lt;String&gt; extractWarningMessages(CeActivityDto dto) {
<span class="fc" id="L170">    return dto.getCeTaskMessageDtos().stream()</span>
<span class="fc" id="L171">      .filter(ceTaskMessageDto -&gt; ceTaskMessageDto.getType().isWarning())</span>
<span class="fc" id="L172">      .map(CeTaskMessageDto::getMessage)</span>
<span class="fc" id="L173">      .toList();</span>
  }

  private static List&lt;String&gt; extractInfoMessages(CeActivityDto activityDto) {
<span class="fc" id="L177">    return activityDto.getCeTaskMessageDtos().stream()</span>
<span class="fc" id="L178">      .filter(ceTaskMessageDto -&gt; MessageType.INFO.equals(ceTaskMessageDto.getType()))</span>
<span class="fc" id="L179">      .sorted(Comparator.comparing(CeTaskMessageDto::getCreatedAt))</span>
<span class="fc" id="L180">      .map(CeTaskMessageDto::getMessage)</span>
<span class="fc" id="L181">      .toList();</span>
  }

  private static class DtoCache {
    private final Map&lt;String, ComponentDto&gt; componentsByUuid;
    private final Multimap&lt;String, CeTaskCharacteristicDto&gt; characteristicsByTaskUuid;
    private final Map&lt;String, UserDto&gt; usersByUuid;

<span class="fc" id="L189">    private DtoCache(Map&lt;String, ComponentDto&gt; componentsByUuid, Multimap&lt;String, CeTaskCharacteristicDto&gt; characteristicsByTaskUuid, Map&lt;String, UserDto&gt; usersByUuid) {</span>
<span class="fc" id="L190">      this.componentsByUuid = componentsByUuid;</span>
<span class="fc" id="L191">      this.characteristicsByTaskUuid = characteristicsByTaskUuid;</span>
<span class="fc" id="L192">      this.usersByUuid = usersByUuid;</span>
<span class="fc" id="L193">    }</span>

    static DtoCache forQueueDtos(DbClient dbClient, DbSession dbSession, Collection&lt;CeQueueDto&gt; ceQueueDtos) {
<span class="fc" id="L196">      Map&lt;String, ComponentDto&gt; componentsByUuid = dbClient.componentDao().selectByUuids(dbSession, componentUuidsOfCeQueues(ceQueueDtos))</span>
<span class="fc" id="L197">        .stream()</span>
<span class="fc" id="L198">        .collect(Collectors.toMap(ComponentDto::uuid, Function.identity()));</span>
<span class="fc" id="L199">      Multimap&lt;String, CeTaskCharacteristicDto&gt; characteristicsByTaskUuid = dbClient.ceTaskCharacteristicsDao()</span>
<span class="fc" id="L200">        .selectByTaskUuids(dbSession, ceQueueDtos.stream().map(CeQueueDto::getUuid).toList())</span>
<span class="fc" id="L201">        .stream().collect(MoreCollectors.index(CeTaskCharacteristicDto::getTaskUuid));</span>
<span class="fc" id="L202">      Set&lt;String&gt; submitterUuids = ceQueueDtos.stream().map(CeQueueDto::getSubmitterUuid).filter(Objects::nonNull).collect(Collectors.toSet());</span>
<span class="fc" id="L203">      Map&lt;String, UserDto&gt; usersByUuid = dbClient.userDao().selectByUuids(dbSession, submitterUuids).stream().collect(Collectors.toMap(UserDto::getUuid, Function.identity()));</span>
<span class="fc" id="L204">      return new DtoCache(componentsByUuid, characteristicsByTaskUuid, usersByUuid);</span>
    }

    private static Set&lt;String&gt; componentUuidsOfCeQueues(Collection&lt;CeQueueDto&gt; ceQueueDtos) {
<span class="fc" id="L208">      return ceQueueDtos.stream()</span>
<span class="fc" id="L209">        .filter(Objects::nonNull)</span>
<span class="fc" id="L210">        .map(CeQueueDto::getComponentUuid)</span>
<span class="fc" id="L211">        .filter(Objects::nonNull)</span>
<span class="fc" id="L212">        .collect(Collectors.toSet());</span>
    }

    static DtoCache forActivityDtos(DbClient dbClient, DbSession dbSession, Collection&lt;CeActivityDto&gt; ceActivityDtos) {
<span class="fc" id="L216">      Map&lt;String, ComponentDto&gt; componentsByUuid = dbClient.componentDao().selectByUuids(</span>
        dbSession,
<span class="fc" id="L218">        getComponentUuidsOfCeActivities(ceActivityDtos))</span>
<span class="fc" id="L219">        .stream()</span>
<span class="fc" id="L220">        .collect(Collectors.toMap(ComponentDto::uuid, Function.identity()));</span>
<span class="fc" id="L221">      Multimap&lt;String, CeTaskCharacteristicDto&gt; characteristicsByTaskUuid = dbClient.ceTaskCharacteristicsDao()</span>
<span class="fc" id="L222">        .selectByTaskUuids(dbSession, ceActivityDtos.stream().map(CeActivityDto::getUuid).toList())</span>
<span class="fc" id="L223">        .stream().collect(MoreCollectors.index(CeTaskCharacteristicDto::getTaskUuid));</span>
<span class="fc" id="L224">      Set&lt;String&gt; submitterUuids = ceActivityDtos.stream().map(CeActivityDto::getSubmitterUuid).filter(Objects::nonNull).collect(Collectors.toSet());</span>
<span class="fc" id="L225">      Map&lt;String, UserDto&gt; usersByUuid = dbClient.userDao().selectByUuids(dbSession, submitterUuids).stream().collect(Collectors.toMap(UserDto::getUuid, Function.identity()));</span>
<span class="fc" id="L226">      return new DtoCache(componentsByUuid, characteristicsByTaskUuid, usersByUuid);</span>
    }

    private static Set&lt;String&gt; getComponentUuidsOfCeActivities(Collection&lt;CeActivityDto&gt; ceActivityDtos) {
<span class="fc" id="L230">      return ceActivityDtos.stream()</span>
<span class="fc" id="L231">        .filter(Objects::nonNull)</span>
<span class="fc" id="L232">        .map(CeActivityDto::getComponentUuid)</span>
<span class="fc" id="L233">        .filter(Objects::nonNull)</span>
<span class="fc" id="L234">        .collect(Collectors.toSet());</span>
    }

    @CheckForNull
    ComponentDto getComponent(@Nullable String uuid) {
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">      if (uuid == null) {</span>
<span class="nc" id="L240">        return null;</span>
      }
<span class="fc" id="L242">      return componentsByUuid.get(uuid);</span>
    }

    Optional&lt;String&gt; getBranchKey(String taskUuid) {
<span class="fc" id="L246">      return characteristicsByTaskUuid.get(taskUuid).stream()</span>
<span class="fc" id="L247">        .filter(c -&gt; c.getKey().equals(BRANCH))</span>
<span class="fc" id="L248">        .map(CeTaskCharacteristicDto::getValue)</span>
<span class="fc" id="L249">        .findAny();</span>
    }

    Optional&lt;Common.BranchType&gt; getBranchType(String taskUuid) {
<span class="fc" id="L253">      return characteristicsByTaskUuid.get(taskUuid).stream()</span>
<span class="fc" id="L254">        .filter(c -&gt; c.getKey().equals(BRANCH_TYPE))</span>
<span class="fc" id="L255">        .map(c -&gt; Common.BranchType.valueOf(c.getValue()))</span>
<span class="fc" id="L256">        .findAny();</span>
    }

    Optional&lt;String&gt; getPullRequest(String taskUuid) {
<span class="fc" id="L260">      return characteristicsByTaskUuid.get(taskUuid).stream()</span>
<span class="fc" id="L261">        .filter(c -&gt; c.getKey().equals(PULL_REQUEST))</span>
<span class="fc" id="L262">        .map(CeTaskCharacteristicDto::getValue)</span>
<span class="fc" id="L263">        .findAny();</span>
    }

    Optional&lt;UserDto&gt; getUser(@Nullable String userUuid) {
<span class="fc bfc" id="L267" title="All 2 branches covered.">      if (userUuid == null) {</span>
<span class="fc" id="L268">        return Optional.empty();</span>
      }
<span class="fc" id="L270">      return Optional.ofNullable(usersByUuid.get(userUuid));</span>
    }
  }

  /**
   * now - startedAt
   */
  @CheckForNull
  private Long computeExecutionTimeMs(CeQueueDto dto) {
<span class="fc" id="L279">    Long startedAt = dto.getStartedAt();</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">    if (startedAt == null) {</span>
<span class="fc" id="L281">      return null;</span>
    }
<span class="fc" id="L283">    return system2.now() - startedAt;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>