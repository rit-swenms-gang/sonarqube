<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProjectMeasuresIndexerIterator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.db.measure</a> &gt; <span class="el_source">ProjectMeasuresIndexerIterator.java</span></div><h1>ProjectMeasuresIndexerIterator.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.db.measure;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSortedSet;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.measures.CoreMetrics;
import org.sonar.core.metric.SoftwareQualitiesMetrics;
import org.sonar.core.util.CloseableIterator;
import org.sonar.db.DatabaseUtils;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.ComponentQualifiers;

import static org.sonar.api.measures.CoreMetrics.ALERT_STATUS_KEY;
import static org.sonar.api.measures.CoreMetrics.NCLOC_KEY;
import static org.sonar.api.measures.CoreMetrics.NCLOC_LANGUAGE_DISTRIBUTION_KEY;
import static org.sonar.api.utils.KeyValueFormat.parseStringInt;
import static org.sonar.db.component.DbTagsReader.readDbTags;

public class ProjectMeasuresIndexerIterator extends CloseableIterator&lt;ProjectMeasuresIndexerIterator.ProjectMeasures&gt; {

<span class="fc" id="L56">  public static final Set&lt;String&gt; METRIC_KEYS = ImmutableSortedSet.of(</span>
    NCLOC_KEY,
    CoreMetrics.LINES_KEY,
    CoreMetrics.DUPLICATED_LINES_DENSITY_KEY,
    CoreMetrics.COVERAGE_KEY,
    CoreMetrics.SQALE_RATING_KEY,
    CoreMetrics.RELIABILITY_RATING_KEY,
    CoreMetrics.SECURITY_RATING_KEY,
    CoreMetrics.SECURITY_HOTSPOTS_REVIEWED_KEY,
    CoreMetrics.SECURITY_REVIEW_RATING_KEY,
    CoreMetrics.NCLOC_LANGUAGE_DISTRIBUTION_KEY,
    CoreMetrics.ALERT_STATUS_KEY,
    CoreMetrics.NEW_SECURITY_RATING_KEY,
    CoreMetrics.NEW_SECURITY_HOTSPOTS_REVIEWED_KEY,
    CoreMetrics.NEW_SECURITY_REVIEW_RATING_KEY,
    CoreMetrics.NEW_MAINTAINABILITY_RATING_KEY,
    CoreMetrics.NEW_COVERAGE_KEY,
    CoreMetrics.NEW_DUPLICATED_LINES_DENSITY_KEY,
    CoreMetrics.NEW_LINES_KEY,
    CoreMetrics.NEW_RELIABILITY_RATING_KEY,

    //Ratings based on software quality
    SoftwareQualitiesMetrics.SOFTWARE_QUALITY_MAINTAINABILITY_RATING_KEY,
    SoftwareQualitiesMetrics.SOFTWARE_QUALITY_RELIABILITY_RATING_KEY,
    SoftwareQualitiesMetrics.SOFTWARE_QUALITY_SECURITY_RATING_KEY,
    SoftwareQualitiesMetrics.NEW_SOFTWARE_QUALITY_SECURITY_RATING_KEY,
    SoftwareQualitiesMetrics.NEW_SOFTWARE_QUALITY_MAINTAINABILITY_RATING_KEY,
    SoftwareQualitiesMetrics.NEW_SOFTWARE_QUALITY_RELIABILITY_RATING_KEY
  );

<span class="fc" id="L86">  private static final Gson GSON = new Gson();</span>

  private static final String SQL_PROJECTS = &quot;&quot;&quot;
    SELECT p.uuid, p.kee, p.name, p.created_at, s.created_at, p.tags, p.qualifier, p.ncloc
    FROM projects p
    INNER JOIN project_branches pb ON pb.project_uuid = p.uuid AND pb.is_main = ?
    LEFT OUTER JOIN snapshots s ON s.root_component_uuid=pb.uuid AND s.islast=?
    WHERE p.qualifier in (?, ?)&quot;&quot;&quot;;

  private static final String PROJECT_FILTER = &quot; AND pb.project_uuid=?&quot;;

  private static final String SQL_GENERIC_METRICS = &quot;&quot;&quot;
    SELECT m.name
    FROM metrics m
    WHERE m.enabled = ?&quot;&quot;&quot;;

  private static final String SQL_MEASURES = &quot;&quot;&quot;
    SELECT m.json_value
    FROM measures m
    INNER JOIN project_branches pb ON pb.uuid = m.component_uuid
    WHERE pb.project_uuid = ?
    AND pb.is_main = ?&quot;&quot;&quot;;

  private static final boolean ENABLED = true;

  private final DbSession dbSession;
  private final DbClient dbClient;
  private final PreparedStatement measuresStatement;
  private final Iterator&lt;Project&gt; projects;
  private final List&lt;String&gt; metrics;

  private ProjectMeasuresIndexerIterator(DbSession dbSession, DbClient dbClient, PreparedStatement measuresStatement,
<span class="fc" id="L118">    List&lt;Project&gt; projects, List&lt;String&gt; metrics) {</span>
<span class="fc" id="L119">    this.dbSession = dbSession;</span>
<span class="fc" id="L120">    this.dbClient = dbClient;</span>
<span class="fc" id="L121">    this.measuresStatement = measuresStatement;</span>
<span class="fc" id="L122">    this.projects = projects.iterator();</span>
<span class="fc" id="L123">    this.metrics = metrics;</span>
<span class="fc" id="L124">  }</span>

  public static ProjectMeasuresIndexerIterator create(DbSession session, DbClient dbClient, @Nullable String projectUuid) {
<span class="fc" id="L127">    List&lt;Project&gt; projects = selectProjects(session, projectUuid);</span>
<span class="fc" id="L128">    PreparedStatement measuresStatement = createMeasuresStatement(session);</span>
<span class="fc" id="L129">    return new ProjectMeasuresIndexerIterator(session, dbClient, measuresStatement, projects, selectMetrics(session));</span>
  }

  private static List&lt;String&gt; selectMetrics(DbSession session) {
<span class="fc" id="L133">    List&lt;String&gt; metrics = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L134">    try (PreparedStatement stmt = createMetricsStatement(session);</span>
<span class="fc" id="L135">         ResultSet rs = stmt.executeQuery()) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L137">        String key = rs.getString(1);</span>
<span class="fc" id="L138">        metrics.add(key);</span>
<span class="fc" id="L139">      }</span>
<span class="fc" id="L140">      return metrics;</span>
<span class="nc" id="L141">    } catch (SQLException e) {</span>
<span class="nc" id="L142">      throw new IllegalStateException(&quot;Fail to execute request to select all metrics&quot;, e);</span>
    }
  }

  private static PreparedStatement createMetricsStatement(DbSession session) {
    try {
<span class="fc" id="L148">      PreparedStatement stmt = session.getConnection().prepareStatement(SQL_GENERIC_METRICS);</span>
<span class="fc" id="L149">      stmt.setBoolean(1, ENABLED);</span>
<span class="fc" id="L150">      return stmt;</span>
<span class="nc" id="L151">    } catch (SQLException e) {</span>
<span class="nc" id="L152">      throw new IllegalStateException(&quot;Fail to prepare SQL request to select all metrics&quot;, e);</span>
    }
  }

  private static List&lt;Project&gt; selectProjects(DbSession session, @Nullable String projectUuid) {
<span class="fc" id="L157">    List&lt;Project&gt; projects = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L158">    try (PreparedStatement stmt = createProjectsStatement(session, projectUuid);</span>
<span class="fc" id="L159">         ResultSet rs = stmt.executeQuery()) {</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L161">        String uuid = rs.getString(1);</span>
<span class="fc" id="L162">        String key = rs.getString(2);</span>
<span class="fc" id="L163">        String name = rs.getString(3);</span>
<span class="fc" id="L164">        Long creationDate = rs.getLong(4);</span>
<span class="fc" id="L165">        Long analysisDate = DatabaseUtils.getLong(rs, 5);</span>
<span class="fc" id="L166">        List&lt;String&gt; tags = readDbTags(DatabaseUtils.getString(rs, 6));</span>
<span class="fc" id="L167">        String qualifier = rs.getString(7);</span>
<span class="fc" id="L168">        Long ncloc = DatabaseUtils.getLong(rs, 8);</span>
<span class="fc" id="L169">        Project project = new Project.Builder()</span>
<span class="fc" id="L170">          .setUuid(uuid)</span>
<span class="fc" id="L171">          .setKey(key)</span>
<span class="fc" id="L172">          .setName(name)</span>
<span class="fc" id="L173">          .setQualifier(qualifier)</span>
<span class="fc" id="L174">          .setTags(tags)</span>
<span class="fc" id="L175">          .setCreationDate(creationDate)</span>
<span class="fc" id="L176">          .setAnalysisDate(analysisDate)</span>
<span class="fc" id="L177">          .setNcloc(ncloc)</span>
<span class="fc" id="L178">          .build();</span>
<span class="fc" id="L179">        projects.add(project);</span>
<span class="fc" id="L180">      }</span>
<span class="fc" id="L181">      return projects;</span>
<span class="nc" id="L182">    } catch (SQLException e) {</span>
<span class="nc" id="L183">      throw new IllegalStateException(&quot;Fail to execute request to select all projects&quot;, e);</span>
    }
  }

  private static PreparedStatement createProjectsStatement(DbSession session, @Nullable String projectUuid) {
    try {
<span class="fc" id="L189">      StringBuilder sql = new StringBuilder(SQL_PROJECTS);</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">      if (projectUuid != null) {</span>
<span class="fc" id="L191">        sql.append(PROJECT_FILTER);</span>
      }
<span class="fc" id="L193">      PreparedStatement stmt = session.getConnection().prepareStatement(sql.toString());</span>
<span class="fc" id="L194">      stmt.setBoolean(1, true);</span>
<span class="fc" id="L195">      stmt.setBoolean(2, true);</span>
<span class="fc" id="L196">      stmt.setString(3, ComponentQualifiers.PROJECT);</span>
<span class="fc" id="L197">      stmt.setString(4, ComponentQualifiers.APP);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">      if (projectUuid != null) {</span>
<span class="fc" id="L199">        stmt.setString(5, projectUuid);</span>
      }
<span class="fc" id="L201">      return stmt;</span>
<span class="nc" id="L202">    } catch (SQLException e) {</span>
<span class="nc" id="L203">      throw new IllegalStateException(&quot;Fail to prepare SQL request to select all project measures&quot;, e);</span>
    }
  }

  private static PreparedStatement createMeasuresStatement(DbSession session) {
    try {
<span class="fc" id="L209">      return session.getConnection().prepareStatement(SQL_MEASURES);</span>
<span class="nc" id="L210">    } catch (SQLException e) {</span>
<span class="nc" id="L211">      throw new IllegalStateException(&quot;Fail to prepare SQL request to select measures&quot;, e);</span>
    }
  }

  @Override
  @CheckForNull
  protected ProjectMeasures doNext() {
<span class="fc bfc" id="L218" title="All 2 branches covered.">    if (!projects.hasNext()) {</span>
<span class="fc" id="L219">      return null;</span>
    }
<span class="fc" id="L221">    Project project = projects.next();</span>
<span class="fc" id="L222">    Measures measures = selectMeasures(project);</span>
<span class="fc" id="L223">    return new ProjectMeasures(project, measures);</span>
  }

  private Measures selectMeasures(Project project) {
<span class="fc" id="L227">    String projectUuid = project.getUuid();</span>
    try {
<span class="fc" id="L229">      Measures measures = getMeasures(projectUuid);</span>
<span class="fc" id="L230">      project.getNcloc().ifPresent(ncloc -&gt; readNclocDistributionFromBiggestBranch(projectUuid, ncloc, measures));</span>
<span class="fc" id="L231">      return measures;</span>
<span class="nc" id="L232">    } catch (Exception e) {</span>
<span class="nc" id="L233">      throw new IllegalStateException(String.format(&quot;Fail to execute request to select measures of project %s&quot;, projectUuid), e);</span>
    }
  }

  private Measures getMeasures(String projectUuid) throws SQLException {
<span class="fc" id="L238">    Measures measures = new Measures();</span>
<span class="fc" id="L239">    measuresStatement.setString(1, projectUuid);</span>
<span class="fc" id="L240">    measuresStatement.setBoolean(2, true);</span>

<span class="fc" id="L242">    try (ResultSet rs = measuresStatement.executeQuery()) {</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L244">        readMeasureLine(rs, measures);</span>
      }
    }
<span class="fc" id="L247">    return measures;</span>
  }

  private void readMeasureLine(ResultSet rs, Measures measures) throws SQLException {
<span class="fc" id="L251">    String jsonValue = rs.getString(1);</span>
<span class="fc" id="L252">    Map&lt;String, Object&gt; metricValues = GSON.fromJson(jsonValue, new TypeToken&lt;Map&lt;String, Object&gt;&gt;() {</span>
<span class="fc" id="L253">    }.getType());</span>

<span class="fc" id="L255">    metricValues.forEach((metricKey, value) -&gt; readMeasure(measures, metricKey, value));</span>
<span class="fc" id="L256">  }</span>

  private void readMeasure(Measures measures, String metricKey, Object value) {
<span class="pc bpc" id="L259" title="1 of 4 branches missed.">    if (METRIC_KEYS.contains(metricKey) &amp;&amp; metrics.contains(metricKey)) {</span>
<span class="pc bpc" id="L260" title="1 of 4 branches missed.">      if (ALERT_STATUS_KEY.equals(metricKey) &amp;&amp; value instanceof String qualityGate) {</span>
<span class="fc" id="L261">        measures.setQualityGateStatus(qualityGate);</span>
<span class="fc" id="L262">        return;</span>
      }
<span class="pc bpc" id="L264" title="1 of 4 branches missed.">      if (NCLOC_LANGUAGE_DISTRIBUTION_KEY.equals(metricKey) &amp;&amp; value instanceof String distribution) {</span>
<span class="fc" id="L265">        measures.setNclocByLanguages(distribution);</span>
<span class="fc" id="L266">        return;</span>
      }
<span class="fc bfc" id="L268" title="All 2 branches covered.">      if (value instanceof Double doubleValue) {</span>
<span class="fc" id="L269">        measures.addNumericMeasure(metricKey, doubleValue);</span>
      }
    }
<span class="fc" id="L272">  }</span>

  private void readNclocDistributionFromBiggestBranch(String projectUuid, long ncloc, Measures measures) {
<span class="fc" id="L275">    List&lt;String&gt; branchUuids = dbClient.branchDao().selectByProjectUuid(dbSession, projectUuid).stream().map(BranchDto::getUuid).toList();</span>
<span class="fc" id="L276">    List&lt;MeasureDto&gt; measureDtos = dbClient.measureDao().selectByComponentUuidsAndMetricKeys(dbSession, branchUuids,</span>
<span class="fc" id="L277">      List.of(NCLOC_KEY, NCLOC_LANGUAGE_DISTRIBUTION_KEY));</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">    for (MeasureDto measureDto : measureDtos) {</span>
<span class="fc" id="L279">      Long branchNcloc = measureDto.getLong(NCLOC_KEY);</span>
<span class="pc bpc" id="L280" title="2 of 4 branches missed.">      if (branchNcloc != null &amp;&amp; branchNcloc == ncloc) {</span>
<span class="fc" id="L281">        String nclocLanguageDistribution = measureDto.getString(NCLOC_LANGUAGE_DISTRIBUTION_KEY);</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (nclocLanguageDistribution != null) {</span>
<span class="fc" id="L283">          measures.setNclocByLanguages(nclocLanguageDistribution);</span>
        }
        break;
      }
<span class="nc" id="L287">    }</span>
<span class="fc" id="L288">  }</span>

  @Override
  protected void doClose() throws Exception {
<span class="fc" id="L292">    measuresStatement.close();</span>
<span class="fc" id="L293">  }</span>

  public static class Project {
    private final String uuid;
    private final String key;
    private final String name;
    private final String qualifier;
    private final Long creationDate;
    private final Long analysisDate;
    private final List&lt;String&gt; tags;
    private final Long ncloc;

<span class="fc" id="L305">    private Project(Builder builder) {</span>
<span class="fc" id="L306">      this.uuid = builder.uuid;</span>
<span class="fc" id="L307">      this.key = builder.key;</span>
<span class="fc" id="L308">      this.name = builder.name;</span>
<span class="fc" id="L309">      this.qualifier = builder.qualifier;</span>
<span class="fc" id="L310">      this.tags = builder.tags;</span>
<span class="fc" id="L311">      this.analysisDate = builder.analysisDate;</span>
<span class="fc" id="L312">      this.creationDate = builder.creationDate;</span>
<span class="fc" id="L313">      this.ncloc = builder.ncloc;</span>
<span class="fc" id="L314">    }</span>

    public String getUuid() {
<span class="fc" id="L317">      return uuid;</span>
    }

    public String getKey() {
<span class="fc" id="L321">      return key;</span>
    }

    public String getName() {
<span class="fc" id="L325">      return name;</span>
    }

    public String getQualifier() {
<span class="fc" id="L329">      return qualifier;</span>
    }

    public List&lt;String&gt; getTags() {
<span class="fc" id="L333">      return tags;</span>
    }

    @CheckForNull
    public Long getAnalysisDate() {
<span class="fc" id="L338">      return analysisDate;</span>
    }

    public Long getCreationDate() {
<span class="fc" id="L342">      return creationDate;</span>
    }

    public Optional&lt;Long&gt; getNcloc() {
<span class="fc" id="L346">      return Optional.ofNullable(ncloc);</span>
    }

    private static class Builder {
      private String uuid;
      private String key;
      private String name;
      private String qualifier;
      private Long creationDate;
      private Long analysisDate;
      private List&lt;String&gt; tags;
      private Long ncloc;

      public Builder setUuid(String uuid) {
<span class="fc" id="L360">        this.uuid = uuid;</span>
<span class="fc" id="L361">        return this;</span>
      }

      public Builder setKey(String key) {
<span class="fc" id="L365">        this.key = key;</span>
<span class="fc" id="L366">        return this;</span>
      }

      public Builder setName(String name) {
<span class="fc" id="L370">        this.name = name;</span>
<span class="fc" id="L371">        return this;</span>
      }

      public Builder setQualifier(String qualifier) {
<span class="fc" id="L375">        this.qualifier = qualifier;</span>
<span class="fc" id="L376">        return this;</span>
      }

      public Builder setCreationDate(Long creationDate) {
<span class="fc" id="L380">        this.creationDate = creationDate;</span>
<span class="fc" id="L381">        return this;</span>
      }

      public Builder setAnalysisDate(@Nullable Long analysisDate) {
<span class="fc" id="L385">        this.analysisDate = analysisDate;</span>
<span class="fc" id="L386">        return this;</span>
      }

      public Builder setTags(List&lt;String&gt; tags) {
<span class="fc" id="L390">        this.tags = tags;</span>
<span class="fc" id="L391">        return this;</span>
      }

      public Builder setNcloc(@Nullable Long ncloc) {
<span class="fc" id="L395">        this.ncloc = ncloc;</span>
<span class="fc" id="L396">        return this;</span>
      }

      public Project build() {
<span class="fc" id="L400">        return new Project(this);</span>
      }
    }
  }

<span class="fc" id="L405">  public static class Measures {</span>
<span class="fc" id="L406">    private final Map&lt;String, Double&gt; numericMeasures = new HashMap&lt;&gt;();</span>
    private String qualityGateStatus;
<span class="fc" id="L408">    private Map&lt;String, Integer&gt; nclocByLanguages = new LinkedHashMap&lt;&gt;();</span>

    Measures addNumericMeasure(String metricKey, double value) {
<span class="fc" id="L411">      numericMeasures.put(metricKey, value);</span>
<span class="fc" id="L412">      return this;</span>
    }

    public Map&lt;String, Double&gt; getNumericMeasures() {
<span class="fc" id="L416">      return numericMeasures;</span>
    }

    Measures setQualityGateStatus(@Nullable String qualityGateStatus) {
<span class="fc" id="L420">      this.qualityGateStatus = qualityGateStatus;</span>
<span class="fc" id="L421">      return this;</span>
    }

    @CheckForNull
    public String getQualityGateStatus() {
<span class="fc" id="L426">      return qualityGateStatus;</span>
    }

    Measures setNclocByLanguages(String nclocByLangues) {
<span class="fc" id="L430">      this.nclocByLanguages = ImmutableMap.copyOf(parseStringInt(nclocByLangues));</span>
<span class="fc" id="L431">      return this;</span>
    }

    public Map&lt;String, Integer&gt; getNclocByLanguages() {
<span class="fc" id="L435">      return nclocByLanguages;</span>
    }
  }

  public static class ProjectMeasures {
    private final Project project;
    private final Measures measures;

<span class="fc" id="L443">    public ProjectMeasures(Project project, Measures measures) {</span>
<span class="fc" id="L444">      this.project = project;</span>
<span class="fc" id="L445">      this.measures = measures;</span>
<span class="fc" id="L446">    }</span>

    public Project getProject() {
<span class="fc" id="L449">      return project;</span>
    }

    public Measures getMeasures() {
<span class="fc" id="L453">      return measures;</span>
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>