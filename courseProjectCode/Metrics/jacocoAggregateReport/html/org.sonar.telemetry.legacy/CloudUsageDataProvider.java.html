<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CloudUsageDataProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.telemetry.legacy</a> &gt; <span class="el_source">CloudUsageDataProvider.java</span></div><h1>CloudUsageDataProvider.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.telemetry.legacy;

import com.google.common.annotations.VisibleForTesting;
import com.google.gson.Gson;
import java.io.FileInputStream;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.security.GeneralSecurityException;
import java.security.KeyStore;
import java.security.SecureRandom;
import java.security.cert.Certificate;
import java.security.cert.CertificateFactory;
import java.util.Collection;
import java.util.Scanner;
import java.util.function.Supplier;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import jakarta.inject.Inject;
import javax.net.ssl.SSLContext;
import javax.net.ssl.TrustManager;
import javax.net.ssl.TrustManagerFactory;
import javax.net.ssl.X509TrustManager;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;
import okhttp3.ResponseBody;
import okhttp3.internal.tls.OkHostnameVerifier;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.api.server.ServerSide;
import org.sonar.api.utils.System2;
import org.sonar.server.platform.ContainerSupport;
import org.sonar.server.util.Paths2;

import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.Objects.requireNonNull;

@ServerSide
public class CloudUsageDataProvider {

<span class="fc" id="L62">  private static final Logger LOG = LoggerFactory.getLogger(CloudUsageDataProvider.class);</span>

  private static final String SERVICEACCOUNT_CA_PATH = &quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;;
  static final String KUBERNETES_SERVICE_HOST = &quot;KUBERNETES_SERVICE_HOST&quot;;
  static final String KUBERNETES_SERVICE_PORT = &quot;KUBERNETES_SERVICE_PORT&quot;;
  static final String SONAR_HELM_CHART_VERSION = &quot;SONAR_HELM_CHART_VERSION&quot;;
  static final String DOCKER_RUNNING = &quot;DOCKER_RUNNING&quot;;
<span class="fc" id="L69">  private static final String[] KUBERNETES_PROVIDER_COMMAND = {&quot;bash&quot;, &quot;-c&quot;, &quot;uname -r&quot;};</span>
  private static final int KUBERNETES_PROVIDER_MAX_SIZE = 100;
  private final ContainerSupport containerSupport;
  private final System2 system2;
  private final Paths2 paths2;
  private final Supplier&lt;ProcessBuilder&gt; processBuilderSupplier;
  private OkHttpClient httpClient;
  private TelemetryData.CloudUsage cloudUsageData;

  @Inject
  public CloudUsageDataProvider(ContainerSupport containerSupport, System2 system2, Paths2 paths2) {
<span class="pc" id="L80">    this(containerSupport, system2, paths2, ProcessBuilder::new, null);</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">    if (isOnKubernetes()) {</span>
<span class="fc" id="L82">      initHttpClient();</span>
    }
<span class="fc" id="L84">  }</span>

  @VisibleForTesting
  CloudUsageDataProvider(ContainerSupport containerSupport, System2 system2, Paths2 paths2, Supplier&lt;ProcessBuilder&gt; processBuilderSupplier,
<span class="fc" id="L88">                         @Nullable OkHttpClient httpClient) {</span>
<span class="fc" id="L89">    this.containerSupport = containerSupport;</span>
<span class="fc" id="L90">    this.system2 = system2;</span>
<span class="fc" id="L91">    this.paths2 = paths2;</span>
<span class="fc" id="L92">    this.processBuilderSupplier = processBuilderSupplier;</span>
<span class="fc" id="L93">    this.httpClient = httpClient;</span>
<span class="fc" id="L94">  }</span>

  public TelemetryData.CloudUsage getCloudUsage() {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">    if (cloudUsageData != null) {</span>
<span class="nc" id="L98">      return cloudUsageData;</span>
    }

<span class="fc" id="L101">    String kubernetesVersion = null;</span>
<span class="fc" id="L102">    String kubernetesPlatform = null;</span>

<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (isOnKubernetes()) {</span>
<span class="fc" id="L105">      VersionInfo versionInfo = getVersionInfo();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">      if (versionInfo != null) {</span>
<span class="fc" id="L107">        kubernetesVersion = versionInfo.major() + &quot;.&quot; + versionInfo.minor();</span>
<span class="fc" id="L108">        kubernetesPlatform = versionInfo.platform();</span>
      }
    }

<span class="fc" id="L112">    cloudUsageData = new TelemetryData.CloudUsage(</span>
<span class="fc" id="L113">      isOnKubernetes(),</span>
      kubernetesVersion,
      kubernetesPlatform,
<span class="fc" id="L116">      getKubernetesProvider(),</span>
<span class="fc" id="L117">      getOfficialHelmChartVersion(),</span>
<span class="fc" id="L118">      containerSupport.isRunningOnHelmOpenshift(),</span>
<span class="fc" id="L119">      containerSupport.isHelmAutoscalingEnabled(),</span>
<span class="fc" id="L120">      containerSupport.getContainerContext(),</span>
<span class="fc" id="L121">      isOfficialImageUsed());</span>

<span class="fc" id="L123">    return cloudUsageData;</span>
  }

  private boolean isOnKubernetes() {
<span class="fc" id="L127">    return StringUtils.isNotBlank(system2.envVariable(KUBERNETES_SERVICE_HOST));</span>
  }

  @CheckForNull
  private String getOfficialHelmChartVersion() {
<span class="fc" id="L132">    return system2.envVariable(SONAR_HELM_CHART_VERSION);</span>
  }

  private boolean isOfficialImageUsed() {
<span class="fc" id="L136">    return Boolean.parseBoolean(system2.envVariable(DOCKER_RUNNING));</span>
  }

  /**
   * Create an http client to call the Kubernetes API.
   * This is based on the client creation in the official Kubernetes Java client.
   */
  private void initHttpClient() {
    try {
<span class="fc" id="L145">      TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</span>
<span class="fc" id="L146">      trustManagerFactory.init(getKeyStore());</span>
<span class="fc" id="L147">      TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();</span>

<span class="fc" id="L149">      SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);</span>
<span class="fc" id="L150">      sslContext.init(null, trustManagers, new SecureRandom());</span>

<span class="fc" id="L152">      httpClient = new OkHttpClient.Builder()</span>
<span class="fc" id="L153">        .sslSocketFactory(sslContext.getSocketFactory(), (X509TrustManager) trustManagers[0])</span>
<span class="fc" id="L154">        .hostnameVerifier(OkHostnameVerifier.INSTANCE)</span>
<span class="fc" id="L155">        .build();</span>
<span class="fc" id="L156">    } catch (Exception e) {</span>
<span class="fc" id="L157">      LOG.debug(&quot;Failed to create http client for Kubernetes API&quot;, e);</span>
<span class="fc" id="L158">    }</span>
<span class="fc" id="L159">  }</span>

  private KeyStore getKeyStore() throws GeneralSecurityException, IOException {
<span class="fc" id="L162">    KeyStore caKeyStore = newEmptyKeyStore();</span>

<span class="fc" id="L164">    try (FileInputStream fis = new FileInputStream(paths2.get(SERVICEACCOUNT_CA_PATH).toFile())) {</span>
<span class="fc" id="L165">      CertificateFactory certificateFactory = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="fc" id="L166">      Collection&lt;? extends Certificate&gt; certificates = certificateFactory.generateCertificates(fis);</span>

<span class="fc" id="L168">      int index = 0;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">      for (Certificate certificate : certificates) {</span>
<span class="fc" id="L170">        String certificateAlias = &quot;ca&quot; + index;</span>
<span class="fc" id="L171">        caKeyStore.setCertificateEntry(certificateAlias, certificate);</span>
<span class="fc" id="L172">        index++;</span>
<span class="fc" id="L173">      }</span>
    }

<span class="fc" id="L176">    return caKeyStore;</span>
  }

  private static KeyStore newEmptyKeyStore() throws GeneralSecurityException, IOException {
<span class="fc" id="L180">    KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span>
<span class="fc" id="L181">    keyStore.load(null, null);</span>
<span class="fc" id="L182">    return keyStore;</span>
  }

<span class="fc" id="L185">  record VersionInfo(String major, String minor, String platform) {</span>
  }

  private VersionInfo getVersionInfo() {
    try {
<span class="fc" id="L190">      Request request = buildRequest();</span>
<span class="fc" id="L191">      try (Response response = httpClient.newCall(request).execute()) {</span>
<span class="fc" id="L192">        ResponseBody responseBody = requireNonNull(response.body(), &quot;Response body is null&quot;);</span>
<span class="fc" id="L193">        return new Gson().fromJson(responseBody.string(), VersionInfo.class);</span>
      }
<span class="fc" id="L195">    } catch (Exception e) {</span>
<span class="fc" id="L196">      LOG.debug(&quot;Failed to get Kubernetes version info&quot;, e);</span>
<span class="fc" id="L197">      return null;</span>
    }
  }

  private Request buildRequest() throws URISyntaxException {
<span class="fc" id="L202">    String host = system2.envVariable(KUBERNETES_SERVICE_HOST);</span>
<span class="fc" id="L203">    String port = system2.envVariable(KUBERNETES_SERVICE_PORT);</span>
<span class="pc bpc" id="L204" title="2 of 4 branches missed.">    if (host == null || port == null) {</span>
<span class="nc" id="L205">      throw new IllegalStateException(&quot;Kubernetes environment variables are not set&quot;);</span>
    }

<span class="fc" id="L208">    URI uri = new URI(&quot;https&quot;, null, host, Integer.parseInt(port), &quot;/version&quot;, null, null);</span>

<span class="fc" id="L210">    return new Request.Builder()</span>
<span class="fc" id="L211">      .get()</span>
<span class="fc" id="L212">      .url(uri.toString())</span>
<span class="fc" id="L213">      .build();</span>
  }

  @CheckForNull
  private String getKubernetesProvider() {
    try {
<span class="fc" id="L219">      Process process = processBuilderSupplier.get().command(KUBERNETES_PROVIDER_COMMAND).start();</span>
<span class="fc" id="L220">      try (Scanner scanner = new Scanner(process.getInputStream(), UTF_8)) {</span>
<span class="fc" id="L221">        scanner.useDelimiter(&quot;\n&quot;);</span>
        // Null characters can be present in the output on Windows
<span class="fc" id="L223">        String output = scanner.next().replace(&quot;\u0000&quot;, &quot;&quot;);</span>
<span class="fc" id="L224">        return StringUtils.abbreviate(output, KUBERNETES_PROVIDER_MAX_SIZE);</span>
      } finally {
<span class="fc" id="L226">        process.destroy();</span>
      }
<span class="fc" id="L228">    } catch (Exception e) {</span>
<span class="fc" id="L229">      LOG.debug(&quot;Failed to get Kubernetes provider&quot;, e);</span>
<span class="fc" id="L230">      return null;</span>
    }
  }

  @VisibleForTesting
  OkHttpClient getHttpClient() {
<span class="fc" id="L236">    return httpClient;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>