<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionTemplateDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.db.permission.template</a> &gt; <span class="el_source">PermissionTemplateDao.java</span></div><h1>PermissionTemplateDao.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.db.permission.template;

import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.apache.ibatis.session.ResultHandler;
import org.sonar.api.utils.System2;
import org.sonar.core.util.UuidFactory;
import org.sonar.db.Dao;
import org.sonar.db.DbSession;
import org.sonar.db.Pagination;
import org.sonar.db.audit.AuditPersister;
import org.sonar.db.audit.model.PermissionTemplateNewValue;
import org.sonar.db.permission.CountPerEntityPermission;
import org.sonar.db.permission.PermissionQuery;
import org.sonar.db.permission.ProjectPermission;

import static java.lang.String.format;
import static org.sonar.api.security.DefaultGroups.ANYONE;
import static org.sonar.db.DatabaseUtils.executeLargeInputs;
import static org.sonar.db.DatabaseUtils.executeLargeInputsWithoutOutput;

public class PermissionTemplateDao implements Dao {

  private static final String ANYONE_GROUP_PARAMETER = &quot;anyoneGroup&quot;;

  private final System2 system;
  private final UuidFactory uuidFactory;
  private final AuditPersister auditPersister;

<span class="fc" id="L55">  public PermissionTemplateDao(UuidFactory uuidFactory, System2 system, AuditPersister auditPersister) {</span>
<span class="fc" id="L56">    this.uuidFactory = uuidFactory;</span>
<span class="fc" id="L57">    this.system = system;</span>
<span class="fc" id="L58">    this.auditPersister = auditPersister;</span>
<span class="fc" id="L59">  }</span>

  /**
   * @return a paginated list of user logins.
   */
  public List&lt;String&gt; selectUserLoginsByQueryAndTemplate(DbSession session, PermissionQuery query, String templateUuid) {
<span class="fc" id="L65">    return mapper(session).selectUserLoginsByQueryAndTemplate(query, templateUuid, Pagination.forPage(query.getPageIndex()).andSize(query.getPageSize()));</span>
  }

  public int countUserLoginsByQueryAndTemplate(DbSession session, PermissionQuery query, String templateUuid) {
<span class="fc" id="L69">    return mapper(session).countUserLoginsByQueryAndTemplate(query, templateUuid);</span>
  }

  public List&lt;PermissionTemplateUserDto&gt; selectUserPermissionsByTemplateIdAndUserLogins(DbSession dbSession, String templateUuid, List&lt;String&gt; logins) {
<span class="fc" id="L73">    return executeLargeInputs(logins, l -&gt; mapper(dbSession).selectUserPermissionsByTemplateUuidAndUserLogins(templateUuid, l));</span>
  }

  public List&lt;PermissionTemplateUserDto&gt; selectUserPermissionsByTemplateId(DbSession dbSession, String templateUuid) {
<span class="fc" id="L77">    return mapper(dbSession).selectUserPermissionsByTemplateUuidAndUserLogins(templateUuid, Collections.emptyList());</span>
  }

  public List&lt;String&gt; selectGroupNamesByQueryAndTemplate(DbSession session, PermissionQuery query, String templateUuid) {
<span class="fc" id="L81">    return mapper(session).selectGroupNamesByQueryAndTemplate(templateUuid, query, Pagination.forPage(query.getPageIndex()).andSize(query.getPageSize()));</span>
  }

  public int countGroupNamesByQueryAndTemplate(DbSession session, PermissionQuery query, String templateUuid) {
<span class="fc" id="L85">    return mapper(session).countGroupNamesByQueryAndTemplate(query, templateUuid);</span>
  }

  public List&lt;PermissionTemplateGroupDto&gt; selectGroupPermissionsByTemplateIdAndGroupNames(DbSession dbSession, String templateUuid, List&lt;String&gt; groups) {
<span class="fc" id="L89">    return executeLargeInputs(groups, g -&gt; mapper(dbSession).selectGroupPermissionsByTemplateUuidAndGroupNames(templateUuid, g));</span>
  }

  public List&lt;PermissionTemplateGroupDto&gt; selectGroupPermissionsByTemplateUuid(DbSession dbSession, String templateUuid) {
<span class="fc" id="L93">    return mapper(dbSession).selectGroupPermissionsByTemplateUuidAndGroupNames(templateUuid, Collections.emptyList());</span>
  }

  /**
   * @return {@code true} if template contains groups that are granted with {@code permission}, else {@code false}
   */
  public boolean hasGroupsWithPermission(DbSession dbSession, String templateUuid, String permission, @Nullable String groupUuid) {
<span class="fc bfc" id="L100" title="All 2 branches covered.">    return mapper(dbSession).countGroupsWithPermission(templateUuid, permission, groupUuid) &gt; 0;</span>
  }

  @CheckForNull
  public PermissionTemplateDto selectByUuid(DbSession session, String templateUuid) {
<span class="fc" id="L105">    return mapper(session).selectByUuid(templateUuid);</span>
  }

  public List&lt;PermissionTemplateDto&gt; selectAll(DbSession session, @Nullable String nameMatch) {
<span class="fc bfc" id="L109" title="All 2 branches covered.">    String upperCaseNameLikeSql = nameMatch != null ? toUppercaseSqlQuery(nameMatch) : null;</span>
<span class="fc" id="L110">    return mapper(session).selectAll(upperCaseNameLikeSql);</span>
  }

  private static String toUppercaseSqlQuery(String nameMatch) {
<span class="fc" id="L114">    String wildcard = &quot;%&quot;;</span>
<span class="fc" id="L115">    return format(&quot;%s%s%s&quot;, wildcard, nameMatch.toUpperCase(Locale.ENGLISH), wildcard);</span>
  }

  public PermissionTemplateDto insert(DbSession session, PermissionTemplateDto dto) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">    if (dto.getUuid() == null) {</span>
<span class="nc" id="L120">      dto.setUuid(uuidFactory.create());</span>
    }
<span class="fc" id="L122">    mapper(session).insert(dto);</span>
<span class="fc" id="L123">    auditPersister.addPermissionTemplate(session, new PermissionTemplateNewValue(dto.getUuid(), dto.getName()));</span>

<span class="fc" id="L125">    return dto;</span>
  }

  /**
   * Each row returns a #{@link CountPerEntityPermission}
   */
  public void usersCountByTemplateUuidAndPermission(DbSession dbSession, List&lt;String&gt; templateUuids, ResultHandler&lt;CountByTemplateAndPermissionDto&gt; resultHandler) {
<span class="fc" id="L132">    Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;(1);</span>

<span class="fc" id="L134">    executeLargeInputsWithoutOutput(</span>
      templateUuids,
      partitionedTemplateUuids -&gt; {
<span class="fc" id="L137">        parameters.put(&quot;templateUuids&quot;, partitionedTemplateUuids);</span>
<span class="fc" id="L138">        mapper(dbSession).usersCountByTemplateUuidAndPermission(parameters, resultHandler);</span>
<span class="fc" id="L139">      });</span>
<span class="fc" id="L140">  }</span>

  /**
   * Each row returns a #{@link CountPerEntityPermission}
   */
  public void groupsCountByTemplateUuidAndPermission(DbSession dbSession, List&lt;String&gt; templateUuids, ResultHandler&lt;CountByTemplateAndPermissionDto&gt; resultHandler) {
<span class="fc" id="L146">    Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;(2);</span>
<span class="fc" id="L147">    parameters.put(ANYONE_GROUP_PARAMETER, ANYONE);</span>

<span class="fc" id="L149">    executeLargeInputsWithoutOutput(</span>
      templateUuids,
      partitionedTemplateUuids -&gt; {
<span class="fc" id="L152">        parameters.put(&quot;templateUuids&quot;, partitionedTemplateUuids);</span>
<span class="fc" id="L153">        mapper(dbSession).groupsCountByTemplateUuidAndPermission(parameters, resultHandler);</span>
<span class="fc" id="L154">      });</span>
<span class="fc" id="L155">  }</span>

  public List&lt;PermissionTemplateGroupDto&gt; selectAllGroupPermissionTemplatesByGroupUuid(DbSession dbSession, String groupUuid) {
<span class="fc" id="L158">    return mapper(dbSession).selectAllGroupPermissionTemplatesByGroupUuid(groupUuid);</span>
  }

  public void deleteByUuid(DbSession session, String templateUuid, String templateName) {
<span class="fc" id="L162">    PermissionTemplateMapper mapper = mapper(session);</span>
<span class="fc" id="L163">    mapper.deleteUserPermissionsByTemplateUuid(templateUuid);</span>
<span class="fc" id="L164">    mapper.deleteGroupPermissionsByTemplateUuid(templateUuid);</span>
<span class="fc" id="L165">    session.getMapper(PermissionTemplateCharacteristicMapper.class).deleteByTemplateUuid(templateUuid);</span>
<span class="fc" id="L166">    int deletedRows = mapper.deleteByUuid(templateUuid);</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">    if (deletedRows &gt; 0) {</span>
<span class="fc" id="L169">      auditPersister.deletePermissionTemplate(session, new PermissionTemplateNewValue(templateUuid, templateName));</span>
    }
<span class="fc" id="L171">  }</span>

  public PermissionTemplateDto update(DbSession session, PermissionTemplateDto permissionTemplate) {
<span class="fc" id="L174">    mapper(session).update(permissionTemplate);</span>
<span class="fc" id="L175">    auditPersister.updatePermissionTemplate(session, new PermissionTemplateNewValue(permissionTemplate));</span>
<span class="fc" id="L176">    return permissionTemplate;</span>
  }

  public void insertUserPermission(DbSession session, String templateUuid, String userUuid, ProjectPermission permission,
    String templateName, String userLogin) {
<span class="fc" id="L181">    insertUserPermission(session, templateUuid, userUuid, permission.getKey(), templateName, userLogin);</span>
<span class="fc" id="L182">  }</span>

  public void insertUserPermission(DbSession session, String templateUuid, String userUuid, String permission,
    String templateName, String userLogin) {
<span class="fc" id="L186">    PermissionTemplateUserDto permissionTemplateUser = new PermissionTemplateUserDto()</span>
<span class="fc" id="L187">      .setUuid(uuidFactory.create())</span>
<span class="fc" id="L188">      .setTemplateUuid(templateUuid)</span>
<span class="fc" id="L189">      .setUserUuid(userUuid)</span>
<span class="fc" id="L190">      .setPermission(permission)</span>
<span class="fc" id="L191">      .setCreatedAt(now())</span>
<span class="fc" id="L192">      .setUpdatedAt(now());</span>

<span class="fc" id="L194">    mapper(session).insertUserPermission(permissionTemplateUser);</span>

<span class="fc" id="L196">    auditPersister.addUserToPermissionTemplate(session, new PermissionTemplateNewValue(templateUuid, templateName, permission, userUuid, userLogin, null, null));</span>

<span class="fc" id="L198">    session.commit();</span>
<span class="fc" id="L199">  }</span>

  public void deleteUserPermission(DbSession session, String templateUuid, String userUuid, ProjectPermission permission,
    String templateName, String userLogin) {
<span class="fc" id="L203">    deleteUserPermission(session, templateUuid, userUuid, permission.getKey(), templateName, userLogin);</span>
<span class="fc" id="L204">  }</span>

  public void deleteUserPermission(DbSession session, String templateUuid, String userUuid, String permission,
    String templateName, String userLogin) {
<span class="fc" id="L208">    PermissionTemplateUserDto permissionTemplateUser = new PermissionTemplateUserDto()</span>
<span class="fc" id="L209">      .setTemplateUuid(templateUuid)</span>
<span class="fc" id="L210">      .setPermission(permission)</span>
<span class="fc" id="L211">      .setUserUuid(userUuid);</span>
<span class="fc" id="L212">    int deletedRows = mapper(session).deleteUserPermission(permissionTemplateUser);</span>

<span class="fc bfc" id="L214" title="All 2 branches covered.">    if (deletedRows &gt; 0) {</span>
<span class="fc" id="L215">      auditPersister.deleteUserFromPermissionTemplate(session, new PermissionTemplateNewValue(templateUuid, templateName, permission, userUuid, userLogin, null, null));</span>
    }

<span class="fc" id="L218">    session.commit();</span>
<span class="fc" id="L219">  }</span>

  public void deleteUserPermissionsByUserUuid(DbSession dbSession, String userUuid, String userLogin) {
<span class="fc" id="L222">    int deletedRows = mapper(dbSession).deleteUserPermissionsByUserUuid(userUuid);</span>

<span class="fc bfc" id="L224" title="All 2 branches covered.">    if (deletedRows &gt; 0) {</span>
<span class="fc" id="L225">      auditPersister.deleteUserFromPermissionTemplate(dbSession, new PermissionTemplateNewValue(null, null, null, userUuid, userLogin, null, null));</span>
    }
<span class="fc" id="L227">  }</span>

  public void insertGroupPermission(DbSession session, String templateUuid, @Nullable String groupUuid, ProjectPermission permission,
    String templateName, @Nullable String groupName) {
<span class="fc" id="L231">    insertGroupPermission(session, templateUuid, groupUuid, permission.getKey(), templateName, groupName);</span>
<span class="fc" id="L232">  }</span>

  public void insertGroupPermission(DbSession session, String templateUuid, @Nullable String groupUuid, String permission,
    String templateName, @Nullable String groupName) {
<span class="fc" id="L236">    PermissionTemplateGroupDto permissionTemplateGroup = new PermissionTemplateGroupDto()</span>
<span class="fc" id="L237">      .setUuid(uuidFactory.create())</span>
<span class="fc" id="L238">      .setTemplateUuid(templateUuid)</span>
<span class="fc" id="L239">      .setPermission(permission)</span>
<span class="fc" id="L240">      .setGroupUuid(groupUuid)</span>
<span class="fc" id="L241">      .setCreatedAt(now())</span>
<span class="fc" id="L242">      .setUpdatedAt(now());</span>
<span class="fc" id="L243">    mapper(session).insertGroupPermission(permissionTemplateGroup);</span>

<span class="fc" id="L245">    auditPersister.addGroupToPermissionTemplate(session, new PermissionTemplateNewValue(templateUuid, templateName, permission, null, null, groupUuid, groupName));</span>
<span class="fc" id="L246">  }</span>

  public void insertGroupPermission(DbSession session, PermissionTemplateGroupDto permissionTemplateGroup, String templateName) {
<span class="fc" id="L249">    mapper(session).insertGroupPermission(permissionTemplateGroup);</span>

<span class="fc" id="L251">    auditPersister.addGroupToPermissionTemplate(session, new PermissionTemplateNewValue(permissionTemplateGroup.getTemplateUuid(), templateName,</span>
<span class="fc" id="L252">      permissionTemplateGroup.getPermission(), null, null, permissionTemplateGroup.getGroupUuid(), permissionTemplateGroup.getGroupName()));</span>
<span class="fc" id="L253">  }</span>

  public void deleteGroupPermission(DbSession session, String templateUuid, @Nullable String groupUuid, ProjectPermission permission, String templateName,
    @Nullable String groupName) {
<span class="fc" id="L257">    deleteGroupPermission(session, templateUuid, groupUuid, permission.getKey(), templateName, groupName);</span>
<span class="fc" id="L258">  }</span>

  public void deleteGroupPermission(DbSession session, String templateUuid, @Nullable String groupUuid, String permission, String templateName,
    @Nullable String groupName) {
<span class="fc" id="L262">    PermissionTemplateGroupDto permissionTemplateGroup = new PermissionTemplateGroupDto()</span>
<span class="fc" id="L263">      .setTemplateUuid(templateUuid)</span>
<span class="fc" id="L264">      .setPermission(permission)</span>
<span class="fc" id="L265">      .setGroupUuid(groupUuid);</span>
<span class="fc" id="L266">    int deletedRows = mapper(session).deleteGroupPermission(permissionTemplateGroup);</span>

<span class="fc bfc" id="L268" title="All 2 branches covered.">    if (deletedRows &gt; 0) {</span>
<span class="fc" id="L269">      auditPersister.deleteGroupFromPermissionTemplate(session, new PermissionTemplateNewValue(permissionTemplateGroup.getTemplateUuid(), templateName,</span>
<span class="fc" id="L270">        permissionTemplateGroup.getPermission(), null, null, permissionTemplateGroup.getGroupUuid(), groupName));</span>
    }

<span class="fc" id="L273">    session.commit();</span>
<span class="fc" id="L274">  }</span>

  public PermissionTemplateDto selectByName(DbSession dbSession, String name) {
<span class="fc" id="L277">    return mapper(dbSession).selectByName(name.toUpperCase(Locale.ENGLISH));</span>
  }

  public List&lt;String&gt; selectPotentialPermissionsByUserUuidAndTemplateUuid(DbSession dbSession, @Nullable String currentUserUuid, String templateUuid) {
<span class="fc" id="L281">    return mapper(dbSession).selectPotentialPermissionsByUserUuidAndTemplateUuid(currentUserUuid, templateUuid);</span>
  }

  /**
   * Remove a group from all templates (used when removing a group)
   */
  public void deleteByGroup(DbSession session, String groupUuid, String groupName) {
<span class="fc" id="L288">    int deletedRows = session.getMapper(PermissionTemplateMapper.class).deleteByGroupUuid(groupUuid);</span>

<span class="fc bfc" id="L290" title="All 2 branches covered.">    if (deletedRows &gt; 0) {</span>
<span class="fc" id="L291">      auditPersister.deleteGroupFromPermissionTemplate(session, new PermissionTemplateNewValue(null, null, null, null, null, groupUuid, groupName));</span>
    }
<span class="fc" id="L293">  }</span>

  private Date now() {
<span class="fc" id="L296">    return new Date(system.now());</span>
  }

  private static PermissionTemplateMapper mapper(DbSession session) {
<span class="fc" id="L300">    return session.getMapper(PermissionTemplateMapper.class);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>