<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IssueChangeEventServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.pushapi.issues</a> &gt; <span class="el_source">IssueChangeEventServiceImpl.java</span></div><h1>IssueChangeEventServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.pushapi.issues;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import java.io.Serializable;
import java.util.Collection;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.stream.Collectors;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.issue.impact.Severity;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.server.ServerSide;
import org.sonar.core.issue.DefaultIssue;
import org.sonar.core.issue.FieldDiffs;
import org.sonar.core.issue.FieldDiffs.Diff;
import org.sonar.core.util.issue.Issue;
import org.sonar.core.util.issue.IssueChangedEvent;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.pushevent.PushEventDto;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.elasticsearch.common.Strings.isNullOrEmpty;
import static org.sonar.db.component.BranchType.BRANCH;
import static org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition.ACCEPT;
import static org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition.CONFIRM;
import static org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition.FALSE_POSITIVE;
import static org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition.UNCONFIRM;
import static org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition.WONT_FIX;

@ServerSide
public class IssueChangeEventServiceImpl implements IssueChangeEventService {
<span class="fc" id="L57">  private static final Gson GSON = new GsonBuilder().create();</span>

  private static final String EVENT_NAME = &quot;IssueChanged&quot;;
  private static final String FALSE_POSITIVE_KEY = &quot;FALSE-POSITIVE&quot;;
  private static final String WONT_FIX_KEY = &quot;WONTFIX&quot;;

  private static final String RESOLUTION_KEY = &quot;resolution&quot;;
  private static final String SEVERITY_KEY = &quot;severity&quot;;
  private static final String IMPACT_SEVERITY_KEY = &quot;impactSeverity&quot;;
  private static final String TYPE_KEY = &quot;type&quot;;

  private final DbClient dbClient;

<span class="fc" id="L70">  public IssueChangeEventServiceImpl(DbClient dbClient) {</span>
<span class="fc" id="L71">    this.dbClient = dbClient;</span>
<span class="fc" id="L72">  }</span>

  @Override
  public void distributeIssueChangeEvent(DefaultIssue issue, @Nullable String severity, Map&lt;SoftwareQuality, Severity&gt; impacts, @Nullable String type, @Nullable String transition,
    BranchDto branch, String projectKey) {
<span class="fc" id="L77">    Issue changedIssue = new Issue(issue.key(), branch.getKey());</span>

<span class="fc" id="L79">    Boolean resolved = isResolved(transition);</span>

<span class="fc bfc" id="L81" title="All 8 branches covered.">    if (severity == null &amp;&amp; type == null &amp;&amp; resolved == null &amp;&amp; impacts.isEmpty()) {</span>
<span class="fc" id="L82">      return;</span>
    }

<span class="fc" id="L85">    impacts.forEach(changedIssue::addImpact);</span>
<span class="fc" id="L86">    IssueChangedEvent event = new IssueChangedEvent(projectKey, new Issue[] {changedIssue},</span>
      resolved, severity, type);

<span class="fc" id="L89">    persistEvent(event, branch.getProjectUuid());</span>
<span class="fc" id="L90">  }</span>

  @Override
  public void distributeIssueChangeEvent(Collection&lt;DefaultIssue&gt; issues, Map&lt;String, ComponentDto&gt; projectsByUuid,
    Map&lt;String, BranchDto&gt; branchesByProjectUuid) {

<span class="fc bfc" id="L96" title="All 2 branches covered.">    for (Entry&lt;String, ComponentDto&gt; entry : projectsByUuid.entrySet()) {</span>
<span class="fc" id="L97">      String projectKey = entry.getValue().getKey();</span>

<span class="fc" id="L99">      Set&lt;DefaultIssue&gt; issuesInProject = issues</span>
<span class="fc" id="L100">        .stream()</span>
<span class="fc" id="L101">        .filter(i -&gt; i.projectUuid().equals(entry.getKey()))</span>
<span class="fc" id="L102">        .collect(Collectors.toSet());</span>

<span class="fc" id="L104">      Map&lt;String, Issue&gt; issueChanges = issuesInProject.stream()</span>
<span class="fc" id="L105">        .filter(i -&gt; branchesByProjectUuid.get(i.projectUuid()).getBranchType().equals(BRANCH))</span>
<span class="fc" id="L106">        .map(i -&gt; new Issue(i.key(), branchesByProjectUuid.get(i.projectUuid()).getKey()))</span>
<span class="fc" id="L107">        .collect(Collectors.toMap(Issue::getIssueKey, i -&gt; i));</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">      if (issueChanges.isEmpty()) {</span>
<span class="fc" id="L110">        continue;</span>
      }

<span class="fc" id="L113">      IssueChangedEvent event = getIssueChangedEvent(projectKey, issuesInProject, issueChanges);</span>

<span class="fc bfc" id="L115" title="All 2 branches covered.">      if (event != null) {</span>
<span class="fc" id="L116">        BranchDto branchDto = branchesByProjectUuid.get(entry.getKey());</span>
<span class="fc" id="L117">        persistEvent(event, branchDto.getProjectUuid());</span>
      }
<span class="fc" id="L119">    }</span>
<span class="fc" id="L120">  }</span>

  @CheckForNull
  private static IssueChangedEvent getIssueChangedEvent(String projectKey, Set&lt;DefaultIssue&gt; issuesInProject, Map&lt;String, Issue&gt; issueChanges) {
<span class="fc" id="L124">    DefaultIssue firstIssue = issuesInProject.stream().iterator().next();</span>

<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (firstIssue.currentChange() == null) {</span>
<span class="fc" id="L127">      return null;</span>
    }

<span class="fc" id="L130">    Boolean resolved = null;</span>
<span class="fc" id="L131">    String severity = null;</span>
<span class="fc" id="L132">    String type = null;</span>

<span class="fc" id="L134">    boolean isRelevantEvent = false;</span>
<span class="fc" id="L135">    Map&lt;String, Diff&gt; diffs = firstIssue.currentChange().diffs();</span>

<span class="pc bpc" id="L137" title="1 of 2 branches missed.">    if (diffs.containsKey(RESOLUTION_KEY)) {</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">      resolved = diffs.get(RESOLUTION_KEY).newValue() == null ? false : isResolved(diffs.get(RESOLUTION_KEY).newValue().toString());</span>
<span class="fc" id="L139">      isRelevantEvent = true;</span>
    }

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">    if (diffs.containsKey(SEVERITY_KEY)) {</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">      severity = diffs.get(SEVERITY_KEY).newValue() == null ? null : diffs.get(SEVERITY_KEY).newValue().toString();</span>
<span class="fc" id="L144">      isRelevantEvent = true;</span>
    }
<span class="fc" id="L146">    addImpactsToChangeEvent(issuesInProject, issueChanges);</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    if (diffs.containsKey(TYPE_KEY)) {</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">      type = diffs.get(TYPE_KEY).newValue() == null ? null : diffs.get(TYPE_KEY).newValue().toString();</span>
<span class="fc" id="L150">      isRelevantEvent = true;</span>
    }

<span class="pc bpc" id="L153" title="1 of 2 branches missed.">    if (!isRelevantEvent) {</span>
<span class="nc" id="L154">      return null;</span>
    }

<span class="fc" id="L157">    return new IssueChangedEvent(projectKey, issueChanges.values().toArray(new Issue[0]), resolved, severity, type);</span>
  }

  private static void addImpactsToChangeEvent(Set&lt;DefaultIssue&gt; issuesInProject, Map&lt;String, Issue&gt; issueChanges) {
<span class="fc bfc" id="L161" title="All 2 branches covered.">    for (DefaultIssue defaultIssue : issuesInProject) {</span>
<span class="fc" id="L162">      FieldDiffs currentChanges = defaultIssue.currentChange();</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">      if (currentChanges == null) {</span>
<span class="nc" id="L164">        continue;</span>
      }

<span class="fc" id="L167">      Map&lt;String, Diff&gt; diffs = currentChanges.diffs();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">      if (issueChanges.containsKey(defaultIssue.key())</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        &amp;&amp; diffs.containsKey(IMPACT_SEVERITY_KEY)) {</span>
<span class="fc" id="L170">        Serializable newValue = diffs.get(IMPACT_SEVERITY_KEY).newValue();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        String impact = newValue != null ? newValue.toString() : null;</span>
<span class="fc" id="L172">        Issue issue = issueChanges.get(defaultIssue.key());</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        if (impact != null) {</span>
<span class="fc" id="L174">          issue.addImpact(SoftwareQuality.valueOf(impact.split(&quot;:&quot;)[0]), Severity.valueOf(impact.split(&quot;:&quot;)[1]));</span>
        }
      }
<span class="fc" id="L177">    }</span>
<span class="fc" id="L178">  }</span>

  @CheckForNull
  private static Boolean isResolved(@Nullable String transitionOrStatus) {
<span class="fc bfc" id="L182" title="All 2 branches covered.">    if (isNullOrEmpty(transitionOrStatus)) {</span>
<span class="fc" id="L183">      return null;</span>
    }

<span class="fc bfc" id="L186" title="All 4 branches covered.">    if (transitionOrStatus.equals(CONFIRM.getKey()) || transitionOrStatus.equals(UNCONFIRM.getKey())) {</span>
<span class="fc" id="L187">      return null;</span>
    }

<span class="fc bfc" id="L190" title="All 6 branches covered.">    return transitionOrStatus.equals(ACCEPT.getKey()) || transitionOrStatus.equals(WONT_FIX.getKey()) || transitionOrStatus.equals(FALSE_POSITIVE.getKey()) ||</span>
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">      transitionOrStatus.equals(FALSE_POSITIVE_KEY) || transitionOrStatus.equals(WONT_FIX_KEY);</span>
  }

  private void persistEvent(IssueChangedEvent event, String entry) {
<span class="fc" id="L195">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L196">      PushEventDto eventDto = new PushEventDto()</span>
<span class="fc" id="L197">        .setName(EVENT_NAME)</span>
<span class="fc" id="L198">        .setProjectUuid(entry)</span>
<span class="fc" id="L199">        .setPayload(serializeIssueToPushEvent(event));</span>
<span class="fc" id="L200">      dbClient.pushEventDao().insert(dbSession, eventDto);</span>
<span class="fc" id="L201">      dbSession.commit();</span>
    }
<span class="fc" id="L203">  }</span>

  private static byte[] serializeIssueToPushEvent(IssueChangedEvent event) {
<span class="fc" id="L206">    return GSON.toJson(event).getBytes(UTF_8);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>