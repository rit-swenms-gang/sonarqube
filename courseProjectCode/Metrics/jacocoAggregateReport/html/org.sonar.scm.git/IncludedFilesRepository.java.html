<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IncludedFilesRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.scm.git</a> &gt; <span class="el_source">IncludedFilesRepository.java</span></div><h1>IncludedFilesRepository.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.scm.git;

import java.io.IOException;
import java.nio.file.Path;
import java.util.HashSet;
import java.util.Set;
import org.eclipse.jgit.lib.Repository;
import org.eclipse.jgit.submodule.SubmoduleWalk;
import org.eclipse.jgit.treewalk.FileTreeIterator;
import org.eclipse.jgit.treewalk.TreeWalk;
import org.eclipse.jgit.treewalk.WorkingTreeIterator;
import org.eclipse.jgit.treewalk.filter.PathFilterGroup;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class IncludedFilesRepository {

<span class="fc" id="L37">  private static final Logger LOG = LoggerFactory.getLogger(IncludedFilesRepository.class);</span>
<span class="fc" id="L38">  private final Set&lt;Path&gt; includedFiles = new HashSet&lt;&gt;();</span>

<span class="fc" id="L40">  public IncludedFilesRepository(Path baseDir) throws IOException {</span>
<span class="fc" id="L41">    indexFiles(baseDir);</span>
<span class="fc" id="L42">    LOG.debug(&quot;{} non excluded files in this Git repository&quot;, includedFiles.size());</span>
<span class="fc" id="L43">  }</span>

  public boolean contains(Path absolutePath) {
<span class="fc" id="L46">    return includedFiles.contains(absolutePath);</span>
  }

  private void indexFiles(Path baseDir) throws IOException {
<span class="fc" id="L50">    try (Repository repo = JGitUtils.buildRepository(baseDir)) {</span>
<span class="fc" id="L51">      collectFilesIterative(repo, baseDir);</span>
    }
<span class="fc" id="L53">  }</span>

  private void collectFiles(Repository repo, Path baseDir) throws IOException {
<span class="fc" id="L56">    Path workTreeRoot = repo.getWorkTree().toPath();</span>
<span class="fc" id="L57">    FileTreeIterator workingTreeIt = new FileTreeIterator(repo);</span>
<span class="fc" id="L58">    try (TreeWalk treeWalk = new TreeWalk(repo)) {</span>
<span class="fc" id="L59">      treeWalk.setRecursive(true);</span>
      // with submodules, the baseDir may be the parent of the workTreeRoot. In that case, we don't want to set a filter.
<span class="fc bfc" id="L61" title="All 4 branches covered.">      if (!workTreeRoot.equals(baseDir) &amp;&amp; baseDir.startsWith(workTreeRoot)) {</span>
<span class="fc" id="L62">        Path relativeBaseDir = workTreeRoot.relativize(baseDir);</span>
<span class="fc" id="L63">        treeWalk.setFilter(PathFilterGroup.createFromStrings(relativeBaseDir.toString().replace('\\', '/')));</span>
      }
<span class="fc" id="L65">      treeWalk.addTree(workingTreeIt);</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">      while (treeWalk.next()) {</span>

<span class="fc" id="L68">        WorkingTreeIterator workingTreeIterator = treeWalk</span>
<span class="fc" id="L69">          .getTree(0, WorkingTreeIterator.class);</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (!workingTreeIterator.isEntryIgnored()) {</span>
<span class="fc" id="L72">          includedFiles.add(workTreeRoot.resolve(treeWalk.getPathString()));</span>
        }
<span class="fc" id="L74">      }</span>
    }
<span class="fc" id="L76">  }</span>

  private void collectFilesIterative(Repository repo, Path baseDir) throws IOException {
<span class="fc" id="L79">    collectFiles(repo, baseDir);</span>

<span class="fc" id="L81">    try (SubmoduleWalk submoduleWalk = SubmoduleWalk.forIndex(repo)) {</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">      while (submoduleWalk.next()) {</span>
<span class="fc" id="L83">        try (Repository submoduleRepo = submoduleWalk.getRepository()) {</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">          if (submoduleRepo == null) {</span>
<span class="fc" id="L85">            LOG.debug(&quot;Git submodule [{}] found, but has not been cloned, skipping.&quot;, submoduleWalk.getPath());</span>
            continue;
          }
<span class="fc" id="L88">          collectFilesIterative(submoduleRepo, baseDir);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        }</span>
      }
    }
<span class="fc" id="L92">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>