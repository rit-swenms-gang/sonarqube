<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasureAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.badge.ws</a> &gt; <span class="el_source">MeasureAction.java</span></div><h1>MeasureAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.badge.ws;

import com.google.common.collect.ImmutableMap;
import com.google.common.io.Resources;
import java.util.EnumMap;
import java.util.Map;
import java.util.function.Function;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.NewAction;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.measure.MeasureDto;
import org.sonar.db.metric.MetricDto;
import org.sonar.server.badge.ws.SvgGenerator.Color;
import org.sonar.server.measure.Rating;
import org.sonar.server.telemetry.TelemetryBadgeProvider;

import static com.google.common.base.Preconditions.checkState;
import static java.lang.String.format;
import static org.sonar.api.measures.CoreMetrics.ALERT_STATUS_KEY;
import static org.sonar.api.measures.CoreMetrics.BUGS_KEY;
import static org.sonar.api.measures.CoreMetrics.CODE_SMELLS_KEY;
import static org.sonar.api.measures.CoreMetrics.COVERAGE_KEY;
import static org.sonar.api.measures.CoreMetrics.DUPLICATED_LINES_DENSITY_KEY;
import static org.sonar.api.measures.CoreMetrics.NCLOC_KEY;
import static org.sonar.api.measures.CoreMetrics.RELIABILITY_RATING_KEY;
import static org.sonar.api.measures.CoreMetrics.SECURITY_HOTSPOTS_KEY;
import static org.sonar.api.measures.CoreMetrics.SECURITY_RATING_KEY;
import static org.sonar.api.measures.CoreMetrics.SQALE_RATING_KEY;
import static org.sonar.api.measures.CoreMetrics.TECHNICAL_DEBT_KEY;
import static org.sonar.api.measures.CoreMetrics.VULNERABILITIES_KEY;
import static org.sonar.api.measures.Metric.Level;
import static org.sonar.api.measures.Metric.ValueType;
import static org.sonar.api.measures.Metric.Level.ERROR;
import static org.sonar.api.measures.Metric.Level.OK;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_MAINTAINABILITY_ISSUES_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_MAINTAINABILITY_RATING_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_MAINTAINABILITY_REMEDIATION_EFFORT_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_RELIABILITY_ISSUES_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_RELIABILITY_RATING_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_SECURITY_ISSUES_KEY;
import static org.sonar.core.metric.SoftwareQualitiesMetrics.SOFTWARE_QUALITY_SECURITY_RATING_KEY;
import static org.sonar.server.badge.ws.SvgFormatter.formatDuration;
import static org.sonar.server.badge.ws.SvgFormatter.formatNumeric;
import static org.sonar.server.badge.ws.SvgFormatter.formatPercent;
import static org.sonar.server.measure.Rating.A;
import static org.sonar.server.measure.Rating.B;
import static org.sonar.server.measure.Rating.C;
import static org.sonar.server.measure.Rating.D;
import static org.sonar.server.measure.Rating.E;

public class MeasureAction extends AbstractProjectBadgesWsAction {

  private static final String PARAM_METRIC = &quot;metric&quot;;

<span class="fc" id="L78">  private static final Map&lt;String, String&gt; METRIC_NAME_BY_KEY = ImmutableMap.&lt;String, String&gt;builder()</span>
<span class="fc" id="L79">    .put(COVERAGE_KEY, &quot;coverage&quot;)</span>
<span class="fc" id="L80">    .put(DUPLICATED_LINES_DENSITY_KEY, &quot;duplicated lines&quot;)</span>
<span class="fc" id="L81">    .put(NCLOC_KEY, &quot;lines of code&quot;)</span>
<span class="fc" id="L82">    .put(ALERT_STATUS_KEY, &quot;quality gate&quot;)</span>
<span class="fc" id="L83">    .put(SECURITY_HOTSPOTS_KEY, &quot;security hotspots&quot;)</span>

    // Standard mode
<span class="fc" id="L86">    .put(BUGS_KEY, &quot;bugs&quot;)</span>
<span class="fc" id="L87">    .put(CODE_SMELLS_KEY, &quot;code smells&quot;)</span>
<span class="fc" id="L88">    .put(VULNERABILITIES_KEY, &quot;vulnerabilities&quot;)</span>
<span class="fc" id="L89">    .put(SQALE_RATING_KEY, &quot;maintainability&quot;)</span>
<span class="fc" id="L90">    .put(RELIABILITY_RATING_KEY, &quot;reliability&quot;)</span>
<span class="fc" id="L91">    .put(SECURITY_RATING_KEY, &quot;security&quot;)</span>
<span class="fc" id="L92">    .put(TECHNICAL_DEBT_KEY, &quot;technical debt&quot;)</span>

    // MQR mode
<span class="fc" id="L95">    .put(SOFTWARE_QUALITY_RELIABILITY_ISSUES_KEY, &quot;reliability issues&quot;)</span>
<span class="fc" id="L96">    .put(SOFTWARE_QUALITY_MAINTAINABILITY_ISSUES_KEY, &quot;maintainability issues&quot;)</span>
<span class="fc" id="L97">    .put(SOFTWARE_QUALITY_SECURITY_ISSUES_KEY, &quot;security issues&quot;)</span>
<span class="fc" id="L98">    .put(SOFTWARE_QUALITY_MAINTAINABILITY_RATING_KEY, &quot;maintainability&quot;)</span>
<span class="fc" id="L99">    .put(SOFTWARE_QUALITY_RELIABILITY_RATING_KEY, &quot;reliability&quot;)</span>
<span class="fc" id="L100">    .put(SOFTWARE_QUALITY_SECURITY_RATING_KEY, &quot;security&quot;)</span>
<span class="fc" id="L101">    .put(SOFTWARE_QUALITY_MAINTAINABILITY_REMEDIATION_EFFORT_KEY, &quot;technical debt&quot;)</span>
<span class="fc" id="L102">    .build();</span>

<span class="fc" id="L104">  private static final String[] UNDEPRECATED_METRIC_KEYS = {BUGS_KEY, CODE_SMELLS_KEY, SECURITY_HOTSPOTS_KEY, VULNERABILITIES_KEY};</span>

<span class="fc" id="L106">  private static final Map&lt;Level, String&gt; QUALITY_GATE_MESSAGE_BY_STATUS = new EnumMap&lt;&gt;(Map.of(</span>
    OK, &quot;passed&quot;,
    ERROR, &quot;failed&quot;));

<span class="fc" id="L110">  private static final Map&lt;Level, Color&gt; COLOR_BY_QUALITY_GATE_STATUS = new EnumMap&lt;&gt;(Map.of(</span>
    OK, Color.QUALITY_GATE_OK,
    ERROR, Color.QUALITY_GATE_ERROR));

<span class="fc" id="L114">  private static final Map&lt;Rating, Color&gt; COLOR_BY_RATING = new EnumMap&lt;&gt;(Map.of(</span>
    A, Color.RATING_A,
    B, Color.RATING_B,
    C, Color.RATING_C,
    D, Color.RATING_D,
    E, Color.RATING_E));

  private final DbClient dbClient;
  private final TelemetryBadgeProvider telemetryBadgeProvider;

  public MeasureAction(DbClient dbClient, ProjectBadgesSupport support, SvgGenerator svgGenerator,
    TelemetryBadgeProvider telemetryBadgeProvider) {
<span class="fc" id="L126">    super(support, svgGenerator);</span>
<span class="fc" id="L127">    this.dbClient = dbClient;</span>
<span class="fc" id="L128">    this.telemetryBadgeProvider = telemetryBadgeProvider;</span>
<span class="fc" id="L129">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L133">    NewAction action = controller.createAction(&quot;measure&quot;)</span>
<span class="fc" id="L134">      .setHandler(this)</span>
<span class="fc" id="L135">      .setDescription(&quot;Generate badge for project's measure as an SVG.&lt;br/&gt;&quot; +</span>
        &quot;Requires 'Browse' permission on the specified project.&quot;)
<span class="fc" id="L137">      .setSince(&quot;7.1&quot;)</span>
<span class="fc" id="L138">      .setChangelog(new Change(&quot;10.8&quot;, format(&quot;The following metric keys are not deprecated anymore: %s&quot;, String.join(&quot;, &quot;,</span>
        UNDEPRECATED_METRIC_KEYS))))
<span class="fc" id="L140">      .setChangelog(new Change(&quot;10.4&quot;, format(&quot;The following metric keys are now deprecated: %s&quot;, String.join(&quot;, &quot;,</span>
        UNDEPRECATED_METRIC_KEYS))))
<span class="fc" id="L142">      .setResponseExample(Resources.getResource(getClass(), &quot;measure-example.svg&quot;));</span>
<span class="fc" id="L143">    support.addProjectAndBranchParams(action);</span>
<span class="fc" id="L144">    action.createParam(PARAM_METRIC)</span>
<span class="fc" id="L145">      .setDescription(&quot;Metric key&quot;)</span>
<span class="fc" id="L146">      .setRequired(true)</span>
<span class="fc" id="L147">      .setPossibleValues(METRIC_NAME_BY_KEY.keySet());</span>
<span class="fc" id="L148">  }</span>

  @Override
  protected String getBadge(Request request) {
<span class="fc" id="L152">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L153">      String metricKey = request.mandatoryParam(PARAM_METRIC);</span>
<span class="fc" id="L154">      BranchDto branch = support.getBranch(dbSession, request);</span>
<span class="fc" id="L155">      MetricDto metric = dbClient.metricDao().selectByKey(dbSession, metricKey);</span>
<span class="pc bpc" id="L156" title="1 of 4 branches missed.">      checkState(metric != null &amp;&amp; metric.isEnabled(), &quot;Metric '%s' hasn't been found&quot;, metricKey);</span>
<span class="fc" id="L157">      MeasureDto measure = getMeasure(dbSession, branch);</span>
<span class="fc" id="L158">      telemetryBadgeProvider.incrementForMetric(metricKey);</span>
<span class="fc" id="L159">      return generateSvg(metric, measure);</span>
    }
  }

  private MeasureDto getMeasure(DbSession dbSession, BranchDto branch) {
<span class="fc" id="L164">    return dbClient.measureDao().selectByComponentUuid(dbSession, branch.getUuid())</span>
<span class="fc" id="L165">      .orElseThrow(() -&gt; new ProjectBadgesException(&quot;Measure has not been found&quot;));</span>
  }

  private String generateSvg(MetricDto metric, MeasureDto measure) {
<span class="fc" id="L169">    String metricType = metric.getValueType();</span>
<span class="pc bpc" id="L170" title="1 of 6 branches missed.">    switch (ValueType.valueOf(metricType)) {</span>
      case INT:
<span class="fc" id="L172">        return generateBadge(metric, formatNumeric(getNonNullValue(measure, m -&gt; m.getLong(metric.getKey()))), Color.DEFAULT);</span>
      case PERCENT:
<span class="fc" id="L174">        return generateBadge(metric, formatPercent(getNonNullValue(measure, m -&gt; m.getDouble(metric.getKey()))), Color.DEFAULT);</span>
      case LEVEL:
<span class="fc" id="L176">        return generateQualityGate(metric, measure);</span>
      case WORK_DUR:
<span class="fc" id="L178">        return generateBadge(metric, formatDuration(getNonNullValue(measure, m -&gt; m.getLong(metric.getKey()))), Color.DEFAULT);</span>
      case RATING:
<span class="fc" id="L180">        return generateRating(metric, measure);</span>
      default:
<span class="nc" id="L182">        throw new IllegalStateException(format(&quot;Invalid metric type '%s'&quot;, metricType));</span>
    }
  }

  private String generateQualityGate(MetricDto metric, MeasureDto measure) {
<span class="fc" id="L187">    Level qualityGate = Level.valueOf(getNonNullValue(measure, m -&gt; m.getString(metric.getKey())));</span>
<span class="fc" id="L188">    return generateBadge(metric, QUALITY_GATE_MESSAGE_BY_STATUS.get(qualityGate), COLOR_BY_QUALITY_GATE_STATUS.get(qualityGate));</span>
  }

  private String generateRating(MetricDto metric, MeasureDto measure) {
<span class="fc" id="L192">    Rating rating = Rating.valueOf(getNonNullValue(measure, m -&gt; m.getInt(metric.getKey())).intValue());</span>
<span class="fc" id="L193">    return generateBadge(metric, rating.name(), COLOR_BY_RATING.get(rating));</span>
  }

  private String generateBadge(MetricDto metric, String value, Color color) {
<span class="fc" id="L197">    return svgGenerator.generateBadge(METRIC_NAME_BY_KEY.get(metric.getKey()), value, color);</span>
  }

  private static &lt;P&gt; P getNonNullValue(MeasureDto measure, Function&lt;MeasureDto, P&gt; function) {
<span class="fc" id="L201">    P value = function.apply(measure);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">    checkState(value != null, &quot;Measure has not been found&quot;);</span>
<span class="fc" id="L203">    return value;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>