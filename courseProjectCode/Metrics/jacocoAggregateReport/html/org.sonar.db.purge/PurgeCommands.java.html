<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PurgeCommands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.db.purge</a> &gt; <span class="el_source">PurgeCommands.java</span></div><h1>PurgeCommands.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.db.purge;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.Lists;
import java.util.Collection;
import java.util.List;
import javax.annotation.Nullable;
import org.sonar.api.utils.System2;
import org.sonar.db.DbSession;

import static org.sonar.db.DatabaseUtils.executeLargeInputs;

class PurgeCommands {

  private static final int MAX_SNAPSHOTS_PER_QUERY = 1000;
  private static final int MAX_RESOURCES_PER_QUERY = 1000;
<span class="fc" id="L36">  private static final String[] UNPROCESSED_STATUS = new String[]{&quot;U&quot;};</span>

  private final DbSession session;
  private final PurgeMapper purgeMapper;
  private final PurgeProfiler profiler;
  private final System2 system2;

<span class="fc" id="L43">  PurgeCommands(DbSession session, PurgeMapper purgeMapper, PurgeProfiler profiler, System2 system2) {</span>
<span class="fc" id="L44">    this.session = session;</span>
<span class="fc" id="L45">    this.purgeMapper = purgeMapper;</span>
<span class="fc" id="L46">    this.profiler = profiler;</span>
<span class="fc" id="L47">    this.system2 = system2;</span>
<span class="fc" id="L48">  }</span>

  PurgeCommands(DbSession session, PurgeProfiler profiler, System2 system2) {
<span class="fc" id="L51">    this(session, session.getMapper(PurgeMapper.class), profiler, system2);</span>
<span class="fc" id="L52">  }</span>

  List&lt;String&gt; selectSnapshotUuids(PurgeSnapshotQuery query) {
<span class="fc" id="L55">    return purgeMapper.selectAnalysisUuids(query);</span>
  }

  void deleteEventComponentChanges(String rootComponentUuid) {
<span class="fc" id="L59">    profiler.start(&quot;deleteAnalyses (event_component_changes)&quot;);</span>
<span class="fc" id="L60">    purgeMapper.deleteEventComponentChangesByComponentUuid(rootComponentUuid);</span>
<span class="fc" id="L61">    session.commit();</span>
<span class="fc" id="L62">    profiler.stop();</span>
<span class="fc" id="L63">  }</span>

  void deleteAnalyses(String rootComponentUuid) {
<span class="fc" id="L66">    profiler.start(&quot;deleteAnalyses (events)&quot;);</span>
<span class="fc" id="L67">    purgeMapper.deleteEventsByComponentUuid(rootComponentUuid);</span>
<span class="fc" id="L68">    session.commit();</span>
<span class="fc" id="L69">    profiler.stop();</span>

<span class="fc" id="L71">    List&lt;List&lt;String&gt;&gt; analysisUuidsPartitions = Lists.partition(purgeMapper.selectAnalysisUuids(new PurgeSnapshotQuery(rootComponentUuid)), MAX_SNAPSHOTS_PER_QUERY);</span>

<span class="fc" id="L73">    deleteAnalysisDuplications(analysisUuidsPartitions);</span>

<span class="fc" id="L75">    profiler.start(&quot;deleteAnalyses (project_measures)&quot;);</span>
<span class="fc" id="L76">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisMeasures);</span>
<span class="fc" id="L77">    session.commit();</span>
<span class="fc" id="L78">    profiler.stop();</span>

<span class="fc" id="L80">    profiler.start(&quot;deleteAnalyses (analysis_properties)&quot;);</span>
<span class="fc" id="L81">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisProperties);</span>
<span class="fc" id="L82">    session.commit();</span>
<span class="fc" id="L83">    profiler.stop();</span>

<span class="fc" id="L85">    profiler.start(&quot;deleteAnalyses (snapshots)&quot;);</span>
<span class="fc" id="L86">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalyses);</span>
<span class="fc" id="L87">    session.commit();</span>
<span class="fc" id="L88">    profiler.stop();</span>
<span class="fc" id="L89">  }</span>

  void deleteAbortedAnalyses(String rootUuid) {
<span class="fc" id="L92">    PurgeSnapshotQuery query = new PurgeSnapshotQuery(rootUuid)</span>
<span class="fc" id="L93">      .setIslast(false)</span>
<span class="fc" id="L94">      .setStatus(UNPROCESSED_STATUS);</span>
<span class="fc" id="L95">    deleteAnalyses(purgeMapper.selectAnalysisUuids(query));</span>
<span class="fc" id="L96">  }</span>

  @VisibleForTesting
  void deleteAnalyses(List&lt;String&gt; analysisIdUuids) {
<span class="fc" id="L100">    List&lt;List&lt;String&gt;&gt; analysisUuidsPartitions = Lists.partition(analysisIdUuids, MAX_SNAPSHOTS_PER_QUERY);</span>

<span class="fc" id="L102">    deleteAnalysisDuplications(analysisUuidsPartitions);</span>

<span class="fc" id="L104">    profiler.start(&quot;deleteAnalyses (event_component_changes)&quot;);</span>
<span class="fc" id="L105">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisEventComponentChanges);</span>
<span class="fc" id="L106">    session.commit();</span>
<span class="fc" id="L107">    profiler.stop();</span>

<span class="fc" id="L109">    profiler.start(&quot;deleteAnalyses (events)&quot;);</span>
<span class="fc" id="L110">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisEvents);</span>
<span class="fc" id="L111">    session.commit();</span>
<span class="fc" id="L112">    profiler.stop();</span>

<span class="fc" id="L114">    profiler.start(&quot;deleteAnalyses (project_measures)&quot;);</span>
<span class="fc" id="L115">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisMeasures);</span>
<span class="fc" id="L116">    session.commit();</span>
<span class="fc" id="L117">    profiler.stop();</span>

<span class="fc" id="L119">    profiler.start(&quot;deleteAnalyses (analysis_properties)&quot;);</span>
<span class="fc" id="L120">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalysisProperties);</span>
<span class="fc" id="L121">    session.commit();</span>
<span class="fc" id="L122">    profiler.stop();</span>

<span class="fc" id="L124">    profiler.start(&quot;deleteAnalyses (snapshots)&quot;);</span>
<span class="fc" id="L125">    analysisUuidsPartitions.forEach(purgeMapper::deleteAnalyses);</span>
<span class="fc" id="L126">    session.commit();</span>
<span class="fc" id="L127">    profiler.stop();</span>
<span class="fc" id="L128">  }</span>

  void purgeAnalyses(List&lt;String&gt; analysisUuids) {
<span class="fc" id="L131">    List&lt;List&lt;String&gt;&gt; analysisUuidsPartitions = Lists.partition(analysisUuids, MAX_SNAPSHOTS_PER_QUERY);</span>

<span class="fc" id="L133">    deleteAnalysisDuplications(analysisUuidsPartitions);</span>

<span class="fc" id="L135">    profiler.start(&quot;updatePurgeStatusToOne (snapshots)&quot;);</span>
<span class="fc" id="L136">    analysisUuidsPartitions.forEach(purgeMapper::updatePurgeStatusToOne);</span>
<span class="fc" id="L137">    session.commit();</span>
<span class="fc" id="L138">    profiler.stop();</span>
<span class="fc" id="L139">  }</span>

  void purgeDisabledComponents(String rootComponentUuid, Collection&lt;String&gt; disabledComponentUuids, PurgeListener listener) {

<span class="fc" id="L143">    profiler.start(&quot;purgeDisabledComponents (file_sources)&quot;);</span>
<span class="fc" id="L144">      executeLargeInputs(</span>
<span class="fc" id="L145">        purgeMapper.selectDisabledComponentsWithFileSource(rootComponentUuid),</span>
        input -&gt; {
<span class="fc" id="L147">          purgeMapper.deleteFileSourcesByFileUuid(input);</span>
<span class="fc" id="L148">          return input;</span>
        });
<span class="fc" id="L150">    profiler.stop();</span>

<span class="fc" id="L152">    profiler.start(&quot;purgeDisabledComponents (unresolved_issues)&quot;);</span>
<span class="fc" id="L153">      executeLargeInputs(</span>
<span class="fc" id="L154">        purgeMapper.selectDisabledComponentsWithUnresolvedIssues(rootComponentUuid),</span>
        input -&gt; {
<span class="fc" id="L156">          purgeMapper.resolveComponentIssuesNotAlreadyResolved(input, system2.now());</span>
<span class="fc" id="L157">          return input;</span>
        });
<span class="fc" id="L159">    profiler.stop();</span>

<span class="fc" id="L161">    profiler.start(&quot;purgeDisabledComponents (measures)&quot;);</span>
<span class="fc" id="L162">    executeLargeInputs(</span>
<span class="fc" id="L163">      purgeMapper.selectDisabledComponentsWithMeasures(rootComponentUuid),</span>
      input -&gt; {
<span class="fc" id="L165">        purgeMapper.deleteMeasuresByComponentUuids(input);</span>
<span class="fc" id="L166">        return input;</span>
      });
<span class="fc" id="L168">    profiler.stop();</span>

<span class="fc" id="L170">    session.commit();</span>
<span class="fc" id="L171">  }</span>

  private void deleteAnalysisDuplications(List&lt;List&lt;String&gt;&gt; snapshotUuidsPartitions) {
<span class="fc" id="L174">    profiler.start(&quot;deleteAnalysisDuplications (duplications_index)&quot;);</span>
<span class="fc" id="L175">    snapshotUuidsPartitions.forEach(purgeMapper::deleteAnalysisDuplications);</span>
<span class="fc" id="L176">    session.commit();</span>
<span class="fc" id="L177">    profiler.stop();</span>
<span class="fc" id="L178">  }</span>

  void deletePermissions(String entityUuid) {
<span class="fc" id="L181">    profiler.start(&quot;deletePermissions (group_roles)&quot;);</span>
<span class="fc" id="L182">    purgeMapper.deleteGroupRolesByEntityUuid(entityUuid);</span>
<span class="fc" id="L183">    session.commit();</span>
<span class="fc" id="L184">    profiler.stop();</span>

<span class="fc" id="L186">    profiler.start(&quot;deletePermissions (user_roles)&quot;);</span>
<span class="fc" id="L187">    purgeMapper.deleteUserRolesByEntityUuid(entityUuid);</span>
<span class="fc" id="L188">    session.commit();</span>
<span class="fc" id="L189">    profiler.stop();</span>
<span class="fc" id="L190">  }</span>

  void deleteIssues(String rootUuid) {
<span class="fc" id="L193">    profiler.start(&quot;deleteIssues (issue_changes)&quot;);</span>
<span class="fc" id="L194">    purgeMapper.deleteIssueChangesByProjectUuid(rootUuid);</span>
<span class="fc" id="L195">    session.commit();</span>
<span class="fc" id="L196">    profiler.stop();</span>

<span class="fc" id="L198">    profiler.start(&quot;deleteIssues (new_code_reference_issues)&quot;);</span>
<span class="fc" id="L199">    purgeMapper.deleteNewCodeReferenceIssuesByProjectUuid(rootUuid);</span>
<span class="fc" id="L200">    session.commit();</span>
<span class="fc" id="L201">    profiler.stop();</span>

<span class="fc" id="L203">    profiler.start(&quot;deleteIssues (issues_impacts)&quot;);</span>
<span class="fc" id="L204">    purgeMapper.deleteIssuesImpactsByProjectUuid(rootUuid);</span>
<span class="fc" id="L205">    session.commit();</span>
<span class="fc" id="L206">    profiler.stop();</span>

<span class="fc" id="L208">    profiler.start(&quot;deleteIssues (issues)&quot;);</span>
<span class="fc" id="L209">    purgeMapper.deleteIssuesByProjectUuid(rootUuid);</span>
<span class="fc" id="L210">    session.commit();</span>
<span class="fc" id="L211">    profiler.stop();</span>
<span class="fc" id="L212">  }</span>

  void deleteLinks(String rootUuid) {
<span class="fc" id="L215">    profiler.start(&quot;deleteLinks (project_links)&quot;);</span>
<span class="fc" id="L216">    purgeMapper.deleteProjectLinksByProjectUuid(rootUuid);</span>
<span class="fc" id="L217">    session.commit();</span>
<span class="fc" id="L218">    profiler.stop();</span>
<span class="fc" id="L219">  }</span>

  void deleteByRootAndSubviews(List&lt;String&gt; rootAndSubviewsUuids) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">    if (rootAndSubviewsUuids.isEmpty()) {</span>
<span class="fc" id="L223">      return;</span>
    }
<span class="fc" id="L225">    List&lt;List&lt;String&gt;&gt; uuidsPartitions = Lists.partition(rootAndSubviewsUuids, MAX_RESOURCES_PER_QUERY);</span>

<span class="fc" id="L227">    profiler.start(&quot;deleteByRootAndSubviews (properties)&quot;);</span>
<span class="fc" id="L228">    uuidsPartitions.forEach(purgeMapper::deletePropertiesByEntityUuids);</span>
<span class="fc" id="L229">    session.commit();</span>
<span class="fc" id="L230">    profiler.stop();</span>

<span class="fc" id="L232">    profiler.start(&quot;deleteByRootAndSubviews (report_schedules)&quot;);</span>
<span class="fc" id="L233">    uuidsPartitions.forEach(purgeMapper::deleteReportSchedulesByPortfolioUuids);</span>
<span class="fc" id="L234">    session.commit();</span>
<span class="fc" id="L235">    profiler.stop();</span>

<span class="fc" id="L237">    profiler.start(&quot;deleteByRootAndSubviews (report_subscriptions)&quot;);</span>
<span class="fc" id="L238">    uuidsPartitions.forEach(purgeMapper::deleteReportSubscriptionsByPortfolioUuids);</span>
<span class="fc" id="L239">    session.commit();</span>
<span class="fc" id="L240">    profiler.stop();</span>
<span class="fc" id="L241">  }</span>

  void deleteDisabledComponentsWithoutIssues(List&lt;String&gt; disabledComponentsWithoutIssue) {
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (disabledComponentsWithoutIssue.isEmpty()) {</span>
<span class="fc" id="L245">      return;</span>
    }
<span class="fc" id="L247">    List&lt;List&lt;String&gt;&gt; uuidsPartitions = Lists.partition(disabledComponentsWithoutIssue, MAX_RESOURCES_PER_QUERY);</span>

<span class="fc" id="L249">    profiler.start(&quot;deleteDisabledComponentsWithoutIssues (properties)&quot;);</span>
<span class="fc" id="L250">    uuidsPartitions.forEach(purgeMapper::deletePropertiesByEntityUuids);</span>
<span class="fc" id="L251">    session.commit();</span>
<span class="fc" id="L252">    profiler.stop();</span>

<span class="fc" id="L254">    profiler.start(&quot;deleteDisabledComponentsWithoutIssues (projects)&quot;);</span>
<span class="fc" id="L255">    uuidsPartitions.forEach(purgeMapper::deleteComponentsByUuids);</span>
<span class="fc" id="L256">    session.commit();</span>
<span class="fc" id="L257">    profiler.stop();</span>
<span class="fc" id="L258">  }</span>

  void deleteOutdatedProperties(String entityUuid) {
<span class="fc" id="L261">    profiler.start(&quot;deleteOutdatedProperties (properties)&quot;);</span>
<span class="fc" id="L262">    purgeMapper.deletePropertiesByEntityUuids(List.of(entityUuid));</span>
<span class="fc" id="L263">    session.commit();</span>
<span class="fc" id="L264">    profiler.stop();</span>
<span class="fc" id="L265">  }</span>

  void deleteComponents(String rootUuid) {
<span class="fc" id="L268">    profiler.start(&quot;deleteComponents (projects)&quot;);</span>
<span class="fc" id="L269">    purgeMapper.deleteComponentsByBranchUuid(rootUuid);</span>
<span class="fc" id="L270">    session.commit();</span>
<span class="fc" id="L271">    profiler.stop();</span>
<span class="fc" id="L272">  }</span>

  void deleteNonMainBranchComponentsByProjectUuid(String uuid) {
<span class="fc" id="L275">    profiler.start(&quot;deleteNonMainBranchComponentsByProjectUuid (projects)&quot;);</span>
<span class="fc" id="L276">    purgeMapper.deleteNonMainBranchComponentsByProjectUuid(uuid);</span>
<span class="fc" id="L277">    session.commit();</span>
<span class="fc" id="L278">    profiler.stop();</span>
<span class="fc" id="L279">  }</span>

  void deleteProject(String projectUuid) {
<span class="fc" id="L282">    profiler.start(&quot;deleteProject (projects)&quot;);</span>
<span class="fc" id="L283">    purgeMapper.deleteProjectsByProjectUuid(projectUuid);</span>
<span class="fc" id="L284">    session.commit();</span>
<span class="fc" id="L285">    profiler.stop();</span>
<span class="fc" id="L286">  }</span>

  void deleteComponents(List&lt;String&gt; componentUuids) {
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">    if (componentUuids.isEmpty()) {</span>
<span class="nc" id="L290">      return;</span>
    }

<span class="fc" id="L293">    profiler.start(&quot;deleteComponents (projects)&quot;);</span>
<span class="fc" id="L294">    Lists.partition(componentUuids, MAX_RESOURCES_PER_QUERY).forEach(purgeMapper::deleteComponentsByUuids);</span>
<span class="fc" id="L295">    session.commit();</span>
<span class="fc" id="L296">    profiler.stop();</span>
<span class="fc" id="L297">  }</span>

  void deleteComponentMeasures(List&lt;String&gt; componentUuids) {
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">    if (componentUuids.isEmpty()) {</span>
<span class="nc" id="L301">      return;</span>
    }

<span class="fc" id="L304">    profiler.start(&quot;deleteComponentMeasures (project_measures)&quot;);</span>
<span class="fc" id="L305">    Lists.partition(componentUuids, MAX_RESOURCES_PER_QUERY).forEach(purgeMapper::fullDeleteComponentMeasures);</span>
<span class="fc" id="L306">    session.commit();</span>
<span class="fc" id="L307">    profiler.stop();</span>
<span class="fc" id="L308">  }</span>

  void deleteFileSources(String rootUuid) {
<span class="fc" id="L311">    profiler.start(&quot;deleteFileSources (file_sources)&quot;);</span>
<span class="fc" id="L312">    purgeMapper.deleteFileSourcesByProjectUuid(rootUuid);</span>
<span class="fc" id="L313">    session.commit();</span>
<span class="fc" id="L314">    profiler.stop();</span>
<span class="fc" id="L315">  }</span>

  void deleteCeActivity(String rootUuid) {
<span class="fc" id="L318">    profiler.start(&quot;deleteCeActivity (ce_scanner_context)&quot;);</span>
<span class="fc" id="L319">    purgeMapper.deleteCeScannerContextOfCeActivityByRootUuidOrBefore(rootUuid, null, null);</span>
<span class="fc" id="L320">    session.commit();</span>
<span class="fc" id="L321">    profiler.stop();</span>
<span class="fc" id="L322">    profiler.start(&quot;deleteCeActivity (ce_task_characteristics)&quot;);</span>
<span class="fc" id="L323">    purgeMapper.deleteCeTaskCharacteristicsOfCeActivityByRootUuidOrBefore(rootUuid, null, null);</span>
<span class="fc" id="L324">    session.commit();</span>
<span class="fc" id="L325">    profiler.stop();</span>
<span class="fc" id="L326">    profiler.start(&quot;deleteCeActivity (ce_task_input)&quot;);</span>
<span class="fc" id="L327">    purgeMapper.deleteCeTaskInputOfCeActivityByRootUuidOrBefore(rootUuid, null, null);</span>
<span class="fc" id="L328">    session.commit();</span>
<span class="fc" id="L329">    profiler.stop();</span>
<span class="fc" id="L330">    profiler.start(&quot;deleteCeActivity (ce_task_message)&quot;);</span>
<span class="fc" id="L331">    purgeMapper.deleteCeTaskMessageOfCeActivityByRootUuidOrBefore(rootUuid, null, null);</span>
<span class="fc" id="L332">    session.commit();</span>
<span class="fc" id="L333">    profiler.stop();</span>
<span class="fc" id="L334">    profiler.start(&quot;deleteCeActivity (ce_activity)&quot;);</span>
<span class="fc" id="L335">    purgeMapper.deleteCeActivityByRootUuidOrBefore(rootUuid, null, null);</span>
<span class="fc" id="L336">    session.commit();</span>
<span class="fc" id="L337">    profiler.stop();</span>
<span class="fc" id="L338">  }</span>

  void deleteCeActivityBefore(@Nullable String rootUuid, @Nullable String entityUuidToPurge, long createdAt) {
<span class="fc" id="L341">    profiler.start(&quot;deleteCeActivityBefore (ce_scanner_context)&quot;);</span>
<span class="fc" id="L342">    purgeMapper.deleteCeScannerContextOfCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L343">    session.commit();</span>
<span class="fc" id="L344">    profiler.stop();</span>
<span class="fc" id="L345">    profiler.start(&quot;deleteCeActivityBefore (ce_task_characteristics)&quot;);</span>
<span class="fc" id="L346">    purgeMapper.deleteCeTaskCharacteristicsOfCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L347">    session.commit();</span>
<span class="fc" id="L348">    profiler.stop();</span>
<span class="fc" id="L349">    profiler.start(&quot;deleteCeActivityBefore (ce_task_input)&quot;);</span>
<span class="fc" id="L350">    purgeMapper.deleteCeTaskInputOfCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L351">    session.commit();</span>
<span class="fc" id="L352">    profiler.stop();</span>
<span class="fc" id="L353">    profiler.start(&quot;deleteCeActivityBefore (ce_task_message)&quot;);</span>
<span class="fc" id="L354">    purgeMapper.deleteCeTaskMessageOfCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L355">    session.commit();</span>
<span class="fc" id="L356">    profiler.stop();</span>
<span class="fc" id="L357">    profiler.start(&quot;deleteCeActivityBefore (ce_activity)&quot;);</span>
<span class="fc" id="L358">    purgeMapper.deleteCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L359">    session.commit();</span>
<span class="fc" id="L360">    profiler.stop();</span>
<span class="fc" id="L361">  }</span>

  void deleteCeScannerContextBefore(@Nullable String rootUuid, @Nullable String entityUuidToPurge, long createdAt) {
    // assuming CeScannerContext of rows in table CE_QUEUE can't be older than createdAt
<span class="fc" id="L365">    profiler.start(&quot;deleteCeScannerContextBefore&quot;);</span>
<span class="fc" id="L366">    purgeMapper.deleteCeScannerContextOfCeActivityByRootUuidOrBefore(rootUuid, entityUuidToPurge, createdAt);</span>
<span class="fc" id="L367">    session.commit();</span>
<span class="fc" id="L368">  }</span>

  void deleteCeQueue(String rootUuid) {
<span class="fc" id="L371">    profiler.start(&quot;deleteCeQueue (ce_scanner_context)&quot;);</span>
<span class="fc" id="L372">    purgeMapper.deleteCeScannerContextOfCeQueueByRootUuid(rootUuid);</span>
<span class="fc" id="L373">    session.commit();</span>
<span class="fc" id="L374">    profiler.stop();</span>
<span class="fc" id="L375">    profiler.start(&quot;deleteCeQueue (ce_task_characteristics)&quot;);</span>
<span class="fc" id="L376">    purgeMapper.deleteCeTaskCharacteristicsOfCeQueueByRootUuid(rootUuid);</span>
<span class="fc" id="L377">    session.commit();</span>
<span class="fc" id="L378">    profiler.stop();</span>
<span class="fc" id="L379">    profiler.start(&quot;deleteCeQueue (ce_task_input)&quot;);</span>
<span class="fc" id="L380">    purgeMapper.deleteCeTaskInputOfCeQueueByRootUuid(rootUuid);</span>
<span class="fc" id="L381">    session.commit();</span>
<span class="fc" id="L382">    profiler.stop();</span>
<span class="fc" id="L383">    profiler.start(&quot;deleteCeQueue (ce_task_message)&quot;);</span>
<span class="fc" id="L384">    purgeMapper.deleteCeTaskMessageOfCeQueueByRootUuid(rootUuid);</span>
<span class="fc" id="L385">    session.commit();</span>
<span class="fc" id="L386">    profiler.stop();</span>
<span class="fc" id="L387">    profiler.start(&quot;deleteCeQueue (ce_queue)&quot;);</span>
<span class="fc" id="L388">    purgeMapper.deleteCeQueueByRootUuid(rootUuid);</span>
<span class="fc" id="L389">    session.commit();</span>
<span class="fc" id="L390">    profiler.stop();</span>
<span class="fc" id="L391">  }</span>

  void deleteWebhooks(String rootUuid) {
<span class="fc" id="L394">    profiler.start(&quot;deleteWebhooks (webhooks)&quot;);</span>
<span class="fc" id="L395">    purgeMapper.deleteWebhooksByProjectUuid(rootUuid);</span>
<span class="fc" id="L396">    session.commit();</span>
<span class="fc" id="L397">    profiler.stop();</span>
<span class="fc" id="L398">  }</span>

  void deleteWebhookDeliveries(String rootUuid) {
<span class="fc" id="L401">    profiler.start(&quot;deleteWebhookDeliveries (webhook_deliveries)&quot;);</span>
<span class="fc" id="L402">    purgeMapper.deleteWebhookDeliveriesByProjectUuid(rootUuid);</span>
<span class="fc" id="L403">    session.commit();</span>
<span class="fc" id="L404">    profiler.stop();</span>
<span class="fc" id="L405">  }</span>

  void deleteApplicationProjectsByProject(String projectUuid) {
<span class="fc" id="L408">    profiler.start(&quot;deleteApplicationProjectsByProject (app_projects)&quot;);</span>
<span class="fc" id="L409">    purgeMapper.deleteAppBranchProjectBranchesByProjectUuid(projectUuid);</span>
<span class="fc" id="L410">    purgeMapper.deleteAppProjectsByProjectUuid(projectUuid);</span>
<span class="fc" id="L411">    session.commit();</span>
<span class="fc" id="L412">    profiler.stop();</span>
<span class="fc" id="L413">  }</span>

  void deleteApplicationProjects(String applicationUuid) {
<span class="fc" id="L416">    profiler.start(&quot;deleteApplicationProjects (app_projects)&quot;);</span>
<span class="fc" id="L417">    purgeMapper.deleteAppBranchProjectBranchesByAppUuid(applicationUuid);</span>
<span class="fc" id="L418">    purgeMapper.deleteAppProjectsByAppUuid(applicationUuid);</span>
<span class="fc" id="L419">    session.commit();</span>
<span class="fc" id="L420">    profiler.stop();</span>
<span class="fc" id="L421">  }</span>

  void deleteApplicationBranchProjects(String applicationBranchUuid) {
<span class="fc" id="L424">    profiler.start(&quot;deleteApplicationBranchProjects (app_branch_project_branch)&quot;);</span>
<span class="fc" id="L425">    purgeMapper.deleteAppBranchProjectsByAppBranchUuid(applicationBranchUuid);</span>
<span class="fc" id="L426">    session.commit();</span>
<span class="fc" id="L427">    profiler.stop();</span>
<span class="fc" id="L428">  }</span>

  public void deleteProjectAlmSettings(String rootUuid) {
<span class="fc" id="L431">    profiler.start(&quot;deleteProjectAlmSettings (project_alm_settings)&quot;);</span>
<span class="fc" id="L432">    purgeMapper.deleteProjectAlmSettingsByProjectUuid(rootUuid);</span>
<span class="fc" id="L433">    session.commit();</span>
<span class="fc" id="L434">    profiler.stop();</span>
<span class="fc" id="L435">  }</span>

  public void deleteProjectBadgeToken(String rootUuid) {
<span class="fc" id="L438">    profiler.start(&quot;deleteProjectBadgeToken (project_badge_token)&quot;);</span>
<span class="fc" id="L439">    purgeMapper.deleteProjectBadgeTokenByProjectUuid(rootUuid);</span>
<span class="fc" id="L440">    session.commit();</span>
<span class="fc" id="L441">    profiler.stop();</span>
<span class="fc" id="L442">  }</span>

  void deleteBranch(String rootUuid) {
<span class="fc" id="L445">    profiler.start(&quot;deleteBranch (project_branches)&quot;);</span>
<span class="fc" id="L446">    purgeMapper.deleteAppBranchProjectBranchesByProjectBranchUuid(rootUuid);</span>
<span class="fc" id="L447">    purgeMapper.deleteBranchByUuid(rootUuid);</span>
<span class="fc" id="L448">    session.commit();</span>
<span class="fc" id="L449">    profiler.stop();</span>
<span class="fc" id="L450">  }</span>

  void deleteMeasures(String rootUuid) {
<span class="fc" id="L453">    profiler.start(&quot;deleteMeasures (measures)&quot;);</span>
<span class="fc" id="L454">    purgeMapper.deleteMeasuresByBranchUuid(rootUuid);</span>
<span class="fc" id="L455">    session.commit();</span>
<span class="fc" id="L456">    profiler.stop();</span>
<span class="fc" id="L457">  }</span>

  void deleteNewCodePeriodsForProject(String projectUuid) {
<span class="fc" id="L460">    profiler.start(&quot;deleteNewCodePeriods (new_code_periods)&quot;);</span>
<span class="fc" id="L461">    purgeMapper.deleteNewCodePeriodsByProjectUuid(projectUuid);</span>
<span class="fc" id="L462">    session.commit();</span>
<span class="fc" id="L463">    profiler.stop();</span>
<span class="fc" id="L464">  }</span>

  void deleteNewCodePeriodsForBranch(String branchUuid) {
<span class="fc" id="L467">    profiler.start(&quot;deleteNewCodePeriods (new_code_periods)&quot;);</span>
<span class="fc" id="L468">    purgeMapper.deleteNewCodePeriodsByBranchUuid(branchUuid);</span>
<span class="fc" id="L469">    session.commit();</span>
<span class="fc" id="L470">    profiler.stop();</span>
<span class="fc" id="L471">  }</span>

  void deleteUserDismissedMessages(String projectUuid) {
<span class="fc" id="L474">    profiler.start(&quot;deleteUserDismissedMessages (user_dismissed_messages)&quot;);</span>
<span class="fc" id="L475">    purgeMapper.deleteUserDismissedMessagesByProjectUuid(projectUuid);</span>
<span class="fc" id="L476">    session.commit();</span>
<span class="fc" id="L477">    profiler.stop();</span>
<span class="fc" id="L478">  }</span>

  public void deleteProjectInPortfolios(String rootUuid) {
<span class="fc" id="L481">    profiler.start(&quot;deleteProjectInPortfolios (portfolio_projects)&quot;);</span>
    // delete selected project if it's only selecting a single branch corresponding to rootUuid
<span class="fc" id="L483">    purgeMapper.deletePortfolioProjectsByBranchUuid(rootUuid);</span>
    // delete selected branches if branch is rootUuid or if it's part of a project that is rootUuid
<span class="fc" id="L485">    purgeMapper.deletePortfolioProjectBranchesByBranchUuid(rootUuid);</span>
    // delete selected project if project is rootUuid
<span class="fc" id="L487">    purgeMapper.deletePortfolioProjectsByProjectUuid(rootUuid);</span>
<span class="fc" id="L488">    session.commit();</span>
<span class="fc" id="L489">    profiler.stop();</span>
<span class="fc" id="L490">  }</span>

  public void deleteScannerCache(String branchUuid) {
<span class="fc" id="L493">    profiler.start(&quot;deleteScannerCache (scanner_analysis_cache)&quot;);</span>
<span class="fc" id="L494">    purgeMapper.deleteScannerAnalysisCacheByBranchUuid(branchUuid);</span>
<span class="fc" id="L495">    session.commit();</span>
<span class="fc" id="L496">    profiler.stop();</span>
<span class="fc" id="L497">  }</span>

  public void deleteReportSchedules(String rootUuid) {
<span class="fc" id="L500">    profiler.start(&quot;deleteReportSchedules (report_schedules)&quot;);</span>
<span class="fc" id="L501">    purgeMapper.deleteReportSchedulesByBranchUuid(rootUuid);</span>
<span class="fc" id="L502">    session.commit();</span>
<span class="fc" id="L503">    profiler.stop();</span>
<span class="fc" id="L504">  }</span>

  public void deleteReportSubscriptions(String branchUuid) {
<span class="fc" id="L507">    profiler.start(&quot;deleteReportSubscriptions (report_subscriptions)&quot;);</span>
<span class="fc" id="L508">    purgeMapper.deleteReportSubscriptionsByBranchUuid(branchUuid);</span>
<span class="fc" id="L509">    session.commit();</span>
<span class="fc" id="L510">    profiler.stop();</span>
<span class="fc" id="L511">  }</span>

  public void deleteArchitectureGraphs(String branchUuid) {
<span class="fc" id="L514">    profiler.start(&quot;deleteArchitectureGraphs (architecture_graphs)&quot;);</span>
<span class="fc" id="L515">    purgeMapper.deleteArchitectureGraphsByBranchUuid(branchUuid);</span>
<span class="fc" id="L516">    session.commit();</span>
<span class="fc" id="L517">    profiler.stop();</span>
<span class="fc" id="L518">  }</span>

  public void deleteAnticipatedTransitions(String projectUuid, long createdAt) {
<span class="fc" id="L521">    profiler.start(&quot;deleteAnticipatedTransitions (anticipated_transitions)&quot;);</span>
<span class="fc" id="L522">    purgeMapper.deleteAnticipatedTransitionsByProjectUuidAndCreationDate(projectUuid, createdAt);</span>
<span class="fc" id="L523">    session.commit();</span>
<span class="fc" id="L524">    profiler.stop();</span>
<span class="fc" id="L525">  }</span>

  public void deleteIssuesFixed(String branchUuid) {
<span class="fc" id="L528">    profiler.start(&quot;deleteIssuesFixed (issues_fixed)&quot;);</span>
<span class="fc" id="L529">    purgeMapper.deleteIssuesFixedByBranchUuid(branchUuid);</span>
<span class="fc" id="L530">    session.commit();</span>
<span class="fc" id="L531">    profiler.stop();</span>
<span class="fc" id="L532">  }</span>

  public void deleteScaActivity(String componentUuid) {
    // delete sca_analyses first since it sort of marks the analysis as valid/existing
<span class="fc" id="L536">    profiler.start(&quot;deleteScaAnalyses (sca_analyses)&quot;);</span>
<span class="fc" id="L537">    purgeMapper.deleteScaAnalysesByComponentUuid(componentUuid);</span>
<span class="fc" id="L538">    session.commit();</span>
<span class="fc" id="L539">    profiler.stop();</span>

<span class="fc" id="L541">    profiler.start(&quot;deleteScaDependencies (sca_dependencies)&quot;);</span>
<span class="fc" id="L542">    purgeMapper.deleteScaDependenciesByComponentUuid(componentUuid);</span>
<span class="fc" id="L543">    session.commit();</span>
<span class="fc" id="L544">    profiler.stop();</span>

    // this must be done before deleting sca_issues_releases or we won't
    // be able to find the rows
<span class="fc" id="L548">    profiler.start(&quot;deleteScaIssuesReleasesChanges (sca_issue_rels_changes)&quot;);</span>
<span class="fc" id="L549">    purgeMapper.deleteScaIssuesReleasesChangesByComponentUuid(componentUuid);</span>
<span class="fc" id="L550">    session.commit();</span>
<span class="fc" id="L551">    profiler.stop();</span>

<span class="fc" id="L553">    profiler.start(&quot;deleteScaIssuesReleases (sca_issues_releases)&quot;);</span>
<span class="fc" id="L554">    purgeMapper.deleteScaIssuesReleasesByComponentUuid(componentUuid);</span>
<span class="fc" id="L555">    session.commit();</span>
<span class="fc" id="L556">    profiler.stop();</span>

    // sca_releases MUST be deleted last because dependencies and
    // issues_releases only join to the component through sca_releases
<span class="fc" id="L560">    profiler.start(&quot;deleteScaReleases (sca_releases)&quot;);</span>
<span class="fc" id="L561">    purgeMapper.deleteScaReleasesByComponentUuid(componentUuid);</span>
<span class="fc" id="L562">    session.commit();</span>
<span class="fc" id="L563">    profiler.stop();</span>
<span class="fc" id="L564">  }</span>

  public void deleteScaLicenseProfiles(String projectUuid) {
<span class="fc" id="L567">    profiler.start(&quot;deleteScaLicenseProfileProjects (sca_lic_prof_projects)&quot;);</span>
<span class="fc" id="L568">    purgeMapper.deleteScaLicenseProfileProjectsByProjectUuid(projectUuid);</span>
<span class="fc" id="L569">    profiler.stop();</span>
<span class="fc" id="L570">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>