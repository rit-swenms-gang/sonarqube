<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitlabApplicationClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.alm.client.gitlab</a> &gt; <span class="el_source">GitlabApplicationClient.java</span></div><h1>GitlabApplicationClient.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.alm.client.gitlab;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonParseException;
import com.google.gson.JsonSyntaxException;
import com.google.gson.reflect.TypeToken;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import javax.annotation.Nullable;
import okhttp3.Headers;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.RequestBody;
import okhttp3.Response;
import org.apache.logging.log4j.util.Strings;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.sonar.alm.client.TimeoutConfiguration;
import org.sonar.api.server.ServerSide;
import org.sonar.auth.gitlab.GsonGroup;
import org.sonar.auth.gitlab.GsonProjectMember;
import org.sonar.auth.gitlab.GsonUser;
import org.sonarqube.ws.MediaTypes;
import org.sonarqube.ws.client.OkHttpClientBuilder;

import static java.lang.String.format;
import static java.net.HttpURLConnection.HTTP_FORBIDDEN;
import static java.net.HttpURLConnection.HTTP_UNAUTHORIZED;
import static java.nio.charset.StandardCharsets.UTF_8;

@ServerSide
public class GitlabApplicationClient {
<span class="fc" id="L59">  private static final Logger LOG = LoggerFactory.getLogger(GitlabApplicationClient.class);</span>
<span class="fc" id="L60">  private static final Gson GSON = new Gson();</span>
<span class="fc" id="L61">  private static final TypeToken&lt;List&lt;GsonGroup&gt;&gt; GITLAB_GROUP = new TypeToken&lt;&gt;() {</span>
  };
<span class="fc" id="L63">  private static final TypeToken&lt;List&lt;GsonUser&gt;&gt; GITLAB_USER = new TypeToken&lt;&gt;() {</span>
  };
<span class="fc" id="L65">  private static final TypeToken&lt;List&lt;GsonProjectMember&gt;&gt; GITLAB_PROJECT_MEMBER = new TypeToken&lt;&gt;() {</span>
  };

  protected static final String PRIVATE_TOKEN = &quot;Private-Token&quot;;
  private static final String GITLAB_GROUPS_MEMBERS_ENDPOINT = &quot;/groups/%s/members&quot;;
  protected final OkHttpClient client;

  private final GitlabPaginatedHttpClient gitlabPaginatedHttpClient;

<span class="fc" id="L74">  public GitlabApplicationClient(GitlabPaginatedHttpClient gitlabPaginatedHttpClient, TimeoutConfiguration timeoutConfiguration) {</span>
<span class="fc" id="L75">    this.gitlabPaginatedHttpClient = gitlabPaginatedHttpClient;</span>
<span class="fc" id="L76">    client = new OkHttpClientBuilder()</span>
<span class="fc" id="L77">      .setConnectTimeoutMs(timeoutConfiguration.getConnectTimeout())</span>
<span class="fc" id="L78">      .setReadTimeoutMs(timeoutConfiguration.getReadTimeout())</span>
<span class="fc" id="L79">      .setFollowRedirects(false)</span>
<span class="fc" id="L80">      .build();</span>
<span class="fc" id="L81">  }</span>

  public void checkReadPermission(@Nullable String gitlabUrl, @Nullable String personalAccessToken) {
<span class="nc" id="L84">    checkProjectAccess(gitlabUrl, personalAccessToken, &quot;Could not validate GitLab read permission. Got an unexpected answer.&quot;);</span>
<span class="nc" id="L85">  }</span>

  public void checkUrl(@Nullable String gitlabUrl) {
<span class="nc" id="L88">    checkProjectAccess(gitlabUrl, null, &quot;Could not validate GitLab url. Got an unexpected answer.&quot;);</span>
<span class="nc" id="L89">  }</span>

  private void checkProjectAccess(@Nullable String gitlabUrl, @Nullable String personalAccessToken, String errorMessage) {
<span class="fc" id="L92">    String url = format(&quot;%s/projects&quot;, gitlabUrl);</span>

<span class="fc" id="L94">    LOG.debug(&quot;get projects : [{}]&quot;, url);</span>
<span class="fc" id="L95">    Request.Builder builder = new Request.Builder()</span>
<span class="fc" id="L96">      .url(url)</span>
<span class="fc" id="L97">      .get();</span>

<span class="pc bpc" id="L99" title="1 of 2 branches missed.">    if (personalAccessToken != null) {</span>
<span class="fc" id="L100">      builder.addHeader(PRIVATE_TOKEN, personalAccessToken);</span>
    }

<span class="fc" id="L103">    Request request = builder.build();</span>

<span class="nc" id="L105">    try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L106">      checkResponseIsSuccessful(response, errorMessage);</span>
<span class="nc" id="L107">      Project.parseJsonArray(response.body().string());</span>
<span class="nc" id="L108">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L109">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to verify read permission. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L110">    } catch (IOException e) {</span>
<span class="fc" id="L111">      logException(url, e);</span>
<span class="fc" id="L112">      throw new IllegalArgumentException(errorMessage);</span>
<span class="nc" id="L113">    }</span>
<span class="nc" id="L114">  }</span>

  private static void logException(String url, IOException e) {
<span class="fc" id="L117">    String errorMessage = format(&quot;Gitlab API call to [%s] failed with error message : [%s]&quot;, url, e.getMessage());</span>
<span class="fc" id="L118">    LOG.info(errorMessage, e);</span>
<span class="fc" id="L119">  }</span>

  public void checkToken(String gitlabUrl, String personalAccessToken) {
<span class="fc" id="L122">    String url = format(&quot;%s/user&quot;, gitlabUrl);</span>

<span class="fc" id="L124">    LOG.debug(&quot;get current user : [{}]&quot;, url);</span>
<span class="fc" id="L125">    Request.Builder builder = new Request.Builder()</span>
<span class="fc" id="L126">      .addHeader(PRIVATE_TOKEN, personalAccessToken)</span>
<span class="fc" id="L127">      .url(url)</span>
<span class="fc" id="L128">      .get();</span>

<span class="fc" id="L130">    Request request = builder.build();</span>

<span class="fc" id="L132">    String errorMessage = &quot;Could not validate GitLab token. Got an unexpected answer.&quot;;</span>
<span class="nc" id="L133">    try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L134">      checkResponseIsSuccessful(response, errorMessage);</span>
<span class="nc" id="L135">      GsonId.parseOne(response.body().string());</span>
<span class="nc" id="L136">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L137">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to verify token. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L138">    } catch (IOException e) {</span>
<span class="fc" id="L139">      logException(url, e);</span>
<span class="fc" id="L140">      throw new IllegalArgumentException(errorMessage);</span>
<span class="nc" id="L141">    }</span>
<span class="nc" id="L142">  }</span>

  public void checkWritePermission(String gitlabUrl, String personalAccessToken) {
<span class="fc" id="L145">    String url = format(&quot;%s/markdown&quot;, gitlabUrl);</span>

<span class="fc" id="L147">    LOG.debug(&quot;verify write permission by formating some markdown : [{}]&quot;, url);</span>
<span class="fc" id="L148">    Request.Builder builder = new Request.Builder()</span>
<span class="fc" id="L149">      .url(url)</span>
<span class="fc" id="L150">      .addHeader(PRIVATE_TOKEN, personalAccessToken)</span>
<span class="fc" id="L151">      .addHeader(&quot;Content-Type&quot;, MediaTypes.JSON)</span>
<span class="fc" id="L152">      .post(RequestBody.create(&quot;{\&quot;text\&quot;:\&quot;validating write permission\&quot;}&quot;.getBytes(UTF_8)));</span>

<span class="fc" id="L154">    Request request = builder.build();</span>

<span class="fc" id="L156">    String errorMessage = &quot;Could not validate GitLab write permission. Got an unexpected answer.&quot;;</span>
<span class="nc" id="L157">    try (Response response = client.newCall(request).execute()) {</span>
<span class="nc" id="L158">      checkResponseIsSuccessful(response, errorMessage);</span>
<span class="nc" id="L159">      GsonMarkdown.parseOne(response.body().string());</span>
<span class="nc" id="L160">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L161">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to verify write permission. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L162">    } catch (IOException e) {</span>
<span class="fc" id="L163">      logException(url, e);</span>
<span class="fc" id="L164">      throw new IllegalArgumentException(errorMessage);</span>
<span class="nc" id="L165">    }</span>

<span class="nc" id="L167">  }</span>

  private static String urlEncode(String value) {
    try {
<span class="fc" id="L171">      return URLEncoder.encode(value, UTF_8.toString());</span>
<span class="nc" id="L172">    } catch (UnsupportedEncodingException ex) {</span>
<span class="nc" id="L173">      throw new IllegalStateException(ex.getCause());</span>
    }
  }

  protected static void checkResponseIsSuccessful(Response response) throws IOException {
<span class="fc" id="L178">    checkResponseIsSuccessful(response, &quot;GitLab Merge Request did not happen, please check your configuration&quot;);</span>
<span class="fc" id="L179">  }</span>

  protected static void checkResponseIsSuccessful(Response response, String errorMessage) throws IOException {
<span class="fc bfc" id="L182" title="All 2 branches covered.">    if (!response.isSuccessful()) {</span>
<span class="fc" id="L183">      String body = response.body().string();</span>
<span class="fc" id="L184">      LOG.error(&quot;Gitlab API call to [{}] failed with {} http code. gitlab response content : [{}]&quot;, response.request().url(), response.code(), body);</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">      if (isTokenRevoked(response, body)) {</span>
<span class="fc" id="L186">        throw new GitlabServerException(response.code(), &quot;Your GitLab token was revoked&quot;);</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">      } else if (isTokenExpired(response, body)) {</span>
<span class="nc" id="L188">        throw new GitlabServerException(response.code(), &quot;Your GitLab token is expired&quot;);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">      } else if (isInsufficientScope(response, body)) {</span>
<span class="fc" id="L190">        throw new GitlabServerException(response.code(), &quot;Your GitLab token has insufficient scope&quot;);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">      } else if (response.code() == HTTP_UNAUTHORIZED) {</span>
<span class="fc" id="L192">        throw new GitlabServerException(response.code(), &quot;Invalid personal access token&quot;);</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">      } else if (response.isRedirect()) {</span>
<span class="fc" id="L194">        throw new GitlabServerException(response.code(), &quot;Request was redirected, please provide the correct URL&quot;);</span>
      } else {
<span class="fc" id="L196">        throw new GitlabServerException(response.code(), errorMessage);</span>
      }
    }
<span class="fc" id="L199">  }</span>

  private static boolean isTokenRevoked(Response response, String body) {
<span class="fc bfc" id="L202" title="All 2 branches covered.">    if (response.code() == HTTP_UNAUTHORIZED) {</span>
      try {
<span class="fc" id="L204">        Optional&lt;GsonError&gt; gitlabError = GsonError.parseOne(body);</span>
<span class="fc" id="L205">        return gitlabError.map(GsonError::getErrorDescription).map(description -&gt; description.contains(&quot;Token was revoked&quot;)).orElse(false);</span>
<span class="fc" id="L206">      } catch (JsonParseException e) {</span>
        // nothing to do
      }
    }
<span class="fc" id="L210">    return false;</span>
  }

  private static boolean isTokenExpired(Response response, String body) {
<span class="fc bfc" id="L214" title="All 2 branches covered.">    if (response.code() == HTTP_UNAUTHORIZED) {</span>
      try {
<span class="nc" id="L216">        Optional&lt;GsonError&gt; gitlabError = GsonError.parseOne(body);</span>
<span class="nc" id="L217">        return gitlabError.map(GsonError::getErrorDescription).map(description -&gt; description.contains(&quot;Token is expired&quot;)).orElse(false);</span>
<span class="fc" id="L218">      } catch (JsonParseException e) {</span>
        // nothing to do
      }
    }
<span class="fc" id="L222">    return false;</span>
  }

  private static boolean isInsufficientScope(Response response, String body) {
<span class="fc bfc" id="L226" title="All 2 branches covered.">    if (response.code() == HTTP_FORBIDDEN) {</span>
      try {
<span class="fc" id="L228">        Optional&lt;GsonError&gt; gitlabError = GsonError.parseOne(body);</span>
<span class="fc" id="L229">        return gitlabError.map(GsonError::getError).map(&quot;insufficient_scope&quot;::equals).orElse(false);</span>
<span class="nc" id="L230">      } catch (JsonParseException e) {</span>
        // nothing to do
      }
    }
<span class="fc" id="L234">    return false;</span>
  }

  public Project getProject(String gitlabUrl, String pat, Long gitlabProjectId) {
<span class="fc" id="L238">    String url = format(&quot;%s/projects/%s&quot;, gitlabUrl, gitlabProjectId);</span>
<span class="fc" id="L239">    LOG.debug(&quot;get project : [{}]&quot;, url);</span>
<span class="fc" id="L240">    Request request = new Request.Builder()</span>
<span class="fc" id="L241">      .addHeader(PRIVATE_TOKEN, pat)</span>
<span class="fc" id="L242">      .get()</span>
<span class="fc" id="L243">      .url(url)</span>
<span class="fc" id="L244">      .build();</span>

<span class="fc" id="L246">    try (Response response = client.newCall(request).execute()) {</span>
<span class="fc" id="L247">      checkResponseIsSuccessful(response);</span>
<span class="fc" id="L248">      String body = response.body().string();</span>
<span class="fc" id="L249">      LOG.trace(&quot;loading project payload result : [{}]&quot;, body);</span>
<span class="fc" id="L250">      return new GsonBuilder().create().fromJson(body, Project.class);</span>
<span class="fc" id="L251">    } catch (JsonSyntaxException e) {</span>
<span class="fc" id="L252">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to retrieve a project. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L253">    } catch (IOException e) {</span>
<span class="fc" id="L254">      logException(url, e);</span>
<span class="fc" id="L255">      throw new IllegalStateException(e.getMessage(), e);</span>
    }
  }

  //
  // This method is used to check if a user has REPORTER level access to the project, which is a requirement for PR decoration.
  // As of June 9, 2021 there is no better way to do this check and still support GitLab 11.7.
  //
  public Optional&lt;Project&gt; getReporterLevelAccessProject(String gitlabUrl, String pat, Long gitlabProjectId) {
<span class="fc" id="L264">    String url = format(&quot;%s/projects?min_access_level=20&amp;id_after=%s&amp;id_before=%s&quot;, gitlabUrl, gitlabProjectId - 1,</span>
<span class="fc" id="L265">      gitlabProjectId + 1);</span>
<span class="fc" id="L266">    LOG.debug(&quot;get project : [{}]&quot;, url);</span>
<span class="fc" id="L267">    Request request = new Request.Builder()</span>
<span class="fc" id="L268">      .addHeader(PRIVATE_TOKEN, pat)</span>
<span class="fc" id="L269">      .get()</span>
<span class="fc" id="L270">      .url(url)</span>
<span class="fc" id="L271">      .build();</span>

<span class="fc" id="L273">    try (Response response = client.newCall(request).execute()) {</span>
<span class="fc" id="L274">      checkResponseIsSuccessful(response);</span>
<span class="fc" id="L275">      String body = response.body().string();</span>
<span class="fc" id="L276">      LOG.trace(&quot;loading project payload result : [{}]&quot;, body);</span>

<span class="fc" id="L278">      List&lt;Project&gt; projects = Project.parseJsonArray(body);</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">      if (projects.isEmpty()) {</span>
<span class="nc" id="L280">        return Optional.empty();</span>
      } else {
<span class="fc" id="L282">        return Optional.of(projects.get(0));</span>
      }
<span class="nc bnc" id="L284" title="All 2 branches missed.">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L285">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to retrieve a project. Got a non-json payload as result.&quot;);</span>
<span class="nc" id="L286">    } catch (IOException e) {</span>
<span class="nc" id="L287">      logException(url, e);</span>
<span class="nc" id="L288">      throw new IllegalStateException(e.getMessage(), e);</span>
    }
  }

  public List&lt;GitLabBranch&gt; getBranches(String gitlabUrl, String pat, Long gitlabProjectId) {
<span class="fc" id="L293">    String url = format(&quot;%s/projects/%s/repository/branches&quot;, gitlabUrl, gitlabProjectId);</span>
<span class="fc" id="L294">    LOG.debug(&quot;get branches : [{}]&quot;, url);</span>
<span class="fc" id="L295">    Request request = new Request.Builder()</span>
<span class="fc" id="L296">      .addHeader(PRIVATE_TOKEN, pat)</span>
<span class="fc" id="L297">      .get()</span>
<span class="fc" id="L298">      .url(url)</span>
<span class="fc" id="L299">      .build();</span>

<span class="fc" id="L301">    try (Response response = client.newCall(request).execute()) {</span>
<span class="fc" id="L302">      checkResponseIsSuccessful(response);</span>
<span class="fc" id="L303">      String body = response.body().string();</span>
<span class="fc" id="L304">      LOG.trace(&quot;loading branches payload result : [{}]&quot;, body);</span>
<span class="fc" id="L305">      return Arrays.asList(new GsonBuilder().create().fromJson(body, GitLabBranch[].class));</span>
<span class="fc" id="L306">    } catch (JsonSyntaxException e) {</span>
<span class="fc" id="L307">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to retrieve project branches. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L308">    } catch (IOException e) {</span>
<span class="fc" id="L309">      logException(url, e);</span>
<span class="fc" id="L310">      throw new IllegalStateException(e.getMessage(), e);</span>
    }
  }

  public ProjectList searchProjects(String gitlabUrl, String personalAccessToken, @Nullable String projectName,
    @Nullable Integer pageNumber, @Nullable Integer pageSize) {
<span class="fc" id="L316">    String url = format(&quot;%s/projects?archived=false&amp;simple=true&amp;membership=true&amp;order_by=name&amp;sort=asc&amp;search=%s%s%s&quot;,</span>
      gitlabUrl,
<span class="fc bfc" id="L318" title="All 2 branches covered.">      projectName == null ? &quot;&quot; : urlEncode(projectName),</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">      pageNumber == null ? &quot;&quot; : format(&quot;&amp;page=%d&quot;, pageNumber),</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">      pageSize == null ? &quot;&quot; : format(&quot;&amp;per_page=%d&quot;, pageSize)</span>
    );

<span class="fc" id="L323">    LOG.debug(&quot;get projects : [{}]&quot;, url);</span>
<span class="fc" id="L324">    Request request = new Request.Builder()</span>
<span class="fc" id="L325">      .addHeader(PRIVATE_TOKEN, personalAccessToken)</span>
<span class="fc" id="L326">      .url(url)</span>
<span class="fc" id="L327">      .get()</span>
<span class="fc" id="L328">      .build();</span>

<span class="fc" id="L330">    try (Response response = client.newCall(request).execute()) {</span>
<span class="fc" id="L331">      Headers headers = response.headers();</span>
<span class="fc" id="L332">      checkResponseIsSuccessful(response, &quot;Could not get projects from GitLab instance&quot;);</span>
<span class="fc" id="L333">      List&lt;Project&gt; projectList = Project.parseJsonArray(response.body().string());</span>
<span class="fc" id="L334">      int returnedPageNumber = parseAndGetIntegerHeader(headers.get(&quot;X-Page&quot;));</span>
<span class="fc" id="L335">      int returnedPageSize = parseAndGetIntegerHeader(headers.get(&quot;X-Per-Page&quot;));</span>
<span class="fc" id="L336">      String xtotal = headers.get(&quot;X-Total&quot;);</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">      Integer totalProjects = Strings.isEmpty(xtotal) ? null : parseAndGetIntegerHeader(xtotal);</span>
<span class="fc" id="L338">      return new ProjectList(projectList, returnedPageNumber, returnedPageSize, totalProjects);</span>
<span class="nc" id="L339">    } catch (JsonSyntaxException e) {</span>
<span class="nc" id="L340">      throw new IllegalArgumentException(&quot;Could not parse GitLab answer to search projects. Got a non-json payload as result.&quot;);</span>
<span class="fc" id="L341">    } catch (IOException e) {</span>
<span class="fc" id="L342">      logException(url, e);</span>
<span class="fc" id="L343">      throw new IllegalStateException(e.getMessage(), e);</span>
    }
  }

  private static int parseAndGetIntegerHeader(@Nullable String header) {
<span class="fc bfc" id="L348" title="All 2 branches covered.">    if (header == null) {</span>
<span class="fc" id="L349">      throw new IllegalArgumentException(&quot;Pagination data from GitLab response is missing&quot;);</span>
    } else {
      try {
<span class="fc" id="L352">        return Integer.parseInt(header);</span>
<span class="fc" id="L353">      } catch (NumberFormatException e) {</span>
<span class="fc" id="L354">        throw new IllegalArgumentException(&quot;Could not parse pagination number&quot;, e);</span>
      }
    }
  }

  public Set&lt;GsonGroup&gt; getGroups(String gitlabUrl, String token) {
<span class="fc" id="L360">    return Set.copyOf(executePaginatedQuery(gitlabUrl, token, &quot;/groups&quot;, resp -&gt; GSON.fromJson(resp, GITLAB_GROUP)));</span>
  }

  public Set&lt;GsonUser&gt; getDirectGroupMembers(String gitlabUrl, String token, String groupId) {
<span class="fc" id="L364">    return getMembers(gitlabUrl, token, format(GITLAB_GROUPS_MEMBERS_ENDPOINT, groupId));</span>
  }

  public Set&lt;GsonUser&gt; getAllGroupMembers(String gitlabUrl, String token, String groupId) {
<span class="fc" id="L368">    return getMembers(gitlabUrl, token, format(GITLAB_GROUPS_MEMBERS_ENDPOINT + &quot;/all&quot;, groupId));</span>
  }

  private Set&lt;GsonUser&gt; getMembers(String gitlabUrl, String token, String endpoint) {
<span class="fc" id="L372">    return Set.copyOf(executePaginatedQuery(gitlabUrl, token, endpoint, resp -&gt; GSON.fromJson(resp, GITLAB_USER)));</span>
  }

  public Set&lt;GsonProjectMember&gt; getAllProjectMembers(String gitlabUrl, String token, long projectId) {
<span class="fc" id="L376">    String url = format(&quot;/projects/%s/members/all&quot;, projectId);</span>
<span class="fc" id="L377">    return Set.copyOf(executePaginatedQuery(gitlabUrl, token, url, resp -&gt; GSON.fromJson(resp, GITLAB_PROJECT_MEMBER)));</span>
  }

  private &lt;E&gt; List&lt;E&gt; executePaginatedQuery(String appUrl, String token, String query, Function&lt;String, List&lt;E&gt;&gt; responseDeserializer) {
<span class="fc" id="L381">    GitlabToken gitlabToken = new GitlabToken(token);</span>
<span class="fc" id="L382">    return gitlabPaginatedHttpClient.get(appUrl, gitlabToken, query, responseDeserializer);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>