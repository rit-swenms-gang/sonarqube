<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleQueryFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">RuleQueryFactory.java</span></div><h1>RuleQueryFactory.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import java.util.Date;
import java.util.List;
import org.sonar.api.rule.RuleStatus;
import org.sonar.core.rule.RuleType;
import org.sonar.api.server.ServerSide;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.WebService;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.qualityprofile.QProfileDto;
import org.sonar.server.rule.index.RuleQuery;

import static org.sonar.server.exceptions.NotFoundException.checkFound;
import static org.sonar.server.rule.ws.EnumUtils.toEnums;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVATION;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_AVAILABLE_SINCE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_COMPARE_TO_PROFILE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CWE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SOFTWARE_QUALITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_INCLUDE_EXTERNAL;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_INHERITANCE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IS_TEMPLATE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_LANGUAGES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_MOBILE_TOP_10_2024;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10_2021;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_PRIORITIZED_RULE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_QPROFILE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_REPOSITORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_RULE_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SANS_TOP_25;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SONARSOURCE_SECURITY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_STATUSES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TAGS;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TEMPLATE_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TYPES;

@ServerSide
public class RuleQueryFactory {
  private final DbClient dbClient;

<span class="fc" id="L68">  public RuleQueryFactory(DbClient dbClient) {</span>
<span class="fc" id="L69">    this.dbClient = dbClient;</span>
<span class="fc" id="L70">  }</span>

  /**
   * Similar to {@link #createRuleQuery(DbSession, Request)} but sets additional fields which are only used
   * for the rule search WS. 
   */
  public RuleQuery createRuleSearchQuery(DbSession dbSession, Request request) {
<span class="fc" id="L77">    RuleQuery query = createRuleQuery(dbSession, request);</span>
<span class="fc" id="L78">    query.setIncludeExternal(request.mandatoryParamAsBoolean(PARAM_INCLUDE_EXTERNAL));</span>
<span class="fc" id="L79">    query.setPrioritizedRule(request.paramAsBoolean(PARAM_PRIORITIZED_RULE));</span>
<span class="fc" id="L80">    return query;</span>
  }

  /**
   * Create a {@link RuleQuery} from a {@link Request}.
   * When a profile key is set, the language of the profile is automatically set in the query
   */
  public RuleQuery createRuleQuery(DbSession dbSession, Request request) {
<span class="fc" id="L88">    RuleQuery query = new RuleQuery();</span>
<span class="fc" id="L89">    query.setQueryText(request.param(WebService.Param.TEXT_QUERY));</span>
<span class="fc" id="L90">    query.setSeverities(request.paramAsStrings(PARAM_SEVERITIES));</span>
<span class="fc" id="L91">    query.setRepositories(request.paramAsStrings(PARAM_REPOSITORIES));</span>
<span class="fc" id="L92">    Date availableSince = request.paramAsDate(PARAM_AVAILABLE_SINCE);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">    query.setAvailableSince(availableSince != null ? availableSince.getTime() : null);</span>
<span class="fc" id="L94">    query.setStatuses(toEnums(request.paramAsStrings(PARAM_STATUSES), RuleStatus.class));</span>

    // Order is important : 1. Load profile, 2. Load compare to profile
<span class="fc" id="L97">    setProfile(dbSession, query, request);</span>
<span class="fc" id="L98">    setCompareToProfile(dbSession, query, request);</span>
<span class="fc" id="L99">    QProfileDto profile = query.getQProfile();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">    query.setLanguages(profile == null ? request.paramAsStrings(PARAM_LANGUAGES) : List.of(profile.getLanguage()));</span>
<span class="fc" id="L101">    query.setActivation(request.paramAsBoolean(PARAM_ACTIVATION));</span>
<span class="fc" id="L102">    query.setTags(request.paramAsStrings(PARAM_TAGS));</span>
<span class="fc" id="L103">    query.setInheritance(request.paramAsStrings(PARAM_INHERITANCE));</span>
<span class="fc" id="L104">    query.setActiveSeverities(request.paramAsStrings(PARAM_ACTIVE_SEVERITIES));</span>
<span class="fc" id="L105">    query.setIsTemplate(request.paramAsBoolean(PARAM_IS_TEMPLATE));</span>
<span class="fc" id="L106">    query.setTemplateKey(request.param(PARAM_TEMPLATE_KEY));</span>
<span class="fc" id="L107">    query.setTypes(toEnums(request.paramAsStrings(PARAM_TYPES), RuleType.class));</span>
<span class="fc" id="L108">    query.setKey(request.param(PARAM_RULE_KEY));</span>
<span class="fc" id="L109">    query.setCwe(request.paramAsStrings(PARAM_CWE));</span>
<span class="fc" id="L110">    query.setOwaspTop10(request.paramAsStrings(PARAM_OWASP_TOP_10));</span>
<span class="fc" id="L111">    query.setOwaspTop10For2021(request.paramAsStrings(PARAM_OWASP_TOP_10_2021));</span>
<span class="fc" id="L112">    query.setOwaspMobileTop10For2024(request.paramAsStrings(PARAM_OWASP_MOBILE_TOP_10_2024));</span>
<span class="fc" id="L113">    query.setSansTop25(request.paramAsStrings(PARAM_SANS_TOP_25));</span>
<span class="fc" id="L114">    query.setSonarsourceSecurity(request.paramAsStrings(PARAM_SONARSOURCE_SECURITY));</span>
<span class="fc" id="L115">    query.setCleanCodeAttributesCategories(request.paramAsStrings(PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES));</span>
<span class="fc" id="L116">    query.setImpactSeverities(request.paramAsStrings(PARAM_IMPACT_SEVERITIES));</span>
<span class="fc" id="L117">    query.setImpactSoftwareQualities(request.paramAsStrings(PARAM_IMPACT_SOFTWARE_QUALITIES));</span>
<span class="fc" id="L118">    query.setActiveImpactSeverities(request.paramAsStrings(PARAM_ACTIVE_IMPACT_SEVERITIES));</span>

<span class="fc" id="L120">    String sortParam = request.param(WebService.Param.SORT);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">    if (sortParam != null) {</span>
<span class="fc" id="L122">      query.setSortField(sortParam);</span>
<span class="fc" id="L123">      query.setAscendingSort(request.mandatoryParamAsBoolean(WebService.Param.ASCENDING));</span>
    }
<span class="fc" id="L125">    return query;</span>
  }

  private void setProfile(DbSession dbSession, RuleQuery query, Request request) {
<span class="fc" id="L129">    String profileUuid = request.param(PARAM_QPROFILE);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">    if (profileUuid == null) {</span>
<span class="fc" id="L131">      return;</span>
    }
<span class="fc" id="L133">    QProfileDto profileOptional = dbClient.qualityProfileDao().selectByUuid(dbSession, profileUuid);</span>
<span class="fc" id="L134">    QProfileDto profile = checkFound(profileOptional, &quot;The specified qualityProfile '%s' does not exist&quot;, profileUuid);</span>
<span class="fc" id="L135">    query.setQProfile(profile);</span>
<span class="fc" id="L136">  }</span>

  private void setCompareToProfile(DbSession dbSession, RuleQuery query, Request request) {
<span class="fc" id="L139">    String compareToProfileUuid = request.param(PARAM_COMPARE_TO_PROFILE);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">    if (compareToProfileUuid == null) {</span>
<span class="fc" id="L141">      return;</span>
    }
<span class="fc" id="L143">    QProfileDto profileOptional = dbClient.qualityProfileDao().selectByUuid(dbSession, compareToProfileUuid);</span>
<span class="fc" id="L144">    QProfileDto profile = checkFound(profileOptional, &quot;The specified qualityProfile '%s' does not exist&quot;, compareToProfileUuid);</span>

<span class="fc" id="L146">    query.setCompareToQProfile(profile);</span>
<span class="fc" id="L147">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>