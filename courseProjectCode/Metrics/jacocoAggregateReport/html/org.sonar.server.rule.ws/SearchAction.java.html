<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">SearchAction.java</span></div><h1>SearchAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Ordering;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;
import javax.annotation.Nullable;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.Severity;
import org.sonar.api.rules.CleanCodeAttributeCategory;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.core.rule.RuleType;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.server.es.Facets;
import org.sonar.server.es.SearchIdResult;
import org.sonar.server.es.SearchOptions;
import org.sonar.server.rule.index.RuleIndex;
import org.sonar.server.rule.index.RuleQuery;
import org.sonar.server.rule.ws.RulesResponseFormatter.SearchResult;
import org.sonarqube.ws.Common;
import org.sonarqube.ws.Rules;
import org.sonarqube.ws.Rules.SearchResponse;
import org.sonarqube.ws.client.issue.IssuesWsParameters;

import static java.lang.String.format;
import static org.sonar.api.issue.impact.Severity.BLOCKER;
import static org.sonar.api.issue.impact.Severity.INFO;
import static org.sonar.api.server.ws.WebService.Param.ASCENDING;
import static org.sonar.api.server.ws.WebService.Param.FACETS;
import static org.sonar.api.server.ws.WebService.Param.FIELDS;
import static org.sonar.api.server.ws.WebService.Param.PAGE;
import static org.sonar.api.server.ws.WebService.Param.PAGE_SIZE;
import static org.sonar.server.es.SearchOptions.MAX_PAGE_SIZE;
import static org.sonar.server.rule.index.RuleIndex.ALL_STATUSES_EXCEPT_REMOVED;
import static org.sonar.server.rule.index.RuleIndex.FACET_ACTIVE_IMPACT_SEVERITY;
import static org.sonar.server.rule.index.RuleIndex.FACET_ACTIVE_SEVERITIES;
import static org.sonar.server.rule.index.RuleIndex.FACET_CLEAN_CODE_ATTRIBUTE_CATEGORY;
import static org.sonar.server.rule.index.RuleIndex.FACET_CWE;
import static org.sonar.server.rule.index.RuleIndex.FACET_IMPACT_SEVERITY;
import static org.sonar.server.rule.index.RuleIndex.FACET_IMPACT_SOFTWARE_QUALITY;
import static org.sonar.server.rule.index.RuleIndex.FACET_LANGUAGES;
import static org.sonar.server.rule.index.RuleIndex.FACET_OLD_DEFAULT;
import static org.sonar.server.rule.index.RuleIndex.FACET_OWASP_MOBILE_TOP_10_2024;
import static org.sonar.server.rule.index.RuleIndex.FACET_OWASP_TOP_10;
import static org.sonar.server.rule.index.RuleIndex.FACET_OWASP_TOP_10_2021;
import static org.sonar.server.rule.index.RuleIndex.FACET_REPOSITORIES;
import static org.sonar.server.rule.index.RuleIndex.FACET_SANS_TOP_25;
import static org.sonar.server.rule.index.RuleIndex.FACET_SEVERITIES;
import static org.sonar.server.rule.index.RuleIndex.FACET_SONARSOURCE_SECURITY;
import static org.sonar.server.rule.index.RuleIndex.FACET_STATUSES;
import static org.sonar.server.rule.index.RuleIndex.FACET_TAGS;
import static org.sonar.server.rule.index.RuleIndex.FACET_TYPES;
import static org.sonar.server.rule.ws.RulesWsParameters.OPTIONAL_FIELDS;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CWE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SOFTWARE_QUALITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_LANGUAGES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_MOBILE_TOP_10_2024;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10_2021;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_PRIORITIZED_RULE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_REPOSITORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SANS_TOP_25;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SONARSOURCE_SECURITY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_STATUSES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TAGS;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TYPES;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

public class SearchAction implements RulesWsAction {
  public static final String ACTION = &quot;search&quot;;

<span class="fc" id="L112">  private static final Collection&lt;String&gt; DEFAULT_FACETS = Set.of(PARAM_LANGUAGES, PARAM_REPOSITORIES, &quot;tags&quot;);</span>
<span class="fc" id="L113">  private static final String[] POSSIBLE_FACETS = new String[] {</span>
    FACET_LANGUAGES,
    FACET_REPOSITORIES,
    FACET_TAGS,
    FACET_SEVERITIES,
    FACET_ACTIVE_SEVERITIES,
    FACET_STATUSES,
    FACET_TYPES,
    FACET_OLD_DEFAULT,
    FACET_CWE,
    FACET_OWASP_TOP_10,
    FACET_OWASP_TOP_10_2021,
    FACET_OWASP_MOBILE_TOP_10_2024,
    FACET_SANS_TOP_25,
    FACET_SONARSOURCE_SECURITY,
    FACET_CLEAN_CODE_ATTRIBUTE_CATEGORY,
    FACET_IMPACT_SEVERITY,
    FACET_IMPACT_SOFTWARE_QUALITY,
    FACET_ACTIVE_IMPACT_SEVERITY
  };

  private final RuleQueryFactory ruleQueryFactory;
  private final DbClient dbClient;
  private final RuleIndex ruleIndex;
  private final RulesResponseFormatter rulesResponseFormatter;

<span class="fc" id="L139">  public SearchAction(RuleIndex ruleIndex, RuleQueryFactory ruleQueryFactory, DbClient dbClient, RulesResponseFormatter rulesResponseFormatter) {</span>
<span class="fc" id="L140">    this.ruleIndex = ruleIndex;</span>
<span class="fc" id="L141">    this.ruleQueryFactory = ruleQueryFactory;</span>
<span class="fc" id="L142">    this.dbClient = dbClient;</span>
<span class="fc" id="L143">    this.rulesResponseFormatter = rulesResponseFormatter;</span>
<span class="fc" id="L144">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L148">    WebService.NewAction action = controller.createAction(ACTION)</span>
<span class="fc" id="L149">      .addPagingParams(100, MAX_PAGE_SIZE)</span>
<span class="fc" id="L150">      .setHandler(this)</span>
<span class="fc" id="L151">      .setChangelog(</span>
        new Change(&quot;5.5&quot;, &quot;The field 'effortToFixDescription' has been deprecated, use 'gapDescription' instead&quot;),
        new Change(&quot;5.5&quot;, &quot;The field 'debtRemFnCoeff' has been deprecated, use 'remFnGapMultiplier' instead&quot;),
        new Change(&quot;5.5&quot;, &quot;The field 'defaultDebtRemFnCoeff' has been deprecated, use 'defaultRemFnGapMultiplier' instead&quot;),
        new Change(&quot;5.5&quot;, &quot;The field 'debtRemFnOffset' has been deprecated, use 'remFnBaseEffort' instead&quot;),
        new Change(&quot;5.5&quot;, &quot;The field 'defaultDebtRemFnOffset' has been deprecated, use 'defaultRemFnBaseEffort' instead&quot;),
        new Change(&quot;5.5&quot;, &quot;The field 'debtOverloaded' has been deprecated, use 'remFnOverloaded' instead&quot;),
        new Change(&quot;7.1&quot;, &quot;The field 'scope' has been added to the response&quot;),
        new Change(&quot;7.1&quot;, &quot;The field 'scope' has been added to the 'fields' parameter&quot;),
        new Change(&quot;7.2&quot;, &quot;The field 'isExternal' has been added to the response&quot;),
        new Change(&quot;7.2&quot;, &quot;The field 'includeExternal' has been added to the 'fields' parameter&quot;),
        new Change(&quot;7.5&quot;, &quot;The field 'updatedAt' has been added to the 'fields' parameter&quot;),
        new Change(&quot;9.5&quot;, &quot;The field 'htmlDesc' has been deprecated, use 'descriptionSections' instead&quot;),
        new Change(&quot;9.5&quot;, &quot;The field 'descriptionSections' has been added to the payload&quot;),
        new Change(&quot;9.5&quot;, &quot;The field 'descriptionSections' has been added to the 'fields' parameter&quot;),
        new Change(&quot;9.6&quot;, &quot;'descriptionSections' can optionally embed a context field&quot;),
        new Change(&quot;9.6&quot;, &quot;The field 'educationPrinciples' has been added to the 'fields' parameter&quot;),
        new Change(&quot;9.8&quot;, &quot;response fields 'total', 's', 'pageSize' have been deprecated, please use 'paging' object instead&quot;),
        new Change(&quot;9.8&quot;, &quot;The field 'paging' has been added to the response&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'effortToFixDescription' has been removed, use 'gapDescription' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'debtRemFnCoeff' has been removed, use 'remFnGapMultiplier' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'defaultDebtRemFnCoeff' has been removed, use 'defaultRemFnGapMultiplier' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'debtRemFnOffset' has been removed, use 'remFnBaseEffort' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'defaultDebtRemFnOffset' has been removed, use 'defaultRemFnBaseEffort' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The deprecated field 'debtOverloaded' has been removed, use 'remFnOverloaded' instead.&quot;),
        new Change(&quot;10.0&quot;, &quot;The field 'defaultDebtRemFnType' has been deprecated, use 'defaultRemFnType' instead&quot;),
        new Change(&quot;10.0&quot;, &quot;The field 'debtRemFnType' has been deprecated, use 'remFnType' instead&quot;),
        new Change(&quot;10.0&quot;, &quot;The value 'debtRemFn' for the 'fields' parameter has been deprecated, use 'remFn' instead&quot;),
        new Change(&quot;10.0&quot;, &quot;The value 'defaultDebtRemFn' for the 'fields' parameter has been deprecated, use 'defaultRemFn' instead&quot;),
        new Change(&quot;10.0&quot;, &quot;The value 'sansTop25' for the parameter 'facets' has been deprecated&quot;),
        new Change(&quot;10.0&quot;, &quot;Parameter 'sansTop25' is deprecated&quot;),
        new Change(&quot;10.2&quot;, &quot;Add 'impacts', 'cleanCodeAttribute', 'cleanCodeAttributeCategory' fields to the response&quot;),
        new Change(&quot;10.2&quot;, &quot;The fields 'type' and 'severity' are deprecated in the response. Use 'impacts' instead.&quot;),
        new Change(&quot;10.2&quot;, &quot;The field 'cleanCodeAttribute' has been added to the 'fields' parameter.&quot;),
        new Change(&quot;10.2&quot;, &quot;The value 'severity' for the 'fields' parameter has been deprecated.&quot;),
        new Change(&quot;10.2&quot;,
<span class="fc" id="L187">          format(&quot;The values '%s', '%s' and '%s' have been added to the 'facets' parameter.&quot;, FACET_CLEAN_CODE_ATTRIBUTE_CATEGORY, FACET_IMPACT_SOFTWARE_QUALITY,</span>
            FACET_IMPACT_SEVERITY)),
<span class="fc" id="L189">        new Change(&quot;10.2&quot;, format(&quot;The values 'severity' and 'types' for the 'facets' parameter have been deprecated. Use '%s' and '%s' instead.&quot;, FACET_IMPACT_SEVERITY,</span>
          FACET_IMPACT_SOFTWARE_QUALITY)),
        new Change(&quot;10.2&quot;,
<span class="fc" id="L192">          format(&quot;Parameters '%s', '%s', and '%s' are now deprecated. Use '%s' and '%s' instead.&quot;, PARAM_SEVERITIES, PARAM_TYPES, PARAM_ACTIVE_SEVERITIES,</span>
            PARAM_IMPACT_SOFTWARE_QUALITIES, PARAM_IMPACT_SEVERITIES)),
<span class="fc" id="L194">        new Change(&quot;10.6&quot;, format(&quot;Parameter '%s has been added&quot;, PARAM_PRIORITIZED_RULE)),</span>
<span class="fc" id="L195">        new Change(&quot;10.8&quot;, format(&quot;Possible values '%s' and '%s' for response field 'impactSeverities' of 'facets' have been added&quot;, INFO.name(), BLOCKER.name())),</span>
<span class="fc" id="L196">        new Change(&quot;10.8&quot;, format(&quot;Possible values '%s' and '%s' for response field 'severity' of 'impacts' have been added&quot;, INFO.name(), BLOCKER.name())),</span>
<span class="fc" id="L197">        new Change(&quot;10.8&quot;, format(&quot;Parameter '%s' now supports values: '%s','%s'&quot;, IssuesWsParameters.PARAM_SEVERITIES, INFO.name(), BLOCKER.name())),</span>
        new Change(&quot;10.8&quot;, &quot;The field 'impacts' has been added to the response&quot;),
<span class="fc" id="L199">        new Change(&quot;10.8&quot;, format(&quot;The parameters '%s','%s and '%s' are not deprecated anymore.&quot;, PARAM_SEVERITIES, PARAM_TYPES, PARAM_ACTIVE_SEVERITIES)),</span>
        new Change(&quot;10.8&quot;, &quot;The values 'severity' and 'types' for the 'facets' parameter are not deprecated anymore.&quot;),
        new Change(&quot;10.8&quot;, &quot;The fields 'type' and 'severity' in the response are not deprecated anymore.&quot;),
        new Change(&quot;10.8&quot;, &quot;The value 'severity' for the 'fields' parameter is not deprecated anymore.&quot;),
<span class="fc" id="L203">        new Change(&quot;2025.1&quot;, format(&quot;The facet '%s' has been added.&quot;, FACET_ACTIVE_IMPACT_SEVERITY)),</span>
        new Change(&quot;2025.1&quot;, &quot;The deprecated field 'htmlDesc' is not returned anymore, even if specified in the 'fields' parameter.&quot;));

<span class="fc" id="L206">    action.createParam(FACETS)</span>
<span class="fc" id="L207">      .setDescription(&quot;Comma-separated list of the facets to be computed. No facet is computed by default.&quot;)</span>
<span class="fc" id="L208">      .setPossibleValues(POSSIBLE_FACETS)</span>
<span class="fc" id="L209">      .setExampleValue(format(&quot;%s,%s&quot;, POSSIBLE_FACETS[0], POSSIBLE_FACETS[1]));</span>

<span class="fc" id="L211">    WebService.NewParam paramFields = action.createParam(FIELDS)</span>
<span class="fc" id="L212">      .setDescription(&quot;Comma-separated list of additional fields to be returned in the response. All the fields are returned by default, except actives.&quot;)</span>
<span class="fc" id="L213">      .setPossibleValues(Ordering.natural().sortedCopy(OPTIONAL_FIELDS));</span>

<span class="fc" id="L215">    Iterator&lt;String&gt; it = OPTIONAL_FIELDS.iterator();</span>
<span class="fc" id="L216">    paramFields.setExampleValue(format(&quot;%s,%s&quot;, it.next(), it.next()));</span>
<span class="fc" id="L217">    action.setDescription(&quot;Search for a collection of relevant rules matching a specified query.&lt;br/&gt;&quot;)</span>
<span class="fc" id="L218">      .setResponseExample(getClass().getResource(&quot;search-example.json&quot;))</span>
<span class="fc" id="L219">      .setSince(&quot;4.4&quot;)</span>
<span class="fc" id="L220">      .setHandler(this);</span>

    // Rule-specific search parameters
<span class="fc" id="L223">    RuleWsSupport.defineGenericRuleSearchParameters(action);</span>
<span class="fc" id="L224">    RuleWsSupport.defineIsExternalParam(action);</span>
<span class="fc" id="L225">    RuleWsSupport.definePrioritizedRuleParam(action);</span>
<span class="fc" id="L226">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L230">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L231">      SearchRequest searchWsRequest = toSearchWsRequest(request);</span>
<span class="fc" id="L232">      SearchOptions context = buildSearchOptions(searchWsRequest);</span>
<span class="fc" id="L233">      RuleQuery query = ruleQueryFactory.createRuleSearchQuery(dbSession, request);</span>
<span class="fc" id="L234">      SearchResult searchResult = doSearch(dbSession, query, context);</span>
<span class="fc" id="L235">      SearchResponse responseBuilder = buildResponse(dbSession, searchWsRequest, context, searchResult, query);</span>
<span class="fc" id="L236">      writeProtobuf(responseBuilder, request, response);</span>
    }
<span class="fc" id="L238">  }</span>

  private SearchResponse buildResponse(DbSession dbSession, SearchRequest request, SearchOptions context, SearchResult result, RuleQuery query) {
<span class="fc" id="L241">    SearchResponse.Builder responseBuilder = SearchResponse.newBuilder();</span>
<span class="fc" id="L242">    writeStatistics(responseBuilder, result, context);</span>
<span class="fc" id="L243">    doContextResponse(dbSession, request, result, responseBuilder, query);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (!context.getFacets().isEmpty()) {</span>
<span class="fc" id="L245">      writeFacets(responseBuilder, request, context, result);</span>
    }
<span class="fc" id="L247">    return responseBuilder.build();</span>
  }

  private static void writeStatistics(SearchResponse.Builder response, SearchResult searchResult, SearchOptions context) {
<span class="fc" id="L251">    response.setTotal(searchResult.getTotal());</span>
<span class="fc" id="L252">    response.setP(context.getPage());</span>
<span class="fc" id="L253">    response.setPs(context.getLimit());</span>
<span class="fc" id="L254">    response.setPaging(formatPaging(searchResult.getTotal(), context.getPage(), context.getLimit()));</span>
<span class="fc" id="L255">  }</span>

  private static Common.Paging.Builder formatPaging(Long total, int pageIndex, int limit) {
<span class="fc" id="L258">    return Common.Paging.newBuilder()</span>
<span class="fc" id="L259">      .setPageIndex(pageIndex)</span>
<span class="fc" id="L260">      .setPageSize(limit)</span>
<span class="fc" id="L261">      .setTotal(total.intValue());</span>
  }

  private static SearchOptions buildSearchOptions(SearchRequest request) {
<span class="fc" id="L265">    SearchOptions context = loadCommonContext(request);</span>
<span class="fc" id="L266">    SearchOptions searchOptions = new SearchOptions()</span>
<span class="fc" id="L267">      .setLimit(context.getLimit())</span>
<span class="fc" id="L268">      .setOffset(context.getOffset());</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">    if (context.getFacets().contains(RuleIndex.FACET_OLD_DEFAULT)) {</span>
<span class="nc" id="L270">      searchOptions.addFacets(DEFAULT_FACETS);</span>
    } else {
<span class="fc" id="L272">      searchOptions.addFacets(context.getFacets());</span>
    }
<span class="fc" id="L274">    return searchOptions;</span>
  }

  private static SearchOptions loadCommonContext(SearchRequest request) {
<span class="fc" id="L278">    int pageSize = Integer.parseInt(request.pageSize());</span>
<span class="fc" id="L279">    SearchOptions context = new SearchOptions().addFields(request.fields());</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">    if (request.facets() != null) {</span>
<span class="fc" id="L281">      context.addFacets(request.facets());</span>
    }
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">    if (pageSize &lt; 1) {</span>
<span class="nc" id="L284">      context.setPage(Integer.parseInt(request.page()), 0).setLimit(MAX_PAGE_SIZE);</span>
    } else {
<span class="fc" id="L286">      context.setPage(Integer.parseInt(request.page()), pageSize);</span>
    }
<span class="fc" id="L288">    return context;</span>
  }

  private SearchResult doSearch(DbSession dbSession, RuleQuery query, SearchOptions context) {
<span class="fc" id="L292">    SearchIdResult&lt;String&gt; result = ruleIndex.search(query, context);</span>
<span class="fc" id="L293">    List&lt;String&gt; ruleUuids = result.getUuids();</span>
    // rule order is managed by ES, this order by must be kept when fetching rule details
<span class="fc" id="L295">    Map&lt;String, RuleDto&gt; rulesByRuleKey = Maps.uniqueIndex(dbClient.ruleDao().selectByUuids(dbSession, ruleUuids), RuleDto::getUuid);</span>
<span class="fc" id="L296">    List&lt;RuleDto&gt; rules = new LinkedList&lt;&gt;();</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">    for (String ruleUuid : ruleUuids) {</span>
<span class="fc" id="L298">      RuleDto rule = rulesByRuleKey.get(ruleUuid);</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">      if (rule != null) {</span>
<span class="fc" id="L300">        rules.add(rule);</span>
      }
<span class="fc" id="L302">    }</span>

<span class="fc" id="L304">    List&lt;String&gt; templateRuleUuids = rules.stream()</span>
<span class="fc" id="L305">      .map(RuleDto::getTemplateUuid)</span>
<span class="fc" id="L306">      .filter(Objects::nonNull)</span>
<span class="fc" id="L307">      .toList();</span>
<span class="fc" id="L308">    List&lt;RuleDto&gt; templateRules = dbClient.ruleDao().selectByUuids(dbSession, templateRuleUuids);</span>
<span class="fc" id="L309">    List&lt;RuleParamDto&gt; ruleParamDtos = dbClient.ruleDao().selectRuleParamsByRuleUuids(dbSession, ruleUuids);</span>
<span class="fc" id="L310">    return new SearchResult()</span>
<span class="fc" id="L311">      .setRules(rules)</span>
<span class="fc" id="L312">      .setRuleParameters(ruleParamDtos)</span>
<span class="fc" id="L313">      .setTemplateRules(templateRules)</span>
<span class="fc" id="L314">      .setFacets(result.getFacets())</span>
<span class="fc" id="L315">      .setTotal(result.getTotal());</span>
  }

  private void doContextResponse(DbSession dbSession, SearchRequest request, SearchResult result, SearchResponse.Builder response, RuleQuery query) {
<span class="fc" id="L319">    SearchOptions contextForResponse = loadCommonContext(request);</span>
<span class="fc" id="L320">    response.addAllRules(rulesResponseFormatter.formatRulesSearch(dbSession, result, contextForResponse.getFields()));</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">    if (contextForResponse.getFields().contains(&quot;actives&quot;)) {</span>
<span class="fc" id="L322">      Rules.Actives actives = rulesResponseFormatter.formatActiveRules(dbSession, query.getQProfile(), result.getRules());</span>
<span class="fc" id="L323">      Set&lt;String&gt; qProfiles = actives.getActivesMap().values()</span>
<span class="fc" id="L324">        .stream()</span>
<span class="fc" id="L325">        .map(Rules.ActiveList::getActiveListList)</span>
<span class="fc" id="L326">        .flatMap(List::stream)</span>
<span class="fc" id="L327">        .map(Rules.Active::getQProfile)</span>
<span class="fc" id="L328">        .collect(Collectors.toSet());</span>

<span class="fc" id="L330">      Rules.QProfiles profiles = rulesResponseFormatter.formatQualityProfiles(dbSession, qProfiles);</span>
<span class="fc" id="L331">      response.setActives(actives);</span>
<span class="fc" id="L332">      response.setQProfiles(profiles);</span>
    }
<span class="fc" id="L334">  }</span>

  private static void writeFacets(SearchResponse.Builder response, SearchRequest request, SearchOptions context, SearchResult results) {
<span class="fc" id="L337">    Facets resultsFacets = results.getFacets();</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">    if (resultsFacets == null) {</span>
<span class="nc" id="L339">      return;</span>
    }
<span class="fc" id="L341">    addMandatoryFacetValues(results, FACET_LANGUAGES, request.languages);</span>
<span class="fc" id="L342">    addMandatoryFacetValues(results, FACET_REPOSITORIES, request.repositories);</span>
<span class="fc" id="L343">    addMandatoryFacetValues(results, FACET_STATUSES, ALL_STATUSES_EXCEPT_REMOVED);</span>
<span class="fc" id="L344">    addMandatoryFacetValues(results, FACET_SEVERITIES, Severity.ALL);</span>
<span class="fc" id="L345">    addMandatoryFacetValues(results, FACET_ACTIVE_SEVERITIES, Severity.ALL);</span>
<span class="fc" id="L346">    addMandatoryFacetValues(results, FACET_TAGS, request.tags);</span>
<span class="fc" id="L347">    addMandatoryFacetValues(results, FACET_TYPES, RuleType.names());</span>
<span class="fc" id="L348">    addMandatoryFacetValues(results, FACET_CWE, request.cwe);</span>
<span class="fc" id="L349">    addMandatoryFacetValues(results, FACET_OWASP_TOP_10, request.owaspTop10());</span>
<span class="fc" id="L350">    addMandatoryFacetValues(results, FACET_OWASP_TOP_10_2021, request.owaspTop10For2021());</span>
<span class="fc" id="L351">    addMandatoryFacetValues(results, FACET_OWASP_MOBILE_TOP_10_2024, request.owaspMobileTop10For2024());</span>
<span class="fc" id="L352">    addMandatoryFacetValues(results, FACET_SANS_TOP_25, request.sansTop25());</span>
<span class="fc" id="L353">    addMandatoryFacetValues(results, FACET_SONARSOURCE_SECURITY, request.sonarsourceSecurity());</span>
<span class="fc" id="L354">    addMandatoryFacetValues(results, PARAM_IMPACT_SOFTWARE_QUALITIES, enumToStringCollection(SoftwareQuality.values()));</span>
<span class="fc" id="L355">    addMandatoryFacetValues(results, PARAM_IMPACT_SEVERITIES, enumToStringCollection(org.sonar.api.issue.impact.Severity.values()));</span>
<span class="fc" id="L356">    addMandatoryFacetValues(results, PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES, enumToStringCollection(CleanCodeAttributeCategory.values()));</span>

<span class="fc" id="L358">    Common.Facet.Builder facet = Common.Facet.newBuilder();</span>
<span class="fc" id="L359">    Common.FacetValue.Builder value = Common.FacetValue.newBuilder();</span>
<span class="fc" id="L360">    Map&lt;String, List&lt;String&gt;&gt; facetValuesByFacetKey = new HashMap&lt;&gt;();</span>
<span class="fc" id="L361">    facetValuesByFacetKey.put(FACET_LANGUAGES, request.languages());</span>
<span class="fc" id="L362">    facetValuesByFacetKey.put(FACET_REPOSITORIES, request.repositories());</span>
<span class="fc" id="L363">    facetValuesByFacetKey.put(FACET_STATUSES, request.statuses());</span>
<span class="fc" id="L364">    facetValuesByFacetKey.put(FACET_SEVERITIES, request.severities());</span>
<span class="fc" id="L365">    facetValuesByFacetKey.put(FACET_ACTIVE_SEVERITIES, request.activeSeverities());</span>
<span class="fc" id="L366">    facetValuesByFacetKey.put(FACET_TAGS, request.tags());</span>
<span class="fc" id="L367">    facetValuesByFacetKey.put(FACET_TYPES, request.types());</span>
<span class="fc" id="L368">    facetValuesByFacetKey.put(FACET_CWE, request.cwe());</span>
<span class="fc" id="L369">    facetValuesByFacetKey.put(FACET_OWASP_TOP_10, request.owaspTop10());</span>
<span class="fc" id="L370">    facetValuesByFacetKey.put(FACET_OWASP_TOP_10_2021, request.owaspTop10For2021());</span>
<span class="fc" id="L371">    facetValuesByFacetKey.put(FACET_OWASP_MOBILE_TOP_10_2024, request.owaspMobileTop10For2024());</span>
<span class="fc" id="L372">    facetValuesByFacetKey.put(FACET_SANS_TOP_25, request.sansTop25());</span>
<span class="fc" id="L373">    facetValuesByFacetKey.put(FACET_SONARSOURCE_SECURITY, request.sonarsourceSecurity());</span>
<span class="fc" id="L374">    facetValuesByFacetKey.put(FACET_CLEAN_CODE_ATTRIBUTE_CATEGORY, request.cleanCodeAttributesCategories());</span>
<span class="fc" id="L375">    facetValuesByFacetKey.put(FACET_IMPACT_SOFTWARE_QUALITY, request.impactSoftwareQualities());</span>
<span class="fc" id="L376">    facetValuesByFacetKey.put(FACET_IMPACT_SEVERITY, request.impactSeverities());</span>
<span class="fc" id="L377">    facetValuesByFacetKey.put(FACET_ACTIVE_IMPACT_SEVERITY, request.activeImpactSeverities());</span>

<span class="fc bfc" id="L379" title="All 2 branches covered.">    for (String facetName : context.getFacets()) {</span>
<span class="fc" id="L380">      facet.clear().setProperty(facetName);</span>
<span class="fc" id="L381">      Map&lt;String, Long&gt; facets = resultsFacets.get(facetName);</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">      if (facets != null) {</span>
<span class="fc" id="L383">        Set&lt;String&gt; itemsFromFacets = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">        for (Map.Entry&lt;String, Long&gt; facetValue : facets.entrySet()) {</span>
<span class="fc" id="L385">          itemsFromFacets.add(facetValue.getKey());</span>
<span class="fc" id="L386">          facet.addValues(value</span>
<span class="fc" id="L387">            .clear()</span>
<span class="fc" id="L388">            .setVal(facetValue.getKey())</span>
<span class="fc" id="L389">            .setCount(facetValue.getValue()));</span>
<span class="fc" id="L390">        }</span>
<span class="fc" id="L391">        addZeroFacetsForSelectedItems(facet, facetValuesByFacetKey.get(facetName), itemsFromFacets);</span>
      }
<span class="fc" id="L393">      response.getFacetsBuilder().addFacets(facet);</span>
<span class="fc" id="L394">    }</span>
<span class="fc" id="L395">  }</span>

  private static Collection&lt;String&gt; enumToStringCollection(Enum&lt;?&gt;... enumValues) {
<span class="fc" id="L398">    return Arrays.stream(enumValues).map(Enum::name).toList();</span>
  }

  private static void addZeroFacetsForSelectedItems(Common.Facet.Builder facet, @Nullable List&lt;String&gt; requestParams, Set&lt;String&gt; itemsFromFacets) {
<span class="fc bfc" id="L402" title="All 2 branches covered.">    if (requestParams != null) {</span>
<span class="fc" id="L403">      Common.FacetValue.Builder value = Common.FacetValue.newBuilder();</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">      for (String param : requestParams) {</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">        if (!itemsFromFacets.contains(param)) {</span>
<span class="nc" id="L406">          facet.addValues(value.clear()</span>
<span class="nc" id="L407">            .setVal(param)</span>
<span class="nc" id="L408">            .setCount(0L));</span>
        }
<span class="fc" id="L410">      }</span>
    }
<span class="fc" id="L412">  }</span>

  private static void addMandatoryFacetValues(SearchResult results, String facetName, @Nullable Collection&lt;String&gt; mandatoryValues) {
<span class="fc" id="L415">    Facets facets = results.getFacets();</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">    if (facets == null) {</span>
<span class="nc" id="L417">      return;</span>
    }
<span class="fc" id="L419">    Map&lt;String, Long&gt; facetValues = facets.get(facetName);</span>
<span class="fc bfc" id="L420" title="All 2 branches covered.">    if (facetValues != null) {</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">      Collection&lt;String&gt; valuesToAdd = mandatoryValues == null ? Lists.newArrayList() : mandatoryValues;</span>
<span class="fc bfc" id="L422" title="All 2 branches covered.">      for (String item : valuesToAdd) {</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">        if (!facetValues.containsKey(item)) {</span>
<span class="fc" id="L424">          facetValues.put(item, 0L);</span>
        }
<span class="fc" id="L426">      }</span>
    }
<span class="fc" id="L428">  }</span>

  private static SearchRequest toSearchWsRequest(Request request) {
<span class="fc" id="L431">    request.mandatoryParamAsBoolean(ASCENDING);</span>
<span class="fc" id="L432">    return new SearchRequest(</span>
<span class="fc" id="L433">      String.valueOf(request.mandatoryParamAsInt(PAGE)),</span>
<span class="fc" id="L434">      String.valueOf(request.mandatoryParamAsInt(PAGE_SIZE)),</span>
<span class="fc" id="L435">      request.paramAsStrings(FIELDS),</span>
<span class="fc" id="L436">      request.paramAsStrings(FACETS),</span>
<span class="fc" id="L437">      request.paramAsStrings(PARAM_LANGUAGES),</span>
<span class="fc" id="L438">      request.paramAsStrings(PARAM_REPOSITORIES),</span>
<span class="fc" id="L439">      request.paramAsStrings(PARAM_SEVERITIES),</span>
<span class="fc" id="L440">      request.paramAsStrings(PARAM_STATUSES),</span>
<span class="fc" id="L441">      request.paramAsStrings(PARAM_TAGS),</span>
<span class="fc" id="L442">      request.paramAsStrings(PARAM_TYPES),</span>
<span class="fc" id="L443">      request.paramAsStrings(PARAM_CWE),</span>
<span class="fc" id="L444">      request.paramAsStrings(PARAM_OWASP_TOP_10),</span>
<span class="fc" id="L445">      request.paramAsStrings(PARAM_OWASP_TOP_10_2021),</span>
<span class="fc" id="L446">      request.paramAsStrings(PARAM_OWASP_MOBILE_TOP_10_2024),</span>
<span class="fc" id="L447">      request.paramAsStrings(PARAM_SANS_TOP_25),</span>
<span class="fc" id="L448">      request.paramAsStrings(PARAM_SONARSOURCE_SECURITY),</span>
<span class="fc" id="L449">      request.paramAsStrings(PARAM_IMPACT_SEVERITIES),</span>
<span class="fc" id="L450">      request.paramAsStrings(PARAM_IMPACT_SOFTWARE_QUALITIES),</span>
<span class="fc" id="L451">      request.paramAsStrings(PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES),</span>
<span class="fc" id="L452">      request.paramAsStrings(PARAM_ACTIVE_SEVERITIES),</span>
<span class="fc" id="L453">      request.paramAsStrings(PARAM_ACTIVE_IMPACT_SEVERITIES),</span>
<span class="fc" id="L454">      request.paramAsBoolean(PARAM_PRIORITIZED_RULE)</span>
    );
  }

<span class="fc" id="L458">  private record SearchRequest(</span>
    String page,
    String pageSize,
    @Nullable List&lt;String&gt; fields,
    @Nullable List&lt;String&gt; facets,
    @Nullable List&lt;String&gt; languages,
    @Nullable List&lt;String&gt; repositories,
    @Nullable List&lt;String&gt; severities,
    @Nullable List&lt;String&gt; statuses,
    @Nullable List&lt;String&gt; tags,
    @Nullable List&lt;String&gt; types,
    @Nullable List&lt;String&gt; cwe,
    @Nullable List&lt;String&gt; owaspTop10,
    @Nullable List&lt;String&gt; owaspTop10For2021,
    @Nullable List&lt;String&gt; owaspMobileTop10For2024,
    @Nullable List&lt;String&gt; sansTop25,
    @Nullable List&lt;String&gt; sonarsourceSecurity,
    @Nullable List&lt;String&gt; impactSeverities,
    @Nullable List&lt;String&gt; impactSoftwareQualities,
    @Nullable List&lt;String&gt; cleanCodeAttributesCategories,
    @Nullable List&lt;String&gt; activeSeverities,
    @Nullable List&lt;String&gt; activeImpactSeverities,
    @Nullable Boolean prioritizedRule
  ) {
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>