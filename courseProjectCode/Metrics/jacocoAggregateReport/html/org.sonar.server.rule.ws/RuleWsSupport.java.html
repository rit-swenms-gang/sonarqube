<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleWsSupport.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">RuleWsSupport.java</span></div><h1>RuleWsSupport.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.rule.Severity;
import org.sonar.api.rules.CleanCodeAttributeCategory;
import org.sonar.core.rule.RuleType;
import org.sonar.api.server.ServerSide;
import org.sonar.api.server.ws.WebService;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.user.UserDto;
import org.sonar.server.qualityprofile.ActiveRuleInheritance;
import org.sonar.server.rule.index.RuleIndexDefinition;
import org.sonar.server.security.SecurityStandards;
import org.sonar.server.security.SecurityStandards.SQCategory;
import org.sonar.server.user.UserSession;

import static java.lang.String.format;
import static org.sonar.api.server.ws.WebService.Param.ASCENDING;
import static org.sonar.api.server.ws.WebService.Param.SORT;
import static org.sonar.api.server.ws.WebService.Param.TEXT_QUERY;
import static org.sonar.core.util.Uuids.UUID_EXAMPLE_01;
import static org.sonar.core.util.Uuids.UUID_EXAMPLE_02;
import static org.sonar.db.permission.GlobalPermission.ADMINISTER_QUALITY_PROFILES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVATION;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_ACTIVE_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_AVAILABLE_SINCE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_COMPARE_TO_PROFILE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_CWE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IMPACT_SOFTWARE_QUALITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_INCLUDE_EXTERNAL;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_INHERITANCE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_IS_TEMPLATE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_LANGUAGES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_MOBILE_TOP_10_2024;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_OWASP_TOP_10_2021;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_PRIORITIZED_RULE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_QPROFILE;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_REPOSITORIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_RULE_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SANS_TOP_25;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SEVERITIES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_SONARSOURCE_SECURITY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_STATUSES;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TAGS;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TEMPLATE_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.PARAM_TYPES;

@ServerSide
public class RuleWsSupport {

  private final DbClient dbClient;
  private final UserSession userSession;

<span class="fc" id="L87">  public RuleWsSupport(DbClient dbClient, UserSession userSession) {</span>
<span class="fc" id="L88">    this.dbClient = dbClient;</span>
<span class="fc" id="L89">    this.userSession = userSession;</span>
<span class="fc" id="L90">  }</span>

  public void checkQProfileAdminPermission() {
<span class="fc" id="L93">    userSession</span>
<span class="fc" id="L94">      .checkLoggedIn()</span>
<span class="fc" id="L95">      .checkPermission(ADMINISTER_QUALITY_PROFILES);</span>
<span class="fc" id="L96">  }</span>

  Map&lt;String, UserDto&gt; getUsersByUuid(DbSession dbSession, List&lt;RuleDto&gt; rules) {
<span class="fc" id="L99">    Set&lt;String&gt; userUuids = rules.stream().map(RuleDto::getNoteUserUuid).filter(Objects::nonNull).collect(Collectors.toSet());</span>
<span class="fc" id="L100">    return dbClient.userDao().selectByUuids(dbSession, userUuids).stream().collect(Collectors.toMap(UserDto::getUuid, Function.identity()));</span>
  }

  public static void defineGenericRuleSearchParameters(WebService.NewAction action) {
<span class="fc" id="L104">    action</span>
<span class="fc" id="L105">      .createParam(TEXT_QUERY)</span>
<span class="fc" id="L106">      .setMinimumLength(2)</span>
<span class="fc" id="L107">      .setDescription(&quot;UTF-8 search query&quot;)</span>
<span class="fc" id="L108">      .setExampleValue(&quot;xpath&quot;);</span>

<span class="fc" id="L110">    action</span>
<span class="fc" id="L111">      .createParam(PARAM_RULE_KEY)</span>
<span class="fc" id="L112">      .setDescription(&quot;Key of rule to search for&quot;)</span>
<span class="fc" id="L113">      .setExampleValue(&quot;java:S1144&quot;);</span>

<span class="fc" id="L115">    action</span>
<span class="fc" id="L116">      .createParam(PARAM_REPOSITORIES)</span>
<span class="fc" id="L117">      .setDescription(&quot;Comma-separated list of repositories&quot;)</span>
<span class="fc" id="L118">      .setExampleValue(&quot;java,html&quot;);</span>

<span class="fc" id="L120">    action</span>
<span class="fc" id="L121">      .createParam(PARAM_SEVERITIES)</span>
<span class="fc" id="L122">      .setDescription(&quot;Comma-separated list of default severities. Not the same than severity of rules in Quality profiles.&quot;)</span>
<span class="fc" id="L123">      .setPossibleValues(Severity.ALL)</span>
<span class="fc" id="L124">      .setExampleValue(&quot;CRITICAL,BLOCKER&quot;);</span>

<span class="fc" id="L126">    action</span>
<span class="fc" id="L127">      .createParam(PARAM_CWE)</span>
<span class="fc" id="L128">      .setDescription(&quot;Comma-separated list of CWE identifiers. Use '&quot; + SecurityStandards.UNKNOWN_STANDARD + &quot;' to select rules not associated to any CWE.&quot;)</span>
<span class="fc" id="L129">      .setExampleValue(&quot;12,125,&quot; + SecurityStandards.UNKNOWN_STANDARD);</span>

<span class="fc" id="L131">    action.createParam(PARAM_OWASP_TOP_10)</span>
<span class="fc" id="L132">      .setDescription(&quot;Comma-separated list of OWASP Top 10 2017 lowercase categories.&quot;)</span>
<span class="fc" id="L133">      .setSince(&quot;7.3&quot;)</span>
<span class="fc" id="L134">      .setPossibleValues(&quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;, &quot;a4&quot;, &quot;a5&quot;, &quot;a6&quot;, &quot;a7&quot;, &quot;a8&quot;, &quot;a9&quot;, &quot;a10&quot;);</span>

<span class="fc" id="L136">    action.createParam(PARAM_OWASP_TOP_10_2021)</span>
<span class="fc" id="L137">      .setDescription(&quot;Comma-separated list of OWASP Top 10 2021 lowercase categories.&quot;)</span>
<span class="fc" id="L138">      .setSince(&quot;9.4&quot;)</span>
<span class="fc" id="L139">      .setPossibleValues(&quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;, &quot;a4&quot;, &quot;a5&quot;, &quot;a6&quot;, &quot;a7&quot;, &quot;a8&quot;, &quot;a9&quot;, &quot;a10&quot;);</span>

<span class="fc" id="L141">    action.createParam(PARAM_OWASP_MOBILE_TOP_10_2024)</span>
<span class="fc" id="L142">      .setDescription(&quot;Comma-separated list of OWASP Mobile Top 10 2024 lowercase categories.&quot;)</span>
<span class="fc" id="L143">      .setSince(&quot;2025.4&quot;)</span>
<span class="fc" id="L144">      .setPossibleValues(&quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;, &quot;m4&quot;, &quot;m5&quot;, &quot;m6&quot;, &quot;m7&quot;, &quot;m8&quot;, &quot;m9&quot;, &quot;m10&quot;);</span>

<span class="fc" id="L146">    action.createParam(PARAM_SANS_TOP_25)</span>
<span class="fc" id="L147">      .setDeprecatedSince(&quot;10.0&quot;)</span>
<span class="fc" id="L148">      .setDescription(&quot;Comma-separated list of SANS Top 25 categories.&quot;)</span>
<span class="fc" id="L149">      .setSince(&quot;7.3&quot;)</span>
<span class="fc" id="L150">      .setPossibleValues(SecurityStandards.CWES_BY_SANS_TOP_25.keySet());</span>

<span class="fc" id="L152">    action</span>
<span class="fc" id="L153">      .createParam(PARAM_SONARSOURCE_SECURITY)</span>
<span class="fc" id="L154">      .setDescription(&quot;Comma-separated list of SonarSource security categories. Use '&quot; + SQCategory.OTHERS.getKey() + &quot;' to select rules not associated&quot; +</span>
        &quot; with any category&quot;)
<span class="fc" id="L156">      .setSince(&quot;7.8&quot;)</span>
<span class="fc" id="L157">      .setPossibleValues(Arrays.stream(SQCategory.values()).map(SQCategory::getKey).toList())</span>
<span class="fc" id="L158">      .setExampleValue(&quot;sql-injection,command-injection,others&quot;);</span>

<span class="fc" id="L160">    action</span>
<span class="fc" id="L161">      .createParam(PARAM_LANGUAGES)</span>
<span class="fc" id="L162">      .setDescription(&quot;Comma-separated list of languages&quot;)</span>
<span class="fc" id="L163">      .setExampleValue(&quot;java,js&quot;);</span>

<span class="fc" id="L165">    action</span>
<span class="fc" id="L166">      .createParam(PARAM_STATUSES)</span>
<span class="fc" id="L167">      .setDescription(&quot;Comma-separated list of status codes&quot;)</span>
<span class="fc" id="L168">      .setPossibleValues(RuleStatus.values())</span>
<span class="fc" id="L169">      .setExampleValue(RuleStatus.READY);</span>

<span class="fc" id="L171">    action</span>
<span class="fc" id="L172">      .createParam(PARAM_AVAILABLE_SINCE)</span>
<span class="fc" id="L173">      .setDescription(&quot;Filters rules added since date. Format is yyyy-MM-dd&quot;)</span>
<span class="fc" id="L174">      .setExampleValue(&quot;2014-06-22&quot;);</span>

<span class="fc" id="L176">    action</span>
<span class="fc" id="L177">      .createParam(PARAM_TAGS)</span>
<span class="fc" id="L178">      .setDescription(&quot;Comma-separated list of tags. Returned rules match any of the tags (OR operator)&quot;)</span>
<span class="fc" id="L179">      .setExampleValue(&quot;security,java8&quot;);</span>

<span class="fc" id="L181">    action</span>
<span class="fc" id="L182">      .createParam(PARAM_TYPES)</span>
<span class="fc" id="L183">      .setSince(&quot;5.5&quot;)</span>
<span class="fc" id="L184">      .setDescription(&quot;Comma-separated list of types. Returned rules match any of the tags (OR operator)&quot;)</span>
<span class="fc" id="L185">      .setPossibleValues(RuleType.values())</span>
<span class="fc" id="L186">      .setExampleValue(RuleType.BUG);</span>

<span class="fc" id="L188">    action.createParam(PARAM_IMPACT_SOFTWARE_QUALITIES)</span>
<span class="fc" id="L189">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L190">      .setDescription(&quot;Comma-separated list of Software Qualities&quot;)</span>
<span class="fc" id="L191">      .setExampleValue(SoftwareQuality.MAINTAINABILITY + &quot;,&quot; + SoftwareQuality.RELIABILITY)</span>
<span class="fc" id="L192">      .setPossibleValues(SoftwareQuality.values());</span>

<span class="fc" id="L194">    action.createParam(PARAM_IMPACT_SEVERITIES)</span>
<span class="fc" id="L195">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L196">      .setDescription(&quot;Comma-separated list of Software Quality Severities&quot;)</span>
<span class="fc" id="L197">      .setExampleValue(org.sonar.api.issue.impact.Severity.HIGH + &quot;,&quot; + org.sonar.api.issue.impact.Severity.MEDIUM)</span>
<span class="fc" id="L198">      .setPossibleValues(org.sonar.api.issue.impact.Severity.values());</span>

<span class="fc" id="L200">    action.createParam(PARAM_ACTIVE_IMPACT_SEVERITIES)</span>
<span class="fc" id="L201">      .setSince(&quot;2025.1&quot;)</span>
<span class="fc" id="L202">      .setDescription(&quot;Comma-separated list of Activation Software Quality Severities, i.e the impact severity of rules in Quality profiles.&quot;)</span>
<span class="fc" id="L203">      .setExampleValue(org.sonar.api.issue.impact.Severity.HIGH + &quot;,&quot; + org.sonar.api.issue.impact.Severity.MEDIUM)</span>
<span class="fc" id="L204">      .setPossibleValues(org.sonar.api.issue.impact.Severity.values());</span>

<span class="fc" id="L206">    action.createParam(PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES)</span>
<span class="fc" id="L207">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L208">      .setDescription(&quot;Comma-separated list of Clean Code Attribute Categories&quot;)</span>
<span class="fc" id="L209">      .setExampleValue(CleanCodeAttributeCategory.ADAPTABLE + &quot;,&quot; + CleanCodeAttributeCategory.INTENTIONAL)</span>
<span class="fc" id="L210">      .setPossibleValues(CleanCodeAttributeCategory.values());</span>

<span class="fc" id="L212">    action</span>
<span class="fc" id="L213">      .createParam(PARAM_ACTIVATION)</span>
<span class="fc" id="L214">      .setDescription(&quot;Filter rules that are activated or deactivated on the selected Quality profile. Ignored if &quot; +</span>
        &quot;the parameter '&quot; + PARAM_QPROFILE + &quot;' is not set.&quot;)
<span class="fc" id="L216">      .setBooleanPossibleValues();</span>

<span class="fc" id="L218">    action</span>
<span class="fc" id="L219">      .createParam(PARAM_QPROFILE)</span>
<span class="fc" id="L220">      .setDescription(&quot;Quality profile key to filter on. Only rules of the same language as this profile are returned.&quot; +</span>
        &quot; By default only rules activated in this profile are returned. You can change that using the '&quot; +
        PARAM_ACTIVATION + &quot;' parameter.&quot;)
<span class="fc" id="L223">      .setExampleValue(UUID_EXAMPLE_01);</span>

<span class="fc" id="L225">    action.createParam(PARAM_COMPARE_TO_PROFILE)</span>
<span class="fc" id="L226">      .setDescription(&quot;Quality profile key to filter rules that are activated. Meant to compare easily to profile set in '%s'&quot;, PARAM_QPROFILE)</span>
<span class="fc" id="L227">      .setInternal(true)</span>
<span class="fc" id="L228">      .setSince(&quot;6.5&quot;)</span>
<span class="fc" id="L229">      .setExampleValue(UUID_EXAMPLE_02);</span>

<span class="fc" id="L231">    action</span>
<span class="fc" id="L232">      .createParam(PARAM_INHERITANCE)</span>
<span class="fc" id="L233">      .setDescription(&quot;Comma-separated list of values of inheritance for a rule within a quality profile. Used only if the parameter '&quot; +</span>
        PARAM_ACTIVATION + &quot;' is set.&quot;)
<span class="fc" id="L235">      .setPossibleValues(ActiveRuleInheritance.NONE.name(),</span>
<span class="fc" id="L236">        ActiveRuleInheritance.INHERITED.name(),</span>
<span class="fc" id="L237">        ActiveRuleInheritance.OVERRIDES.name())</span>
<span class="fc" id="L238">      .setExampleValue(ActiveRuleInheritance.INHERITED.name() + &quot;,&quot; +</span>
<span class="fc" id="L239">        ActiveRuleInheritance.OVERRIDES.name());</span>

<span class="fc" id="L241">    action</span>
<span class="fc" id="L242">      .createParam(PARAM_ACTIVE_SEVERITIES)</span>
<span class="fc" id="L243">      .setDescription(&quot;Comma-separated list of activation severities, i.e the severity of rules in Quality profiles.&quot;)</span>
<span class="fc" id="L244">      .setPossibleValues(Severity.ALL)</span>
<span class="fc" id="L245">      .setExampleValue(&quot;CRITICAL,BLOCKER&quot;);</span>

<span class="fc" id="L247">    action</span>
<span class="fc" id="L248">      .createParam(PARAM_IS_TEMPLATE)</span>
<span class="fc" id="L249">      .setDescription(&quot;Filter template rules&quot;)</span>
<span class="fc" id="L250">      .setBooleanPossibleValues();</span>

<span class="fc" id="L252">    action</span>
<span class="fc" id="L253">      .createParam(PARAM_TEMPLATE_KEY)</span>
<span class="fc" id="L254">      .setDescription(&quot;Key of the template rule to filter on. Used to search for the custom rules based on this template.&quot;)</span>
<span class="fc" id="L255">      .setExampleValue(&quot;java:S001&quot;);</span>

<span class="fc" id="L257">    action</span>
<span class="fc" id="L258">      .createParam(SORT)</span>
<span class="fc" id="L259">      .setDescription(&quot;Sort field&quot;)</span>
<span class="fc" id="L260">      .setPossibleValues(RuleIndexDefinition.SORT_FIELDS)</span>
<span class="fc" id="L261">      .setExampleValue(RuleIndexDefinition.SORT_FIELDS.iterator().next());</span>

<span class="fc" id="L263">    action</span>
<span class="fc" id="L264">      .createParam(ASCENDING)</span>
<span class="fc" id="L265">      .setDescription(&quot;Ascending sort&quot;)</span>
<span class="fc" id="L266">      .setBooleanPossibleValues()</span>
<span class="fc" id="L267">      .setDefaultValue(true);</span>
<span class="fc" id="L268">  }</span>

  static void defineIsExternalParam(WebService.NewAction action) {
<span class="fc" id="L271">    action</span>
<span class="fc" id="L272">      .createParam(PARAM_INCLUDE_EXTERNAL)</span>
<span class="fc" id="L273">      .setDescription(&quot;Include external engine rules in the results&quot;)</span>
<span class="fc" id="L274">      .setDefaultValue(false)</span>
<span class="fc" id="L275">      .setBooleanPossibleValues()</span>
<span class="fc" id="L276">      .setSince(&quot;7.2&quot;);</span>
<span class="fc" id="L277">  }</span>

  static void definePrioritizedRuleParam(WebService.NewAction action) {
<span class="fc" id="L280">    action</span>
<span class="fc" id="L281">      .createParam(PARAM_PRIORITIZED_RULE)</span>
<span class="fc" id="L282">      .setDescription(format(&quot;Filter on prioritized rules. Ignored if the parameter '%s' is not set.&quot;, PARAM_QPROFILE))</span>
<span class="fc" id="L283">      .setBooleanPossibleValues()</span>
<span class="fc" id="L284">      .setSince(&quot;10.6&quot;);</span>
<span class="fc" id="L285">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>