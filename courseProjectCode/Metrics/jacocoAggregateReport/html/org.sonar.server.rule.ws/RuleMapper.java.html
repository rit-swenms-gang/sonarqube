<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RuleMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">RuleMapper.java</span></div><h1>RuleMapper.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.resources.Language;
import org.sonar.api.resources.Languages;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.api.server.debt.DebtRemediationFunction;
import org.sonar.api.server.debt.internal.DefaultDebtRemediationFunction;
import org.sonar.core.rule.ImpactFormatter;
import org.sonar.db.issue.ImpactDto;
import org.sonar.db.rule.DeprecatedRuleKeyDto;
import org.sonar.db.rule.RuleDescriptionSectionContextDto;
import org.sonar.db.rule.RuleDescriptionSectionDto;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleDto.Scope;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.db.user.UserDto;
import org.sonar.markdown.Markdown;
import org.sonar.server.common.text.MacroInterpreter;
import org.sonar.server.rule.RuleDescriptionFormatter;
import org.sonar.server.rule.ws.RulesResponseFormatter.SearchResult;
import org.sonarqube.ws.Common;
import org.sonarqube.ws.Common.RuleScope;
import org.sonarqube.ws.Rules;

import static org.sonar.api.utils.DateUtils.formatDateTime;
import static org.sonar.db.rule.RuleDto.Format.MARKDOWN;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_CLEAN_CODE_ATTRIBUTE;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_CREATED_AT;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_DEBT_REM_FUNCTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_DEFAULT_DEBT_REM_FUNCTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_DEFAULT_REM_FUNCTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_DEPRECATED_KEYS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_DESCRIPTION_SECTIONS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_EDUCATION_PRINCIPLES;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_GAP_DESCRIPTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_INTERNAL_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_IS_EXTERNAL;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_IS_TEMPLATE;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_LANGUAGE;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_LANGUAGE_NAME;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_MARKDOWN_DESCRIPTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_NAME;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_NOTE_LOGIN;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_PARAMS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_REM_FUNCTION;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_REM_FUNCTION_OVERLOADED;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_REPO;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_SCOPE;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_SEVERITY;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_STATUS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_SYSTEM_TAGS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_TAGS;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_TEMPLATE_KEY;
import static org.sonar.server.rule.ws.RulesWsParameters.FIELD_UPDATED_AT;
import static org.sonarqube.ws.Rules.Rule.DescriptionSection.Context.newBuilder;

/**
 * Conversion of {@link RuleDto} to {@link Rules.Rule}
 */
public class RuleMapper {

  private final Languages languages;
  private final MacroInterpreter macroInterpreter;
  private final RuleDescriptionFormatter ruleDescriptionFormatter;

<span class="fc" id="L96">  public RuleMapper(final Languages languages, final MacroInterpreter macroInterpreter, RuleDescriptionFormatter ruleDescriptionFormatter) {</span>
<span class="fc" id="L97">    this.languages = languages;</span>
<span class="fc" id="L98">    this.macroInterpreter = macroInterpreter;</span>
<span class="fc" id="L99">    this.ruleDescriptionFormatter = ruleDescriptionFormatter;</span>
<span class="fc" id="L100">  }</span>

  public Rules.Rule toWsRule(RuleDto ruleDefinitionDto, SearchResult result, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L103">    Rules.Rule.Builder ruleResponse = Rules.Rule.newBuilder();</span>
<span class="fc" id="L104">    applyRuleDefinition(ruleResponse, ruleDefinitionDto, result, fieldsToReturn, Collections.emptyMap());</span>
<span class="fc" id="L105">    return ruleResponse.build();</span>
  }

  public Rules.Rule toWsRule(RuleDto ruleDto, SearchResult result, Set&lt;String&gt; fieldsToReturn, Map&lt;String, UserDto&gt; usersByUuid,
    Map&lt;String, List&lt;DeprecatedRuleKeyDto&gt;&gt; deprecatedRuleKeysByRuleUuid) {
<span class="fc" id="L110">    Rules.Rule.Builder ruleResponse = Rules.Rule.newBuilder();</span>
<span class="fc" id="L111">    applyRuleDefinition(ruleResponse, ruleDto, result, fieldsToReturn, deprecatedRuleKeysByRuleUuid);</span>
<span class="fc" id="L112">    setDebtRemediationFunctionFields(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L113">    setNotesFields(ruleResponse, ruleDto, usersByUuid, fieldsToReturn);</span>
<span class="fc" id="L114">    return ruleResponse.build();</span>
  }

  private Rules.Rule.Builder applyRuleDefinition(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, SearchResult result,
    Set&lt;String&gt; fieldsToReturn, Map&lt;String, List&lt;DeprecatedRuleKeyDto&gt;&gt; deprecatedRuleKeysByRuleUuid) {

    // Mandatory fields
<span class="fc" id="L121">    ruleResponse.setKey(ruleDto.getKey().toString());</span>
<span class="fc" id="L122">    ruleResponse.setType(Common.RuleType.forNumber(ruleDto.getType()));</span>
<span class="fc" id="L123">    setImpacts(ruleResponse, ruleDto);</span>

    // Optional fields
<span class="fc" id="L126">    setName(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L127">    setRepository(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L128">    setStatus(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L129">    setSysTags(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L130">    setParams(ruleResponse, ruleDto, result, fieldsToReturn);</span>
<span class="fc" id="L131">    setCreatedAt(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L132">    setUpdatedAt(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L133">    setDescriptionFields(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L134">    setSeverity(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L135">    setInternalKey(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L136">    setLanguage(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L137">    setLanguageName(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L138">    setIsTemplate(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L139">    setIsExternal(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L140">    setTemplateKey(ruleResponse, ruleDto, result, fieldsToReturn);</span>
<span class="fc" id="L141">    setDefaultDebtRemediationFunctionFields(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L142">    setGapDescription(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L143">    setScope(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L144">    setDeprecatedKeys(ruleResponse, ruleDto, fieldsToReturn, deprecatedRuleKeysByRuleUuid);</span>

<span class="fc" id="L146">    setTags(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L147">    setIsRemediationFunctionOverloaded(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">    if (ruleDto.isAdHoc()) {</span>
<span class="fc" id="L149">      setAdHocName(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L150">      setAdHocDescription(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L151">      setAdHocSeverity(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L152">      setAdHocType(ruleResponse, ruleDto);</span>
    }
<span class="fc" id="L154">    setEducationPrinciples(ruleResponse, ruleDto, fieldsToReturn);</span>
<span class="fc" id="L155">    setCleanCodeAttributes(ruleResponse, ruleDto, fieldsToReturn);</span>

<span class="fc" id="L157">    return ruleResponse;</span>
  }

  private static void setImpacts(Rules.Rule.Builder ruleResponse, RuleDto ruleDto) {
<span class="fc" id="L161">    Rules.Impacts.Builder impactsBuilder = Rules.Impacts.newBuilder();</span>
<span class="fc" id="L162">    ruleDto.getDefaultImpacts().forEach(impactDto -&gt; impactsBuilder.addImpacts(toImpact(impactDto)));</span>
<span class="fc" id="L163">    ruleResponse.setImpacts(impactsBuilder.build());</span>
<span class="fc" id="L164">  }</span>

  private static Common.Impact toImpact(ImpactDto impactDto) {
<span class="fc" id="L167">    Common.ImpactSeverity severity = ImpactFormatter.mapImpactSeverity(impactDto.getSeverity());</span>
<span class="fc" id="L168">    Common.SoftwareQuality softwareQuality = Common.SoftwareQuality.valueOf(impactDto.getSoftwareQuality().name());</span>
<span class="fc" id="L169">    return Common.Impact.newBuilder().setSeverity(severity).setSoftwareQuality(softwareQuality).build();</span>
  }

  private static void setAdHocName(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L173">    String adHocName = ruleDto.getAdHocName();</span>
<span class="pc bpc" id="L174" title="1 of 4 branches missed.">    if (adHocName != null &amp;&amp; shouldReturnField(fieldsToReturn, FIELD_NAME)) {</span>
<span class="fc" id="L175">      ruleResponse.setName(adHocName);</span>
    }
<span class="fc" id="L177">  }</span>

  private void setAdHocDescription(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L180">    String adHocDescription = ruleDto.getAdHocDescription();</span>
<span class="pc bpc" id="L181" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_DESCRIPTION_SECTIONS) &amp;&amp; adHocDescription != null) {</span>
<span class="fc" id="L182">      ruleResponse.clearDescriptionSections();</span>
<span class="fc" id="L183">      ruleResponse.getDescriptionSectionsBuilder().addDescriptionSectionsBuilder()</span>
<span class="fc" id="L184">        .setKey(RuleDescriptionSectionDto.DEFAULT_KEY)</span>
<span class="fc" id="L185">        .setContent(macroInterpreter.interpret(adHocDescription));</span>
    }
<span class="fc" id="L187">  }</span>

  private static void setAdHocSeverity(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L190">    String severity = ruleDto.getAdHocSeverity();</span>
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_SEVERITY) &amp;&amp; severity != null) {</span>
<span class="fc" id="L192">      ruleResponse.setSeverity(severity);</span>
    }
<span class="fc" id="L194">  }</span>

  private static void setAdHocType(Rules.Rule.Builder ruleResponse, RuleDto ruleDto) {
<span class="fc" id="L197">    Integer ruleType = ruleDto.getAdHocType();</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">    if (ruleType != null) {</span>
<span class="fc" id="L199">      ruleResponse.setType(Common.RuleType.forNumber(ruleType));</span>
    }
<span class="fc" id="L201">  }</span>

  private static void setRepository(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L204" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_REPO)) {</span>
<span class="fc" id="L205">      ruleResponse.setRepo(ruleDto.getKey().repository());</span>
    }
<span class="fc" id="L207">  }</span>

  private static void setScope(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L210" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_SCOPE)) {</span>
<span class="fc" id="L211">      ruleResponse.setScope(toWsRuleScope(ruleDto.getScope()));</span>
    }
<span class="fc" id="L213">  }</span>

  private static void setEducationPrinciples(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L216" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_EDUCATION_PRINCIPLES)) {</span>
<span class="fc" id="L217">      ruleResponse.getEducationPrinciplesBuilder().addAllEducationPrinciples((ruleDto.getEducationPrinciples()));</span>
    }
<span class="fc" id="L219">  }</span>

  private static void setCleanCodeAttributes(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L222">    CleanCodeAttribute cleanCodeAttribute = ruleDto.getCleanCodeAttribute();</span>
<span class="pc bpc" id="L223" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_CLEAN_CODE_ATTRIBUTE) &amp;&amp; cleanCodeAttribute != null) {</span>
<span class="fc" id="L224">      ruleResponse.setCleanCodeAttribute(Common.CleanCodeAttribute.valueOf(cleanCodeAttribute.name()));</span>
<span class="fc" id="L225">      ruleResponse.setCleanCodeAttributeCategory(Common.CleanCodeAttributeCategory.valueOf(cleanCodeAttribute.getAttributeCategory().name()));</span>
    }
<span class="fc" id="L227">  }</span>

  private static void setDeprecatedKeys(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn,
    Map&lt;String, List&lt;DeprecatedRuleKeyDto&gt;&gt; deprecatedRuleKeysByRuleUuid) {
<span class="fc bfc" id="L231" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_DEPRECATED_KEYS)) {</span>
<span class="fc" id="L232">      List&lt;DeprecatedRuleKeyDto&gt; deprecatedRuleKeyDtos = deprecatedRuleKeysByRuleUuid.get(ruleDto.getUuid());</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">      if (deprecatedRuleKeyDtos == null) {</span>
<span class="fc" id="L234">        return;</span>
      }

<span class="fc" id="L237">      List&lt;String&gt; deprecatedKeys = deprecatedRuleKeyDtos.stream()</span>
<span class="fc" id="L238">        .map(r -&gt; RuleKey.of(r.getOldRepositoryKey(), r.getOldRuleKey()).toString())</span>
<span class="fc" id="L239">        .toList();</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">      if (!deprecatedKeys.isEmpty()) {</span>
<span class="fc" id="L241">        ruleResponse.setDeprecatedKeys(Rules.DeprecatedKeys.newBuilder().addAllDeprecatedKey(deprecatedKeys).build());</span>
      }
    }
<span class="fc" id="L244">  }</span>

  private static RuleScope toWsRuleScope(Scope scope) {
<span class="pc bpc" id="L247" title="3 of 4 branches missed.">    switch (scope) {</span>
      case ALL:
<span class="nc" id="L249">        return RuleScope.ALL;</span>
      case MAIN:
<span class="fc" id="L251">        return RuleScope.MAIN;</span>
      case TEST:
<span class="nc" id="L253">        return RuleScope.TEST;</span>
      default:
<span class="nc" id="L255">        throw new IllegalArgumentException(&quot;Unknown rule scope: &quot; + scope);</span>
    }
  }

  private static void setGapDescription(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L260">    String gapDescription = ruleDto.getGapDescription();</span>
<span class="pc bpc" id="L261" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_GAP_DESCRIPTION) &amp;&amp; gapDescription != null) {</span>
<span class="fc" id="L262">      ruleResponse.setGapDescription(gapDescription);</span>
    }
<span class="fc" id="L264">  }</span>

  private static void setIsRemediationFunctionOverloaded(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L267" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_REM_FUNCTION_OVERLOADED)) {</span>
<span class="fc" id="L268">      ruleResponse.setRemFnOverloaded(isRemediationFunctionOverloaded(ruleDto));</span>
    }
<span class="fc" id="L270">  }</span>

  private static void setDefaultDebtRemediationFunctionFields(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="pc bpc" id="L273" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_DEFAULT_DEBT_REM_FUNCTION) || shouldReturnField(fieldsToReturn, FIELD_DEFAULT_REM_FUNCTION)) {</span>
<span class="fc" id="L274">      DebtRemediationFunction defaultDebtRemediationFunction = defaultDebtRemediationFunction(ruleDto);</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">      if (defaultDebtRemediationFunction != null) {</span>
<span class="fc" id="L276">        String gapMultiplier = defaultDebtRemediationFunction.gapMultiplier();</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        if (gapMultiplier != null) {</span>
<span class="fc" id="L278">          ruleResponse.setDefaultRemFnGapMultiplier(gapMultiplier);</span>
        }
<span class="fc" id="L280">        String baseEffort = defaultDebtRemediationFunction.baseEffort();</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (baseEffort != null) {</span>
<span class="fc" id="L282">          ruleResponse.setDefaultRemFnBaseEffort(baseEffort);</span>
        }
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">        if (defaultDebtRemediationFunction.type() != null) {</span>
<span class="fc" id="L285">          ruleResponse.setDefaultRemFnType(defaultDebtRemediationFunction.type().name());</span>
          // Set deprecated field
<span class="fc" id="L287">          ruleResponse.setDefaultDebtRemFnType(defaultDebtRemediationFunction.type().name());</span>
        }
      }
    }
<span class="fc" id="L291">  }</span>

  private static void setDebtRemediationFunctionFields(Rules.Rule.Builder ruleResponse, RuleDto ruleDto,
    Set&lt;String&gt; fieldsToReturn) {
<span class="pc bpc" id="L295" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_DEBT_REM_FUNCTION) || shouldReturnField(fieldsToReturn, FIELD_REM_FUNCTION)) {</span>
<span class="fc" id="L296">      DebtRemediationFunction debtRemediationFunction = debtRemediationFunction(ruleDto);</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">      if (debtRemediationFunction != null) {</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (debtRemediationFunction.type() != null) {</span>
<span class="fc" id="L299">          ruleResponse.setRemFnType(debtRemediationFunction.type().name());</span>
          // Set deprecated field
<span class="fc" id="L301">          ruleResponse.setDebtRemFnType(debtRemediationFunction.type().name());</span>
        }
<span class="fc" id="L303">        String gapMultiplier = debtRemediationFunction.gapMultiplier();</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (gapMultiplier != null) {</span>
<span class="fc" id="L305">          ruleResponse.setRemFnGapMultiplier(gapMultiplier);</span>
        }
<span class="fc" id="L307">        String baseEffort = debtRemediationFunction.baseEffort();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">        if (baseEffort != null) {</span>
<span class="fc" id="L309">          ruleResponse.setRemFnBaseEffort(baseEffort);</span>
        }
      }
    }
<span class="fc" id="L313">  }</span>

  private static void setName(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L316" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_NAME) &amp;&amp; ruleDto.getName() != null) {</span>
<span class="fc" id="L317">      ruleResponse.setName(ruleDto.getName());</span>
    }
<span class="fc" id="L319">  }</span>

  private static void setStatus(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="pc bpc" id="L322" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_STATUS) &amp;&amp; ruleDto.getStatus() != null) {</span>
<span class="fc" id="L323">      ruleResponse.setStatus(Common.RuleStatus.valueOf(ruleDto.getStatus().toString()));</span>
    }
<span class="fc" id="L325">  }</span>

  private static void setTags(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L328" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_TAGS)) {</span>
<span class="fc" id="L329">      ruleResponse.getTagsBuilder().addAllTags(ruleDto.getTags());</span>
    }
<span class="fc" id="L331">  }</span>

  private static void setSysTags(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L334" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_SYSTEM_TAGS)) {</span>
<span class="fc" id="L335">      ruleResponse.getSysTagsBuilder().addAllSysTags(ruleDto.getSystemTags());</span>
    }
<span class="fc" id="L337">  }</span>

  private static void setParams(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, SearchResult searchResult, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L340" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_PARAMS)) {</span>
<span class="fc" id="L341">      List&lt;RuleParamDto&gt; ruleParameters = searchResult.getRuleParamsByRuleUuid().get(ruleDto.getUuid());</span>
<span class="fc" id="L342">      ruleResponse.getParamsBuilder().addAllParams(ruleParameters.stream().map(RuleParamDtoToWsRuleParam.INSTANCE).toList());</span>
    }
<span class="fc" id="L344">  }</span>

  private static void setCreatedAt(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L347" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_CREATED_AT)) {</span>
<span class="fc" id="L348">      ruleResponse.setCreatedAt(formatDateTime(ruleDto.getCreatedAt()));</span>
    }
<span class="fc" id="L350">  }</span>

  private static void setUpdatedAt(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L353" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_UPDATED_AT)) {</span>
<span class="fc" id="L354">      ruleResponse.setUpdatedAt(formatDateTime(ruleDto.getUpdatedAt()));</span>
    }
<span class="fc" id="L356">  }</span>

  private void setDescriptionFields(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L359" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_DESCRIPTION_SECTIONS)) {</span>
<span class="fc" id="L360">      Set&lt;RuleDescriptionSectionDto&gt; ruleDescriptionSectionDtos = ruleDto.getRuleDescriptionSectionDtos();</span>
<span class="fc" id="L361">      Set&lt;Rules.Rule.DescriptionSection&gt; sections = ruleDescriptionSectionDtos.stream()</span>
<span class="fc" id="L362">        .map(sectionDto -&gt; toDescriptionSection(ruleDto, sectionDto))</span>
<span class="fc" id="L363">        .collect(Collectors.toSet());</span>
<span class="fc" id="L364">      ruleResponse.setDescriptionSections(Rules.Rule.DescriptionSections.newBuilder().addAllDescriptionSections(sections).build());</span>
    }

<span class="fc bfc" id="L367" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_MARKDOWN_DESCRIPTION) &amp;&amp; MARKDOWN.equals(ruleDto.getDescriptionFormat())) {</span>
<span class="fc" id="L368">      Optional.ofNullable(ruleDto.getDefaultRuleDescriptionSection())</span>
<span class="fc" id="L369">        .map(RuleDescriptionSectionDto::getContent)</span>
<span class="fc" id="L370">        .ifPresent(ruleResponse::setMdDesc);</span>
    }
<span class="fc" id="L372">  }</span>

  private Rules.Rule.DescriptionSection toDescriptionSection(RuleDto ruleDto, RuleDescriptionSectionDto section) {
<span class="fc" id="L375">    String htmlContent = ruleDescriptionFormatter.toHtml(ruleDto.getDescriptionFormat(), section);</span>
<span class="fc" id="L376">    String interpretedHtmlContent = macroInterpreter.interpret(htmlContent);</span>

<span class="fc" id="L378">    Rules.Rule.DescriptionSection.Builder sectionBuilder = Rules.Rule.DescriptionSection.newBuilder()</span>
<span class="fc" id="L379">      .setKey(section.getKey())</span>
<span class="fc" id="L380">      .setContent(interpretedHtmlContent);</span>
<span class="fc" id="L381">    toProtobufContext(section.getContext()).ifPresent(sectionBuilder::setContext);</span>

<span class="fc" id="L383">    return sectionBuilder.build();</span>
  }

  private void setNotesFields(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Map&lt;String, UserDto&gt; usersByUuid, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L387">    String noteData = ruleDto.getNoteData();</span>
<span class="fc bfc" id="L388" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, &quot;htmlNote&quot;) &amp;&amp; noteData != null) {</span>
<span class="fc" id="L389">      ruleResponse.setHtmlNote(macroInterpreter.interpret(Markdown.convertToHtml(noteData)));</span>
    }
<span class="fc bfc" id="L391" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, &quot;mdNote&quot;) &amp;&amp; noteData != null) {</span>
<span class="fc" id="L392">      ruleResponse.setMdNote(noteData);</span>
    }
<span class="fc" id="L394">    String userUuid = ruleDto.getNoteUserUuid();</span>
<span class="fc bfc" id="L395" title="All 6 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_NOTE_LOGIN) &amp;&amp; userUuid != null &amp;&amp; usersByUuid.containsKey(userUuid)) {</span>
<span class="fc" id="L396">      ruleResponse.setNoteLogin(usersByUuid.get(userUuid).getLogin());</span>
    }
<span class="fc" id="L398">  }</span>

  private static void setSeverity(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L401">    String severity = ruleDto.getSeverityString();</span>
<span class="fc bfc" id="L402" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_SEVERITY) &amp;&amp; severity != null) {</span>
<span class="fc" id="L403">      ruleResponse.setSeverity(severity);</span>
    }
<span class="fc" id="L405">  }</span>

  private static void setInternalKey(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L408" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_INTERNAL_KEY) &amp;&amp; ruleDto.getConfigKey() != null) {</span>
<span class="fc" id="L409">      ruleResponse.setInternalKey(ruleDto.getConfigKey());</span>
    }
<span class="fc" id="L411">  }</span>

  private static void setLanguage(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L414">    String language = ruleDto.getLanguage();</span>
<span class="pc bpc" id="L415" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_LANGUAGE) &amp;&amp; language != null) {</span>
<span class="fc" id="L416">      ruleResponse.setLang(language);</span>
    }
<span class="fc" id="L418">  }</span>

  private void setLanguageName(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc" id="L421">    String languageKey = ruleDto.getLanguage();</span>
<span class="pc bpc" id="L422" title="1 of 4 branches missed.">    if (shouldReturnField(fieldsToReturn, FIELD_LANGUAGE_NAME) &amp;&amp; languageKey != null) {</span>
<span class="fc" id="L423">      Language language = languages.get(languageKey);</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">      ruleResponse.setLangName(language == null ? languageKey : language.getName());</span>
    }
<span class="fc" id="L426">  }</span>

  private static void setIsTemplate(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L429" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_IS_TEMPLATE)) {</span>
<span class="fc" id="L430">      ruleResponse.setIsTemplate(ruleDto.isTemplate());</span>
    }
<span class="fc" id="L432">  }</span>

  private static void setIsExternal(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L435" title="All 2 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_IS_EXTERNAL)) {</span>
<span class="fc" id="L436">      ruleResponse.setIsExternal(ruleDto.isExternal());</span>
    }
<span class="fc" id="L438">  }</span>

  private static void setTemplateKey(Rules.Rule.Builder ruleResponse, RuleDto ruleDto, SearchResult result, Set&lt;String&gt; fieldsToReturn) {
<span class="fc bfc" id="L441" title="All 4 branches covered.">    if (shouldReturnField(fieldsToReturn, FIELD_TEMPLATE_KEY) &amp;&amp; ruleDto.isCustomRule()) {</span>
<span class="fc" id="L442">      RuleDto templateRule = result.getTemplateRulesByRuleUuid().get(ruleDto.getTemplateUuid());</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">      if (templateRule != null) {</span>
<span class="fc" id="L444">        ruleResponse.setTemplateKey(templateRule.getKey().toString());</span>
      }
    }
<span class="fc" id="L447">  }</span>

  public static boolean shouldReturnField(Set&lt;String&gt; fieldsToReturn, String fieldName) {
<span class="fc bfc" id="L450" title="All 4 branches covered.">    return fieldsToReturn.isEmpty() || fieldsToReturn.contains(fieldName);</span>
  }

  private static Optional&lt;Rules.Rule.DescriptionSection.Context&gt; toProtobufContext(@Nullable RuleDescriptionSectionContextDto context) {
<span class="fc" id="L454">    return Optional.ofNullable(context)</span>
<span class="fc" id="L455">      .map(c -&gt; newBuilder()</span>
<span class="fc" id="L456">        .setKey(c.getKey())</span>
<span class="fc" id="L457">        .setDisplayName(c.getDisplayName())</span>
<span class="fc" id="L458">        .build());</span>
  }

  private static boolean isRemediationFunctionOverloaded(RuleDto rule) {
<span class="fc bfc" id="L462" title="All 2 branches covered.">    return rule.getRemediationFunction() != null;</span>
  }

  @CheckForNull
  private static DebtRemediationFunction defaultDebtRemediationFunction(final RuleDto ruleDto) {
<span class="fc" id="L467">    final String function = ruleDto.getDefRemediationFunction();</span>
<span class="pc bpc" id="L468" title="1 of 4 branches missed.">    if (function == null || function.isEmpty()) {</span>
<span class="fc" id="L469">      return null;</span>
    } else {
<span class="fc" id="L471">      return new DefaultDebtRemediationFunction(</span>
<span class="fc" id="L472">        DebtRemediationFunction.Type.valueOf(function.toUpperCase(Locale.ENGLISH)),</span>
<span class="fc" id="L473">        ruleDto.getDefRemediationGapMultiplier(),</span>
<span class="fc" id="L474">        ruleDto.getDefRemediationBaseEffort());</span>
    }
  }

  @CheckForNull
  private static DebtRemediationFunction debtRemediationFunction(RuleDto ruleDto) {
<span class="fc" id="L480">    final String function = ruleDto.getRemediationFunction();</span>
<span class="pc bpc" id="L481" title="1 of 4 branches missed.">    if (function == null || function.isEmpty()) {</span>
<span class="fc" id="L482">      return defaultDebtRemediationFunction(ruleDto);</span>
    } else {
<span class="fc" id="L484">      return new DefaultDebtRemediationFunction(</span>
<span class="fc" id="L485">        DebtRemediationFunction.Type.valueOf(function.toUpperCase(Locale.ENGLISH)),</span>
<span class="fc" id="L486">        ruleDto.getRemediationGapMultiplier(),</span>
<span class="fc" id="L487">        ruleDto.getRemediationBaseEffort());</span>
    }
  }

<span class="fc" id="L491">  private enum RuleParamDtoToWsRuleParam implements Function&lt;RuleParamDto, Rules.Rule.Param&gt; {</span>
<span class="fc" id="L492">    INSTANCE;</span>

    @Override
    public Rules.Rule.Param apply(RuleParamDto param) {
<span class="fc" id="L496">      Rules.Rule.Param.Builder paramResponse = Rules.Rule.Param.newBuilder();</span>
<span class="fc" id="L497">      paramResponse.setKey(param.getName());</span>
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">      if (param.getDescription() != null) {</span>
<span class="fc" id="L499">        paramResponse.setHtmlDesc(Markdown.convertToHtml(param.getDescription()));</span>
      }
<span class="fc" id="L501">      String defaultValue = param.getDefaultValue();</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">      if (defaultValue != null) {</span>
<span class="fc" id="L503">        paramResponse.setDefaultValue(defaultValue);</span>
      }
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">      if (param.getType() != null) {</span>
<span class="fc" id="L506">        paramResponse.setType(param.getType());</span>
      }

<span class="fc" id="L509">      return paramResponse.build();</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>