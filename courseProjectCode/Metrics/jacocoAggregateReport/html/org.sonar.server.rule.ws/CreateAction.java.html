<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreateAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">CreateAction.java</span></div><h1>CreateAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import com.google.common.io.Resources;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.rule.Severity;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.core.rule.RuleType;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.utils.KeyValueFormat;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.server.common.rule.ReactivationException;
import org.sonar.server.common.rule.service.NewCustomRule;
import org.sonar.server.common.rule.service.RuleInformation;
import org.sonar.server.common.rule.service.RuleService;
import org.sonarqube.ws.Rules;

import static com.google.common.base.Strings.isNullOrEmpty;
import static java.net.HttpURLConnection.HTTP_CONFLICT;
import static java.util.Collections.singletonList;
import static java.util.Optional.ofNullable;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

public class CreateAction implements RulesWsAction {

  public static final String PARAM_CUSTOM_KEY = &quot;customKey&quot;;
  public static final String PARAM_NAME = &quot;name&quot;;
  public static final String PARAM_DESCRIPTION = &quot;markdownDescription&quot;;
  public static final String PARAM_SEVERITY = &quot;severity&quot;;
  public static final String PARAM_STATUS = &quot;status&quot;;
  public static final String PARAM_TEMPLATE_KEY = &quot;templateKey&quot;;
  public static final String PARAM_TYPE = &quot;type&quot;;
  private static final String PARAM_IMPACTS = &quot;impacts&quot;;
  private static final String PARAM_CLEAN_CODE_ATTRIBUTE = &quot;cleanCodeAttribute&quot;;
  public static final String PARAMS = &quot;params&quot;;

  static final int KEY_MAXIMUM_LENGTH = 200;
  static final int NAME_MAXIMUM_LENGTH = 200;

  /**
   * @deprecated since 10.4
   */
  @Deprecated(since = &quot;10.4&quot;)
  private static final String PARAM_PREVENT_REACTIVATION = &quot;preventReactivation&quot;;

  private final DbClient dbClient;
  private final RuleService ruleService;
  private final RuleMapper ruleMapper;
  private final RuleWsSupport ruleWsSupport;

<span class="fc" id="L82">  public CreateAction(DbClient dbClient, RuleService ruleService, RuleMapper ruleMapper, RuleWsSupport ruleWsSupport) {</span>
<span class="fc" id="L83">    this.dbClient = dbClient;</span>
<span class="fc" id="L84">    this.ruleService = ruleService;</span>
<span class="fc" id="L85">    this.ruleMapper = ruleMapper;</span>
<span class="fc" id="L86">    this.ruleWsSupport = ruleWsSupport;</span>
<span class="fc" id="L87">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L91">    WebService.NewAction action = controller</span>
<span class="fc" id="L92">      .createAction(&quot;create&quot;)</span>
<span class="fc" id="L93">      .setPost(true)</span>
<span class="fc" id="L94">      .setDescription(&quot;Create a custom rule.&lt;br&gt;&quot; +</span>
        &quot;Requires the 'Administer Quality Profiles' permission&quot;)
<span class="fc" id="L96">      .setResponseExample(Resources.getResource(getClass(), &quot;create-example.json&quot;))</span>
<span class="fc" id="L97">      .setSince(&quot;4.4&quot;)</span>
<span class="fc" id="L98">      .setChangelog(</span>
        new Change(&quot;5.5&quot;, &quot;Creating manual rule is not more possible&quot;),
        new Change(&quot;10.0&quot;, &quot;Drop deprecated keys: 'custom_key', 'template_key', 'markdown_description', 'prevent_reactivation'&quot;),
        new Change(&quot;10.2&quot;, &quot;Add 'impacts', 'cleanCodeAttribute', 'cleanCodeAttributeCategory' fields to the response&quot;),
        new Change(&quot;10.2&quot;, &quot;Fields 'type' and 'severity' are deprecated in the response. Use 'impacts' instead.&quot;),
<span class="fc" id="L103">        new Change(&quot;10.4&quot;, String.format(&quot;Add '%s' and '%s' parameters to the request&quot;, PARAM_IMPACTS, PARAM_CLEAN_CODE_ATTRIBUTE)),</span>
<span class="fc" id="L104">        new Change(&quot;10.4&quot;, String.format(&quot;Parameters '%s' and '%s' are deprecated. Use '%s' instead.&quot;, PARAM_TYPE, PARAM_SEVERITY, PARAM_IMPACTS)),</span>
<span class="fc" id="L105">        new Change(&quot;10.4&quot;, String.format(&quot;Parameter '%s' is deprecated. Use api/rules/update endpoint instead.&quot;, PARAM_PREVENT_REACTIVATION)),</span>
<span class="fc" id="L106">        new Change(&quot;10.8&quot;, String.format(&quot;The parameters '%s' and '%s' are not deprecated anymore.&quot;, PARAM_TYPE, PARAM_SEVERITY)))</span>
<span class="fc" id="L107">      .setHandler(this);</span>

<span class="fc" id="L109">    action</span>
<span class="fc" id="L110">      .createParam(PARAM_CUSTOM_KEY)</span>
<span class="fc" id="L111">      .setRequired(true)</span>
<span class="fc" id="L112">      .setMaximumLength(KEY_MAXIMUM_LENGTH)</span>
<span class="fc" id="L113">      .setDescription(&quot;Key of the custom rule&quot;)</span>
<span class="fc" id="L114">      .setExampleValue(&quot;Todo_should_not_be_used&quot;);</span>

<span class="fc" id="L116">    action</span>
<span class="fc" id="L117">      .createParam(PARAM_TEMPLATE_KEY)</span>
<span class="fc" id="L118">      .setRequired(true)</span>
<span class="fc" id="L119">      .setDescription(&quot;Key of the template rule in order to create a custom rule&quot;)</span>
<span class="fc" id="L120">      .setExampleValue(&quot;java:XPath&quot;);</span>

<span class="fc" id="L122">    action</span>
<span class="fc" id="L123">      .createParam(PARAM_NAME)</span>
<span class="fc" id="L124">      .setRequired(true)</span>
<span class="fc" id="L125">      .setMaximumLength(NAME_MAXIMUM_LENGTH)</span>
<span class="fc" id="L126">      .setDescription(&quot;Rule name&quot;)</span>
<span class="fc" id="L127">      .setExampleValue(&quot;My custom rule&quot;);</span>

<span class="fc" id="L129">    action</span>
<span class="fc" id="L130">      .createParam(PARAM_DESCRIPTION)</span>
<span class="fc" id="L131">      .setRequired(true)</span>
<span class="fc" id="L132">      .setDescription(&quot;Rule description in &lt;a href='/formatting/help'&gt;markdown format&lt;/a&gt;&quot;)</span>
<span class="fc" id="L133">      .setExampleValue(&quot;Description of my custom rule&quot;);</span>

<span class="fc" id="L135">    action</span>
<span class="fc" id="L136">      .createParam(PARAM_SEVERITY)</span>
<span class="fc" id="L137">      .setPossibleValues(Severity.ALL)</span>
<span class="fc" id="L138">      .setDescription(&quot;Rule severity&quot;);</span>
<span class="fc" id="L139">    action</span>
<span class="fc" id="L140">      .createParam(PARAM_STATUS)</span>
<span class="fc" id="L141">      .setPossibleValues(</span>
<span class="fc" id="L142">        Arrays.stream(RuleStatus.values())</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">          .filter(status -&gt; !RuleStatus.REMOVED.equals(status))</span>
<span class="fc" id="L144">          .toList())</span>
<span class="fc" id="L145">      .setDefaultValue(RuleStatus.READY)</span>
<span class="fc" id="L146">      .setDescription(&quot;Rule status&quot;);</span>

<span class="fc" id="L148">    action.createParam(PARAMS)</span>
<span class="fc" id="L149">      .setDescription(&quot;Parameters as semi-colon list of &amp;lt;key&amp;gt;=&amp;lt;value&amp;gt;&quot;)</span>
<span class="fc" id="L150">      .setExampleValue(&quot;key1=v1;key2=v2&quot;);</span>

<span class="fc" id="L152">    action</span>
<span class="fc" id="L153">      .createParam(PARAM_PREVENT_REACTIVATION)</span>
<span class="fc" id="L154">      .setDeprecatedSince(&quot;10.4&quot;)</span>
<span class="fc" id="L155">      .setBooleanPossibleValues()</span>
<span class="fc" id="L156">      .setDefaultValue(false)</span>
<span class="fc" id="L157">      .setDescription(&quot;If set to true and if the rule has been deactivated (status 'REMOVED'), a status 409 will be returned&quot;);</span>

<span class="fc" id="L159">    action.createParam(PARAM_TYPE)</span>
<span class="fc" id="L160">      .setPossibleValues(RuleType.names())</span>
<span class="fc" id="L161">      .setDescription(&quot;Rule type&quot;)</span>
<span class="fc" id="L162">      .setSince(&quot;6.7&quot;);</span>

<span class="fc" id="L164">    action.createParam(PARAM_CLEAN_CODE_ATTRIBUTE)</span>
<span class="fc" id="L165">      .setDescription(&quot;Clean code attribute&quot;)</span>
<span class="fc" id="L166">      .setPossibleValues(CleanCodeAttribute.values())</span>
<span class="fc" id="L167">      .setSince(&quot;10.4&quot;);</span>

<span class="fc" id="L169">    action.createParam(PARAM_IMPACTS)</span>
<span class="fc" id="L170">      .setDescription(&quot;Impacts as semi-colon list of &amp;lt;software_quality&amp;gt;=&amp;lt;severity&amp;gt;&quot;)</span>
<span class="fc" id="L171">      .setExampleValue(&quot;SECURITY=HIGH;MAINTAINABILITY=LOW&quot;)</span>
<span class="fc" id="L172">      .setSince(&quot;10.4&quot;);</span>
<span class="fc" id="L173">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L177">    ruleWsSupport.checkQProfileAdminPermission();</span>
<span class="fc" id="L178">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
      try {
<span class="fc" id="L180">        NewCustomRule newCustomRule = toNewCustomRule(request);</span>
<span class="fc" id="L181">        RuleInformation customRule = ruleService.createCustomRule(newCustomRule, dbSession);</span>
<span class="fc" id="L182">        writeResponse(dbSession, request, response, customRule.ruleDto(), customRule.params());</span>
<span class="fc" id="L183">      } catch (ReactivationException e) {</span>
<span class="fc" id="L184">        response.stream().setStatus(HTTP_CONFLICT);</span>
<span class="fc" id="L185">        writeResponse(dbSession, request, response, e.ruleKey());</span>
<span class="fc" id="L186">      }</span>
    }
<span class="fc" id="L188">  }</span>

  private static NewCustomRule toNewCustomRule(Request request) {
<span class="fc" id="L191">    RuleKey templateKey = RuleKey.parse(request.mandatoryParam(PARAM_TEMPLATE_KEY));</span>
<span class="fc" id="L192">    NewCustomRule newRule = NewCustomRule.createForCustomRule(</span>
<span class="fc" id="L193">      RuleKey.of(templateKey.repository(), request.mandatoryParam(PARAM_CUSTOM_KEY)), templateKey)</span>
<span class="fc" id="L194">      .setName(request.mandatoryParam(PARAM_NAME))</span>
<span class="fc" id="L195">      .setMarkdownDescription(request.mandatoryParam(PARAM_DESCRIPTION))</span>
<span class="fc" id="L196">      .setStatus(RuleStatus.valueOf(request.mandatoryParam(PARAM_STATUS)))</span>
<span class="fc" id="L197">      .setPreventReactivation(request.mandatoryParamAsBoolean(PARAM_PREVENT_REACTIVATION))</span>
<span class="fc" id="L198">      .setSeverity(request.param(PARAM_SEVERITY))</span>
<span class="fc" id="L199">      .setType(ofNullable(request.param(PARAM_TYPE)).map(RuleType::valueOf).orElse(null))</span>
<span class="fc" id="L200">      .setCleanCodeAttribute(ofNullable(request.param(PARAM_CLEAN_CODE_ATTRIBUTE)).map(CleanCodeAttribute::valueOf).orElse(null));</span>
<span class="fc" id="L201">    String params = request.param(PARAMS);</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">    if (!isNullOrEmpty(params)) {</span>
<span class="fc" id="L203">      newRule.setParameters(KeyValueFormat.parse(params));</span>
    }
<span class="fc" id="L205">    String impacts = request.param(PARAM_IMPACTS);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">    if (!isNullOrEmpty(impacts)) {</span>
<span class="fc" id="L207">      newRule.setImpacts(KeyValueFormat.parse(impacts).entrySet().stream()</span>
<span class="fc" id="L208">        .map(e -&gt; new NewCustomRule.Impact(SoftwareQuality.valueOf(e.getKey()), org.sonar.api.issue.impact.Severity.valueOf(e.getValue())))</span>
<span class="fc" id="L209">        .toList());</span>
    }
<span class="fc" id="L211">    return newRule;</span>
  }

  private void writeResponse(DbSession dbSession, Request request, Response response, RuleDto rule, List&lt;RuleParamDto&gt; params) {
<span class="fc" id="L215">    writeProtobuf(createResponse(dbSession, rule, params), request, response);</span>
<span class="fc" id="L216">  }</span>

  private void writeResponse(DbSession dbSession, Request request, Response response, RuleKey ruleKey) {
<span class="fc" id="L219">    RuleDto rule = dbClient.ruleDao().selectByKey(dbSession, ruleKey)</span>
<span class="pc" id="L220">      .orElseThrow(() -&gt; new IllegalStateException(String.format(&quot;Cannot load rule, that has just been created '%s'&quot;, ruleKey)));</span>
<span class="fc" id="L221">    List&lt;RuleParamDto&gt; ruleParameters = dbClient.ruleDao().selectRuleParamsByRuleUuids(dbSession, singletonList(rule.getUuid()));</span>
<span class="fc" id="L222">    writeProtobuf(createResponse(dbSession, rule, ruleParameters), request, response);</span>
<span class="fc" id="L223">  }</span>

  private Rules.CreateResponse createResponse(DbSession dbSession, RuleDto rule, List&lt;RuleParamDto&gt; params) {
<span class="fc" id="L226">    List&lt;RuleDto&gt; templateRules = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (rule.isCustomRule()) {</span>
<span class="fc" id="L228">      Optional&lt;RuleDto&gt; templateRule = dbClient.ruleDao().selectByUuid(rule.getTemplateUuid(), dbSession);</span>
<span class="fc" id="L229">      templateRule.ifPresent(templateRules::add);</span>
    }

<span class="fc" id="L232">    RulesResponseFormatter.SearchResult searchResult = new RulesResponseFormatter.SearchResult()</span>
<span class="fc" id="L233">      .setRuleParameters(params)</span>
<span class="fc" id="L234">      .setTemplateRules(templateRules)</span>
<span class="fc" id="L235">      .setTotal(1L);</span>
<span class="fc" id="L236">    return Rules.CreateResponse.newBuilder()</span>
<span class="fc" id="L237">      .setRule(ruleMapper.toWsRule(rule, searchResult, Collections.emptySet()))</span>
<span class="fc" id="L238">      .build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>