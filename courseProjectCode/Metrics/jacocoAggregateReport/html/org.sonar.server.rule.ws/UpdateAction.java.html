<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UpdateAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.rule.ws</a> &gt; <span class="el_source">UpdateAction.java</span></div><h1>UpdateAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.rule.ws;

import com.google.common.base.Splitter;
import com.google.common.io.Resources;
import java.util.ArrayList;
import java.util.Collections;
import java.util.EnumMap;
import java.util.List;
import java.util.Map;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.RuleKey;
import org.sonar.api.rule.RuleStatus;
import org.sonar.api.rule.Severity;
import org.sonar.api.server.debt.DebtRemediationFunction;
import org.sonar.api.server.debt.internal.DefaultDebtRemediationFunction;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.utils.KeyValueFormat;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.rule.RuleDto;
import org.sonar.db.rule.RuleParamDto;
import org.sonar.server.exceptions.NotFoundException;
import org.sonar.server.rule.RuleUpdate;
import org.sonar.server.rule.RuleUpdater;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Rules.UpdateResponse;

import static com.google.common.collect.Sets.newHashSet;
import static java.lang.String.format;
import static java.util.Collections.emptyMap;
import static java.util.Collections.singletonList;
import static java.util.Optional.ofNullable;
import static org.sonar.server.common.ParamParsingUtils.parseImpact;
import static org.sonar.server.rule.ws.CreateAction.KEY_MAXIMUM_LENGTH;
import static org.sonar.server.rule.ws.CreateAction.NAME_MAXIMUM_LENGTH;
import static org.sonar.server.ws.WsUtils.writeProtobuf;

public class UpdateAction implements RulesWsAction {

  public static final String PARAM_KEY = &quot;key&quot;;
  public static final String PARAM_TAGS = &quot;tags&quot;;
  public static final String PARAM_MARKDOWN_NOTE = &quot;markdown_note&quot;;
  public static final String PARAM_REMEDIATION_FN_TYPE = &quot;remediation_fn_type&quot;;
  public static final String PARAM_REMEDIATION_FN_BASE_EFFORT = &quot;remediation_fn_base_effort&quot;;
  public static final String PARAM_REMEDIATION_FN_GAP_MULTIPLIER = &quot;remediation_fy_gap_multiplier&quot;;
  public static final String PARAM_NAME = &quot;name&quot;;
  public static final String PARAM_DESCRIPTION = &quot;markdownDescription&quot;;
  public static final String PARAM_SEVERITY = &quot;severity&quot;;
  public static final String PARAM_IMPACTS = &quot;impacts&quot;;
  public static final String PARAM_STATUS = &quot;status&quot;;
  public static final String PARAMS = &quot;params&quot;;

  private final DbClient dbClient;
  private final RuleUpdater ruleUpdater;
  private final RuleMapper mapper;
  private final UserSession userSession;
  private final RuleWsSupport ruleWsSupport;

<span class="fc" id="L83">  public UpdateAction(DbClient dbClient, RuleUpdater ruleUpdater, RuleMapper mapper, UserSession userSession, RuleWsSupport ruleWsSupport) {</span>
<span class="fc" id="L84">    this.dbClient = dbClient;</span>
<span class="fc" id="L85">    this.ruleUpdater = ruleUpdater;</span>
<span class="fc" id="L86">    this.mapper = mapper;</span>
<span class="fc" id="L87">    this.userSession = userSession;</span>
<span class="fc" id="L88">    this.ruleWsSupport = ruleWsSupport;</span>
<span class="fc" id="L89">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L93">    WebService.NewAction action = controller</span>
<span class="fc" id="L94">      .createAction(&quot;update&quot;)</span>
<span class="fc" id="L95">      .setPost(true)</span>
<span class="fc" id="L96">      .setResponseExample(Resources.getResource(getClass(), &quot;update-example.json&quot;))</span>
<span class="fc" id="L97">      .setDescription(&quot;Update an existing rule.&lt;br&gt;&quot; +</span>
        &quot;Requires the 'Administer Quality Profiles' permission&quot;)
<span class="fc" id="L99">      .setChangelog(</span>
<span class="fc" id="L100">        new Change(&quot;10.8&quot;, String.format(&quot;Parameter %s was added.&quot;, PARAM_IMPACTS)),</span>
<span class="fc" id="L101">        new Change(&quot;10.8&quot;, String.format(&quot;The parameter '%s' is not deprecated anymore.&quot;, PARAM_SEVERITY)),</span>
        new Change(&quot;10.8&quot;, &quot;The field 'severity' and 'type' in the response are not deprecated anymore.&quot;),
<span class="fc" id="L103">        new Change(&quot;10.4&quot;, String.format(&quot;The parameter '%s' is deprecated.&quot;, PARAM_SEVERITY)),</span>
        new Change(&quot;10.4&quot;, &quot;Updating a removed rule is now possible.&quot;),
        new Change(&quot;10.2&quot;, &quot;The field 'severity' and 'type' in the response have been deprecated, use 'impacts' instead.&quot;),
        new Change(&quot;10.2&quot;, &quot;Add 'impacts', 'cleanCodeAttribute', 'cleanCodeAttributeCategory' fields to the response&quot;))
<span class="fc" id="L107">      .setSince(&quot;4.4&quot;)</span>
<span class="fc" id="L108">      .setHandler(this);</span>

<span class="fc" id="L110">    action.createParam(PARAM_KEY)</span>
<span class="fc" id="L111">      .setRequired(true)</span>
<span class="fc" id="L112">      .setMaximumLength(KEY_MAXIMUM_LENGTH)</span>
<span class="fc" id="L113">      .setDescription(&quot;Key of the rule to update&quot;)</span>
<span class="fc" id="L114">      .setExampleValue(&quot;javascript:NullCheck&quot;);</span>

<span class="fc" id="L116">    action.createParam(PARAM_TAGS)</span>
<span class="fc" id="L117">      .setDescription(&quot;Optional comma-separated list of tags to set. Use blank value to remove current tags. Tags &quot; +</span>
        &quot;are not changed if the parameter is not set.&quot;)
<span class="fc" id="L119">      .setExampleValue(&quot;java8,security&quot;);</span>

<span class="fc" id="L121">    action.createParam(PARAM_MARKDOWN_NOTE)</span>
<span class="fc" id="L122">      .setDescription(&quot;Optional note in &lt;a href='/formatting/help'&gt;markdown format&lt;/a&gt;. Use empty value to remove current note. Note is not changed &quot; +</span>
        &quot;if the parameter is not set.&quot;)
<span class="fc" id="L124">      .setExampleValue(&quot;my *note*&quot;);</span>

<span class="fc" id="L126">    action.createParam(PARAM_REMEDIATION_FN_TYPE)</span>
<span class="fc" id="L127">      .setDescription(&quot;Type of the remediation function of the rule&quot;)</span>
<span class="fc" id="L128">      .setPossibleValues(DebtRemediationFunction.Type.values())</span>
<span class="fc" id="L129">      .setSince(&quot;5.5&quot;);</span>

<span class="fc" id="L131">    action.createParam(PARAM_REMEDIATION_FN_BASE_EFFORT)</span>
<span class="fc" id="L132">      .setDescription(&quot;Base effort of the remediation function of the rule&quot;)</span>
<span class="fc" id="L133">      .setExampleValue(&quot;1d&quot;)</span>
<span class="fc" id="L134">      .setSince(&quot;5.5&quot;);</span>

<span class="fc" id="L136">    action.createParam(PARAM_REMEDIATION_FN_GAP_MULTIPLIER)</span>
<span class="fc" id="L137">      .setDescription(&quot;Gap multiplier of the remediation function of the rule&quot;)</span>
<span class="fc" id="L138">      .setExampleValue(&quot;3min&quot;)</span>
<span class="fc" id="L139">      .setSince(&quot;5.5&quot;);</span>

<span class="fc" id="L141">    action</span>
<span class="fc" id="L142">      .createParam(PARAM_NAME)</span>
<span class="fc" id="L143">      .setMaximumLength(NAME_MAXIMUM_LENGTH)</span>
<span class="fc" id="L144">      .setDescription(&quot;Rule name (mandatory for custom rule)&quot;)</span>
<span class="fc" id="L145">      .setExampleValue(&quot;My custom rule&quot;);</span>

<span class="fc" id="L147">    action</span>
<span class="fc" id="L148">      .createParam(PARAM_DESCRIPTION)</span>
<span class="fc" id="L149">      .setDescription(&quot;Rule description (mandatory for custom rule and manual rule) in &lt;a href='/formatting/help'&gt;markdown format&lt;/a&gt;&quot;)</span>
<span class="fc" id="L150">      .setExampleValue(&quot;Description of my custom rule&quot;)</span>
<span class="fc" id="L151">      .setDeprecatedKey(&quot;markdown_description&quot;, &quot;10.2&quot;);</span>

<span class="fc" id="L153">    action</span>
<span class="fc" id="L154">      .createParam(PARAM_SEVERITY)</span>
<span class="fc" id="L155">      .setDescription(&quot;Rule severity (Only when updating a custom rule)&quot;)</span>
<span class="fc" id="L156">      .setPossibleValues(Severity.ALL);</span>

<span class="fc" id="L158">    action</span>
<span class="fc" id="L159">      .createParam(PARAM_IMPACTS)</span>
<span class="fc" id="L160">      .setDescription(&quot;Rule impacts, semicolon-separated (Only when updating a custom rule impact severity)&quot;)</span>
<span class="fc" id="L161">      .setExampleValue(&quot;MAINTAINABILITY=HIGH;SECURITY=LOW&quot;);</span>

<span class="fc" id="L163">    action</span>
<span class="fc" id="L164">      .createParam(PARAM_STATUS)</span>
<span class="fc" id="L165">      .setPossibleValues(RuleStatus.values())</span>
<span class="fc" id="L166">      .setDescription(&quot;Rule status (Only when updating a custom rule)&quot;);</span>

<span class="fc" id="L168">    action.createParam(PARAMS)</span>
<span class="fc" id="L169">      .setDescription(&quot;Parameters as semi-colon list of &lt;key&gt;=&lt;value&gt;, for example 'params=key1=v1;key2=v2' (Only when updating a custom rule)&quot;);</span>
<span class="fc" id="L170">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L174">    userSession.checkLoggedIn();</span>
<span class="fc" id="L175">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L176">      ruleWsSupport.checkQProfileAdminPermission();</span>
<span class="fc" id="L177">      RuleUpdate update = readRequest(dbSession, request);</span>
<span class="fc" id="L178">      ruleUpdater.update(dbSession, update, userSession);</span>
<span class="fc" id="L179">      UpdateResponse updateResponse = buildResponse(dbSession, update.getRuleKey());</span>

<span class="fc" id="L181">      writeProtobuf(updateResponse, request, response);</span>
    }
<span class="fc" id="L183">  }</span>

  private RuleUpdate readRequest(DbSession dbSession, Request request) {
<span class="fc" id="L186">    RuleKey key = RuleKey.parse(request.mandatoryParam(PARAM_KEY));</span>
<span class="fc" id="L187">    RuleUpdate update = createRuleUpdate(dbSession, key);</span>
<span class="fc" id="L188">    readTags(request, update);</span>
<span class="fc" id="L189">    readMarkdownNote(request, update);</span>
<span class="fc" id="L190">    readDebt(request, update);</span>

<span class="fc" id="L192">    String name = request.param(PARAM_NAME);</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">    if (name != null) {</span>
<span class="fc" id="L194">      update.setName(name);</span>
    }
<span class="fc" id="L196">    String description = request.param(PARAM_DESCRIPTION);</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">    if (description != null) {</span>
<span class="fc" id="L198">      update.setMarkdownDescription(description);</span>
    }
<span class="fc" id="L200">    String severity = request.param(PARAM_SEVERITY);</span>
<span class="fc" id="L201">    String impacts = request.param(PARAM_IMPACTS);</span>
<span class="pc bpc" id="L202" title="1 of 4 branches missed.">    if (impacts != null &amp;&amp; severity != null) {</span>
<span class="nc" id="L203">      throw new IllegalArgumentException(&quot;Both 'severity' and 'impacts' parameters cannot be set at the same time&quot;);</span>
    }
<span class="fc bfc" id="L205" title="All 2 branches covered.">    if (impacts != null) {</span>
<span class="fc" id="L206">      Map&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; parsedImpact = parseImpacts(impacts);</span>
<span class="fc" id="L207">      update.setImpactSeverities(parsedImpact);</span>
    }
<span class="fc bfc" id="L209" title="All 2 branches covered.">    if (severity != null) {</span>
<span class="fc" id="L210">      update.setSeverity(severity);</span>
    }
<span class="fc" id="L212">    String status = request.param(PARAM_STATUS);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">    if (status != null) {</span>
<span class="fc" id="L214">      update.setStatus(RuleStatus.valueOf(status));</span>
    }
<span class="fc" id="L216">    String params = request.param(PARAMS);</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">    if (params != null) {</span>
<span class="fc" id="L218">      update.setParameters(KeyValueFormat.parse(params));</span>
    }
<span class="fc" id="L220">    return update;</span>
  }

  private RuleUpdate createRuleUpdate(DbSession dbSession, RuleKey key) {
<span class="fc" id="L224">    RuleDto rule = dbClient.ruleDao().selectByKey(dbSession, key)</span>
<span class="pc" id="L225">      .orElseThrow(() -&gt; new NotFoundException(format(&quot;This rule does not exist: %s&quot;, key)));</span>
<span class="fc" id="L226">    return ofNullable(rule.getTemplateUuid())</span>
<span class="fc" id="L227">      .map(x -&gt; RuleUpdate.createForCustomRule(key))</span>
<span class="fc" id="L228">      .orElseGet(() -&gt; RuleUpdate.createForPluginRule(key));</span>
  }

  private static void readTags(Request request, RuleUpdate update) {
<span class="fc" id="L232">    String value = request.param(PARAM_TAGS);</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">    if (value != null) {</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">      if (StringUtils.isBlank(value)) {</span>
<span class="nc" id="L235">        update.setTags(null);</span>
      } else {
<span class="fc" id="L237">        update.setTags(newHashSet(Splitter.on(',').omitEmptyStrings().trimResults().split(value)));</span>
      }
    }
    // else do not touch this field
<span class="fc" id="L241">  }</span>

  private static void readMarkdownNote(Request request, RuleUpdate update) {
<span class="fc" id="L244">    String value = request.param(PARAM_MARKDOWN_NOTE);</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">    if (value != null) {</span>
<span class="fc" id="L246">      update.setMarkdownNote(value);</span>
    }
    // else do not touch this field
<span class="fc" id="L249">  }</span>

  private static void readDebt(Request request, RuleUpdate update) {
<span class="fc" id="L252">    String value = request.param(PARAM_REMEDIATION_FN_TYPE);</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">    if (value != null) {</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">      if (StringUtils.isBlank(value)) {</span>
<span class="nc" id="L255">        update.setDebtRemediationFunction(null);</span>
      } else {
<span class="fc" id="L257">        DebtRemediationFunction fn = new DefaultDebtRemediationFunction(</span>
<span class="fc" id="L258">          DebtRemediationFunction.Type.valueOf(value),</span>
<span class="fc" id="L259">          request.param(PARAM_REMEDIATION_FN_GAP_MULTIPLIER),</span>
<span class="fc" id="L260">          request.param(PARAM_REMEDIATION_FN_BASE_EFFORT));</span>
<span class="fc" id="L261">        update.setDebtRemediationFunction(fn);</span>
      }
    }
<span class="fc" id="L264">  }</span>

  private UpdateResponse buildResponse(DbSession dbSession, RuleKey key) {
<span class="fc" id="L267">    RuleDto rule = dbClient.ruleDao().selectByKey(dbSession, key)</span>
<span class="pc" id="L268">      .orElseThrow(() -&gt; new NotFoundException(format(&quot;Rule not found: %s&quot;, key)));</span>
<span class="fc" id="L269">    List&lt;RuleDto&gt; templateRules = new ArrayList&lt;&gt;(1);</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">    if (rule.isCustomRule()) {</span>
<span class="fc" id="L271">      dbClient.ruleDao().selectByUuid(rule.getTemplateUuid(), dbSession).ifPresent(templateRules::add);</span>
    }
<span class="fc" id="L273">    List&lt;RuleParamDto&gt; ruleParameters = dbClient.ruleDao().selectRuleParamsByRuleUuids(dbSession, singletonList(rule.getUuid()));</span>
<span class="fc" id="L274">    UpdateResponse.Builder responseBuilder = UpdateResponse.newBuilder();</span>
<span class="fc" id="L275">    RulesResponseFormatter.SearchResult searchResult = new RulesResponseFormatter.SearchResult()</span>
<span class="fc" id="L276">      .setRules(singletonList(rule))</span>
<span class="fc" id="L277">      .setTemplateRules(templateRules)</span>
<span class="fc" id="L278">      .setRuleParameters(ruleParameters)</span>
<span class="fc" id="L279">      .setTotal(1L);</span>
<span class="fc" id="L280">    responseBuilder</span>
<span class="fc" id="L281">      .setRule(mapper.toWsRule(rule, searchResult, Collections.emptySet(),</span>
<span class="fc" id="L282">        ruleWsSupport.getUsersByUuid(dbSession, singletonList(rule)), emptyMap()));</span>

<span class="fc" id="L284">    return responseBuilder.build();</span>
  }

  private static Map&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; parseImpacts(String impacts) {
<span class="fc" id="L288">    Map&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; parsedImpacts = new EnumMap&lt;&gt;(SoftwareQuality.class);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">    for (String impact : impacts.split(&quot;;&quot;)) {</span>
<span class="fc" id="L290">      Pair&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; pair = parseImpact(impact);</span>
<span class="fc" id="L291">      parsedImpacts.put(pair.getKey(), pair.getValue());</span>
    }
<span class="fc" id="L293">    return parsedImpacts;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>