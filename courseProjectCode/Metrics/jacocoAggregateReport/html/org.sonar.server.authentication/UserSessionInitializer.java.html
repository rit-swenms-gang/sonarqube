<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserSessionInitializer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.authentication</a> &gt; <span class="el_source">UserSessionInitializer.java</span></div><h1>UserSessionInitializer.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.authentication;

import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import org.slf4j.MDC;
import org.sonar.api.config.Configuration;
import org.sonar.api.impl.ws.StaticResources;
import org.sonar.api.server.ServerSide;
import org.sonar.api.server.http.HttpRequest;
import org.sonar.api.server.http.HttpResponse;
import org.sonar.api.web.UrlPattern;
import org.sonar.db.user.UserTokenDto;
import org.sonar.server.authentication.event.AuthenticationEvent;
import org.sonar.server.authentication.event.AuthenticationEvent.Source;
import org.sonar.server.authentication.event.AuthenticationException;
import org.sonar.server.user.ThreadLocalUserSession;
import org.sonar.server.user.TokenUserSession;
import org.sonar.server.user.UserSession;

import static java.net.HttpURLConnection.HTTP_UNAUTHORIZED;
import static org.sonar.api.CoreProperties.CORE_FORCE_AUTHENTICATION_DEFAULT_VALUE;
import static org.sonar.api.CoreProperties.CORE_FORCE_AUTHENTICATION_PROPERTY;
import static org.sonar.api.utils.DateUtils.formatDateTime;
import static org.sonar.server.authentication.AuthenticationError.handleAuthenticationError;

@ServerSide
public class UserSessionInitializer {

  /**
   * Key of attribute to be used for displaying user login
   * in logs/access.log. The pattern to be configured
   * in property sonar.web.accessLogs.pattern is &quot;%reqAttribute{LOGIN}&quot;
   */
  private static final String ACCESS_LOG_LOGIN = &quot;LOGIN&quot;;

  public static final String USER_LOGIN_MDC_KEY = &quot;LOGIN&quot;;

  private static final String SQ_AUTHENTICATION_TOKEN_EXPIRATION = &quot;SonarQube-Authentication-Token-Expiration&quot;;

  // SONAR-6546 these urls should be get from WebService
<span class="fc" id="L61">  private static final Set&lt;String&gt; SKIPPED_URLS = Set.of(</span>
    &quot;/batch/index&quot;, &quot;/batch/file&quot;,
    &quot;/maintenance/*&quot;, &quot;/setup/*&quot;,
    &quot;/sessions/*&quot;, &quot;/oauth2/callback/*&quot;,
    &quot;/api/system/db_migration_status&quot;, &quot;/api/system/status&quot;, &quot;/api/system/migrate_db&quot;,
    &quot;/api/server/version&quot;,
    &quot;/api/users/identity_providers&quot;, &quot;/api/l10n/index&quot;,
    &quot;/api/authentication/login&quot;, &quot;/api/authentication/logout&quot;, &quot;/api/authentication/validate&quot;,
    &quot;/api/project_badges/measure&quot;, &quot;/api/project_badges/quality_gate&quot;, &quot;/api/project_badges/ai_code_assurance&quot;,
    &quot;/api/settings/login_message&quot;);

<span class="fc" id="L72">  private static final Set&lt;String&gt; URL_USING_PASSCODE = Set.of(</span>
    &quot;/api/ce/info&quot;, &quot;/api/ce/pause&quot;,
    &quot;/api/ce/resume&quot;, &quot;/api/system/health&quot;,
    &quot;/api/system/analytics&quot;, &quot;/api/system/migrate_es&quot;,
    &quot;/api/system/liveness&quot;,
    &quot;/api/monitoring/metrics&quot;);

<span class="fc" id="L79">  private static final UrlPattern URL_PATTERN = UrlPattern.builder()</span>
<span class="fc" id="L80">    .includes(&quot;/*&quot;)</span>
<span class="fc" id="L81">    .excludes(StaticResources.patterns())</span>
<span class="fc" id="L82">    .excludes(SKIPPED_URLS)</span>
<span class="fc" id="L83">    .build();</span>

<span class="fc" id="L85">  private static final UrlPattern PASSCODE_URLS = UrlPattern.builder()</span>
<span class="fc" id="L86">    .includes(URL_USING_PASSCODE)</span>
<span class="fc" id="L87">    .build();</span>

  private final Configuration config;
  private final ThreadLocalUserSession threadLocalSession;
  private final AuthenticationEvent authenticationEvent;
  private final RequestAuthenticator requestAuthenticator;

  public UserSessionInitializer(Configuration config, ThreadLocalUserSession threadLocalSession, AuthenticationEvent authenticationEvent,
<span class="fc" id="L95">    RequestAuthenticator requestAuthenticator) {</span>
<span class="fc" id="L96">    this.config = config;</span>
<span class="fc" id="L97">    this.threadLocalSession = threadLocalSession;</span>
<span class="fc" id="L98">    this.authenticationEvent = authenticationEvent;</span>
<span class="fc" id="L99">    this.requestAuthenticator = requestAuthenticator;</span>
<span class="fc" id="L100">  }</span>

  public boolean initUserSession(HttpRequest request, HttpResponse response) {
<span class="fc" id="L103">    MDC.put(USER_LOGIN_MDC_KEY, &quot;-&quot;);</span>
<span class="fc" id="L104">    String path = request.getRequestURI().replaceFirst(request.getContextPath(), &quot;&quot;);</span>
    try {
      // Do not set user session when url is excluded
<span class="fc bfc" id="L107" title="All 2 branches covered.">      if (URL_PATTERN.matches(path)) {</span>
<span class="fc" id="L108">        loadUserSession(request, response, PASSCODE_URLS.matches(path));</span>
      }
<span class="fc" id="L110">      return true;</span>
<span class="fc" id="L111">    } catch (AuthenticationException e) {</span>
<span class="fc" id="L112">      authenticationEvent.loginFailure(request, e);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">      if (isWsUrl(path)) {</span>
<span class="fc" id="L114">        response.setStatus(HTTP_UNAUTHORIZED);</span>
<span class="fc" id="L115">        return false;</span>
      }
<span class="fc bfc" id="L117" title="All 2 branches covered.">      if (isNotLocalOrJwt(e.getSource())) {</span>
        // redirect to Unauthorized error page
<span class="fc" id="L119">        handleAuthenticationError(e, request, response);</span>
<span class="fc" id="L120">        return false;</span>
      }
      // Web pages should redirect to the index.html file
<span class="fc" id="L123">      return true;</span>
    }
  }

  private static boolean isNotLocalOrJwt(Source source) {
<span class="fc" id="L128">    AuthenticationEvent.Provider provider = source.getProvider();</span>
<span class="pc bpc" id="L129" title="1 of 4 branches missed.">    return provider != AuthenticationEvent.Provider.LOCAL &amp;&amp; provider != AuthenticationEvent.Provider.JWT;</span>
  }

  private void loadUserSession(HttpRequest request, HttpResponse response, boolean urlSupportsSystemPasscode) {
<span class="fc" id="L133">    UserSession session = requestAuthenticator.authenticate(request, response);</span>
<span class="fc bfc" id="L134" title="All 6 branches covered.">    if (!session.isLoggedIn() &amp;&amp; !urlSupportsSystemPasscode &amp;&amp; config.getBoolean(CORE_FORCE_AUTHENTICATION_PROPERTY).orElse(CORE_FORCE_AUTHENTICATION_DEFAULT_VALUE)) {</span>
      // authentication is required
<span class="fc" id="L136">      throw AuthenticationException.newBuilder()</span>
<span class="fc" id="L137">        .setSource(Source.local(AuthenticationEvent.Method.BASIC))</span>
<span class="fc" id="L138">        .setMessage(&quot;User must be authenticated&quot;)</span>
<span class="fc" id="L139">        .build();</span>
    }
<span class="fc" id="L141">    threadLocalSession.set(session);</span>
<span class="fc" id="L142">    checkTokenUserSession(response, session);</span>
<span class="fc" id="L143">    request.setAttribute(ACCESS_LOG_LOGIN, Objects.toString(session.getLogin(), &quot;-&quot;));</span>
<span class="fc" id="L144">    MDC.put(USER_LOGIN_MDC_KEY, Objects.toString(session.getLogin(), &quot;-&quot;));</span>
<span class="fc" id="L145">  }</span>

  private static void checkTokenUserSession(HttpResponse response, UserSession session) {
<span class="fc bfc" id="L148" title="All 2 branches covered.">    if (session instanceof TokenUserSession tokenUserSession) {</span>
<span class="fc" id="L149">      UserTokenDto userTokenDto = tokenUserSession.getUserToken();</span>
<span class="fc" id="L150">      Optional.ofNullable(userTokenDto.getExpirationDate()).ifPresent(expirationDate -&gt; response.addHeader(SQ_AUTHENTICATION_TOKEN_EXPIRATION, formatDateTime(expirationDate)));</span>
    }
<span class="fc" id="L152">  }</span>

  public void removeUserSession() {
<span class="fc" id="L155">    MDC.remove(USER_LOGIN_MDC_KEY);</span>
<span class="fc" id="L156">    threadLocalSession.unload();</span>
<span class="fc" id="L157">  }</span>

  private static boolean isWsUrl(String path) {
<span class="fc bfc" id="L160" title="All 4 branches covered.">    return path.startsWith(&quot;/batch/&quot;) || path.startsWith(&quot;/api/&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>