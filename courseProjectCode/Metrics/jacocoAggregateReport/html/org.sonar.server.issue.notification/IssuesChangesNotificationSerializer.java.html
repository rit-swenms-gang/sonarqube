<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IssuesChangesNotificationSerializer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.issue.notification</a> &gt; <span class="el_source">IssuesChangesNotificationSerializer.java</span></div><h1>IssuesChangesNotificationSerializer.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.issue.notification;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import javax.annotation.concurrent.Immutable;
import org.sonar.api.issue.IssueStatus;
import org.sonar.api.rule.RuleKey;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.ChangedIssue;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.Project;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.Rule;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.User;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkState;
import static java.util.Optional.ofNullable;

<span class="fc" id="L42">public class IssuesChangesNotificationSerializer {</span>
  private static final String FIELD_ISSUES_COUNT = &quot;issues.count&quot;;
  private static final String FIELD_CHANGE_DATE = &quot;change.date&quot;;
  private static final String FIELD_CHANGE_AUTHOR_UUID = &quot;change.author.uuid&quot;;
  private static final String FIELD_CHANGE_AUTHOR_LOGIN = &quot;change.author.login&quot;;
  private static final String FIELD_CHANGE_AUTHOR_NAME = &quot;change.author.name&quot;;
  private static final String FIELD_PREFIX_RULES = &quot;rules.&quot;;

  public IssuesChangesNotification serialize(IssuesChangesNotificationBuilder builder) {
<span class="fc" id="L51">    IssuesChangesNotification res = new IssuesChangesNotification();</span>
<span class="fc" id="L52">    serializeIssueSize(res, builder.getIssues());</span>
<span class="fc" id="L53">    serializeChange(res, builder.getChange());</span>
<span class="fc" id="L54">    serializeIssues(res, builder.getIssues());</span>
<span class="fc" id="L55">    serializeRules(res, builder.getIssues());</span>
<span class="fc" id="L56">    serializeProjects(res, builder.getIssues());</span>

<span class="fc" id="L58">    return res;</span>
  }

  /**
   * @throws IllegalArgumentException if {@code notification} misses any field or of any has unsupported value
   */
  public IssuesChangesNotificationBuilder from(IssuesChangesNotification notification) {
<span class="fc" id="L65">    int issueCount = readIssueCount(notification);</span>
<span class="fc" id="L66">    IssuesChangesNotificationBuilder.Change change = readChange(notification);</span>
<span class="fc" id="L67">    List&lt;Issue&gt; issues = readIssues(notification, issueCount);</span>
<span class="fc" id="L68">    Map&lt;String, Project&gt; projects = readProjects(notification, issues);</span>
<span class="fc" id="L69">    Map&lt;RuleKey, Rule&gt; rules = readRules(notification, issues);</span>

<span class="fc" id="L71">    return new IssuesChangesNotificationBuilder(buildChangedIssues(issues, projects, rules), change);</span>
  }

  private static void serializeIssueSize(IssuesChangesNotification res, Set&lt;ChangedIssue&gt; issues) {
<span class="fc" id="L75">    res.setFieldValue(FIELD_ISSUES_COUNT, String.valueOf(issues.size()));</span>
<span class="fc" id="L76">  }</span>

  private static int readIssueCount(IssuesChangesNotification notification) {
<span class="fc" id="L79">    String fieldValue = notification.getFieldValue(FIELD_ISSUES_COUNT);</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">    checkArgument(fieldValue != null, &quot;missing field %s&quot;, FIELD_ISSUES_COUNT);</span>
<span class="fc" id="L81">    int issueCount = Integer.parseInt(fieldValue);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">    checkArgument(issueCount &gt; 0, &quot;issue count must be &gt;= 1&quot;);</span>
<span class="fc" id="L83">    return issueCount;</span>
  }

  private static Set&lt;ChangedIssue&gt; buildChangedIssues(List&lt;Issue&gt; issues, Map&lt;String, Project&gt; projects,
    Map&lt;RuleKey, Rule&gt; rules) {
<span class="fc" id="L88">    return issues.stream()</span>
<span class="fc" id="L89">      .map(issue -&gt; new ChangedIssue.Builder(issue.key)</span>
<span class="fc" id="L90">        .setNewStatus(issue.newStatus)</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        .setNewIssueStatus(issue.newIssueStatus == null ? null : IssueStatus.valueOf(issue.newIssueStatus))</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        .setOldIssueStatus(issue.oldIssueStatus == null ? null : IssueStatus.valueOf(issue.oldIssueStatus))</span>
<span class="fc" id="L93">        .setAssignee(issue.assignee)</span>
<span class="fc" id="L94">        .setRule(rules.get(issue.ruleKey))</span>
<span class="fc" id="L95">        .setProject(projects.get(issue.projectUuid))</span>
<span class="fc" id="L96">        .build())</span>
<span class="fc" id="L97">      .collect(Collectors.toSet());</span>
  }

  private static void serializeIssues(IssuesChangesNotification res, Set&lt;ChangedIssue&gt; issues) {
<span class="fc" id="L101">    int index = 0;</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">    for (ChangedIssue issue : issues) {</span>
<span class="fc" id="L103">      serializeIssue(res, index, issue);</span>
<span class="fc" id="L104">      index++;</span>
<span class="fc" id="L105">    }</span>
<span class="fc" id="L106">  }</span>

  private static List&lt;Issue&gt; readIssues(IssuesChangesNotification notification, int issueCount) {
<span class="fc" id="L109">    List&lt;Issue&gt; res = new ArrayList&lt;&gt;(issueCount);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">    for (int i = 0; i &lt; issueCount; i++) {</span>
<span class="fc" id="L111">      res.add(readIssue(notification, i));</span>
    }
<span class="fc" id="L113">    return res;</span>
  }

  private static void serializeIssue(IssuesChangesNotification notification, int index, ChangedIssue issue) {
<span class="fc" id="L117">    String issuePropertyPrefix = &quot;issues.&quot; + index;</span>
<span class="fc" id="L118">    notification.setFieldValue(issuePropertyPrefix + &quot;.key&quot;, issue.getKey());</span>
<span class="fc" id="L119">    issue.getAssignee()</span>
<span class="fc" id="L120">      .ifPresent(assignee -&gt; {</span>
<span class="fc" id="L121">        notification.setFieldValue(issuePropertyPrefix + &quot;.assignee.uuid&quot;, assignee.getUuid());</span>
<span class="fc" id="L122">        notification.setFieldValue(issuePropertyPrefix + &quot;.assignee.login&quot;, assignee.getLogin());</span>
<span class="fc" id="L123">        assignee.getName()</span>
<span class="fc" id="L124">          .ifPresent(name -&gt; notification.setFieldValue(issuePropertyPrefix + &quot;.assignee.name&quot;, name));</span>
<span class="fc" id="L125">      });</span>
<span class="fc" id="L126">    notification.setFieldValue(issuePropertyPrefix + &quot;.newStatus&quot;, issue.getNewStatus());</span>
<span class="fc" id="L127">    issue.getNewIssueStatus()</span>
<span class="fc" id="L128">      .ifPresent(newIssueStatus -&gt; notification.setFieldValue(issuePropertyPrefix + &quot;.newIssueStatus&quot;, newIssueStatus.name()));</span>
<span class="fc" id="L129">    issue.getOldIssueStatus()</span>
<span class="fc" id="L130">      .ifPresent(oldIssueStatus -&gt; notification.setFieldValue(issuePropertyPrefix + &quot;.oldIssueStatus&quot;, oldIssueStatus.name()));</span>
<span class="fc" id="L131">    notification.setFieldValue(issuePropertyPrefix + &quot;.ruleKey&quot;, issue.getRule().getKey().toString());</span>
<span class="fc" id="L132">    notification.setFieldValue(issuePropertyPrefix + &quot;.projectUuid&quot;, issue.getProject().getUuid());</span>
<span class="fc" id="L133">  }</span>

  private static Issue readIssue(IssuesChangesNotification notification, int index) {
<span class="fc" id="L136">    String issuePropertyPrefix = &quot;issues.&quot; + index;</span>
<span class="fc" id="L137">    User assignee = readAssignee(notification, issuePropertyPrefix, index);</span>
<span class="fc" id="L138">    return new Issue.Builder()</span>
<span class="fc" id="L139">      .setKey(getIssueFieldValue(notification, issuePropertyPrefix + &quot;.key&quot;, index))</span>
<span class="fc" id="L140">      .setNewStatus(getIssueFieldValue(notification, issuePropertyPrefix + &quot;.newStatus&quot;, index))</span>
<span class="fc" id="L141">      .setNewResolution(notification.getFieldValue(issuePropertyPrefix + &quot;.newResolution&quot;))</span>
<span class="fc" id="L142">      .setNewIssueStatus(notification.getFieldValue(issuePropertyPrefix + &quot;.newIssueStatus&quot;))</span>
<span class="fc" id="L143">      .setOldIssueStatus(notification.getFieldValue(issuePropertyPrefix + &quot;.oldIssueStatus&quot;))</span>
<span class="fc" id="L144">      .setAssignee(assignee)</span>
<span class="fc" id="L145">      .setRuleKey(getIssueFieldValue(notification, issuePropertyPrefix + &quot;.ruleKey&quot;, index))</span>
<span class="fc" id="L146">      .setProjectUuid(getIssueFieldValue(notification, issuePropertyPrefix + &quot;.projectUuid&quot;, index))</span>
<span class="fc" id="L147">      .build();</span>
  }

  @CheckForNull
  private static User readAssignee(IssuesChangesNotification notification, String issuePropertyPrefix, int index) {
<span class="fc" id="L152">    String uuid = notification.getFieldValue(issuePropertyPrefix + &quot;.assignee.uuid&quot;);</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">    if (uuid == null) {</span>
<span class="fc" id="L154">      return null;</span>
    }
<span class="fc" id="L156">    String login = getIssueFieldValue(notification, issuePropertyPrefix + &quot;.assignee.login&quot;, index);</span>
<span class="fc" id="L157">    return new User(uuid, login, notification.getFieldValue(issuePropertyPrefix + &quot;.assignee.name&quot;));</span>
  }

  private static String getIssueFieldValue(IssuesChangesNotification notification, String fieldName, int index) {
<span class="fc" id="L161">    String fieldValue = notification.getFieldValue(fieldName);</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">    checkState(fieldValue != null, &quot;Can not find field %s for issue with index %s&quot;, fieldName, index);</span>
<span class="fc" id="L163">    return fieldValue;</span>
  }

  private static void serializeRules(IssuesChangesNotification res, Set&lt;ChangedIssue&gt; issues) {
<span class="fc" id="L167">    issues.stream()</span>
<span class="fc" id="L168">      .map(ChangedIssue::getRule)</span>
<span class="fc" id="L169">      .collect(Collectors.toSet())</span>
<span class="fc" id="L170">      .forEach(rule -&gt; {</span>
<span class="fc" id="L171">        res.setFieldValue(FIELD_PREFIX_RULES + rule.getKey(), rule.getName());</span>
<span class="fc" id="L172">        ofNullable(rule.getRuleType()).ifPresent(ruleType -&gt; res.setFieldValue(FIELD_PREFIX_RULES + rule.getKey() + &quot;.type&quot;, rule.getRuleType().name()));</span>
<span class="fc" id="L173">      });</span>
<span class="fc" id="L174">  }</span>

  private static Map&lt;RuleKey, Rule&gt; readRules(IssuesChangesNotification notification, List&lt;Issue&gt; issues) {
<span class="fc" id="L177">    return issues.stream()</span>
<span class="fc" id="L178">      .map(issue -&gt; issue.ruleKey)</span>
<span class="fc" id="L179">      .collect(Collectors.toSet())</span>
<span class="fc" id="L180">      .stream()</span>
<span class="fc" id="L181">      .map(ruleKey -&gt; readRule(notification, ruleKey))</span>
<span class="fc" id="L182">      .collect(Collectors.toMap(Rule::getKey, Function.identity()));</span>
  }

  private static Rule readRule(IssuesChangesNotification notification, RuleKey ruleKey) {
<span class="fc" id="L186">    String fieldName = FIELD_PREFIX_RULES + ruleKey;</span>
<span class="fc" id="L187">    String ruleName = notification.getFieldValue(fieldName);</span>
<span class="fc" id="L188">    String ruleType = notification.getFieldValue(fieldName + &quot;.type&quot;);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">    checkState(ruleName != null, &quot;can not find field %s&quot;, ruleKey);</span>
<span class="fc" id="L190">    return new Rule(ruleKey, ruleType, ruleName);</span>
  }

  private static void serializeProjects(IssuesChangesNotification res, Set&lt;ChangedIssue&gt; issues) {
<span class="fc" id="L194">    issues.stream()</span>
<span class="fc" id="L195">      .map(ChangedIssue::getProject)</span>
<span class="fc" id="L196">      .collect(Collectors.toSet())</span>
<span class="fc" id="L197">      .forEach(project -&gt; {</span>
<span class="fc" id="L198">        String projectPropertyPrefix = &quot;projects.&quot; + project.getUuid();</span>
<span class="fc" id="L199">        res.setFieldValue(projectPropertyPrefix + &quot;.key&quot;, project.getKey());</span>
<span class="fc" id="L200">        res.setFieldValue(projectPropertyPrefix + &quot;.projectName&quot;, project.getProjectName());</span>
<span class="fc" id="L201">        project.getBranchName()</span>
<span class="fc" id="L202">          .ifPresent(branchName -&gt; res.setFieldValue(projectPropertyPrefix + &quot;.branchName&quot;, branchName));</span>
<span class="fc" id="L203">      });</span>
<span class="fc" id="L204">  }</span>

  private static Map&lt;String, Project&gt; readProjects(IssuesChangesNotification notification, List&lt;Issue&gt; issues) {
<span class="fc" id="L207">    return issues.stream()</span>
<span class="fc" id="L208">      .map(issue -&gt; issue.projectUuid)</span>
<span class="fc" id="L209">      .collect(Collectors.toSet())</span>
<span class="fc" id="L210">      .stream()</span>
<span class="fc" id="L211">      .map(projectUuid -&gt; {</span>
<span class="fc" id="L212">        String projectPropertyPrefix = &quot;projects.&quot; + projectUuid;</span>
<span class="fc" id="L213">        return new Project.Builder(projectUuid)</span>
<span class="fc" id="L214">          .setKey(getProjectFieldValue(notification, projectPropertyPrefix + &quot;.key&quot;, projectUuid))</span>
<span class="fc" id="L215">          .setProjectName(getProjectFieldValue(notification, projectPropertyPrefix + &quot;.projectName&quot;, projectUuid))</span>
<span class="fc" id="L216">          .setBranchName(notification.getFieldValue(projectPropertyPrefix + &quot;.branchName&quot;))</span>
<span class="fc" id="L217">          .build();</span>
      })
<span class="fc" id="L219">      .collect(Collectors.toMap(Project::getUuid, Function.identity()));</span>
  }

  private static String getProjectFieldValue(IssuesChangesNotification notification, String fieldName, String uuid) {
<span class="fc" id="L223">    String fieldValue = notification.getFieldValue(fieldName);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">    checkState(fieldValue != null, &quot;Can not find field %s for project with uuid %s&quot;, fieldName, uuid);</span>
<span class="fc" id="L225">    return fieldValue;</span>
  }

  private static void serializeChange(IssuesChangesNotification notification, IssuesChangesNotificationBuilder.Change change) {
<span class="fc" id="L229">    notification.setFieldValue(FIELD_CHANGE_DATE, String.valueOf(change.date));</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">    if (change instanceof IssuesChangesNotificationBuilder.UserChange userChange) {</span>
<span class="fc" id="L231">      User user = userChange.getUser();</span>
<span class="fc" id="L232">      notification.setFieldValue(FIELD_CHANGE_AUTHOR_UUID, user.getUuid());</span>
<span class="fc" id="L233">      notification.setFieldValue(FIELD_CHANGE_AUTHOR_LOGIN, user.getLogin());</span>
<span class="fc" id="L234">      user.getName().ifPresent(name -&gt; notification.setFieldValue(FIELD_CHANGE_AUTHOR_NAME, name));</span>
    }
<span class="fc" id="L236">  }</span>

  private static IssuesChangesNotificationBuilder.Change readChange(IssuesChangesNotification notification) {
<span class="fc" id="L239">    String dateFieldValue = notification.getFieldValue(FIELD_CHANGE_DATE);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">    checkState(dateFieldValue != null, &quot;Can not find field %s&quot;, FIELD_CHANGE_DATE);</span>
<span class="fc" id="L241">    long date = Long.parseLong(dateFieldValue);</span>

<span class="fc" id="L243">    String uuid = notification.getFieldValue(FIELD_CHANGE_AUTHOR_UUID);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (uuid == null) {</span>
<span class="fc" id="L245">      return new IssuesChangesNotificationBuilder.AnalysisChange(date);</span>
    }
<span class="fc" id="L247">    String login = notification.getFieldValue(FIELD_CHANGE_AUTHOR_LOGIN);</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">    checkState(login != null, &quot;Can not find field %s&quot;, FIELD_CHANGE_AUTHOR_LOGIN);</span>
<span class="fc" id="L249">    return new IssuesChangesNotificationBuilder.UserChange(date, new User(uuid, login, notification.getFieldValue(FIELD_CHANGE_AUTHOR_NAME)));</span>
  }

  @Immutable
  private static final class Issue {
    private final String key;
    private final String newStatus;
    @CheckForNull
    private final String newResolution;
    @CheckForNull
    private final String newIssueStatus;
    @CheckForNull
    private final String oldIssueStatus;
    @CheckForNull
    private final User assignee;
    private final RuleKey ruleKey;
    private final String projectUuid;

<span class="fc" id="L267">    private Issue(Builder builder) {</span>
<span class="fc" id="L268">      this.key = builder.key;</span>
<span class="fc" id="L269">      this.newResolution = builder.newResolution;</span>
<span class="fc" id="L270">      this.newStatus = builder.newStatus;</span>
<span class="fc" id="L271">      this.assignee = builder.assignee;</span>
<span class="fc" id="L272">      this.ruleKey = RuleKey.parse(builder.ruleKey);</span>
<span class="fc" id="L273">      this.projectUuid = builder.projectUuid;</span>
<span class="fc" id="L274">      this.newIssueStatus = builder.newIssueStatus;</span>
<span class="fc" id="L275">      this.oldIssueStatus = builder.oldIssueStatus;</span>
<span class="fc" id="L276">    }</span>

<span class="fc" id="L278">    static class Builder {</span>
<span class="fc" id="L279">      private String oldIssueStatus = null;</span>
<span class="fc" id="L280">      private String key = null;</span>
<span class="fc" id="L281">      private String newStatus = null;</span>
<span class="fc" id="L282">      @CheckForNull</span>
      private String newResolution = null;
<span class="fc" id="L284">      @CheckForNull</span>
      private User assignee = null;
<span class="fc" id="L286">      private String ruleKey = null;</span>
<span class="fc" id="L287">      private String projectUuid = null;</span>
<span class="fc" id="L288">      private String newIssueStatus = null;</span>

      public Builder setKey(String key) {
<span class="fc" id="L291">        this.key = key;</span>
<span class="fc" id="L292">        return this;</span>
      }

      public Builder setNewStatus(String newStatus) {
<span class="fc" id="L296">        this.newStatus = newStatus;</span>
<span class="fc" id="L297">        return this;</span>
      }

      public Builder setNewResolution(@Nullable String newResolution) {
<span class="fc" id="L301">        this.newResolution = newResolution;</span>
<span class="fc" id="L302">        return this;</span>
      }

      public Builder setNewIssueStatus(@Nullable String newIssueStatus) {
<span class="fc" id="L306">        this.newIssueStatus = newIssueStatus;</span>
<span class="fc" id="L307">        return this;</span>
      }

      public Builder setOldIssueStatus(@Nullable String oldIssueStatus) {
<span class="fc" id="L311">        this.oldIssueStatus = oldIssueStatus;</span>
<span class="fc" id="L312">        return this;</span>
      }

      public Builder setAssignee(@Nullable User assignee) {
<span class="fc" id="L316">        this.assignee = assignee;</span>
<span class="fc" id="L317">        return this;</span>
      }

      public Builder setRuleKey(String ruleKey) {
<span class="fc" id="L321">        this.ruleKey = ruleKey;</span>
<span class="fc" id="L322">        return this;</span>
      }

      public Builder setProjectUuid(String projectUuid) {
<span class="fc" id="L326">        this.projectUuid = projectUuid;</span>
<span class="fc" id="L327">        return this;</span>
      }

      public Issue build() {
<span class="fc" id="L331">        return new Issue(this);</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>