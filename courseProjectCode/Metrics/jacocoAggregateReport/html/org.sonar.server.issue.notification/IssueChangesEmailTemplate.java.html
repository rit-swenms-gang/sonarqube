<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IssueChangesEmailTemplate.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.issue.notification</a> &gt; <span class="el_source">IssueChangesEmailTemplate.java</span></div><h1>IssueChangesEmailTemplate.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.issue.notification;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSortedSet;
import com.google.common.collect.ListMultimap;
import com.google.common.collect.Lists;
import com.google.common.collect.SetMultimap;
import java.io.UnsupportedEncodingException;
import java.util.Collection;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.function.BiConsumer;
import java.util.function.Consumer;
import javax.annotation.Nullable;
import org.sonar.api.platform.Server;
import org.sonar.core.rule.RuleType;
import org.sonar.core.i18n.I18n;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.ChangedIssue;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.Project;
import org.sonar.server.issue.notification.IssuesChangesNotificationBuilder.Rule;

import static java.net.URLEncoder.encode;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.function.Function.identity;
import static org.apache.commons.lang3.StringEscapeUtils.escapeHtml4;
import static org.sonar.core.util.stream.MoreCollectors.index;
import static org.sonar.server.issue.notification.RuleGroup.ISSUES;
import static org.sonar.server.issue.notification.RuleGroup.SECURITY_HOTSPOTS;
import static org.sonar.server.issue.notification.RuleGroup.formatIssueOrHotspot;
import static org.sonar.server.issue.notification.RuleGroup.formatIssuesOrHotspots;
import static org.sonar.server.issue.notification.RuleGroup.resolveGroup;

public abstract class IssueChangesEmailTemplate implements EmailTemplate {

<span class="fc" id="L59">  private static final Comparator&lt;Rule&gt; RULE_COMPARATOR = Comparator.comparing(r -&gt; r.getKey().toString());</span>
<span class="fc" id="L60">  private static final Comparator&lt;Project&gt; PROJECT_COMPARATOR = Comparator.comparing(Project::getProjectName)</span>
<span class="fc" id="L61">    .thenComparing(t -&gt; t.getBranchName().orElse(&quot;&quot;));</span>
<span class="fc" id="L62">  private static final Comparator&lt;ChangedIssue&gt; CHANGED_ISSUE_KEY_COMPARATOR = Comparator.comparing(ChangedIssue::getKey, Comparator.naturalOrder());</span>

  /**
   * Assuming:
   * &lt;ul&gt;
   *   &lt;li&gt;UUID length of 40 chars&lt;/li&gt;
   *   &lt;li&gt;a max URL length of 2083 chars&lt;/li&gt;
   * &lt;/ul&gt;
   * This leaves ~850 chars for the rest of the URL (including other parameters such as the project key and the branch),
   * which is reasonable to stay safe from the max URL length supported by some browsers and network devices.
   */
  private static final int MAX_ISSUES_BY_LINK = 40;
<span class="fc" id="L74">  private static final String URL_ENCODED_COMMA = urlEncode(&quot;,&quot;);</span>

  private final I18n i18n;
  private final Server server;

<span class="fc" id="L79">  protected IssueChangesEmailTemplate(I18n i18n, Server server) {</span>
<span class="fc" id="L80">    this.i18n = i18n;</span>
<span class="fc" id="L81">    this.server = server;</span>
<span class="fc" id="L82">  }</span>

  /**
   * Used to build the subject for the email
   */
  protected static String toSubject(Project project) {
<span class="fc" id="L88">    return project.getProjectName() + project.getBranchName().map(branchName -&gt; &quot; (&quot; + branchName + &quot;)&quot;).orElse(&quot;&quot;);</span>
  }

  /**
   * Adds &quot;projectName&quot; or &quot;projectName, branchName&quot; if branchName is non null
   */
  protected static void toString(StringBuilder sb, Project project) {
<span class="fc" id="L95">    Optional&lt;String&gt; branchName = project.getBranchName();</span>
<span class="fc" id="L96">    String value = project.getProjectName();</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">    if (branchName.isPresent()) {</span>
<span class="fc" id="L98">      value += &quot;, &quot; + branchName.get();</span>
    }
<span class="fc" id="L100">    sb.append(escapeHtml4(value));</span>
<span class="fc" id="L101">  }</span>

  static String toUrlParams(Project project) {
<span class="fc" id="L104">    return &quot;id=&quot; + urlEncode(project.getKey()) +</span>
<span class="fc" id="L105">      project.getBranchName().map(branchName -&gt; &quot;&amp;branch=&quot; + urlEncode(branchName)).orElse(&quot;&quot;);</span>
  }

  void addIssuesByProjectThenRule(StringBuilder sb, SetMultimap&lt;Project, ChangedIssue&gt; issuesByProject) {
<span class="fc" id="L109">    issuesByProject.keySet().stream()</span>
<span class="fc" id="L110">      .sorted(PROJECT_COMPARATOR)</span>
<span class="fc" id="L111">      .forEach(project -&gt; {</span>
<span class="fc" id="L112">        String encodedProjectParams = toUrlParams(project);</span>
<span class="fc" id="L113">        paragraph(sb, s -&gt; toString(s, project));</span>
<span class="fc" id="L114">        addIssuesByRule(sb, issuesByProject.get(project), projectIssuePageHref(encodedProjectParams));</span>
<span class="fc" id="L115">      });</span>
<span class="fc" id="L116">  }</span>

  void addIssuesAndHotspotsByProjectThenRule(StringBuilder sb, SetMultimap&lt;Project, ChangedIssue&gt; issuesByProject) {
<span class="fc" id="L119">    issuesByProject.keySet().stream()</span>
<span class="fc" id="L120">      .sorted(PROJECT_COMPARATOR)</span>
<span class="fc" id="L121">      .forEach(project -&gt; {</span>
<span class="fc" id="L122">        String encodedProjectParams = toUrlParams(project);</span>
<span class="fc" id="L123">        paragraph(sb, s -&gt; toString(s, project));</span>

<span class="fc" id="L125">        Set&lt;ChangedIssue&gt; changedIssues = issuesByProject.get(project);</span>
<span class="fc" id="L126">        ListMultimap&lt;RuleGroup, ChangedIssue&gt; issuesAndHotspots = changedIssues.stream()</span>
<span class="fc" id="L127">          .collect(index(changedIssue -&gt; resolveGroup(changedIssue.getRule().getRuleType()), identity()));</span>

<span class="fc" id="L129">        List&lt;ChangedIssue&gt; issues = issuesAndHotspots.get(ISSUES);</span>
<span class="fc" id="L130">        List&lt;ChangedIssue&gt; hotspots = issuesAndHotspots.get(SECURITY_HOTSPOTS);</span>

<span class="fc bfc" id="L132" title="All 2 branches covered.">        boolean hasSecurityHotspots = !hotspots.isEmpty();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">        boolean hasOtherIssues = !issues.isEmpty();</span>

<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (hasOtherIssues) {</span>
<span class="fc" id="L136">          addIssuesByRule(sb, issues, projectIssuePageHref(encodedProjectParams));</span>
        }

<span class="fc bfc" id="L139" title="All 4 branches covered.">        if (hasSecurityHotspots &amp;&amp; hasOtherIssues) {</span>
<span class="fc" id="L140">          paragraph(sb, stringBuilder -&gt; {</span>
<span class="fc" id="L141">          });</span>
        }

<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (hasSecurityHotspots) {</span>
<span class="fc" id="L145">          addIssuesByRule(sb, hotspots, securityHotspotPageHref(encodedProjectParams));</span>
        }
<span class="fc" id="L147">      });</span>
<span class="fc" id="L148">  }</span>

  void addIssuesByRule(StringBuilder sb, Collection&lt;ChangedIssue&gt; changedIssues, BiConsumer&lt;StringBuilder, Collection&lt;ChangedIssue&gt;&gt; issuePageHref) {
<span class="fc" id="L151">    ListMultimap&lt;Rule, ChangedIssue&gt; issuesByRule = changedIssues.stream()</span>
<span class="fc" id="L152">      .collect(index(ChangedIssue::getRule, t -&gt; t));</span>

<span class="fc" id="L154">    Iterator&lt;Rule&gt; rules = issuesByRule.keySet().stream()</span>
<span class="fc" id="L155">      .sorted(RULE_COMPARATOR)</span>
<span class="fc" id="L156">      .iterator();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">    if (!rules.hasNext()) {</span>
<span class="nc" id="L158">      return;</span>
    }

<span class="fc" id="L161">    sb.append(&quot;&lt;ul&gt;&quot;);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">    while (rules.hasNext()) {</span>
<span class="fc" id="L163">      Rule rule = rules.next();</span>
<span class="fc" id="L164">      Collection&lt;ChangedIssue&gt; issues = issuesByRule.get(rule);</span>

<span class="fc" id="L166">      String ruleName = escapeHtml4(rule.getName());</span>
<span class="fc" id="L167">      sb.append(&quot;&lt;li&gt;&quot;).append(&quot;Rule &quot;).append(&quot; &lt;em&gt;&quot;).append(ruleName).append(&quot;&lt;/em&gt; - &quot;);</span>
<span class="fc" id="L168">      appendIssueLinks(sb, issuePageHref, issues, rule.getRuleType());</span>
<span class="fc" id="L169">      sb.append(&quot;&lt;/li&gt;&quot;);</span>
<span class="fc" id="L170">    }</span>
<span class="fc" id="L171">    sb.append(&quot;&lt;/ul&gt;&quot;);</span>
<span class="fc" id="L172">  }</span>

  private static void appendIssueLinks(StringBuilder sb, BiConsumer&lt;StringBuilder, Collection&lt;ChangedIssue&gt;&gt; issuePageHref, Collection&lt;ChangedIssue&gt; issues,
    @Nullable RuleType ruleType) {
<span class="fc" id="L176">    SortedSet&lt;ChangedIssue&gt; sortedIssues = ImmutableSortedSet.copyOf(CHANGED_ISSUE_KEY_COMPARATOR, issues);</span>
<span class="fc" id="L177">    int issueCount = issues.size();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (issueCount == 1) {</span>
<span class="fc" id="L179">      link(sb, s -&gt; issuePageHref.accept(s, sortedIssues), s -&gt; s.append(&quot;See the single &quot;).append(formatIssueOrHotspot(ruleType)));</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">    } else if (issueCount &lt;= MAX_ISSUES_BY_LINK) {</span>
<span class="fc" id="L181">      link(sb, s -&gt; issuePageHref.accept(s, sortedIssues), s -&gt; s.append(&quot;See all &quot;).append(issueCount).append(&quot; &quot;).append(formatIssuesOrHotspots(ruleType)));</span>
    } else {
<span class="fc" id="L183">      sb.append(&quot;See &quot;).append(formatIssuesOrHotspots(ruleType));</span>
<span class="fc" id="L184">      List&lt;List&lt;ChangedIssue&gt;&gt; issueGroups = Lists.partition(ImmutableList.copyOf(sortedIssues), MAX_ISSUES_BY_LINK);</span>
<span class="fc" id="L185">      Iterator&lt;List&lt;ChangedIssue&gt;&gt; issueGroupsIterator = issueGroups.iterator();</span>
<span class="fc" id="L186">      int[] groupIndex = new int[] {0};</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">      while (issueGroupsIterator.hasNext()) {</span>
<span class="fc" id="L188">        List&lt;ChangedIssue&gt; issueGroup = issueGroupsIterator.next();</span>
<span class="fc" id="L189">        sb.append(' ');</span>
<span class="fc" id="L190">        link(sb, s -&gt; issuePageHref.accept(s, issueGroup), issueGroupLabel(sb, groupIndex, issueGroup));</span>
<span class="fc" id="L191">        groupIndex[0]++;</span>
<span class="fc" id="L192">      }</span>
    }
<span class="fc" id="L194">  }</span>

  BiConsumer&lt;StringBuilder, Collection&lt;ChangedIssue&gt;&gt; projectIssuePageHref(String projectParams) {
<span class="fc" id="L197">    return (s, issues) -&gt; {</span>
<span class="fc" id="L198">      s.append(server.getPublicRootUrl()).append(&quot;/project/issues?&quot;).append(projectParams)</span>
<span class="fc" id="L199">        .append(&quot;&amp;issues=&quot;);</span>

<span class="fc" id="L201">      Iterator&lt;ChangedIssue&gt; issueIterator = issues.iterator();</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">      while (issueIterator.hasNext()) {</span>
<span class="fc" id="L203">        s.append(urlEncode(issueIterator.next().getKey()));</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (issueIterator.hasNext()) {</span>
<span class="fc" id="L205">          s.append(URL_ENCODED_COMMA);</span>
        }
      }

<span class="fc bfc" id="L209" title="All 2 branches covered.">      if (issues.size() == 1) {</span>
<span class="fc" id="L210">        s.append(&quot;&amp;open=&quot;).append(urlEncode(issues.iterator().next().getKey()));</span>
      }
<span class="fc" id="L212">    };</span>
  }

  BiConsumer&lt;StringBuilder, Collection&lt;ChangedIssue&gt;&gt; securityHotspotPageHref(String projectParams) {
<span class="fc" id="L216">    return (s, issues) -&gt; {</span>
<span class="fc" id="L217">      s.append(server.getPublicRootUrl()).append(&quot;/security_hotspots?&quot;).append(projectParams)</span>
<span class="fc" id="L218">        .append(&quot;&amp;hotspots=&quot;);</span>

<span class="fc" id="L220">      Iterator&lt;ChangedIssue&gt; issueIterator = issues.iterator();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">      while (issueIterator.hasNext()) {</span>
<span class="fc" id="L222">        s.append(urlEncode(issueIterator.next().getKey()));</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (issueIterator.hasNext()) {</span>
<span class="fc" id="L224">          s.append(URL_ENCODED_COMMA);</span>
        }
      }
<span class="fc" id="L227">    };</span>
  }

  private static Consumer&lt;StringBuilder&gt; issueGroupLabel(StringBuilder sb, int[] groupIndex, List&lt;ChangedIssue&gt; issueGroup) {
<span class="fc" id="L231">    return s -&gt; {</span>
<span class="fc" id="L232">      int firstIssueNumber = (groupIndex[0] * MAX_ISSUES_BY_LINK) + 1;</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">      if (issueGroup.size() == 1) {</span>
<span class="fc" id="L234">        sb.append(firstIssueNumber);</span>
      } else {
<span class="fc" id="L236">        sb.append(firstIssueNumber).append(&quot;-&quot;).append(firstIssueNumber + issueGroup.size() - 1);</span>
      }
<span class="fc" id="L238">    };</span>
  }

  void addFooter(StringBuilder sb, String notificationI18nKey) {
<span class="fc" id="L242">    paragraph(sb, s -&gt; s.append(&quot;&amp;nbsp;&quot;));</span>
<span class="fc" id="L243">    paragraph(sb, s -&gt; {</span>
<span class="fc" id="L244">      s.append(&quot;&lt;small&gt;&quot;);</span>
<span class="fc" id="L245">      s.append(&quot;You received this email because you are subscribed to &quot;)</span>
<span class="fc" id="L246">        .append('&quot;').append(i18n.message(Locale.ENGLISH, notificationI18nKey, notificationI18nKey)).append('&quot;')</span>
<span class="fc" id="L247">        .append(&quot; notifications from SonarQube.&quot;);</span>
<span class="fc" id="L248">      s.append(&quot; Click &quot;);</span>
<span class="fc" id="L249">      link(s, s1 -&gt; s1.append(server.getPublicRootUrl()).append(&quot;/account/notifications&quot;), s1 -&gt; s1.append(&quot;here&quot;));</span>
<span class="fc" id="L250">      s.append(&quot; to edit your email preferences.&quot;);</span>
<span class="fc" id="L251">      s.append(&quot;&lt;/small&gt;&quot;);</span>
<span class="fc" id="L252">    });</span>
<span class="fc" id="L253">  }</span>

  protected static void paragraph(StringBuilder sb, Consumer&lt;StringBuilder&gt; content) {
<span class="fc" id="L256">    sb.append(&quot;&lt;p&gt;&quot;);</span>
<span class="fc" id="L257">    content.accept(sb);</span>
<span class="fc" id="L258">    sb.append(&quot;&lt;/p&gt;&quot;);</span>
<span class="fc" id="L259">  }</span>

  protected static void link(StringBuilder sb, Consumer&lt;StringBuilder&gt; link, Consumer&lt;StringBuilder&gt; content) {
<span class="fc" id="L262">    sb.append(&quot;&lt;a href=\&quot;&quot;);</span>
<span class="fc" id="L263">    link.accept(sb);</span>
<span class="fc" id="L264">    sb.append(&quot;\&quot;&gt;&quot;);</span>
<span class="fc" id="L265">    content.accept(sb);</span>
<span class="fc" id="L266">    sb.append(&quot;&lt;/a&gt;&quot;);</span>
<span class="fc" id="L267">  }</span>

  private static String urlEncode(String str) {
    try {
<span class="fc" id="L271">      return encode(str, UTF_8.name());</span>
<span class="nc" id="L272">    } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L273">      throw new IllegalStateException(e);</span>
    }
  }

  protected static String issueOrIssues(Collection&lt;?&gt; collection) {
<span class="fc bfc" id="L278" title="All 2 branches covered.">    if (collection.size() &gt; 1) {</span>
<span class="fc" id="L279">      return &quot;issues&quot;;</span>
    }
<span class="fc" id="L281">    return &quot;issue&quot;;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>