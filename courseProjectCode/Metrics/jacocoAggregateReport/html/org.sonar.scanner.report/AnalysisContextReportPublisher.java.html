<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnalysisContextReportPublisher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.scanner.report</a> &gt; <span class="el_source">AnalysisContextReportPublisher.java</span></div><h1>AnalysisContextReportPublisher.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.scanner.report;

import java.io.BufferedWriter;
import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Map;
import java.util.TreeSet;
import org.apache.commons.lang3.StringUtils;
import org.sonar.api.CoreProperties;
import org.sonar.api.batch.fs.internal.AbstractProjectOrModule;
import org.sonar.api.batch.fs.internal.DefaultInputModule;
import org.sonar.api.utils.System2;
import org.sonar.core.platform.PluginInfo;
import org.sonar.scanner.bootstrap.GlobalServerSettings;
import org.sonar.scanner.bootstrap.ScannerPluginRepository;
import org.sonar.scanner.fs.InputModuleHierarchy;
import org.sonar.scanner.protocol.output.ScannerReportWriter;
import org.sonar.scanner.scan.ProjectServerSettings;
import org.sonar.scanner.scan.filesystem.InputComponentStore;

public class AnalysisContextReportPublisher {

  private static final String KEY_VALUE_FORMAT = &quot;  - %s=%s&quot;;

  private static final String ENV_PROP_PREFIX = &quot;env.&quot;;
  private static final String SONAR_PROP_PREFIX = &quot;sonar.&quot;;
  private static final int MAX_WIDTH = 1000;
  private final ScannerPluginRepository pluginRepo;
  private final ProjectServerSettings projectServerSettings;
  private final System2 system;
  private final GlobalServerSettings globalServerSettings;
  private final InputModuleHierarchy hierarchy;
  private final InputComponentStore store;

  public AnalysisContextReportPublisher(ProjectServerSettings projectServerSettings, ScannerPluginRepository pluginRepo, System2 system,
<span class="fc" id="L59">    GlobalServerSettings globalServerSettings, InputModuleHierarchy hierarchy, InputComponentStore store) {</span>
<span class="fc" id="L60">    this.projectServerSettings = projectServerSettings;</span>
<span class="fc" id="L61">    this.pluginRepo = pluginRepo;</span>
<span class="fc" id="L62">    this.system = system;</span>
<span class="fc" id="L63">    this.globalServerSettings = globalServerSettings;</span>
<span class="fc" id="L64">    this.hierarchy = hierarchy;</span>
<span class="fc" id="L65">    this.store = store;</span>
<span class="fc" id="L66">  }</span>

  public void init(ScannerReportWriter writer) {
<span class="fc" id="L69">    File analysisLog = writer.getFileStructure().analysisLog();</span>
<span class="fc" id="L70">    try (BufferedWriter fileWriter = Files.newBufferedWriter(analysisLog.toPath(), StandardCharsets.UTF_8)) {</span>
<span class="fc" id="L71">      writePlugins(fileWriter);</span>
<span class="fc" id="L72">      writeBundledAnalyzers(fileWriter);</span>
<span class="fc" id="L73">      writeGlobalSettings(fileWriter);</span>
<span class="fc" id="L74">      writeProjectSettings(fileWriter);</span>
<span class="fc" id="L75">      writeModulesSettings(fileWriter);</span>
<span class="nc" id="L76">    } catch (IOException e) {</span>
<span class="nc" id="L77">      throw new IllegalStateException(&quot;Unable to write analysis log&quot;, e);</span>
<span class="fc" id="L78">    }</span>
<span class="fc" id="L79">  }</span>

  private void writePlugins(BufferedWriter fileWriter) throws IOException {
<span class="fc" id="L82">    fileWriter.write(&quot;Plugins:\n&quot;);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">    for (PluginInfo p : pluginRepo.getExternalPluginsInfos()) {</span>
<span class="fc" id="L84">      fileWriter.append(String.format(&quot;  - %s %s (%s)&quot;, p.getName(), p.getVersion(), p.getKey())).append('\n');</span>
<span class="fc" id="L85">    }</span>
<span class="fc" id="L86">  }</span>

  private void writeBundledAnalyzers(BufferedWriter fileWriter) throws IOException {
<span class="fc" id="L89">    fileWriter.write(&quot;Bundled analyzers:\n&quot;);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">    for (PluginInfo p : pluginRepo.getBundledPluginsInfos()) {</span>
<span class="fc" id="L91">      fileWriter.append(String.format(&quot;  - %s %s (%s)&quot;, p.getName(), p.getVersion(), p.getKey())).append('\n');</span>
<span class="fc" id="L92">    }</span>
<span class="fc" id="L93">  }</span>

  private void writeGlobalSettings(BufferedWriter fileWriter) throws IOException {
<span class="fc" id="L96">    fileWriter.append(&quot;Global server settings:\n&quot;);</span>
<span class="fc" id="L97">    Map&lt;String, String&gt; props = globalServerSettings.properties();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">    for (String prop : new TreeSet&lt;&gt;(props.keySet())) {</span>
<span class="fc" id="L99">      dumpPropIfNotSensitive(fileWriter, prop, props.get(prop));</span>
<span class="fc" id="L100">    }</span>
<span class="fc" id="L101">  }</span>

  private void writeProjectSettings(BufferedWriter fileWriter) throws IOException {
<span class="fc" id="L104">    fileWriter.append(&quot;Project server settings:\n&quot;);</span>
<span class="fc" id="L105">    Map&lt;String, String&gt; props = projectServerSettings.properties();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">    for (String prop : new TreeSet&lt;&gt;(props.keySet())) {</span>
<span class="fc" id="L107">      dumpPropIfNotSensitive(fileWriter, prop, props.get(prop));</span>
<span class="fc" id="L108">    }</span>
<span class="fc" id="L109">    fileWriter.append(&quot;Project scanner properties:\n&quot;);</span>
<span class="fc" id="L110">    writeScannerProps(fileWriter, hierarchy.root().properties());</span>
<span class="fc" id="L111">  }</span>

  private void writeModulesSettings(BufferedWriter fileWriter) throws IOException {
<span class="fc bfc" id="L114" title="All 2 branches covered.">    for (DefaultInputModule module : store.allModules()) {</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">      if (module.equals(hierarchy.root())) {</span>
<span class="fc" id="L116">        continue;</span>
      }
<span class="fc" id="L118">      Map&lt;String, String&gt; moduleSpecificProps = collectModuleSpecificProps(module);</span>
<span class="fc" id="L119">      fileWriter.append(String.format(&quot;Scanner properties of module: %s&quot;, module.key())).append('\n');</span>
<span class="fc" id="L120">      writeScannerProps(fileWriter, moduleSpecificProps);</span>
<span class="fc" id="L121">    }</span>
<span class="fc" id="L122">  }</span>

  private void writeScannerProps(BufferedWriter fileWriter, Map&lt;String, String&gt; props) throws IOException {
<span class="fc bfc" id="L125" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; prop : props.entrySet().stream().sorted(Comparator.comparing(Map.Entry::getKey)).toList()) {</span>
<span class="pc bpc" id="L126" title="3 of 6 branches missed.">      if (isSystemProp(prop.getKey()) || isEnvVariable(prop.getKey()) || !isSqProp(prop.getKey())) {</span>
<span class="nc" id="L127">        continue;</span>
      }
<span class="fc" id="L129">      dumpPropIfNotSensitive(fileWriter, prop.getKey(), prop.getValue());</span>
<span class="fc" id="L130">    }</span>
<span class="fc" id="L131">  }</span>

  private static void dumpPropIfNotSensitive(BufferedWriter fileWriter, String prop, String value) throws IOException {
<span class="fc bfc" id="L134" title="All 2 branches covered.">    fileWriter.append(String.format(KEY_VALUE_FORMAT, prop, isSensitiveProperty(prop) ? &quot;******&quot; : StringUtils.abbreviate(value, MAX_WIDTH))).append('\n');</span>
<span class="fc" id="L135">  }</span>

  /**
   * Only keep props that are not in parent
   */
  private Map&lt;String, String&gt; collectModuleSpecificProps(DefaultInputModule module) {
<span class="fc" id="L141">    Map&lt;String, String&gt; moduleSpecificProps = new HashMap&lt;&gt;();</span>
<span class="fc" id="L142">    AbstractProjectOrModule parent = hierarchy.parent(module);</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">    if (parent == null) {</span>
<span class="nc" id="L144">      moduleSpecificProps.putAll(module.properties());</span>
    } else {
<span class="fc" id="L146">      Map&lt;String, String&gt; parentProps = parent.properties();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">      for (Map.Entry&lt;String, String&gt; entry : module.properties().entrySet()) {</span>
<span class="fc bfc" id="L148" title="All 4 branches covered.">        if (!parentProps.containsKey(entry.getKey()) || !parentProps.get(entry.getKey()).equals(entry.getValue())) {</span>
<span class="fc" id="L149">          moduleSpecificProps.put(entry.getKey(), entry.getValue());</span>
        }
<span class="fc" id="L151">      }</span>
    }
<span class="fc" id="L153">    return moduleSpecificProps;</span>
  }

  private static boolean isSqProp(String propKey) {
<span class="fc" id="L157">    return propKey.startsWith(SONAR_PROP_PREFIX);</span>
  }

  private boolean isSystemProp(String propKey) {
<span class="pc bpc" id="L161" title="3 of 4 branches missed.">    return system.properties().containsKey(propKey) &amp;&amp; !propKey.startsWith(SONAR_PROP_PREFIX);</span>
  }

  private boolean isEnvVariable(String propKey) {
<span class="pc bpc" id="L165" title="3 of 4 branches missed.">    return propKey.startsWith(ENV_PROP_PREFIX) &amp;&amp; system.envVariables().containsKey(propKey.substring(ENV_PROP_PREFIX.length()));</span>
  }

  private static boolean isSensitiveProperty(String key) {
<span class="pc bpc" id="L169" title="1 of 8 branches missed.">    return key.equals(CoreProperties.LOGIN) || key.contains(&quot;.password&quot;) || key.contains(&quot;.secured&quot;) || key.contains(&quot;.token&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>