<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IssueLifecycle.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.ce.task.projectanalysis.issue</a> &gt; <span class="el_source">IssueLifecycle.java</span></div><h1>IssueLifecycle.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.ce.task.projectanalysis.issue;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;
import java.util.Date;
import java.util.Optional;
import jakarta.inject.Inject;
import org.jetbrains.annotations.NotNull;
import org.sonar.api.issue.Issue;
import org.sonar.api.rules.CleanCodeAttribute;
import org.sonar.core.rule.RuleType;
import org.sonar.ce.task.projectanalysis.analysis.AnalysisMetadataHolder;
import org.sonar.core.issue.DefaultImpact;
import org.sonar.core.issue.DefaultIssue;
import org.sonar.core.issue.DefaultIssueComment;
import org.sonar.core.issue.FieldDiffs;
import org.sonar.core.issue.IssueChangeContext;
import org.sonar.core.util.Uuids;
import org.sonar.db.component.BranchType;
import org.sonar.server.issue.IssueFieldsSetter;
import org.sonar.server.issue.workflow.IssueWorkflow;

import static java.util.Objects.requireNonNull;
import static java.util.Optional.ofNullable;
import static org.sonar.core.issue.IssueChangeContext.issueChangeContextByScanBuilder;

/**
 * Sets the appropriate fields when an issue is :
 * &lt;ul&gt;
 * &lt;li&gt;newly created&lt;/li&gt;
 * &lt;li&gt;merged the related base issue&lt;/li&gt;
 * &lt;li&gt;relocated (only manual issues)&lt;/li&gt;
 * &lt;/ul&gt;
 */
public class IssueLifecycle {

  private final IssueWorkflow workflow;
  private final IssueChangeContext changeContext;
  private final RuleRepository ruleRepository;
  private final IssueFieldsSetter updater;
  private final DebtCalculator debtCalculator;
  private final AnalysisMetadataHolder analysisMetadataHolder;

  @Inject
  public IssueLifecycle(AnalysisMetadataHolder analysisMetadataHolder, IssueWorkflow workflow, IssueFieldsSetter updater, DebtCalculator debtCalculator,
    RuleRepository ruleRepository) {
<span class="nc" id="L66">    this(analysisMetadataHolder, issueChangeContextByScanBuilder(new Date(analysisMetadataHolder.getAnalysisDate())).build(), workflow, updater, debtCalculator, ruleRepository);</span>
<span class="nc" id="L67">  }</span>

  @VisibleForTesting
  IssueLifecycle(AnalysisMetadataHolder analysisMetadataHolder, IssueChangeContext changeContext, IssueWorkflow workflow, IssueFieldsSetter updater,
<span class="fc" id="L71">    DebtCalculator debtCalculator, RuleRepository ruleRepository) {</span>
<span class="fc" id="L72">    this.analysisMetadataHolder = analysisMetadataHolder;</span>
<span class="fc" id="L73">    this.workflow = workflow;</span>
<span class="fc" id="L74">    this.updater = updater;</span>
<span class="fc" id="L75">    this.debtCalculator = debtCalculator;</span>
<span class="fc" id="L76">    this.changeContext = changeContext;</span>
<span class="fc" id="L77">    this.ruleRepository = ruleRepository;</span>
<span class="fc" id="L78">  }</span>

  public void initNewOpenIssue(DefaultIssue issue) {
<span class="pc bpc" id="L81" title="2 of 4 branches missed.">    Preconditions.checkArgument(issue.isFromExternalRuleEngine() != (issue.type() == null), &quot;At this stage issue type should be set for and only for external issues&quot;);</span>
<span class="fc" id="L82">    Rule rule = ruleRepository.getByKey(issue.ruleKey());</span>
<span class="fc" id="L83">    issue.setKey(Uuids.create());</span>
<span class="fc" id="L84">    issue.setCreationDate(changeContext.date());</span>
<span class="fc" id="L85">    issue.setUpdateDate(changeContext.date());</span>
<span class="fc" id="L86">    issue.setEffort(debtCalculator.calculate(issue));</span>
<span class="fc" id="L87">    setType(issue, rule);</span>
<span class="fc" id="L88">    setStatus(issue, rule);</span>
<span class="fc" id="L89">    setCleanCodeAttribute(issue, rule);</span>
<span class="fc" id="L90">  }</span>

  private static void setCleanCodeAttribute(DefaultIssue issue, Rule rule) {
<span class="fc" id="L93">    issue.setCleanCodeAttribute(ofNullable(rule.cleanCodeAttribute()).orElse(CleanCodeAttribute.defaultCleanCodeAttribute()));</span>
<span class="fc" id="L94">  }</span>

  private static void setType(DefaultIssue issue, Rule rule) {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">    if (issue.isFromExternalRuleEngine()) {</span>
<span class="nc" id="L98">      return;</span>
    }
<span class="fc" id="L100">    issue.setType(requireNonNull(rule.getType(), &quot;No rule type&quot;));</span>
<span class="fc" id="L101">  }</span>

  private static void setStatus(DefaultIssue issue, Rule rule) {
<span class="pc bpc" id="L104" title="1 of 4 branches missed.">    if (rule.getType() == RuleType.SECURITY_HOTSPOT || issue.type() == RuleType.SECURITY_HOTSPOT) {</span>
<span class="fc" id="L105">      issue.setStatus(Issue.STATUS_TO_REVIEW);</span>
    } else {
<span class="fc" id="L107">      issue.setStatus(Issue.STATUS_OPEN);</span>
    }
<span class="fc" id="L109">  }</span>

  public void copyExistingOpenIssueFromBranch(DefaultIssue raw, DefaultIssue base, String branchName) {
<span class="fc" id="L112">    raw.setKey(Uuids.create());</span>
<span class="fc" id="L113">    raw.setNew(false);</span>
<span class="fc" id="L114">    copyAttributesOfIssueFromAnotherBranch(raw, base);</span>
<span class="fc" id="L115">    raw.setFieldChange(changeContext, IssueFieldsSetter.FROM_BRANCH, branchName, analysisMetadataHolder.getBranch().getName());</span>
<span class="fc" id="L116">  }</span>

  public void mergeConfirmedOrResolvedFromPrOrBranch(DefaultIssue raw, DefaultIssue base, BranchType branchType, String prOrBranchKey) {
<span class="fc" id="L119">    copyAttributesOfIssueFromAnotherBranch(raw, base);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">    String from = (branchType == BranchType.PULL_REQUEST) ? &quot;#&quot; + prOrBranchKey : prOrBranchKey;</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">    String to = analysisMetadataHolder.isPullRequest() ? (&quot;#&quot; + analysisMetadataHolder.getPullRequestKey()) : analysisMetadataHolder.getBranch().getName();</span>
<span class="fc" id="L122">    raw.setFieldChange(changeContext, IssueFieldsSetter.FROM_BRANCH, from, to);</span>
<span class="fc" id="L123">  }</span>

  public void copyExistingIssueFromSourceBranchToPullRequest(DefaultIssue raw, DefaultIssue base) {
<span class="fc" id="L126">    Preconditions.checkState(analysisMetadataHolder.isPullRequest(), &quot;This operation should be done only on pull request analysis&quot;);</span>
<span class="fc" id="L127">    copyAttributesOfIssueFromAnotherBranch(raw, base);</span>
<span class="fc" id="L128">    String from = analysisMetadataHolder.getBranch().getName();</span>
<span class="fc" id="L129">    String to = &quot;#&quot; + analysisMetadataHolder.getPullRequestKey();</span>
<span class="fc" id="L130">    raw.setFieldChange(changeContext, IssueFieldsSetter.FROM_BRANCH, from, to);</span>
<span class="fc" id="L131">  }</span>

  public void copyAttributesOfIssueFromAnotherBranch(DefaultIssue to, DefaultIssue from) {
<span class="fc" id="L134">    to.setCopied(true);</span>
<span class="fc" id="L135">    copyFields(to, from);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (from.manualSeverity()) {</span>
<span class="nc" id="L137">      to.setManualSeverity(true);</span>
<span class="nc" id="L138">      to.setSeverity(from.severity());</span>
    }

<span class="fc" id="L141">    from.getImpacts()</span>
<span class="fc" id="L142">      .stream().filter(DefaultImpact::manualSeverity)</span>
<span class="pc" id="L143">      .forEach(i -&gt; to.addImpact(i.softwareQuality(), i.severity(), true));</span>
<span class="fc" id="L144">    to.setCleanCodeAttribute(from.getCleanCodeAttribute());</span>
<span class="fc" id="L145">    copyChangesOfIssueFromOtherBranch(to, from);</span>
<span class="fc" id="L146">  }</span>

  private static void copyChangesOfIssueFromOtherBranch(DefaultIssue raw, DefaultIssue base) {
<span class="fc" id="L149">    base.defaultIssueComments().forEach(c -&gt; raw.addComment(copyComment(raw.key(), c)));</span>
<span class="fc" id="L150">    base.changes().forEach(c -&gt; copyFieldDiffOfIssueFromOtherBranch(raw.key(), c).ifPresent(raw::addChange));</span>
<span class="fc" id="L151">  }</span>

  /**
   * Copy a comment from another issue
   */
  private static DefaultIssueComment copyComment(String issueKey, DefaultIssueComment c) {
<span class="fc" id="L157">    DefaultIssueComment comment = new DefaultIssueComment();</span>
<span class="fc" id="L158">    comment.setIssueKey(issueKey);</span>
<span class="fc" id="L159">    comment.setKey(Uuids.create());</span>
<span class="fc" id="L160">    comment.setUserUuid(c.userUuid());</span>
<span class="fc" id="L161">    comment.setMarkdownText(c.markdownText());</span>
<span class="fc" id="L162">    comment.setCreatedAt(c.createdAt()).setUpdatedAt(c.updatedAt());</span>
<span class="fc" id="L163">    comment.setNew(true);</span>
<span class="fc" id="L164">    return comment;</span>
  }

  /**
   * Copy a diff from another issue
   */
  private static Optional&lt;FieldDiffs&gt; copyFieldDiffOfIssueFromOtherBranch(String issueKey, FieldDiffs source) {
<span class="fc" id="L171">    FieldDiffs result = new FieldDiffs();</span>
<span class="fc" id="L172">    result.setIssueKey(issueKey);</span>
<span class="fc" id="L173">    source.userUuid().ifPresent(result::setUserUuid);</span>
<span class="fc" id="L174">    source.webhookSource().ifPresent(result::setWebhookSource);</span>
<span class="fc" id="L175">    source.externalUser().ifPresent(result::setExternalUser);</span>
<span class="fc" id="L176">    result.setCreationDate(source.creationDate());</span>
    // Don't copy &quot;file&quot; changelogs as they refer to file uuids that might later be purged
<span class="fc" id="L178">    source.diffs().entrySet().stream()</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">      .filter(e -&gt; !e.getKey().equals(IssueFieldsSetter.FILE))</span>
<span class="fc" id="L180">      .forEach(e -&gt; result.setDiff(e.getKey(), e.getValue().oldValue(), e.getValue().newValue()));</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">    if (result.diffs().isEmpty()) {</span>
<span class="fc" id="L182">      return Optional.empty();</span>
    }
<span class="fc" id="L184">    return Optional.of(result);</span>
  }

  public void mergeExistingOpenIssue(DefaultIssue raw, DefaultIssue base) {
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">    Preconditions.checkArgument(raw.isFromExternalRuleEngine() != (raw.type() == null), &quot;At this stage issue type should be set for and only for external issues&quot;);</span>
<span class="fc" id="L189">    Rule rule = ruleRepository.getByKey(raw.ruleKey());</span>
<span class="fc" id="L190">    raw.setKey(base.key());</span>
<span class="fc" id="L191">    raw.setNew(false);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">    if (base.isChanged()) {</span>
      // In case issue was moved from module or folder to the root project
<span class="fc" id="L194">      raw.setChanged(true);</span>
    }
<span class="fc" id="L196">    setType(raw, rule);</span>
<span class="fc" id="L197">    setCleanCodeAttribute(raw, rule);</span>
<span class="fc" id="L198">    copyFields(raw, base);</span>
<span class="fc" id="L199">    base.changes().forEach(raw::addChange);</span>

<span class="fc bfc" id="L201" title="All 2 branches covered.">    if (base.manualSeverity()) {</span>
<span class="fc" id="L202">      raw.setManualSeverity(true);</span>
<span class="fc" id="L203">      raw.setSeverity(base.severity());</span>
    } else {
<span class="fc" id="L205">      updater.setPastSeverity(raw, base.severity(), changeContext);</span>
    }
    // set component/module related fields from base in case current component has been moved
    // (in which case base issue belongs to original file and raw issue to component)
<span class="fc" id="L209">    raw.setComponentUuid(base.componentUuid());</span>
<span class="fc" id="L210">    raw.setComponentKey(base.componentKey());</span>

    // fields coming from raw
<span class="fc" id="L213">    updater.setPastLine(raw, base.getLine());</span>
<span class="fc" id="L214">    updater.setPastLocations(raw, base.getLocations());</span>
<span class="fc" id="L215">    updater.setRuleDescriptionContextKey(raw, base.getRuleDescriptionContextKey().orElse(null));</span>
<span class="fc" id="L216">    updater.setPastMessage(raw, base.getMessage(), base.getMessageFormattings(), changeContext);</span>
<span class="fc" id="L217">    updater.setPastGap(raw, base.gap(), changeContext);</span>
<span class="fc" id="L218">    updater.setPastEffort(raw, base.effort(), changeContext);</span>
<span class="fc" id="L219">    updater.setCodeVariants(raw, requireNonNull(base.codeVariants()), changeContext);</span>
<span class="fc" id="L220">    updater.setImpacts(raw, base.getImpacts(), changeContext);</span>
<span class="fc" id="L221">    updater.setCleanCodeAttribute(raw, base.getCleanCodeAttribute(), changeContext);</span>
<span class="fc" id="L222">    updater.setPrioritizedRule(raw, base.isPrioritizedRule(), changeContext);</span>
<span class="fc" id="L223">  }</span>

  public void doAutomaticTransition(DefaultIssue issue) {
<span class="fc" id="L226">    workflow.doAutomaticTransition(issue, changeContext);</span>
<span class="fc" id="L227">  }</span>

  public void doManualTransition(DefaultIssue issue, String transitionKey, String userUuid) {
<span class="fc" id="L230">    workflow.doManualTransition(issue, transitionKey, getIssueChangeContextWithUser(userUuid));</span>
<span class="fc" id="L231">  }</span>

  public void addComment(DefaultIssue issue, String comment, String userUuid) {
<span class="fc" id="L234">    updater.addComment(issue, comment, getIssueChangeContextWithUser(userUuid));</span>
<span class="fc" id="L235">  }</span>

  @NotNull
  private IssueChangeContext getIssueChangeContextWithUser(String userUuid) {
<span class="fc" id="L239">    return IssueChangeContext.newBuilder()</span>
<span class="fc" id="L240">      .setDate(changeContext.date())</span>
<span class="fc" id="L241">      .setWebhookSource(changeContext.getWebhookSource())</span>
<span class="fc" id="L242">      .setUserUuid(userUuid).build();</span>
  }

  private void copyFields(DefaultIssue toIssue, DefaultIssue fromIssue) {
<span class="fc" id="L246">    toIssue.setType(fromIssue.type());</span>
<span class="fc" id="L247">    toIssue.setCreationDate(fromIssue.creationDate());</span>
<span class="fc" id="L248">    toIssue.setUpdateDate(fromIssue.updateDate());</span>
<span class="fc" id="L249">    toIssue.setCloseDate(fromIssue.closeDate());</span>
<span class="fc" id="L250">    toIssue.setResolution(fromIssue.resolution());</span>
<span class="fc" id="L251">    toIssue.setStatus(fromIssue.status());</span>
<span class="fc" id="L252">    toIssue.setAssigneeUuid(fromIssue.assignee());</span>
<span class="fc" id="L253">    toIssue.setAssigneeLogin(fromIssue.assigneeLogin());</span>
<span class="fc" id="L254">    toIssue.setAuthorLogin(fromIssue.authorLogin());</span>
<span class="fc" id="L255">    toIssue.setTags(fromIssue.tags());</span>
<span class="fc" id="L256">    toIssue.setEffort(debtCalculator.calculate(toIssue));</span>
<span class="fc" id="L257">    toIssue.setOnDisabledRule(fromIssue.isOnDisabledRule());</span>
<span class="fc" id="L258">    toIssue.setSelectedAt(fromIssue.selectedAt());</span>
<span class="fc" id="L259">    toIssue.setIsNewCodeReferenceIssue(fromIssue.isNewCodeReferenceIssue());</span>
<span class="fc" id="L260">    toIssue.setPrioritizedRule(fromIssue.isPrioritizedRule());</span>
<span class="fc" id="L261">    toIssue.setFromSonarQubeUpdate(fromIssue.isFromSonarQubeUpdate());</span>
<span class="fc" id="L262">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>