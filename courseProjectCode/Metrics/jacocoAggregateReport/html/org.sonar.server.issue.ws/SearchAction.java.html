<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.issue.ws</a> &gt; <span class="el_source">SearchAction.java</span></div><h1>SearchAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.issue.ws;

import com.google.common.collect.Lists;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.EnumSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import java.util.Objects;
import javax.annotation.Nullable;
import org.apache.lucene.search.TotalHits;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.search.SearchHit;
import org.sonar.api.issue.IssueStatus;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.Severity;
import org.sonar.api.rules.CleanCodeAttributeCategory;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.Param;
import org.sonar.api.utils.Paging;
import org.sonar.api.utils.System2;
import org.sonar.core.rule.RuleType;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.user.UserDto;
import org.sonar.server.es.Facets;
import org.sonar.server.es.SearchOptions;
import org.sonar.server.issue.SearchRequest;
import org.sonar.server.issue.index.IssueIndex;
import org.sonar.server.issue.index.IssueIndexSyncProgressChecker;
import org.sonar.server.issue.index.IssueQuery;
import org.sonar.server.issue.index.IssueQueryFactory;
import org.sonar.server.issue.index.IssueScope;
import org.sonar.server.issue.workflow.codequalityissue.CodeQualityIssueWorkflowTransition;
import org.sonar.server.security.SecurityStandards.SQCategory;
import org.sonar.server.issue.FromSonarQubeUpdateFeature;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Issues.SearchWsResponse;

import static com.google.common.base.MoreObjects.firstNonNull;
import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Iterables.concat;
import static com.google.common.collect.Sets.newHashSet;
import static java.lang.String.format;
import static java.util.Collections.emptyList;
import static java.util.Collections.singletonList;
import static java.util.Optional.ofNullable;
import static org.sonar.api.issue.Issue.RESOLUTIONS;
import static org.sonar.api.issue.Issue.RESOLUTION_FIXED;
import static org.sonar.api.issue.Issue.RESOLUTION_REMOVED;
import static org.sonar.api.issue.Issue.STATUS_OPEN;
import static org.sonar.api.issue.Issue.STATUS_REOPENED;
import static org.sonar.api.issue.Issue.STATUS_REVIEWED;
import static org.sonar.api.issue.Issue.STATUS_TO_REVIEW;
import static org.sonar.api.issue.impact.Severity.BLOCKER;
import static org.sonar.api.issue.impact.Severity.HIGH;
import static org.sonar.api.issue.impact.Severity.INFO;
import static org.sonar.api.issue.impact.Severity.MEDIUM;
import static org.sonar.api.issue.impact.Severity.values;
import static org.sonar.api.server.ws.WebService.Param.FACETS;
import static org.sonar.api.utils.Paging.forPageIndex;
import static org.sonar.server.es.SearchOptions.MAX_PAGE_SIZE;
import static org.sonar.server.issue.index.IssueIndex.FACET_ASSIGNED_TO_ME;
import static org.sonar.server.issue.index.IssueIndex.FACET_PROJECTS;
import static org.sonar.server.issue.index.IssueQueryFactory.ISSUE_STATUSES;
import static org.sonar.server.issue.index.IssueQueryFactory.UNKNOWN;
import static org.sonar.server.security.SecurityStandards.SANS_TOP_25_INSECURE_INTERACTION;
import static org.sonar.server.security.SecurityStandards.SANS_TOP_25_POROUS_DEFENSES;
import static org.sonar.server.security.SecurityStandards.SANS_TOP_25_RISKY_RESOURCE;
import static org.sonar.server.security.SecurityStandards.UNKNOWN_STANDARD;
import static org.sonar.server.ws.KeyExamples.KEY_BRANCH_EXAMPLE_001;
import static org.sonar.server.ws.KeyExamples.KEY_PROJECT_EXAMPLE_001;
import static org.sonar.server.ws.KeyExamples.KEY_PULL_REQUEST_EXAMPLE_001;
import static org.sonar.server.ws.WsUtils.writeProtobuf;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.ACTION_SEARCH;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ADDITIONAL_FIELDS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ASC;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ASSIGNED;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ASSIGNEES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_AUTHOR;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_BRANCH;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CASA;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CODE_VARIANTS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_COMPONENTS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_COMPONENT_KEYS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CREATED_AFTER;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CREATED_AT;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CREATED_BEFORE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CREATED_IN_LAST;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_CWE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_DIRECTORIES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_FILES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_FIXED_IN_PULL_REQUEST;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_IMPACT_SEVERITIES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_IMPACT_SOFTWARE_QUALITIES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_IN_NEW_CODE_PERIOD;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ISSUES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ISSUE_STATUSES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_LANGUAGES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ON_COMPONENT_ONLY;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_OWASP_ASVS_40;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_OWASP_ASVS_LEVEL;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_OWASP_MOBILE_TOP_10_2024;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_OWASP_TOP_10;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_OWASP_TOP_10_2021;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_PCI_DSS_32;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_PCI_DSS_40;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_PRIORITIZED_RULE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_FROM_SONAR_QUBE_UPDATE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_PROJECTS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_PULL_REQUEST;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_RESOLUTIONS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_RESOLVED;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_RULES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_SANS_TOP_25;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_SCOPES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_SEVERITIES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_SONARSOURCE_SECURITY;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_STATUSES;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_STIG_ASD_V5R3;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_TAGS;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_TIMEZONE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_TYPES;

public class SearchAction implements IssuesWsAction {
  private static final String LOGIN_MYSELF = &quot;__me__&quot;;
<span class="fc" id="L155">  private static final Set&lt;String&gt; ISSUE_SCOPES = Arrays.stream(IssueScope.values()).map(Enum::name).collect(Collectors.toSet());</span>
<span class="fc" id="L156">  private static final EnumSet&lt;RuleType&gt; ALL_RULE_TYPES_EXCEPT_SECURITY_HOTSPOTS = EnumSet.complementOf(EnumSet.of(RuleType.SECURITY_HOTSPOT));</span>

<span class="fc" id="L158">  static final List&lt;String&gt; BASE_SUPPORTED_FACETS = List.of(</span>
    FACET_PROJECTS,
    PARAM_FILES,
    FACET_ASSIGNED_TO_ME,
    PARAM_SEVERITIES,
    PARAM_STATUSES,
    PARAM_RESOLUTIONS,
    PARAM_RULES,
    PARAM_ASSIGNEES,
    PARAM_AUTHOR,
    PARAM_DIRECTORIES,
    PARAM_SCOPES,
    PARAM_LANGUAGES,
    PARAM_TAGS,
    PARAM_TYPES,
    PARAM_PCI_DSS_32,
    PARAM_PCI_DSS_40,
    PARAM_OWASP_ASVS_40,
    PARAM_OWASP_MOBILE_TOP_10_2024,
    PARAM_OWASP_TOP_10,
    PARAM_OWASP_TOP_10_2021,
    PARAM_STIG_ASD_V5R3,
    PARAM_CASA,
    PARAM_SANS_TOP_25,
    PARAM_CWE,
    PARAM_CREATED_AT,
    PARAM_SONARSOURCE_SECURITY,
    PARAM_CODE_VARIANTS,
    PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES,
    PARAM_IMPACT_SOFTWARE_QUALITIES,
    PARAM_IMPACT_SEVERITIES,
    PARAM_ISSUE_STATUSES,
    PARAM_PRIORITIZED_RULE);

  private static final String INTERNAL_PARAMETER_DISCLAIMER = &quot;This parameter is mostly used by the Issues page, please prefer usage of &quot; +
    &quot;the componentKeys parameter. &quot;;
  private static final String NEW_FACET_ADDED_MESSAGE = &quot;Facet '%s' has been added&quot;;
  private static final String NEW_PARAM_ADDED_MESSAGE = &quot;Param '%s' has been added&quot;;
  private static final String V_2025_3 = &quot;2025.3&quot;;
  private static final String V_2025_5 = &quot;2025.5&quot;;
<span class="fc" id="L198">  private static final Set&lt;String&gt; FACETS_REQUIRING_PROJECT = newHashSet(PARAM_FILES, PARAM_DIRECTORIES);</span>

  private final UserSession userSession;
  private final IssueIndex issueIndex;
  private final IssueQueryFactory issueQueryFactory;
  private final IssueIndexSyncProgressChecker issueIndexSyncProgressChecker;
  private final SearchResponseLoader searchResponseLoader;
  private final SearchResponseFormat searchResponseFormat;
  private final System2 system2;
  private final DbClient dbClient;
  private final FromSonarQubeUpdateFeature fromSonarQubeUpdateFeature;

  public SearchAction(UserSession userSession, IssueIndex issueIndex, IssueQueryFactory issueQueryFactory,
    IssueIndexSyncProgressChecker issueIndexSyncProgressChecker,
    SearchResponseLoader searchResponseLoader, SearchResponseFormat searchResponseFormat, System2 system2, DbClient dbClient,
<span class="fc" id="L213">    FromSonarQubeUpdateFeature fromSonarQubeUpdateFeature) {</span>
<span class="fc" id="L214">    this.userSession = userSession;</span>
<span class="fc" id="L215">    this.issueIndex = issueIndex;</span>
<span class="fc" id="L216">    this.issueQueryFactory = issueQueryFactory;</span>
<span class="fc" id="L217">    this.issueIndexSyncProgressChecker = issueIndexSyncProgressChecker;</span>
<span class="fc" id="L218">    this.searchResponseLoader = searchResponseLoader;</span>
<span class="fc" id="L219">    this.searchResponseFormat = searchResponseFormat;</span>
<span class="fc" id="L220">    this.system2 = system2;</span>
<span class="fc" id="L221">    this.dbClient = dbClient;</span>
<span class="fc" id="L222">    this.fromSonarQubeUpdateFeature = fromSonarQubeUpdateFeature;</span>
<span class="fc" id="L223">  }</span>

  private List&lt;String&gt; getSupportedFacets() {
<span class="fc" id="L226">    return Stream.concat(</span>
<span class="fc" id="L227">      BASE_SUPPORTED_FACETS.stream(),</span>
<span class="fc" id="L228">      Stream.of(</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">        fromSonarQubeUpdateFeature.isAvailable() ? PARAM_FROM_SONAR_QUBE_UPDATE : null</span>
<span class="fc" id="L230">      ).filter(Objects::nonNull)</span>
<span class="fc" id="L231">    ).toList();</span>
  }

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L236">    WebService.NewAction action = controller</span>
<span class="fc" id="L237">      .createAction(ACTION_SEARCH)</span>
<span class="fc" id="L238">      .setHandler(this)</span>
<span class="fc" id="L239">      .setDescription(&quot;Search for issues.&lt;br&gt;Requires the 'Browse' permission on the specified project(s). &lt;br&gt;&quot;</span>
        + &quot;For applications, it also requires 'Browse' permission on its child projects.&quot;
        + &quot;&lt;br/&gt;When issue indexing is in progress returns 503 service unavailable HTTP code.&quot;)
<span class="fc" id="L242">      .setSince(&quot;3.6&quot;)</span>
<span class="fc" id="L243">      .setChangelog(</span>
<span class="fc" id="L244">        new Change(V_2025_5, format(NEW_FACET_ADDED_MESSAGE, PARAM_FROM_SONAR_QUBE_UPDATE)),</span>
<span class="fc" id="L245">        new Change(V_2025_5, format(NEW_PARAM_ADDED_MESSAGE, PARAM_FROM_SONAR_QUBE_UPDATE)),</span>
<span class="fc" id="L246">        new Change(V_2025_3, format(NEW_FACET_ADDED_MESSAGE, PARAM_OWASP_MOBILE_TOP_10_2024)),</span>
<span class="fc" id="L247">        new Change(V_2025_3, format(NEW_PARAM_ADDED_MESSAGE, PARAM_OWASP_MOBILE_TOP_10_2024)),</span>
        new Change(&quot;10.8&quot;, &quot;The response fields 'severity' and 'type' are not deprecated anymore..&quot;),
        new Change(&quot;10.8&quot;, &quot;The fields 'severity' and 'type' are not deprecated anymore.&quot;),
<span class="fc" id="L250">        new Change(&quot;10.8&quot;, format(&quot;The parameters '%s' and '%s' are not deprecated anymore.&quot;, PARAM_SEVERITIES, PARAM_TYPES)),</span>
<span class="fc" id="L251">        new Change(&quot;10.8&quot;, format(&quot;Possible values '%s' and '%s' for response field 'impactSeverities' of 'facets' have been added.&quot;, INFO.name(), BLOCKER.name())),</span>
<span class="fc" id="L252">        new Change(&quot;10.8&quot;, format(&quot;Possible values '%s' and '%s' for response field 'severity' of 'impacts' have been added.&quot;, INFO.name(), BLOCKER.name())),</span>
<span class="fc" id="L253">        new Change(&quot;10.8&quot;, format(&quot;Parameter '%s' now supports values: '%s','%s'.&quot;, PARAM_SEVERITIES, INFO.name(), BLOCKER.name())),</span>
<span class="fc" id="L254">        new Change(&quot;10.7&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_CASA)),</span>
<span class="fc" id="L255">        new Change(&quot;10.7&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_CASA)),</span>
<span class="fc" id="L256">        new Change(&quot;10.7&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_STIG_ASD_V5R3)),</span>
<span class="fc" id="L257">        new Change(&quot;10.7&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_STIG_ASD_V5R3)),</span>
<span class="fc" id="L258">        new Change(&quot;10.6&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_PRIORITIZED_RULE)),</span>
<span class="fc" id="L259">        new Change(&quot;10.6&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_PRIORITIZED_RULE)),</span>
<span class="fc" id="L260">        new Change(&quot;10.4&quot;, &quot;Added new param '%s'&quot;.formatted(PARAM_FIXED_IN_PULL_REQUEST)),</span>
        new Change(&quot;10.4&quot;,
<span class="fc" id="L262">          &quot;Value '%s' for 'transition' response field is deprecated, use '%s' instead&quot;.formatted(CodeQualityIssueWorkflowTransition.WONT_FIX,</span>
            CodeQualityIssueWorkflowTransition.ACCEPT)),
<span class="fc" id="L264">        new Change(&quot;10.4&quot;, &quot;Possible value '%s' for 'transition' response field has been added&quot;.formatted(CodeQualityIssueWorkflowTransition.ACCEPT)),</span>
<span class="fc" id="L265">        new Change(&quot;10.4&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_ISSUE_STATUSES)),</span>
<span class="fc" id="L266">        new Change(&quot;10.4&quot;, format(&quot;Parameters '%s' and '%s' are deprecated in favor of '%s'.&quot;, PARAM_RESOLUTIONS, PARAM_STATUSES, PARAM_ISSUE_STATUSES)),</span>
<span class="fc" id="L267">        new Change(&quot;10.4&quot;, format(&quot;Parameters '%s' and '%s' are deprecated, use '%s' and '%s' instead.&quot;, PARAM_SEVERITIES, PARAM_TYPES,</span>
          PARAM_IMPACT_SEVERITIES, PARAM_IMPACT_SOFTWARE_QUALITIES)),
<span class="fc" id="L269">        new Change(&quot;10.4&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_ISSUE_STATUSES)),</span>
<span class="fc" id="L270">        new Change(&quot;10.4&quot;, format(&quot;Facets '%s' and '%s' are deprecated in favor of '%s'&quot;, PARAM_RESOLUTIONS, PARAM_STATUSES, PARAM_ISSUE_STATUSES)),</span>
        new Change(&quot;10.4&quot;, &quot;Response fields 'severity' and 'type' are deprecated, use 'impacts' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;Response field 'issueStatus' added&quot;),
        new Change(&quot;10.4&quot;, &quot;Response fields 'status' and 'resolutions' are deprecated, in favor of 'issueStatus'&quot;),
<span class="fc" id="L274">        new Change(&quot;10.4&quot;, format(&quot;Possible value '%s' for 'issueStatus' field is deprecated.&quot;, IssueStatus.CONFIRMED)),</span>
        new Change(&quot;10.2&quot;, &quot;Add 'impacts', 'cleanCodeAttribute', 'cleanCodeAttributeCategory' fields to the response&quot;),
<span class="fc" id="L276">        new Change(&quot;10.2&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_IMPACT_SOFTWARE_QUALITIES)),</span>
<span class="fc" id="L277">        new Change(&quot;10.2&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_IMPACT_SEVERITIES)),</span>
<span class="fc" id="L278">        new Change(&quot;10.2&quot;, format(NEW_PARAM_ADDED_MESSAGE, PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES)),</span>
<span class="fc" id="L279">        new Change(&quot;10.2&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_IMPACT_SOFTWARE_QUALITIES)),</span>
<span class="fc" id="L280">        new Change(&quot;10.2&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_IMPACT_SEVERITIES)),</span>
<span class="fc" id="L281">        new Change(&quot;10.2&quot;, format(NEW_FACET_ADDED_MESSAGE, PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES)),</span>
<span class="fc" id="L282">        new Change(&quot;10.2&quot;, format(&quot;Parameter '%s' renamed to '%s'&quot;, PARAM_COMPONENT_KEYS, PARAM_COMPONENTS)),</span>
        new Change(&quot;10.1&quot;, &quot;Add the 'codeVariants' parameter, facet and response field&quot;),
        new Change(&quot;10.0&quot;, &quot;Parameter 'sansTop25' is deprecated&quot;),
        new Change(&quot;10.0&quot;, &quot;The value 'sansTop25' for the parameter 'facets' has been deprecated&quot;),
<span class="fc" id="L286">        new Change(&quot;10.0&quot;, format(&quot;Deprecated value 'ASSIGNEE' in parameter '%s' is dropped&quot;, Param.SORT)),</span>
<span class="fc" id="L287">        new Change(&quot;10.0&quot;, format(&quot;Parameter 'sinceLeakPeriod' is removed, please use '%s' instead&quot;, PARAM_IN_NEW_CODE_PERIOD)),</span>
        new Change(&quot;9.8&quot;, &quot;Add message formatting to issue and locations response&quot;),
        new Change(&quot;9.8&quot;, &quot;response fields 'total', 's', 'ps' have been deprecated, please use 'paging' object instead&quot;),
        new Change(&quot;9.7&quot;, &quot;Issues flows in the response may contain a description and a type&quot;),
        new Change(&quot;9.6&quot;, &quot;Response field 'fromHotspot' dropped.&quot;),
        new Change(&quot;9.6&quot;, &quot;Added facets 'pciDss-3.2' and 'pciDss-4.0&quot;),
        new Change(&quot;9.6&quot;, &quot;Added parameters 'pciDss-3.2' and 'pciDss-4.0&quot;),
        new Change(&quot;9.6&quot;, &quot;Response field 'ruleDescriptionContextKey' added&quot;),
        new Change(&quot;9.6&quot;, &quot;New possible value for 'additionalFields' parameter: 'ruleDescriptionContextKey'&quot;),
        new Change(&quot;9.6&quot;, &quot;Facet 'moduleUuids' is dropped.&quot;),
<span class="fc" id="L297">        new Change(&quot;9.4&quot;, format(&quot;Parameter 'sinceLeakPeriod' is deprecated, please use '%s' instead&quot;, PARAM_IN_NEW_CODE_PERIOD)),</span>
        new Change(&quot;9.2&quot;, &quot;Response field 'quickFixAvailable' added&quot;),
        new Change(&quot;9.1&quot;, &quot;Deprecated parameters 'authors', 'facetMode' and 'moduleUuids' were dropped&quot;),
        new Change(&quot;8.6&quot;, &quot;Parameter 'timeZone' added&quot;),
        new Change(&quot;8.5&quot;, &quot;Facet 'fileUuids' is dropped in favour of the new facet 'files'&quot; +
          &quot;Note that they are not strictly identical, the latter returns the file paths.&quot;),
        new Change(&quot;8.5&quot;, &quot;Internal parameter 'fileUuids' has been dropped&quot;),
        new Change(&quot;8.4&quot;, &quot;parameters 'componentUuids', 'projectKeys' has been dropped.&quot;),
        new Change(&quot;8.2&quot;, &quot;'REVIEWED', 'TO_REVIEW' status param values are no longer supported&quot;),
        new Change(&quot;8.2&quot;, &quot;Security hotspots are no longer returned as type 'SECURITY_HOTSPOT' is not supported anymore, use dedicated &quot; +
          &quot;api/hotspots&quot;),
        new Change(&quot;8.2&quot;, &quot;response field 'fromHotspot' has been deprecated and is no more populated&quot;),
        new Change(&quot;8.2&quot;, &quot;Status 'IN_REVIEW' for Security Hotspots has been deprecated&quot;),
<span class="fc" id="L310">        new Change(&quot;7.8&quot;, format(&quot;added new Security Hotspots statuses : %s, %s and %s&quot;, STATUS_TO_REVIEW, &quot;IN_REVIEW&quot;,</span>
          STATUS_REVIEWED)),
        new Change(&quot;7.8&quot;, &quot;Security hotspots are returned by default&quot;),
<span class="fc" id="L313">        new Change(&quot;7.7&quot;, format(&quot;Value 'authors' in parameter '%s' is deprecated, please use '%s' instead&quot;, FACETS, PARAM_AUTHOR)),</span>
<span class="fc" id="L314">        new Change(&quot;7.6&quot;, format(&quot;The use of module keys in parameter '%s' is deprecated&quot;, PARAM_COMPONENT_KEYS)),</span>
        new Change(&quot;7.4&quot;, &quot;The facet 'projectUuids' is dropped in favour of the new facet 'projects'. &quot; +
          &quot;Note that they are not strictly identical, the latter returns the project keys.&quot;),
        new Change(&quot;7.4&quot;, &quot;Parameter 'facetMode' does not accept anymore deprecated value 'debt'&quot;),
        new Change(&quot;7.3&quot;, &quot;response field 'fromHotspot' added to issues that are security hotspots&quot;),
        new Change(&quot;7.3&quot;, &quot;added facets 'sansTop25', 'owaspTop10' and 'cwe'&quot;),
        new Change(&quot;7.2&quot;, &quot;response field 'externalRuleEngine' added to issues that have been imported from an external rule engine&quot;),
<span class="fc" id="L321">        new Change(&quot;7.2&quot;, format(&quot;value 'ASSIGNEE' in parameter '%s' is deprecated, it won't have any effect&quot;, Param.SORT)),</span>
        new Change(&quot;6.5&quot;, &quot;parameters 'projects', 'projectUuids', 'moduleUuids', 'directories', 'fileUuids' are marked as internal&quot;),
        new Change(&quot;6.3&quot;, &quot;response field 'email' is renamed 'avatar'&quot;),
        new Change(&quot;5.5&quot;, &quot;response fields 'reporter' and 'actionPlan' are removed (drop of action plan and manual issue features)&quot;),
        new Change(&quot;5.5&quot;, &quot;parameters 'reporters', 'actionPlans' and 'planned' are dropped and therefore ignored (drop of action plan and&quot; +
          &quot; manual issue features)&quot;),
        new Change(&quot;5.5&quot;, &quot;response field 'debt' is renamed 'effort'&quot;))
<span class="fc" id="L328">      .setResponseExample(getClass().getResource(&quot;search-example.json&quot;));</span>

<span class="fc" id="L330">    action.addPagingParams(100, MAX_PAGE_SIZE);</span>
<span class="fc" id="L331">    action.createParam(FACETS)</span>
<span class="fc" id="L332">      .setDescription(&quot;Comma-separated list of the facets to be computed. No facet is computed by default.&quot;)</span>
<span class="fc" id="L333">      .setPossibleValues(getSupportedFacets());</span>
<span class="fc" id="L334">    action.addSortParams(IssueQuery.SORTS, null, true);</span>
<span class="fc" id="L335">    action.createParam(PARAM_ADDITIONAL_FIELDS)</span>
<span class="fc" id="L336">      .setSince(&quot;5.2&quot;)</span>
<span class="fc" id="L337">      .setDescription(&quot;Comma-separated list of the optional fields to be returned in response. Action plans are dropped in 5.5, it is not&quot; +</span>
        &quot; returned in the response.&quot;)
<span class="fc" id="L339">      .setPossibleValues(SearchAdditionalField.possibleValues());</span>
<span class="fc" id="L340">    addComponentRelatedParams(action);</span>
<span class="fc" id="L341">    action.createParam(PARAM_ISSUES)</span>
<span class="fc" id="L342">      .setDescription(&quot;Comma-separated list of issue keys&quot;)</span>
<span class="fc" id="L343">      .setExampleValue(&quot;5bccd6e8-f525-43a2-8d76-fcb13dde79ef&quot;);</span>
<span class="fc" id="L344">    action.createParam(PARAM_SEVERITIES)</span>
<span class="fc" id="L345">      .setDescription(&quot;Comma-separated list of severities&quot;)</span>
<span class="fc" id="L346">      .setExampleValue(Severity.BLOCKER + &quot;,&quot; + Severity.CRITICAL)</span>
<span class="fc" id="L347">      .setPossibleValues(Severity.ALL);</span>
<span class="fc" id="L348">    action.createParam(PARAM_IMPACT_SOFTWARE_QUALITIES)</span>
<span class="fc" id="L349">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L350">      .setDescription(&quot;Comma-separated list of Software Qualities&quot;)</span>
<span class="fc" id="L351">      .setExampleValue(SoftwareQuality.MAINTAINABILITY + &quot;,&quot; + SoftwareQuality.RELIABILITY)</span>
<span class="fc" id="L352">      .setPossibleValues(SoftwareQuality.values());</span>
<span class="fc" id="L353">    action.createParam(PARAM_IMPACT_SEVERITIES)</span>
<span class="fc" id="L354">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L355">      .setDescription(&quot;Comma-separated list of Software Quality Severities&quot;)</span>
<span class="fc" id="L356">      .setExampleValue(HIGH + &quot;,&quot; + MEDIUM)</span>
<span class="fc" id="L357">      .setPossibleValues(values());</span>
<span class="fc" id="L358">    action.createParam(PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES)</span>
<span class="fc" id="L359">      .setSince(&quot;10.2&quot;)</span>
<span class="fc" id="L360">      .setDescription(&quot;Comma-separated list of Clean Code Attribute Categories&quot;)</span>
<span class="fc" id="L361">      .setExampleValue(CleanCodeAttributeCategory.ADAPTABLE + &quot;,&quot; + CleanCodeAttributeCategory.INTENTIONAL)</span>
<span class="fc" id="L362">      .setPossibleValues(CleanCodeAttributeCategory.values());</span>
<span class="fc" id="L363">    action.createParam(PARAM_STATUSES)</span>
<span class="fc" id="L364">      .setDescription(&quot;Comma-separated list of statuses&quot;)</span>
<span class="fc" id="L365">      .setExampleValue(STATUS_OPEN + &quot;,&quot; + STATUS_REOPENED)</span>
<span class="fc" id="L366">      .setPossibleValues(ISSUE_STATUSES)</span>
<span class="fc" id="L367">      .setDeprecatedSince(&quot;10.4&quot;);</span>
<span class="fc" id="L368">    action.createParam(PARAM_RESOLUTIONS)</span>
<span class="fc" id="L369">      .setDescription(&quot;Comma-separated list of resolutions&quot;)</span>
<span class="fc" id="L370">      .setExampleValue(RESOLUTION_FIXED + &quot;,&quot; + RESOLUTION_REMOVED)</span>
<span class="fc" id="L371">      .setPossibleValues(RESOLUTIONS);</span>
<span class="fc" id="L372">    action.createParam(PARAM_RESOLVED)</span>
<span class="fc" id="L373">      .setDescription(&quot;To match resolved or unresolved issues&quot;)</span>
<span class="fc" id="L374">      .setBooleanPossibleValues();</span>
<span class="fc" id="L375">    action.createParam(PARAM_PRIORITIZED_RULE)</span>
<span class="fc" id="L376">      .setDescription(&quot;To match issues with prioritized rule or not&quot;)</span>
<span class="fc" id="L377">      .setBooleanPossibleValues();</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">    if (fromSonarQubeUpdateFeature.isAvailable()) {</span>
<span class="fc" id="L379">      action.createParam(PARAM_FROM_SONAR_QUBE_UPDATE)</span>
<span class="fc" id="L380">        .setDescription(&quot;To match issues detected because of SonarQube updates&quot;)</span>
<span class="fc" id="L381">        .setBooleanPossibleValues();</span>
    }
<span class="fc" id="L383">    action.createParam(PARAM_RULES)</span>
<span class="fc" id="L384">      .setDescription(&quot;Comma-separated list of coding rule keys. Format is &amp;lt;repository&amp;gt;:&amp;lt;rule&amp;gt;&quot;)</span>
<span class="fc" id="L385">      .setExampleValue(&quot;java:S1144&quot;);</span>
<span class="fc" id="L386">    action.createParam(PARAM_TAGS)</span>
<span class="fc" id="L387">      .setDescription(&quot;Comma-separated list of tags.&quot;)</span>
<span class="fc" id="L388">      .setExampleValue(&quot;security,convention&quot;);</span>
<span class="fc" id="L389">    action.createParam(PARAM_TYPES)</span>
<span class="fc" id="L390">      .setDescription(&quot;Comma-separated list of types.&quot;)</span>
<span class="fc" id="L391">      .setSince(&quot;5.5&quot;)</span>
<span class="fc" id="L392">      .setPossibleValues(ALL_RULE_TYPES_EXCEPT_SECURITY_HOTSPOTS)</span>
<span class="fc" id="L393">      .setExampleValue(format(&quot;%s,%s&quot;, RuleType.CODE_SMELL, RuleType.BUG));</span>
<span class="fc" id="L394">    action.createParam(PARAM_OWASP_ASVS_LEVEL)</span>
<span class="fc" id="L395">      .setDescription(&quot;Level of OWASP ASVS categories.&quot;)</span>
<span class="fc" id="L396">      .setSince(&quot;9.7&quot;)</span>
<span class="fc" id="L397">      .setPossibleValues(1, 2, 3);</span>
<span class="fc" id="L398">    action.createParam(PARAM_PCI_DSS_32)</span>
<span class="fc" id="L399">      .setDescription(&quot;Comma-separated list of PCI DSS v3.2 categories.&quot;)</span>
<span class="fc" id="L400">      .setSince(&quot;9.6&quot;)</span>
<span class="fc" id="L401">      .setExampleValue(&quot;4,6.5.8,10.1&quot;);</span>
<span class="fc" id="L402">    action.createParam(PARAM_PCI_DSS_40)</span>
<span class="fc" id="L403">      .setDescription(&quot;Comma-separated list of PCI DSS v4.0 categories.&quot;)</span>
<span class="fc" id="L404">      .setSince(&quot;9.6&quot;)</span>
<span class="fc" id="L405">      .setExampleValue(&quot;4,6.5.8,10.1&quot;);</span>
<span class="fc" id="L406">    action.createParam(PARAM_OWASP_ASVS_40)</span>
<span class="fc" id="L407">      .setDescription(&quot;Comma-separated list of OWASP ASVS v4.0 categories.&quot;)</span>
<span class="fc" id="L408">      .setSince(&quot;9.7&quot;)</span>
<span class="fc" id="L409">      .setExampleValue(&quot;6,10.1.1&quot;);</span>
<span class="fc" id="L410">    action.createParam(PARAM_OWASP_MOBILE_TOP_10_2024)</span>
<span class="fc" id="L411">      .setDescription(&quot;Comma-separated list of OWASP Mobile Top 10 2024 lowercase categories.&quot;)</span>
<span class="fc" id="L412">      .setSince(V_2025_3)</span>
<span class="fc" id="L413">      .setPossibleValues(&quot;m1&quot;, &quot;m2&quot;, &quot;m3&quot;, &quot;m4&quot;, &quot;m5&quot;, &quot;m6&quot;, &quot;m7&quot;, &quot;m8&quot;, &quot;m9&quot;, &quot;m10&quot;);</span>
<span class="fc" id="L414">    action.createParam(PARAM_OWASP_TOP_10)</span>
<span class="fc" id="L415">      .setDescription(&quot;Comma-separated list of OWASP Top 10 2017 lowercase categories.&quot;)</span>
<span class="fc" id="L416">      .setSince(&quot;7.3&quot;)</span>
<span class="fc" id="L417">      .setPossibleValues(&quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;, &quot;a4&quot;, &quot;a5&quot;, &quot;a6&quot;, &quot;a7&quot;, &quot;a8&quot;, &quot;a9&quot;, &quot;a10&quot;);</span>
<span class="fc" id="L418">    action.createParam(PARAM_OWASP_TOP_10_2021)</span>
<span class="fc" id="L419">      .setDescription(&quot;Comma-separated list of OWASP Top 10 2021 lowercase categories.&quot;)</span>
<span class="fc" id="L420">      .setSince(&quot;9.4&quot;)</span>
<span class="fc" id="L421">      .setPossibleValues(&quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;, &quot;a4&quot;, &quot;a5&quot;, &quot;a6&quot;, &quot;a7&quot;, &quot;a8&quot;, &quot;a9&quot;, &quot;a10&quot;);</span>
<span class="fc" id="L422">    action.createParam(PARAM_STIG_ASD_V5R3)</span>
<span class="fc" id="L423">      .setDescription(&quot;Comma-separated list of STIG V5R3 categories.&quot;)</span>
<span class="fc" id="L424">      .setSince(&quot;10.7&quot;);</span>
<span class="fc" id="L425">    action.createParam(PARAM_CASA)</span>
<span class="fc" id="L426">      .setDescription(&quot;Comma-separated list of CASA categories.&quot;)</span>
<span class="fc" id="L427">      .setSince(&quot;10.7&quot;);</span>
<span class="fc" id="L428">    action.createParam(PARAM_SANS_TOP_25)</span>
<span class="fc" id="L429">      .setDescription(&quot;Comma-separated list of SANS Top 25 categories.&quot;)</span>
<span class="fc" id="L430">      .setDeprecatedSince(&quot;10.0&quot;)</span>
<span class="fc" id="L431">      .setSince(&quot;7.3&quot;)</span>
<span class="fc" id="L432">      .setPossibleValues(SANS_TOP_25_INSECURE_INTERACTION, SANS_TOP_25_RISKY_RESOURCE, SANS_TOP_25_POROUS_DEFENSES);</span>
<span class="fc" id="L433">    action.createParam(PARAM_CWE)</span>
<span class="fc" id="L434">      .setDescription(&quot;Comma-separated list of CWE identifiers. Use '&quot; + UNKNOWN_STANDARD + &quot;' to select issues not associated to any CWE.&quot;)</span>
<span class="fc" id="L435">      .setExampleValue(&quot;12,125,&quot; + UNKNOWN_STANDARD);</span>
<span class="fc" id="L436">    action.createParam(PARAM_SONARSOURCE_SECURITY)</span>
<span class="fc" id="L437">      .setDescription(&quot;Comma-separated list of SonarSource security categories. Use '&quot; + SQCategory.OTHERS.getKey() + &quot;' to select issues&quot; +</span>
        &quot; not associated&quot; +
        &quot; with any category&quot;)
<span class="fc" id="L440">      .setSince(&quot;7.8&quot;)</span>
<span class="fc" id="L441">      .setPossibleValues(Arrays.stream(SQCategory.values()).map(SQCategory::getKey).toList());</span>
<span class="fc" id="L442">    action.createParam(PARAM_AUTHOR)</span>
<span class="fc" id="L443">      .setDescription(&quot;SCM accounts. To set several values, the parameter must be called once for each value.&quot;)</span>
<span class="fc" id="L444">      .setExampleValue(&quot;author=torvalds@linux-foundation.org&amp;author=linux@fondation.org&quot;);</span>
<span class="fc" id="L445">    action.createParam(PARAM_ASSIGNEES)</span>
<span class="fc" id="L446">      .setDescription(&quot;Comma-separated list of assignee logins. The value '__me__' can be used as a placeholder for user who performs the&quot; +</span>
        &quot; request&quot;)
<span class="fc" id="L448">      .setExampleValue(&quot;admin,usera,__me__&quot;);</span>
<span class="fc" id="L449">    action.createParam(PARAM_ASSIGNED)</span>
<span class="fc" id="L450">      .setDescription(&quot;To retrieve assigned or unassigned issues&quot;)</span>
<span class="fc" id="L451">      .setBooleanPossibleValues();</span>
<span class="fc" id="L452">    action.createParam(PARAM_SCOPES)</span>
<span class="fc" id="L453">      .setDescription(&quot;Comma-separated list of scopes. Available since 8.5&quot;)</span>
<span class="fc" id="L454">      .setPossibleValues(IssueScope.MAIN.name(), IssueScope.TEST.name())</span>
<span class="fc" id="L455">      .setExampleValue(format(&quot;%s,%s&quot;, IssueScope.MAIN.name(), IssueScope.TEST.name()));</span>
<span class="fc" id="L456">    action.createParam(PARAM_LANGUAGES)</span>
<span class="fc" id="L457">      .setDescription(&quot;Comma-separated list of languages. Available since 4.4&quot;)</span>
<span class="fc" id="L458">      .setExampleValue(&quot;java,js&quot;);</span>
<span class="fc" id="L459">    action.createParam(PARAM_CREATED_AT)</span>
<span class="fc" id="L460">      .setDescription(&quot;Datetime to retrieve issues created during a specific analysis&quot;)</span>
<span class="fc" id="L461">      .setExampleValue(&quot;2017-10-19T13:00:00+0200&quot;);</span>
<span class="fc" id="L462">    action.createParam(PARAM_CREATED_AFTER)</span>
<span class="fc" id="L463">      .setDescription(&quot;To retrieve issues created after the given date (inclusive). &lt;br&gt;&quot; +</span>
        &quot;Either a date (use '&quot; + PARAM_TIMEZONE + &quot;' attribute or it will default to server timezone) or datetime can be provided. &lt;br&gt;&quot; +
        &quot;If this parameter is set, createdInLast must not be set&quot;)
<span class="fc" id="L466">      .setExampleValue(&quot;2017-10-19 or 2017-10-19T13:00:00+0200&quot;);</span>
<span class="fc" id="L467">    action.createParam(PARAM_CREATED_BEFORE)</span>
<span class="fc" id="L468">      .setDescription(&quot;To retrieve issues created before the given date (exclusive). &lt;br&gt;&quot; +</span>
        &quot;Either a date (use '&quot; + PARAM_TIMEZONE + &quot;' attribute or it will default to server timezone) or datetime can be provided.&quot;)
<span class="fc" id="L470">      .setExampleValue(&quot;2017-10-19 or 2017-10-19T13:00:00+0200&quot;);</span>
<span class="fc" id="L471">    action.createParam(PARAM_CREATED_IN_LAST)</span>
<span class="fc" id="L472">      .setDescription(&quot;To retrieve issues created during a time span before the current time (exclusive). &quot; +</span>
        &quot;Accepted units are 'y' for year, 'm' for month, 'w' for week and 'd' for day. &quot; +
        &quot;If this parameter is set, createdAfter must not be set&quot;)
<span class="fc" id="L475">      .setExampleValue(&quot;1m2w (1 month 2 weeks)&quot;);</span>
<span class="fc" id="L476">    action.createParam(PARAM_IN_NEW_CODE_PERIOD)</span>
<span class="fc" id="L477">      .setDescription(&quot;To retrieve issues created in the new code period.&lt;br&gt;&quot; +</span>
        &quot;If this parameter is set to a truthy value, createdAfter must not be set and one component uuid or key must be provided.&lt;br&gt;&quot; +
        &quot;This parameter is ignored if the requested component is Application or Portfolio.&quot;)
<span class="fc" id="L480">      .setBooleanPossibleValues()</span>
<span class="fc" id="L481">      .setSince(&quot;9.4&quot;);</span>
<span class="fc" id="L482">    action.createParam(PARAM_TIMEZONE)</span>
<span class="fc" id="L483">      .setDescription(</span>
        &quot;To resolve dates passed to '&quot; + PARAM_CREATED_AFTER + &quot;' or '&quot; + PARAM_CREATED_BEFORE + &quot;' (does not apply to datetime) and to &quot; +
          &quot;compute creation date histogram&quot;)
<span class="fc" id="L486">      .setRequired(false)</span>
<span class="fc" id="L487">      .setExampleValue(&quot;'Europe/Paris', 'Z' or '+02:00'&quot;)</span>
<span class="fc" id="L488">      .setSince(&quot;8.6&quot;);</span>
<span class="fc" id="L489">    action.createParam(PARAM_CODE_VARIANTS)</span>
<span class="fc" id="L490">      .setDescription(&quot;Comma-separated list of code variants.&quot;)</span>
<span class="fc" id="L491">      .setExampleValue(&quot;windows,linux&quot;)</span>
<span class="fc" id="L492">      .setSince(&quot;10.1&quot;);</span>
<span class="fc" id="L493">    action.createParam(PARAM_ISSUE_STATUSES)</span>
<span class="fc" id="L494">      .setDescription(&quot;&quot;)</span>
<span class="fc" id="L495">      .setPossibleValues(IssueStatus.values())</span>
<span class="fc" id="L496">      .setExampleValue(&quot;%s,%S&quot;.formatted(IssueStatus.ACCEPTED, IssueStatus.FIXED))</span>
<span class="fc" id="L497">      .setSince(&quot;10.4&quot;);</span>
<span class="fc" id="L498">  }</span>

  private static void addComponentRelatedParams(WebService.NewAction action) {
<span class="fc" id="L501">    action.createParam(PARAM_ON_COMPONENT_ONLY)</span>
<span class="fc" id="L502">      .setDescription(&quot;Return only issues at a component's level, not on its descendants (modules, directories, files, etc). &quot; +</span>
        &quot;This parameter is only considered when componentKeys is set.&quot;)
<span class="fc" id="L504">      .setBooleanPossibleValues()</span>
<span class="fc" id="L505">      .setDefaultValue(&quot;false&quot;);</span>

<span class="fc" id="L507">    action.createParam(PARAM_COMPONENTS)</span>
<span class="fc" id="L508">      .setDeprecatedKey(PARAM_COMPONENT_KEYS, &quot;10.2&quot;)</span>
<span class="fc" id="L509">      .setDescription(&quot;Comma-separated list of component keys. Retrieve issues associated to a specific list of components (and all its &quot; +</span>
        &quot;descendants). &quot; +
        &quot;A component can be a portfolio, project, module, directory or file.&quot;)
<span class="fc" id="L512">      .setExampleValue(KEY_PROJECT_EXAMPLE_001);</span>

<span class="fc" id="L514">    action.createParam(PARAM_PROJECTS)</span>
<span class="fc" id="L515">      .setDescription(&quot;To retrieve issues associated to a specific list of projects (comma-separated list of project keys). &quot; +</span>
        INTERNAL_PARAMETER_DISCLAIMER +
        &quot;If this parameter is set, projectUuids must not be set.&quot;)
<span class="fc" id="L518">      .setInternal(true)</span>
<span class="fc" id="L519">      .setExampleValue(KEY_PROJECT_EXAMPLE_001);</span>

<span class="fc" id="L521">    action.createParam(PARAM_DIRECTORIES)</span>
<span class="fc" id="L522">      .setDescription(&quot;To retrieve issues associated to a specific list of directories (comma-separated list of directory paths). &quot; +</span>
        &quot;This parameter is only meaningful when a module is selected. &quot; +
        INTERNAL_PARAMETER_DISCLAIMER)
<span class="fc" id="L525">      .setInternal(true)</span>
<span class="fc" id="L526">      .setSince(&quot;5.1&quot;)</span>
<span class="fc" id="L527">      .setExampleValue(&quot;src/main/java/org/sonar/server/&quot;);</span>

<span class="fc" id="L529">    action.createParam(PARAM_FILES)</span>
<span class="fc" id="L530">      .setDescription(&quot;To retrieve issues associated to a specific list of files (comma-separated list of file paths). &quot; +</span>
        INTERNAL_PARAMETER_DISCLAIMER)
<span class="fc" id="L532">      .setInternal(true)</span>
<span class="fc" id="L533">      .setExampleValue(&quot;src/main/java/org/sonar/server/Test.java&quot;);</span>

<span class="fc" id="L535">    action.createParam(PARAM_BRANCH)</span>
<span class="fc" id="L536">      .setDescription(&quot;Branch key. Not available in the community edition.&quot;)</span>
<span class="fc" id="L537">      .setExampleValue(KEY_BRANCH_EXAMPLE_001)</span>
<span class="fc" id="L538">      .setSince(&quot;6.6&quot;);</span>

<span class="fc" id="L540">    action.createParam(PARAM_PULL_REQUEST)</span>
<span class="fc" id="L541">      .setDescription(&quot;Pull request id. Not available in the community edition.&quot;)</span>
<span class="fc" id="L542">      .setExampleValue(KEY_PULL_REQUEST_EXAMPLE_001)</span>
<span class="fc" id="L543">      .setSince(&quot;7.1&quot;);</span>

<span class="fc" id="L545">    action.createParam(PARAM_FIXED_IN_PULL_REQUEST)</span>
<span class="fc" id="L546">      .setDescription(&quot;Pull request id to filter issues that would be fixed in the specified project or branch by the pull request. &quot; +</span>
        &quot;Should not be used together with + '&quot; + PARAM_PULL_REQUEST + &quot;'. At least the '&quot; + PARAM_COMPONENTS + &quot;' must be be specified &quot; +
        &quot;when this param is used.  Not available in the community edition.&quot;)
<span class="fc" id="L549">      .setExampleValue(KEY_PULL_REQUEST_EXAMPLE_001)</span>
<span class="fc" id="L550">      .setSince(&quot;10.4&quot;);</span>
<span class="fc" id="L551">  }</span>

  @Override
  public final void handle(Request request, Response response) {
<span class="fc" id="L555">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L556">      SearchRequest searchRequest = toSearchWsRequest(dbSession, request);</span>
<span class="fc" id="L557">      checkIfNeedIssueSync(dbSession, searchRequest);</span>
<span class="fc" id="L558">      SearchWsResponse searchWsResponse = doHandle(searchRequest);</span>
<span class="fc" id="L559">      writeProtobuf(searchWsResponse, request, response);</span>
    }
<span class="fc" id="L561">  }</span>

  private SearchWsResponse doHandle(SearchRequest request) {
    // prepare the Elasticsearch request
<span class="fc" id="L565">    SearchOptions options = createSearchOptionsFromRequest(request);</span>
<span class="fc" id="L566">    EnumSet&lt;SearchAdditionalField&gt; additionalFields = SearchAdditionalField.getFromRequest(request);</span>
<span class="fc" id="L567">    IssueQuery query = issueQueryFactory.create(request);</span>

<span class="fc" id="L569">    Set&lt;String&gt; facetsRequiringProjectParameter = options.getFacets().stream()</span>
<span class="fc" id="L570">      .filter(FACETS_REQUIRING_PROJECT::contains)</span>
<span class="fc" id="L571">      .collect(Collectors.toSet());</span>
<span class="fc bfc" id="L572" title="All 2 branches covered.">    checkArgument(facetsRequiringProjectParameter.isEmpty() ||</span>
<span class="fc bfc" id="L573" title="All 2 branches covered.">      (!query.projectUuids().isEmpty()), &quot;Facet(s) '%s' require to also filter by project&quot;,</span>
<span class="fc" id="L574">      String.join(&quot;,&quot;, facetsRequiringProjectParameter));</span>

    // execute request
<span class="fc" id="L577">    SearchResponse result = issueIndex.search(query, options);</span>
<span class="fc" id="L578">    result.getHits();</span>
<span class="fc" id="L579">    List&lt;String&gt; issueKeys = Arrays.stream(result.getHits().getHits())</span>
<span class="fc" id="L580">      .map(SearchHit::getId)</span>
<span class="fc" id="L581">      .toList();</span>

    // load the additional information to be returned in response
<span class="fc" id="L584">    SearchResponseLoader.Collector collector = new SearchResponseLoader.Collector(issueKeys);</span>
<span class="fc" id="L585">    collectLoggedInUser(collector);</span>
<span class="fc" id="L586">    collectRequestParams(collector, request);</span>
<span class="fc" id="L587">    Facets facets = new Facets(result, Optional.ofNullable(query.timeZone()).orElse(system2.getDefaultTimeZone().toZoneId()));</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">    if (!options.getFacets().isEmpty()) {</span>
      // add missing values to facets. For example if assignee &quot;john&quot; and facet on &quot;assignees&quot; are requested, then
      // &quot;john&quot; should always be listed in the facet. If it is not present, then it is added with value zero.
      // This is a constraint from webapp UX.
<span class="fc" id="L592">      completeFacets(facets, request, query);</span>
<span class="fc" id="L593">      collectFacets(collector, facets);</span>
    }
<span class="fc" id="L595">    SearchResponseData preloadedData = new SearchResponseData();</span>
<span class="fc" id="L596">    preloadedData.addRules(List.copyOf(query.rules()));</span>
<span class="fc" id="L597">    SearchResponseData data = searchResponseLoader.load(preloadedData, collector, additionalFields, facets);</span>

    // FIXME allow long in Paging
<span class="fc" id="L600">    Paging paging = forPageIndex(options.getPage()).withPageSize(options.getLimit()).andTotal((int) getTotalHits(result).value);</span>
<span class="fc" id="L601">    return searchResponseFormat.formatSearch(additionalFields, data, paging, facets, userSession.isLoggedIn(), getSupportedFacets());</span>
  }

  private static TotalHits getTotalHits(SearchResponse response) {
<span class="pc" id="L605">    return ofNullable(response.getHits().getTotalHits()).orElseThrow(() -&gt; new IllegalStateException(&quot;Could not get total hits of search &quot; +</span>
      &quot;results&quot;));
  }

  private SearchOptions createSearchOptionsFromRequest(SearchRequest request) {
<span class="fc" id="L610">    SearchOptions options = new SearchOptions();</span>
<span class="fc" id="L611">    options.setPage(request.getPage(), request.getPageSize());</span>

<span class="fc" id="L613">    List&lt;String&gt; facets = request.getFacets();</span>

<span class="pc bpc" id="L615" title="1 of 4 branches missed.">    if (facets == null || facets.isEmpty()) {</span>
<span class="fc" id="L616">      return options;</span>
    }

<span class="fc" id="L619">    List&lt;String&gt; requestedFacets = new ArrayList&lt;&gt;(facets);</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">    if (!userSession.isLoggedIn()) {</span>
<span class="fc" id="L621">      requestedFacets.remove(PARAM_AUTHOR);</span>
    }
<span class="fc" id="L623">    options.addFacets(requestedFacets);</span>
<span class="fc" id="L624">    return options;</span>
  }

  private void completeFacets(Facets facets, SearchRequest request, IssueQuery query) {
<span class="fc" id="L628">    addMandatoryValuesToFacet(facets, PARAM_SEVERITIES, Severity.ALL);</span>
<span class="fc" id="L629">    addMandatoryValuesToFacet(facets, PARAM_STATUSES, ISSUE_STATUSES);</span>
<span class="fc" id="L630">    addMandatoryValuesToFacet(facets, PARAM_IMPACT_SOFTWARE_QUALITIES, enumToStringCollection(SoftwareQuality.values()));</span>
<span class="fc" id="L631">    addMandatoryValuesToFacet(facets, PARAM_IMPACT_SEVERITIES, enumToStringCollection(values()));</span>
<span class="fc" id="L632">    addMandatoryValuesToFacet(facets, PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES, enumToStringCollection(CleanCodeAttributeCategory.values()));</span>

<span class="fc" id="L634">    addMandatoryValuesToFacet(facets, PARAM_RESOLUTIONS, concat(singletonList(&quot;&quot;), RESOLUTIONS));</span>
<span class="fc" id="L635">    addMandatoryValuesToFacet(facets, FACET_PROJECTS, query.projectUuids());</span>
<span class="fc" id="L636">    addMandatoryValuesToFacet(facets, PARAM_FILES, query.files());</span>

<span class="fc" id="L638">    List&lt;String&gt; assignees = Lists.newArrayList(&quot;&quot;);</span>
<span class="fc" id="L639">    List&lt;String&gt; assigneesFromRequest = request.getAssigneeUuids();</span>
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">    if (assigneesFromRequest != null) {</span>
<span class="fc" id="L641">      assignees.addAll(assigneesFromRequest);</span>
<span class="fc" id="L642">      assignees.remove(LOGIN_MYSELF);</span>
    }
<span class="fc" id="L644">    addMandatoryValuesToFacet(facets, PARAM_ASSIGNEES, assignees);</span>
<span class="fc" id="L645">    addMandatoryValuesToFacet(facets, FACET_ASSIGNED_TO_ME, singletonList(userSession.getUuid()));</span>
<span class="fc" id="L646">    addMandatoryValuesToFacet(facets, PARAM_RULES, query.ruleUuids());</span>
<span class="fc" id="L647">    addMandatoryValuesToFacet(facets, PARAM_SCOPES, ISSUE_SCOPES);</span>
<span class="fc" id="L648">    addMandatoryValuesToFacet(facets, PARAM_LANGUAGES, request.getLanguages());</span>
<span class="fc" id="L649">    addMandatoryValuesToFacet(facets, PARAM_TAGS, request.getTags());</span>

<span class="fc" id="L651">    setTypesFacet(facets);</span>

<span class="fc" id="L653">    addMandatoryValuesToFacet(facets, PARAM_PCI_DSS_32, request.getPciDss32());</span>
<span class="fc" id="L654">    addMandatoryValuesToFacet(facets, PARAM_PCI_DSS_40, request.getPciDss40());</span>
<span class="fc" id="L655">    addMandatoryValuesToFacet(facets, PARAM_OWASP_ASVS_40, request.getOwaspAsvs40());</span>
<span class="fc" id="L656">    addMandatoryValuesToFacet(facets, PARAM_OWASP_MOBILE_TOP_10_2024, request.getOwaspMobileTop10For2024());</span>
<span class="fc" id="L657">    addMandatoryValuesToFacet(facets, PARAM_OWASP_TOP_10, request.getOwaspTop10());</span>
<span class="fc" id="L658">    addMandatoryValuesToFacet(facets, PARAM_OWASP_TOP_10_2021, request.getOwaspTop10For2021());</span>
<span class="fc" id="L659">    addMandatoryValuesToFacet(facets, PARAM_STIG_ASD_V5R3, request.getStigAsdV5R3());</span>
<span class="fc" id="L660">    addMandatoryValuesToFacet(facets, PARAM_CASA, request.getCasa());</span>
<span class="fc" id="L661">    addMandatoryValuesToFacet(facets, PARAM_SANS_TOP_25, request.getSansTop25());</span>
<span class="fc" id="L662">    addMandatoryValuesToFacet(facets, PARAM_CWE, request.getCwe());</span>
<span class="fc" id="L663">    addMandatoryValuesToFacet(facets, PARAM_SONARSOURCE_SECURITY, request.getSonarsourceSecurity());</span>
<span class="fc" id="L664">    addMandatoryValuesToFacet(facets, PARAM_CODE_VARIANTS, request.getCodeVariants());</span>
<span class="fc" id="L665">  }</span>

  private static Collection&lt;String&gt; enumToStringCollection(Enum&lt;?&gt;... enumValues) {
<span class="fc" id="L668">    return Arrays.stream(enumValues).map(Enum::name).toList();</span>
  }

  private static void setTypesFacet(Facets facets) {
<span class="fc" id="L672">    Map&lt;String, Long&gt; typeFacet = facets.get(PARAM_TYPES);</span>
<span class="fc bfc" id="L673" title="All 2 branches covered.">    if (typeFacet != null) {</span>
<span class="fc" id="L674">      typeFacet.remove(RuleType.SECURITY_HOTSPOT.name());</span>
    }
<span class="fc" id="L676">    addMandatoryValuesToFacet(facets, PARAM_TYPES, ALL_RULE_TYPES_EXCEPT_SECURITY_HOTSPOTS.stream().map(Enum::name).toList());</span>
<span class="fc" id="L677">  }</span>

  private static void addMandatoryValuesToFacet(Facets facets, String facetName, @Nullable Iterable&lt;String&gt; mandatoryValues) {
<span class="fc" id="L680">    Map&lt;String, Long&gt; buckets = facets.get(facetName);</span>
<span class="fc bfc" id="L681" title="All 4 branches covered.">    if (buckets != null &amp;&amp; mandatoryValues != null) {</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">      for (String mandatoryValue : mandatoryValues) {</span>
<span class="fc" id="L683">        buckets.putIfAbsent(mandatoryValue, 0L);</span>
<span class="fc" id="L684">      }</span>
    }
<span class="fc" id="L686">  }</span>

  private void collectLoggedInUser(SearchResponseLoader.Collector collector) {
<span class="fc bfc" id="L689" title="All 2 branches covered.">    if (userSession.isLoggedIn()) {</span>
<span class="fc" id="L690">      collector.addUserUuids(singletonList(userSession.getUuid()));</span>
    }
<span class="fc" id="L692">  }</span>

  private static void collectFacets(SearchResponseLoader.Collector collector, Facets facets) {
<span class="fc" id="L695">    collector.addProjectUuids(facets.getBucketKeys(FACET_PROJECTS));</span>
<span class="fc" id="L696">    collector.addRuleIds(facets.getBucketKeys(PARAM_RULES));</span>
<span class="fc" id="L697">    collector.addUserUuids(facets.getBucketKeys(PARAM_ASSIGNEES));</span>
<span class="fc" id="L698">  }</span>

  private static void collectRequestParams(SearchResponseLoader.Collector collector, SearchRequest request) {
<span class="fc" id="L701">    collector.addUserUuids(request.getAssigneeUuids());</span>
<span class="fc" id="L702">  }</span>

  private SearchRequest toSearchWsRequest(DbSession dbSession, Request request) {
<span class="fc" id="L705">    return new SearchRequest()</span>
<span class="fc" id="L706">      .setAdditionalFields(request.paramAsStrings(PARAM_ADDITIONAL_FIELDS))</span>
<span class="fc" id="L707">      .setAsc(request.mandatoryParamAsBoolean(PARAM_ASC))</span>
<span class="fc" id="L708">      .setAssigned(request.paramAsBoolean(PARAM_ASSIGNED))</span>
<span class="fc" id="L709">      .setAssigneesUuid(getLogins(dbSession, request.paramAsStrings(PARAM_ASSIGNEES)))</span>
<span class="fc" id="L710">      .setAuthors(request.multiParam(PARAM_AUTHOR))</span>
<span class="fc" id="L711">      .setComponentKeys(request.paramAsStrings(PARAM_COMPONENTS))</span>
<span class="fc" id="L712">      .setCreatedAfter(request.param(PARAM_CREATED_AFTER))</span>
<span class="fc" id="L713">      .setCreatedAt(request.param(PARAM_CREATED_AT))</span>
<span class="fc" id="L714">      .setCreatedBefore(request.param(PARAM_CREATED_BEFORE))</span>
<span class="fc" id="L715">      .setCreatedInLast(request.param(PARAM_CREATED_IN_LAST))</span>
<span class="fc" id="L716">      .setDirectories(request.paramAsStrings(PARAM_DIRECTORIES))</span>
<span class="fc" id="L717">      .setFacets(request.paramAsStrings(FACETS))</span>
<span class="fc" id="L718">      .setFiles(request.paramAsStrings(PARAM_FILES))</span>
<span class="fc" id="L719">      .setInNewCodePeriod(request.paramAsBoolean(PARAM_IN_NEW_CODE_PERIOD))</span>
<span class="fc" id="L720">      .setIssues(request.paramAsStrings(PARAM_ISSUES))</span>
<span class="fc" id="L721">      .setScopes(request.paramAsStrings(PARAM_SCOPES))</span>
<span class="fc" id="L722">      .setLanguages(request.paramAsStrings(PARAM_LANGUAGES))</span>
<span class="fc" id="L723">      .setOnComponentOnly(request.paramAsBoolean(PARAM_ON_COMPONENT_ONLY))</span>
<span class="fc" id="L724">      .setBranch(request.param(PARAM_BRANCH))</span>
<span class="fc" id="L725">      .setPullRequest(request.param(PARAM_PULL_REQUEST))</span>
<span class="fc" id="L726">      .setPage(request.mandatoryParamAsInt(Param.PAGE))</span>
<span class="fc" id="L727">      .setPageSize(request.mandatoryParamAsInt(Param.PAGE_SIZE))</span>
<span class="fc" id="L728">      .setProjectKeys(request.paramAsStrings(PARAM_PROJECTS))</span>
<span class="fc" id="L729">      .setResolutions(request.paramAsStrings(PARAM_RESOLUTIONS))</span>
<span class="fc" id="L730">      .setResolved(request.paramAsBoolean(PARAM_RESOLVED))</span>
<span class="fc" id="L731">      .setPrioritizedRule(request.paramAsBoolean(PARAM_PRIORITIZED_RULE))</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">      .setFromSonarQubeUpdate(fromSonarQubeUpdateFeature.isAvailable() ? request.paramAsBoolean(PARAM_FROM_SONAR_QUBE_UPDATE) : null)</span>
<span class="fc" id="L733">      .setRules(request.paramAsStrings(PARAM_RULES))</span>
<span class="fc" id="L734">      .setSort(request.param(Param.SORT))</span>
<span class="fc" id="L735">      .setSeverities(request.paramAsStrings(PARAM_SEVERITIES))</span>
<span class="fc" id="L736">      .setImpactSeverities(request.paramAsStrings(PARAM_IMPACT_SEVERITIES))</span>
<span class="fc" id="L737">      .setImpactSoftwareQualities(request.paramAsStrings(PARAM_IMPACT_SOFTWARE_QUALITIES))</span>
<span class="fc" id="L738">      .setCleanCodeAttributesCategories(request.paramAsStrings(PARAM_CLEAN_CODE_ATTRIBUTE_CATEGORIES))</span>
<span class="fc" id="L739">      .setStatuses(request.paramAsStrings(PARAM_STATUSES))</span>
<span class="fc" id="L740">      .setIssueStatuses(request.paramAsStrings(PARAM_ISSUE_STATUSES))</span>
<span class="fc" id="L741">      .setTags(request.paramAsStrings(PARAM_TAGS))</span>
<span class="fc" id="L742">      .setTypes(allRuleTypesExceptHotspotsIfEmpty(request.paramAsStrings(PARAM_TYPES)))</span>
<span class="fc" id="L743">      .setPciDss32(request.paramAsStrings(PARAM_PCI_DSS_32))</span>
<span class="fc" id="L744">      .setPciDss40(request.paramAsStrings(PARAM_PCI_DSS_40))</span>
<span class="fc" id="L745">      .setOwaspAsvsLevel(request.paramAsInt(PARAM_OWASP_ASVS_LEVEL))</span>
<span class="fc" id="L746">      .setOwaspAsvs40(request.paramAsStrings(PARAM_OWASP_ASVS_40))</span>
<span class="fc" id="L747">      .setOwaspMobileTop10For2024(request.paramAsStrings(PARAM_OWASP_MOBILE_TOP_10_2024))</span>
<span class="fc" id="L748">      .setOwaspTop10(request.paramAsStrings(PARAM_OWASP_TOP_10))</span>
<span class="fc" id="L749">      .setOwaspTop10For2021(request.paramAsStrings(PARAM_OWASP_TOP_10_2021))</span>
<span class="fc" id="L750">      .setStigAsdV5R3(request.paramAsStrings(PARAM_STIG_ASD_V5R3))</span>
<span class="fc" id="L751">      .setCasa(request.paramAsStrings(PARAM_CASA))</span>
<span class="fc" id="L752">      .setSansTop25(request.paramAsStrings(PARAM_SANS_TOP_25))</span>
<span class="fc" id="L753">      .setCwe(request.paramAsStrings(PARAM_CWE))</span>
<span class="fc" id="L754">      .setSonarsourceSecurity(request.paramAsStrings(PARAM_SONARSOURCE_SECURITY))</span>
<span class="fc" id="L755">      .setTimeZone(request.param(PARAM_TIMEZONE))</span>
<span class="fc" id="L756">      .setCodeVariants(request.paramAsStrings(PARAM_CODE_VARIANTS))</span>
<span class="fc" id="L757">      .setFixedInPullRequest(request.param(PARAM_FIXED_IN_PULL_REQUEST));</span>
  }

  private void checkIfNeedIssueSync(DbSession dbSession, SearchRequest searchRequest) {
<span class="fc" id="L761">    List&lt;String&gt; components = searchRequest.getComponentKeys();</span>
<span class="pc bpc" id="L762" title="1 of 4 branches missed.">    if (components != null &amp;&amp; !components.isEmpty()) {</span>
<span class="fc" id="L763">      issueIndexSyncProgressChecker.checkIfAnyComponentsNeedIssueSync(dbSession, components);</span>
    } else {
      // component keys not provided - asking for global
<span class="fc" id="L766">      issueIndexSyncProgressChecker.checkIfIssueSyncInProgress(dbSession);</span>
    }
<span class="fc" id="L768">  }</span>

  private static List&lt;String&gt; allRuleTypesExceptHotspotsIfEmpty(@Nullable List&lt;String&gt; types) {
<span class="pc bpc" id="L771" title="3 of 4 branches missed.">    if (types == null || types.isEmpty()) {</span>
<span class="fc" id="L772">      return ALL_RULE_TYPES_EXCEPT_SECURITY_HOTSPOTS.stream().map(Enum::name).toList();</span>
    }
<span class="nc" id="L774">    return types;</span>
  }

  private List&lt;String&gt; getLogins(DbSession dbSession, @Nullable List&lt;String&gt; assigneeLogins) {
<span class="fc" id="L778">    List&lt;String&gt; userLogins = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L780" title="All 2 branches covered.">    for (String login : ofNullable(assigneeLogins).orElse(emptyList())) {</span>
<span class="fc bfc" id="L781" title="All 2 branches covered.">      if (LOGIN_MYSELF.equals(login)) {</span>
<span class="pc bpc" id="L782" title="1 of 2 branches missed.">        if (userSession.getLogin() == null) {</span>
<span class="nc" id="L783">          userLogins.add(UNKNOWN);</span>
        } else {
<span class="fc" id="L785">          userLogins.add(userSession.getLogin());</span>
        }
      } else {
<span class="fc" id="L788">        userLogins.add(login);</span>
      }
<span class="fc" id="L790">    }</span>

<span class="fc" id="L792">    List&lt;UserDto&gt; userDtos = dbClient.userDao().selectByLogins(dbSession, userLogins);</span>
<span class="fc" id="L793">    List&lt;String&gt; assigneeUuid = userDtos.stream().map(UserDto::getUuid).toList();</span>

<span class="fc bfc" id="L795" title="All 4 branches covered.">    if ((assigneeLogins != null) &amp;&amp; firstNonNull(assigneeUuid, emptyList()).isEmpty()) {</span>
<span class="fc" id="L796">      assigneeUuid = List.of(&quot;non-existent-uuid&quot;);</span>
    }
<span class="fc" id="L798">    return assigneeUuid;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>