<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SetSeverityAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.issue.ws</a> &gt; <span class="el_source">SetSeverityAction.java</span></div><h1>SetSeverityAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.issue.ws;

import com.google.common.io.Resources;
import java.util.Date;
import java.util.Map;
import javax.annotation.Nullable;
import org.apache.commons.lang3.tuple.Pair;
import org.sonar.api.issue.impact.SoftwareQuality;
import org.sonar.api.rule.Severity;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.core.issue.DefaultIssue;
import org.sonar.core.issue.IssueChangeContext;
import org.sonar.core.rule.RuleTypeMapper;
import org.sonar.core.util.Uuids;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.ComponentDto;
import org.sonar.db.issue.IssueDto;
import org.sonar.server.issue.IssueFieldsSetter;
import org.sonar.server.issue.IssueFinder;
import org.sonar.server.pushapi.issues.IssueChangeEventService;
import org.sonar.server.user.UserSession;

import static org.sonar.api.server.rule.internal.ImpactMapper.convertToRuleSeverity;
import static org.sonar.api.server.rule.internal.ImpactMapper.convertToRuleType;
import static org.sonar.api.server.rule.internal.ImpactMapper.convertToSoftwareQuality;
import static org.sonar.db.permission.ProjectPermission.ISSUE_ADMIN;
import static org.sonar.core.issue.IssueChangeContext.issueChangeContextByUserBuilder;
import static org.sonar.core.rule.ImpactSeverityMapper.mapImpactSeverity;
import static org.sonar.core.rule.RuleTypeMapper.toApiRuleType;
import static org.sonar.db.component.BranchType.BRANCH;
import static org.sonar.server.common.ParamParsingUtils.parseImpact;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.ACTION_SET_SEVERITY;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_IMPACT;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_ISSUE;
import static org.sonarqube.ws.client.issue.IssuesWsParameters.PARAM_SEVERITY;

public class SetSeverityAction implements IssuesWsAction {

  private final UserSession userSession;
  private final DbClient dbClient;
  private final IssueChangeEventService issueChangeEventService;
  private final IssueFinder issueFinder;
  private final IssueFieldsSetter issueFieldsSetter;
  private final IssueUpdater issueUpdater;
  private final OperationResponseWriter responseWriter;

  public SetSeverityAction(UserSession userSession, DbClient dbClient, IssueChangeEventService issueChangeEventService,
    IssueFinder issueFinder, IssueFieldsSetter issueFieldsSetter, IssueUpdater issueUpdater,
<span class="fc" id="L73">    OperationResponseWriter responseWriter) {</span>
<span class="fc" id="L74">    this.userSession = userSession;</span>
<span class="fc" id="L75">    this.dbClient = dbClient;</span>
<span class="fc" id="L76">    this.issueChangeEventService = issueChangeEventService;</span>
<span class="fc" id="L77">    this.issueFinder = issueFinder;</span>
<span class="fc" id="L78">    this.issueFieldsSetter = issueFieldsSetter;</span>
<span class="fc" id="L79">    this.issueUpdater = issueUpdater;</span>
<span class="fc" id="L80">    this.responseWriter = responseWriter;</span>
<span class="fc" id="L81">  }</span>

  @Override
  public void define(WebService.NewController controller) {
<span class="fc" id="L85">    WebService.NewAction action = controller.createAction(ACTION_SET_SEVERITY)</span>
<span class="fc" id="L86">      .setDescription(&quot;Change severity.&lt;br/&gt;&quot; +</span>
        &quot;Requires the following permissions:&quot; +
        &quot;&lt;ul&gt;&quot; +
        &quot;  &lt;li&gt;'Authentication'&lt;/li&gt;&quot; +
        &quot;  &lt;li&gt;'Browse' rights on project of the specified issue&lt;/li&gt;&quot; +
        &quot;  &lt;li&gt;'Administer Issues' rights on project of the specified issue&lt;/li&gt;&quot; +
        &quot;&lt;/ul&gt;&quot;)
<span class="fc" id="L93">      .setSince(&quot;3.6&quot;)</span>
<span class="fc" id="L94">      .setChangelog(</span>
        new Change(&quot;10.8&quot;, &quot;Add 'impact' parameter to the request.&quot;),
        new Change(&quot;10.8&quot;, &quot;Parameter 'severity' is now optional.&quot;),
        new Change(&quot;10.8&quot;, &quot;This endpoint is not deprecated anymore.&quot;),
        new Change(&quot;10.4&quot;, &quot;The response fields 'status' and 'resolution' are deprecated. Please use 'issueStatus' instead.&quot;),
        new Change(&quot;10.4&quot;, &quot;Add 'issueStatus' field to the response.&quot;),
        new Change(&quot;10.2&quot;, &quot;This endpoint is now deprecated.&quot;),
        new Change(&quot;10.2&quot;, &quot;Add 'impacts', 'cleanCodeAttribute', 'cleanCodeAttributeCategory' fields to the response&quot;),
        new Change(&quot;9.6&quot;, &quot;Response field 'ruleDescriptionContextKey' added&quot;),
        new Change(&quot;8.8&quot;, &quot;The response field components.uuid is removed&quot;),
        new Change(&quot;6.5&quot;, &quot;the database ids of the components are removed from the response&quot;),
        new Change(&quot;6.5&quot;, &quot;the response field components.uuid is deprecated. Use components.key instead.&quot;))
<span class="fc" id="L106">      .setHandler(this)</span>
<span class="fc" id="L107">      .setResponseExample(Resources.getResource(this.getClass(), &quot;set_severity-example.json&quot;))</span>
<span class="fc" id="L108">      .setPost(true);</span>

<span class="fc" id="L110">    action.createParam(PARAM_ISSUE)</span>
<span class="fc" id="L111">      .setDescription(&quot;Issue key&quot;)</span>
<span class="fc" id="L112">      .setRequired(true)</span>
<span class="fc" id="L113">      .setExampleValue(Uuids.UUID_EXAMPLE_01);</span>
<span class="fc" id="L114">    action.createParam(PARAM_SEVERITY)</span>
<span class="fc" id="L115">      .setDescription(&quot;New severity&quot;)</span>
<span class="fc" id="L116">      .setRequired(false)</span>
<span class="fc" id="L117">      .setPossibleValues(Severity.ALL);</span>
<span class="fc" id="L118">    action.createParam(PARAM_IMPACT)</span>
<span class="fc" id="L119">      .setDescription(&quot;Override of impact severity for the rule. Cannot be used as the same time as 'severity'&quot;)</span>
<span class="fc" id="L120">      .setRequired(false)</span>
<span class="fc" id="L121">      .setExampleValue(&quot;impact=MAINTAINABILITY=HIGH&quot;);</span>
<span class="fc" id="L122">  }</span>

  @Override
  public void handle(Request request, Response response) throws Exception {
<span class="fc" id="L126">    userSession.checkLoggedIn();</span>
<span class="fc" id="L127">    String issueKey = request.mandatoryParam(PARAM_ISSUE);</span>
<span class="fc" id="L128">    String severity = request.param(PARAM_SEVERITY);</span>
<span class="fc" id="L129">    String impact = request.param(PARAM_IMPACT);</span>
<span class="fc" id="L130">    checkParams(severity, impact);</span>

<span class="fc" id="L132">    try (DbSession session = dbClient.openSession(false)) {</span>
<span class="fc" id="L133">      SearchResponseData preloadedSearchResponseData = setSeverity(session, issueKey, impact, severity);</span>
<span class="fc" id="L134">      responseWriter.write(issueKey, preloadedSearchResponseData, request, response, true);</span>
    }
<span class="fc" id="L136">  }</span>

  private SearchResponseData setSeverity(DbSession session, String issueKey, @Nullable String impact, @Nullable String severity) {
<span class="fc" id="L139">    IssueDto issueDto = issueFinder.getByKey(session, issueKey);</span>
<span class="fc" id="L140">    DefaultIssue issue = issueDto.toDefaultIssue();</span>
<span class="fc" id="L141">    userSession.checkComponentUuidPermission(ISSUE_ADMIN, issue.projectUuid());</span>

<span class="fc" id="L143">    IssueChangeContext context = issueChangeContextByUserBuilder(new Date(), userSession.getUuid()).withRefreshMeasures().build();</span>
    SearchResponseData response;
<span class="fc bfc" id="L145" title="All 2 branches covered.">    if (severity != null) {</span>
<span class="fc" id="L146">      response = setManualSeverity(session, issue, issueDto, severity, context);</span>
    } else {
<span class="fc" id="L148">      response = setManualImpact(session, issue, issueDto, impact, context);</span>
    }
<span class="fc" id="L150">    return response;</span>
  }

  private SearchResponseData setManualImpact(DbSession session, DefaultIssue issue, IssueDto issueDto, String impact,
    IssueChangeContext context) {
<span class="fc" id="L155">    Map&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; effectiveImpacts = issueDto.getEffectiveImpacts();</span>
<span class="fc" id="L156">    Pair&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; manualImpact = parseImpact(impact);</span>

<span class="fc" id="L158">    org.sonar.api.issue.impact.Severity manualImpactSeverity = manualImpact.getValue();</span>
<span class="fc" id="L159">    SoftwareQuality softwareQuality = manualImpact.getKey();</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">    if (!effectiveImpacts.containsKey(softwareQuality)) {</span>
<span class="fc" id="L162">      throw new IllegalArgumentException(&quot;Issue does not support impact &quot; + softwareQuality);</span>
    }
<span class="fc" id="L164">    createImpactsIfMissing(issue, effectiveImpacts);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">    if (issueFieldsSetter.setImpactManualSeverity(issue, softwareQuality, manualImpactSeverity, context)) {</span>
<span class="fc" id="L166">      String manualSeverity = null;</span>
<span class="fc" id="L167">      boolean severityHasChanged = false;</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">      if (convertToRuleType(softwareQuality) == RuleTypeMapper.toApiRuleType(issue.type())) {</span>
<span class="fc" id="L169">        manualSeverity = convertToRuleSeverity(manualImpactSeverity);</span>
<span class="fc" id="L170">        severityHasChanged = issueFieldsSetter.setManualSeverity(issue, manualSeverity, context);</span>
      }
<span class="fc" id="L172">      BranchDto branch = issueUpdater.getBranch(session, issue);</span>
<span class="fc" id="L173">      SearchResponseData response = issueUpdater.saveIssueAndPreloadSearchResponseData(session, issueDto, issue, context, branch);</span>
<span class="pc bpc" id="L174" title="2 of 4 branches missed.">      if (branch.getBranchType().equals(BRANCH) &amp;&amp; response.getComponentByUuid(issue.projectUuid()) != null) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        issueChangeEventService.distributeIssueChangeEvent(issue, severityHasChanged ? manualSeverity : null, Map.of(softwareQuality, manualImpactSeverity), null, null,</span>
<span class="fc" id="L176">          branch, getProjectKey(issue, response));</span>
      }
<span class="fc" id="L178">      return response;</span>
    }
<span class="fc" id="L180">    return new SearchResponseData(issueDto);</span>
  }

  private SearchResponseData setManualSeverity(DbSession session, DefaultIssue issue, IssueDto issueDto, String severity,
    IssueChangeContext context) {
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">    if (issueFieldsSetter.setManualSeverity(issue, severity, context)) {</span>
<span class="fc" id="L186">      SoftwareQuality softwareQuality = convertToSoftwareQuality(toApiRuleType(issue.type()));</span>
<span class="fc" id="L187">      boolean impactHasChanged = false;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">      if (issueDto.getEffectiveImpacts().containsKey(softwareQuality)) {</span>
<span class="fc" id="L189">        createImpactsIfMissing(issue, issueDto.getEffectiveImpacts());</span>
<span class="fc" id="L190">        impactHasChanged = issueFieldsSetter.setImpactManualSeverity(issue, softwareQuality, mapImpactSeverity(severity), context);</span>
      }
<span class="fc" id="L192">      BranchDto branch = issueUpdater.getBranch(session, issue);</span>
<span class="fc" id="L193">      SearchResponseData response = issueUpdater.saveIssueAndPreloadSearchResponseData(session, issueDto, issue, context, branch);</span>
<span class="pc bpc" id="L194" title="1 of 4 branches missed.">      if (branch.getBranchType().equals(BRANCH) &amp;&amp; response.getComponentByUuid(issue.projectUuid()) != null) {</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        issueChangeEventService.distributeIssueChangeEvent(issue, severity, impactHasChanged ? Map.of(softwareQuality, mapImpactSeverity(severity)) : Map.of(), null, null,</span>
<span class="fc" id="L196">          branch, getProjectKey(issue, response));</span>
      }
<span class="fc" id="L198">      return response;</span>
    }
<span class="nc" id="L200">    return new SearchResponseData(issueDto);</span>
  }

  private static String getProjectKey(DefaultIssue issue, SearchResponseData response) {
<span class="fc" id="L204">    ComponentDto componentByUuid = response.getComponentByUuid(issue.projectUuid());</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">    if (componentByUuid == null) {</span>
<span class="nc" id="L206">      throw new IllegalStateException(&quot;Component with uuid &quot; + issue.projectUuid() + &quot; not found&quot;);</span>
    }
<span class="fc" id="L208">    return componentByUuid.getKey();</span>
  }

  private static void createImpactsIfMissing(DefaultIssue issue, Map&lt;SoftwareQuality, org.sonar.api.issue.impact.Severity&gt; effectiveImpacts) {
<span class="fc bfc" id="L212" title="All 2 branches covered.">    if (issue.impacts().isEmpty()) {</span>
<span class="fc" id="L213">      issue.replaceImpacts(effectiveImpacts);</span>
<span class="fc" id="L214">      issue.setChanged(true);</span>
    }
<span class="fc" id="L216">  }</span>

  private static void checkParams(@Nullable String severity, @Nullable String impact) {
<span class="fc bfc" id="L219" title="All 4 branches covered.">    if (severity != null &amp;&amp; impact != null) {</span>
<span class="fc" id="L220">      throw new IllegalArgumentException(&quot;Parameters 'severity' and 'impact' cannot be used at the same time&quot;);</span>
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">    } else if (severity == null &amp;&amp; impact == null) {</span>
<span class="nc" id="L222">      throw new IllegalArgumentException(&quot;One of the parameters 'severity' or 'impact' must be provided&quot;);</span>
    }
<span class="fc" id="L224">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>