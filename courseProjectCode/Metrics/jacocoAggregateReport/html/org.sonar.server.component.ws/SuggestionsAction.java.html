<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SuggestionsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.component.ws</a> &gt; <span class="el_source">SuggestionsAction.java</span></div><h1>SuggestionsAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.component.ws;

import com.google.common.collect.ListMultimap;
import com.google.common.html.HtmlEscapers;
import com.google.common.io.Resources;
import java.util.Arrays;
import java.util.Collection;
import java.util.Comparator;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import javax.annotation.Nullable;
import org.sonar.server.component.ComponentType;
import org.sonar.server.component.ComponentTypes;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.NewAction;
import org.sonar.core.util.stream.MoreCollectors;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.entity.EntityDto;
import org.sonar.server.component.index.ComponentHit;
import org.sonar.server.component.index.ComponentHitsPerQualifier;
import org.sonar.server.component.index.ComponentIndex;
import org.sonar.server.component.index.ComponentIndexResults;
import org.sonar.server.component.index.SuggestionQuery;
import org.sonar.server.es.newindex.DefaultIndexSettings;
import org.sonar.server.favorite.FavoriteFinder;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Components.SuggestionsWsResponse;
import org.sonarqube.ws.Components.SuggestionsWsResponse.Category;
import org.sonarqube.ws.Components.SuggestionsWsResponse.Suggestion;

import static java.util.Arrays.stream;
import static java.util.Collections.emptyList;
import static java.util.Collections.emptySet;
import static java.util.Collections.singletonList;
import static org.sonar.db.permission.ProjectPermission.USER;
import static org.sonar.server.component.index.SuggestionQuery.DEFAULT_LIMIT;
import static org.sonar.server.es.newindex.DefaultIndexSettings.MINIMUM_NGRAM_LENGTH;
import static org.sonar.server.ws.WsUtils.writeProtobuf;
import static org.sonarqube.ws.Components.SuggestionsWsResponse.newBuilder;
import static org.sonarqube.ws.client.component.ComponentsWsParameters.ACTION_SUGGESTIONS;

public class SuggestionsAction implements ComponentsWsAction {
  static final String PARAM_QUERY = &quot;s&quot;;
  static final String PARAM_MORE = &quot;more&quot;;
  static final String PARAM_RECENTLY_BROWSED = &quot;recentlyBrowsed&quot;;
  static final String SHORT_INPUT_WARNING = &quot;short_input&quot;;
  private static final int MAXIMUM_RECENTLY_BROWSED = 50;
  private static final int EXTENDED_LIMIT = 20;

  private final ComponentIndex index;
  private final FavoriteFinder favoriteFinder;
  private final UserSession userSession;
  private final ComponentTypes componentTypes;

  private final DbClient dbClient;

<span class="fc" id="L86">  public SuggestionsAction(DbClient dbClient, ComponentIndex index, FavoriteFinder favoriteFinder, UserSession userSession, ComponentTypes componentTypes) {</span>
<span class="fc" id="L87">    this.dbClient = dbClient;</span>
<span class="fc" id="L88">    this.index = index;</span>
<span class="fc" id="L89">    this.favoriteFinder = favoriteFinder;</span>
<span class="fc" id="L90">    this.userSession = userSession;</span>
<span class="fc" id="L91">    this.componentTypes = componentTypes;</span>
<span class="fc" id="L92">  }</span>

  @Override
  public void define(WebService.NewController context) {
<span class="fc" id="L96">    NewAction action = context.createAction(ACTION_SUGGESTIONS)</span>
<span class="fc" id="L97">      .setDescription(</span>
        &quot;Internal WS for the top-right search engine. The result will contain component search results, grouped by their qualifiers.&lt;p&gt;&quot;
          + &quot;Each result contains:&quot;
          + &quot;&lt;ul&gt;&quot;
          + &quot;&lt;li&gt;the component key&lt;/li&gt;&quot;
          + &quot;&lt;li&gt;the component's name (unescaped)&lt;/li&gt;&quot;
          + &quot;&lt;li&gt;optionally a display name, which puts emphasis to matching characters (this text contains html tags and parts of the html-escaped name)&lt;/li&gt;&quot;
          + &quot;&lt;/ul&gt;&quot;)
<span class="fc" id="L105">      .setSince(&quot;4.2&quot;)</span>
<span class="fc" id="L106">      .setInternal(true)</span>
<span class="fc" id="L107">      .setHandler(this)</span>
<span class="fc" id="L108">      .setResponseExample(Resources.getResource(this.getClass(), &quot;suggestions-example.json&quot;))</span>
<span class="fc" id="L109">      .setChangelog(</span>
<span class="fc" id="L110">        new Change(&quot;10.0&quot;, String.format(&quot;The use of 'BRC' as value for parameter '%s' is no longer supported&quot;, PARAM_MORE)),</span>
<span class="fc" id="L111">        new Change(&quot;8.4&quot;, String.format(&quot;The use of 'DIR', 'FIL','UTS' as values for parameter '%s' is no longer supported&quot;, PARAM_MORE)),</span>
<span class="fc" id="L112">        new Change(&quot;7.6&quot;, String.format(&quot;The use of 'BRC' as value for parameter '%s' is deprecated&quot;, PARAM_MORE)));</span>

<span class="fc" id="L114">    action.createParam(PARAM_QUERY)</span>
<span class="fc" id="L115">      .setRequired(false)</span>
<span class="fc" id="L116">      .setMinimumLength(2)</span>
<span class="fc" id="L117">      .setDescription(&quot;Search query: can contain several search tokens separated by spaces.&quot;)</span>
<span class="fc" id="L118">      .setExampleValue(&quot;sonar&quot;);</span>

<span class="fc" id="L120">    action.createParam(PARAM_MORE)</span>
<span class="fc" id="L121">      .setDescription(&quot;Category, for which to display the next &quot; + EXTENDED_LIMIT + &quot; results (skipping the first &quot; + DEFAULT_LIMIT + &quot; results)&quot;)</span>
<span class="fc" id="L122">      .setPossibleValues(stream(SuggestionCategory.values()).map(SuggestionCategory::getName).toArray(String[]::new))</span>
<span class="fc" id="L123">      .setSince(&quot;6.4&quot;);</span>

<span class="fc" id="L125">    action.createParam(PARAM_RECENTLY_BROWSED)</span>
<span class="fc" id="L126">      .setDescription(&quot;Comma separated list of component keys, that have recently been browsed by the user. Only the first &quot; + MAXIMUM_RECENTLY_BROWSED</span>
        + &quot; items will be used. Order is not taken into account.&quot;)
<span class="fc" id="L128">      .setSince(&quot;6.4&quot;)</span>
<span class="fc" id="L129">      .setExampleValue(&quot;org.sonarsource:sonarqube,some.other:project&quot;)</span>
<span class="fc" id="L130">      .setRequired(false)</span>
<span class="fc" id="L131">      .setMaxValuesAllowed(MAXIMUM_RECENTLY_BROWSED);</span>
<span class="fc" id="L132">  }</span>

  @Override
  public void handle(Request wsRequest, Response wsResponse) throws Exception {
<span class="fc" id="L136">    String query = wsRequest.param(PARAM_QUERY);</span>
<span class="fc" id="L137">    String more = wsRequest.param(PARAM_MORE);</span>
<span class="fc" id="L138">    Set&lt;String&gt; recentlyBrowsedKeys = getRecentlyBrowsedKeys(wsRequest);</span>
<span class="fc" id="L139">    List&lt;String&gt; qualifiers = getQualifiers(more);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">    int skip = more == null ? 0 : DEFAULT_LIMIT;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">    int limit = more == null ? DEFAULT_LIMIT : EXTENDED_LIMIT;</span>
<span class="fc" id="L142">    SuggestionsWsResponse searchWsResponse = loadSuggestions(query, skip, limit, recentlyBrowsedKeys, qualifiers);</span>
<span class="fc" id="L143">    writeProtobuf(searchWsResponse, wsRequest, wsResponse);</span>
<span class="fc" id="L144">  }</span>

  private static Set&lt;String&gt; getRecentlyBrowsedKeys(Request wsRequest) {
<span class="fc" id="L147">    List&lt;String&gt; recentlyBrowsedParam = wsRequest.paramAsStrings(PARAM_RECENTLY_BROWSED);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">    if (recentlyBrowsedParam == null) {</span>
<span class="fc" id="L149">      return emptySet();</span>
    }
<span class="fc" id="L151">    return new HashSet&lt;&gt;(recentlyBrowsedParam);</span>
  }

  private SuggestionsWsResponse loadSuggestions(@Nullable String query, int skip, int limit, Set&lt;String&gt; recentlyBrowsedKeys, List&lt;String&gt; qualifiers) {
<span class="fc bfc" id="L155" title="All 2 branches covered.">    if (query == null) {</span>
<span class="fc" id="L156">      return loadSuggestionsWithoutSearch(skip, limit, recentlyBrowsedKeys, qualifiers);</span>
    }
<span class="fc" id="L158">    return loadSuggestionsWithSearch(query, skip, limit, recentlyBrowsedKeys, qualifiers);</span>
  }

  /**
   * we are generating suggestions, by using (1) favorites and (2) recently browsed components (without searching in Elasticsearch)
   */
  private SuggestionsWsResponse loadSuggestionsWithoutSearch(int skip, int limit, Set&lt;String&gt; recentlyBrowsedKeys, List&lt;String&gt; qualifiers) {
<span class="fc" id="L165">    List&lt;EntityDto&gt; favorites = favoriteFinder.list();</span>
<span class="fc bfc" id="L166" title="All 4 branches covered.">    if (favorites.isEmpty() &amp;&amp; recentlyBrowsedKeys.isEmpty()) {</span>
<span class="fc" id="L167">      return newBuilder().build();</span>
    }
<span class="fc" id="L169">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L170">      Set&lt;EntityDto&gt; entities = new HashSet&lt;&gt;(favorites);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">      if (!recentlyBrowsedKeys.isEmpty()) {</span>
<span class="fc" id="L172">        entities.addAll(dbClient.entityDao().selectByKeys(dbSession, recentlyBrowsedKeys));</span>
      }
<span class="fc" id="L174">      List&lt;EntityDto&gt; authorizedEntities = userSession.keepAuthorizedEntities(USER, entities);</span>
<span class="fc" id="L175">      ListMultimap&lt;String, EntityDto&gt; entityPerQualifier = authorizedEntities.stream()</span>
<span class="fc" id="L176">        .collect(MoreCollectors.index(EntityDto::getQualifier));</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">      if (entityPerQualifier.isEmpty()) {</span>
<span class="fc" id="L178">        return newBuilder().build();</span>
      }

<span class="fc" id="L181">      Set&lt;String&gt; favoriteUuids = favorites.stream().map(EntityDto::getUuid).collect(Collectors.toSet());</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">      Comparator&lt;EntityDto&gt; favoriteComparator = Comparator.comparing(c -&gt; favoriteUuids.contains(c.getUuid()) ? -1 : +1);</span>
<span class="fc" id="L183">      Comparator&lt;EntityDto&gt; comparator = favoriteComparator.thenComparing(EntityDto::getName);</span>

<span class="fc" id="L185">      ComponentIndexResults componentsPerQualifiers = ComponentIndexResults.newBuilder().setQualifiers(</span>
<span class="fc" id="L186">        qualifiers.stream().map(q -&gt; {</span>
<span class="fc" id="L187">          List&lt;EntityDto&gt; componentsOfThisQualifier = entityPerQualifier.get(q);</span>
<span class="fc" id="L188">          List&lt;ComponentHit&gt; hits = componentsOfThisQualifier</span>
<span class="fc" id="L189">            .stream()</span>
<span class="fc" id="L190">            .sorted(comparator)</span>
<span class="fc" id="L191">            .skip(skip)</span>
<span class="fc" id="L192">            .limit(limit)</span>
<span class="fc" id="L193">            .map(EntityDto::getUuid)</span>
<span class="fc" id="L194">            .map(ComponentHit::new)</span>
<span class="fc" id="L195">            .toList();</span>
<span class="fc" id="L196">          int totalHits = componentsOfThisQualifier.size();</span>
<span class="fc" id="L197">          return new ComponentHitsPerQualifier(q, hits, totalHits);</span>
<span class="fc" id="L198">        })).build();</span>
<span class="fc" id="L199">      return buildResponse(recentlyBrowsedKeys, favoriteUuids, componentsPerQualifiers, authorizedEntities, skip + limit).build();</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">    }</span>
  }

  private SuggestionsWsResponse loadSuggestionsWithSearch(String query, int skip, int limit, Set&lt;String&gt; recentlyBrowsedKeys, List&lt;String&gt; qualifiers) {
<span class="fc bfc" id="L204" title="All 4 branches covered.">    if (split(query).noneMatch(token -&gt; token.length() &gt;= MINIMUM_NGRAM_LENGTH)) {</span>
<span class="fc" id="L205">      SuggestionsWsResponse.Builder queryBuilder = newBuilder();</span>
<span class="fc" id="L206">      getWarning(query).ifPresent(queryBuilder::setWarning);</span>
<span class="fc" id="L207">      return queryBuilder.build();</span>
    }

<span class="fc" id="L210">    List&lt;EntityDto&gt; favorites = favoriteFinder.list();</span>
<span class="fc" id="L211">    Set&lt;String&gt; favoriteKeys = favorites.stream().map(EntityDto::getKey).collect(Collectors.toSet());</span>
<span class="fc" id="L212">    SuggestionQuery.Builder queryBuilder = SuggestionQuery.builder()</span>
<span class="fc" id="L213">      .setQuery(query)</span>
<span class="fc" id="L214">      .setRecentlyBrowsedKeys(recentlyBrowsedKeys)</span>
<span class="fc" id="L215">      .setFavoriteKeys(favoriteKeys)</span>
<span class="fc" id="L216">      .setQualifiers(qualifiers)</span>
<span class="fc" id="L217">      .setSkip(skip)</span>
<span class="fc" id="L218">      .setLimit(limit);</span>
<span class="fc" id="L219">    ComponentIndexResults componentsPerQualifiers = searchInIndex(queryBuilder.build());</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">    if (componentsPerQualifiers.isEmpty()) {</span>
<span class="fc" id="L221">      return newBuilder().build();</span>
    }
<span class="fc" id="L223">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L224">      Set&lt;String&gt; entityUuids = componentsPerQualifiers.getQualifiers()</span>
<span class="fc" id="L225">        .map(ComponentHitsPerQualifier::getHits)</span>
<span class="fc" id="L226">        .flatMap(Collection::stream)</span>
<span class="fc" id="L227">        .map(ComponentHit::getUuid)</span>
<span class="fc" id="L228">        .collect(Collectors.toSet());</span>
<span class="fc" id="L229">      List&lt;EntityDto&gt; entities = dbClient.entityDao().selectByUuids(dbSession, entityUuids);</span>
<span class="fc" id="L230">      Set&lt;String&gt; favoriteUuids = favorites.stream().map(EntityDto::getUuid).collect(Collectors.toSet());</span>
<span class="fc" id="L231">      SuggestionsWsResponse.Builder searchWsResponse = buildResponse(recentlyBrowsedKeys, favoriteUuids, componentsPerQualifiers, entities, skip + limit);</span>
<span class="fc" id="L232">      getWarning(query).ifPresent(searchWsResponse::setWarning);</span>
<span class="fc" id="L233">      return searchWsResponse.build();</span>
    }
  }

  private static Optional&lt;String&gt; getWarning(String query) {
<span class="fc" id="L238">    return split(query)</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">      .filter(token -&gt; token.length() &lt; MINIMUM_NGRAM_LENGTH)</span>
<span class="fc" id="L240">      .findAny()</span>
<span class="fc" id="L241">      .map(x -&gt; SHORT_INPUT_WARNING);</span>
  }

  private static Stream&lt;String&gt; split(String query) {
<span class="fc" id="L245">    return Arrays.stream(query.split(DefaultIndexSettings.SEARCH_TERM_TOKENIZER_PATTERN));</span>
  }

  private List&lt;String&gt; getQualifiers(@Nullable String more) {
<span class="fc" id="L249">    Set&lt;String&gt; availableQualifiers = componentTypes.getAll().stream()</span>
<span class="fc" id="L250">      .map(ComponentType::getQualifier)</span>
<span class="fc" id="L251">      .collect(Collectors.toSet());</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">    if (more == null) {</span>
<span class="fc" id="L253">      return stream(SuggestionCategory.values())</span>
<span class="fc" id="L254">        .map(SuggestionCategory::getQualifier)</span>
<span class="fc" id="L255">        .filter(availableQualifiers::contains)</span>
<span class="fc" id="L256">        .toList();</span>
    }

<span class="fc" id="L259">    String qualifier = SuggestionCategory.getByName(more).getQualifier();</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">    return availableQualifiers.contains(qualifier) ? singletonList(qualifier) : emptyList();</span>
  }

  private SuggestionsWsResponse.Builder buildResponse(Set&lt;String&gt; recentlyBrowsedKeys, Set&lt;String&gt; favoriteUuids, ComponentIndexResults componentsPerQualifiers,
    List&lt;EntityDto&gt; entities, int coveredItems) {

<span class="fc" id="L266">    Map&lt;String, EntityDto&gt; entitiesByUuids = entities.stream().collect(Collectors.toMap(EntityDto::getUuid, Function.identity()));</span>
<span class="fc" id="L267">    return toResponse(componentsPerQualifiers, recentlyBrowsedKeys, favoriteUuids, entitiesByUuids, coveredItems);</span>
  }

  private ComponentIndexResults searchInIndex(SuggestionQuery suggestionQuery) {
<span class="fc" id="L271">    return index.searchSuggestions(suggestionQuery);</span>
  }

  private static SuggestionsWsResponse.Builder toResponse(ComponentIndexResults componentsPerQualifiers, Set&lt;String&gt; recentlyBrowsedKeys, Set&lt;String&gt; favoriteUuids,
    Map&lt;String, EntityDto&gt; entitiesByUuids, int coveredItems) {
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">    if (componentsPerQualifiers.isEmpty()) {</span>
<span class="nc" id="L277">      return newBuilder();</span>
    }
<span class="fc" id="L279">    return newBuilder()</span>
<span class="fc" id="L280">      .addAllResults(toCategories(componentsPerQualifiers, recentlyBrowsedKeys, favoriteUuids, entitiesByUuids, coveredItems));</span>
  }

  private static List&lt;Category&gt; toCategories(ComponentIndexResults componentsPerQualifiers, Set&lt;String&gt; recentlyBrowsedKeys, Set&lt;String&gt; favoriteUuids,
    Map&lt;String, EntityDto&gt; entitiesByUuids, int coveredItems) {
<span class="fc" id="L285">    return componentsPerQualifiers.getQualifiers().map(qualifier -&gt; {</span>

<span class="fc" id="L287">      List&lt;Suggestion&gt; suggestions = qualifier.getHits().stream()</span>
<span class="fc" id="L288">        .map(hit -&gt; toSuggestion(hit, recentlyBrowsedKeys, favoriteUuids, entitiesByUuids))</span>
<span class="fc" id="L289">        .filter(Optional::isPresent)</span>
<span class="fc" id="L290">        .map(Optional::get)</span>
<span class="fc" id="L291">        .toList();</span>

<span class="fc" id="L293">      return Category.newBuilder()</span>
<span class="fc" id="L294">        .setQ(qualifier.getQualifier())</span>
<span class="fc" id="L295">        .setMore(Math.max(0, qualifier.getTotalHits() - coveredItems))</span>
<span class="fc" id="L296">        .addAllItems(suggestions)</span>
<span class="fc" id="L297">        .build();</span>
<span class="fc" id="L298">    }).toList();</span>
  }

  /**
   * @return null when the component exists in Elasticsearch but not in database. That
   * occurs when failed indexing requests are been recovering.
   */
  private static Optional&lt;Suggestion&gt; toSuggestion(ComponentHit hit, Set&lt;String&gt; recentlyBrowsedKeys, Set&lt;String&gt; favoriteUuids, Map&lt;String, EntityDto&gt; entitiesByUuids) {
<span class="fc" id="L306">    return Optional.ofNullable(entitiesByUuids.get(hit.getUuid()))</span>
<span class="fc" id="L307">      .map(result -&gt; Suggestion.newBuilder()</span>
<span class="fc" id="L308">        .setKey(result.getKey())</span>
<span class="fc" id="L309">        .setName(result.getName())</span>
<span class="fc" id="L310">        .setMatch(hit.getHighlightedText().orElse(HtmlEscapers.htmlEscaper().escape(result.getName())))</span>
<span class="fc" id="L311">        .setIsRecentlyBrowsed(recentlyBrowsedKeys.contains(result.getKey()))</span>
<span class="fc" id="L312">        .setIsFavorite(favoriteUuids.contains(result.getUuid()))</span>
<span class="fc" id="L313">        .build());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>