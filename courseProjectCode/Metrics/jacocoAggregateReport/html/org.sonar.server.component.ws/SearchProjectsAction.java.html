<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchProjectsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sonarqube</a> &gt; <a href="index.source.html" class="el_package">org.sonar.server.component.ws</a> &gt; <span class="el_source">SearchProjectsAction.java</span></div><h1>SearchProjectsAction.java</h1><pre class="source lang-java linenums">/*
 * SonarQube
 * Copyright (C) 2009-2025 SonarSource SA
 * mailto:info AT sonarsource DOT com
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 3 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */
package org.sonar.server.component.ws;

import com.google.common.collect.Maps;
import com.google.common.collect.Ordering;
import com.google.common.collect.Sets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collector;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import javax.annotation.CheckForNull;
import javax.annotation.Nullable;
import org.sonar.api.server.ws.Change;
import org.sonar.api.server.ws.Request;
import org.sonar.api.server.ws.Response;
import org.sonar.api.server.ws.WebService;
import org.sonar.api.server.ws.WebService.Param;
import org.sonar.db.permission.ProjectPermission;
import org.sonar.core.platform.EditionProvider.Edition;
import org.sonar.core.platform.PlatformEditionProvider;
import org.sonar.db.DbClient;
import org.sonar.db.DbSession;
import org.sonar.db.component.BranchDto;
import org.sonar.db.component.ComponentQualifiers;
import org.sonar.db.component.SnapshotDto;
import org.sonar.db.project.ProjectDto;
import org.sonar.db.property.PropertyDto;
import org.sonar.db.property.PropertyQuery;
import org.sonar.db.user.TokenType;
import org.sonar.server.ai.code.assurance.AiCodeAssurance;
import org.sonar.server.ai.code.assurance.AiCodeAssuranceEntitlement;
import org.sonar.server.ai.code.assurance.AiCodeAssuranceVerifier;
import org.sonar.server.component.ws.FilterParser.Criterion;
import org.sonar.server.component.ws.SearchProjectsAction.SearchResults.SearchResultsBuilder;
import org.sonar.server.es.Facets;
import org.sonar.server.es.SearchIdResult;
import org.sonar.server.es.SearchOptions;
import org.sonar.server.measure.index.ProjectMeasuresIndex;
import org.sonar.server.measure.index.ProjectMeasuresQuery;
import org.sonar.server.project.Visibility;
import org.sonar.server.user.TokenUserSession;
import org.sonar.server.user.UserSession;
import org.sonarqube.ws.Common;
import org.sonarqube.ws.Components;
import org.sonarqube.ws.Components.Component;
import org.sonarqube.ws.Components.SearchProjectsWsResponse;

import static com.google.common.base.MoreObjects.firstNonNull;
import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Sets.newHashSet;
import static java.util.Collections.emptyList;
import static java.util.Collections.emptyMap;
import static java.util.Objects.requireNonNull;
import static java.util.Optional.ofNullable;
import static org.sonar.api.measures.CoreMetrics.ALERT_STATUS_KEY;
import static org.sonar.api.server.ws.WebService.Param.FACETS;
import static org.sonar.api.server.ws.WebService.Param.FIELDS;
import static org.sonar.api.utils.DateUtils.formatDateTime;
import static org.sonar.db.measure.ProjectMeasuresIndexerIterator.METRIC_KEYS;
import static org.sonar.server.component.ws.ProjectMeasuresQueryFactory.IS_FAVORITE_CRITERION;
import static org.sonar.server.component.ws.ProjectMeasuresQueryFactory.newProjectMeasuresQuery;
import static org.sonar.server.component.ws.ProjectMeasuresQueryValidator.NON_METRIC_SORT_KEYS;
import static org.sonar.server.measure.index.ProjectMeasuresQuery.SORT_BY_CREATION_DATE;
import static org.sonar.server.measure.index.ProjectMeasuresQuery.SORT_BY_LAST_ANALYSIS_DATE;
import static org.sonar.server.measure.index.ProjectMeasuresQuery.SORT_BY_NAME;
import static org.sonar.server.ws.WsUtils.writeProtobuf;
import static org.sonarqube.ws.client.component.ComponentsWsParameters.ACTION_SEARCH_PROJECTS;
import static org.sonarqube.ws.client.component.ComponentsWsParameters.PARAM_FILTER;
import static org.sonarqube.ws.client.project.ProjectsWsParameters.FILTER_LANGUAGES;
import static org.sonarqube.ws.client.project.ProjectsWsParameters.FILTER_TAGS;

public class SearchProjectsAction implements ComponentsWsAction {
  public static final int MAX_PAGE_SIZE = 500;
  public static final int DEFAULT_PAGE_SIZE = 100;
  private static final String ALL = &quot;_all&quot;;
  private static final String ANALYSIS_DATE = &quot;analysisDate&quot;;
  private static final String LEAK_PERIOD_DATE = &quot;leakPeriodDate&quot;;
  private static final String METRIC_LEAK_PROJECTS_KEY = &quot;leak_projects&quot;;
  private static final String HTML_POSSIBLE_VALUES_TEXT = &quot;The possible values are:&quot;;
  private static final String HTML_UL_START_TAG = &quot;&lt;ul&gt;&quot;;
  private static final String HTML_UL_END_TAG = &quot;&lt;/ul&gt;&quot;;
<span class="fc" id="L112">  private static final Set&lt;String&gt; POSSIBLE_FIELDS = newHashSet(ALL, ANALYSIS_DATE, LEAK_PERIOD_DATE);</span>

  private final DbClient dbClient;
  private final ProjectMeasuresIndex index;
  private final UserSession userSession;
  private final PlatformEditionProvider editionProvider;
  private final AiCodeAssuranceVerifier aiCodeAssuranceVerifier;
  private final AiCodeAssuranceEntitlement aiCodeAssuranceEntitlement;

  public SearchProjectsAction(DbClient dbClient, ProjectMeasuresIndex index, UserSession userSession,
<span class="fc" id="L122">    PlatformEditionProvider editionProvider,  AiCodeAssuranceEntitlement aiCodeAssuranceEntitlement, AiCodeAssuranceVerifier aiCodeAssuranceVerifier   ) {</span>
<span class="fc" id="L123">    this.dbClient = dbClient;</span>
<span class="fc" id="L124">    this.index = index;</span>
<span class="fc" id="L125">    this.userSession = userSession;</span>
<span class="fc" id="L126">    this.editionProvider = editionProvider;</span>
<span class="fc" id="L127">    this.aiCodeAssuranceEntitlement = aiCodeAssuranceEntitlement;</span>
<span class="fc" id="L128">    this.aiCodeAssuranceVerifier = aiCodeAssuranceVerifier;</span>
<span class="fc" id="L129">  }</span>

  @Override
  public void define(WebService.NewController context) {
<span class="fc" id="L133">    WebService.NewAction action = context.createAction(ACTION_SEARCH_PROJECTS)</span>
<span class="fc" id="L134">      .setSince(&quot;6.2&quot;)</span>
<span class="fc" id="L135">      .setDescription(&quot;Search for projects&quot;)</span>
<span class="fc" id="L136">      .addPagingParams(DEFAULT_PAGE_SIZE, MAX_PAGE_SIZE)</span>
<span class="fc" id="L137">      .setInternal(true)</span>
<span class="fc" id="L138">      .setChangelog(</span>
        new Change(&quot;2025.1&quot;, &quot;Field 'containsAiCode' response field has added.&quot;),
        new Change(&quot;2025.1&quot;, &quot;Field 'isAiCodeAssured' response field has been removed.&quot;),
        new Change(&quot;10.8&quot;, &quot;Field 'isAiCodeAssured' response field has been deprecated. Use 'aiCodeAssurance' instead.&quot;),
        new Change(&quot;10.8&quot;, &quot;Add 'aiCodeAssurance' response field&quot;),
        new Change(&quot;10.7&quot;, &quot;Add 'isAiCodeAssured' response field&quot;),
        new Change(&quot;10.3&quot;, &quot;Add 'creationDate' sort parameter.&quot;),
        new Change(&quot;10.2&quot;, &quot;Field 'needIssueSync' removed from response&quot;),
        new Change(&quot;8.3&quot;, &quot;Add 'qualifier' filter and facet&quot;),
        new Change(&quot;8.0&quot;, &quot;Field 'id' removed from response&quot;))
<span class="fc" id="L148">      .setResponseExample(getClass().getResource(&quot;search_projects-example.json&quot;))</span>
<span class="fc" id="L149">      .setHandler(this);</span>

<span class="fc" id="L151">    action.createFieldsParam(POSSIBLE_FIELDS)</span>
<span class="fc" id="L152">      .setDescription(&quot;Comma-separated list of the fields to be returned in response&quot;)</span>
<span class="fc" id="L153">      .setSince(&quot;6.4&quot;);</span>
<span class="fc" id="L154">    action.createParam(FACETS)</span>
<span class="fc" id="L155">      .setDescription(&quot;Comma-separated list of the facets to be computed. No facet is computed by default.&quot;)</span>
<span class="fc" id="L156">      .setPossibleValues(Arrays.stream(ProjectMeasuresIndex.Facet.values())</span>
<span class="fc" id="L157">        .map(ProjectMeasuresIndex.Facet::getName)</span>
<span class="fc" id="L158">        .sorted()</span>
<span class="fc" id="L159">        .toList());</span>
<span class="fc" id="L160">    action</span>
<span class="fc" id="L161">      .createParam(PARAM_FILTER)</span>
<span class="fc" id="L162">      .setMinimumLength(2)</span>
<span class="fc" id="L163">      .setDescription(&quot;Filter of projects on name, key, measure value, quality gate, language, tag or whether a project is a favorite or &quot; +</span>
        &quot;not.&lt;br&gt;&quot; +
        &quot;The filter must be encoded to form a valid URL (for example '=' must be replaced by '%3D').&lt;br&gt;&quot; +
        &quot;Examples of use:&quot; +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;to filter my favorite projects with a failed quality gate and a coverage greater than or equals to 60% and a coverage &quot; +
        &quot;strictly lower than 80%:&lt;br&gt;&quot; +
        &quot;   &lt;code&gt;filter=\&quot;alert_status = ERROR and isFavorite and coverage &gt;= 60 and coverage &lt; 80\&quot;&lt;/code&gt;&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;to filter projects with a reliability, security and maintainability rating equals or worse than B:&lt;br&gt;&quot; +
        &quot;   &lt;code&gt;filter=\&quot;reliability_rating&gt;=2 and security_rating&gt;=2 and sqale_rating&gt;=2\&quot;&lt;/code&gt;&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;to filter projects without duplication data:&lt;br&gt;&quot; +
        &quot;   &lt;code&gt;filter=\&quot;duplicated_lines_density = NO_DATA\&quot;&lt;/code&gt;&lt;/li&gt;&quot; +
        HTML_UL_END_TAG +
        &quot;To filter on project name or key, use the 'query' keyword, for instance : &lt;code&gt;filter='query = \&quot;Sonar\&quot;'&lt;/code&gt;.&lt;br&gt;&quot; +
        &quot;&lt;br&gt;&quot; +
        &quot;To filter on a numeric metric, provide the metric key.&lt;br&gt;&quot; +
        &quot;These are the supported metric keys:&lt;br&gt;&quot; +
        HTML_UL_START_TAG +
<span class="fc" id="L181">        METRIC_KEYS.stream().sorted().map(key -&gt; &quot;&lt;li&gt;&quot; + key + &quot;&lt;/li&gt;&quot;).collect(Collectors.joining()) +</span>
        HTML_UL_END_TAG +
        &quot;&lt;br&gt;&quot; +
        &quot;To filter on a rating, provide the corresponding metric key (ex: reliability_rating for reliability rating).&lt;br&gt;&quot; +
        HTML_POSSIBLE_VALUES_TEXT +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;'1' for rating A&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'2' for rating B&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'3' for rating C&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'4' for rating D&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'5' for rating E&lt;/li&gt;&quot; +
        HTML_UL_END_TAG +
        &quot;To filter on a Quality Gate status use the metric key 'alert_status'. Only the '=' operator can be used.&lt;br&gt;&quot; +
        HTML_POSSIBLE_VALUES_TEXT +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;'OK' for Passed&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'WARN' for Warning&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;'ERROR' for Failed&lt;/li&gt;&quot; +
        HTML_UL_END_TAG +
        &quot;To filter on languages use the 'languages' keyword: &quot; +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;to filter on a single language you can use 'languages = java'&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;to filter on several languages you must use 'languages IN (java, js)'&lt;/li&gt;&quot; +
        HTML_UL_END_TAG +
        &quot;Use the WS api/languages/list to find the key of a language.&lt;br&gt; &quot; +
        &quot;To filter on tags use the 'tags' keyword:&quot; +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;to filter on one tag you can use &lt;code&gt;tags = finance&lt;/code&gt;&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;to filter on several tags you must use &lt;code&gt;tags in (offshore, java)&lt;/code&gt;&lt;/li&gt;&quot; +
        HTML_UL_END_TAG +
        &quot;To filter on a qualifier use key 'qualifier'. Only the '=' operator can be used.&lt;br&gt;&quot; +
        HTML_POSSIBLE_VALUES_TEXT +
        HTML_UL_START_TAG +
        &quot; &lt;li&gt;TRK - for projects&lt;/li&gt;&quot; +
        &quot; &lt;li&gt;APP - for applications&lt;/li&gt;&quot; +
        HTML_UL_END_TAG);
<span class="fc" id="L217">    action.createParam(Param.SORT)</span>
<span class="fc" id="L218">      .setDescription(&quot;Sort projects by numeric metric key, quality gate status (using '%s'), last analysis date (using '%s'), project &quot; +</span>
          &quot;name or creationDate (using '%s').&quot;,
        ALERT_STATUS_KEY, SORT_BY_LAST_ANALYSIS_DATE, PARAM_FILTER, SORT_BY_CREATION_DATE)
<span class="fc" id="L221">      .setDefaultValue(SORT_BY_NAME)</span>
<span class="fc" id="L222">      .setPossibleValues(</span>
<span class="fc" id="L223">        Stream.concat(METRIC_KEYS.stream(), NON_METRIC_SORT_KEYS.stream()).sorted().toList())</span>
<span class="fc" id="L224">      .setSince(&quot;6.4&quot;);</span>
<span class="fc" id="L225">    action.createParam(Param.ASCENDING)</span>
<span class="fc" id="L226">      .setDescription(&quot;Ascending sort&quot;)</span>
<span class="fc" id="L227">      .setBooleanPossibleValues()</span>
<span class="fc" id="L228">      .setDefaultValue(true);</span>
<span class="fc" id="L229">  }</span>

  @Override
  public void handle(Request httpRequest, Response httpResponse) throws Exception {
<span class="fc" id="L233">    SearchProjectsWsResponse response = doHandle(toRequest(httpRequest));</span>

<span class="fc" id="L235">    writeProtobuf(response, httpRequest, httpResponse);</span>
<span class="fc" id="L236">  }</span>

  private SearchProjectsWsResponse doHandle(SearchProjectsRequest request) {
<span class="fc" id="L239">    try (DbSession dbSession = dbClient.openSession(false)) {</span>
<span class="fc" id="L240">      SearchResults searchResults = searchData(dbSession, request);</span>
<span class="fc" id="L241">      return buildResponse(request, searchResults);</span>
    }
  }

  private SearchResults searchData(DbSession dbSession, SearchProjectsRequest request) {
<span class="fc" id="L246">    Set&lt;String&gt; favoriteProjectUuids = loadFavoriteProjectUuids(dbSession);</span>
<span class="fc" id="L247">    List&lt;Criterion&gt; criteria = FilterParser.parse(firstNonNull(request.getFilter(), &quot;&quot;));</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">    ProjectMeasuresQuery query = newProjectMeasuresQuery(criteria, hasFavoriteFilter(criteria) ? favoriteProjectUuids : null)</span>
<span class="fc" id="L249">      .setSort(request.getSort())</span>
<span class="fc" id="L250">      .setAsc(request.getAsc());</span>

<span class="fc" id="L252">    Set&lt;String&gt; qualifiersBasedOnEdition = getQualifiersBasedOnEdition(query);</span>
<span class="fc" id="L253">    query.setQualifiers(qualifiersBasedOnEdition);</span>

<span class="fc" id="L255">    ProjectMeasuresQueryValidator.validate(query);</span>

<span class="fc" id="L257">    SearchIdResult&lt;String&gt; esResults = index.search(query, new SearchOptions()</span>
      // skip facets for project token authorization, avoid exposing unauthorized projects count
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">      .addFacets(isProjectAnalysisToken() ? emptyList() : request.getFacets())</span>
<span class="fc" id="L260">      .setPage(request.getPage(), request.getPageSize()));</span>

<span class="fc" id="L262">    List&lt;String&gt; projectUuids = esResults.getUuids();</span>
<span class="fc" id="L263">    Ordering&lt;ProjectDto&gt; ordering = Ordering.explicit(projectUuids).onResultOf(ProjectDto::getUuid);</span>
<span class="fc" id="L264">    List&lt;ProjectDto&gt; projects = ordering.immutableSortedCopy(dbClient.projectDao().selectByUuids(dbSession, new HashSet&lt;&gt;(projectUuids)));</span>
<span class="fc" id="L265">    projects = userSession.keepAuthorizedEntities(ProjectPermission.USER, projects);</span>

<span class="fc" id="L267">    Map&lt;String, BranchDto&gt; mainBranchByUuid = dbClient.branchDao().selectMainBranchesByProjectUuids(dbSession, projectUuids)</span>
<span class="fc" id="L268">      .stream()</span>
<span class="fc" id="L269">      .collect(Collectors.toMap(BranchDto::getUuid, b -&gt; b));</span>

<span class="fc" id="L271">    List&lt;SnapshotDto&gt; snapshots = getSnapshots(dbSession, request, mainBranchByUuid.keySet());</span>
<span class="fc" id="L272">    Map&lt;String, SnapshotDto&gt; analysisByProjectUuid = snapshots.stream()</span>
<span class="fc" id="L273">      .collect(Collectors.toMap(s -&gt; mainBranchByUuid.get(s.getRootComponentUuid()).getProjectUuid(), s -&gt; s));</span>
<span class="fc" id="L274">    Map&lt;String, Long&gt; applicationsBranchLeakPeriod = getApplicationsLeakPeriod(dbSession, request, qualifiersBasedOnEdition,</span>
<span class="fc" id="L275">      mainBranchByUuid.keySet());</span>
<span class="fc" id="L276">    Map&lt;String, Long&gt; applicationsLeakPeriod = applicationsBranchLeakPeriod.entrySet()</span>
<span class="fc" id="L277">      .stream()</span>
<span class="fc" id="L278">      .collect(Collectors.toMap(e -&gt; mainBranchByUuid.get(e.getKey()).getProjectUuid(), Entry::getValue));</span>

<span class="fc" id="L280">    return SearchResultsBuilder.builder()</span>
<span class="fc" id="L281">      .projects(projects)</span>
<span class="fc" id="L282">      .favoriteProjectUuids(favoriteProjectUuids)</span>
<span class="fc" id="L283">      .searchResults(esResults)</span>
<span class="fc" id="L284">      .analysisByProjectUuid(analysisByProjectUuid)</span>
<span class="fc" id="L285">      .applicationsLeakPeriods(applicationsLeakPeriod)</span>
<span class="fc" id="L286">      .query(query)</span>
<span class="fc" id="L287">      .build();</span>
  }

  private Set&lt;String&gt; getQualifiersBasedOnEdition(ProjectMeasuresQuery query) {
<span class="fc" id="L291">    Set&lt;String&gt; availableQualifiers = getQualifiersFromEdition();</span>
<span class="fc" id="L292">    Set&lt;String&gt; requestQualifiers = query.getQualifiers().orElse(availableQualifiers);</span>

<span class="fc" id="L294">    Set&lt;String&gt; resolvedQualifiers = requestQualifiers.stream()</span>
<span class="fc" id="L295">      .filter(availableQualifiers::contains)</span>
<span class="fc" id="L296">      .collect(Collectors.toSet());</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">    if (!resolvedQualifiers.isEmpty()) {</span>
<span class="fc" id="L298">      return resolvedQualifiers;</span>
    } else {
<span class="nc" id="L300">      throw new IllegalArgumentException(&quot;Invalid qualifier, available are: &quot; + String.join(&quot;,&quot;, availableQualifiers));</span>
    }
  }

  private Set&lt;String&gt; getQualifiersFromEdition() {
<span class="fc" id="L305">    Optional&lt;Edition&gt; edition = editionProvider.get();</span>

<span class="fc bfc" id="L307" title="All 2 branches covered.">    if (edition.isEmpty()) {</span>
<span class="fc" id="L308">      return Sets.newHashSet(ComponentQualifiers.PROJECT);</span>
    }

<span class="fc bfc" id="L311" title="All 2 branches covered.">    return switch (edition.get()) {</span>
<span class="fc" id="L312">      case ENTERPRISE, DATACENTER, DEVELOPER -&gt; Sets.newHashSet(ComponentQualifiers.PROJECT, ComponentQualifiers.APP);</span>
<span class="fc" id="L313">      default -&gt; Sets.newHashSet(ComponentQualifiers.PROJECT);</span>
    };
  }

  private static boolean hasFavoriteFilter(List&lt;Criterion&gt; criteria) {
<span class="fc" id="L318">    return criteria.stream()</span>
<span class="fc" id="L319">      .map(Criterion::getKey)</span>
<span class="fc" id="L320">      .anyMatch(IS_FAVORITE_CRITERION::equalsIgnoreCase);</span>
  }

  private Set&lt;String&gt; loadFavoriteProjectUuids(DbSession dbSession) {
<span class="fc bfc" id="L324" title="All 2 branches covered.">    if (!userSession.isLoggedIn()) {</span>
<span class="fc" id="L325">      return Collections.emptySet();</span>
    }

<span class="fc" id="L328">    List&lt;PropertyDto&gt; props = dbClient.propertiesDao().selectByQuery(</span>
<span class="fc" id="L329">      PropertyQuery.builder()</span>
<span class="fc" id="L330">        .setUserUuid(userSession.getUuid())</span>
<span class="fc" id="L331">        .setKey(&quot;favourite&quot;)</span>
<span class="fc" id="L332">        .build(),</span>
      dbSession);

<span class="fc" id="L335">    Set&lt;String&gt; favoriteDbUuids = props.stream()</span>
<span class="fc" id="L336">      .map(PropertyDto::getEntityUuid)</span>
<span class="fc" id="L337">      .filter(Objects::nonNull)</span>
<span class="fc" id="L338">      .collect(Collectors.toSet());</span>

<span class="fc" id="L340">    return dbClient.projectDao().selectByUuids(dbSession, favoriteDbUuids).stream()</span>
<span class="fc" id="L341">      .map(ProjectDto::getUuid)</span>
<span class="fc" id="L342">      .collect(Collectors.toSet());</span>
  }

  private List&lt;SnapshotDto&gt; getSnapshots(DbSession dbSession, SearchProjectsRequest request, Collection&lt;String&gt; mainBranchUuids) {
<span class="fc bfc" id="L346" title="All 4 branches covered.">    if (request.getAdditionalFields().contains(ANALYSIS_DATE) || request.getAdditionalFields().contains(LEAK_PERIOD_DATE)) {</span>
<span class="fc" id="L347">      return dbClient.snapshotDao().selectLastAnalysesByRootComponentUuids(dbSession, mainBranchUuids);</span>
    }
<span class="fc" id="L349">    return emptyList();</span>
  }

  private Map&lt;String, Long&gt; getApplicationsLeakPeriod(DbSession dbSession, SearchProjectsRequest request, Set&lt;String&gt; qualifiers,
    Collection&lt;String&gt; mainBranchUuids) {
<span class="fc bfc" id="L354" title="All 4 branches covered.">    if (qualifiers.contains(ComponentQualifiers.APP) &amp;&amp; request.getAdditionalFields().contains(LEAK_PERIOD_DATE)) {</span>
<span class="fc" id="L355">      return dbClient.measureDao().selectByComponentUuidsAndMetricKeys(dbSession, mainBranchUuids,</span>
<span class="fc" id="L356">          Collections.singleton(METRIC_LEAK_PROJECTS_KEY))</span>
<span class="fc" id="L357">        .stream()</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">        .filter(m -&gt; !Objects.isNull(m.getString(METRIC_LEAK_PROJECTS_KEY)))</span>
<span class="fc" id="L359">        .map(m -&gt; Maps.immutableEntry(m.getComponentUuid(),</span>
<span class="fc" id="L360">          ApplicationLeakProjects.parse(m.getString(METRIC_LEAK_PROJECTS_KEY)).getOldestLeak()))</span>
<span class="fc" id="L361">        .filter(entry -&gt; entry.getValue().isPresent())</span>
<span class="fc" id="L362">        .collect(Collectors.toMap(Entry::getKey, entry -&gt; entry.getValue().get().getLeak()));</span>
    }

<span class="fc" id="L365">    return emptyMap();</span>
  }

  private static SearchProjectsRequest toRequest(Request httpRequest) {
<span class="fc" id="L369">    RequestBuilder request = new RequestBuilder()</span>
<span class="fc" id="L370">      .setFilter(httpRequest.param(PARAM_FILTER))</span>
<span class="fc" id="L371">      .setSort(httpRequest.mandatoryParam(Param.SORT))</span>
<span class="fc" id="L372">      .setAsc(httpRequest.mandatoryParamAsBoolean(Param.ASCENDING))</span>
<span class="fc" id="L373">      .setPage(httpRequest.mandatoryParamAsInt(Param.PAGE))</span>
<span class="fc" id="L374">      .setPageSize(httpRequest.mandatoryParamAsInt(Param.PAGE_SIZE));</span>
<span class="pc bpc" id="L375" title="1 of 2 branches missed.">    if (httpRequest.hasParam(FACETS)) {</span>
<span class="fc" id="L376">      request.setFacets(httpRequest.mandatoryParamAsStrings(FACETS));</span>
    }
<span class="fc bfc" id="L378" title="All 2 branches covered.">    if (httpRequest.hasParam(FIELDS)) {</span>
<span class="fc" id="L379">      List&lt;String&gt; paramsAsString = httpRequest.mandatoryParamAsStrings(FIELDS);</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">      if (paramsAsString.contains(ALL)) {</span>
<span class="fc" id="L381">        request.setAdditionalFields(List.of(ANALYSIS_DATE, LEAK_PERIOD_DATE));</span>
      } else {
<span class="fc" id="L383">        request.setAdditionalFields(paramsAsString);</span>
      }
    }
<span class="fc" id="L386">    return request.build();</span>
  }

  private SearchProjectsWsResponse buildResponse(SearchProjectsRequest request, SearchResults searchResults) {
<span class="fc" id="L390">    Function&lt;ProjectDto, Component&gt; dbToWsComponent = new DbToWsComponent(request, searchResults, userSession.isLoggedIn());</span>

<span class="fc" id="L392">    return Stream.of(SearchProjectsWsResponse.newBuilder())</span>
<span class="fc" id="L393">      .map(response -&gt; response.setPaging(Common.Paging.newBuilder()</span>
<span class="fc" id="L394">        .setPageIndex(request.getPage())</span>
<span class="fc" id="L395">        .setPageSize(request.getPageSize())</span>
        // skip total for project token authorization, avoid exposing unauthorized projects count
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">        .setTotal(isProjectAnalysisToken() ? searchResults.projects.size() : searchResults.total)))</span>
<span class="fc" id="L398">      .map(response -&gt; {</span>
<span class="fc" id="L399">        searchResults.projects.stream()</span>
<span class="fc" id="L400">          .map(dbToWsComponent)</span>
<span class="fc" id="L401">          .forEach(response::addComponents);</span>
<span class="fc" id="L402">        return response;</span>
      })
<span class="fc" id="L404">      .map(response -&gt; addFacets(searchResults, response))</span>
<span class="fc" id="L405">      .map(SearchProjectsWsResponse.Builder::build)</span>
<span class="fc" id="L406">      .findFirst()</span>
<span class="pc" id="L407">      .orElseThrow(() -&gt; new IllegalStateException(&quot;SearchProjectsWsResponse not built&quot;));</span>
  }

  private static SearchProjectsWsResponse.Builder addFacets(SearchResults searchResults, SearchProjectsWsResponse.Builder wsResponse) {
<span class="fc" id="L411">    Facets esFacets = searchResults.facets;</span>
<span class="fc" id="L412">    EsToWsFacet esToWsFacet = new EsToWsFacet();</span>

<span class="fc" id="L414">    searchResults.query.getLanguages().ifPresent(languages -&gt; addMandatoryValuesToFacet(esFacets, FILTER_LANGUAGES, languages));</span>
<span class="fc" id="L415">    searchResults.query.getTags().ifPresent(tags -&gt; addMandatoryValuesToFacet(esFacets, FILTER_TAGS, tags));</span>
<span class="fc" id="L416">    Common.Facets wsFacets = esFacets.getAll().entrySet().stream()</span>
<span class="fc" id="L417">      .map(esToWsFacet)</span>
<span class="fc" id="L418">      .collect(Collector.of(</span>
        Common.Facets::newBuilder,
        Common.Facets.Builder::addFacets,
        (result1, result2) -&gt; {
<span class="nc" id="L422">          throw new IllegalStateException(&quot;Parallel execution forbidden&quot;);</span>
        },
        Common.Facets.Builder::build));

<span class="fc" id="L426">    wsResponse.setFacets(wsFacets);</span>

<span class="fc" id="L428">    return wsResponse;</span>
  }

  private static void addMandatoryValuesToFacet(Facets facets, String facetName, Iterable&lt;String&gt; mandatoryValues) {
<span class="fc" id="L432">    Map&lt;String, Long&gt; buckets = facets.get(facetName);</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">    if (buckets == null) {</span>
<span class="fc" id="L434">      return;</span>
    }
<span class="fc bfc" id="L436" title="All 2 branches covered.">    for (String mandatoryValue : mandatoryValues) {</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">      if (!buckets.containsKey(mandatoryValue)) {</span>
<span class="fc" id="L438">        buckets.put(mandatoryValue, 0L);</span>
      }
<span class="fc" id="L440">    }</span>
<span class="fc" id="L441">  }</span>

<span class="fc" id="L443">  private static class EsToWsFacet implements Function&lt;Entry&lt;String, LinkedHashMap&lt;String, Long&gt;&gt;, Common.Facet&gt; {</span>
<span class="fc" id="L444">    private final BucketToFacetValue bucketToFacetValue = new BucketToFacetValue();</span>
<span class="fc" id="L445">    private final Common.Facet.Builder wsFacet = Common.Facet.newBuilder();</span>

    @Override
    public Common.Facet apply(Entry&lt;String, LinkedHashMap&lt;String, Long&gt;&gt; esFacet) {
<span class="fc" id="L449">      wsFacet</span>
<span class="fc" id="L450">        .clear()</span>
<span class="fc" id="L451">        .setProperty(esFacet.getKey());</span>
<span class="fc" id="L452">      LinkedHashMap&lt;String, Long&gt; buckets = esFacet.getValue();</span>
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">      if (buckets != null) {</span>
<span class="fc" id="L454">        buckets.entrySet()</span>
<span class="fc" id="L455">          .stream()</span>
<span class="fc" id="L456">          .map(bucketToFacetValue)</span>
<span class="fc" id="L457">          .forEach(wsFacet::addValues);</span>
      } else {
<span class="nc" id="L459">        wsFacet.addAllValues(Collections.emptyList());</span>
      }

<span class="fc" id="L462">      return wsFacet.build();</span>
    }
  }

  private static class BucketToFacetValue implements Function&lt;Entry&lt;String, Long&gt;, Common.FacetValue&gt; {
    private final Common.FacetValue.Builder facetValue;

<span class="fc" id="L469">    private BucketToFacetValue() {</span>
<span class="fc" id="L470">      this.facetValue = Common.FacetValue.newBuilder();</span>
<span class="fc" id="L471">    }</span>

    @Override
    public Common.FacetValue apply(Entry&lt;String, Long&gt; bucket) {
<span class="fc" id="L475">      return facetValue</span>
<span class="fc" id="L476">        .clear()</span>
<span class="fc" id="L477">        .setVal(bucket.getKey())</span>
<span class="fc" id="L478">        .setCount(bucket.getValue())</span>
<span class="fc" id="L479">        .build();</span>
    }
  }

  private class DbToWsComponent implements Function&lt;ProjectDto, Component&gt; {
    private final SearchProjectsRequest request;
    private final Component.Builder wsComponent;
    private final Set&lt;String&gt; favoriteProjectUuids;
    private final boolean isUserLoggedIn;
    private final Map&lt;String, SnapshotDto&gt; analysisByProjectUuid;
    private final Map&lt;String, Long&gt; applicationsLeakPeriod;

<span class="fc" id="L491">    private DbToWsComponent(SearchProjectsRequest request, SearchResults searchResults, boolean isUserLoggedIn) {</span>
<span class="fc" id="L492">      this.request = request;</span>
<span class="fc" id="L493">      this.analysisByProjectUuid = searchResults.analysisByProjectUuid;</span>
<span class="fc" id="L494">      this.applicationsLeakPeriod = searchResults.applicationsLeakPeriods;</span>
<span class="fc" id="L495">      this.wsComponent = Component.newBuilder();</span>
<span class="fc" id="L496">      this.favoriteProjectUuids = searchResults.favoriteProjectUuids;</span>
<span class="fc" id="L497">      this.isUserLoggedIn = isUserLoggedIn;</span>
<span class="fc" id="L498">    }</span>

    @Override
    public Component apply(ProjectDto dbProject) {
<span class="fc" id="L502">      AiCodeAssurance aiCodeAssurance = aiCodeAssuranceVerifier.getAiCodeAssurance(dbProject);</span>
<span class="fc" id="L503">      wsComponent</span>
<span class="fc" id="L504">        .clear()</span>
<span class="fc" id="L505">        .setKey(dbProject.getKey())</span>
<span class="fc" id="L506">        .setName(dbProject.getName())</span>
<span class="fc" id="L507">        .setQualifier(dbProject.getQualifier())</span>
<span class="fc" id="L508">        .setVisibility(Visibility.getLabel(dbProject.isPrivate()))</span>
<span class="pc bpc" id="L509" title="1 of 4 branches missed.">        .setContainsAiCode(dbProject.getContainsAiCode() &amp;&amp; aiCodeAssuranceEntitlement.isEnabled())</span>
<span class="fc" id="L510">        .setAiCodeAssurance(Components.AiCodeAssurance.valueOf(aiCodeAssurance.name()))</span>
<span class="fc" id="L511">        .setIsAiCodeFixEnabled(dbProject.getAiCodeFixEnabled());</span>
<span class="fc" id="L512">      wsComponent.getTagsBuilder().addAllTags(dbProject.getTags());</span>

<span class="fc" id="L514">      SnapshotDto snapshotDto = analysisByProjectUuid.get(dbProject.getUuid());</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">      if (snapshotDto != null) {</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">        if (request.getAdditionalFields().contains(ANALYSIS_DATE)) {</span>
<span class="fc" id="L517">          wsComponent.setAnalysisDate(formatDateTime(snapshotDto.getCreatedAt()));</span>
        }
<span class="fc bfc" id="L519" title="All 2 branches covered.">        if (request.getAdditionalFields().contains(LEAK_PERIOD_DATE)) {</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">          if (ComponentQualifiers.APP.equals(dbProject.getQualifier())) {</span>
<span class="fc" id="L521">            ofNullable(applicationsLeakPeriod.get(dbProject.getUuid())).ifPresent(leakPeriodDate -&gt; wsComponent.setLeakPeriodDate(formatDateTime(leakPeriodDate)));</span>
          } else {
<span class="fc" id="L523">            ofNullable(snapshotDto.getPeriodDate()).ifPresent(leakPeriodDate -&gt; wsComponent.setLeakPeriodDate(formatDateTime(leakPeriodDate)));</span>
          }
        }
      }

<span class="fc bfc" id="L528" title="All 2 branches covered.">      if (isUserLoggedIn) {</span>
<span class="fc" id="L529">        wsComponent.setIsFavorite(favoriteProjectUuids.contains(dbProject.getUuid()));</span>
      }

<span class="fc" id="L532">      return wsComponent.build();</span>
    }

  }

  public static class SearchResults {
    private final List&lt;ProjectDto&gt; projects;
    private final Set&lt;String&gt; favoriteProjectUuids;
    private final Facets facets;
    private final Map&lt;String, SnapshotDto&gt; analysisByProjectUuid;
    private final Map&lt;String, Long&gt; applicationsLeakPeriods;
    private final ProjectMeasuresQuery query;
    private final int total;

    private SearchResults(List&lt;ProjectDto&gt; projects, Set&lt;String&gt; favoriteProjectUuids, SearchIdResult&lt;String&gt; searchResults, Map&lt;String,
        SnapshotDto&gt; analysisByProjectUuid,
<span class="fc" id="L548">      Map&lt;String, Long&gt; applicationsLeakPeriods, ProjectMeasuresQuery query) {</span>
<span class="fc" id="L549">      this.projects = projects;</span>
<span class="fc" id="L550">      this.favoriteProjectUuids = favoriteProjectUuids;</span>
<span class="fc" id="L551">      this.total = (int) searchResults.getTotal();</span>
<span class="fc" id="L552">      this.facets = searchResults.getFacets();</span>
<span class="fc" id="L553">      this.analysisByProjectUuid = analysisByProjectUuid;</span>
<span class="fc" id="L554">      this.applicationsLeakPeriods = applicationsLeakPeriods;</span>
<span class="fc" id="L555">      this.query = query;</span>
<span class="fc" id="L556">    }</span>

    public static final class SearchResultsBuilder {

      private List&lt;ProjectDto&gt; projects;
      private Set&lt;String&gt; favoriteProjectUuids;
      private Map&lt;String, SnapshotDto&gt; analysisByProjectUuid;
      private Map&lt;String, Long&gt; applicationsLeakPeriods;
      private ProjectMeasuresQuery query;
      private SearchIdResult&lt;String&gt; searchResults;

      private SearchResultsBuilder() {
      }

      public static SearchResultsBuilder builder() {
<span class="fc" id="L571">        return new SearchResultsBuilder();</span>
      }

      public SearchResultsBuilder projects(List&lt;ProjectDto&gt; projects) {
<span class="fc" id="L575">        this.projects = projects;</span>
<span class="fc" id="L576">        return this;</span>
      }

      public SearchResultsBuilder favoriteProjectUuids(Set&lt;String&gt; favoriteProjectUuids) {
<span class="fc" id="L580">        this.favoriteProjectUuids = favoriteProjectUuids;</span>
<span class="fc" id="L581">        return this;</span>
      }

      public SearchResultsBuilder analysisByProjectUuid(Map&lt;String, SnapshotDto&gt; analysisByProjectUuid) {
<span class="fc" id="L585">        this.analysisByProjectUuid = analysisByProjectUuid;</span>
<span class="fc" id="L586">        return this;</span>
      }

      public SearchResultsBuilder applicationsLeakPeriods(Map&lt;String, Long&gt; applicationsLeakPeriods) {
<span class="fc" id="L590">        this.applicationsLeakPeriods = applicationsLeakPeriods;</span>
<span class="fc" id="L591">        return this;</span>
      }

      public SearchResultsBuilder query(ProjectMeasuresQuery query) {
<span class="fc" id="L595">        this.query = query;</span>
<span class="fc" id="L596">        return this;</span>
      }

      public SearchResultsBuilder searchResults(SearchIdResult&lt;String&gt; searchResults) {
<span class="fc" id="L600">        this.searchResults = searchResults;</span>
<span class="fc" id="L601">        return this;</span>
      }

      public SearchResults build() {
<span class="fc" id="L605">        return new SearchResults(projects, favoriteProjectUuids, searchResults, analysisByProjectUuid, applicationsLeakPeriods, query);</span>
      }
    }
  }

  static class SearchProjectsRequest {

    private final int page;
    private final int pageSize;
    private final String filter;
    private final List&lt;String&gt; facets;
    private final String sort;
    private final Boolean asc;
    private final List&lt;String&gt; additionalFields;

<span class="fc" id="L620">    private SearchProjectsRequest(RequestBuilder builder) {</span>
<span class="fc" id="L621">      this.page = builder.page;</span>
<span class="fc" id="L622">      this.pageSize = builder.pageSize;</span>
<span class="fc" id="L623">      this.filter = builder.filter;</span>
<span class="fc" id="L624">      this.facets = builder.facets;</span>
<span class="fc" id="L625">      this.sort = builder.sort;</span>
<span class="fc" id="L626">      this.asc = builder.asc;</span>
<span class="fc" id="L627">      this.additionalFields = builder.additionalFields;</span>
<span class="fc" id="L628">    }</span>

    @CheckForNull
    public String getFilter() {
<span class="fc" id="L632">      return filter;</span>
    }

    public List&lt;String&gt; getFacets() {
<span class="fc" id="L636">      return facets;</span>
    }

    @CheckForNull
    public String getSort() {
<span class="fc" id="L641">      return sort;</span>
    }

    public int getPageSize() {
<span class="fc" id="L645">      return pageSize;</span>
    }

    public int getPage() {
<span class="fc" id="L649">      return page;</span>
    }

    @CheckForNull
    public Boolean getAsc() {
<span class="fc" id="L654">      return asc;</span>
    }

    public List&lt;String&gt; getAdditionalFields() {
<span class="fc" id="L658">      return additionalFields;</span>
    }

    public static RequestBuilder builder() {
<span class="fc" id="L662">      return new RequestBuilder();</span>
    }

  }

  static class RequestBuilder {
    private Integer page;
    private Integer pageSize;
    private String filter;
<span class="fc" id="L671">    private List&lt;String&gt; facets = new ArrayList&lt;&gt;();</span>
    private String sort;
    private Boolean asc;
<span class="fc" id="L674">    private List&lt;String&gt; additionalFields = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L676">    private RequestBuilder() {</span>
      // enforce static factory method
<span class="fc" id="L678">    }</span>

    public RequestBuilder setFilter(@Nullable String filter) {
<span class="fc" id="L681">      this.filter = filter;</span>
<span class="fc" id="L682">      return this;</span>
    }

    public RequestBuilder setFacets(List&lt;String&gt; facets) {
<span class="fc" id="L686">      this.facets = requireNonNull(facets);</span>
<span class="fc" id="L687">      return this;</span>
    }

    public RequestBuilder setPage(int page) {
<span class="fc" id="L691">      this.page = page;</span>
<span class="fc" id="L692">      return this;</span>
    }

    public RequestBuilder setPageSize(int pageSize) {
<span class="fc" id="L696">      this.pageSize = pageSize;</span>
<span class="fc" id="L697">      return this;</span>
    }

    public RequestBuilder setSort(@Nullable String sort) {
<span class="fc" id="L701">      this.sort = sort;</span>
<span class="fc" id="L702">      return this;</span>
    }

    public RequestBuilder setAsc(boolean asc) {
<span class="fc" id="L706">      this.asc = asc;</span>
<span class="fc" id="L707">      return this;</span>
    }

    public RequestBuilder setAdditionalFields(List&lt;String&gt; additionalFields) {
<span class="fc" id="L711">      this.additionalFields = requireNonNull(additionalFields, &quot;additional fields cannot be null&quot;);</span>
<span class="fc" id="L712">      return this;</span>
    }

    public SearchProjectsRequest build() {
<span class="fc bfc" id="L716" title="All 2 branches covered.">      if (page == null) {</span>
<span class="fc" id="L717">        page = 1;</span>
      }
<span class="fc bfc" id="L719" title="All 2 branches covered.">      if (pageSize == null) {</span>
<span class="fc" id="L720">        pageSize = DEFAULT_PAGE_SIZE;</span>
      }
<span class="fc bfc" id="L722" title="All 2 branches covered.">      checkArgument(pageSize &lt;= MAX_PAGE_SIZE, &quot;Page size must not be greater than %s&quot;, MAX_PAGE_SIZE);</span>
<span class="fc" id="L723">      return new SearchProjectsRequest(this);</span>
    }
  }

  private boolean isProjectAnalysisToken() {
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">    if (userSession instanceof TokenUserSession tokenUserSession) {</span>
<span class="nc" id="L729">      return TokenType.PROJECT_ANALYSIS_TOKEN.equals(tokenUserSession.getTokenType());</span>
    }
<span class="fc" id="L731">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>